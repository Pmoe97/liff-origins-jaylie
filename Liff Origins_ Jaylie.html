<!DOCTYPE html>
<html data-init="no-js">
<head>
<meta charset="UTF-8" />
<title>Liff Origins: Jaylie</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="application-name" content="SugarCube" />
<meta name="version" content="2.37.3" />
<!--

SugarCube (v2.37.3): A free (gratis and libre) story format.

Copyright © 2013–2021 Thomas Michael Edwards <thomasmedwards@gmail.com>.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->
<script id="script-libraries" type="text/javascript">
if(document.head&&document.addEventListener&&document.querySelector&&Object.create&&Object.freeze&&JSON){document.documentElement.setAttribute("data-init", "loading");
/*! @source http://purl.eligrey.com/github/classList.js/blob/1.2.20171210/classList.js */
"document"in self&&("classList"in document.createElement("_")&&(!document.createElementNS||"classList"in document.createElementNS("http://www.w3.org/2000/svg","g"))||!function(t){"use strict";if("Element"in t){var e="classList",n="prototype",i=t.Element[n],s=Object,r=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array[n].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},c=function(t,e){this.name=t,this.code=DOMException[t],this.message=e},a=function(t,e){if(""===e)throw new c("SYNTAX_ERR","The token must not be empty.");if(/\s/.test(e))throw new c("INVALID_CHARACTER_ERR","The token must not contain space characters.");return o.call(t,e)},l=function(t){for(var e=r.call(t.getAttribute("class")||""),n=e?e.split(/\s+/):[],i=0,s=n.length;s>i;i++)this.push(n[i]);this._updateClassName=function(){t.setAttribute("class",this.toString())}},u=l[n]=[],h=function(){return new l(this)};if(c[n]=Error[n],u.item=function(t){return this[t]||null},u.contains=function(t){return~a(this,t+"")},u.add=function(){var t,e=arguments,n=0,i=e.length,s=!1;do t=e[n]+"",~a(this,t)||(this.push(t),s=!0);while(++n<i);s&&this._updateClassName()},u.remove=function(){var t,e,n=arguments,i=0,s=n.length,r=!1;do for(t=n[i]+"",e=a(this,t);~e;)this.splice(e,1),r=!0,e=a(this,t);while(++i<s);r&&this._updateClassName()},u.toggle=function(t,e){var n=this.contains(t),i=n?e!==!0&&"remove":e!==!1&&"add";return i&&this[i](t),e===!0||e===!1?e:!n},u.replace=function(t,e){var n=a(t+"");~n&&(this.splice(n,1,e),this._updateClassName())},u.toString=function(){return this.join(" ")},s.defineProperty){var f={get:h,enumerable:!0,configurable:!0};try{s.defineProperty(i,e,f)}catch(p){void 0!==p.number&&-2146823252!==p.number||(f.enumerable=!1,s.defineProperty(i,e,f))}}else s[n].__defineGetter__&&i.__defineGetter__(e,h)}}(self),function(){"use strict";var t=document.createElement("_");if(t.classList.add("c1","c2"),!t.classList.contains("c2")){var e=function(t){var e=DOMTokenList.prototype[t];DOMTokenList.prototype[t]=function(t){var n,i=arguments.length;for(n=0;i>n;n++)t=arguments[n],e.call(this,t)}};e("add"),e("remove")}if(t.classList.toggle("c3",!1),t.classList.contains("c3")){var n=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(t,e){return 1 in arguments&&!this.contains(t)==!e?e:n.call(this,t)}}"replace"in document.createElement("_").classList||(DOMTokenList.prototype.replace=function(t,e){var n=this.toString().split(" "),i=n.indexOf(t+"");~i&&(n=n.slice(i),this.remove.apply(this,n),this.add(e),this.add.apply(this,n.slice(1)))}),t=null}());
/*!
 * https://github.com/es-shims/es5-shim
 * @license es5-shim Copyright 2009-2020 by contributors, MIT License
 * see https://github.com/es-shims/es5-shim/blob/v4.5.14/LICENSE
 */
(function(t,r){"use strict";if(typeof define==="function"&&define.amd){define(r)}else if(typeof exports==="object"){module.exports=r()}else{t.returnExports=r()}})(this,function(){var t=Array;var r=t.prototype;var e=Object;var n=e.prototype;var i=Function;var a=i.prototype;var o=String;var f=o.prototype;var u=Number;var l=u.prototype;var s=r.slice;var c=r.splice;var v=r.push;var h=r.unshift;var p=r.concat;var y=r.join;var d=a.call;var g=a.apply;var w=Math.max;var b=Math.min;var T=n.toString;var m=typeof Symbol==="function"&&typeof Symbol.toStringTag==="symbol";var D;var S=Function.prototype.toString,x=/^\s*class /,O=function isES6ClassFn(t){try{var r=S.call(t);var e=r.replace(/\/\/.*\n/g,"");var n=e.replace(/\/\*[.\s\S]*\*\//g,"");var i=n.replace(/\n/gm," ").replace(/ {2}/g," ");return x.test(i)}catch(a){return false}},E=function tryFunctionObject(t){try{if(O(t)){return false}S.call(t);return true}catch(r){return false}},j="[object Function]",I="[object GeneratorFunction]",D=function isCallable(t){if(!t){return false}if(typeof t!=="function"&&typeof t!=="object"){return false}if(m){return E(t)}if(O(t)){return false}var r=T.call(t);return r===j||r===I};var M;var U=RegExp.prototype.exec,$=function tryRegexExec(t){try{U.call(t);return true}catch(r){return false}},F="[object RegExp]";M=function isRegex(t){if(typeof t!=="object"){return false}return m?$(t):T.call(t)===F};var N;var C=String.prototype.valueOf,k=function tryStringObject(t){try{C.call(t);return true}catch(r){return false}},A="[object String]";N=function isString(t){if(typeof t==="string"){return true}if(typeof t!=="object"){return false}return m?k(t):T.call(t)===A};var R=e.defineProperty&&function(){try{var t={};e.defineProperty(t,"x",{enumerable:false,value:t});for(var r in t){return false}return t.x===t}catch(n){return false}}();var P=function(t){var r;if(R){r=function(t,r,n,i){if(!i&&r in t){return}e.defineProperty(t,r,{configurable:true,enumerable:false,writable:true,value:n})}}else{r=function(t,r,e,n){if(!n&&r in t){return}t[r]=e}}return function defineProperties(e,n,i){for(var a in n){if(t.call(n,a)){r(e,a,n[a],i)}}}}(n.hasOwnProperty);var J=function isPrimitive(t){var r=typeof t;return t===null||r!=="object"&&r!=="function"};var Y=u.isNaN||function isActualNaN(t){return t!==t};var z={ToInteger:function ToInteger(t){var r=+t;if(Y(r)){r=0}else if(r!==0&&r!==1/0&&r!==-(1/0)){r=(r>0||-1)*Math.floor(Math.abs(r))}return r},ToPrimitive:function ToPrimitive(t){var r,e,n;if(J(t)){return t}e=t.valueOf;if(D(e)){r=e.call(t);if(J(r)){return r}}n=t.toString;if(D(n)){r=n.call(t);if(J(r)){return r}}throw new TypeError},ToObject:function(t){if(t==null){throw new TypeError("can't convert "+t+" to object")}return e(t)},ToUint32:function ToUint32(t){return t>>>0}};var Z=function Empty(){};P(a,{bind:function bind(t){var r=this;if(!D(r)){throw new TypeError("Function.prototype.bind called on incompatible "+r)}var n=s.call(arguments,1);var a;var o=function(){if(this instanceof a){var i=g.call(r,this,p.call(n,s.call(arguments)));if(e(i)===i){return i}return this}else{return g.call(r,t,p.call(n,s.call(arguments)))}};var f=w(0,r.length-n.length);var u=[];for(var l=0;l<f;l++){v.call(u,"$"+l)}a=i("binder","return function ("+y.call(u,",")+"){ return binder.apply(this, arguments); }")(o);if(r.prototype){Z.prototype=r.prototype;a.prototype=new Z;Z.prototype=null}return a}});var G=d.bind(n.hasOwnProperty);var H=d.bind(n.toString);var W=d.bind(s);var B=g.bind(s);if(typeof document==="object"&&document&&document.documentElement){try{W(document.documentElement.childNodes)}catch(X){var L=W;var q=B;W=function arraySliceIE(t){var r=[];var e=t.length;while(e-- >0){r[e]=t[e]}return q(r,L(arguments,1))};B=function arraySliceApplyIE(t,r){return q(W(t),r)}}}var K=d.bind(f.slice);var Q=d.bind(f.split);var V=d.bind(f.indexOf);var _=d.bind(v);var tt=d.bind(n.propertyIsEnumerable);var rt=d.bind(r.sort);var et=t.isArray||function isArray(t){return H(t)==="[object Array]"};var nt=[].unshift(0)!==1;P(r,{unshift:function(){h.apply(this,arguments);return this.length}},nt);P(t,{isArray:et});var it=e("a");var at=it[0]!=="a"||!(0 in it);var ot=function properlyBoxed(t){var r=true;var e=true;var n=false;if(t){try{t.call("foo",function(t,e,n){if(typeof n!=="object"){r=false}});t.call([1],function(){"use strict";e=typeof this==="string"},"x")}catch(i){n=true}}return!!t&&!n&&r&&e};P(r,{forEach:function forEach(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=-1;var i=z.ToUint32(e.length);var a;if(arguments.length>1){a=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.forEach callback must be a function")}while(++n<i){if(n in e){if(typeof a==="undefined"){t(e[n],n,r)}else{t.call(a,e[n],n,r)}}}}},!ot(r.forEach));P(r,{map:function map(r){var e=z.ToObject(this);var n=at&&N(this)?Q(this,""):e;var i=z.ToUint32(n.length);var a=t(i);var o;if(arguments.length>1){o=arguments[1]}if(!D(r)){throw new TypeError("Array.prototype.map callback must be a function")}for(var f=0;f<i;f++){if(f in n){if(typeof o==="undefined"){a[f]=r(n[f],f,e)}else{a[f]=r.call(o,n[f],f,e)}}}return a}},!ot(r.map));P(r,{filter:function filter(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i=[];var a;var o;if(arguments.length>1){o=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.filter callback must be a function")}for(var f=0;f<n;f++){if(f in e){a=e[f];if(typeof o==="undefined"?t(a,f,r):t.call(o,a,f,r)){_(i,a)}}}return i}},!ot(r.filter));P(r,{every:function every(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.every callback must be a function")}for(var a=0;a<n;a++){if(a in e&&!(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return false}}return true}},!ot(r.every));P(r,{some:function some(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.some callback must be a function")}for(var a=0;a<n;a++){if(a in e&&(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return true}}return false}},!ot(r.some));var ft=false;if(r.reduce){ft=typeof r.reduce.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduce:function reduce(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduce callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduce of empty array with no initial value")}var i=0;var a;if(arguments.length>=2){a=arguments[1]}else{do{if(i in e){a=e[i++];break}if(++i>=n){throw new TypeError("reduce of empty array with no initial value")}}while(true)}for(;i<n;i++){if(i in e){a=t(a,e[i],i,r)}}return a}},!ft);var ut=false;if(r.reduceRight){ut=typeof r.reduceRight.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduceRight:function reduceRight(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduceRight callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduceRight of empty array with no initial value")}var i;var a=n-1;if(arguments.length>=2){i=arguments[1]}else{do{if(a in e){i=e[a--];break}if(--a<0){throw new TypeError("reduceRight of empty array with no initial value")}}while(true)}if(a<0){return i}do{if(a in e){i=t(i,e[a],a,r)}}while(a--);return i}},!ut);var lt=r.indexOf&&[0,1].indexOf(1,2)!==-1;P(r,{indexOf:function indexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=0;if(arguments.length>1){n=z.ToInteger(arguments[1])}n=n>=0?n:w(0,e+n);for(;n<e;n++){if(n in r&&r[n]===t){return n}}return-1}},lt);var st=r.lastIndexOf&&[0,1].lastIndexOf(0,-3)!==-1;P(r,{lastIndexOf:function lastIndexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=e-1;if(arguments.length>1){n=b(n,z.ToInteger(arguments[1]))}n=n>=0?n:e-Math.abs(n);for(;n>=0;n--){if(n in r&&t===r[n]){return n}}return-1}},st);var ct=function(){var t=[1,2];var r=t.splice();return t.length===2&&et(r)&&r.length===0}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}else{return c.apply(this,arguments)}}},!ct);var vt=function(){var t={};r.splice.call(t,0,0,1);return t.length===1}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}var e=arguments;this.length=w(z.ToInteger(this.length),0);if(arguments.length>0&&typeof r!=="number"){e=W(arguments);if(e.length<2){_(e,this.length-t)}else{e[1]=z.ToInteger(r)}}return c.apply(this,e)}},!vt);var ht=function(){var r=new t(1e5);r[8]="x";r.splice(1,1);return r.indexOf("x")===7}();var pt=function(){var t=256;var r=[];r[t]="a";r.splice(t+1,0,"b");return r[t]==="a"}();P(r,{splice:function splice(t,r){var e=z.ToObject(this);var n=[];var i=z.ToUint32(e.length);var a=z.ToInteger(t);var f=a<0?w(i+a,0):b(a,i);var u=arguments.length===0?0:arguments.length===1?i-f:b(w(z.ToInteger(r),0),i-f);var l=0;var s;while(l<u){s=o(f+l);if(G(e,s)){n[l]=e[s]}l+=1}var c=W(arguments,2);var v=c.length;var h;if(v<u){l=f;var p=i-u;while(l<p){s=o(l+u);h=o(l+v);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l+=1}l=i;var y=i-u+v;while(l>y){delete e[l-1];l-=1}}else if(v>u){l=i-u;while(l>f){s=o(l+u-1);h=o(l+v-1);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l-=1}}l=f;for(var d=0;d<c.length;++d){e[l]=c[d];l+=1}e.length=i-u+v;return n}},!ht||!pt);var yt=r.join;var dt;try{dt=Array.prototype.join.call("123",",")!=="1,2,3"}catch(X){dt=true}if(dt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(N(this)?Q(this,""):this,r)}},dt)}var gt=[1,2].join(undefined)!=="1,2";if(gt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(this,r)}},gt)}var wt=function push(t){var r=z.ToObject(this);var e=z.ToUint32(r.length);var n=0;while(n<arguments.length){r[e+n]=arguments[n];n+=1}r.length=e+n;return e+n};var bt=function(){var t={};var r=Array.prototype.push.call(t,undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:function push(t){if(et(this)){return v.apply(this,arguments)}return wt.apply(this,arguments)}},bt);var Tt=function(){var t=[];var r=t.push(undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:wt},Tt);P(r,{slice:function(t,r){var e=N(this)?Q(this,""):this;return B(e,arguments)}},at);var mt=function(){try{[1,2].sort(null)}catch(t){try{[1,2].sort({})}catch(r){return false}}return true}();var Dt=function(){try{[1,2].sort(/a/);return false}catch(t){}return true}();var St=function(){try{[1,2].sort(undefined);return true}catch(t){}return false}();P(r,{sort:function sort(t){if(typeof t==="undefined"){return rt(this)}if(!D(t)){throw new TypeError("Array.prototype.sort callback must be a function")}return rt(this,t)}},mt||!St||!Dt);var xt=!tt({toString:null},"toString");var Ot=tt(function(){},"prototype");var Et=!G("x","0");var jt=function(t){var r=t.constructor;return r&&r.prototype===t};var It={$applicationCache:true,$console:true,$external:true,$frame:true,$frameElement:true,$frames:true,$innerHeight:true,$innerWidth:true,$onmozfullscreenchange:true,$onmozfullscreenerror:true,$outerHeight:true,$outerWidth:true,$pageXOffset:true,$pageYOffset:true,$parent:true,$scrollLeft:true,$scrollTop:true,$scrollX:true,$scrollY:true,$self:true,$webkitIndexedDB:true,$webkitStorageInfo:true,$window:true,$width:true,$height:true,$top:true,$localStorage:true};var Mt=function(){if(typeof window==="undefined"){return false}for(var t in window){try{if(!It["$"+t]&&G(window,t)&&window[t]!==null&&typeof window[t]==="object"){jt(window[t])}}catch(r){return true}}return false}();var Ut=function(t){if(typeof window==="undefined"||!Mt){return jt(t)}try{return jt(t)}catch(r){return false}};var $t=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var Ft=$t.length;var Nt=function isArguments(t){return H(t)==="[object Arguments]"};var Ct=function isArguments(t){return t!==null&&typeof t==="object"&&typeof t.length==="number"&&t.length>=0&&!et(t)&&D(t.callee)};var kt=Nt(arguments)?Nt:Ct;P(e,{keys:function keys(t){var r=D(t);var e=kt(t);var n=t!==null&&typeof t==="object";var i=n&&N(t);if(!n&&!r&&!e){throw new TypeError("Object.keys called on a non-object")}var a=[];var f=Ot&&r;if(i&&Et||e){for(var u=0;u<t.length;++u){_(a,o(u))}}if(!e){for(var l in t){if(!(f&&l==="prototype")&&G(t,l)){_(a,o(l))}}}if(xt){var s=Ut(t);for(var c=0;c<Ft;c++){var v=$t[c];if(!(s&&v==="constructor")&&G(t,v)){_(a,v)}}}return a}});var At=e.keys&&function(){return e.keys(arguments).length===2}(1,2);var Rt=e.keys&&function(){var t=e.keys(arguments);return arguments.length!==1||t.length!==1||t[0]!==1}(1);var Pt=e.keys;P(e,{keys:function keys(t){if(kt(t)){return Pt(W(t))}else{return Pt(t)}}},!At||Rt);var Jt=new Date(-0xc782b5b342b24).getUTCMonth()!==0;var Yt=new Date(-0x55d318d56a724);var zt=new Date(14496624e5);var Zt=Yt.toUTCString()!=="Mon, 01 Jan -45875 11:59:59 GMT";var Gt;var Ht;var Wt=Yt.getTimezoneOffset();if(Wt<-720){Gt=Yt.toDateString()!=="Tue Jan 02 -45875";Ht=!/^Thu Dec 10 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}else{Gt=Yt.toDateString()!=="Mon Jan 01 -45875";Ht=!/^Wed Dec 09 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}var Bt=d.bind(Date.prototype.getFullYear);var Xt=d.bind(Date.prototype.getMonth);var Lt=d.bind(Date.prototype.getDate);var qt=d.bind(Date.prototype.getUTCFullYear);var Kt=d.bind(Date.prototype.getUTCMonth);var Qt=d.bind(Date.prototype.getUTCDate);var Vt=d.bind(Date.prototype.getUTCDay);var _t=d.bind(Date.prototype.getUTCHours);var tr=d.bind(Date.prototype.getUTCMinutes);var rr=d.bind(Date.prototype.getUTCSeconds);var er=d.bind(Date.prototype.getUTCMilliseconds);var nr=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var ir=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var ar=function daysInMonth(t,r){return Lt(new Date(r,t,0))};P(Date.prototype,{getFullYear:function getFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);if(t<0&&Xt(this)>11){return t+1}return t},getMonth:function getMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);if(t<0&&r>11){return 0}return r},getDate:function getDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);var e=Lt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e},getUTCFullYear:function getUTCFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);if(t<0&&Kt(this)>11){return t+1}return t},getUTCMonth:function getUTCMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);if(t<0&&r>11){return 0}return r},getUTCDate:function getUTCDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);var e=Qt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e}},Jt);P(Date.prototype,{toUTCString:function toUTCString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Vt(this);var r=Qt(this);var e=Kt(this);var n=qt(this);var i=_t(this);var a=tr(this);var o=rr(this);return nr[t]+", "+(r<10?"0"+r:r)+" "+ir[e]+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"}},Jt||Zt);P(Date.prototype,{toDateString:function toDateString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n}},Jt||Gt);if(Jt||Ht){Date.prototype.toString=function toString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();var i=this.getHours();var a=this.getMinutes();var o=this.getSeconds();var f=this.getTimezoneOffset();var u=Math.floor(Math.abs(f)/60);var l=Math.floor(Math.abs(f)%60);return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"+(f>0?"-":"+")+(u<10?"0"+u:u)+(l<10?"0"+l:l)};if(R){e.defineProperty(Date.prototype,"toString",{configurable:true,enumerable:false,writable:true})}}var or=-621987552e5;var fr="-000001";var ur=Date.prototype.toISOString&&new Date(or).toISOString().indexOf(fr)===-1;var lr=Date.prototype.toISOString&&new Date(-1).toISOString()!=="1969-12-31T23:59:59.999Z";var sr=d.bind(Date.prototype.getTime);P(Date.prototype,{toISOString:function toISOString(){if(!isFinite(this)||!isFinite(sr(this))){throw new RangeError("Date.prototype.toISOString called on non-finite value.")}var t=qt(this);var r=Kt(this);t+=Math.floor(r/12);r=(r%12+12)%12;var e=[r+1,Qt(this),_t(this),tr(this),rr(this)];t=(t<0?"-":t>9999?"+":"")+K("00000"+Math.abs(t),0<=t&&t<=9999?-4:-6);for(var n=0;n<e.length;++n){e[n]=K("00"+e[n],-2)}return t+"-"+W(e,0,2).join("-")+"T"+W(e,2).join(":")+"."+K("000"+er(this),-3)+"Z"}},ur||lr);var cr=function(){try{return Date.prototype.toJSON&&new Date(NaN).toJSON()===null&&new Date(or).toJSON().indexOf(fr)!==-1&&Date.prototype.toJSON.call({toISOString:function(){return true}})}catch(t){return false}}();if(!cr){Date.prototype.toJSON=function toJSON(t){var r=e(this);var n=z.ToPrimitive(r);if(typeof n==="number"&&!isFinite(n)){return null}var i=r.toISOString;if(!D(i)){throw new TypeError("toISOString property is not callable")}return i.call(r)}}var vr=Date.parse("+033658-09-27T01:46:40.000Z")===1e15;var hr=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z"))||!isNaN(Date.parse("2012-12-31T23:59:60.000Z"));var pr=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));if(pr||hr||!vr){var yr=Math.pow(2,31)-1;var dr=Y(new Date(1970,0,1,0,0,0,yr+1).getTime());Date=function(t){var r=function Date(e,n,i,a,f,u,l){var s=arguments.length;var c;if(this instanceof t){var v=u;var h=l;if(dr&&s>=7&&l>yr){var p=Math.floor(l/yr)*yr;var y=Math.floor(p/1e3);v+=y;h-=y*1e3}c=s===1&&o(e)===e?new t(r.parse(e)):s>=7?new t(e,n,i,a,f,v,h):s>=6?new t(e,n,i,a,f,v):s>=5?new t(e,n,i,a,f):s>=4?new t(e,n,i,a):s>=3?new t(e,n,i):s>=2?new t(e,n):s>=1?new t(e instanceof t?+e:e):new t}else{c=t.apply(this,arguments)}if(!J(c)){P(c,{constructor:r},true)}return c};var e=new RegExp("^"+"(\\d{4}|[+-]\\d{6})"+"(?:-(\\d{2})"+"(?:-(\\d{2})"+"(?:"+"T(\\d{2})"+":(\\d{2})"+"(?:"+":(\\d{2})"+"(?:(\\.\\d{1,}))?"+")?"+"("+"Z|"+"(?:"+"([-+])"+"(\\d{2})"+":(\\d{2})"+")"+")?)?)?)?"+"$");var n=[0,31,59,90,120,151,181,212,243,273,304,334,365];var i=function dayFromMonth(t,r){var e=r>1?1:0;return n[r]+Math.floor((t-1969+e)/4)-Math.floor((t-1901+e)/100)+Math.floor((t-1601+e)/400)+365*(t-1970)};var a=function toUTC(r){var e=0;var n=r;if(dr&&n>yr){var i=Math.floor(n/yr)*yr;var a=Math.floor(i/1e3);e+=a;n-=a*1e3}return u(new t(1970,0,1,0,0,e,n))};for(var f in t){if(G(t,f)){r[f]=t[f]}}P(r,{now:t.now,UTC:t.UTC},true);r.prototype=t.prototype;P(r.prototype,{constructor:r},true);var l=function parse(r){var n=e.exec(r);if(n){var o=u(n[1]),f=u(n[2]||1)-1,l=u(n[3]||1)-1,s=u(n[4]||0),c=u(n[5]||0),v=u(n[6]||0),h=Math.floor(u(n[7]||0)*1e3),p=Boolean(n[4]&&!n[8]),y=n[9]==="-"?1:-1,d=u(n[10]||0),g=u(n[11]||0),w;var b=c>0||v>0||h>0;if(s<(b?24:25)&&c<60&&v<60&&h<1e3&&f>-1&&f<12&&d<24&&g<60&&l>-1&&l<i(o,f+1)-i(o,f)){w=((i(o,f)+l)*24+s+d*y)*60;w=((w+c+g*y)*60+v)*1e3+h;if(p){w=a(w)}if(-864e13<=w&&w<=864e13){return w}}return NaN}return t.parse.apply(this,arguments)};P(r,{parse:l});return r}(Date)}if(!Date.now){Date.now=function now(){return(new Date).getTime()}}var gr=l.toFixed&&(8e-5.toFixed(3)!=="0.000"||.9.toFixed(0)!=="1"||1.255.toFixed(2)!=="1.25"||(1000000000000000128).toFixed(0)!=="1000000000000000128");var wr={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function multiply(t,r){var e=-1;var n=r;while(++e<wr.size){n+=t*wr.data[e];wr.data[e]=n%wr.base;n=Math.floor(n/wr.base)}},divide:function divide(t){var r=wr.size;var e=0;while(--r>=0){e+=wr.data[r];wr.data[r]=Math.floor(e/t);e=e%t*wr.base}},numToString:function numToString(){var t=wr.size;var r="";while(--t>=0){if(r!==""||t===0||wr.data[t]!==0){var e=o(wr.data[t]);if(r===""){r=e}else{r+=K("0000000",0,7-e.length)+e}}}return r},pow:function pow(t,r,e){return r===0?e:r%2===1?pow(t,r-1,e*t):pow(t*t,r/2,e)},log:function log(t){var r=0;var e=t;while(e>=4096){r+=12;e/=4096}while(e>=2){r+=1;e/=2}return r}};var br=function toFixed(t){var r,e,n,i,a,f,l,s;r=u(t);r=Y(r)?0:Math.floor(r);if(r<0||r>20){throw new RangeError("Number.toFixed called with invalid number of decimals")}e=u(this);if(Y(e)){return"NaN"}if(e<=-1e21||e>=1e21){return o(e)}n="";if(e<0){n="-";e=-e}i="0";if(e>1e-21){a=wr.log(e*wr.pow(2,69,1))-69;f=a<0?e*wr.pow(2,-a,1):e/wr.pow(2,a,1);f*=4503599627370496;a=52-a;if(a>0){wr.multiply(0,f);l=r;while(l>=7){wr.multiply(1e7,0);l-=7}wr.multiply(wr.pow(10,l,1),0);l=a-1;while(l>=23){wr.divide(1<<23);l-=23}wr.divide(1<<l);wr.multiply(1,1);wr.divide(2);i=wr.numToString()}else{wr.multiply(0,f);wr.multiply(1<<-a,0);i=wr.numToString()+K("0.00000000000000000000",2,2+r)}}if(r>0){s=i.length;if(s<=r){i=n+K("0.0000000000000000000",0,r-s+2)+i}else{i=n+K(i,0,s-r)+"."+K(i,s-r)}}else{i=n+i}return i};P(l,{toFixed:br},gr);var Tr=function(){try{return 1..toPrecision(undefined)==="1"}catch(t){return true}}();var mr=l.toPrecision;P(l,{toPrecision:function toPrecision(t){return typeof t==="undefined"?mr.call(this):mr.call(this,t)}},Tr);if("ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1){(function(){var t=typeof/()??/.exec("")[1]==="undefined";var r=Math.pow(2,32)-1;f.split=function(e,n){var i=String(this);if(typeof e==="undefined"&&n===0){return[]}if(!M(e)){return Q(this,e,n)}var a=[];var o=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),f=0,u,l,s,c;var h=new RegExp(e.source,o+"g");if(!t){u=new RegExp("^"+h.source+"$(?!\\s)",o)}var p=typeof n==="undefined"?r:z.ToUint32(n);l=h.exec(i);while(l){s=l.index+l[0].length;if(s>f){_(a,K(i,f,l.index));if(!t&&l.length>1){l[0].replace(u,function(){for(var t=1;t<arguments.length-2;t++){if(typeof arguments[t]==="undefined"){l[t]=void 0}}})}if(l.length>1&&l.index<i.length){v.apply(a,W(l,1))}c=l[0].length;f=s;if(a.length>=p){break}}if(h.lastIndex===l.index){h.lastIndex++}l=h.exec(i)}if(f===i.length){if(c||!h.test("")){_(a,"")}}else{_(a,K(i,f))}return a.length>p?W(a,0,p):a}})()}else if("0".split(void 0,0).length){f.split=function split(t,r){if(typeof t==="undefined"&&r===0){return[]}return Q(this,t,r)}}var Dr=f.replace;var Sr=function(){var t=[];"x".replace(/x(.)?/g,function(r,e){_(t,e)});return t.length===1&&typeof t[0]==="undefined"}();if(!Sr){f.replace=function replace(t,r){var e=D(r);var n=M(t)&&/\)[*?]/.test(t.source);if(!e||!n){return Dr.call(this,t,r)}else{var i=function(e){var n=arguments.length;var i=t.lastIndex;t.lastIndex=0;var a=t.exec(e)||[];t.lastIndex=i;_(a,arguments[n-2],arguments[n-1]);return r.apply(this,a)};return Dr.call(this,t,i)}}}var xr=f.substr;var Or="".substr&&"0b".substr(-1)!=="b";P(f,{substr:function substr(t,r){var e=t;if(t<0){e=w(this.length+t,0)}return xr.call(this,e,r)}},Or);var Er="\t\n\x0B\f\r \xa0\u1680\u2000\u2001\u2002\u2003"+"\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028"+"\u2029\ufeff";var jr="\u200b";var Ir="["+Er+"]";var Mr=new RegExp("^"+Ir+Ir+"*");var Ur=new RegExp(Ir+Ir+"*$");var $r=f.trim&&(Er.trim()||!jr.trim());P(f,{trim:function trim(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}return o(this).replace(Mr,"").replace(Ur,"")}},$r);var Fr=d.bind(String.prototype.trim);var Nr=f.lastIndexOf&&"abc\u3042\u3044".lastIndexOf("\u3042\u3044",2)!==-1;P(f,{lastIndexOf:function lastIndexOf(t){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var r=o(this);var e=o(t);var n=arguments.length>1?u(arguments[1]):NaN;var i=Y(n)?Infinity:z.ToInteger(n);var a=b(w(i,0),r.length);var f=e.length;var l=a+f;while(l>0){l=w(0,l-f);var s=V(K(r,l,a+f),e);if(s!==-1){return l+s}}return-1}},Nr);var Cr=f.lastIndexOf;P(f,{lastIndexOf:function lastIndexOf(t){return Cr.apply(this,arguments)}},f.lastIndexOf.length!==1);if(parseInt(Er+"08")!==8||parseInt(Er+"0x16")!==22){parseInt=function(t){var r=/^[-+]?0[xX]/;return function parseInt(e,n){if(typeof e==="symbol"){""+e}var i=Fr(String(e));var a=u(n)||(r.test(i)?16:10);return t(i,a)}}(parseInt)}if(1/parseFloat("-0")!==-Infinity){parseFloat=function(t){return function parseFloat(r){var e=Fr(String(r));var n=t(e);return n===0&&K(e,0,1)==="-"?-0:n}}(parseFloat)}if(String(new RangeError("test"))!=="RangeError: test"){var kr=function toString(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var t=this.name;if(typeof t==="undefined"){t="Error"}else if(typeof t!=="string"){t=o(t)}var r=this.message;if(typeof r==="undefined"){r=""}else if(typeof r!=="string"){r=o(r)}if(!t){return r}if(!r){return t}return t+": "+r};Error.prototype.toString=kr}if(R){var Ar=function(t,r){if(tt(t,r)){var e=Object.getOwnPropertyDescriptor(t,r);if(e.configurable){e.enumerable=false;Object.defineProperty(t,r,e)}}};Ar(Error.prototype,"message");if(Error.prototype.message!==""){Error.prototype.message=""}Ar(Error.prototype,"name")}if(String(/a/gim)!=="/a/gim"){var Rr=function toString(){var t="/"+this.source+"/";if(this.global){t+="g"}if(this.ignoreCase){t+="i"}if(this.multiline){t+="m"}return t};RegExp.prototype.toString=Rr}});
/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.4/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(t)}else if(typeof exports==="object"){module.exports=t()}else{e.returnExports=t()}})(this,function(){"use strict";var e=Function.call.bind(Function.apply);var t=Function.call.bind(Function.call);var r=Array.isArray;var n=Object.keys;var o=function notThunker(t){return function notThunk(){return!e(t,this,arguments)}};var i=function(e){try{e();return false}catch(t){return true}};var a=function valueOrFalseIfThrows(e){try{return e()}catch(t){return false}};var u=o(i);var f=function(){return!i(function(){return Object.defineProperty({},"x",{get:function(){}})})};var s=!!Object.defineProperty&&f();var c=function foo(){}.name==="foo";var l=Function.call.bind(Array.prototype.forEach);var p=Function.call.bind(Array.prototype.reduce);var v=Function.call.bind(Array.prototype.filter);var y=Function.call.bind(Array.prototype.some);var h=function(e,t,r,n){if(!n&&t in e){return}if(s){Object.defineProperty(e,t,{configurable:true,enumerable:false,writable:true,value:r})}else{e[t]=r}};var b=function(e,t,r){l(n(t),function(n){var o=t[n];h(e,n,o,!!r)})};var g=Function.call.bind(Object.prototype.toString);var d=typeof/abc/==="function"?function IsCallableSlow(e){return typeof e==="function"&&g(e)==="[object Function]"}:function IsCallableFast(e){return typeof e==="function"};var m={getter:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}Object.defineProperty(e,t,{configurable:true,enumerable:false,get:r})},proxy:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,{configurable:n.configurable,enumerable:n.enumerable,get:function getKey(){return e[t]},set:function setKey(r){e[t]=r}})},redefine:function(e,t,r){if(s){var n=Object.getOwnPropertyDescriptor(e,t);n.value=r;Object.defineProperty(e,t,n)}else{e[t]=r}},defineByDescriptor:function(e,t,r){if(s){Object.defineProperty(e,t,r)}else if("value"in r){e[t]=r.value}},preserveToString:function(e,t){if(t&&d(t.toString)){h(e,"toString",t.toString.bind(t),true)}}};var O=Object.create||function(e,t){var r=function Prototype(){};r.prototype=e;var o=new r;if(typeof t!=="undefined"){n(t).forEach(function(e){m.defineByDescriptor(o,e,t[e])})}return o};var w=function(e,t){if(!Object.setPrototypeOf){return false}return a(function(){var r=function Subclass(t){var r=new e(t);Object.setPrototypeOf(r,Subclass.prototype);return r};Object.setPrototypeOf(r,e);r.prototype=O(e.prototype,{constructor:{value:r}});return t(r)})};var j=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")};var S=j();var T=S.isFinite;var I=Function.call.bind(String.prototype.indexOf);var E=Function.apply.bind(Array.prototype.indexOf);var P=Function.call.bind(Array.prototype.concat);var C=Function.call.bind(String.prototype.slice);var M=Function.call.bind(Array.prototype.push);var x=Function.apply.bind(Array.prototype.push);var N=Function.call.bind(Array.prototype.shift);var A=Math.max;var R=Math.min;var _=Math.floor;var k=Math.abs;var L=Math.exp;var F=Math.log;var D=Math.sqrt;var z=Function.call.bind(Object.prototype.hasOwnProperty);var q;var W=function(){};var G=S.Map;var H=G&&G.prototype["delete"];var V=G&&G.prototype.get;var B=G&&G.prototype.has;var U=G&&G.prototype.set;var $=S.Symbol||{};var J=$.species||"@@species";var X=Number.isNaN||function isNaN(e){return e!==e};var K=Number.isFinite||function isFinite(e){return typeof e==="number"&&T(e)};var Z=d(Math.sign)?Math.sign:function sign(e){var t=Number(e);if(t===0){return t}if(X(t)){return t}return t<0?-1:1};var Y=function log1p(e){var t=Number(e);if(t<-1||X(t)){return NaN}if(t===0||t===Infinity){return t}if(t===-1){return-Infinity}return 1+t-1===0?t:t*(F(1+t)/(1+t-1))};var Q=function isArguments(e){return g(e)==="[object Arguments]"};var ee=function isArguments(e){return e!==null&&typeof e==="object"&&typeof e.length==="number"&&e.length>=0&&g(e)!=="[object Array]"&&g(e.callee)==="[object Function]"};var te=Q(arguments)?Q:ee;var re={primitive:function(e){return e===null||typeof e!=="function"&&typeof e!=="object"},string:function(e){return g(e)==="[object String]"},regex:function(e){return g(e)==="[object RegExp]"},symbol:function(e){return typeof S.Symbol==="function"&&typeof e==="symbol"}};var ne=function overrideNative(e,t,r){var n=e[t];h(e,t,r,true);m.preserveToString(e[t],n)};var oe=typeof $==="function"&&typeof $["for"]==="function"&&re.symbol($());var ie=re.symbol($.iterator)?$.iterator:"_es6-shim iterator_";if(S.Set&&typeof(new S.Set)["@@iterator"]==="function"){ie="@@iterator"}if(!S.Reflect){h(S,"Reflect",{},true)}var ae=S.Reflect;var ue=String;var fe=typeof document==="undefined"||!document?null:document.all;var se=fe==null?function isNullOrUndefined(e){return e==null}:function isNullOrUndefinedAndNotDocumentAll(e){return e==null&&e!==fe};var ce={Call:function Call(t,r){var n=arguments.length>2?arguments[2]:[];if(!ce.IsCallable(t)){throw new TypeError(t+" is not a function")}return e(t,r,n)},RequireObjectCoercible:function(e,t){if(se(e)){throw new TypeError(t||"Cannot call method on "+e)}return e},TypeIsObject:function(e){if(e===void 0||e===null||e===true||e===false){return false}return typeof e==="function"||typeof e==="object"||e===fe},ToObject:function(e,t){return Object(ce.RequireObjectCoercible(e,t))},IsCallable:d,IsConstructor:function(e){return ce.IsCallable(e)},ToInt32:function(e){return ce.ToNumber(e)>>0},ToUint32:function(e){return ce.ToNumber(e)>>>0},ToNumber:function(e){if(g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return+e},ToInteger:function(e){var t=ce.ToNumber(e);if(X(t)){return 0}if(t===0||!K(t)){return t}return(t>0?1:-1)*_(k(t))},ToLength:function(e){var t=ce.ToInteger(e);if(t<=0){return 0}if(t>Number.MAX_SAFE_INTEGER){return Number.MAX_SAFE_INTEGER}return t},SameValue:function(e,t){if(e===t){if(e===0){return 1/e===1/t}return true}return X(e)&&X(t)},SameValueZero:function(e,t){return e===t||X(e)&&X(t)},IsIterable:function(e){return ce.TypeIsObject(e)&&(typeof e[ie]!=="undefined"||te(e))},GetIterator:function(e){if(te(e)){return new q(e,"value")}var t=ce.GetMethod(e,ie);if(!ce.IsCallable(t)){throw new TypeError("value is not an iterable")}var r=ce.Call(t,e);if(!ce.TypeIsObject(r)){throw new TypeError("bad iterator")}return r},GetMethod:function(e,t){var r=ce.ToObject(e)[t];if(se(r)){return void 0}if(!ce.IsCallable(r)){throw new TypeError("Method not callable: "+t)}return r},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var r=ce.GetMethod(e,"return");if(r===void 0){return}var n,o;try{n=ce.Call(r,e)}catch(i){o=i}if(t){return}if(o){throw o}if(!ce.TypeIsObject(n)){throw new TypeError("Iterator's return method returned a non-object.")}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!ce.TypeIsObject(t)){throw new TypeError("bad iterator")}return t},IteratorStep:function(e){var t=ce.IteratorNext(e);var r=ce.IteratorComplete(t);return r?false:t},Construct:function(e,t,r,n){var o=typeof r==="undefined"?e:r;if(!n&&ae.construct){return ae.construct(e,t,o)}var i=o.prototype;if(!ce.TypeIsObject(i)){i=Object.prototype}var a=O(i);var u=ce.Call(e,a,t);return ce.TypeIsObject(u)?u:a},SpeciesConstructor:function(e,t){var r=e.constructor;if(r===void 0){return t}if(!ce.TypeIsObject(r)){throw new TypeError("Bad constructor")}var n=r[J];if(se(n)){return t}if(!ce.IsConstructor(n)){throw new TypeError("Bad @@species")}return n},CreateHTML:function(e,t,r,n){var o=ce.ToString(e);var i="<"+t;if(r!==""){var a=ce.ToString(n);var u=a.replace(/"/g,"&quot;");i+=" "+r+'="'+u+'"'}var f=i+">";var s=f+o;return s+"</"+t+">"},IsRegExp:function IsRegExp(e){if(!ce.TypeIsObject(e)){return false}var t=e[$.match];if(typeof t!=="undefined"){return!!t}return re.regex(e)},ToString:function ToString(e){return ue(e)}};if(s&&oe){var le=function defineWellKnownSymbol(e){if(re.symbol($[e])){return $[e]}var t=$["for"]("Symbol."+e);Object.defineProperty($,e,{configurable:false,enumerable:false,writable:false,value:t});return t};if(!re.symbol($.search)){var pe=le("search");var ve=String.prototype.search;h(RegExp.prototype,pe,function search(e){return ce.Call(ve,e,[this])});var ye=function search(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,pe);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(ve,t,[ce.ToString(e)])};ne(String.prototype,"search",ye)}if(!re.symbol($.replace)){var he=le("replace");var be=String.prototype.replace;h(RegExp.prototype,he,function replace(e,t){return ce.Call(be,e,[this,t])});var ge=function replace(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,he);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(be,r,[ce.ToString(e),t])};ne(String.prototype,"replace",ge)}if(!re.symbol($.split)){var de=le("split");var me=String.prototype.split;h(RegExp.prototype,de,function split(e,t){return ce.Call(me,e,[this,t])});var Oe=function split(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,de);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(me,r,[ce.ToString(e),t])};ne(String.prototype,"split",Oe)}var we=re.symbol($.match);var je=we&&function(){var e={};e[$.match]=function(){return 42};return"a".match(e)!==42}();if(!we||je){var Se=le("match");var Te=String.prototype.match;h(RegExp.prototype,Se,function match(e){return ce.Call(Te,e,[this])});var Ie=function match(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,Se);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(Te,t,[ce.ToString(e)])};ne(String.prototype,"match",Ie)}}var Ee=function wrapConstructor(e,t,r){m.preserveToString(t,e);if(Object.setPrototypeOf){Object.setPrototypeOf(e,t)}if(s){l(Object.getOwnPropertyNames(e),function(n){if(n in W||r[n]){return}m.proxy(e,n,t)})}else{l(Object.keys(e),function(n){if(n in W||r[n]){return}t[n]=e[n]})}t.prototype=e.prototype;m.redefine(e.prototype,"constructor",t)};var Pe=function(){return this};var Ce=function(e){if(s&&!z(e,J)){m.getter(e,J,Pe)}};var Me=function(e,t){var r=t||function iterator(){return this};h(e,ie,r);if(!e[ie]&&re.symbol(ie)){e[ie]=r}};var xe=function createDataProperty(e,t,r){if(s){Object.defineProperty(e,t,{configurable:true,enumerable:true,writable:true,value:r})}else{e[t]=r}};var Ne=function createDataPropertyOrThrow(e,t,r){xe(e,t,r);if(!ce.SameValue(e[t],r)){throw new TypeError("property is nonconfigurable")}};var Ae=function(e,t,r,n){if(!ce.TypeIsObject(e)){throw new TypeError("Constructor requires `new`: "+t.name)}var o=t.prototype;if(!ce.TypeIsObject(o)){o=r}var i=O(o);for(var a in n){if(z(n,a)){var u=n[a];h(i,a,u,true)}}return i};if(String.fromCodePoint&&String.fromCodePoint.length!==1){var Re=String.fromCodePoint;ne(String,"fromCodePoint",function fromCodePoint(e){return ce.Call(Re,this,arguments)})}var _e={fromCodePoint:function fromCodePoint(e){var t=[];var r;for(var n=0,o=arguments.length;n<o;n++){r=Number(arguments[n]);if(!ce.SameValue(r,ce.ToInteger(r))||r<0||r>1114111){throw new RangeError("Invalid code point "+r)}if(r<65536){M(t,String.fromCharCode(r))}else{r-=65536;M(t,String.fromCharCode((r>>10)+55296));M(t,String.fromCharCode(r%1024+56320))}}return t.join("")},raw:function raw(e){var t=ce.ToObject(e,"bad callSite");var r=ce.ToObject(t.raw,"bad raw value");var n=r.length;var o=ce.ToLength(n);if(o<=0){return""}var i=[];var a=0;var u,f,s,c;while(a<o){u=ce.ToString(a);s=ce.ToString(r[u]);M(i,s);if(a+1>=o){break}f=a+1<arguments.length?arguments[a+1]:"";c=ce.ToString(f);M(i,c);a+=1}return i.join("")}};if(String.raw&&String.raw({raw:{0:"x",1:"y",length:2}})!=="xy"){ne(String,"raw",_e.raw)}b(String,_e);var ke=function repeat(e,t){if(t<1){return""}if(t%2){return repeat(e,t-1)+e}var r=repeat(e,t/2);return r+r};var Le=Infinity;var Fe={repeat:function repeat(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);if(r<0||r>=Le){throw new RangeError("repeat count must be less than infinity and not overflow maximum string size")}return ke(t,r)},startsWith:function startsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "startsWith" with a regex')}var r=ce.ToString(e);var n;if(arguments.length>1){n=arguments[1]}var o=A(ce.ToInteger(n),0);return C(t,o,o+r.length)===r},endsWith:function endsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "endsWith" with a regex')}var r=ce.ToString(e);var n=t.length;var o;if(arguments.length>1){o=arguments[1]}var i=typeof o==="undefined"?n:ce.ToInteger(o);var a=R(A(i,0),n);return C(t,a-r.length,a)===r},includes:function includes(e){if(ce.IsRegExp(e)){throw new TypeError('"includes" does not accept a RegExp')}var t=ce.ToString(e);var r;if(arguments.length>1){r=arguments[1]}return I(this,t,r)!==-1},codePointAt:function codePointAt(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);var n=t.length;if(r>=0&&r<n){var o=t.charCodeAt(r);var i=r+1===n;if(o<55296||o>56319||i){return o}var a=t.charCodeAt(r+1);if(a<56320||a>57343){return o}return(o-55296)*1024+(a-56320)+65536}}};if(String.prototype.includes&&"a".includes("a",Infinity)!==false){ne(String.prototype,"includes",Fe.includes)}if(String.prototype.startsWith&&String.prototype.endsWith){var De=i(function(){return"/a/".startsWith(/a/)});var ze=a(function(){return"abc".startsWith("a",Infinity)===false});if(!De||!ze){ne(String.prototype,"startsWith",Fe.startsWith);ne(String.prototype,"endsWith",Fe.endsWith)}}if(oe){var qe=a(function(){var e=/a/;e[$.match]=false;return"/a/".startsWith(e)});if(!qe){ne(String.prototype,"startsWith",Fe.startsWith)}var We=a(function(){var e=/a/;e[$.match]=false;return"/a/".endsWith(e)});if(!We){ne(String.prototype,"endsWith",Fe.endsWith)}var Ge=a(function(){var e=/a/;e[$.match]=false;return"/a/".includes(e)});if(!Ge){ne(String.prototype,"includes",Fe.includes)}}b(String.prototype,Fe);var He=["\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join("");var Ve=new RegExp("(^["+He+"]+)|(["+He+"]+$)","g");var Be=function trim(){return ce.ToString(ce.RequireObjectCoercible(this)).replace(Ve,"")};var Ue=["\x85","\u200b","\ufffe"].join("");var $e=new RegExp("["+Ue+"]","g");var Je=/^[-+]0x[0-9a-f]+$/i;var Xe=Ue.trim().length!==Ue.length;h(String.prototype,"trim",Be,Xe);var Ke=function(e){return{value:e,done:arguments.length===0}};var Ze=function(e){ce.RequireObjectCoercible(e);this._s=ce.ToString(e);this._i=0};Ze.prototype.next=function(){var e=this._s;var t=this._i;if(typeof e==="undefined"||t>=e.length){this._s=void 0;return Ke()}var r=e.charCodeAt(t);var n,o;if(r<55296||r>56319||t+1===e.length){o=1}else{n=e.charCodeAt(t+1);o=n<56320||n>57343?1:2}this._i=t+o;return Ke(e.substr(t,o))};Me(Ze.prototype);Me(String.prototype,function(){return new Ze(this)});var Ye={from:function from(e){var r=this;var n;if(arguments.length>1){n=arguments[1]}var o,i;if(typeof n==="undefined"){o=false}else{if(!ce.IsCallable(n)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}o=true}var a=typeof(te(e)||ce.GetMethod(e,ie))!=="undefined";var u,f,s;if(a){f=ce.IsConstructor(r)?Object(new r):[];var c=ce.GetIterator(e);var l,p;s=0;while(true){l=ce.IteratorStep(c);if(l===false){break}p=l.value;try{if(o){p=typeof i==="undefined"?n(p,s):t(n,i,p,s)}f[s]=p}catch(v){ce.IteratorClose(c,true);throw v}s+=1}u=s}else{var y=ce.ToObject(e);u=ce.ToLength(y.length);f=ce.IsConstructor(r)?Object(new r(u)):new Array(u);var h;for(s=0;s<u;++s){h=y[s];if(o){h=typeof i==="undefined"?n(h,s):t(n,i,h,s)}Ne(f,s,h)}}f.length=u;return f},of:function of(){var e=arguments.length;var t=this;var n=r(t)||!ce.IsCallable(t)?new Array(e):ce.Construct(t,[e]);for(var o=0;o<e;++o){Ne(n,o,arguments[o])}n.length=e;return n}};b(Array,Ye);Ce(Array);q=function(e,t){this.i=0;this.array=e;this.kind=t};b(q.prototype,{next:function(){var e=this.i;var t=this.array;if(!(this instanceof q)){throw new TypeError("Not an ArrayIterator")}if(typeof t!=="undefined"){var r=ce.ToLength(t.length);for(;e<r;e++){var n=this.kind;var o;if(n==="key"){o=e}else if(n==="value"){o=t[e]}else if(n==="entry"){o=[e,t[e]]}this.i=e+1;return Ke(o)}}this.array=void 0;return Ke()}});Me(q.prototype);var Qe=Array.of===Ye.of||function(){var e=function Foo(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&t.length===2}();if(!Qe){ne(Array,"of",Ye.of)}var et={copyWithin:function copyWithin(e,t){var r=ce.ToObject(this);var n=ce.ToLength(r.length);var o=ce.ToInteger(e);var i=ce.ToInteger(t);var a=o<0?A(n+o,0):R(o,n);var u=i<0?A(n+i,0):R(i,n);var f;if(arguments.length>2){f=arguments[2]}var s=typeof f==="undefined"?n:ce.ToInteger(f);var c=s<0?A(n+s,0):R(s,n);var l=R(c-u,n-a);var p=1;if(u<a&&a<u+l){p=-1;u+=l-1;a+=l-1}while(l>0){if(u in r){r[a]=r[u]}else{delete r[a]}u+=p;a+=p;l-=1}return r},fill:function fill(e){var t;if(arguments.length>1){t=arguments[1]}var r;if(arguments.length>2){r=arguments[2]}var n=ce.ToObject(this);var o=ce.ToLength(n.length);t=ce.ToInteger(typeof t==="undefined"?0:t);r=ce.ToInteger(typeof r==="undefined"?o:r);var i=t<0?A(o+t,0):R(t,o);var a=r<0?o+r:r;for(var u=i;u<o&&u<a;++u){n[u]=e}return n},find:function find(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#find: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0,a;i<n;i++){a=r[i];if(o){if(t(e,o,a,i,r)){return a}}else if(e(a,i,r)){return a}}},findIndex:function findIndex(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#findIndex: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0;i<n;i++){if(o){if(t(e,o,r[i],i,r)){return i}}else if(e(r[i],i,r)){return i}}return-1},keys:function keys(){return new q(this,"key")},values:function values(){return new q(this,"value")},entries:function entries(){return new q(this,"entry")}};if(Array.prototype.keys&&!ce.IsCallable([1].keys().next)){delete Array.prototype.keys}if(Array.prototype.entries&&!ce.IsCallable([1].entries().next)){delete Array.prototype.entries}if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ie]){b(Array.prototype,{values:Array.prototype[ie]});if(re.symbol($.unscopables)){Array.prototype[$.unscopables].values=true}}if(c&&Array.prototype.values&&Array.prototype.values.name!=="values"){var tt=Array.prototype.values;ne(Array.prototype,"values",function values(){return ce.Call(tt,this,arguments)});h(Array.prototype,ie,Array.prototype.values,true)}b(Array.prototype,et);if(1/[true].indexOf(true,-0)<0){h(Array.prototype,"indexOf",function indexOf(e){var t=E(this,arguments);if(t===0&&1/t<0){return 0}return t},true)}Me(Array.prototype,function(){return this.values()});if(Object.getPrototypeOf){Me(Object.getPrototypeOf([].values()))}var rt=function(){return a(function(){return Array.from({length:-1}).length===0})}();var nt=function(){var e=Array.from([0].entries());return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0}();if(!rt||!nt){ne(Array,"from",Ye.from)}var ot=function(){return a(function(){return Array.from([0],void 0)})}();if(!ot){var it=Array.from;ne(Array,"from",function from(e){if(arguments.length>1&&typeof arguments[1]!=="undefined"){return ce.Call(it,this,arguments)}else{return t(it,this,e)}})}var at=-(Math.pow(2,32)-1);var ut=function(e,r){var n={length:at};n[r?(n.length>>>0)-1:0]=true;return a(function(){t(e,n,function(){throw new RangeError("should not reach here")},[]);return true})};if(!ut(Array.prototype.forEach)){var ft=Array.prototype.forEach;ne(Array.prototype,"forEach",function forEach(e){return ce.Call(ft,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.map)){var st=Array.prototype.map;ne(Array.prototype,"map",function map(e){return ce.Call(st,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.filter)){var ct=Array.prototype.filter;ne(Array.prototype,"filter",function filter(e){return ce.Call(ct,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.some)){var lt=Array.prototype.some;ne(Array.prototype,"some",function some(e){return ce.Call(lt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.every)){var pt=Array.prototype.every;ne(Array.prototype,"every",function every(e){return ce.Call(pt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduce)){var vt=Array.prototype.reduce;ne(Array.prototype,"reduce",function reduce(e){return ce.Call(vt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduceRight,true)){var yt=Array.prototype.reduceRight;ne(Array.prototype,"reduceRight",function reduceRight(e){return ce.Call(yt,this.length>=0?this:[],arguments)},true)}var ht=Number("0o10")!==8;var bt=Number("0b10")!==2;var gt=y(Ue,function(e){return Number(e+0+e)===0});if(ht||bt||gt){var dt=Number;var mt=/^0b[01]+$/i;var Ot=/^0o[0-7]+$/i;var wt=mt.test.bind(mt);var jt=Ot.test.bind(Ot);var St=function(e){var t;if(typeof e.valueOf==="function"){t=e.valueOf();if(re.primitive(t)){return t}}if(typeof e.toString==="function"){t=e.toString();if(re.primitive(t)){return t}}throw new TypeError("No default value")};var Tt=$e.test.bind($e);var It=Je.test.bind(Je);var Et=function(){var e=function Number(t){var r;if(arguments.length>0){r=re.primitive(t)?t:St(t,"number")}else{r=0}if(typeof r==="string"){r=ce.Call(Be,r);if(wt(r)){r=parseInt(C(r,2),2)}else if(jt(r)){r=parseInt(C(r,2),8)}else if(Tt(r)||It(r)){r=NaN}}var n=this;var o=a(function(){dt.prototype.valueOf.call(n);return true});if(n instanceof e&&!o){return new dt(r)}return dt(r)};return e}();Ee(dt,Et,{});b(Et,{NaN:dt.NaN,MAX_VALUE:dt.MAX_VALUE,MIN_VALUE:dt.MIN_VALUE,NEGATIVE_INFINITY:dt.NEGATIVE_INFINITY,POSITIVE_INFINITY:dt.POSITIVE_INFINITY});Number=Et;m.redefine(S,"Number",Et)}var Pt=Math.pow(2,53)-1;b(Number,{MAX_SAFE_INTEGER:Pt,MIN_SAFE_INTEGER:-Pt,EPSILON:2.220446049250313e-16,parseInt:S.parseInt,parseFloat:S.parseFloat,isFinite:K,isInteger:function isInteger(e){return K(e)&&ce.ToInteger(e)===e},isSafeInteger:function isSafeInteger(e){return Number.isInteger(e)&&k(e)<=Number.MAX_SAFE_INTEGER},isNaN:X});h(Number,"parseInt",S.parseInt,Number.parseInt!==S.parseInt);if([,1].find(function(){return true})===1){ne(Array.prototype,"find",et.find)}if([,1].findIndex(function(){return true})!==0){ne(Array.prototype,"findIndex",et.findIndex)}var Ct=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);var Mt=function ensureEnumerable(e,t){if(s&&Ct(e,t)){Object.defineProperty(e,t,{enumerable:false})}};var xt=function sliceArgs(){var e=Number(this);var t=arguments.length;var r=t-e;var n=new Array(r<0?0:r);for(var o=e;o<t;++o){n[o-e]=arguments[o]}return n};var Nt=function assignTo(e){return function assignToSource(t,r){t[r]=e[r];return t}};var At=function(e,t){var r=n(Object(t));var o;if(ce.IsCallable(Object.getOwnPropertySymbols)){o=v(Object.getOwnPropertySymbols(Object(t)),Ct(t))}return p(P(r,o||[]),Nt(t),e)};var Rt={assign:function(e,t){var r=ce.ToObject(e,"Cannot convert undefined or null to object");return p(ce.Call(xt,1,arguments),At,r)},is:function is(e,t){return ce.SameValue(e,t)}};var _t=Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return e[1]==="y"}}();if(_t){ne(Object,"assign",Rt.assign)}b(Object,Rt);if(s){var kt={setPrototypeOf:function(e,r){var n;var o=function(e,t){if(!ce.TypeIsObject(e)){throw new TypeError("cannot set prototype on a non-object")}if(!(t===null||ce.TypeIsObject(t))){throw new TypeError("can only set prototype to an object or null"+t)}};var i=function(e,r){o(e,r);t(n,e,r);return e};try{n=e.getOwnPropertyDescriptor(e.prototype,r).set;t(n,{},null)}catch(a){if(e.prototype!=={}[r]){return}n=function(e){this[r]=e};i.polyfill=i(i({},null),e.prototype)instanceof e}return i}(Object,"__proto__")};b(Object,kt)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){(function(){var e=Object.create(null);var t=Object.getPrototypeOf;var r=Object.setPrototypeOf;Object.getPrototypeOf=function(r){var n=t(r);return n===e?null:n};Object.setPrototypeOf=function(t,n){var o=n===null?e:n;return r(t,o)};Object.setPrototypeOf.polyfill=false})()}var Lt=!i(function(){return Object.keys("foo")});if(!Lt){var Ft=Object.keys;ne(Object,"keys",function keys(e){return Ft(ce.ToObject(e))});n=Object.keys}var Dt=i(function(){return Object.keys(/a/g)});if(Dt){var zt=Object.keys;ne(Object,"keys",function keys(e){if(re.regex(e)){var t=[];for(var r in e){if(z(e,r)){M(t,r)}}return t}return zt(e)});n=Object.keys}if(Object.getOwnPropertyNames){var qt=!i(function(){return Object.getOwnPropertyNames("foo")});if(!qt){var Wt=typeof window==="object"?Object.getOwnPropertyNames(window):[];var Gt=Object.getOwnPropertyNames;ne(Object,"getOwnPropertyNames",function getOwnPropertyNames(e){var t=ce.ToObject(e);if(g(t)==="[object Window]"){try{return Gt(t)}catch(r){return P([],Wt)}}return Gt(t)})}}if(Object.getOwnPropertyDescriptor){var Ht=!i(function(){return Object.getOwnPropertyDescriptor("foo","bar")});if(!Ht){var Vt=Object.getOwnPropertyDescriptor;ne(Object,"getOwnPropertyDescriptor",function getOwnPropertyDescriptor(e,t){return Vt(ce.ToObject(e),t)})}}if(Object.seal){var Bt=!i(function(){return Object.seal("foo")});if(!Bt){var Ut=Object.seal;ne(Object,"seal",function seal(e){if(!ce.TypeIsObject(e)){return e}return Ut(e)})}}if(Object.isSealed){var $t=!i(function(){return Object.isSealed("foo")});if(!$t){var Jt=Object.isSealed;ne(Object,"isSealed",function isSealed(e){if(!ce.TypeIsObject(e)){return true}return Jt(e)})}}if(Object.freeze){var Xt=!i(function(){return Object.freeze("foo")});if(!Xt){var Kt=Object.freeze;ne(Object,"freeze",function freeze(e){if(!ce.TypeIsObject(e)){return e}return Kt(e)})}}if(Object.isFrozen){var Zt=!i(function(){return Object.isFrozen("foo")});if(!Zt){var Yt=Object.isFrozen;ne(Object,"isFrozen",function isFrozen(e){if(!ce.TypeIsObject(e)){return true}return Yt(e)})}}if(Object.preventExtensions){var Qt=!i(function(){return Object.preventExtensions("foo")});if(!Qt){var er=Object.preventExtensions;ne(Object,"preventExtensions",function preventExtensions(e){if(!ce.TypeIsObject(e)){return e}return er(e)})}}if(Object.isExtensible){var tr=!i(function(){return Object.isExtensible("foo")});if(!tr){var rr=Object.isExtensible;ne(Object,"isExtensible",function isExtensible(e){if(!ce.TypeIsObject(e)){return false}return rr(e)})}}if(Object.getPrototypeOf){var nr=!i(function(){return Object.getPrototypeOf("foo")});if(!nr){var or=Object.getPrototypeOf;ne(Object,"getPrototypeOf",function getPrototypeOf(e){return or(ce.ToObject(e))})}}var ir=s&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&ce.IsCallable(e.get)}();if(s&&!ir){var ar=function flags(){if(!ce.TypeIsObject(this)){throw new TypeError("Method called on incompatible type: must be an object.")}var e="";if(this.global){e+="g"}if(this.ignoreCase){e+="i"}if(this.multiline){e+="m"}if(this.unicode){e+="u"}if(this.sticky){e+="y"}return e};m.getter(RegExp.prototype,"flags",ar)}var ur=s&&a(function(){return String(new RegExp(/a/g,"i"))==="/a/i"});var fr=oe&&s&&function(){var e=/./;e[$.match]=false;return RegExp(e)===e}();var sr=a(function(){return RegExp.prototype.toString.call({source:"abc"})==="/abc/"});var cr=sr&&a(function(){return RegExp.prototype.toString.call({source:"a",flags:"b"})==="/a/b"});if(!sr||!cr){var lr=RegExp.prototype.toString;h(RegExp.prototype,"toString",function toString(){var e=ce.RequireObjectCoercible(this);if(re.regex(e)){return t(lr,e)}var r=ue(e.source);var n=ue(e.flags);return"/"+r+"/"+n},true);m.preserveToString(RegExp.prototype.toString,lr)}if(s&&(!ur||fr)){var pr=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get;var vr=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{};var yr=function(){return this.source};var hr=ce.IsCallable(vr.get)?vr.get:yr;var br=RegExp;var gr=function(){return function RegExp(e,t){var r=ce.IsRegExp(e);var n=this instanceof RegExp;if(!n&&r&&typeof t==="undefined"&&e.constructor===RegExp){return e}var o=e;var i=t;if(re.regex(e)){o=ce.Call(hr,e);i=typeof t==="undefined"?ce.Call(pr,e):t;return new RegExp(o,i)}else if(r){o=e.source;i=typeof t==="undefined"?e.flags:t}return new br(e,t)}}();Ee(br,gr,{$input:true});RegExp=gr;m.redefine(S,"RegExp",gr)}if(s){var dr={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(n(dr),function(e){if(e in RegExp&&!(dr[e]in RegExp)){m.getter(RegExp,dr[e],function get(){return RegExp[e]})}})}Ce(RegExp);var mr=1/Number.EPSILON;var Or=function roundTiesToEven(e){return e+mr-mr};var wr=Math.pow(2,-23);var jr=Math.pow(2,127)*(2-wr);var Sr=Math.pow(2,-126);var Tr=Math.E;var Ir=Math.LOG2E;var Er=Math.LOG10E;var Pr=Number.prototype.clz;delete Number.prototype.clz;var Cr={acosh:function acosh(e){var t=Number(e);if(X(t)||e<1){return NaN}if(t===1){return 0}if(t===Infinity){return t}var r=1/(t*t);if(t<2){return Y(t-1+D(1-r)*t)}var n=t/2;return Y(n+D(1-r)*n-1)+1/Ir},asinh:function asinh(e){var t=Number(e);if(t===0||!T(t)){return t}var r=k(t);var n=r*r;var o=Z(t);if(r<1){return o*Y(r+n/(D(n+1)+1))}return o*(Y(r/2+D(1+1/n)*r/2-1)+1/Ir)},atanh:function atanh(e){var t=Number(e);if(t===0){return t}if(t===-1){return-Infinity}if(t===1){return Infinity}if(X(t)||t<-1||t>1){return NaN}var r=k(t);return Z(t)*Y(2*r/(1-r))/2},cbrt:function cbrt(e){var t=Number(e);if(t===0){return t}var r=t<0;var n;if(r){t=-t}if(t===Infinity){n=Infinity}else{n=L(F(t)/3);n=(t/(n*n)+2*n)/3}return r?-n:n},clz32:function clz32(e){var t=Number(e);var r=ce.ToUint32(t);if(r===0){return 32}return Pr?ce.Call(Pr,r):31-_(F(r+.5)*Ir)},cosh:function cosh(e){var t=Number(e);if(t===0){return 1}if(X(t)){return NaN}if(!T(t)){return Infinity}var r=L(k(t)-1);return(r+1/(r*Tr*Tr))*(Tr/2)},expm1:function expm1(e){var t=Number(e);if(t===-Infinity){return-1}if(!T(t)||t===0){return t}if(k(t)>.5){return L(t)-1}var r=t;var n=0;var o=1;while(n+r!==n){n+=r;o+=1;r*=t/o}return n},hypot:function hypot(e,t){var r=0;var n=0;for(var o=0;o<arguments.length;++o){var i=k(Number(arguments[o]));if(n<i){r*=n/i*(n/i);r+=1;n=i}else{r+=i>0?i/n*(i/n):i}}return n===Infinity?Infinity:n*D(r)},log2:function log2(e){return F(e)*Ir},log10:function log10(e){return F(e)*Er},log1p:Y,sign:Z,sinh:function sinh(e){var t=Number(e);if(!T(t)||t===0){return t}var r=k(t);if(r<1){var n=Math.expm1(r);return Z(t)*n*(1+1/(n+1))/2}var o=L(r-1);return Z(t)*(o-1/(o*Tr*Tr))*(Tr/2)},tanh:function tanh(e){var t=Number(e);if(X(t)||t===0){return t}if(t>=20){return 1}if(t<=-20){return-1}return(Math.expm1(t)-Math.expm1(-t))/(L(t)+L(-t))},trunc:function trunc(e){var t=Number(e);return t<0?-_(-t):_(t)},imul:function imul(e,t){var r=ce.ToUint32(e);var n=ce.ToUint32(t);var o=r>>>16&65535;var i=r&65535;var a=n>>>16&65535;var u=n&65535;return i*u+(o*u+i*a<<16>>>0)|0},fround:function fround(e){var t=Number(e);if(t===0||t===Infinity||t===-Infinity||X(t)){return t}var r=Z(t);var n=k(t);if(n<Sr){return r*Or(n/Sr/wr)*Sr*wr}var o=(1+wr/Number.EPSILON)*n;var i=o-(o-n);if(i>jr||X(i)){return r*Infinity}return r*i}};var Mr=function withinULPDistance(e,t,r){return k(1-e/t)/Number.EPSILON<(r||8)};b(Math,Cr);h(Math,"sinh",Cr.sinh,Math.sinh(710)===Infinity);h(Math,"cosh",Cr.cosh,Math.cosh(710)===Infinity);h(Math,"log1p",Cr.log1p,Math.log1p(-1e-17)!==-1e-17);h(Math,"asinh",Cr.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7));h(Math,"asinh",Cr.asinh,Math.asinh(1e300)===Infinity);h(Math,"atanh",Cr.atanh,Math.atanh(1e-300)===0);h(Math,"tanh",Cr.tanh,Math.tanh(-2e-17)!==-2e-17);
h(Math,"acosh",Cr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);h(Math,"acosh",Cr.acosh,!Mr(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON)));h(Math,"cbrt",Cr.cbrt,!Mr(Math.cbrt(1e-300),1e-100));h(Math,"sinh",Cr.sinh,Math.sinh(-2e-17)!==-2e-17);var xr=Math.expm1(10);h(Math,"expm1",Cr.expm1,xr>22025.465794806718||xr<22025.465794806718);var Nr=Math.round;var Ar=Math.round(.5-Number.EPSILON/4)===0&&Math.round(-.5+Number.EPSILON/3.99)===1;var Rr=mr+1;var _r=2*mr-1;var kr=[Rr,_r].every(function(e){return Math.round(e)===e});h(Math,"round",function round(e){var t=_(e);var r=t===-1?-0:t+1;return e-t<.5?t:r},!Ar||!kr);m.preserveToString(Math.round,Nr);var Lr=Math.imul;if(Math.imul(4294967295,5)!==-5){Math.imul=Cr.imul;m.preserveToString(Math.imul,Lr)}if(Math.imul.length!==2){ne(Math,"imul",function imul(e,t){return ce.Call(Lr,Math,arguments)})}var Fr=function(){var e=S.setTimeout;if(typeof e!=="function"&&typeof e!=="object"){return}ce.IsPromise=function(e){if(!ce.TypeIsObject(e)){return false}if(typeof e._promise==="undefined"){return false}return true};var r=function(e){if(!ce.IsConstructor(e)){throw new TypeError("Bad promise constructor")}var t=this;var r=function(e,r){if(t.resolve!==void 0||t.reject!==void 0){throw new TypeError("Bad Promise implementation!")}t.resolve=e;t.reject=r};t.resolve=void 0;t.reject=void 0;t.promise=new e(r);if(!(ce.IsCallable(t.resolve)&&ce.IsCallable(t.reject))){throw new TypeError("Bad promise constructor")}};var n;if(typeof window!=="undefined"&&ce.IsCallable(window.postMessage)){n=function(){var e=[];var t="zero-timeout-message";var r=function(r){M(e,r);window.postMessage(t,"*")};var n=function(r){if(r.source===window&&r.data===t){r.stopPropagation();if(e.length===0){return}var n=N(e);n()}};window.addEventListener("message",n,true);return r}}var o=function(){var e=S.Promise;var t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}};var i=ce.IsCallable(S.setImmediate)?S.setImmediate:typeof process==="object"&&process.nextTick?process.nextTick:o()||(ce.IsCallable(n)?n():function(t){e(t,0)});var a=function(e){return e};var u=function(e){throw e};var f=0;var s=1;var c=2;var l=0;var p=1;var v=2;var y={};var h=function(e,t,r){i(function(){g(e,t,r)})};var g=function(e,t,r){var n,o;if(t===y){return e(r)}try{n=e(r);o=t.resolve}catch(i){n=i;o=t.reject}o(n)};var d=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.fulfillReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+l],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=s;r.reactionLength=0};var m=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.rejectReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+p],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=c;r.reactionLength=0};var O=function(e){var t=false;var r=function(r){var n;if(t){return}t=true;if(r===e){return m(e,new TypeError("Self resolution"))}if(!ce.TypeIsObject(r)){return d(e,r)}try{n=r.then}catch(o){return m(e,o)}if(!ce.IsCallable(n)){return d(e,r)}i(function(){j(e,r,n)})};var n=function(r){if(t){return}t=true;return m(e,r)};return{resolve:r,reject:n}};var w=function(e,r,n,o){if(e===I){t(e,r,n,o,y)}else{t(e,r,n,o)}};var j=function(e,t,r){var n=O(e);var o=n.resolve;var i=n.reject;try{w(r,t,o,i)}catch(a){i(a)}};var T,I;var E=function(){var e=function Promise(t){if(!(this instanceof e)){throw new TypeError('Constructor Promise requires "new"')}if(this&&this._promise){throw new TypeError("Bad construction")}if(!ce.IsCallable(t)){throw new TypeError("not a valid resolver")}var r=Ae(this,e,T,{_promise:{result:void 0,state:f,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}});var n=O(r);var o=n.reject;try{t(n.resolve,o)}catch(i){o(i)}return r};return e}();T=E.prototype;var P=function(e,t,r,n){var o=false;return function(i){if(o){return}o=true;t[e]=i;if(--n.count===0){var a=r.resolve;a(t)}}};var C=function(e,t,r){var n=e.iterator;var o=[];var i={count:1};var a,u;var f=0;while(true){try{a=ce.IteratorStep(n);if(a===false){e.done=true;break}u=a.value}catch(s){e.done=true;throw s}o[f]=void 0;var c=t.resolve(u);var l=P(f,o,r,i);i.count+=1;w(c.then,c,l,r.reject);f+=1}if(--i.count===0){var p=r.resolve;p(o)}return r.promise};var x=function(e,t,r){var n=e.iterator;var o,i,a;while(true){try{o=ce.IteratorStep(n);if(o===false){e.done=true;break}i=o.value}catch(u){e.done=true;throw u}a=t.resolve(i);w(a.then,a,r.resolve,r.reject)}return r.promise};b(E,{all:function all(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return C(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},race:function race(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return x(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},reject:function reject(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}var n=new r(t);var o=n.reject;o(e);return n.promise},resolve:function resolve(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}if(ce.IsPromise(e)){var n=e.constructor;if(n===t){return e}}var o=new r(t);var i=o.resolve;i(e);return o.promise}});b(T,{"catch":function(e){return this.then(null,e)},then:function then(e,t){var n=this;if(!ce.IsPromise(n)){throw new TypeError("not a promise")}var o=ce.SpeciesConstructor(n,E);var i;var b=arguments.length>2&&arguments[2]===y;if(b&&o===E){i=y}else{i=new r(o)}var g=ce.IsCallable(e)?e:a;var d=ce.IsCallable(t)?t:u;var m=n._promise;var O;if(m.state===f){if(m.reactionLength===0){m.fulfillReactionHandler0=g;m.rejectReactionHandler0=d;m.reactionCapability0=i}else{var w=3*(m.reactionLength-1);m[w+l]=g;m[w+p]=d;m[w+v]=i}m.reactionLength+=1}else if(m.state===s){O=m.result;h(g,i,O)}else if(m.state===c){O=m.result;h(d,i,O)}else{throw new TypeError("unexpected Promise state")}return i.promise}});y=new r(E);I=T.then;return E}();if(S.Promise){delete S.Promise.accept;delete S.Promise.defer;delete S.Promise.prototype.chain}if(typeof Fr==="function"){b(S,{Promise:Fr});var Dr=w(S.Promise,function(e){return e.resolve(42).then(function(){})instanceof e});var zr=!i(function(){return S.Promise.reject(42).then(null,5).then(null,W)});var qr=i(function(){return S.Promise.call(3,W)});var Wr=function(e){var t=e.resolve(5);t.constructor={};var r=e.resolve(t);try{r.then(null,W).then(null,W)}catch(n){return true}return t===r}(S.Promise);var Gr=s&&function(){var e=0;var t=Object.defineProperty({},"then",{get:function(){e+=1}});Promise.resolve(t);return e===1}();var Hr=function BadResolverPromise(e){var t=new Promise(e);e(3,function(){});this.then=t.then;this.constructor=BadResolverPromise};Hr.prototype=Promise.prototype;Hr.all=Promise.all;var Vr=a(function(){return!!Hr.all([1,2])});if(!Dr||!zr||!qr||Wr||!Gr||Vr){Promise=Fr;ne(S,"Promise",Fr)}if(Promise.all.length!==1){var Br=Promise.all;ne(Promise,"all",function all(e){return ce.Call(Br,this,arguments)})}if(Promise.race.length!==1){var Ur=Promise.race;ne(Promise,"race",function race(e){return ce.Call(Ur,this,arguments)})}if(Promise.resolve.length!==1){var $r=Promise.resolve;ne(Promise,"resolve",function resolve(e){return ce.Call($r,this,arguments)})}if(Promise.reject.length!==1){var Jr=Promise.reject;ne(Promise,"reject",function reject(e){return ce.Call(Jr,this,arguments)})}Mt(Promise,"all");Mt(Promise,"race");Mt(Promise,"resolve");Mt(Promise,"reject");Ce(Promise)}var Xr=function(e){var t=n(p(e,function(e,t){e[t]=true;return e},{}));return e.join(":")===t.join(":")};var Kr=Xr(["z","a","bb"]);var Zr=Xr(["z",1,"a","3",2]);if(s){var Yr=function fastkey(e,t){if(!t&&!Kr){return null}if(se(e)){return"^"+ce.ToString(e)}else if(typeof e==="string"){return"$"+e}else if(typeof e==="number"){if(!Zr){return"n"+e}return e}else if(typeof e==="boolean"){return"b"+e}return null};var Qr=function emptyObject(){return Object.create?Object.create(null):{}};var en=function addIterableToMap(e,n,o){if(r(o)||re.string(o)){l(o,function(e){if(!ce.TypeIsObject(e)){throw new TypeError("Iterator value "+e+" is not an entry object")}n.set(e[0],e[1])})}else if(o instanceof e){t(e.prototype.forEach,o,function(e,t){n.set(t,e)})}else{var i,a;if(!se(o)){a=n.set;if(!ce.IsCallable(a)){throw new TypeError("bad map")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{if(!ce.TypeIsObject(f)){throw new TypeError("Iterator value "+f+" is not an entry object")}t(a,n,f[0],f[1])}catch(s){ce.IteratorClose(i,true);throw s}}}}};var tn=function addIterableToSet(e,n,o){if(r(o)||re.string(o)){l(o,function(e){n.add(e)})}else if(o instanceof e){t(e.prototype.forEach,o,function(e){n.add(e)})}else{var i,a;if(!se(o)){a=n.add;if(!ce.IsCallable(a)){throw new TypeError("bad set")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{t(a,n,f)}catch(s){ce.IteratorClose(i,true);throw s}}}}};var rn={Map:function(){var e={};var r=function MapEntry(e,t){this.key=e;this.value=t;this.next=null;this.prev=null};r.prototype.isRemoved=function isRemoved(){return this.key===e};var n=function isMap(e){return!!e._es6map};var o=function requireMapSlot(e,t){if(!ce.TypeIsObject(e)||!n(e)){throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+ce.ToString(e))}};var i=function MapIterator(e,t){o(e,"[[MapIterator]]");this.head=e._head;this.i=this.head;this.kind=t};i.prototype={isMapIterator:true,next:function next(){if(!this.isMapIterator){throw new TypeError("Not a MapIterator")}var e=this.i;var t=this.kind;var r=this.head;if(typeof this.i==="undefined"){return Ke()}while(e.isRemoved()&&e!==r){e=e.prev}var n;while(e.next!==r){e=e.next;if(!e.isRemoved()){if(t==="key"){n=e.key}else if(t==="value"){n=e.value}else{n=[e.key,e.value]}this.i=e;return Ke(n)}}this.i=void 0;return Ke()}};Me(i.prototype);var a;var u=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}if(this&&this._es6map){throw new TypeError("Bad construction")}var e=Ae(this,Map,a,{_es6map:true,_head:null,_map:G?new G:null,_size:0,_storage:Qr()});var t=new r(null,null);t.next=t.prev=t;e._head=t;if(arguments.length>0){en(Map,e,arguments[0])}return e};a=u.prototype;m.getter(a,"size",function(){if(typeof this._size==="undefined"){throw new TypeError("size method called on incompatible Map")}return this._size});b(a,{get:function get(e){o(this,"get");var t;var r=Yr(e,true);if(r!==null){t=this._storage[r];if(t){return t.value}else{return}}if(this._map){t=V.call(this._map,e);if(t){return t.value}else{return}}var n=this._head;var i=n;while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){return i.value}}},has:function has(e){o(this,"has");var t=Yr(e,true);if(t!==null){return typeof this._storage[t]!=="undefined"}if(this._map){return B.call(this._map,e)}var r=this._head;var n=r;while((n=n.next)!==r){if(ce.SameValueZero(n.key,e)){return true}}return false},set:function set(e,t){o(this,"set");var n=this._head;var i=n;var a;var u=Yr(e,true);if(u!==null){if(typeof this._storage[u]!=="undefined"){this._storage[u].value=t;return this}else{a=this._storage[u]=new r(e,t);i=n.prev}}else if(this._map){if(B.call(this._map,e)){V.call(this._map,e).value=t}else{a=new r(e,t);U.call(this._map,e,a);i=n.prev}}while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){i.value=t;return this}}a=a||new r(e,t);if(ce.SameValue(-0,e)){a.key=+0}a.next=this._head;a.prev=this._head.prev;a.prev.next=a;a.next.prev=a;this._size+=1;return this},"delete":function(t){o(this,"delete");var r=this._head;var n=r;var i=Yr(t,true);if(i!==null){if(typeof this._storage[i]==="undefined"){return false}n=this._storage[i].prev;delete this._storage[i]}else if(this._map){if(!B.call(this._map,t)){return false}n=V.call(this._map,t).prev;H.call(this._map,t)}while((n=n.next)!==r){if(ce.SameValueZero(n.key,t)){n.key=e;n.value=e;n.prev.next=n.next;n.next.prev=n.prev;this._size-=1;return true}}return false},clear:function clear(){o(this,"clear");this._map=G?new G:null;this._size=0;this._storage=Qr();var t=this._head;var r=t;var n=r.next;while((r=n)!==t){r.key=e;r.value=e;n=r.next;r.next=r.prev=t}t.next=t.prev=t},keys:function keys(){o(this,"keys");return new i(this,"key")},values:function values(){o(this,"values");return new i(this,"value")},entries:function entries(){o(this,"entries");return new i(this,"key+value")},forEach:function forEach(e){o(this,"forEach");var r=arguments.length>1?arguments[1]:null;var n=this.entries();for(var i=n.next();!i.done;i=n.next()){if(r){t(e,r,i.value[1],i.value[0],this)}else{e(i.value[1],i.value[0],this)}}}});Me(a,a.entries);return u}(),Set:function(){var e=function isSet(e){return e._es6set&&typeof e._storage!=="undefined"};var r=function requireSetSlot(t,r){if(!ce.TypeIsObject(t)||!e(t)){throw new TypeError("Set.prototype."+r+" called on incompatible receiver "+ce.ToString(t))}};var o;var i=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}if(this&&this._es6set){throw new TypeError("Bad construction")}var e=Ae(this,Set,o,{_es6set:true,"[[SetData]]":null,_storage:Qr()});if(!e._es6set){throw new TypeError("bad set")}if(arguments.length>0){tn(Set,e,arguments[0])}return e};o=i.prototype;var a=function(e){var t=e;if(t==="^null"){return null}else if(t==="^undefined"){return void 0}else{var r=t.charAt(0);if(r==="$"){return C(t,1)}else if(r==="n"){return+C(t,1)}else if(r==="b"){return t==="btrue"}}return+t};var u=function ensureMap(e){if(!e["[[SetData]]"]){var t=new rn.Map;e["[[SetData]]"]=t;l(n(e._storage),function(e){var r=a(e);t.set(r,r)});e["[[SetData]]"]=t}e._storage=null};m.getter(i.prototype,"size",function(){r(this,"size");if(this._storage){return n(this._storage).length}u(this);return this["[[SetData]]"].size});b(i.prototype,{has:function has(e){r(this,"has");var t;if(this._storage&&(t=Yr(e))!==null){return!!this._storage[t]}u(this);return this["[[SetData]]"].has(e)},add:function add(e){r(this,"add");var t;if(this._storage&&(t=Yr(e))!==null){this._storage[t]=true;return this}u(this);this["[[SetData]]"].set(e,e);return this},"delete":function(e){r(this,"delete");var t;if(this._storage&&(t=Yr(e))!==null){var n=z(this._storage,t);return delete this._storage[t]&&n}u(this);return this["[[SetData]]"]["delete"](e)},clear:function clear(){r(this,"clear");if(this._storage){this._storage=Qr()}if(this["[[SetData]]"]){this["[[SetData]]"].clear()}},values:function values(){r(this,"values");u(this);return new f(this["[[SetData]]"].values())},entries:function entries(){r(this,"entries");u(this);return new f(this["[[SetData]]"].entries())},forEach:function forEach(e){r(this,"forEach");var n=arguments.length>1?arguments[1]:null;var o=this;u(o);this["[[SetData]]"].forEach(function(r,i){if(n){t(e,n,i,i,o)}else{e(i,i,o)}})}});h(i.prototype,"keys",i.prototype.values,true);Me(i.prototype,i.prototype.values);var f=function SetIterator(e){this.it=e};f.prototype={isSetIterator:true,next:function next(){if(!this.isSetIterator){throw new TypeError("Not a SetIterator")}return this.it.next()}};Me(f.prototype);return i}()};var nn=S.Set&&!Set.prototype["delete"]&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys);if(nn){S.Set=rn.Set}if(S.Map||S.Set){var on=a(function(){return new Map([[1,2]]).get(1)===2});if(!on){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,S.Map.prototype);return e};S.Map.prototype=O(G.prototype);h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var an=new Map;var un=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);e.set(-0,e);return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}();var fn=an.set(1,2)===an;if(!un||!fn){ne(Map.prototype,"set",function set(e,r){t(U,this,e===0?0:e,r);return this})}if(!un){b(Map.prototype,{get:function get(e){return t(V,this,e===0?0:e)},has:function has(e){return t(B,this,e===0?0:e)}},true);m.preserveToString(Map.prototype.get,V);m.preserveToString(Map.prototype.has,B)}var sn=new Set;var cn=Set.prototype["delete"]&&Set.prototype.add&&Set.prototype.has&&function(e){e["delete"](0);e.add(-0);return!e.has(0)}(sn);var ln=sn.add(1)===sn;if(!cn||!ln){var pn=Set.prototype.add;Set.prototype.add=function add(e){t(pn,this,e===0?0:e);return this};m.preserveToString(Set.prototype.add,pn)}if(!cn){var vn=Set.prototype.has;Set.prototype.has=function has(e){return t(vn,this,e===0?0:e)};m.preserveToString(Set.prototype.has,vn);var yn=Set.prototype["delete"];Set.prototype["delete"]=function SetDelete(e){return t(yn,this,e===0?0:e)};m.preserveToString(Set.prototype["delete"],yn)}var hn=w(S.Map,function(e){var t=new e([]);t.set(42,42);return t instanceof e});var bn=Object.setPrototypeOf&&!hn;var gn=function(){try{return!(S.Map()instanceof S.Map)}catch(e){return e instanceof TypeError}}();if(S.Map.length!==0||bn||!gn){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Map.prototype);return e};S.Map.prototype=G.prototype;h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var dn=w(S.Set,function(e){var t=new e([]);t.add(42,42);return t instanceof e});var mn=Object.setPrototypeOf&&!dn;var On=function(){try{return!(S.Set()instanceof S.Set)}catch(e){return e instanceof TypeError}}();if(S.Set.length!==0||mn||!On){var wn=S.Set;S.Set=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}var e=new wn;if(arguments.length>0){tn(Set,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Set.prototype);return e};S.Set.prototype=wn.prototype;h(S.Set.prototype,"constructor",S.Set,true);m.preserveToString(S.Set,wn)}var jn=new S.Map;var Sn=!a(function(){return jn.keys().next().done});if(typeof S.Map.prototype.clear!=="function"||(new S.Set).size!==0||jn.size!==0||typeof S.Map.prototype.keys!=="function"||typeof S.Set.prototype.keys!=="function"||typeof S.Map.prototype.forEach!=="function"||typeof S.Set.prototype.forEach!=="function"||u(S.Map)||u(S.Set)||typeof jn.keys().next!=="function"||Sn||!hn){b(S,{Map:rn.Map,Set:rn.Set},true)}if(S.Set.prototype.keys!==S.Set.prototype.values){h(S.Set.prototype,"keys",S.Set.prototype.values,true)}Me(Object.getPrototypeOf((new S.Map).keys()));Me(Object.getPrototypeOf((new S.Set).keys()));if(c&&S.Set.prototype.has.name!=="has"){var Tn=S.Set.prototype.has;ne(S.Set.prototype,"has",function has(e){return t(Tn,this,e)})}}b(S,rn);Ce(S.Map);Ce(S.Set)}var In=function throwUnlessTargetIsObject(e){if(!ce.TypeIsObject(e)){throw new TypeError("target must be an object")}};var En={apply:function apply(){return ce.Call(ce.Call,null,arguments)},construct:function construct(e,t){if(!ce.IsConstructor(e)){throw new TypeError("First argument must be a constructor.")}var r=arguments.length>2?arguments[2]:e;if(!ce.IsConstructor(r)){throw new TypeError("new.target must be a constructor.")}return ce.Construct(e,t,r,"internal")},deleteProperty:function deleteProperty(e,t){In(e);if(s){var r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){return false}}return delete e[t]},has:function has(e,t){In(e);return t in e}};if(Object.getOwnPropertyNames){Object.assign(En,{ownKeys:function ownKeys(e){In(e);var t=Object.getOwnPropertyNames(e);if(ce.IsCallable(Object.getOwnPropertySymbols)){x(t,Object.getOwnPropertySymbols(e))}return t}})}var Pn=function ConvertExceptionToBoolean(e){return!i(e)};if(Object.preventExtensions){Object.assign(En,{isExtensible:function isExtensible(e){In(e);return Object.isExtensible(e)},preventExtensions:function preventExtensions(e){In(e);return Pn(function(){return Object.preventExtensions(e)})}})}if(s){var Cn=function get(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(!n){var o=Object.getPrototypeOf(e);if(o===null){return void 0}return Cn(o,t,r)}if("value"in n){return n.value}if(n.get){return ce.Call(n.get,r)}return void 0};var Mn=function set(e,r,n,o){var i=Object.getOwnPropertyDescriptor(e,r);if(!i){var a=Object.getPrototypeOf(e);if(a!==null){return Mn(a,r,n,o)}i={value:void 0,writable:true,enumerable:true,configurable:true}}if("value"in i){if(!i.writable){return false}if(!ce.TypeIsObject(o)){return false}var u=Object.getOwnPropertyDescriptor(o,r);if(u){return ae.defineProperty(o,r,{value:n})}else{return ae.defineProperty(o,r,{value:n,writable:true,enumerable:true,configurable:true})}}if(i.set){t(i.set,o,n);return true}return false};Object.assign(En,{defineProperty:function defineProperty(e,t,r){In(e);return Pn(function(){return Object.defineProperty(e,t,r)})},getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){In(e);return Object.getOwnPropertyDescriptor(e,t)},get:function get(e,t){In(e);var r=arguments.length>2?arguments[2]:e;return Cn(e,t,r)},set:function set(e,t,r){In(e);var n=arguments.length>3?arguments[3]:e;return Mn(e,t,r,n)}})}if(Object.getPrototypeOf){var xn=Object.getPrototypeOf;En.getPrototypeOf=function getPrototypeOf(e){In(e);return xn(e)}}if(Object.setPrototypeOf&&En.getPrototypeOf){var Nn=function(e,t){var r=t;while(r){if(e===r){return true}r=En.getPrototypeOf(r)}return false};Object.assign(En,{setPrototypeOf:function setPrototypeOf(e,t){In(e);if(t!==null&&!ce.TypeIsObject(t)){throw new TypeError("proto must be an object or null")}if(t===ae.getPrototypeOf(e)){return true}if(ae.isExtensible&&!ae.isExtensible(e)){return false}if(Nn(e,t)){return false}Object.setPrototypeOf(e,t);return true}})}var An=function(e,t){if(!ce.IsCallable(S.Reflect[e])){h(S.Reflect,e,t)}else{var r=a(function(){S.Reflect[e](1);S.Reflect[e](NaN);S.Reflect[e](true);return true});if(r){ne(S.Reflect,e,t)}}};Object.keys(En).forEach(function(e){An(e,En[e])});var Rn=S.Reflect.getPrototypeOf;if(c&&Rn&&Rn.name!=="getPrototypeOf"){ne(S.Reflect,"getPrototypeOf",function getPrototypeOf(e){return t(Rn,S.Reflect,e)})}if(S.Reflect.setPrototypeOf){if(a(function(){S.Reflect.setPrototypeOf(1,{});return true})){ne(S.Reflect,"setPrototypeOf",En.setPrototypeOf)}}if(S.Reflect.defineProperty){if(!a(function(){var e=!S.Reflect.defineProperty(1,"test",{value:1});var t=typeof Object.preventExtensions!=="function"||!S.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})){ne(S.Reflect,"defineProperty",En.defineProperty)}}if(S.Reflect.construct){if(!a(function(){var e=function F(){};return S.Reflect.construct(function(){},[],e)instanceof e})){ne(S.Reflect,"construct",En.construct)}}if(String(new Date(NaN))!=="Invalid Date"){var _n=Date.prototype.toString;var kn=function toString(){var e=+this;if(e!==e){return"Invalid Date"}return ce.Call(_n,this)};ne(Date.prototype,"toString",kn)}var Ln={anchor:function anchor(e){return ce.CreateHTML(this,"a","name",e)},big:function big(){return ce.CreateHTML(this,"big","","")},blink:function blink(){return ce.CreateHTML(this,"blink","","")},bold:function bold(){return ce.CreateHTML(this,"b","","")},fixed:function fixed(){return ce.CreateHTML(this,"tt","","")},fontcolor:function fontcolor(e){return ce.CreateHTML(this,"font","color",e)},fontsize:function fontsize(e){return ce.CreateHTML(this,"font","size",e)},italics:function italics(){return ce.CreateHTML(this,"i","","")},link:function link(e){return ce.CreateHTML(this,"a","href",e)},small:function small(){return ce.CreateHTML(this,"small","","")},strike:function strike(){return ce.CreateHTML(this,"strike","","")},sub:function sub(){return ce.CreateHTML(this,"sub","","")},sup:function sub(){return ce.CreateHTML(this,"sup","","")}};l(Object.keys(Ln),function(e){var r=String.prototype[e];var n=false;if(ce.IsCallable(r)){var o=t(r,"",' " ');var i=P([],o.match(/"/g)).length;n=o!==o.toLowerCase()||i>2}else{n=true}if(n){ne(String.prototype,e,Ln[e])}});var Fn=function(){if(!oe){return false}var e=typeof JSON==="object"&&typeof JSON.stringify==="function"?JSON.stringify:null;if(!e){return false}if(typeof e($())!=="undefined"){return true}if(e([$()])!=="[null]"){return true}var t={a:$()};t[$()]=true;if(e(t)!=="{}"){return true}return false}();var Dn=a(function(){if(!oe){return true}return JSON.stringify(Object($()))==="{}"&&JSON.stringify([Object($())])==="[{}]"});if(Fn||!Dn){var zn=JSON.stringify;ne(JSON,"stringify",function stringify(e){if(typeof e==="symbol"){return}var n;if(arguments.length>1){n=arguments[1]}var o=[e];if(!r(n)){var i=ce.IsCallable(n)?n:null;var a=function(e,r){var n=i?t(i,this,e,r):r;if(typeof n!=="symbol"){if(re.symbol(n)){return Nt({})(n)}else{return n}}};o.push(a)}else{o.push(n)}if(arguments.length>2){o.push(arguments[2])}return zn.apply(this,o)})}return S});
/*! jQuery v3.7.1 | (c) OpenJS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(ie,e){"use strict";var oe=[],r=Object.getPrototypeOf,ae=oe.slice,g=oe.flat?function(e){return oe.flat.call(e)}:function(e){return oe.concat.apply([],e)},s=oe.push,se=oe.indexOf,n={},i=n.toString,ue=n.hasOwnProperty,o=ue.toString,a=o.call(Object),le={},v=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},y=function(e){return null!=e&&e===e.window},C=ie.document,u={type:!0,src:!0,nonce:!0,noModule:!0};function m(e,t,n){var r,i,o=(n=n||C).createElement("script");if(o.text=e,t)for(r in u)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function x(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[i.call(e)]||"object":typeof e}var t="3.7.1",l=/HTML$/i,ce=function(e,t){return new ce.fn.init(e,t)};function c(e){var t=!!e&&"length"in e&&e.length,n=x(e);return!v(e)&&!y(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}function fe(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}ce.fn=ce.prototype={jquery:t,constructor:ce,length:0,toArray:function(){return ae.call(this)},get:function(e){return null==e?ae.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=ce.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return ce.each(this,e)},map:function(n){return this.pushStack(ce.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(ae.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(ce.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(ce.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:oe.sort,splice:oe.splice},ce.extend=ce.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||v(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(ce.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||ce.isPlainObject(n)?n:{},i=!1,a[t]=ce.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},ce.extend({expando:"jQuery"+(t+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==i.call(e))&&(!(t=r(e))||"function"==typeof(n=ue.call(t,"constructor")&&t.constructor)&&o.call(n)===a)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){m(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(c(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},text:function(e){var t,n="",r=0,i=e.nodeType;if(!i)while(t=e[r++])n+=ce.text(t);return 1===i||11===i?e.textContent:9===i?e.documentElement.textContent:3===i||4===i?e.nodeValue:n},makeArray:function(e,t){var n=t||[];return null!=e&&(c(Object(e))?ce.merge(n,"string"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:se.call(t,e,n)},isXMLDoc:function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!l.test(t||n&&n.nodeName||"HTML")},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(c(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g(a)},guid:1,support:le}),"function"==typeof Symbol&&(ce.fn[Symbol.iterator]=oe[Symbol.iterator]),ce.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var pe=oe.pop,de=oe.sort,he=oe.splice,ge="[\\x20\\t\\r\\n\\f]",ve=new RegExp("^"+ge+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ge+"+$","g");ce.contains=function(e,t){var n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(e.contains?e.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))};var f=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function p(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e}ce.escapeSelector=function(e){return(e+"").replace(f,p)};var ye=C,me=s;!function(){var e,b,w,o,a,T,r,C,d,i,k=me,S=ce.expando,E=0,n=0,s=W(),c=W(),u=W(),h=W(),l=function(e,t){return e===t&&(a=!0),0},f="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",t="(?:\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",p="\\["+ge+"*("+t+")(?:"+ge+"*([*^$|!~]?=)"+ge+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+t+"))|)"+ge+"*\\]",g=":("+t+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+p+")*)|.*)\\)|)",v=new RegExp(ge+"+","g"),y=new RegExp("^"+ge+"*,"+ge+"*"),m=new RegExp("^"+ge+"*([>+~]|"+ge+")"+ge+"*"),x=new RegExp(ge+"|>"),j=new RegExp(g),A=new RegExp("^"+t+"$"),D={ID:new RegExp("^#("+t+")"),CLASS:new RegExp("^\\.("+t+")"),TAG:new RegExp("^("+t+"|[*])"),ATTR:new RegExp("^"+p),PSEUDO:new RegExp("^"+g),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ge+"*(even|odd|(([+-]|)(\\d*)n|)"+ge+"*(?:([+-]|)"+ge+"*(\\d+)|))"+ge+"*\\)|)","i"),bool:new RegExp("^(?:"+f+")$","i"),needsContext:new RegExp("^"+ge+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ge+"*((?:-\\d)?\\d*)"+ge+"*\\)|)(?=[^-]|$)","i")},N=/^(?:input|select|textarea|button)$/i,q=/^h\d$/i,L=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,H=/[+~]/,O=new RegExp("\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\([^\\r\\n\\f])","g"),P=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},M=function(){V()},R=J(function(e){return!0===e.disabled&&fe(e,"fieldset")},{dir:"parentNode",next:"legend"});try{k.apply(oe=ae.call(ye.childNodes),ye.childNodes),oe[ye.childNodes.length].nodeType}catch(e){k={apply:function(e,t){me.apply(e,ae.call(t))},call:function(e){me.apply(e,ae.call(arguments,1))}}}function I(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&(V(e),e=e||T,C)){if(11!==p&&(u=L.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return k.call(n,a),n}else if(f&&(a=f.getElementById(i))&&I.contains(e,a)&&a.id===i)return k.call(n,a),n}else{if(u[2])return k.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&e.getElementsByClassName)return k.apply(n,e.getElementsByClassName(i)),n}if(!(h[t+" "]||d&&d.test(t))){if(c=t,f=e,1===p&&(x.test(t)||m.test(t))){(f=H.test(t)&&U(e.parentNode)||e)==e&&le.scope||((s=e.getAttribute("id"))?s=ce.escapeSelector(s):e.setAttribute("id",s=S)),o=(l=Y(t)).length;while(o--)l[o]=(s?"#"+s:":scope")+" "+Q(l[o]);c=l.join(",")}try{return k.apply(n,f.querySelectorAll(c)),n}catch(e){h(t,!0)}finally{s===S&&e.removeAttribute("id")}}}return re(t.replace(ve,"$1"),e,n,r)}function W(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function F(e){return e[S]=!0,e}function $(e){var t=T.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function B(t){return function(e){return fe(e,"input")&&e.type===t}}function _(t){return function(e){return(fe(e,"input")||fe(e,"button"))&&e.type===t}}function z(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&R(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function X(a){return F(function(o){return o=+o,F(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function U(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function V(e){var t,n=e?e.ownerDocument||e:ye;return n!=T&&9===n.nodeType&&n.documentElement&&(r=(T=n).documentElement,C=!ce.isXMLDoc(T),i=r.matches||r.webkitMatchesSelector||r.msMatchesSelector,r.msMatchesSelector&&ye!=T&&(t=T.defaultView)&&t.top!==t&&t.addEventListener("unload",M),le.getById=$(function(e){return r.appendChild(e).id=ce.expando,!T.getElementsByName||!T.getElementsByName(ce.expando).length}),le.disconnectedMatch=$(function(e){return i.call(e,"*")}),le.scope=$(function(){return T.querySelectorAll(":scope")}),le.cssHas=$(function(){try{return T.querySelector(":has(*,:jqfake)"),!1}catch(e){return!0}}),le.getById?(b.filter.ID=function(e){var t=e.replace(O,P);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(O,P);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):t.querySelectorAll(e)},b.find.CLASS=function(e,t){if("undefined"!=typeof t.getElementsByClassName&&C)return t.getElementsByClassName(e)},d=[],$(function(e){var t;r.appendChild(e).innerHTML="<a id='"+S+"' href='' disabled='disabled'></a><select id='"+S+"-\r\\' disabled='disabled'><option selected=''></option></select>",e.querySelectorAll("[selected]").length||d.push("\\["+ge+"*(?:value|"+f+")"),e.querySelectorAll("[id~="+S+"-]").length||d.push("~="),e.querySelectorAll("a#"+S+"+*").length||d.push(".#.+[+~]"),e.querySelectorAll(":checked").length||d.push(":checked"),(t=T.createElement("input")).setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),r.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&d.push(":enabled",":disabled"),(t=T.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||d.push("\\["+ge+"*name"+ge+"*="+ge+"*(?:''|\"\")")}),le.cssHas||d.push(":has"),d=d.length&&new RegExp(d.join("|")),l=function(e,t){if(e===t)return a=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!le.sortDetached&&t.compareDocumentPosition(e)===n?e===T||e.ownerDocument==ye&&I.contains(ye,e)?-1:t===T||t.ownerDocument==ye&&I.contains(ye,t)?1:o?se.call(o,e)-se.call(o,t):0:4&n?-1:1)}),T}for(e in I.matches=function(e,t){return I(e,null,null,t)},I.matchesSelector=function(e,t){if(V(e),C&&!h[t+" "]&&(!d||!d.test(t)))try{var n=i.call(e,t);if(n||le.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){h(t,!0)}return 0<I(t,T,null,[e]).length},I.contains=function(e,t){return(e.ownerDocument||e)!=T&&V(e),ce.contains(e,t)},I.attr=function(e,t){(e.ownerDocument||e)!=T&&V(e);var n=b.attrHandle[t.toLowerCase()],r=n&&ue.call(b.attrHandle,t.toLowerCase())?n(e,t,!C):void 0;return void 0!==r?r:e.getAttribute(t)},I.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},ce.uniqueSort=function(e){var t,n=[],r=0,i=0;if(a=!le.sortStable,o=!le.sortStable&&ae.call(e,0),de.call(e,l),a){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)he.call(e,n[r],1)}return o=null,e},ce.fn.uniqueSort=function(){return this.pushStack(ce.uniqueSort(ae.apply(this)))},(b=ce.expr={cacheLength:50,createPseudo:F,match:D,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(O,P),e[3]=(e[3]||e[4]||e[5]||"").replace(O,P),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||I.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&I.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return D.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&j.test(n)&&(t=Y(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(O,P).toLowerCase();return"*"===e?function(){return!0}:function(e){return fe(e,t)}},CLASS:function(e){var t=s[e+" "];return t||(t=new RegExp("(^|"+ge+")"+e+"("+ge+"|$)"))&&s(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=I.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(v," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(d,e,t,h,g){var v="nth"!==d.slice(0,3),y="last"!==d.slice(-4),m="of-type"===e;return 1===h&&0===g?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u=v!==y?"nextSibling":"previousSibling",l=e.parentNode,c=m&&e.nodeName.toLowerCase(),f=!n&&!m,p=!1;if(l){if(v){while(u){o=e;while(o=o[u])if(m?fe(o,c):1===o.nodeType)return!1;s=u="only"===d&&!s&&"nextSibling"}return!0}if(s=[y?l.firstChild:l.lastChild],y&&f){p=(a=(r=(i=l[S]||(l[S]={}))[d]||[])[0]===E&&r[1])&&r[2],o=a&&l.childNodes[a];while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if(1===o.nodeType&&++p&&o===e){i[d]=[E,a,p];break}}else if(f&&(p=a=(r=(i=e[S]||(e[S]={}))[d]||[])[0]===E&&r[1]),!1===p)while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if((m?fe(o,c):1===o.nodeType)&&++p&&(f&&((i=o[S]||(o[S]={}))[d]=[E,p]),o===e))break;return(p-=g)===h||p%h==0&&0<=p/h}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||I.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?F(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=se.call(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:F(function(e){var r=[],i=[],s=ne(e.replace(ve,"$1"));return s[S]?F(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:F(function(t){return function(e){return 0<I(t,e).length}}),contains:F(function(t){return t=t.replace(O,P),function(e){return-1<(e.textContent||ce.text(e)).indexOf(t)}}),lang:F(function(n){return A.test(n||"")||I.error("unsupported lang: "+n),n=n.replace(O,P).toLowerCase(),function(e){var t;do{if(t=C?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=ie.location&&ie.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===r},focus:function(e){return e===function(){try{return T.activeElement}catch(e){}}()&&T.hasFocus()&&!!(e.type||e.href||~e.tabIndex)},enabled:z(!1),disabled:z(!0),checked:function(e){return fe(e,"input")&&!!e.checked||fe(e,"option")&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return q.test(e.nodeName)},input:function(e){return N.test(e.nodeName)},button:function(e){return fe(e,"input")&&"button"===e.type||fe(e,"button")},text:function(e){var t;return fe(e,"input")&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:X(function(){return[0]}),last:X(function(e,t){return[t-1]}),eq:X(function(e,t,n){return[n<0?n+t:n]}),even:X(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:X(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:X(function(e,t,n){var r;for(r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:X(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=B(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=_(e);function G(){}function Y(e,t){var n,r,i,o,a,s,u,l=c[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=y.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=m.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(ve," ")}),a=a.slice(n.length)),b.filter)!(r=D[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?I.error(e):c(e,s).slice(0)}function Q(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function J(a,e,t){var s=e.dir,u=e.next,l=u||s,c=t&&"parentNode"===l,f=n++;return e.first?function(e,t,n){while(e=e[s])if(1===e.nodeType||c)return a(e,t,n);return!1}:function(e,t,n){var r,i,o=[E,f];if(n){while(e=e[s])if((1===e.nodeType||c)&&a(e,t,n))return!0}else while(e=e[s])if(1===e.nodeType||c)if(i=e[S]||(e[S]={}),u&&fe(e,u))e=e[s]||e;else{if((r=i[l])&&r[0]===E&&r[1]===f)return o[2]=r[2];if((i[l]=o)[2]=a(e,t,n))return!0}return!1}}function K(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Z(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function ee(d,h,g,v,y,e){return v&&!v[S]&&(v=ee(v)),y&&!y[S]&&(y=ee(y,e)),F(function(e,t,n,r){var i,o,a,s,u=[],l=[],c=t.length,f=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)I(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),p=!d||!e&&h?f:Z(f,u,d,n,r);if(g?g(p,s=y||(e?d:c||v)?[]:t,n,r):s=p,v){i=Z(s,l),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(s[l[o]]=!(p[l[o]]=a))}if(e){if(y||d){if(y){i=[],o=s.length;while(o--)(a=s[o])&&i.push(p[o]=a);y(null,s=[],i,r)}o=s.length;while(o--)(a=s[o])&&-1<(i=y?se.call(e,a):u[o])&&(e[i]=!(t[i]=a))}}else s=Z(s===t?s.splice(c,s.length):s),y?y(null,t,s,r):k.apply(t,s)})}function te(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=J(function(e){return e===i},a,!0),l=J(function(e){return-1<se.call(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!=w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[J(K(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return ee(1<s&&K(c),1<s&&Q(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(ve,"$1"),t,s<n&&te(e.slice(s,n)),n<r&&te(e=e.slice(n)),n<r&&Q(e))}c.push(t)}return K(c)}function ne(e,t){var n,v,y,m,x,r,i=[],o=[],a=u[e+" "];if(!a){t||(t=Y(e)),n=t.length;while(n--)(a=te(t[n]))[S]?i.push(a):o.push(a);(a=u(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=E+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t==T||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument==T||(V(o),n=!C);while(s=v[a++])if(s(o,t||T,n)){k.call(r,o);break}i&&(E=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=pe.call(r));f=Z(f)}k.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&ce.uniqueSort(r)}return i&&(E=h,w=p),c},m?F(r):r))).selector=e}return a}function re(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&Y(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&C&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(O,P),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=D.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(O,P),H.test(o[0].type)&&U(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&Q(o)))return k.apply(n,r),n;break}}}return(l||ne(e,c))(r,t,!C,n,!t||H.test(e)&&U(t.parentNode)||t),n}G.prototype=b.filters=b.pseudos,b.setFilters=new G,le.sortStable=S.split("").sort(l).join("")===S,V(),le.sortDetached=$(function(e){return 1&e.compareDocumentPosition(T.createElement("fieldset"))}),ce.find=I,ce.expr[":"]=ce.expr.pseudos,ce.unique=ce.uniqueSort,I.compile=ne,I.select=re,I.setDocument=V,I.tokenize=Y,I.escape=ce.escapeSelector,I.getText=ce.text,I.isXML=ce.isXMLDoc,I.selectors=ce.expr,I.support=ce.support,I.uniqueSort=ce.uniqueSort}();var d=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&ce(e).is(n))break;r.push(e)}return r},h=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},b=ce.expr.match.needsContext,w=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function T(e,n,r){return v(n)?ce.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?ce.grep(e,function(e){return e===n!==r}):"string"!=typeof n?ce.grep(e,function(e){return-1<se.call(n,e)!==r}):ce.filter(n,e,r)}ce.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?ce.find.matchesSelector(r,e)?[r]:[]:ce.find.matches(e,ce.grep(t,function(e){return 1===e.nodeType}))},ce.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(ce(e).filter(function(){for(t=0;t<r;t++)if(ce.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)ce.find(e,i[t],n);return 1<r?ce.uniqueSort(n):n},filter:function(e){return this.pushStack(T(this,e||[],!1))},not:function(e){return this.pushStack(T(this,e||[],!0))},is:function(e){return!!T(this,"string"==typeof e&&b.test(e)?ce(e):e||[],!1).length}});var k,S=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(ce.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||k,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:S.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof ce?t[0]:t,ce.merge(this,ce.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:C,!0)),w.test(r[1])&&ce.isPlainObject(t))for(r in t)v(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=C.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):v(e)?void 0!==n.ready?n.ready(e):e(ce):ce.makeArray(e,this)}).prototype=ce.fn,k=ce(C);var E=/^(?:parents|prev(?:Until|All))/,j={children:!0,contents:!0,next:!0,prev:!0};function A(e,t){while((e=e[t])&&1!==e.nodeType);return e}ce.fn.extend({has:function(e){var t=ce(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(ce.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&ce(e);if(!b.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&ce.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?ce.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?se.call(ce(e),this[0]):se.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(ce.uniqueSort(ce.merge(this.get(),ce(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),ce.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return d(e,"parentNode")},parentsUntil:function(e,t,n){return d(e,"parentNode",n)},next:function(e){return A(e,"nextSibling")},prev:function(e){return A(e,"previousSibling")},nextAll:function(e){return d(e,"nextSibling")},prevAll:function(e){return d(e,"previousSibling")},nextUntil:function(e,t,n){return d(e,"nextSibling",n)},prevUntil:function(e,t,n){return d(e,"previousSibling",n)},siblings:function(e){return h((e.parentNode||{}).firstChild,e)},children:function(e){return h(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(fe(e,"template")&&(e=e.content||e),ce.merge([],e.childNodes))}},function(r,i){ce.fn[r]=function(e,t){var n=ce.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=ce.filter(t,n)),1<this.length&&(j[r]||ce.uniqueSort(n),E.test(r)&&n.reverse()),this.pushStack(n)}});var D=/[^\x20\t\r\n\f]+/g;function N(e){return e}function q(e){throw e}function L(e,t,n,r){var i;try{e&&v(i=e.promise)?i.call(e).done(t).fail(n):e&&v(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}ce.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},ce.each(e.match(D)||[],function(e,t){n[t]=!0}),n):ce.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){ce.each(e,function(e,t){v(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==x(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return ce.each(arguments,function(e,t){var n;while(-1<(n=ce.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<ce.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},ce.extend({Deferred:function(e){var o=[["notify","progress",ce.Callbacks("memory"),ce.Callbacks("memory"),2],["resolve","done",ce.Callbacks("once memory"),ce.Callbacks("once memory"),0,"resolved"],["reject","fail",ce.Callbacks("once memory"),ce.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return ce.Deferred(function(r){ce.each(o,function(e,t){var n=v(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&v(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,v(t)?s?t.call(e,l(u,o,N,s),l(u,o,q,s)):(u++,t.call(e,l(u,o,N,s),l(u,o,q,s),l(u,o,N,o.notifyWith))):(a!==N&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){ce.Deferred.exceptionHook&&ce.Deferred.exceptionHook(e,t.error),u<=i+1&&(a!==q&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(ce.Deferred.getErrorHook?t.error=ce.Deferred.getErrorHook():ce.Deferred.getStackHook&&(t.error=ce.Deferred.getStackHook()),ie.setTimeout(t))}}return ce.Deferred(function(e){o[0][3].add(l(0,e,v(r)?r:N,e.notifyWith)),o[1][3].add(l(0,e,v(t)?t:N)),o[2][3].add(l(0,e,v(n)?n:q))}).promise()},promise:function(e){return null!=e?ce.extend(e,a):a}},s={};return ce.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=ae.call(arguments),o=ce.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?ae.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(L(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||v(i[t]&&i[t].then)))return o.then();while(t--)L(i[t],a(t),o.reject);return o.promise()}});var H=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;ce.Deferred.exceptionHook=function(e,t){ie.console&&ie.console.warn&&e&&H.test(e.name)&&ie.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},ce.readyException=function(e){ie.setTimeout(function(){throw e})};var O=ce.Deferred();function P(){C.removeEventListener("DOMContentLoaded",P),ie.removeEventListener("load",P),ce.ready()}ce.fn.ready=function(e){return O.then(e)["catch"](function(e){ce.readyException(e)}),this},ce.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--ce.readyWait:ce.isReady)||(ce.isReady=!0)!==e&&0<--ce.readyWait||O.resolveWith(C,[ce])}}),ce.ready.then=O.then,"complete"===C.readyState||"loading"!==C.readyState&&!C.documentElement.doScroll?ie.setTimeout(ce.ready):(C.addEventListener("DOMContentLoaded",P),ie.addEventListener("load",P));var M=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===x(n))for(s in i=!0,n)M(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,v(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(ce(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},R=/^-ms-/,I=/-([a-z])/g;function W(e,t){return t.toUpperCase()}function F(e){return e.replace(R,"ms-").replace(I,W)}var $=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function B(){this.expando=ce.expando+B.uid++}B.uid=1,B.prototype={cache:function(e){var t=e[this.expando];return t||(t={},$(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[F(t)]=n;else for(r in t)i[F(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][F(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(F):(t=F(t))in r?[t]:t.match(D)||[]).length;while(n--)delete r[t[n]]}(void 0===t||ce.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!ce.isEmptyObject(t)}};var _=new B,z=new B,X=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,U=/[A-Z]/g;function V(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(U,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:X.test(i)?JSON.parse(i):i)}catch(e){}z.set(e,t,n)}else n=void 0;return n}ce.extend({hasData:function(e){return z.hasData(e)||_.hasData(e)},data:function(e,t,n){return z.access(e,t,n)},removeData:function(e,t){z.remove(e,t)},_data:function(e,t,n){return _.access(e,t,n)},_removeData:function(e,t){_.remove(e,t)}}),ce.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=z.get(o),1===o.nodeType&&!_.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=F(r.slice(5)),V(o,r,i[r]));_.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){z.set(this,n)}):M(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=z.get(o,n))?t:void 0!==(t=V(o,n))?t:void 0;this.each(function(){z.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){z.remove(this,e)})}}),ce.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=_.get(e,t),n&&(!r||Array.isArray(n)?r=_.access(e,t,ce.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=ce.queue(e,t),r=n.length,i=n.shift(),o=ce._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){ce.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return _.get(e,n)||_.access(e,n,{empty:ce.Callbacks("once memory").add(function(){_.remove(e,[t+"queue",n])})})}}),ce.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?ce.queue(this[0],t):void 0===n?this:this.each(function(){var e=ce.queue(this,t,n);ce._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&ce.dequeue(this,t)})},dequeue:function(e){return this.each(function(){ce.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=ce.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=_.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var G=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Y=new RegExp("^(?:([+-])=|)("+G+")([a-z%]*)$","i"),Q=["Top","Right","Bottom","Left"],J=C.documentElement,K=function(e){return ce.contains(e.ownerDocument,e)},Z={composed:!0};J.getRootNode&&(K=function(e){return ce.contains(e.ownerDocument,e)||e.getRootNode(Z)===e.ownerDocument});var ee=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&K(e)&&"none"===ce.css(e,"display")};function te(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return ce.css(e,t,"")},u=s(),l=n&&n[3]||(ce.cssNumber[t]?"":"px"),c=e.nodeType&&(ce.cssNumber[t]||"px"!==l&&+u)&&Y.exec(ce.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)ce.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,ce.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ne={};function re(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=_.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ee(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ne[s])||(o=a.body.appendChild(a.createElement(s)),u=ce.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ne[s]=u)))):"none"!==n&&(l[c]="none",_.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}ce.fn.extend({show:function(){return re(this,!0)},hide:function(){return re(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ee(this)?ce(this).show():ce(this).hide()})}});var xe,be,we=/^(?:checkbox|radio)$/i,Te=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,Ce=/^$|^module$|\/(?:java|ecma)script/i;xe=C.createDocumentFragment().appendChild(C.createElement("div")),(be=C.createElement("input")).setAttribute("type","radio"),be.setAttribute("checked","checked"),be.setAttribute("name","t"),xe.appendChild(be),le.checkClone=xe.cloneNode(!0).cloneNode(!0).lastChild.checked,xe.innerHTML="<textarea>x</textarea>",le.noCloneChecked=!!xe.cloneNode(!0).lastChild.defaultValue,xe.innerHTML="<option></option>",le.option=!!xe.lastChild;var ke={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function Se(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&fe(e,t)?ce.merge([e],n):n}function Ee(e,t){for(var n=0,r=e.length;n<r;n++)_.set(e[n],"globalEval",!t||_.get(t[n],"globalEval"))}ke.tbody=ke.tfoot=ke.colgroup=ke.caption=ke.thead,ke.th=ke.td,le.option||(ke.optgroup=ke.option=[1,"<select multiple='multiple'>","</select>"]);var je=/<|&#?\w+;/;function Ae(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===x(o))ce.merge(p,o.nodeType?[o]:o);else if(je.test(o)){a=a||f.appendChild(t.createElement("div")),s=(Te.exec(o)||["",""])[1].toLowerCase(),u=ke[s]||ke._default,a.innerHTML=u[1]+ce.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;ce.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<ce.inArray(o,r))i&&i.push(o);else if(l=K(o),a=Se(f.appendChild(o),"script"),l&&Ee(a),n){c=0;while(o=a[c++])Ce.test(o.type||"")&&n.push(o)}return f}var De=/^([^.]*)(?:\.(.+)|)/;function Ne(){return!0}function qe(){return!1}function Le(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Le(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=qe;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return ce().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=ce.guid++)),e.each(function(){ce.event.add(this,t,i,r,n)})}function He(e,r,t){t?(_.set(e,r,!1),ce.event.add(e,r,{namespace:!1,handler:function(e){var t,n=_.get(this,r);if(1&e.isTrigger&&this[r]){if(n)(ce.event.special[r]||{}).delegateType&&e.stopPropagation();else if(n=ae.call(arguments),_.set(this,r,n),this[r](),t=_.get(this,r),_.set(this,r,!1),n!==t)return e.stopImmediatePropagation(),e.preventDefault(),t}else n&&(_.set(this,r,ce.event.trigger(n[0],n.slice(1),this)),e.stopPropagation(),e.isImmediatePropagationStopped=Ne)}})):void 0===_.get(e,r)&&ce.event.add(e,r,Ne)}ce.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.get(t);if($(t)){n.handler&&(n=(o=n).handler,i=o.selector),i&&ce.find.matchesSelector(J,i),n.guid||(n.guid=ce.guid++),(u=v.events)||(u=v.events=Object.create(null)),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof ce&&ce.event.triggered!==e.type?ce.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(D)||[""]).length;while(l--)d=g=(s=De.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=ce.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=ce.event.special[d]||{},c=ce.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&ce.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),ce.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.hasData(e)&&_.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(D)||[""]).length;while(l--)if(d=g=(s=De.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=ce.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||ce.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)ce.event.remove(e,d+t[l],n,r,!0);ce.isEmptyObject(u)&&_.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=new Array(arguments.length),u=ce.event.fix(e),l=(_.get(this,"events")||Object.create(null))[u.type]||[],c=ce.event.special[u.type]||{};for(s[0]=u,t=1;t<arguments.length;t++)s[t]=arguments[t];if(u.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,u)){a=ce.event.handlers.call(this,u,l),t=0;while((i=a[t++])&&!u.isPropagationStopped()){u.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!u.isImmediatePropagationStopped())u.rnamespace&&!1!==o.namespace&&!u.rnamespace.test(o.namespace)||(u.handleObj=o,u.data=o.data,void 0!==(r=((ce.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))&&!1===(u.result=r)&&(u.preventDefault(),u.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,u),u.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<ce(i,this).index(l):ce.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(ce.Event.prototype,t,{enumerable:!0,configurable:!0,get:v(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[ce.expando]?e:new ce.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click",!0),!1},trigger:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click"),!0},_default:function(e){var t=e.target;return we.test(t.type)&&t.click&&fe(t,"input")&&_.get(t,"click")||fe(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},ce.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},ce.Event=function(e,t){if(!(this instanceof ce.Event))return new ce.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Ne:qe,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&ce.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[ce.expando]=!0},ce.Event.prototype={constructor:ce.Event,isDefaultPrevented:qe,isPropagationStopped:qe,isImmediatePropagationStopped:qe,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Ne,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Ne,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Ne,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},ce.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},ce.event.addProp),ce.each({focus:"focusin",blur:"focusout"},function(r,i){function o(e){if(C.documentMode){var t=_.get(this,"handle"),n=ce.event.fix(e);n.type="focusin"===e.type?"focus":"blur",n.isSimulated=!0,t(e),n.target===n.currentTarget&&t(n)}else ce.event.simulate(i,e.target,ce.event.fix(e))}ce.event.special[r]={setup:function(){var e;if(He(this,r,!0),!C.documentMode)return!1;(e=_.get(this,i))||this.addEventListener(i,o),_.set(this,i,(e||0)+1)},trigger:function(){return He(this,r),!0},teardown:function(){var e;if(!C.documentMode)return!1;(e=_.get(this,i)-1)?_.set(this,i,e):(this.removeEventListener(i,o),_.remove(this,i))},_default:function(e){return _.get(e.target,r)},delegateType:i},ce.event.special[i]={setup:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i);n||(C.documentMode?this.addEventListener(i,o):e.addEventListener(r,o,!0)),_.set(t,i,(n||0)+1)},teardown:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i)-1;n?_.set(t,i,n):(C.documentMode?this.removeEventListener(i,o):e.removeEventListener(r,o,!0),_.remove(t,i))}}}),ce.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){ce.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||ce.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),ce.fn.extend({on:function(e,t,n,r){return Le(this,e,t,n,r)},one:function(e,t,n,r){return Le(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,ce(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=qe),this.each(function(){ce.event.remove(this,e,n,t)})}});var Oe=/<script|<style|<link/i,Pe=/checked\s*(?:[^=]|=\s*.checked.)/i,Me=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function Re(e,t){return fe(e,"table")&&fe(11!==t.nodeType?t:t.firstChild,"tr")&&ce(e).children("tbody")[0]||e}function Ie(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function We(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Fe(e,t){var n,r,i,o,a,s;if(1===t.nodeType){if(_.hasData(e)&&(s=_.get(e).events))for(i in _.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)ce.event.add(t,i,s[i][n]);z.hasData(e)&&(o=z.access(e),a=ce.extend({},o),z.set(t,a))}}function $e(n,r,i,o){r=g(r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=v(d);if(h||1<f&&"string"==typeof d&&!le.checkClone&&Pe.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),$e(t,r,i,o)});if(f&&(t=(e=Ae(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=ce.map(Se(e,"script"),Ie)).length;c<f;c++)u=e,c!==p&&(u=ce.clone(u,!0,!0),s&&ce.merge(a,Se(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,ce.map(a,We),c=0;c<s;c++)u=a[c],Ce.test(u.type||"")&&!_.access(u,"globalEval")&&ce.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?ce._evalUrl&&!u.noModule&&ce._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):m(u.textContent.replace(Me,""),u,l))}return n}function Be(e,t,n){for(var r,i=t?ce.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||ce.cleanData(Se(r)),r.parentNode&&(n&&K(r)&&Ee(Se(r,"script")),r.parentNode.removeChild(r));return e}ce.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=K(e);if(!(le.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||ce.isXMLDoc(e)))for(a=Se(c),r=0,i=(o=Se(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&we.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||Se(e),a=a||Se(c),r=0,i=o.length;r<i;r++)Fe(o[r],a[r]);else Fe(e,c);return 0<(a=Se(c,"script")).length&&Ee(a,!f&&Se(e,"script")),c},cleanData:function(e){for(var t,n,r,i=ce.event.special,o=0;void 0!==(n=e[o]);o++)if($(n)){if(t=n[_.expando]){if(t.events)for(r in t.events)i[r]?ce.event.remove(n,r):ce.removeEvent(n,r,t.handle);n[_.expando]=void 0}n[z.expando]&&(n[z.expando]=void 0)}}}),ce.fn.extend({detach:function(e){return Be(this,e,!0)},remove:function(e){return Be(this,e)},text:function(e){return M(this,function(e){return void 0===e?ce.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return $e(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Re(this,e).appendChild(e)})},prepend:function(){return $e(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Re(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(ce.cleanData(Se(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return ce.clone(this,e,t)})},html:function(e){return M(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Oe.test(e)&&!ke[(Te.exec(e)||["",""])[1].toLowerCase()]){e=ce.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(ce.cleanData(Se(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return $e(this,arguments,function(e){var t=this.parentNode;ce.inArray(this,n)<0&&(ce.cleanData(Se(this)),t&&t.replaceChild(e,this))},n)}}),ce.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){ce.fn[e]=function(e){for(var t,n=[],r=ce(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),ce(r[o])[a](t),s.apply(n,t.get());return this.pushStack(n)}});var _e=new RegExp("^("+G+")(?!px)[a-z%]+$","i"),ze=/^--/,Xe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=ie),t.getComputedStyle(e)},Ue=function(e,t,n){var r,i,o={};for(i in t)o[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=o[i];return r},Ve=new RegExp(Q.join("|"),"i");function Ge(e,t,n){var r,i,o,a,s=ze.test(t),u=e.style;return(n=n||Xe(e))&&(a=n.getPropertyValue(t)||n[t],s&&a&&(a=a.replace(ve,"$1")||void 0),""!==a||K(e)||(a=ce.style(e,t)),!le.pixelBoxStyles()&&_e.test(a)&&Ve.test(t)&&(r=u.width,i=u.minWidth,o=u.maxWidth,u.minWidth=u.maxWidth=u.width=a,a=n.width,u.width=r,u.minWidth=i,u.maxWidth=o)),void 0!==a?a+"":a}function Ye(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",J.appendChild(u).appendChild(l);var e=ie.getComputedStyle(l);n="1%"!==e.top,s=12===t(e.marginLeft),l.style.right="60%",o=36===t(e.right),r=36===t(e.width),l.style.position="absolute",i=12===t(l.offsetWidth/3),J.removeChild(u),l=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s,u=C.createElement("div"),l=C.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",le.clearCloneStyle="content-box"===l.style.backgroundClip,ce.extend(le,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),s},scrollboxSize:function(){return e(),i},reliableTrDimensions:function(){var e,t,n,r;return null==a&&(e=C.createElement("table"),t=C.createElement("tr"),n=C.createElement("div"),e.style.cssText="position:absolute;left:-11111px;border-collapse:separate",t.style.cssText="box-sizing:content-box;border:1px solid",t.style.height="1px",n.style.height="9px",n.style.display="block",J.appendChild(e).appendChild(t).appendChild(n),r=ie.getComputedStyle(t),a=parseInt(r.height,10)+parseInt(r.borderTopWidth,10)+parseInt(r.borderBottomWidth,10)===t.offsetHeight,J.removeChild(e)),a}}))}();var Qe=["Webkit","Moz","ms"],Je=C.createElement("div").style,Ke={};function Ze(e){var t=ce.cssProps[e]||Ke[e];return t||(e in Je?e:Ke[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Qe.length;while(n--)if((e=Qe[n]+t)in Je)return e}(e)||e)}var et=/^(none|table(?!-c[ea]).+)/,tt={position:"absolute",visibility:"hidden",display:"block"},nt={letterSpacing:"0",fontWeight:"400"};function rt(e,t,n){var r=Y.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function it(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0,l=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(l+=ce.css(e,n+Q[a],!0,i)),r?("content"===n&&(u-=ce.css(e,"padding"+Q[a],!0,i)),"margin"!==n&&(u-=ce.css(e,"border"+Q[a]+"Width",!0,i))):(u+=ce.css(e,"padding"+Q[a],!0,i),"padding"!==n?u+=ce.css(e,"border"+Q[a]+"Width",!0,i):s+=ce.css(e,"border"+Q[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u+l}function ot(e,t,n){var r=Xe(e),i=(!le.boxSizingReliable()||n)&&"border-box"===ce.css(e,"boxSizing",!1,r),o=i,a=Ge(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(_e.test(a)){if(!n)return a;a="auto"}return(!le.boxSizingReliable()&&i||!le.reliableTrDimensions()&&fe(e,"tr")||"auto"===a||!parseFloat(a)&&"inline"===ce.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===ce.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+it(e,t,n||(i?"border":"content"),o,r,a)+"px"}function at(e,t,n,r,i){return new at.prototype.init(e,t,n,r,i)}ce.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Ge(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=F(t),u=ze.test(t),l=e.style;if(u||(t=Ze(s)),a=ce.cssHooks[t]||ce.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=Y.exec(n))&&i[1]&&(n=te(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(ce.cssNumber[s]?"":"px")),le.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=F(t);return ze.test(t)||(t=Ze(s)),(a=ce.cssHooks[t]||ce.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=Ge(e,t,r)),"normal"===i&&t in nt&&(i=nt[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),ce.each(["height","width"],function(e,u){ce.cssHooks[u]={get:function(e,t,n){if(t)return!et.test(ce.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?ot(e,u,n):Ue(e,tt,function(){return ot(e,u,n)})},set:function(e,t,n){var r,i=Xe(e),o=!le.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===ce.css(e,"boxSizing",!1,i),s=n?it(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-it(e,u,"border",!1,i)-.5)),s&&(r=Y.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=ce.css(e,u)),rt(0,t,s)}}}),ce.cssHooks.marginLeft=Ye(le.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Ge(e,"marginLeft"))||e.getBoundingClientRect().left-Ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),ce.each({margin:"",padding:"",border:"Width"},function(i,o){ce.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+Q[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(ce.cssHooks[i+o].set=rt)}),ce.fn.extend({css:function(e,t){return M(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Xe(e),i=t.length;a<i;a++)o[t[a]]=ce.css(e,t[a],!1,r);return o}return void 0!==n?ce.style(e,t,n):ce.css(e,t)},e,t,1<arguments.length)}}),((ce.Tween=at).prototype={constructor:at,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||ce.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(ce.cssNumber[n]?"":"px")},cur:function(){var e=at.propHooks[this.prop];return e&&e.get?e.get(this):at.propHooks._default.get(this)},run:function(e){var t,n=at.propHooks[this.prop];return this.options.duration?this.pos=t=ce.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):at.propHooks._default.set(this),this}}).init.prototype=at.prototype,(at.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=ce.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){ce.fx.step[e.prop]?ce.fx.step[e.prop](e):1!==e.elem.nodeType||!ce.cssHooks[e.prop]&&null==e.elem.style[Ze(e.prop)]?e.elem[e.prop]=e.now:ce.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=at.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},ce.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},ce.fx=at.prototype.init,ce.fx.step={};var st,ut,lt,ct,ft=/^(?:toggle|show|hide)$/,pt=/queueHooks$/;function dt(){ut&&(!1===C.hidden&&ie.requestAnimationFrame?ie.requestAnimationFrame(dt):ie.setTimeout(dt,ce.fx.interval),ce.fx.tick())}function ht(){return ie.setTimeout(function(){st=void 0}),st=Date.now()}function gt(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=Q[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function vt(e,t,n){for(var r,i=(yt.tweeners[t]||[]).concat(yt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function yt(o,e,t){var n,a,r=0,i=yt.prefilters.length,s=ce.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=st||ht(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:ce.extend({},e),opts:ce.extend(!0,{specialEasing:{},easing:ce.easing._default},t),originalProperties:e,originalOptions:t,startTime:st||ht(),duration:t.duration,tweens:[],createTween:function(e,t){var n=ce.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=F(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=ce.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=yt.prefilters[r].call(l,o,c,l.opts))return v(n.stop)&&(ce._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return ce.map(c,vt,l),v(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),ce.fx.timer(ce.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}ce.Animation=ce.extend(yt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return te(n.elem,e,Y.exec(t),n),n}]},tweener:function(e,t){v(e)?(t=e,e=["*"]):e=e.match(D);for(var n,r=0,i=e.length;r<i;r++)n=e[r],yt.tweeners[n]=yt.tweeners[n]||[],yt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ee(e),v=_.get(e,"fxshow");for(r in n.queue||(null==(a=ce._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,ce.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],ft.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||ce.style(e,r)}if((u=!ce.isEmptyObject(t))||!ce.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=_.get(e,"display")),"none"===(c=ce.css(e,"display"))&&(l?c=l:(re([e],!0),l=e.style.display||l,c=ce.css(e,"display"),re([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===ce.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=_.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&re([e],!0),p.done(function(){for(r in g||re([e]),_.remove(e,"fxshow"),d)ce.style(e,r,d[r])})),u=vt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?yt.prefilters.unshift(e):yt.prefilters.push(e)}}),ce.speed=function(e,t,n){var r=e&&"object"==typeof e?ce.extend({},e):{complete:n||!n&&t||v(e)&&e,duration:e,easing:n&&t||t&&!v(t)&&t};return ce.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in ce.fx.speeds?r.duration=ce.fx.speeds[r.duration]:r.duration=ce.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){v(r.old)&&r.old.call(this),r.queue&&ce.dequeue(this,r.queue)},r},ce.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ee).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=ce.isEmptyObject(t),o=ce.speed(e,n,r),a=function(){var e=yt(this,ce.extend({},t),o);(i||_.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=ce.timers,r=_.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&pt.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||ce.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=_.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=ce.timers,o=n?n.length:0;for(t.finish=!0,ce.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),ce.each(["toggle","show","hide"],function(e,r){var i=ce.fn[r];ce.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(gt(r,!0),e,t,n)}}),ce.each({slideDown:gt("show"),slideUp:gt("hide"),slideToggle:gt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){ce.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),ce.timers=[],ce.fx.tick=function(){var e,t=0,n=ce.timers;for(st=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||ce.fx.stop(),st=void 0},ce.fx.timer=function(e){ce.timers.push(e),ce.fx.start()},ce.fx.interval=13,ce.fx.start=function(){ut||(ut=!0,dt())},ce.fx.stop=function(){ut=null},ce.fx.speeds={slow:600,fast:200,_default:400},ce.fn.delay=function(r,e){return r=ce.fx&&ce.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=ie.setTimeout(e,r);t.stop=function(){ie.clearTimeout(n)}})},lt=C.createElement("input"),ct=C.createElement("select").appendChild(C.createElement("option")),lt.type="checkbox",le.checkOn=""!==lt.value,le.optSelected=ct.selected,(lt=C.createElement("input")).value="t",lt.type="radio",le.radioValue="t"===lt.value;var mt,xt=ce.expr.attrHandle;ce.fn.extend({attr:function(e,t){return M(this,ce.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){ce.removeAttr(this,e)})}}),ce.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?ce.prop(e,t,n):(1===o&&ce.isXMLDoc(e)||(i=ce.attrHooks[t.toLowerCase()]||(ce.expr.match.bool.test(t)?mt:void 0)),void 0!==n?null===n?void ce.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=ce.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!le.radioValue&&"radio"===t&&fe(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(D);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),mt={set:function(e,t,n){return!1===t?ce.removeAttr(e,n):e.setAttribute(n,n),n}},ce.each(ce.expr.match.bool.source.match(/\w+/g),function(e,t){var a=xt[t]||ce.find.attr;xt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=xt[o],xt[o]=r,r=null!=a(e,t,n)?o:null,xt[o]=i),r}});var bt=/^(?:input|select|textarea|button)$/i,wt=/^(?:a|area)$/i;function Tt(e){return(e.match(D)||[]).join(" ")}function Ct(e){return e.getAttribute&&e.getAttribute("class")||""}function kt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(D)||[]}ce.fn.extend({prop:function(e,t){return M(this,ce.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[ce.propFix[e]||e]})}}),ce.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&ce.isXMLDoc(e)||(t=ce.propFix[t]||t,i=ce.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=ce.find.attr(e,"tabindex");return t?parseInt(t,10):bt.test(e.nodeName)||wt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),le.optSelected||(ce.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),ce.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){ce.propFix[this.toLowerCase()]=this}),ce.fn.extend({addClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).addClass(t.call(this,e,Ct(this)))}):(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++)i=e[o],n.indexOf(" "+i+" ")<0&&(n+=i+" ");a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this},removeClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).removeClass(t.call(this,e,Ct(this)))}):arguments.length?(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++){i=e[o];while(-1<n.indexOf(" "+i+" "))n=n.replace(" "+i+" "," ")}a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this:this.attr("class","")},toggleClass:function(t,n){var e,r,i,o,a=typeof t,s="string"===a||Array.isArray(t);return v(t)?this.each(function(e){ce(this).toggleClass(t.call(this,e,Ct(this),n),n)}):"boolean"==typeof n&&s?n?this.addClass(t):this.removeClass(t):(e=kt(t),this.each(function(){if(s)for(o=ce(this),i=0;i<e.length;i++)r=e[i],o.hasClass(r)?o.removeClass(r):o.addClass(r);else void 0!==t&&"boolean"!==a||((r=Ct(this))&&_.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===t?"":_.get(this,"__className__")||""))}))},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+Tt(Ct(n))+" ").indexOf(t))return!0;return!1}});var St=/\r/g;ce.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=v(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,ce(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=ce.map(t,function(e){return null==e?"":e+""})),(r=ce.valHooks[this.type]||ce.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=ce.valHooks[t.type]||ce.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(St,""):null==e?"":e:void 0}}),ce.extend({valHooks:{option:{get:function(e){var t=ce.find.attr(e,"value");return null!=t?t:Tt(ce.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!fe(n.parentNode,"optgroup"))){if(t=ce(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=ce.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<ce.inArray(ce.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),ce.each(["radio","checkbox"],function(){ce.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<ce.inArray(ce(e).val(),t)}},le.checkOn||(ce.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Et=ie.location,jt={guid:Date.now()},At=/\?/;ce.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{t=(new ie.DOMParser).parseFromString(e,"text/xml")}catch(e){}return n=t&&t.getElementsByTagName("parsererror")[0],t&&!n||ce.error("Invalid XML: "+(n?ce.map(n.childNodes,function(e){return e.textContent}).join("\n"):e)),t};var Dt=/^(?:focusinfocus|focusoutblur)$/,Nt=function(e){e.stopPropagation()};ce.extend(ce.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||C],d=ue.call(e,"type")?e.type:e,h=ue.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||C,3!==n.nodeType&&8!==n.nodeType&&!Dt.test(d+ce.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[ce.expando]?e:new ce.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:ce.makeArray(t,[e]),c=ce.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!y(n)){for(s=c.delegateType||d,Dt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||C)&&p.push(a.defaultView||a.parentWindow||ie)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(_.get(o,"events")||Object.create(null))[e.type]&&_.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&$(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!$(n)||u&&v(n[d])&&!y(n)&&((a=n[u])&&(n[u]=null),ce.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Nt),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Nt),ce.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=ce.extend(new ce.Event,n,{type:e,isSimulated:!0});ce.event.trigger(r,null,t)}}),ce.fn.extend({trigger:function(e,t){return this.each(function(){ce.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return ce.event.trigger(e,t,n,!0)}});var qt=/\[\]$/,Lt=/\r?\n/g,Ht=/^(?:submit|button|image|reset|file)$/i,Ot=/^(?:input|select|textarea|keygen)/i;function Pt(n,e,r,i){var t;if(Array.isArray(e))ce.each(e,function(e,t){r||qt.test(n)?i(n,t):Pt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==x(e))i(n,e);else for(t in e)Pt(n+"["+t+"]",e[t],r,i)}ce.param=function(e,t){var n,r=[],i=function(e,t){var n=v(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!ce.isPlainObject(e))ce.each(e,function(){i(this.name,this.value)});else for(n in e)Pt(n,e[n],t,i);return r.join("&")},ce.fn.extend({serialize:function(){return ce.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=ce.prop(this,"elements");return e?ce.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!ce(this).is(":disabled")&&Ot.test(this.nodeName)&&!Ht.test(e)&&(this.checked||!we.test(e))}).map(function(e,t){var n=ce(this).val();return null==n?null:Array.isArray(n)?ce.map(n,function(e){return{name:t.name,value:e.replace(Lt,"\r\n")}}):{name:t.name,value:n.replace(Lt,"\r\n")}}).get()}});var Mt=/%20/g,Rt=/#.*$/,It=/([?&])_=[^&]*/,Wt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Ft=/^(?:GET|HEAD)$/,$t=/^\/\//,Bt={},_t={},zt="*/".concat("*"),Xt=C.createElement("a");function Ut(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(D)||[];if(v(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function Vt(t,i,o,a){var s={},u=t===_t;function l(e){var r;return s[e]=!0,ce.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Gt(e,t){var n,r,i=ce.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&ce.extend(!0,e,r),e}Xt.href=Et.href,ce.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":zt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":ce.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Gt(Gt(e,ce.ajaxSettings),t):Gt(ce.ajaxSettings,e)},ajaxPrefilter:Ut(Bt),ajaxTransport:Ut(_t),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=ce.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?ce(y):ce.event,x=ce.Deferred(),b=ce.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Wt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace($t,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(D)||[""],null==v.crossDomain){r=C.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Xt.protocol+"//"+Xt.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=ce.param(v.data,v.traditional)),Vt(Bt,v,t,T),h)return T;for(i in(g=ce.event&&v.global)&&0==ce.active++&&ce.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Ft.test(v.type),f=v.url.replace(Rt,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Mt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(At.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(It,"$1"),o=(At.test(f)?"&":"?")+"_="+jt.guid+++o),v.url=f+o),v.ifModified&&(ce.lastModified[f]&&T.setRequestHeader("If-Modified-Since",ce.lastModified[f]),ce.etag[f]&&T.setRequestHeader("If-None-Match",ce.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+zt+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=Vt(_t,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=ie.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&ie.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),!i&&-1<ce.inArray("script",v.dataTypes)&&ce.inArray("json",v.dataTypes)<0&&(v.converters["text script"]=function(){}),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(ce.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(ce.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--ce.active||ce.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return ce.get(e,t,n,"json")},getScript:function(e,t){return ce.get(e,void 0,t,"script")}}),ce.each(["get","post"],function(e,i){ce[i]=function(e,t,n,r){return v(t)&&(r=r||n,n=t,t=void 0),ce.ajax(ce.extend({url:e,type:i,dataType:r,data:t,success:n},ce.isPlainObject(e)&&e))}}),ce.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),ce._evalUrl=function(e,t,n){return ce.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){ce.globalEval(e,t,n)}})},ce.fn.extend({wrapAll:function(e){var t;return this[0]&&(v(e)&&(e=e.call(this[0])),t=ce(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return v(n)?this.each(function(e){ce(this).wrapInner(n.call(this,e))}):this.each(function(){var e=ce(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=v(t);return this.each(function(e){ce(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){ce(this).replaceWith(this.childNodes)}),this}}),ce.expr.pseudos.hidden=function(e){return!ce.expr.pseudos.visible(e)},ce.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},ce.ajaxSettings.xhr=function(){try{return new ie.XMLHttpRequest}catch(e){}};var Yt={0:200,1223:204},Qt=ce.ajaxSettings.xhr();le.cors=!!Qt&&"withCredentials"in Qt,le.ajax=Qt=!!Qt,ce.ajaxTransport(function(i){var o,a;if(le.cors||Qt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Yt[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&ie.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),ce.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),ce.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return ce.globalEval(e),e}}}),ce.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),ce.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=ce("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),C.head.appendChild(r[0])},abort:function(){i&&i()}}});var Jt,Kt=[],Zt=/(=)\?(?=&|$)|\?\?/;ce.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Kt.pop()||ce.expando+"_"+jt.guid++;return this[e]=!0,e}}),ce.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Zt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Zt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=v(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Zt,"$1"+r):!1!==e.jsonp&&(e.url+=(At.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||ce.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=ie[r],ie[r]=function(){o=arguments},n.always(function(){void 0===i?ce(ie).removeProp(r):ie[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Kt.push(r)),o&&v(i)&&i(o[0]),o=i=void 0}),"script"}),le.createHTMLDocument=((Jt=C.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Jt.childNodes.length),ce.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(le.createHTMLDocument?((r=(t=C.implementation.createHTMLDocument("")).createElement("base")).href=C.location.href,t.head.appendChild(r)):t=C),o=!n&&[],(i=w.exec(e))?[t.createElement(i[1])]:(i=Ae([e],t,o),o&&o.length&&ce(o).remove(),ce.merge([],i.childNodes)));var r,i,o},ce.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=Tt(e.slice(s)),e=e.slice(0,s)),v(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&ce.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?ce("<div>").append(ce.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},ce.expr.pseudos.animated=function(t){return ce.grep(ce.timers,function(e){return t===e.elem}).length},ce.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=ce.css(e,"position"),c=ce(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=ce.css(e,"top"),u=ce.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),v(t)&&(t=t.call(e,n,ce.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},ce.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){ce.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===ce.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===ce.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=ce(e).offset()).top+=ce.css(e,"borderTopWidth",!0),i.left+=ce.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-ce.css(r,"marginTop",!0),left:t.left-i.left-ce.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===ce.css(e,"position"))e=e.offsetParent;return e||J})}}),ce.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;ce.fn[t]=function(e){return M(this,function(e,t,n){var r;if(y(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),ce.each(["top","left"],function(e,n){ce.cssHooks[n]=Ye(le.pixelPosition,function(e,t){if(t)return t=Ge(e,n),_e.test(t)?ce(e).position()[n]+"px":t})}),ce.each({Height:"height",Width:"width"},function(a,s){ce.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){ce.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return M(this,function(e,t,n){var r;return y(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?ce.css(e,t,i):ce.style(e,t,n,i)},s,n?e:void 0,n)}})}),ce.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){ce.fn[t]=function(e){return this.on(t,e)}}),ce.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.on("mouseenter",e).on("mouseleave",t||e)}}),ce.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){ce.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}});var en=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;ce.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),v(e))return r=ae.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(ae.call(arguments)))}).guid=e.guid=e.guid||ce.guid++,i},ce.holdReady=function(e){e?ce.readyWait++:ce.ready(!0)},ce.isArray=Array.isArray,ce.parseJSON=JSON.parse,ce.nodeName=fe,ce.isFunction=v,ce.isWindow=y,ce.camelCase=F,ce.type=x,ce.now=Date.now,ce.isNumeric=function(e){var t=ce.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},ce.trim=function(e){return null==e?"":(e+"").replace(en,"$1")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return ce});var tn=ie.jQuery,nn=ie.$;return ce.noConflict=function(e){return ie.$===ce&&(ie.$=nn),e&&ie.jQuery===ce&&(ie.jQuery=tn),ce},"undefined"==typeof e&&(ie.jQuery=ie.$=ce),ce});
/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);
/*!
 * imagesLoaded PACKAGED v4.1.4
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */
!function(e,t){"function"==typeof define&&define.amd?define("ev-emitter/ev-emitter",t):"object"==typeof module&&module.exports?module.exports=t():e.EvEmitter=t()}("undefined"!=typeof window?window:this,function(){function e(){}var t=e.prototype;return t.on=function(e,t){if(e&&t){var i=this._events=this._events||{},n=i[e]=i[e]||[];return n.indexOf(t)==-1&&n.push(t),this}},t.once=function(e,t){if(e&&t){this.on(e,t);var i=this._onceEvents=this._onceEvents||{},n=i[e]=i[e]||{};return n[t]=!0,this}},t.off=function(e,t){var i=this._events&&this._events[e];if(i&&i.length){var n=i.indexOf(t);return n!=-1&&i.splice(n,1),this}},t.emitEvent=function(e,t){var i=this._events&&this._events[e];if(i&&i.length){i=i.slice(0),t=t||[];for(var n=this._onceEvents&&this._onceEvents[e],o=0;o<i.length;o++){var r=i[o],s=n&&n[r];s&&(this.off(e,r),delete n[r]),r.apply(this,t)}return this}},t.allOff=function(){delete this._events,delete this._onceEvents},e}),function(e,t){"use strict";"function"==typeof define&&define.amd?define(["ev-emitter/ev-emitter"],function(i){return t(e,i)}):"object"==typeof module&&module.exports?module.exports=t(e,require("ev-emitter")):e.imagesLoaded=t(e,e.EvEmitter)}("undefined"!=typeof window?window:this,function(e,t){function i(e,t){for(var i in t)e[i]=t[i];return e}function n(e){if(Array.isArray(e))return e;var t="object"==typeof e&&"number"==typeof e.length;return t?d.call(e):[e]}function o(e,t,r){if(!(this instanceof o))return new o(e,t,r);var s=e;return"string"==typeof e&&(s=document.querySelectorAll(e)),s?(this.elements=n(s),this.options=i({},this.options),"function"==typeof t?r=t:i(this.options,t),r&&this.on("always",r),this.getImages(),h&&(this.jqDeferred=new h.Deferred),void setTimeout(this.check.bind(this))):void a.error("Bad element for imagesLoaded "+(s||e))}function r(e){this.img=e}function s(e,t){this.url=e,this.element=t,this.img=new Image}var h=e.jQuery,a=e.console,d=Array.prototype.slice;o.prototype=Object.create(t.prototype),o.prototype.options={},o.prototype.getImages=function(){this.images=[],this.elements.forEach(this.addElementImages,this)},o.prototype.addElementImages=function(e){"IMG"==e.nodeName&&this.addImage(e),this.options.background===!0&&this.addElementBackgroundImages(e);var t=e.nodeType;if(t&&u[t]){for(var i=e.querySelectorAll("img"),n=0;n<i.length;n++){var o=i[n];this.addImage(o)}if("string"==typeof this.options.background){var r=e.querySelectorAll(this.options.background);for(n=0;n<r.length;n++){var s=r[n];this.addElementBackgroundImages(s)}}}};var u={1:!0,9:!0,11:!0};return o.prototype.addElementBackgroundImages=function(e){var t=getComputedStyle(e);if(t)for(var i=/url\((['"])?(.*?)\1\)/gi,n=i.exec(t.backgroundImage);null!==n;){var o=n&&n[2];o&&this.addBackground(o,e),n=i.exec(t.backgroundImage)}},o.prototype.addImage=function(e){var t=new r(e);this.images.push(t)},o.prototype.addBackground=function(e,t){var i=new s(e,t);this.images.push(i)},o.prototype.check=function(){function e(e,i,n){setTimeout(function(){t.progress(e,i,n)})}var t=this;return this.progressedCount=0,this.hasAnyBroken=!1,this.images.length?void this.images.forEach(function(t){t.once("progress",e),t.check()}):void this.complete()},o.prototype.progress=function(e,t,i){this.progressedCount++,this.hasAnyBroken=this.hasAnyBroken||!e.isLoaded,this.emitEvent("progress",[this,e,t]),this.jqDeferred&&this.jqDeferred.notify&&this.jqDeferred.notify(this,e),this.progressedCount==this.images.length&&this.complete(),this.options.debug&&a&&a.log("progress: "+i,e,t)},o.prototype.complete=function(){var e=this.hasAnyBroken?"fail":"done";if(this.isComplete=!0,this.emitEvent(e,[this]),this.emitEvent("always",[this]),this.jqDeferred){var t=this.hasAnyBroken?"reject":"resolve";this.jqDeferred[t](this)}},r.prototype=Object.create(t.prototype),r.prototype.check=function(){var e=this.getIsImageComplete();return e?void this.confirm(0!==this.img.naturalWidth,"naturalWidth"):(this.proxyImage=new Image,this.proxyImage.addEventListener("load",this),this.proxyImage.addEventListener("error",this),this.img.addEventListener("load",this),this.img.addEventListener("error",this),void(this.proxyImage.src=this.img.src))},r.prototype.getIsImageComplete=function(){return this.img.complete&&this.img.naturalWidth},r.prototype.confirm=function(e,t){this.isLoaded=e,this.emitEvent("progress",[this,this.img,t])},r.prototype.handleEvent=function(e){var t="on"+e.type;this[t]&&this[t](e)},r.prototype.onload=function(){this.confirm(!0,"onload"),this.unbindEvents()},r.prototype.onerror=function(){this.confirm(!1,"onerror"),this.unbindEvents()},r.prototype.unbindEvents=function(){this.proxyImage.removeEventListener("load",this),this.proxyImage.removeEventListener("error",this),this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype=Object.create(r.prototype),s.prototype.check=function(){this.img.addEventListener("load",this),this.img.addEventListener("error",this),this.img.src=this.url;var e=this.getIsImageComplete();e&&(this.confirm(0!==this.img.naturalWidth,"naturalWidth"),this.unbindEvents())},s.prototype.unbindEvents=function(){this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype.confirm=function(e,t){this.isLoaded=e,this.emitEvent("progress",[this,this.element,t])},o.makeJQueryPlugin=function(t){t=t||e.jQuery,t&&(h=t,h.fn.imagesLoaded=function(e,t){var i=new o(this,e,t);return i.jqDeferred.promise(h(this))})},o.makeJQueryPlugin(),o});
/*! lz-string.min.js v1.5.0 | (c) 2023 Pieroxy | MIT license */
var LZString=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={};function t(r,o){if(!e[r]){e[r]={};for(var n=0;n<r.length;n++)e[r][r.charAt(n)]=n}return e[r][o]}var i={compressToBase64:function(r){if(null==r)return"";var n=i._compress(r,6,function(r){return o.charAt(r)});switch(n.length%4){default:case 0:return n;case 1:return n+"===";case 2:return n+"==";case 3:return n+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(n){return t(o,r.charAt(n))})},compressToUTF16:function(o){return null==o?"":i._compress(o,15,function(o){return r(o+32)})+" "},decompressFromUTF16:function(r){return null==r?"":""==r?null:i._decompress(r.length,16384,function(o){return r.charCodeAt(o)-32})},compressToUint8Array:function(r){for(var o=i.compress(r),n=new Uint8Array(2*o.length),e=0,t=o.length;e<t;e++){var s=o.charCodeAt(e);n[2*e]=s>>>8,n[2*e+1]=s%256}return n},decompressFromUint8Array:function(o){if(null==o)return i.decompress(o);for(var n=new Array(o.length/2),e=0,t=n.length;e<t;e++)n[e]=256*o[2*e]+o[2*e+1];var s=[];return n.forEach(function(o){s.push(r(o))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(r){return null==r?"":i._compress(r,6,function(r){return n.charAt(r)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),i._decompress(r.length,32,function(o){return t(n,r.charAt(o))}))},compress:function(o){return i._compress(o,16,function(o){return r(o)})},_compress:function(r,o,n){if(null==r)return"";var e,t,i,s={},u={},a="",p="",c="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<r.length;i+=1)if(a=r.charAt(i),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=f++,u[a]=!0),p=c+a,Object.prototype.hasOwnProperty.call(s,p))c=p;else{if(Object.prototype.hasOwnProperty.call(u,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==o-1?(v=0,d.push(n(m)),m=0):v++;for(t=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;e<h;e++)m=m<<1|t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}0==--l&&(l=Math.pow(2,h),h++),delete u[c]}else for(t=s[c],e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;0==--l&&(l=Math.pow(2,h),h++),s[p]=f++,c=String(a)}if(""!==c){if(Object.prototype.hasOwnProperty.call(u,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==o-1?(v=0,d.push(n(m)),m=0):v++;for(t=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;e<h;e++)m=m<<1|t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}0==--l&&(l=Math.pow(2,h),h++),delete u[c]}else for(t=s[c],e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;0==--l&&(l=Math.pow(2,h),h++)}for(t=2,e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;for(;;){if(m<<=1,v==o-1){d.push(n(m));break}v++}return d.join("")},decompress:function(r){return null==r?"":""==r?null:i._decompress(r.length,32768,function(o){return r.charCodeAt(o)})},_decompress:function(o,n,e){var t,i,s,u,a,p,c,l=[],f=4,h=4,d=3,m="",v=[],g={val:e(0),position:n,index:1};for(t=0;t<3;t+=1)l[t]=t;for(s=0,a=Math.pow(2,2),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;switch(s){case 0:for(s=0,a=Math.pow(2,8),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;c=r(s);break;case 1:for(s=0,a=Math.pow(2,16),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;c=r(s);break;case 2:return""}for(l[3]=c,i=c,v.push(c);;){if(g.index>o)return"";for(s=0,a=Math.pow(2,d),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;switch(c=s){case 0:for(s=0,a=Math.pow(2,8),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;l[h++]=r(s),c=h-1,f--;break;case 1:for(s=0,a=Math.pow(2,16),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;l[h++]=r(s),c=h-1,f--;break;case 2:return v.join("")}if(0==f&&(f=Math.pow(2,d),d++),l[c])m=l[c];else{if(c!==h)return null;m=i+i.charAt(0)}v.push(m),l[h++]=i+m.charAt(0),i=m,0==--f&&(f=Math.pow(2,d),d++)}}};return i}();"function"==typeof define&&define.amd?define(function(){return LZString}):"undefined"!=typeof module&&null!=module?module.exports=LZString:"undefined"!=typeof angular&&null!=angular&&angular.module("LZString",[]).factory("LZString",function(){return LZString});
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/dist/FileSaver.js */
(function(a,b){if("function"==typeof define&&define.amd)define([],b);else if("undefined"!=typeof exports)b();else{b(),a.FileSaver={exports:{}}.exports}})(this,function(){"use strict";function b(a,b){return"undefined"==typeof b?b={autoBom:!1}:"object"!=typeof b&&(console.warn("Deprecated: Expected third argument to be a object"),b={autoBom:!b}),b.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\uFEFF",a],{type:a.type}):a}function c(a,b,c){var d=new XMLHttpRequest;d.open("GET",a),d.responseType="blob",d.onload=function(){g(d.response,b,c)},d.onerror=function(){console.error("could not download file")},d.send()}function d(a){var b=new XMLHttpRequest;b.open("HEAD",a,!1);try{b.send()}catch(a){}return 200<=b.status&&299>=b.status}function e(a){try{a.dispatchEvent(new MouseEvent("click"))}catch(c){var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(b)}}var f="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0,a=/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),g=f.saveAs||("object"!=typeof window||window!==f?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(b,g,h){var i=f.URL||f.webkitURL,j=document.createElement("a");g=g||b.name||"download",j.download=g,j.rel="noopener","string"==typeof b?(j.href=b,j.origin===location.origin?e(j):d(j.href)?c(b,g,h):e(j,j.target="_blank")):(j.href=i.createObjectURL(b),setTimeout(function(){i.revokeObjectURL(j.href)},4E4),setTimeout(function(){e(j)},0))}:"msSaveOrOpenBlob"in navigator?function(f,g,h){if(g=g||f.name||"download","string"!=typeof f)navigator.msSaveOrOpenBlob(b(f,h),g);else if(d(f))c(f,g,h);else{var i=document.createElement("a");i.href=f,i.target="_blank",setTimeout(function(){e(i)})}}:function(b,d,e,g){if(g=g||open("","_blank"),g&&(g.document.title=g.document.body.innerText="downloading..."),"string"==typeof b)return c(b,d,e);var h="application/octet-stream"===b.type,i=/constructor/i.test(f.HTMLElement)||f.safari,j=/CriOS\/[\d]+/.test(navigator.userAgent);if((j||h&&i||a)&&"undefined"!=typeof FileReader){var k=new FileReader;k.onloadend=function(){var a=k.result;a=j?a:a.replace(/^data:[^;]*;/,"data:attachment/file;"),g?g.location.href=a:location=a,g=null},k.readAsDataURL(b)}else{var l=f.URL||f.webkitURL,m=l.createObjectURL(b);g?g.location=m:location.href=m,g=null,setTimeout(function(){l.revokeObjectURL(m)},4E4)}});f.saveAs=g.saveAs=g,"undefined"!=typeof module&&(module.exports=g)});
/*! seedrandom.js v3.0.5 | Copyright 2019 David Bau. | MIT license */
!function(f,a,c){var s,l=256,p="random",d=c.pow(l,6),g=c.pow(2,52),y=2*g,h=l-1;function n(n,t,r){function e(){for(var n=u.g(6),t=d,r=0;n<g;)n=(n+r)*l,t*=l,r=u.g(1);for(;y<=n;)n/=2,t/=2,r>>>=1;return(n+r)/t}var o=[],i=j(function n(t,r){var e,o=[],i=typeof t;if(r&&"object"==i)for(e in t)try{o.push(n(t[e],r-1))}catch(n){}return o.length?o:"string"==i?t:t+"\0"}((t=1==t?{entropy:!0}:t||{}).entropy?[n,S(a)]:null==n?function(){try{var n;return s&&(n=s.randomBytes)?n=n(l):(n=new Uint8Array(l),(f.crypto||f.msCrypto).getRandomValues(n)),S(n)}catch(n){var t=f.navigator,r=t&&t.plugins;return[+new Date,f,r,f.screen,S(a)]}}():n,3),o),u=new m(o);return e.int32=function(){return 0|u.g(4)},e.quick=function(){return u.g(4)/4294967296},e.double=e,j(S(u.S),a),(t.pass||r||function(n,t,r,e){return e&&(e.S&&v(e,u),n.state=function(){return v(u,{})}),r?(c[p]=n,t):n})(e,i,"global"in t?t.global:this==c,t.state)}function m(n){var t,r=n.length,u=this,e=0,o=u.i=u.j=0,i=u.S=[];for(r||(n=[r++]);e<l;)i[e]=e++;for(e=0;e<l;e++)i[e]=i[o=h&o+n[e%r]+(t=i[e])],i[o]=t;(u.g=function(n){for(var t,r=0,e=u.i,o=u.j,i=u.S;n--;)t=i[e=h&e+1],r=r*l+i[h&(i[e]=i[o=h&o+t])+(i[o]=t)];return u.i=e,u.j=o,r})(l)}function v(n,t){return t.i=n.i,t.j=n.j,t.S=n.S.slice(),t}function j(n,t){for(var r,e=n+"",o=0;o<e.length;)t[h&o]=h&(r^=19*t[h&o])+e.charCodeAt(o++);return S(t)}function S(n){return String.fromCharCode.apply(0,n)}if(j(c.random(),a),"object"==typeof module&&module.exports){module.exports=n;try{s=require("crypto")}catch(n){}}else"function"==typeof define&&define.amd?define(function(){return n}):c["seed"+p]=n}("undefined"!=typeof self?self:this,[],Math);
/*! console_hack.js | (c) 2015 Thomas Michael Edwards | Licensed under SugarCube's Simple BSD license */
!function(){for(var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"],length=methods.length,noop=function(){},console=window.console=window.console||{};length--;){var method=methods[length];console[method]||(console[method]=noop)}}();
}else{document.documentElement.setAttribute("data-init", "lacking");}
</script>
<style id="style-normalize" type="text/css">/*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}</style>
<style id="style-init-screen" type="text/css">@-webkit-keyframes init-loading-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes init-loading-spin{0%{-o-transform:rotate(0);transform:rotate(0)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes init-loading-spin{0%{-webkit-transform:rotate(0);-o-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}#init-screen{display:none;z-index:500000;position:fixed;top:0;left:0;height:100%;width:100%;font:28px/1 Helmet,Freesans,sans-serif;font-weight:700;color:#eee;background-color:#111;text-align:center}#init-screen>div{display:none;position:relative;margin:0 auto;max-width:1136px;top:25%}html[data-init=lacking] #init-screen,html[data-init=loading] #init-screen,html[data-init=no-js] #init-screen{display:block}html[data-init=lacking] #init-lacking,html[data-init=no-js] #init-no-js{display:block;padding:0 1em}html[data-init=no-js] #init-no-js{color:red}html[data-init=loading] #init-loading{-webkit-animation:init-loading-spin 2s linear infinite;-o-animation:init-loading-spin 2s linear infinite;animation:init-loading-spin 2s linear infinite;border:12px solid transparent;border-bottom-color:#7f7f7f;border-radius:50%;border-top-color:#7f7f7f;display:block;height:100px;width:100px}html[data-init=loading] #init-loading>div{text-indent:16128px;overflow:hidden;white-space:nowrap}html[data-init=loading] #story,html[data-init=loading] #ui-bar{display:none!important}</style>
<style id="style-font-icons" type="text/css">@font-face{font-family:sc-icons;font-display:block;src:url("data:application/octet-stream;base64,d09GRgABAAAAAFRoAAsAAAAAVBwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAABCAAAAGAAAABgD1IUnWNtYXAAAAFoAAACdAAAAnQzsxFSZ2FzcAAAA9wAAAAIAAAACAAAABBnbHlmAAAD5AAASzgAAEs4ynuL3WhlYWQAAE8cAAAANgAAADYc3WiNaGhlYQAAT1QAAAAkAAAAJAiCBP1obXR4AABPeAAAAfAAAAHwyjAFu2xvY2EAAFFoAAAA+gAAAPpXLER0bWF4cAAAUmQAAAAgAAAAIACEAIVuYW1lAABShAAAAcIAAAHCiTu08nBvc3QAAFRIAAAAIAAAACAAAwAAAAMDyQGQAAUAAAKZAswAAACPApkCzAAAAesAMwEJAAAAAAAAAAAAAAAAAAAAARAAAAAAAAAAAAAAAAAAAAAAQAAA+CoDgP+AAIADgACAAAAAAQAAAAAAAAAAAAAAIAAAAAAAAwAAAAMAAAAcAAEAAwAAABwAAwABAAAAHAAEAlgAAACSAIAABgASAAEAIPAC8AXwDvAR8BPwFfAZ8CPwKPAu8E7wWvBe8GPwaPBq8G7wcfB48InwjfCT8JzwoPDC8MfwyfDQ8Nrw5/Dr8P7xDvEQ8SfxOvE+8ULxRPFG8UrxUvGG8YjxkfGr8d3x4PH48gXyRPKL8o3y6vLt8vHy+fMe813zgvQQ9Vr1b/V09cD2qfeM99n4Kv/9//8AAAAAACDwAvAE8AzwEPAT8BXwGfAj8CbwLvBI8FDwXvBg8GXwavBu8HDwd/CJ8I3wk/Cc8KDwwfDH8Mnw0PDX8Ofw6/D+8Q3xEPEn8TfxPvFB8UTxRvFK8VDxhfGI8ZHxq/Hd8eDx+PIE8kDyi/KN8ury7fLx8vnzHvNd84H0EPVa9W31dPXA9qn3jPfZ+Cn//f//AAH/4xACEAEP+w/6D/kP+A/1D+wP6g/lD8wPyw/ID8cPxg/FD8IPwQ+8D6wPqQ+kD5wPmQ95D3UPdA9uD2gPXA9ZD0cPOQ84DyIPEw8QDw4PDQ8MDwkPBA7SDtEOyQ6wDn8OfQ5mDlsOIQ3bDdoNfg18DXkNcg1ODRAM7QxgCxcLBQsBCrYJzgjsCKAIUQADAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAH//wAPAAEAAAAAAAAAAAACAAA3OQEAAAAAAQAAAAAAAAAAAAIAADc5AQAAAAABAAAAAAAAAAAAAgAANzkBAAAAAAIAAP+OA/IDgAArAEcAACUWFA8BBiIvAS4BPQEOASMiJy4BJyY1NDc+ATc2MzIXHgEXFhUUBgczMhYXJTI3PgE3NjU0Jy4BJyYjIgcOAQcGFRQXHgEXFgPyDg45DigOxwcHNYNIVkxMcSAhISBxTExWVkxMcSAhLykhCRIH/nU1Ly5GFBQUFEYuLzU1Ly5GFBQUFEYuLwsOKA45Dg7HBxIJISkvISBxTExWVkxMcSAhISBxTExWSIM1BwcOFBRGLi81NS8uRhQUFBRGLi81NS8uRhQUAAAAAAEAEv/TA+4DNQAjAAABFhceAQcGBwEGIicBJicmNjc2NzY3NhYXFh8BNzY3PgEXFhcDnS8YGQUUFCr+fRM1Ev59KxMUBRkYLyoxMWUvMCYnJyYwL2UxMikDAyg2NnI3Nyz+cBMTAZAsNzdyNjYoIw8OCBYWJykpJxYWCA4PIwAAAQA8/4cERANcABgAAAE2MhcTBR4BDwETFgYnJQUGJjcTJyY2NyUCBxFQEYMBJCgYHNQyB0Ej/vv++yNBBzLUHBknASQDXCQk/vgrBksczv7dKC4SiooSLigBI84cSwYrAAAAAAEADwARA/EC7wAVAAAlASY0PwE2Mh8BATYyHwEWFAcBBiInAVz+sw8PSA8rD+AB4A8rD0gPD/2zDyoPEQFNDyoPSQ8P4AHgDw9JDyoP/bMPDwAAAAEAEgAyAq4CzgAjAAABFxYUDwEGIi8BBwYiLwEmND8BJyY0PwE2Mh8BNzYyHwEWFAcB5ckSEi0SNBPIyBM0Ei0SEsnJEhItEjQTyMgTNBItEhIBgMgTNBItEhLJyRISLRI0E8jIEzQSLRISyckSEi0SNBMAAwAA/44D8gOAACMAUABsAAABFRQGKwEVFAYrASImPQEjIiY9ATQ2OwE1NDY7ATIWHQEzMhYBBwYiLwEuAT0BDgEjIicuAScmNTQ3PgE3NjMyFx4BFxYVFAYHMzIWHwEWFAcBNCcuAScmIyIHDgEHBhUUFx4BFxYzMjc+ATc2AmAOCnAOCkAKDnAKDg4KcA4KQAoOcAoOAZI5DicOyAcHNYNIVkxMcSAhISBxTExWVkxMcSAhLykhCRIHxw4O/r4VFkkyMjg4MjFKFhUVFkkyMjg4MjFKFhUCAEAKDnAKDg4KcA4KQAoOcAoODgpwDv29OQ4OxwcSCSEpLyEgcUxMVlZMTHEgISEgcUxMVkiDNQcHxw4oDgIZODIxShYVFRZJMjI4ODIxShYVFRZJMjIAAAMAAP+OA/IDgAAPADwAWAAAARUUBiMhIiY9ATQ2MyEyFgEHBiIvAS4BPQEOASMiJy4BJyY1NDc+ATc2MzIXHgEXFhUUBgczMhYfARYUBwE0Jy4BJyYjIgcOAQcGFRQXHgEXFjMyNz4BNzYCYA4K/rAKDg4KAVAKDgGSOQ4nDsgHBzWDSFZMTHEgISEgcUxMVlZMTHEgIS8pIQkSB8cODv6+FRZJMjI4ODIxShYVFRZJMjI4ODIxShYVAgBACg4OCkAKDg79vTkODscHEgkhKS8hIHFMTFZWTExxICEhIHFMTFZIgzUHB8cOKA4CGTgyMUoWFRUWSTIyODgyMUoWFRUWSTIyAAAAAAIAEP+QA/ADgAA+AE4AAAEWFx4BFxYVFAcOAQcGIyInLgEnJjU0Nz4BNzY3NhYfARYGBw4BFRQXHgEXFjMyNz4BNzY1NCYnLgE/AT4BFwMUBisBIiY1ETQ2OwEyFhUDIC8nJjYPDycnhlpaZ2ZbWocoJw8ONyYmMBEqCx8JBw8+ShoaWz49RkU9PVwbGkdBDwcJHwsqEdAcFEAUHBwUQBQcAxQiLCxnOjs+Z1pahycnJyeGWltmPzo6aCwsIgwJEzgQIwsujVNFPT1cGhsaGlw9PkdOjjALIxA4EwkM/lwUHBwUAeAUHBwUAAAAAgAm/5wD2gNkAFMAXwAAAR4BBw4BBw4BLwEOAQcVFAYHBiInLgE9AS4BJwcGJicuAScmNj8BJjQ3Jy4BNz4BNz4BHwE+ATc1NDY3PgEXHgEdAR4BFzc2FhceARcWBg8BFhQHBTI2NTQmIyIGFRQWA88HBgIRNyUGEQdVGz4hCgk0bzcICyE+GlYHEQUlOBECBgdWBwdWBwYCETglBREHVRs+IQsING83CAshPhtVBxEFJTgRAgYHVQYG/oZCXl5CQl5eAQkFDwk1YCgGAwUxFyQLYwgNAgwMAg0IYwskFzEFAwYoYDUJDwQyIkcjMQQQCDZfKAcCBDEXIwxiCQ0CCwEMAg0JYgwjFzEEAgYpXzYIDwUxI0YjWl5CQl5eQkJeAAAAAAIAAP/ABIADQAAjAFcAAAE+ATMyFhcBERQGIyciJjU4ATE1NCYrASIGHQEUBiMHIiY1ESUeARUUBg8BDgEjIiYnAS4BIyIGBwEOASMiJi8BLgE1NDY3AT4BMzIWHwE1NDY7ATIWFRECMQMIBAQIAwFxEw3gDRMTDYANExMN4A0TA7cEBQMCMwQJBgQIA/4pAwgEBAgD/ikDCAQGCQQzAgMFBAH6DCARESAMsw4KcAoOAlcDAwMD/tH+uA0TARIOvw0TEw2/DhIBEw0BSGEDCgYECAM+BAUDAwGDAwMDA/59AwMFBD4DCAUFCgMBoQoMDAqTkQoODgr+6wAAAAQAAP+ABAADgAAWAC0AOQBFAAABMzIWFREzMhYHAQYiJwEmNjsBETQ2MwEVFAYjISImPQE0NjMhFxYyPwEhMhYVBzQmIyIGFRQWMzI2NzQmIyIGFRQWMzI2AbCgFByvGxQS/s8LIAv+zxMVGrAcFAJQHBT8YBQcHBQBJWIfVB9iASUUHPgXERAYFxEQGIAXERAYFxEQGAOAHBT+sDET/s8LCwExEzEBUBQc/RDgFBwcFOAUHGIeHmIcFLAQGBcREBgXERAYFxEQGBcAAAIAAP+AA4ADgAAgACkAAAEyFhURFAYjISImNRE0NjsBNTQ3PgE3NjMyFx4BFxYdASM1NCYjIgYdAQMgKDg4KP1AKDg4KDAYGFI4Nz8/NzhSGBigVDw8VAHAOCj+gCg4OCgBgCg4kD83OFIYGBgYUjg3P5CQPFRUPJAAAAABAAAADgIAAvIAEQAAATYWFREUBi8BIyImNRE0NjsBAa4WPDsXsswUHBwUzALyFhgg/WAgGBayHBQBIBQcAAAAAgAAAAwDAALwABEAKgAAATYWFREUBi8BIyImNRE0NjsBBR4BFRQGBwYmJyY2Nz4BNTQmJy4BNz4BFwGuFzs7F7LMFBwcFMwBqCsxMSsRJgoJCxEUFhYUEQsJCiYRAvAWGCD9YCAYFrIcFAEgFBwmGFIwMFIYCQsREiYJCyUWFiULCSYSEQsJAAQAAP+oBIADWAARADoAWwB0AAABNhYVERQGLwEjIiY1ETQ2OwEBFhceARcWFRQHDgEHBgcGJicmNjc2Nz4BNzY1NCcuAScmJy4BNz4BFxMUBw4BBwYHBiYnJjY3PgE1NCYnLgE3PgEXFhceARcWFSUeARUUBgcGJicmNjc+ATU0JicuATc+ARcBrhc7OxeyzBQcHBTMAoU8Ly9CEhEREkIvLzwSJwoLCBExKCc2Dw4ODzYnKDERCAsLJxE/DAstHyApEiYKCggRPENDPBEICgsnECkgHy0LDP7kKzExKxEmCgkLERQWFhQRCwkKJhEC8hYYIP1gIBgWshwUASAUHAEYJzQ0ekRER0dERHo0NCcLCRARJwsgKytlODk7Ozk4ZSsrIAsnEREIC/4oMC0tUCMiGQwLDxEnCyZ7RkZ7JgsnERAJCxkiI1AtLTCaGFIwMFIYCQsREiYJCyUWFiULCSYSEQsJAAAAAAEAAP+AAwADgAAKAAAXETQ2MyEyFhURJQA4KAJAKDj+gIADoCg4OCj8YOAAAQCA/8ADAANAABkAABcRNDY7ATIWFREBNhYVERQGJwERFAYrASImgA4KYAoOAYcfSkof/nkOCmAKDigDUAoODgr+nwFqGiIp/QApIhoBaP6hCg4OAAAAAAEAAAAABAADAAAkAAA3ETQ2OwEyFhURATYWFREBNhYVERQGJwERFAYnAREUBisBIiY1AA4KUAoOAVcfSgFXH0pKH/6pSh/+qQ4KUAoOGALQCg4OCv7QATkaIin++AE5GiIp/YApIhoBNv77KSIaATb+0woODgoAAAIAFwAPBAAC8QALABcAABMmNDcBNhYVERQGJxMmNDcBNhYVERQGJxcXFwGAH0pKH4AXFwGAH0pKHwFPEzwTAUAaIin9gCkiGgFAEzwTAUAaIin9gCkiGgABAAD/jQNRA3MACwAAARYUBwEGJjURNDYXA1EvL/1AMGFmKwHTHG4c/mAcNzgDQD8tGQAAAgAA/8IDgANCAA8AHwAABSMiJjURNDY7ATIWFREUBiUUBisBIiY1ETQ2OwEyFhUBIMAoODgowCg4OAI4OCjAKDg4KMAoOD44KALAKDg4KP1AKDhgKDg4KALAKDg4KAAAAQAA/8ADgANAAA8AAAEyFhURFAYjISImNRE0NjMDICg4OCj9QCg4OCgDQDgo/UAoODgoAsAoOAACAAAADwPpAvEACwAXAAABFhQHAQYmNRE0NhcDFhQHAQYmNRE0NhcD6RcX/oAfSkofgBcX/oAfSkofAbETPBP+wBoiKQKAKSIa/sATPBP+wBoiKQKAKSIaAAAAAAEAAAAABAADAAAjAAABERQGKwEiJjURAQYmNREBBiY1ETQ2FwERNDYXARE0NjsBMhYEAA4KUAoO/qkfSv6pH0pKHwFXSh8BVw4KUAoOAuj9MAoODgoBMP7HGiIpAQj+xxoiKQKAKSIa/skBBikiGv7JAS4KDg4AAAEAgP/AAwADQAAZAAABERQGKwEiJjURAQYmNRE0NhcBETQ2OwEyFgMADgpgCg7+eR9KSh8Bhw4KYAoOAyj8sAoODgoBYf6WGiIpAwApIhr+mAFfCg4OAAACAAD/wAOAAyEADwAcAAAlFRQGIyEiJj0BNDYzITIWJSImNwE2MhcBFgYjIQOAJRv9ABslJRsDABsl/OA+MyoBYB1UHQFgKjM+/UCAgBslJRuAGyUlZXMuAYAfH/6ALnMAAAAAAQBF/9kCOwMnABUAABMBNjIfARYUBwkBFhQPAQYiJwEmNDdFAYUOKA4tDg7+zAE0Dg4tDigO/nsODgGiAYUODi4OJw/+y/7LDycOLg4OAYUOKA4AAQBF/9kCOwMnABUAAAkBBiIvASY0NwkBJjQ/ATYyFwEWFAcCO/57DigOLQ4OATT+zA4OLQ4oDgGFDg4BXv57Dg4uDicPATUBNQ8nDi4ODv57DigOAAAAAAIAEP+QA/ADcAAbAD8AAAEyFx4BFxYVFAcOAQcGIyInLgEnJjU0Nz4BNzYBNTQmKwE1NCYrASIGHQEjIgYdARQWOwEVFBY7ATI2PQEzMjYCAGdaWocnJycnh1paZ2daWocnJycnh1paAYcOCrgOCnAKDrgKDg4KuA4KcAoOuAoOA3AnJ4daWmdnWlqHJycnJ4daWmdnWlqHJyf92HAKDrgKDg4KuA4KcAoOuAoODgq4DgAAAAIAEP+QA/ADcAAbACsAAAEyFx4BFxYVFAcOAQcGIyInLgEnJjU0Nz4BNzYDITI2PQE0JiMhIgYdARQWAgBnWlqHJycnJ4daWmdnWlqHJycnJ4daWqECEAoODgr98AoODgNwJyeHWlpnZ1pahycnJyeHWlpnZ1pahycn/cAOCnAKDg4KcAoOAAACABD/kAPwA3AAGwBAAAABMhceARcWFRQHDgEHBiMiJy4BJyY1NDc+ATc2ASc3NjQvASYiDwEnJiIPAQYUHwEHBhQfARYyPwEXFjI/ATY0JwIAZ1pahycnJyeHWlpnZ1pahycnJyeHWloBWoODBwdPBxQHgoIHFAdPBweDgwcHTwcUB4KCBxQHTwcHA3AnJ4daWmdnWlqHJycnJ4daWmdnWlqHJyf9joKCBxQHTwcHg4MHB08HFAeCggcUB08HB4ODBwdPBxQHAAIAEP+QA/ADcAAbADEAAAEUBw4BBwYjIicuAScmNTQ3PgE3NjMyFx4BFxYJATY0LwEmIgcBJyYiDwEGFB8BFjI3A/AnJ4daWmdnWlqHJycnJ4daWmdnWlqHJyf91wFwCQkuCRsJ/tSMCRsJLgkJ0AoaCgGAZ1pahycnJyeHWlpnZ1pahycnJyeHWlr+kgFwChoKLQkJ/tSMCQktChoK0AkJAAAAAwAQ/5AD8ANwABsASQBVAAABFAcOAQcGIyInLgEnJjU0Nz4BNzYzMhceARcWJSIGBwYWHwEWNjc+ATMyFhUUBgcOAR0BFBY7ATI2PQE0Nz4BNzY1NCcuAScmIwMiBhUUFjMyNjU0JgPwJyeHWlpnZ1pahycnJyeHWlpnZ1pahycn/h1RbykFAwhFCBMGGy8pHzwiHyNKDgpwCg4aGj4aGhQVQiopKw0mNjYmJjY2AYBnWlqHJycnJ4daWmdnWlqHJycnJ4daWuVCPgcTBjUGAwgiJSQeFh0REzw+CAoODgoDFQ4PKCEgOiwlJTcPEP4QNiYmNjYmJjYAAAAAAwAQ/5AD8ANwABsAJwBGAAABMhceARcWFRQHDgEHBiMiJy4BJyY1NDc+ATc2FyIGFRQWMzI2NTQmEzU0JisBNTQmKwEiBh0BFBY7ARUjIgYdARQWOwEyNgIAZ1pahycnJyeHWlpnZ1pahycnJyeHWlpnIzExIyMxMU0OChgOCoAKDg4KGBgKDg4KsAoOA3AnJ4daWmdnWlqHJycnJ4daWmdnWlqHJyfcMSMjMTEjIzH+BDAKDsgKDg4KMAoOgA4KMAoODgAAAAADABD/kAPwA3AAGwArADsAAAEyFx4BFxYVFAcOAQcGIyInLgEnJjU0Nz4BNzYFJicuAQcGBwE2NzYmJyYnARYXHgE3NjcBBgcGFhcWFwIAZ1pahycnJyeHWlpnZ1pahycnJyeHWloBazE8PH4+PTUCASUQEQoaGzH9+DE8PH4+PTX9/yUQEQoaGzEDcCcnh1paZ2daWocnJycnh1paZ2daWocnJ+wxGxoKERAl/f81PT5+PDwx/fgxGxoKERAlAgE1PT5+PDwxAAEADv/ZA4ADJwAeAAAlBwYiJwEmNDcBNjIfARYUDwEhMhYdARQGIyEXFhQHAgMsDigO/nsODgGFDigOLA4P8QI/FBwcFP3B8Q8OBi0ODgGFDigOAYUODi0OKA7mHBRAFBzmDigOAAAAAQAA/9kDcgMnAB4AAAE3NjIXARYUBwEGIi8BJjQ/ASEiJj0BNDYzIScmNDcBfSwOKA4BhQ4O/nsOKA4sDg/x/cEUHBwUAj/xDw4C+i0ODv57DigO/nsODi0OKA7mHBRAFBzmDigOAAABABn/wANmAzIAHgAAEycmNDcBNjIXARYUDwEGIi8BERQGKwEiJjURBwYiJ0YtDg4BhQ4oDgGEDw8sDikO5RwUQBQc5g4oDgE9LA4oDgGFDg7+ew4nDi0OD/H9wRQcHBQCP/EPDgAAAAEAGf/OA2cDQAAeAAABFxYUBwEGIicBJjQ/ATYyHwERNDY7ATIWFRE3NjIXAzotDg7+ew4oDv57Dg4tDigO5hwUQBQc5g4oDgHDLA4oDv57Dg4BhQ4oDiwOD/ECPxQcHBT9wfEPDgAABAAA/8ADgANAABQAKQA+AFMAABM1NDY7ATIWHQEUBisBFRQGKwEiJgE0NjsBMhYdARQGKwEiJj0BIyImNQEyFh0BFAYrASImPQE0NjsBNTQ2MwEUBisBIiY9ATQ2OwEyFh0BMzIWFQAcFPgKDg4KqA4KUAoOAkAOCvgUHA4KUAoOqAoOASgKDhwU+AoODgqoDgr+KA4K+BQcDgpQCg6oCg4CGPgUHA4KUAoOqAoODgEaCg4cFPgKDg4KqA4K/igOCvgUHA4KUAoOqAoO/tgKDhwU+AoODgqoDgoAAAQAAP/AA4ADQAAUACkAPgBTAAABIyImPQE0NjsBMhYdATMyFh0BFAYlFAYrASImPQE0NjsBNTQ2OwEyFhURFAYrASImPQEjIiY9ATQ2OwEyFhUFFAYrASImPQE0NjsBMhYdARQGKwEDaPgUHA4KUAoOqAoODv3OHBT4Cg4OCqgOClAKDg4KUAoOqAoODgr4FBwBgA4KUAoOHBT4Cg4OCqgCABwU+AoODgqoDgpQCg4wFBwOClAKDqgKDg4K/LAKDg4KqA4KUAoOHBT4Cg4OCvgUHA4KUAoOAAEAAP/AA4ADQAAjAAABMhYdARQGIyERFAYrASImNREhIiY9ATQ2MyERNDY7ATIWFREDQBslJRv+4CUbQBsl/uAbJSUbASAlG0AbJQHgJRtAGyX+4BslJRsBICUbQBslASAbJSUb/uAAAQAAASADgAHgAA8AAAEyFh0BFAYjISImPQE0NjMDQBslJRv9ABslJRsB4CUbQBslJRtAGyUAAAADABD/kAPwA3AAGwAnADcAAAEUBw4BBwYjIicuAScmNTQ3PgE3NjMyFx4BFxYFIgYVFBYzMjY1NCYDEx4BOwEyNjcTNiYrASIGA/AnJ4daWmdnWlqHJycnJ4daWmdnWlqHJyf+ECY2NiYmNjZ9DgEOCWIJDgEOAQ4LfgsOAYBnWlqHJycnJ4daWmdnWlqHJycnJ4daWss2JiY2NiYmNgFL/vAKDQ0KARAKDw8AAwAAAAAEgAMAACgASQBlAAABHgEVFAYHBgcOAQcGIyInLgEnJicuATU0Njc2Nz4BNzYzMhceARcWFwE4ATEyNz4BNzY1MTQnLgEnJiMiBw4BBwYVFBceARcWMxE4ATEyFhUUBiMiJjU0NjceATMyNjU0Jic+ATMEeQMEBAMpOzuTVlVcXFVWkzs7KQMEBAMpOzuTVlVcXFVWkzs7Kf3HPDQ1ThYXFxZONTQ8PDQ1ThYXFxZONTQ8UHBwUE9wAwQLHRAoOAoJDBoNAZ0GDwgIDwZQQUFeGRoaGV5BQVAGDwgIDwZQQUFeGRoaGV5BQVD+wxcWTjU0PDw0NU4WFxcWTjU0PDw0NU4WFwHgcFBPcHBPDRoMCQo4KBAdCwQEAAAAAwAA/4AFAAOAAB8ATwB0AAAlMjY3Fw4BIyInLgEnJicuATU0Njc+ATcXFhceARcWMwUeARUUBg8BDgEjIiYnAS4BNTQ2PwE+ATMyFh8BPgEzMhceARcWFx4BFRQGBw4BByc+ATU4ATE0Jy4BJyYjMSIGBxc+ATU0Jic+ATMyFhUcARUUBgcCgA0aDWgmTihcVVaTOzspAwQEAw8mFNIEGBhNMjI5AnQFBwQDJwQOBwYKBPtnBQcEAycEDgcGCgT+QpVQXFVWkzs7KQMEBAMeUjKTDQ8XFk41NDw0XSWTAQIKCQ0bDU9vBgRgAwJQCgsaGV5BQVAGDwgIDwYeNxqiODAxSBQVdAUNBwYKBDMFBwQDA40FDQcGCgQzBQcEA8QjKBoZXkFBUAYPCAgPBjtnKnEbPSA8NDVOFhcjH3IFCgUQHQsEBG9OAQEBEB0OAAAAAwAN/4AEcwNQAAsAFwAnAAAlFgYjISImNwE2MhcDIgYVFBYzMjY1NCYDEx4BOwEyNjcTNiYrASIGBHMcODf8QDc4HAHgHG8bUyY2NiYmNjZ9DgEOCWIJDgEOAQ4LfgsOEDBgYDADQDAw/Ww2JiY2NiYmNgFL/vAKDQ0KARAKDw8AAAAAAQAZAIUDZwJ7ABUAAAkBFhQPAQYiJwkBBiIvASY0NwE2MhcB4gGFDg4uDicP/sv+yw8nDi4ODgGFDigOAnv+ew4oDi0ODgE0/swODi0OKA4BhQ4OAAAAAAEAGQCFA2cCewAVAAAlASY0PwE2MhcJATYyHwEWFAcBBiInAZ7+ew4OLg4nDwE1ATUPJw4uDg7+ew4oDoUBhQ4oDi0ODv7MATQODi0OKA7+ew4OAAEAPP+IAkADgAAPAAABEQUGJjcTJyY2NyUTPgEzAkD++yNBBzLUHBknASSDCCARA4D8kYkTLycBI84cSwYrAQgSEgAAAQAA/4kDAAOAAC0AAAEeARUUBiMhFRQGDwEGIi8BLgE9ASEiJjU0Nj8BIyImPQE0NjMhMhYdARQGKwECVEhkHBT+8AEBMAQUBDABAf7wFBxjSRhUFBwcFAIgFBwcFFQB0yF1TRQc0AIEAWAJCWABBALQHBRMdiHtHBRgFBwcFGAUHAAABAAA/4AEAAN1ABYAMAA8AEgAACUjIiY1ESMiJjcBNjIXARYGKwERFAYjJRUUBiMhIiY9ATQ2MyEVFBY7ATI2PQEhMhYHNCYjIgYVFBYzMjY3NCYjIgYVFBYzMjYCUKAUHK8bFBIBMQsgCwExExUbrxwUAbAcFPxgFBwcFAEQQi6gLkIBEBQc+BcREBgXERAYgBcREBgXERAYgBwUAVAxEwExCwv+zxMx/rAUHBDgFBwcFOAUHBAuQkIuEBzEEBgXERAYFxEQGBcREBgXAAAAAAEAAP+AA4ADgAAwAAABMhYVERQGIyEiJjURNDY7ATU0Nz4BNzYzMhceARcWHQEUBisBIiY9ATQmBw4BHQEhAyAoODgo/UAoODgoMBgXUzc3Pz84N1MYGBwUQBQcVTw8UwHwAYA4KP7AKDg4KAFAKDjNPzg4UxgZGBdTODc/IBQcHBQgPFUBAVU8zgAABAAAAAAEgAMAAA8AJAAwADwAAAEVFAYjISImPQE0NjMhMhYnITgBMSIGBxM+ATMhMhYXEy4BIzEHIgYVFBYzMjY1NCYjIgYVFBYzMjY1NCYEgDgo/EAoODgoA8AoOGD8QBEeD8IMKhkCGhkqDMIPHxBgGyUlGxslJdsbJSUbGyUlASDAKDg4KMAoODh4BgYBIRQXFxT+3wYGwCUbGyUlGxslJRsbJSUbGyUAAAIAFv+WA+oDagA+AH0AAAEWFxYUBwYHMAYxBwYHBiInJicmJyY0NzY/ATYWFx4BFxYGDwEOARcWMj8BNjQnLgEnLgE1JjY/AT4BFx4BFwEWFxYUBwYPAQYmJy4BJyY2PwE+AScmIg8BBhQXHgEXHgEVFgYPAQ4BJy4BJyYnJjQ3NjcwNjE3Njc2MhcWFwKNLRYWFhYsAYYtODh1ODgsLRYWFhYtSg8nAQEJCQMEBhsqAioqeCuGKioFCwUGBwELDSoIGAkLFQkBGi0WFhYWLUoPJwEBCQkDBAYbKgIqKngrhioqBQsFBgcBCw0qCBgJCxUJLRYWFhYsAYYtODh1ODgsAg0tODh0ODgsAYYtFhYWFi0sODh1ODgtSg8PFRs1GggSBxoqdysrKoYrdyoGCAMEDgcQIAwqCAIGCBEKARosODh1ODgtSg8PFRs1GggSBxoqdysrKoYrdyoGCAMEDgcQIAwqCAIGCBEKLTg4dDg4LAGGLRYWFhYtAAAAAQAA/8AFAANAADcAAAEWFx4BFxYVFAcOAQcGIyEiJy4BJyY1NDc+ATc2NzwBNTQ3PgE3NjMyFx4BFxYXPgEzMhYVFAYHBDMsJSY3DxAUFEYuLzX9IDw0NU4WFw4PMyMjKhkZVzo7QiwqKUcdHhQXNh5PcQcGAbsJFxdCKiouNS8uRhQUFxZONTQ8LysrRxobDwQIBEI7OlcZGQwLKh4dJA8RcU8SIxAAAwAA/8ADgANAABMAHwA0AAABHgEVERQGIyEiJjURNDYzITIWFwMyNjU0JiMiBhUUFhM0Ji8BLgEjISIGHQEUFjMhMjY9AQNkDQ84KP1AKDg4KAIYFCMN/DVLSzU1S0v1BAMHAwkF/jcKDg4KAdAKDgJ8DSMU/egoODgoAsAoOA8N/RxLNTVLSzU1SwJhBQkDBwMEDgrQCg4OCskAAwAA//gDgAMIAA8AHwAvAAATIiY9ATQ2MyEyFh0BFAYjASImPQE0NjMhMhYdARQGIwEiJj0BNDYzITIWHQEUBiMgDRMTDQNADRMTDfzADRMTDQNADRMTDfzADRMTDQNADRMTDQJ4Ew1QDRMTDVANE/7AEw1QDRMTDVANE/7AEw1QDRMTDVANEwAAAAAFAAD/gAQAA4AABwAPABcALQAxAAABLwE/AR8BBwUvAT8BHwEHAR8BDwEvATcTFhQHAQ4BIyImLwEmNDcBPgEzMhYXAzcnBwHAIEBAICBAQP7ANWtrNTVrawKLNWtrNTVra8ITE/0qCRgMDRcKqRMTAtYJGAwNFwp1rWatAsBAICBAQCAgwGs1NWtrNTX+lWs1NWtrNTUB7xM1E/0qCgkJCqkTNRMC1goJCQr+fK1mrQAAAAABACIAugJdAgAADAAAEyEyFgcBBiInASY2Mz8CAhsUE/7/DCEL/v4TFRsCADET/v4LCwECEzEAAAEAIgDAAl4CBgALAAAlISImNwE2MhcBFgYCQf3+GxUTAQILIgsBAhMVwDETAQILC/7+EzEAAAAAAQA6AGIBgAKeAAwAAAERFAYnASY0NwE2FhUBgDET/v4LCwECEzECgf3+GxUTAQILIgsBAhMVGwABAAAAYgFGAp4ADAAANxE0NhcBFhQHAQYmNQAxEwECCwv+/hMxfwICGxUT/v4LIgv+/hMVGwAAAAEAAP+AAnkDgAAZAAABMhYHAQ4BIyImNxMjIiY3Ez4BMyEyFgcDMwJQHBsO/qAGFwwXHQVc7RYcAkADGxIBIBgcBlXnAkAwGP2gCw0kFwGFIRUB4BIYJhb+/AAAAwAA/4ACwAOAABIANABKAAAXNSEVFAYPAQ4BKwEiJi8BLgE1AzQ3PgE3NjMyFx4BFxYVFAYHDgEHHAExITA0NS4BJy4BNSUyNjU0JiMiBw4BBwYVFBYzMjY1NDbAAUAGBSIJHBB8EBwJIgUGwBoaXkBATUlAQV8cHC4pGUEP/sAPQRkpLgFgDRMTDS4pKT0REhMNDRNeDU1NCRIIMw0QEA0zCBIJAi1GP0BhHR0bHGBAQElDdi8caTEBAQEBMWkcL3ZDoBMNDRMSET0pKS4NExMNQl4AAAAAAgAA/8ADgANAAA8AMwAAATIWFREUBiMhIiY1ETQ2MwE1NCYrATU0JisBIgYdASMiBh0BFBY7ARUUFjsBMjY9ATMyNgMgKDg4KP1AKDg4KAKADgq4DgpwCg64Cg4OCrgOCnAKDrgKDgNAOCj9QCg4OCgCwCg4/ghwCg64Cg4OCrgOCnAKDrgKDg4KuA4AAAAAAgAA/8AEAANAACAAQQAAATIWFREUBiMhIiY1ETQ3PgE3NjsBMhYdARQGKwEiBh0BITIWFREUBiMhIiY1ETQ3PgE3NjsBMhYdARQGKwEiBh0BA6AoODgo/wAoOBkZVzo7QhAUHBwUEDVL/mAoODgo/wAoOBkZVzo7QhAUHBwUEDVLAYA4KP8AKDg4KAHgQjs6VxkZHBRgFBxLNYA4KP8AKDg4KAHgQjs6VxkZHBRgFBxLNYAAAgAA/8AEAANAACAAQQAAATIWFREUBw4BBwYrASImPQE0NjsBMjY9ASMiJjURNDYzITIWFREUBw4BBwYrASImPQE0NjsBMjY9ASMiJjURNDYzA6AoOBkZVzo7QhAUHBwUEDVLoCg4OCj+wCg4GRlXOjtCEBQcHBQQNUugKDg4KANAOCj+IEI7OlcZGRwUYBQcSzWAOCgBACg4OCj+IEI7OlcZGRwUYBQcSzWAOCgBACg4AAAABwAA/4AEAAOAAAsAFwAjAC8AOwBHAFMAAAEUBiMiJjU0NjMyFgMyFhUUBiMiJjU0NgEyFhUUBiMiJjU0NgUUBiMiJjU0NjMyFhcyFhUUBiMiJjU0NiEyFhUUBiMiJjU0NgEyFhUUBiMiJjU0NgJgOCgoODgoKDhgKDg4KCg4OAHIKDg4KCg4OP1IOCgoODgoKDgaKDg4KCg4OAJ0KDg4KCg4OP3cKDg4KCg4OAMgKDg4KCg4OPz4OCgoODgoKDgBoDgoKDg4KCg4YCg4OCgoODjuOCgoODgoKDg4KCg4OCgoOAJMOCgoODgoKDgAAAAAAwAO/44D8gNyACUATABcAAAlFhQPAQYHBiInJicmJyY0NzY/ATYyHwEWFA8BBhQXFjI/ATYyFwMnJjQ/ATY3NjIXFhcWFxYUBwYPAQYiLwEmND8BNjQnJiIPAQYiJwEGIicBJjQ/ATYyFwEWFAcCYAcHWS04OHU4OCwtFhYWFi1ZBxQHTwcHWSoqKngqWQcUByJPBwdZLTg4dTg4LC0WFhYWLVkHFAdPBwdZKioqeCpZBxQHAdYOKA78jQ4OLQ4oDgNzDg5UBxQHWS0WFhYWLSw4OHU4OC1ZBwdPBxQHWSp4KioqWQcHAbpPBxQHWS0WFhYWLSw4OHU4OC1ZBwdPBxQHWSp4KioqWQcH/TEODgNzDigOLQ4O/I0OKA4AAAAAAgAQ/5AD8ANwABsAMQAABSInLgEnJjU0Nz4BNzYzMhceARcWFRQHDgEHBgkBFjI/ATY0LwE3NjQvASYiBwEGFBcCAGdaWocnJycnh1paZ2daWocnJycnh1pa/rUBDw4oDiIODsvLDg4iDigO/vEODnAnJ4daWmdnWlqHJycnJ4daWmdnWlqHJycBzv7xDg4iDigOy8sOKA4iDg7+8Q4oDgAAAAACABD/kAPwA3AAGwAxAAABMhceARcWFRQHDgEHBiMiJy4BJyY1NDc+ATc2CQEmIg8BBhQfAQcGFB8BFjI3ATY0JwIAZ1pahycnJyeHWlpnZ1pahycnJyeHWloBS/7xDigOIg4Oy8sODiIOKA4BDw4OA3AnJ4daWmdnWlqHJycnJ4daWmdnWlqHJyf+MgEPDg4iDigOy8sOKA4iDg4BDw4oDgAAAAIAEP+QA/ADcAAbADEAABM0Nz4BNzYzMhceARcWFRQHDgEHBiMiJy4BJyYJAQYUHwEWMj8BFxYyPwE2NCcBJiIHECcnh1paZ2daWocnJycnh1paZ2daWocnJwHO/vEODiIOKA7Lyw4oDiIODv7xDigOAYBnWlqHJycnJ4daWmdnWlqHJycnJ4daWgFL/vEOKA4iDg7Lyw4OIg4oDgEPDg4AAAAAAgAQ/5AD8ANwABsAMQAAARQHDgEHBiMiJy4BJyY1NDc+ATc2MzIXHgEXFgkBNjQvASYiDwEnJiIPAQYUFwEWMjcD8Ccnh1paZ2daWocnJycnh1paZ2daWocnJ/4yAQ8ODiIOKA7Lyw4oDiIODgEPDigOAYBnWlqHJycnJ4daWmdnWlqHJycnJ4daWv61AQ8OKA4iDg7Lyw4OIg4oDv7xDg4AAAACAAD/gAOAA4AAMAA+AAABMhYVERQGIyEiJjURNDY7ATU0Nz4BNzYzMhceARcWHQEUBisBIiY9ATQmBw4BHQEhATU0JiMiBh0BFBYzMjYDICg4OCj9QCg4OCgwGBdTNzc/Pzg3UxgYHBRAFBxVPDxTAfD+8C8hIS8vISEvAYA4KP7AKDg4KAFAKDjNPzg4UxgZGBdTODc/IBQcHBQgPFUBAVU8zv7QYCEvLyFgIS8vAAMAEADwA/ACEAALABcAIwAAARQGIyImNTQ2MzIWNzIWFRQGIyImNTQ2ITIWFRQGIyImNTQ2ApBUPDxUVDw8VNA8VFQ8PFRU/Xw8VFQ8PFRUAYA8VFQ8PFRUVFQ8PFRUPDxUVDw8VFQ8PFQAAAMAMP+QAVADcAALABcAIwAAEzIWFRQGIyImNTQ2JzQ2MzIWFRQGIyImETQ2MzIWFRQGIyImwDxUVDw8VFRUVDw8VFQ8PFRUPDxUVDw8VAIQVDw8VFQ8PFTQPFRUPDxUVP18PFRUPDxUVAAAAAIAEP+QA/ADcAAbACcAAAEyFx4BFxYVFAcOAQcGIyInLgEnJjU0Nz4BNzYBNjQnJSYGFREUFjcCAGdaWocnJycnh1paZ2daWocnJycnh1paAU4ZGf6gFzAwFwNwJyeHWlpnZ1pahycnJyeHWlpnZ1pahycn/eAOOA7WDRsc/mAcGw0AAAIAAP/AA4ADQAAPAB8AAAEyFhURFAYjISImNRE0NjMTITI2PQE0JiMhIgYdARQWAyAoODgo/UAoODgoWAIQCg4OCv3wCg4OA0A4KP1AKDg4KALAKDj98A4KcAoODgpwCg4AAAACAAD/wAOAA0AADwAlAAAFISImNRE0NjMhMhYVERQGJQE2NC8BJiIHAScmIg8BBhQfARYyNwMg/UAoODgoAsAoODj+PwFwCQkuCRsJ/tSMCRsJLgkJ0AoaCkA4KALAKDg4KP1AKDjEAXAJGwkuCQn+1IwJCS4JGwnQCQkAAgAA/8ADgANAAA8AGwAAAREUBiMhIiY1ETQ2MyEyFgEXFjI/ATYmIyEiBgOAOCj9QCg4OCgCwCg4/Tn2BxQH9gsMEP4UEAwC4P1AKDg4KALAKDg4/r/2Bwf2Cx4eAAAAAgAA/8ADgANAAA8AHAAANxE0NjMhMhYVERQGIyEiJgEnJiIPAQYWMyEyNicAOCgCwCg4OCj9QCg4Asf2BxQH9gsMEAHsEAwLIALAKDg4KP1AKDg4AUH2Bwf2Cx4eCwAAAgAA/8ADgANAAA8AHAAAEyEyFhURFAYjISImNRE0NgE3NjQvASYGFREUFjdgAsAoODgo/UAoODgBQfYHB/YLHh4LA0A4KP1AKDg4KALAKDj9OfYHFAf2CwwQ/hQQDAsAAwAT/5MD7QNtAAsAMwBPAAABMhYVFAYjIiY1NDYFFhQPARcWBi8BBwYiLwEHBiY/AScmND8BJyY2HwE3NjIfATc2Fg8BAzY3NjQnJicmJyYiBwYHBgcGFBcWFxYXFjI3NgIAT3FxT09xcQI8ExS9QwceFcleCisJX8kUHgdDvhMTvkMHHhTJXwoqCl/JFB4HQ3olExMTEyUlMC9iLzAlJRMTExMlJTAvYi8wAkBxT09xcU9PcaEKKgpfyRQeB0O+ExO+QwceFMlfCioKX8kUHgdDvhMTvkMHHhXI/s0lMC9iLzAlJRMTExMlJTAvYi8wJSUTExMTAAABADb/gAPEA4AALAAABSInLgEnJjU0Nz4BNzYzMhYXHgEHBgcOAQcGFRQXHgEXFjc2FgcGBw4BBwYjAjZqXV2LKCkpKItdXWoYLxcQBg8vJSY0Dg8oKIRWVl0QEgskLC1lODg8gCgpi11dampdXosoKAQFAyEIGyUmWjM0Nl5QUG0YGBEDHA0tIyMxDQ0AAAACAAD/kwQAA4AASgBZAAABDgErARUUBgcXFhQHBiIvAQ4BIxE0JisBIgYVESImJwcGIicmND8BLgE9ASMiJicmNjsBNScmNDc2Mh8BITc2MhcWFA8BFTMyFgcBMhceARcWFSE0Nz4BNzYEAAEmGm8ODXgTExI2Em4lXDQOCjAKDjRcJW4SNhITE3gNDm8aJgEBJhtwXRMTEjYSbgHKbhI2EhMTXXAbJgH+Ai4pKT0REv5AEhE9KSkBPhokICE9HHkSNhITE20eIgHoCg4OCv4YIh5tExMSNhJ5HD0hICQaGyd1XhI2EhMTbW0TExI2El51JxsCQhIRPSkpLi4pKT0REgAAAAIAAP/AA4ADQAAPABwAAAUhIiY1ETQ2MyEyFhURFAYBBwYUHwEWNjURNCYHAyD9QCg4OCgCwCg4OP6/9gcH9gseHgtAOCgCwCg4OCj9QCg4Asf2BxQH9gsMEAHsEAwLAAUAAABABQACwAAKABQAXgBoAIIAAAEXIzc+ATEzMBYXATIWFREUBiMhEQU1NCYrATU0JisBIgYdASMiBh0BFBY7AQ4BBy4BJy4BDwIOARceARcOAQcOAR8BHgE3PgE3HgEXFjY/ATYmJy4BJz4BNzMyNjUlNDYzIREhIiY1NwYWOwEyNj8BMxceATsBMjYnAy4BKwEiBgcBMBZMFgULAQoFA6AUHBwU/dACAA4KgA4KIAoOgAoODgrlCh4UChIHBhIIDw0JBAYJFQwMGg4JBQUQBRQIEyQQESMTCRMFEAUFCA0bDB8sChcKDvtgHBQCMP3QFBx2BA4NLQgNAhN4EwINCC4MDgRzAg0HQQgNAgGoS0sSMDASARgcFP3gFBwCgPAgCg4gCg4OCiAOCiAKDhUsFQoVCggEBQgIBRUIDRoNCRIJBRMIHAkFBQwZDQ0ZDAUFCRwIEwUIEwkiRyMOCsAUHP2AHBRwDBQKB0BABwoUDAFSBwkJBwABAED/wAOAA0AAKgAAARUUBisBERQGKwEiJjURIxEUBisBIiY9ASMiJy4BJyY1NDc+ATc2MyEyFgOAEw1gEw1ADRNAEw1ADRNAQjs6VxkZGRlXOjtCAeANEwMgQA0T/SANExMNAuD9IA0TEw3gGRlXOjtCQjs6VxkZEwAAAQAA/4ADgAOAADYAAAEyFhUUBiMiJjU4ATE0NjcnDgEjIiY1NDYzMhYXNy4BNTQ2MzIWFRQGIyImJwceARUUBgcXPgECwFBwcFBQcAIDzRk9IlBwcFAiPRnNAwJwUFBwcFAiPRnNAwICA80ZPQEAcFBQcHBQCxUKgBQWcFBQcBYUgAoVC1BwcFBQcBYUgAoVCwsVCoAUFgACAAD/gAOAA4AAHQAoAAABMhYdARQGIyEiJj0BNDY7ATc+ATsBOAExMhYfATMBAyEDDgEjISImJwNgDRMTDfzADRMTDfATBhYO5Q4XBhPw/QoqAwAqAzcm/hQmNwMDQBMNQA0TEw1ADRMlDA8PDCX8mgKm/VomNDQmAAAAAwAAAAAEgAMAAB0AOQBQAAABMhceARcWFRQHDgEHBiMhIicuAScmNTQ3PgE3NjMBFBceARcWMzI3PgE3NjU0Jy4BJyYjIgcOAQcGATI3PgE3NjU0Jy4BJyYrARYXFhQHBgcDAFBFRmkeHh4eaUZFUP6AUEVGaR4eHh5pRkVQ/wAUFEYuLzU1Ly5GFBQUFEYuLzU1Ly5GFBQCgDUvLkYUFBQURi4vNWIxGRgYGTEDAB4eaUZFUFBFRmkeHh4eaUZFUFBFRmkeHv6ANS8uRhQUFBRGLi81NS8uRhQUFBRGLi/+yxQURi4vNTUvLkYUFDdCQopCQjcAAAACAAAAAASAAwAAHQA5AAABMhceARcWFRQHDgEHBiMhIicuAScmNTQ3PgE3NjMBMjc+ATc2NTQnLgEnJiMiBw4BBwYVFBceARcWAwBPRkZpHh4eHmlGRVD+gE9GRmkeHh4eaUZFUAGANS8uRhQUFBRGLi81NS8uRhQUFBRGLi8DAB4eaUZFUE9GRmkeHh4eaUZFUE9GRmkeHv2AFBRGLi81NS8uRhQUFBRGLi81NS8uRhQUAAADAAAAQAUAAsAABwAhACUAAAEhESE1MzUjEzIWHQEzMhYVERQGKwEVFAYjISImNRE0NjMFESERBED8QAPAQEAgKDgQFBwcFBA4KPwAKDg4KAOg/MACQP6AgIABADgoIBwU/uAUHCAoODgoAcAoOMD/AAEAAAMAAABABQACwAAHACEAJQAAASERITUzNSMTMhYdATMyFhURFAYrARUUBiMhIiY1ETQ2MwURIREEQPxAA8BAQCAoOBAUHBwUEDgo/AAoODgoAuD9gAJA/oCAgAEAOCggHBT+4BQcICg4OCgBwCg4wP8AAQAAAwAAAEAFAALAAAcAIQAlAAABIREhNTM1IxMyFh0BMzIWFREUBisBFRQGIyEiJjURNDYzBREhEQRA/EADwEBAICg4EBQcHBQQOCj8ACg4OCgCIP5AAkD+gICAAQA4KCAcFP7gFBwgKDg4KAHAKDjA/wABAAADAAAAQAUAAsAABwAhACUAAAEhESE1MzUjEzIWHQEzMhYVERQGKwEVFAYjISImNRE0NjMFESERBED8QAPAQEAgKDgQFBwcFBA4KPwAKDg4KAFg/wACQP6AgIABADgoIBwU/uAUHCAoODgoAcAoOMD/AAEAAAIAAABABQACwAAHACEAAAEhESE1MzUjEzIWHQEzMhYVERQGKwEVFAYjISImNRE0NjMEQPxAA8BAQCAoOBAUHBwUEDgo/AAoODgoAkD+gICAAQA4KCAcFP7gFBwgKDg4KAHAKDgAAAAAAwAQ/5AD8ANwABsAKwA7AAABMhceARcWFRQHDgEHBiMiJy4BJyY1NDc+ATc2ExE0JisBIgYVERQWOwEyNjcRNCYrASIGFREUFjsBMjYCAGdaWocnJycnh1paZ2daWocnJycnh1paRxMNYA0TEw1gDRPgEw1gDRMTDWANEwNwJyeHWlpnZ1pahycnJyeHWlpnZ1pahycn/XABQA0TEw3+wA0TEw0BQA0TEw3+wA0TEwACABD/kAPwA3AAGwArAAABMhceARcWFRQHDgEHBiMiJy4BJyY1NDc+ATc2ARE0JiMhIgYVERQWMyEyNgIAZ1pahycnJyeHWlpnZ1pahycnJyeHWloBJxMN/sANExMNAUANEwNwJyeHWlpnZ1pahycnJyeHWlpnZ1pahycn/XABQA0TEw3+wA0TEwAAAAEAEP+QA/ADcABEAAABMhceARcWFRQHDgEHBiMiJy4BJyYnLgE/ATYyFx4BMzI3PgE3Njc2Jy4BJyYHDgEHFxYGIyEiJjURNDYfATY3PgE3NjMB/2daW4cnJycnh1paZzAtLlQmJiEIAQhPBxMHLnE+Rj0+WhoaAQEbG10+PkVAdC5TFxkg/vQUHDsXRyInJ1YvLzIDcCcnh1paZ2daWocnJwkJIRcYHgcUCE8HBigrGxpbPTxESD4+XBoaAQEuLFMXOxwUAQwgGRdHHxoZJAkKAAAABQAA/4ADgAOAAAkAFwAlADMAUQAAFxEhERQGIyEiJgERFBYzMjY1ETQmIyIGBxEUFjMyNjURNCYjIgYHERQWMzI2NRE0JiMiBgEyFh0BFAYjISImPQE0NjsBNz4BOwE4ATEyFh8BM0ADADgo/cAoOAIgEw0NExMNDRPAEw0NExMNDRPAEw0NExMNDRMCgA0TEw38wA0TEw3wEwYWDuUOFwYT8CACoP1gKDg4Aij+QA0TEw0BwA0TEw3+QA0TEw0BwA0TEw3+QA0TEw0BwA0TEwFTEw1ADRMTDUANEyUMDw8MJQAAAgAQ/5AD8ANwACsAWAAAAS4BIyIHDgEHBgcOASsBIiY3Njc+ATc2MzIXHgEXFhc3NhYVERQGIyEiJjcFITIWDwEeATMyNz4BNzY3PgE7ATIWBwYHDgEHBiMiJy4BJyYnBwYmNRE0NjMC5S53QDo1NVYfHw4CDQhzCw4CECwsgVJRWzIvL1cnJyJHFzscFP70IBkX/a4BDCAZF1Mud0A6NTVWHx8OAg0IcwsOAhAsLIFSUVsyLy9XJyciRxc7HBQCdSwvExNDLy44CAoRC1dJSmwfHwkKJBkZIEcXGSD+9BQcOxfyOxdTLC8TE0MvLjgIChELV0lKbB8fCQokGRkgRxcZIAEMFBwAAQAQ/5AD8ANwAEQAAAEyFx4BFxYXNzYWFREUBiMhIiY/AS4BJyYHDgEHBhcWFx4BFxYzMjY3NjIfARYGBwYHDgEHBiMiJy4BJyY1NDc+ATc2MwIBMi8vVicnIkcXOxwU/vQgGRdTLnRART4+XRsbAQEaGlo+PUY+cS4HEwdPCAEIISYmVC4tMGdaWocnJycnh1taZwNwCgkkGRofRxcZIP70FBw7F1MsLgEBGhpcPj5IRDw9WxobKygGB08IFAceGBchCQknJ4daWmdnWlqHJycAAAABAAD/wAOAA0AASAAAJRUUBiM4ATEjIiY/AScHFxYGKwEiJjU4ATE1NDYfATcnBwYmPQE0NjM4ATEzMhYPARc3JyY2OwEyFhU4ATEVFAYvAQcXNzYWFQOAHBTgIBkXSNbWSBcZIOAUHDsXSNfXSBc7HBTgIBkXSNbWSBcZIOAUHDsXSNfXSBc70OAUHDsXSNfXSBc7HBTgIBkXSNbXSRcZIOAUHDsXSNfXSBc7HBTgIBkXSNbXSRcZIAAAAAIAAP+ABAADgAAeADoAAAEyFhURFAYjISImNRE0NjMhMhYdARQGIyERITU0NjMTMhYVERQGLwEBDgEjIiYvAS4BNTQ2NwEnJjYzA2ANEzgo/UAoODgoAUANExMN/uACgBMNsBQcOxdH/hgGEgoKEQctBwcHBwHnRxcZIAEAEw3/ACg4OCgCwCg4Ew1ADRP9gOANEwKAHBT/ACAYFkf+GQcHBwctBxEKChIGAehHFzsAAgAA/8AFAANAADcATQAAARYXHgEXFhUUBw4BBwYjISInLgEnJjU0Nz4BNzY3PAE1NDc+ATc2MzIXHgEXFhc+ATMyFhUUBgcFNiYrATU0JisBIgYdASMiBh8BFjI3BDMsJSY3DxAUFEYuLzX9IDw0NU4WFw4PMyMjKhkZVzo7QiwqKUcdHhQXNh5PcQcG/vYQERWDEw1gDRODFREQ0goaCgG7CRcXQioqLjUvLkYUFBcWTjU0PC8rK0caGw8ECARCOzpXGRkMCyoeHSQPEXFPEiMQshAn4A0TEw3gJxDSCgoAAAAAAgAA/8AFAANAADcATgAAARYXHgEXFhUUBw4BBwYjISInLgEnJjU0Nz4BNzY3PAE1NDc+ATc2MzIXHgEXFhc+ATMyFhUUBgcFMjYvASYiDwEGFjsBFRQWOwEyNj0BMwQzLCUmNw8QFBRGLi81/SA8NDVOFhcODzMjIyoZGVc6O0IsKilHHR4UFzYeT3EHBv7gFREQ0goaCtIQERWDEw1gDRODAbsJFxdCKiouNS8uRhQUFxZONTQ8LysrRxobDwQIBEI7OlcZGQwLKh4dJA8RcU8SIxB7JxDSCgrSECfgDRMTDeAAAgAA/8AEAANAAA8ANAAAATIWFREUBiMhIiY1ETQ2MwEnNzY0LwEmIg8BJyYiDwEGFB8BBwYUHwEWMj8BFxYyPwE2NCcDoCg4OCj8wCg4OCgCmYaGBwdRBxUHhYUHFQdRBweGhgcHUQcVB4WFBxUHUQcHA0A4KP1AKDg4KALAKDj9u4WFBxUHUQcHhoYHB1EHFQeFhQcVB1EHB4aGBwdRBxUHAAACABMAAAUAAwAAFAA5AAABMhYVERQGIyEiJicBJjQ3AT4BMyEDJzc2NC8BJiIPAScmIg8BBhQfAQcGFB8BFjI/ARcWMj8BNjQnBIA1S0s1/RsaLxL+0xMTAS0RLxoC5ql8fAkJLgkbCXx8CRsJLgkJfX0JCS4JGwl8fAkbCS4JCQMASzX+ADVLExIBLhI2EgEtEhT+BHx8CRsJLgkJfX0JCS4JGwl8fAkbCS4JCXx8CQkuCRsJAAAAAwAA/4ADAAOAABEAJwAyAAABFBYzIREUBiMhIiY1ETQ2MyETNiYrATU0JisBIgYdASMiBh8BFjI3AR4BHQEhETMyFhcBwBwUARAcFP1gFBwcFAGQmQ8QFoITDUANE4IWEA/BChwKAVoHB/8ADAoRBwJwFBz9cBQcHBQDoBQc/UkPKKANExMNoCgPvwoKAqQHEQoMAQAHBwADAAD/gAR2A4AACgAaADYAAAEVIREzMhYfAR4BARYUDwEGJj0BIzUzNTQ2FwUUFjMhERQGIyEiJjURNDYzIREUFjMhESEiBhUDAP8ADAoRB8QHBwF2Cgq/ECeAgCcQ/ckTDQFgHBT9YBQcHBQBkBwUARD+oA0TAowMAQAHB8QHEf6CChwKwQ8QFoKAghYQD/kNE/7wFBwcFAOgFBz+8BQc/wATDQAAAAADAAD/gAQAA4AACQAUADcAABMzFSMiJj0BNDYBHgEdASERMzIWFwMUFjMhERQGIyEiJjURIRUUFj8BNjQvASYGHQEhETQ2MyERIODgDRMTA98HB/8ADAoRB24cFAEQHBT9YBQcAQAnEL8KCr8PKP8AHBQBkAFAgBMNQA0TAW4HEQoMAQAHB/7+FBz9cBQcHBQBEIIWEA/BChwKwQ8QFoICEBQc/vAAAAADAAD/gAMAA4AAEQAoADMAAAEUFjMhERQGIyEiJjURNDYzIRMyNi8BJiIPAQYWOwEVFBY7ATI2PQEzEx4BHQEhETMyFhcBwBwUARAcFP1gFBwcFAGQghYQD8EKHArBDxAWghMNQA0TgrAHB/8ADAoRBwJwFBz9cBQcHBQDoBQc/UAoD78KCr8PKKANExMNoAHuBxEKDAEABwcAAAACABP/gAQdA4AAIQAoAAABHgEPARMWBiMiJiclBQ4BIyImNxMnJjY3JRM+ATMyFhcTEzclJxEXAwP5Jxkc1DIFKRwHDwf++v76Bw8IHCgFMtQcGScBJYMIIBERIAmCMqX+6Xz5MAIpBksczv7dHywEA4qJBAQsHwEjzhxLBisBCBISEhL++P7foCn8/YWCARQAAAAAAgAAAA4D9wLyABEANQAAATYWFREUBi8BIyImNRE0NjsBBRcWFA8BBiIvAQcGIi8BJjQ/AScmND8BNjIfATc2Mh8BFhQHAa4XOzsXsswUHBwUzAKfXAkJLgoaCltbChoKLgkJXFwJCS4KGgpbWwoaCi4JCQLyFhgg/WAgGBayHBQBIBQcwFsKGgouCQlcXAkJLgoaCltbChoKLgkJXFwJCS4KGgoAAAAABAAJ/4kD9wN3ABYALABCAFgAAAEyFh0BFAYvAQcGIi8BJjQ/AScmNjsBNyImPQE0Nh8BNzYyHwEWFA8BFxYGIwMXFhQPAQYiLwEHBiY9ATQ2OwEyFgcBNhYdARQGKwEiJj8BJyY0PwE2Mh8BAZAUHDsXPscJGwkzCQnHQhcZIODgFBw7Fz7HCRsJMwkJx0IXGSAgxwkJMwkbCcc+FzscFOAgGRf9/Bc7HBTgIBkXQscJCTMJGwnHAUAcFOAgGRdCxwkJMwkbCcc+FzuAHBTgIBkXQscJCTMJGwnHPhc7/vDHCRsJMwkJx0IXGSDgFBw7FwIEFhgg4BQcOxc+xwkaCjMJCccAAAAABAAA/5YD9wOAABUANABAAEwAACUWFA8BBiIvAS4BNycjAzcFFRc2FhcnIgYHJyY2Nz4BFx4BDwEfATc2FhcWBgcOAQcnLgEjBwYWFwcGIicmNDcBAzI2NTQmIyIGFRQWA+oWFmkWPhbqIg4U1XzAgAEA1SpeI2kMGQykASgrOJJHDggKlReHlQobAxImNxQsGCceTSvPCAYM+CVqJiUlATHWFBwcFBQcHGkWPhZpFhbqI14q1QEAgMB81RQOImsDA6Q5bCs3JhIDGwqViBaVCggNR5M4Ex0LJx4gpCBAHfglJSZqJQEx/kUcFBQcHBQUHAAAAAMAAP+AA4ADgAAKACMAQQAAFwMhAw4BIyEiJicTBhY7ARUUFjsBMjY9ATMyNi8BLgEjIgYHATIWHQEUBiMhIiY9ATQ2OwE3PgE7ATgBMTIWHwEzaioDACoDNyb+FCY3A40PEBVzEw1ADRNzFREQsgULBwcLBQG3DRMTDfzADRMTDfATBhYO5Q4XBhPwJgKm/VomNDQmAWAQKuANExMN4CoQvAUFBQUBShMNQA0TEw1ADRMlDA8PDCUAAAAAAwAA/4ADgAOAAAkAIgBAAAAXESERFAYjISImEwYWOwEVFBY7ATI2PQEzMjYvAS4BIyIGBwEyFh0BFAYjISImPQE0NjsBNz4BOwE4ATEyFh8BM0ADADgo/cAoOLcPEBVzEw1ADRNzFREQsgULBwcLBQG3DRMTDfzADRMTDfATBhYO5Q4XBhPwIAKg/WAoODgBghAq4A0TEw3gKhC8BQUFBQFKEw1ADRMTDUANEyUMDw8MJQAAAQAAAAEAAII1aM1fDzz1AAsEAAAAAADcXxJIAAAAANxfEkgAAP+ABQADgAAAAAgAAgAAAAAAAAABAAADgP+AAAAFAAAAAAAFAAABAAAAAAAAAAAAAAAAAAAAfAQAAAAAAAAAAAAAAAAAAAAEAAAABAAAEgSAADwEAAAPAsAAEgQAAAAEAAAABAAAEAQAACYEgAAABAAAAAOAAAACAAAAAwAAAASAAAADAAAAA4AAgAQAAAAEAAAXA4AAAAOAAAADgAAABAAAAAQAAAADgACAA4AAAAKAAEUCgABFBAAAEAQAABAEAAAQBAAAEAQAABAEAAAQBAAAEAOAAA4DgAAAA4AAGQOAABkDgAAAA4AAAAOAAAADgAAABAAAEASAAAAFAAAABIAADQOAABkDgAAZBIAAPAMAAAAEAAAAA4AAAASAAAAEAAAWBQAAAAOAAAADgAAABAAAAAKAACICgAAiAYAAOgGAAAACgAAAAsAAAAOAAAAEAAAABAAAAAQAAAAEAAAOBAAAEAQAABAEAAAQBAAAEAOAAAAEAAAQAYAAMAQAABADgAAAA4AAAAOAAAADgAAAA4AAAAQAABMEAAA2BAAAAAOAAAAFAAAAA4AAQAOAAAADgAAABIAAAASAAAAFAAAABQAAAAUAAAAFAAAABQAAAAQAABAEAAAQBAAAEAOAAAAEAAAQBAAAEAOAAAAEAAAABQAAAAUAAAAEAAAABQAAEwMAAAAEgAAABAAAAAMAAAAEMAATBAAAAAQAAAkEAAAAA4AAAAOAAAAAAAAAAAoAFAAeAIoAygD8ASYBYAH4AnwC8gOEBAIEaASmBMYFCgW+BdQGAAY8BmgGggayBs4G/Ac4B2QHlgfAB+wIRgiKCO4JQAm+CiIKhgq6Cu4LIgtWC8QMMAxkDIAM1g1mDg4OUA58DqYOyA8KD3IPuBAOEMwRIBFuEbQSDhIqEkYSYhJ+EqwTGBNgE7oUFBSMFRwVbhXAFhIWZBa8FvIXKBdqF5wX2hgKGDoYahjmGS4ZsBngGpwa2hsmG2Qb4Bw6HHQcrhzoHSIdVh2uHfQeXh7QH1QfviAcIHQg5iFYIaoiBiJSIqYi+iNII5Ij5iRqJOQlQiWcAAAAAQAAAHwAgwAHAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAA4ArgABAAAAAAABAAwAAAABAAAAAAACAAcAjQABAAAAAAADAAwARQABAAAAAAAEAAwAogABAAAAAAAFAAsAJAABAAAAAAAGAAwAaQABAAAAAAAKABoAxgADAAEECQABABgADAADAAEECQACAA4AlAADAAEECQADABgAUQADAAEECQAEABgArgADAAEECQAFABYALwADAAEECQAGABgAdQADAAEECQAKADQA4HNjLWljb25zLTkwMABzAGMALQBpAGMAbwBuAHMALQA5ADAAMFZlcnNpb24gMS4wAFYAZQByAHMAaQBvAG4AIAAxAC4AMHNjLWljb25zLTkwMABzAGMALQBpAGMAbwBuAHMALQA5ADAAMHNjLWljb25zLTkwMABzAGMALQBpAGMAbwBuAHMALQA5ADAAMFJlZ3VsYXIAUgBlAGcAdQBsAGEAcnNjLWljb25zLTkwMABzAGMALQBpAGMAbwBuAHMALQA5ADAAMEZvbnQgZ2VuZXJhdGVkIGJ5IEljb01vb24uAEYAbwBuAHQAIABnAGUAbgBlAHIAYQB0AGUAZAAgAGIAeQAgAEkAYwBvAE0AbwBvAG4ALgAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=") format("woff")}</style>
<style id="style-font-emoji" type="text/css">@font-face{font-family:color-emoji;src:local("Twemoji Mozilla"),local("Apple Color Emoji"),local("Segoe UI Emoji"),local("Segoe UI Symbol"),local("Noto Color Emoji"),local("EmojiOne Color"),local("Android Emoji")}</style>
<style id="style-core" type="text/css">#store-area,tw-storydata{display:none!important;z-index:0}::-webkit-scrollbar{height:8px;width:8px}::-webkit-scrollbar-corner,::-webkit-scrollbar-track{background-color:#111}::-webkit-scrollbar-thumb{background-color:#333;border:1px solid #111}*{scrollbar-color:#333 #111;scrollbar-width:thin}:-webkit-full-screen{height:100%;width:100%}:-ms-fullscreen{height:100%;width:100%}:fullscreen{height:100%;width:100%}body::-ms-backdrop{background:0 0}:focus{outline:thin dotted}:disabled{cursor:not-allowed!important}html{font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Cantarell,Ubuntu,"Helvetica Neue",Helvetica,Arial,sans-serif,color-emoji;font-size:16px;line-height:1}body{color:#eee;background-color:#111;overflow:auto}a{cursor:pointer;color:#68d;text-decoration:none;-webkit-transition-duration:.2s;-o-transition-duration:.2s;transition-duration:.2s}a:hover,html[data-outlines] a:focus{color:#8af;text-decoration:underline}a.link-broken{color:#c22}a.link-broken:hover,html[data-outlines] a.link-broken:focus{color:#e44}a[disabled],span.link-disabled{color:#aaa;cursor:not-allowed!important;text-decoration:none}a.link-internal{-webkit-touch-callout:none}area{cursor:pointer}button{cursor:pointer;color:#eee;background-color:#35a;border:1px solid #57c;line-height:normal;padding:.4em;-webkit-transition-duration:.2s;-o-transition-duration:.2s;transition-duration:.2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}button:hover,html[data-outlines] button:focus{background-color:#57c;border-color:#79e}button:disabled{background-color:#444;border:1px solid #666}code,kbd,pre,samp,var{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Lucida Console","Courier New",Courier,monospace,monospace}pre{overflow:auto}input,select,textarea{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}select{padding:.34em .4em}input[type=text]{min-width:18em}textarea{min-width:30em;resize:vertical}input[type=checkbox],input[type=file],input[type=radio],select{cursor:pointer}input[type=range]{-webkit-appearance:none;min-height:1.2em}input[type=range]:focus{outline:0}input[type=range]::-webkit-slider-runnable-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;margin-top:-5px;width:33px}input[type=range]:focus::-webkit-slider-runnable-track{background:#222}input[type=range]::-moz-range-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-moz-range-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;width:33px}input[type=range]::-ms-track{background:0 0;border-color:transparent;color:transparent;cursor:pointer;height:10px;width:calc(100% - 1px)}input[type=range]::-ms-fill-lower{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-fill-upper{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:16px;width:33px}html[data-outlines] input:focus,html[data-outlines] select:focus,html[data-outlines] textarea:focus,input:hover,select:hover,textarea:hover{background-color:#333;border-color:#eee}input:disabled,select:disabled,textarea:disabled{color:#333;background-color:transparent;border-color:#111}hr{display:block;height:1px;border:none;border-top:1px solid #eee;margin:1em 0;padding:0}audio,canvas,progress,video{max-width:100%;vertical-align:middle}.no-transition{-webkit-transition:none!important;-o-transition:none!important;transition:none!important}.error-view{background-color:#511;border-left:.5em solid #c22;display:inline-block;margin:.1em;max-width:100%;padding:0 .25em;position:relative}.error-view>.error-toggle{background-color:transparent;border:none;line-height:inherit;left:0;padding:0;position:absolute;top:0;width:1.75em}.error-view>.error-toggle:hover,html[data-outlines] .error-view>.error-toggle:focus{background-color:transparent}.error-view>.error{display:inline-block;margin-left:.25em}.error-view>.error-toggle+.error{margin-left:1.5em}.error-view>.error-source[hidden]{display:none}.error-view>.error-source:not([hidden]){background-color:rgba(0,0,0,.2);display:block;margin:0 0 .25em;overflow-x:auto;padding:.25em}.highlight,.marked{color:#ff0;font-weight:700;font-style:italic}.nobr{white-space:nowrap}.error-view>.error-toggle::before,.error-view>.error::before,[data-icon-after]::after,[data-icon-before]::before,[data-icon]::before,a.link-external::after{font-family:sc-icons!important;font-style:normal;font-weight:400;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}[data-icon]::before{content:attr(data-icon)}[data-icon-before]::before{content:attr(data-icon-before);margin-right:.35em}[data-icon-after]::after{content:attr(data-icon-after);margin-left:.35em}.error-view>.error-toggle::before{content:"\f0da"}.error-view>.error-toggle.enabled::before{content:"\f0d7"}.error-view>.error::before{content:"\f071";margin-right:.35em}a.link-external::after{content:"\f35d";margin-left:.25em}</style>
<style id="style-core-display" type="text/css">#story{z-index:10;margin:2.5em}@media screen and (max-width:1136px){#story{margin-right:1.5em}}#passages{max-width:54em;margin:0 auto}</style>
<style id="style-core-passage" type="text/css">.passage{line-height:1.75;text-align:left;-webkit-transition:opacity .4s ease-in;-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.passage-in{opacity:0}.passage ol,.passage ul{margin-left:.5em;padding-left:1.5em}.passage table{margin:1em 0;border-collapse:collapse;font-size:100%}.passage caption,.passage td,.passage th,.passage tr{padding:3px}@media (prefers-reduced-motion:reduce){.passage{-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}}</style>
<style id="style-core-macro" type="text/css">@-webkit-keyframes cursor-blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}@-o-keyframes cursor-blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}@keyframes cursor-blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}.macro-append-insert,.macro-linkappend-insert,.macro-linkprepend-insert,.macro-linkreplace-insert,.macro-prepend-insert,.macro-repeat-insert,.macro-replace-insert,.macro-timed-insert{-webkit-transition:opacity .4s ease-in;-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.macro-append-in,.macro-linkappend-in,.macro-linkprepend-in,.macro-linkreplace-in,.macro-prepend-in,.macro-repeat-in,.macro-replace-in,.macro-timed-in{opacity:0}.macro-type-cursor::after{-webkit-animation:cursor-blink 1s infinite;-o-animation:cursor-blink 1s infinite;animation:cursor-blink 1s infinite;content:"\2590";opacity:1}</style>
<style id="style-ui-dialog" type="text/css">html[data-dialog] body{overflow:hidden}#ui-overlay{background-color:#000;height:200%;left:-50%;opacity:0;position:fixed;top:-50%;-webkit-transition:visibility .2s step-end,opacity .2s ease-in;-o-transition:visibility .2s step-end,opacity .2s ease-in;transition:visibility .2s step-end,opacity .2s ease-in;visibility:hidden;width:200%;z-index:100000}#ui-overlay.open{opacity:.8;-webkit-transition:visibility 0s;-o-transition:visibility 0s;transition:visibility 0s;visibility:visible}#ui-dialog{display:none;margin:0;max-width:66em;opacity:0;padding:0;position:fixed;top:50px;z-index:100100}#ui-dialog.open{display:block;opacity:1;-webkit-transition:opacity .2s ease-in;-o-transition:opacity .2s ease-in;transition:opacity .2s ease-in}#ui-dialog>*{-webkit-box-sizing:border-box;box-sizing:border-box}#ui-dialog-titlebar{background-color:#444;min-height:24px;position:relative}#ui-dialog-title{font-size:1.5em;margin:0;padding:.2em 3.5em .2em .5em;text-align:center;text-transform:uppercase}#ui-dialog-close{background-color:transparent;border:1px solid transparent;cursor:pointer;display:block;font-size:120%;height:92%;margin:0;padding:0;position:absolute;right:0;top:0;-webkit-transition-duration:.2s;-o-transition-duration:.2s;transition-duration:.2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;width:3.6em;font-family:sc-icons!important;font-style:normal;font-weight:400;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#ui-dialog-close:hover{background-color:#b44;border-color:#d66}#ui-dialog-body{background-color:#111;border:1px solid #444;height:calc(100% - 2.1em);line-height:1.5;min-width:300px;overflow:auto;padding:1em;text-align:left}#ui-dialog-body>:first-child{margin-top:0}#ui-dialog-body hr{background-color:#444}#ui-dialog-body ul.buttons{margin:0;padding:0;list-style:none}#ui-dialog-body ul.buttons li{display:inline-block;margin:0;padding:.4em .4em 0 0}#ui-dialog-body ul.buttons>li+li>button{margin-left:1em}@media (prefers-reduced-motion:reduce){#ui-overlay{-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}#ui-overlay.open{-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}#ui-dialog.open{-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}}</style>
<style id="style-ui-dialog-saves" type="text/css">#ui-dialog-body.saves{padding:0 0 1px}#ui-dialog-body.saves>:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves>h2{background-color:#222;font-size:inherit;margin:0;padding:.1em 0 .1em .4em}#ui-dialog-body.saves table{border-spacing:0;width:100%}#ui-dialog-body.saves tr:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves td{padding:.33em}#ui-dialog-body.saves td:first-child{display:none!important}#ui-dialog-body.saves td:nth-child(3){line-height:1.2;width:100%}#ui-dialog-body.saves td:last-child{text-align:right}#ui-dialog-body.saves .empty{color:#999;speak:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.saves .details{font-size:75%;margin-left:.25em}#ui-dialog-body.saves #saves-list button{color:#eee;background-color:transparent;border:1px solid #444;height:2.237em;width:2.237em}#ui-dialog-body.saves #saves-list button:disabled{color:#444;border-color:#444}#ui-dialog-body.saves #saves-list button:not(:disabled):hover{background-color:#222;border-color:#ddd}#ui-dialog-body.saves #saves-list button.delete:not(:disabled),#ui-dialog-body.saves button[id=saves-clear]:not(:disabled){background-color:#911;border-color:#b33}#ui-dialog-body.saves #saves-list button.delete:not(:disabled):hover,#ui-dialog-body.saves button[id=saves-clear]:not(:disabled):hover{background-color:#b33;border-color:#d55}#ui-dialog-body.saves #saves-list button.load:not(:disabled){background-color:#161;border-color:#383}#ui-dialog-body.saves #saves-list button.load:not(:disabled):hover{background-color:#383;border-color:#5a5}#ui-dialog-body.saves .buttons li{padding:.4em}#ui-dialog-body.saves .buttons>li+li>button{margin-left:.2em}#ui-dialog-body.saves .buttons.slots>li:last-child{float:right}#ui-dialog-body.saves #saves-list button::before,#ui-dialog-body.saves .buttons button::before{font-family:sc-icons!important;font-style:normal;font-weight:400;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#ui-dialog-body.saves .buttons button::before{margin-right:.35em}#ui-dialog-body.saves button.delete::before{content:"\f2ed"}#ui-dialog-body.saves button.delete:disabled::before{content:"\f1f8"}#ui-dialog-body.saves button.load::before{content:"\f04b"}#ui-dialog-body.saves button.save::before{content:"\f0c7"}#ui-dialog-body.saves button[id=saves-export]::before{content:"\f56e"}#ui-dialog-body.saves button[id=saves-import]::before{content:"\f56f"}#ui-dialog-body.saves button[id=saves-clear]::before{content:"\f2ed"}#ui-dialog-body.saves button[id=saves-clear]:disabled::before{content:"\f1f8"}#ui-dialog-body.saves button[id=saves-disk-save]::before{content:"\f56d"}#ui-dialog-body.saves button[id=saves-disk-load]::before{content:"\f574"}</style>
<style id="style-ui-dialog-settings" type="text/css">#ui-dialog-body.settings [id|=setting-body]>div:first-child{display:table;width:100%}#ui-dialog-body.settings [id|=setting-label]{display:table-cell;padding:.4em 2em .4em 0}#ui-dialog-body.settings [id|=setting-label]+div{display:table-cell;min-width:8em;text-align:right;vertical-align:middle;white-space:nowrap}#ui-dialog-body.settings div[id|=header-body]{margin:1em 0}#ui-dialog-body.settings div[id|=header-body]:first-child{margin-top:0}#ui-dialog-body.settings div[id|=header-body]:not(:first-child){border-top:1px solid #444;padding-top:1em}#ui-dialog-body.settings div[id|=header-body]>*{margin:0}#ui-dialog-body.settings h2[id|=header-heading]{font-size:1.375em}#ui-dialog-body.settings p[id|=header-desc],#ui-dialog-body.settings p[id|=setting-desc]{font-size:87.5%;margin:0 0 0 .5em}#ui-dialog-body.settings div[id|=setting-body]+div[id|=setting-body]{margin:1em 0}#ui-dialog-body.settings [id|=setting-control]{white-space:nowrap}#ui-dialog-body.settings button[id|=setting-control]{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}#ui-dialog-body.settings button[id|=setting-control]:hover{background-color:#333;border-color:#eee}#ui-dialog-body.settings button[id|=setting-control].enabled{background-color:#282;border-color:#4a4}#ui-dialog-body.settings button[id|=setting-control].enabled:hover{background-color:#4a4;border-color:#6c6}#ui-dialog-body.settings input[type=range][id|=setting-control]{max-width:35vw}#ui-dialog-body.settings span[id|=setting-input]{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.settings button[id|=setting-control].enabled::after,#ui-dialog-body.settings button[id|=setting-control]::after{font-family:sc-icons!important;font-style:normal;font-weight:400;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;margin-left:.35em}#ui-dialog-body.settings button[id|=setting-control]::after{content:"\f204"}#ui-dialog-body.settings button[id|=setting-control].enabled::after{content:"\f205"}</style>
<style id="style-ui-dialog-legacy" type="text/css">#ui-dialog-body.list{padding:0}#ui-dialog-body.list ul{margin:0;padding:0;list-style:none;border:1px solid transparent}#ui-dialog-body.list li{margin:0}#ui-dialog-body.list li:not(:first-child){border-top:1px solid #444}#ui-dialog-body.list li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-decoration:none}#ui-dialog-body.list li a:hover{background-color:#333;border-color:#eee}#ui-dialog-body.list a{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}</style>
<style id="style-ui-bar" type="text/css">#story{margin-left:20em;-webkit-transition:margin-left .2s ease-in;-o-transition:margin-left .2s ease-in;transition:margin-left .2s ease-in}#ui-bar.stowed~#story{margin-left:4.5em}@media screen and (max-width:1136px){#story{margin-left:19em}#ui-bar.stowed~#story{margin-left:3.5em}}@media screen and (max-width:768px){#story{margin-left:3.5em}}#ui-bar{background-color:#222;border-right:1px solid #444;height:100%;left:0;margin:0;padding:0;position:fixed;text-align:center;top:0;-webkit-transition:left .2s ease-in;-o-transition:left .2s ease-in;transition:left .2s ease-in;width:17.5em;z-index:50}#ui-bar.stowed{left:-15.5em}#ui-bar-tray{position:absolute;top:.2em;left:0;right:0}#ui-bar-body{height:calc(100% - 2.5em);line-height:1.5;margin:2.5em 0;overflow:auto;padding:0 1.5em}#ui-bar.stowed #ui-bar-body,#ui-bar.stowed #ui-bar-history{visibility:hidden;-webkit-transition:visibility .2s step-end;-o-transition:visibility .2s step-end;transition:visibility .2s step-end}#ui-bar a{text-decoration:none}#ui-bar hr{border-color:#444}#ui-bar-tray button{color:#eee;background-color:transparent;border:1px solid #444}#ui-bar-tray button:hover{background-color:#444;border-color:#eee}#ui-bar-tray button:disabled{color:#444;background-color:transparent;border-color:#444}button#ui-bar-toggle{border-right:none;position:absolute;right:0;top:0}#ui-bar-history{margin:0 auto}#ui-bar-history button:not(:first-child){margin-left:1.2em}#ui-bar-body>:not(:first-child){margin-top:2em}#story-title{margin:0;font-size:162.5%}#story-author{margin-top:2em;font-weight:700}#menu ul{margin:1em 0 0;padding:0;list-style:none;border:1px solid #444}#menu ul:empty{display:none}#menu li{margin:0}#menu li:not(:first-child){border-top:1px solid #444}#menu li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-transform:uppercase}#menu li a:hover{background-color:#444;border-color:#eee}#menu a,#ui-bar-tray button{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#menu-core li[id|=menu-item] a::before,#ui-bar-tray button::before{font-family:sc-icons!important;font-style:normal;font-weight:400;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#ui-bar-tray button::before{display:block;font-size:1.1em;width:1em}#ui-bar-toggle::before{content:"\f053"}#ui-bar.stowed #ui-bar-toggle::before{content:"\f054"}#ui-bar-tray #history-backward::before{content:"\f060"}#ui-bar-tray #history-jumpto::before{content:"\f0e7"}#ui-bar-tray #history-forward::before{content:"\f061"}#menu-item-continue a::before,#menu-item-restart a::before,#menu-item-saves a::before,#menu-item-settings a::before,#menu-item-share a::before{margin-right:.35em}#menu-item-continue a::before{content:"\f04b"}#menu-item-saves a::before{content:"\f0c7"}#menu-item-settings a::before{content:"\f013"}#menu-item-restart a::before{content:"\f011"}#menu-item-share a::before{content:"\f1e0"}@media (prefers-reduced-motion:reduce){#story{-webkit-transition:margin-left 0s;-o-transition:margin-left 0s;transition:margin-left 0s}#ui-bar{-webkit-transition:left 0s;-o-transition:left 0s;transition:left 0s}}</style>
<style id="style-ui-debug-bar" type="text/css">#debug-bar{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:0;margin:0;max-height:95%;max-width:66em;min-width:300px;padding:.5em;position:fixed;right:0;z-index:99900}#debug-bar>div:not([id])+div{margin-top:.5em}#debug-bar>div>label{margin-right:.5em}#debug-bar>div>input[type=text]{min-width:8em;width:14em}#debug-bar>div>select{width:22em}#debug-bar-toggle{color:#eee;background-color:#222;border:1px solid #444;height:calc(100% + 1px);left:calc(-2em - 1px);position:absolute;top:-1px;width:2em}#debug-bar-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-hint{bottom:.75em;font-size:4.5em;opacity:.33;pointer-events:none;position:fixed;right:.6em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap}#debug-bar-watch{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:calc(100% + 1px);font-size:.9em;left:-1px;max-height:280%;max-height:calc(95vh - 100%);position:absolute;overflow-x:hidden;overflow-y:scroll;right:0;z-index:99800}#debug-bar-watch[hidden]{display:none}#debug-bar-watch div{color:#999;font-style:italic;margin:1em auto;text-align:center}#debug-bar-watch table{width:100%}#debug-bar-watch tr:nth-child(2n){background-color:rgba(127,127,127,.15)}#debug-bar-watch td{padding:.2em 0}#debug-bar-watch td:first-child+td{padding:.2em .3em .2em .1em}#debug-bar-watch .watch-delete{background-color:transparent;border:none;color:#c00}#debug-bar-watch-all,#debug-bar-watch-clear{margin-left:.5em}#debug-bar-views-toggle,#debug-bar-watch-toggle{color:#eee;background-color:transparent;border:1px solid #444;margin-right:1em;padding:.4em}#debug-bar-views-toggle:hover,#debug-bar-watch-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle,html[data-debug-view] #debug-bar-views-toggle{background-color:#282;border-color:#4a4}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle:hover,html[data-debug-view] #debug-bar-views-toggle:hover{background-color:#4a4;border-color:#6c6}#debug-bar-hint::after,#debug-bar-passage-play::before,#debug-bar-toggle::before,#debug-bar-views-toggle::after,#debug-bar-watch .watch-delete::before,#debug-bar-watch-add::before,#debug-bar-watch-all::before,#debug-bar-watch-clear::before,#debug-bar-watch-toggle::after{font-family:sc-icons!important;font-style:normal;font-weight:400;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#debug-bar-toggle::before{content:"\f188"}#debug-bar-hint::after{content:"\f188\202f\f061"}#debug-bar-watch .watch-delete::before{content:"\f00d"}#debug-bar-watch-add::before{content:"\f067"}#debug-bar-watch-all::before{content:"\f0d0"}#debug-bar-watch-clear::before{content:"\f2ed"}#debug-bar-views-toggle::after,#debug-bar-watch-toggle::after{content:"\f204";margin-left:.35em}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle::after,html[data-debug-view] #debug-bar-views-toggle::after{content:"\f205"}#debug-bar-passage-play::before{content:"\f04b"}</style>
<style id="style-ui-debug-views" type="text/css">html[data-debug-view] .debug{padding:.25em;background-color:#234}html[data-debug-view] .debug[title]{cursor:help}html[data-debug-view] .debug.block{display:inline-block;vertical-align:middle}html[data-debug-view] .debug.invalid{text-decoration:line-through}html[data-debug-view] .debug.hidden,html[data-debug-view] .debug.hidden .debug{background-color:#555}html:not([data-debug-view]) .debug.hidden{display:none}html[data-debug-view] .debug[data-name][data-type].nonvoid::after,html[data-debug-view] .debug[data-name][data-type]::before{background-color:rgba(0,0,0,.25);font-family:monospace,monospace;white-space:pre}html[data-debug-view] .debug[data-name][data-type]::before{content:attr(data-name)}html[data-debug-view] .debug[data-name][data-type|=macro]::before{content:"<<" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=macro].nonvoid::after{content:"<</" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=html]::before{content:"<" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type|=html].nonvoid::after{content:"</" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type]:not(:empty)::before{margin-right:.25em}html[data-debug-view] .debug[data-name][data-type].nonvoid:not(:empty)::after{margin-left:.25em}html[data-debug-view] .debug[data-name][data-type|=special],html[data-debug-view] .debug[data-name][data-type|=special]::before{display:block}</style>
</head>
<body>
	<div id="init-screen">
		<div id="init-no-js"><noscript>JavaScript must be enabled to play.</noscript></div>
		<div id="init-lacking"><p>Browser lacks capabilities required to play.</p><p>Upgrade or switch to another browser.</p></div>
		<div id="init-loading"><div>Loading&hellip;</div></div>
	</div>
	<tw-storydata name="Liff Origins: Jaylie" startnode="107" creator="Twine" creator-version="2.10.0" format="SugarCube" format-version="2.37.3" ifid="FDA8DE99-1A57-4FDA-BC8F-CD9A1987CDA0" options="" tags="" zoom="1" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">/* twine-user-stylesheet #1: "Base.css" */
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
/* twine-user-stylesheet #2: "CharacterSheetStyles.css" */
/* Character Sheet Overlay Base */
#character-sheet-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.75);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: Cinzel, serif;
}

.overlay-hidden {
  display: none !important;
}

#character-sheet-container {
  background-image: url("images/overlaybg_charactersheet.png");
  background-size: cover;
  background-position: center;
  padding: 20px;
  width: 90vw;
  height: 90vh;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
}

.charactersheet-close-btn {
  position: absolute;
  top: 3%;
  right: 5%;
  background: transparent;
  border: none;
  font-size: 24px;
  color: #421e14;
  cursor: pointer;
}

/* Layout Rows */
.charsheet-top,
.charsheet-center,
.charsheet-bottom {
  display: flex;
  justify-content: space-between;
  gap: 20px;
}

/* Top Sections */
.charsheet-top-left,
.charsheet-top-right {
  flex: 1;
  font-size: 1.1em;
}

/* Center Sections */
.charsheet-center-left {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

.char-portrait img {
  width: 150px;
  height: 150px;
  object-fit: contain;
  border: 2px solid #3b2a1e;
  background-color: rgba(255, 255, 255, 0.1);
}

.charsheet-center-right {
  flex: 3;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.attributes-panel,
.skills-panel {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.attributes-panel ul,
.skills-panel ul {
  list-style-type: none;
  padding-left: 0;
}

.skills-panel .primary-skills,
.skills-panel .secondary-skills {
  background-color: rgba(255, 255, 255, 0.05);
  padding: 10px;
  border: 1px solid #c4b998;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.skills-panel .secondary-skills ul {
  padding-left: 15px;
}

.skills-panel span {
  font-weight: bold;
  cursor: help;
}

/* Bottom Sections */
.charsheet-bottom-left {
  flex: 2;
}

.charsheet-bottom-left img {
  width: 100%;
  max-width: 300px;
}

.charsheet-bottom-right {
  flex: 3;
  display: flex;
  gap: 10px;
}

.traits-panel,
.status-panel {
  flex: 1;
  padding: 10px;
  border: 1px solid #9c8b65;
  background-color: rgba(255, 255, 255, 0.04);
}

.scrollable-list {
  max-height: 200px;
  overflow-y: auto;
}

/* Status Colors */
.status-health {
  color: #d34848;
}
.status-fatigue {
  color: #a6743c;
}
.status-composure {
  color: #4a8eab;
}
.status-excitement {
  color: #ab49a3;
  animation: pulse-status 2s infinite;
}

@keyframes pulse-status {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}

/* Status conditional list styles */
#char-status-conditional li {
  font-style: italic;
  color: #c98233;
}

/* Tooltip style */
[title]:hover::after {
  content: attr(title);
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  padding: 5px 8px;
  border-radius: 4px;
  position: absolute;
  white-space: pre-line;
  font-size: 0.9em;
  max-width: 300px;
  transform: translateY(-1.5em);
  z-index: 10001;
}
/* twine-user-stylesheet #3: "background.css" */
/* =============================
=       Background Layer       =
============================= */
#background-image {
    background-image: url('images/background_default.png');
    background-size: cover;
    background-position: center center;
    background-attachment: fixed;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0;
    pointer-events: none;
    transition: background-image 0.4s ease-in-out;
  }
  
/* twine-user-stylesheet #4: "convo-minigame-styles.css" */
/* ======================================================
   Conversation Minigame Overlay Styles (Updated Layout)
========================================================= */

#conversation-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  font-family: var(--main-font);
  color: #eee;
}

.overlay-hidden, .hidden {
  display: none !important;
}

.convo-window {
  display: flex;
  position: relative;
  flex-direction: row;
  flex-wrap: nowrap;
  width: 90vw;
  max-width: 1000px;
  height: 90vh; /* 🔥 Lock height to viewport, not auto */
  background: #1c1c1c;
  border: 2px solid #888;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  padding: 1em;
}
/* ======================================================
   HAWT™ Escalation Visual System (Backgrounds)
========================================================= */

/* Tier 1: Calm */
.heat-1 {
  background: linear-gradient(135deg, #1c1c1c, #222);
  box-shadow: 0 0 8px #000 inset;
}

/* Tier 2: Slight Warmth */
.heat-2 {
  background: linear-gradient(135deg, #1c1c1c, #3a1c1c);
  animation: simmerPulse 12s infinite;
  box-shadow: 0 0 12px #400000 inset;
}

/* Tier 3: Growing Heat */
.heat-3 {
  background: linear-gradient(135deg, #2c1c1c, #4a1c1c);
  animation: simmerPulse 8s infinite;
  box-shadow: 0 0 16px #600000 inset;
}

/* Tier 4: Bubbling Start */
.heat-4 {
  background: linear-gradient(135deg, #3c1c1c, #6a1c1c, #3c1c3c);
  animation: simmerPulse 5s infinite, brewBubble 20s infinite;
  box-shadow: 0 0 20px #800020 inset, 0 0 10px #800020;
}

/* Tier 5: Full Alchemical Brew */
.heat-5 {
  background: linear-gradient(270deg, #800020, #a00040, #800020);
  background-size: 400% 400%;
  animation: simmerPulse 3s infinite, brewBubble 15s infinite, backgroundRipple 30s infinite;
  box-shadow: 0 0 40px #ff0060, 0 0 20px #ff0060, 0 0 10px #ff0060;
}


#convo-body {
  display: flex;
  flex: 1;
  overflow: auto;
  height: 100%;
}

/* LEFT PANEL */
.convo-left-bar {
  width: 25%;
  min-width: 180px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  padding: 1em;
  border-right: 2px solid #444;
  overflow: hidden;
}

.npc-portrait img,
.player-portrait img {
  width: 100%;
  height: auto;
  max-height: 30vh;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid #999;
}

.convo-stats {
  margin-top: 1em;
  margin-bottom: 1em;
  text-align: center;
  font-size: 0.95em;
  border: 1px solid #666;
  border-radius: 6px;
  padding: 0.5em;
  width: 100%;
  background: #222;
}

.convo-stats div {
  margin: 0.25em 0;
}

/* RIGHT PANEL */
.convo-right {
  width: 75%;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 1em;
  overflow: hidden;
  min-height: 0; /* 🔥 allow shrink flex */
}

/* Header Area */
.convo-header-box {
  flex-shrink: 1; /* 🔥 allow header to shrink */
  flex-grow: 0;
  flex-basis: auto;
  border-bottom: 1px solid #666;
  padding-bottom: 0.5em;
  margin-bottom: 0.5em;
}

.npc-name {
  font-size: 1.5em;
  font-style: italic;
}

.npc-prompt {
  font-size: 1.3em;
  font-style: italic;
  color: #e44;
  margin-top: 0.5em;
}

/* Choices Area */
.convo-main-box {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 0; /* 🔥 allow flex children to shrink */
}

.convo-choices {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 0.5em;
  padding: 1em;
}

@keyframes slideFadeIn {
  from { opacity: 0; transform: translateY(15px); }
  to   { opacity: 1; transform: translateY(0); }
}

.convo-choices button {
  background: #222;
  border: 1px solid #999;
  border-radius: 4px;
  color: #aef;
  font-size: 1em;
  padding: 0.6em;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  opacity: 0;
}

.convo-choices button.animate-choice {
  animation: slideFadeIn 0.6s ease forwards;
}

.convo-choices button:hover {
  background: #333;
}

/* Action Buttons */
.convo-buttons {
  display: flex;
  justify-content: space-between;
  padding: 1em;
  border-top: 1px solid #666;
}

.convo-buttons button {
  padding: 0.8em 1.5em;
  font-weight: bold;
  border-radius: 6px;
  border: 1px solid #888;
  background: #202020;
  color: #eee;
  transition: background 0.2s ease;
  cursor: pointer;
}

.convo-buttons button:hover {
  background: #2a2a2a;
}

/* convo-results popup */
.convo-results {
  position: fixed; /* 🔥 fixed instead of absolute */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #222;
  border: 2px solid #555;
  border-radius: 12px;
  padding: 2em;
  text-align: center;
  z-index: 2000; /* higher layer to stay above convo-window */
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  width: 90%;
  max-width: 400px;
}


.convo-results.hidden {
  display: none;
}

/* ======================================================
   Turn Progress Bar Styles
========================================================= */

.turn-progress-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  margin-bottom: 0.8em;
  padding: 0.5em 0;
  flex-wrap: nowrap;
  width: 100%;
}

.turn-segment {
  width: 60px;
  height: 18px;
  border-radius: 999px;
  background: #555;
  transition: all 0.3s ease;
  position: relative;
}

.turn-segment::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-size: 1em;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

/* Status Colors */
.turn-segment.success { background: #3fbf65; }
.turn-segment.fail { background: #e44; }

.turn-segment.success::after { content: "✔"; color: #fff; opacity: 1; transform: translate(-50%, -50%) scale(1); }
.turn-segment.fail::after { content: "✖"; color: #fff; opacity: 1; transform: translate(-50%, -50%) scale(1); }
.turn-segment.pending { background: #555; }

.turn-number {
  font-size: 1.2em;
  font-weight: bold;
  color: #aaa;
  margin-left: 0.8em;
}

/* ======================================================
   HAWT™ Animations
========================================================= */

@keyframes simmerPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

@keyframes brewBubble {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes backgroundRipple {
  0%, 100% { background-size: 400% 400%; }
  50% { background-size: 450% 450%; }
}

/* ======================================================
   Particle Effects Styles
========================================================= */

.particle {
  position: absolute;
  font-size: 1.5em;
  pointer-events: none;
  user-select: none;
  z-index: 2000;
}

.trust-particle {
  color: #ffe066;
  text-shadow: 0 0 4px #fff8dc;
}

.affection-particle {
  color: #ff6699;
  text-shadow: 0 0 4px #ffd1dc;
}

.fail-particle {
  color: #aaa;
  opacity: 0.8;
}

/* Shake Animation for Failed Choice */
@keyframes buttonShake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-6px); }
  40%, 80% { transform: translateX(6px); }
}

.shake {
  animation: buttonShake 0.4s ease;
}

.grey-out {
  background: #333 !important;
  border-color: #666 !important;
  color: #aaa !important;
}

/* ======================================================
   Tutorial Button and Overlay (Updated)
========================================================= */

/* Floating Tutorial Button Wrapper */
#tutorial-button-wrapper {
  position: fixed; /* 🔥 not absolute */
  top: 16px;
  right: 16px;
  z-index: 1500;
}

/* Button Itself */
#tutorial-button {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #444;
  color: #fff;
  border: 1px solid #888;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
  z-index: 1501;
}

#tutorial-button:hover {
  background: #666;
  transform: scale(1.1);
}

/* Custom Hover Tooltip */
#tutorial-tooltip {
  position: absolute;
  top: -36px;
  right: 0;
  background: #222;
  border: 1px solid #888;
  padding: 0.3em 0.6em;
  border-radius: 8px;
  font-size: 0.85em;
  white-space: nowrap;
  color: #eee;
  box-shadow: 0 0 6px rgba(0,0,0,0.5);
  opacity: 0;
  pointer-events: none;
  transform: translateY(5px);
  transition: opacity 0.3s ease, transform 0.3s ease;
  z-index: 1501;
}

/* Tooltip Visible on Hover */
#tutorial-button-wrapper:hover #tutorial-tooltip {
  opacity: 1;
  transform: translateY(0);
}

/* Fullscreen Tutorial Overlay */
#tutorial-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}

/* When overlay is active (remove .hidden) */
#tutorial-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* Tutorial Content Box */
.tutorial-content {
  background: #222;
  border: 2px solid #555;
  border-radius: 12px;
  padding: 2em;
  max-width: 400px;
  width: 90%;
  text-align: center;
  color: #eee;
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  animation: fadeInScale 0.4s ease;
}

/* Fade-In Animation */
@keyframes fadeInScale {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.tutorial-content h2 {
  margin-bottom: 1em;
  font-size: 1.5em;
}

.tutorial-content ul {
  text-align: left;
  margin-bottom: 1.5em;
  padding-left: 1.2em;
}

.tutorial-content ul li {
  margin-bottom: 0.5em;
}

.tutorial-content button {
  background: #444;
  color: #fff;
  border: 1px solid #888;
  padding: 0.5em 1.2em;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s;
}

.tutorial-content button:hover {
  background: #666;
}

/* KEEP THIS AT THE END */
/* ======================================================
   Responsive Scaling (MOBILE FRIENDLY)
========================================================= */

@media (max-width: 768px) {
  .convo-window {
    flex-direction: column;
    height: auto;
    max-height: 95vh;
  }

  .convo-left-bar, .convo-right {
    width: 100%;
    flex-direction: column;
    border-right: none;
    border-bottom: 2px solid #444;
  }

  .convo-choices {
    padding: 0.5em;
  }
}
/* twine-user-stylesheet #5: "crown-and-caste-styles.css" */
/* ========================================
   ORIENTATION WARNING OVERLAY
======================================== */
#orientation-warning {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.95);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Garamond', serif;
  color: #f0e6d2;
}

.orientation-warning-content {
  text-align: center;
  padding: 2rem;
  max-width: 300px;
}

.orientation-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  transform: rotate(90deg);
  animation: phoneRotate 2s ease-in-out infinite;
}

.orientation-warning-content h3 {
  color: #ffe98a;
  font-size: 1.5rem;
  margin-bottom: 1rem;
  font-weight: bold;
}

.orientation-warning-content p {
  font-size: 1rem;
  line-height: 1.4;
  margin-bottom: 1.5rem;
  color: #f0e6d2;
}

.rotation-animation {
  font-size: 2rem;
  color: #d4b26e;
  animation: rotate 2s linear infinite;
}

@keyframes phoneRotate {
  0%, 100% { transform: rotate(90deg); }
  50% { transform: rotate(0deg); }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ========================================
   CROWN & CASTE MAIN FRAME + BACKGROUND
======================================== */
#overlay-body > #crown-caste-frame {
  position: relative;
  width: min(48rem, 90vw, 85vh);
  aspect-ratio: 1 / 1;
  margin: auto;
  background: radial-gradient(circle at center, #3b2a26 30%, #211513 100%);
  overflow: hidden;
  font-family: 'Garamond', serif;
  color: #f0e6d2;
  font-size: clamp(0.75rem, 1.8vw, 1rem);
  min-height: 400px;
  max-width: 700px;
}

#overlay-panel {
  background-color: #2b1a17 !important;
  background-image: none !important;
}

#crown-caste-frame::before,
#crown-caste-frame::after {
  content: "";
  position: absolute;
  top: -50%;
  left: 50%;
  width: 3px;
  height: 200%;
  background-color: #4d2d2d;
  transform-origin: center;
  z-index: 1;
}
#crown-caste-frame::before { transform: rotate(45deg); }
#crown-caste-frame::after  { transform: rotate(-45deg); }

/* ========================================
   CENTER CROWN DICE AREA
======================================== */
#center-circle {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: clamp(120px, 20vw, 220px);
  height: clamp(120px, 20vw, 220px);
  padding: clamp(6px, 1vw, 12px);
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  gap: clamp(2px, 0.5vw, 8px);
  z-index: 2;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

#center-circle:hover {
  background: rgba(0, 0, 0, 0.9);
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}

#center-circle.chip-mode {
  box-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
  background: rgba(40, 0, 0, 0.9);
}

#crown-pot {
  font-size: clamp(0.8em, 1.5vw, 1em);
  color: #d4b26e;
  margin-bottom: 4px;
}

.crown-die-group {
  display: flex;
  justify-content: center;
  gap: clamp(4px, 1vw, 8px);
  margin-top: 15%;
  margin-bottom: 37%;
}

.crown-die {
  width: clamp(35px, 6vw, 50px);
  height: clamp(35px, 6vw, 50px);
  background-color: #2e1e1c;
  border: 2px solid #c2a96b;
  border-radius: 6px;
  color: #f0e6d2;
  font-size: clamp(1em, 2vw, 1.5em);
  text-align: center;
  line-height: clamp(35px, 6vw, 50px);
  cursor: pointer;
  transition: all 0.2s ease;
}

.crown-die:hover {
  background-color: #3e2e2c;
  transform: scale(1.05);
}

.crown-die.locked {
  background-color: #1a1a1a;
  border-color: #666;
  color: #888;
  box-shadow: 0 0 8px rgba(255, 215, 0, 0.3) inset;
}

.crown-protected-indicator {
  font-size: clamp(0.7em, 1.2vw, 0.8em);
  color: #ffd700;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* ========================================
   PLAYER ZONE POSITIONS (RESPONSIVE)
======================================== */
.player-zone {
  position: absolute;
  z-index: 2;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.zone-north { 
  top: clamp(15px, 4vw, 25px); 
  left: 50%; 
  transform: translateX(-50%); 
}
.zone-south { 
  bottom: clamp(15px, 4vw, 25px); 
  left: 50%; 
  transform: translateX(-50%); 
}
.zone-west  { 
  top: 50%; 
  left: clamp(15px, 4vw, 25px); 
  transform: translateY(-50%); 
  align-items: flex-start; 
}
.zone-east  { 
  top: 50%; 
  right: clamp(15px, 4vw, 25px); 
  transform: translateY(-50%); 
  align-items: flex-end; 
}

.player-zone.active-player {
  filter: brightness(1.2);
}

.player-zone.current-turn {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ========================================
   PLAYER UI ELEMENTS (RESPONSIVE)
======================================== */
.player-name {
  font-weight: bold;
  font-size: clamp(0.8em, 1.5vw, 1em);
  color: #f8eacb;
  text-align: center;
  white-space: nowrap;
  margin-bottom: clamp(4px, 1vw, 8px);
}

.player-stats {
  display: flex;
  gap: clamp(8px, 1.5vw, 12px);
  margin-bottom: clamp(4px, 1vw, 8px);
}

.stat-display {
  display: flex;
  align-items: center;
  gap: clamp(2px, 0.5vw, 4px);
  font-size: clamp(0.7em, 1.2vw, 0.85em);
  color: #f8eacb;
  padding: clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px);
  background: rgba(0, 0, 0, 0.3);
  border-radius: 4px;
}

.stat-display i {
  color: #ffe98a;
  font-size: clamp(0.8em, 1.2vw, 1em);
}

.chip-display {
  cursor: pointer;
  transition: all 0.2s ease;
}

.chip-display:hover {
  background: rgba(0, 0, 0, 0.5);
  transform: scale(1.05);
}

.chip-display.active {
  background: rgba(255, 100, 100, 0.3);
  border: 1px solid #ff6464;
  box-shadow: 0 0 10px rgba(255, 100, 100, 0.5);
}

/* Zone-specific positioning */
.zone-south .player-stats {
  flex-direction: row;
  justify-content: center;
}

.zone-north .player-stats {
  flex-direction: row;
  justify-content: center;
}

.zone-west .player-stats,
.zone-east .player-stats {
  flex-direction: column;
  align-items: center;
}

/* ========================================
   DICE TRIANGLE POSITIONS (RESPONSIVE)
======================================== */
.dice-triangle {
  position: relative;
  width: clamp(60px, 10vw, 80px);
  height: clamp(60px, 10vw, 80px);
}

.zone-die {
  width: clamp(30px, 5vw, 40px);
  height: clamp(30px, 5vw, 40px);
  background-color: #382423;
  border: 1px solid #a9864c;
  border-radius: 4px;
  color: #f0e6d2;
  text-align: center;
  line-height: clamp(30px, 5vw, 40px);
  font-size: clamp(0.9em, 1.5vw, 1.2em);
  transition: all 0.2s ease;
  cursor: pointer;
  position: absolute;
}

.zone-die:hover {
  background-color: #483433;
  transform: scale(1.1);
  z-index: 10;
}

.zone-die.locked {
  background-color: #1e1413;
  color: #999;
  border-color: #664f2d;
  box-shadow: 0 0 6px 1px rgba(255, 215, 0, 0.2) inset;
}

.zone-die.rollable {
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

.zone-die.chip-target {
  box-shadow: 0 0 15px rgba(255, 100, 100, 0.7);
  border-color: #ff6464;
}

/* Triangle positioning (responsive) */
.zone-south .zone-die:nth-child(1) { top: -25%; left: 50%; transform: translateX(-50%); }
.zone-south .zone-die:nth-child(2) { bottom: 17%; left: -7%; }
.zone-south .zone-die:nth-child(3) { bottom: 17%; right: -7%; }

.zone-north .zone-die:nth-child(1) { bottom: -10%; left: 50%; transform: translateX(-50%); }
.zone-north .zone-die:nth-child(2) { top: 5%; left: -6%; }
.zone-north .zone-die:nth-child(3) { top: 5%; right: -6%; }

.zone-west .zone-die:nth-child(1) { right: -100%; top: -15%; transform: translateY(-50%); }
.zone-west .zone-die:nth-child(2) { left: 94%; bottom: 115%; }
.zone-west .zone-die:nth-child(3) { left: 94%; bottom: 57%; }

.zone-east .zone-die:nth-child(1) { left: -100%; top: -15%; transform: translateY(-50%); }
.zone-east .zone-die:nth-child(2) { right: 94%; top: -5%; }
.zone-east .zone-die:nth-child(3) { right: 94%; bottom: 115%; }

/* ========================================
   GAME STATUS & CONTROLS
======================================== */
#game-status {
  position: absolute;
  top: clamp(8px, 2vw, 12px);
  right: clamp(8px, 2vw, 12px);
  background: rgba(0, 0, 0, 0.7);
  padding: clamp(6px, 1vw, 8px) clamp(8px, 1.5vw, 12px);
  border-radius: 6px;
  font-size: clamp(0.7em, 1.2vw, 0.8em);
  z-index: 5;
}

#game-status div {
  margin-bottom: 2px;
}

#current-turn {
  color: #ffd700;
  font-weight: bold;
}

#betting-panel {
  position: absolute;
  bottom: clamp(8px, 2vw, 12px);
  left: 50%;
  transform: translateX(-50%);
  background: #3b2a26;
  border: 2px solid #997c54;
  padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 20px);
  border-radius: 8px;
  z-index: 5;
  text-align: center;
}

.betting-title {
  font-weight: bold;
  font-size: clamp(0.9em, 1.5vw, 1.1em);
  color: #ffe98a;
  margin-bottom: clamp(6px, 1vw, 8px);
}

.betting-controls {
  display: flex;
  gap: clamp(4px, 1vw, 8px);
  flex-wrap: wrap;
  justify-content: center;
}

.bet-btn {
  background: #705234;
  color: #f0e6d2;
  font-family: inherit;
  border: 1px solid #c2a96b;
  padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
  border-radius: 4px;
  cursor: pointer;
  font-size: clamp(0.8em, 1.2vw, 0.9em);
  transition: all 0.2s ease;
  min-width: clamp(35px, 6vw, 45px);
}

.bet-btn:hover {
  background: #8b6c45;
  transform: scale(1.05);
}

.bet-btn:disabled {
  opacity: 0.4;
  cursor: default;
  transform: none;
}

#action-feedback {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.9);
  color: #fff;
  padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 16px);
  border-radius: 6px;
  font-size: clamp(0.8em, 1.3vw, 1em);
  z-index: 100;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#action-feedback.show {
  opacity: 1;
}

.disabled-during-betting {
  pointer-events: none;
  opacity: 0.5;
  filter: grayscale(0.4);
  cursor: not-allowed;
}

#player-actions {
  margin-top: 6px;
  text-align: center;
}

.end-turn-button {
  background: #8b6c45;
  color: #f0e6d2;
  border: 2px solid #c2a96b;
  border-radius: 6px;
  padding: 6px 12px;
  font-family: inherit;
  font-size: 0.9em;
  cursor: pointer;
  transition: background 0.2s ease;
}
.end-turn-button:hover {
  background: #a07d56;
}

.crown-icon {
  font-size: 1em;
  color: #ffd700;
  vertical-align: middle;
  margin-right: 4px;
}


/* ========================================
   DESKTOP OPTIMIZATIONS
======================================== */
@media (min-width: 1024px) {
  #crown-caste-frame {
    width: min(45rem, 75vw);
    max-width: 650px;
  }
  
  #center-circle {
    width: clamp(160px, 22vw, 200px);
    height: clamp(160px, 22vw, 200px);
  }
  
  .zone-north { 
    top: clamp(25px, 3.5vw, 35px); 
  }
  .zone-south { 
    bottom: clamp(25px, 3.5vw, 35px); 
  }
  .zone-west  { 
    left: clamp(25px, 3.5vw, 35px); 
  }
  .zone-east  { 
    right: clamp(25px, 3.5vw, 35px); 
  }
  
  .dice-triangle {
    width: clamp(70px, 9vw, 85px);
    height: clamp(70px, 9vw, 85px);
  }
  
  .zone-die {
    width: clamp(35px, 4.5vw, 42px);
    height: clamp(35px, 4.5vw, 42px);
    line-height: clamp(35px, 4.5vw, 42px);
    font-size: clamp(1em, 1.4vw, 1.2em);
  }
  
  .player-name {
    font-size: clamp(0.9em, 1.3vw, 1em);
  }
  
  .stat-display {
    font-size: clamp(0.8em, 1.1vw, 0.9em);
    padding: clamp(4px, 0.7vw, 6px) clamp(6px, 0.9vw, 8px);
  }
  
  #game-status {
    font-size: clamp(0.8em, 1.1vw, 0.9em);
    padding: clamp(7px, 0.9vw, 10px) clamp(10px, 1.2vw, 12px);
  }
  
  #betting-panel {
    padding: clamp(12px, 1.4vw, 16px) clamp(18px, 2vw, 24px);
  }
  
  .betting-title {
    font-size: clamp(1.1em, 1.3vw, 1.2em);
  }
  
  .bet-btn {
    font-size: clamp(0.9em, 1.1vw, 1em);
    padding: clamp(6px, 0.9vw, 8px) clamp(12px, 1.4vw, 16px);
    min-width: clamp(45px, 5.5vw, 55px);
  }
}

/* ========================================
   RESPONSIVE BREAKPOINTS
======================================== */
@media (max-width: 768px) {
  #crown-caste-frame {
    width: 95vw;
    height: 95vw;
    min-height: 350px;
  }
  
  #center-circle {
    width: clamp(100px, 18vw, 160px);
    height: clamp(100px, 18vw, 160px);
  }
  
  .zone-north { 
    top: clamp(20px, 5vw, 35px); 
  }
  .zone-south { 
    bottom: clamp(20px, 5vw, 35px); 
  }
  .zone-west  { 
    left: clamp(20px, 5vw, 35px); 
  }
  .zone-east  { 
    right: clamp(20px, 5vw, 35px); 
  }
  
  .player-stats {
    flex-direction: column !important;
    gap: 3px !important;
  }
  
  .stat-display {
    font-size: clamp(0.6em, 1vw, 0.75em);
    padding: 2px 4px;
  }
  
  .player-name {
    font-size: clamp(0.7em, 1.2vw, 0.9em);
    margin-bottom: 3px;
  }
  
  .dice-triangle {
    width: clamp(50px, 8vw, 70px);
    height: clamp(50px, 8vw, 70px);
  }
  
  .zone-die {
    width: clamp(25px, 4vw, 35px);
    height: clamp(25px, 4vw, 35px);
    line-height: clamp(25px, 4vw, 35px);
    font-size: clamp(0.8em, 1.2vw, 1em);
  }
  
  #game-status {
    font-size: clamp(0.6em, 1vw, 0.7em);
    padding: 4px 6px;
    top: clamp(5px, 1vw, 10px);
    right: clamp(5px, 1vw, 10px);
  }
  
  #betting-panel {
    bottom: clamp(5px, 1vw, 10px);
    padding: clamp(6px, 1vw, 10px) clamp(8px, 1.5vw, 15px);
  }
  
  .betting-title {
    font-size: clamp(0.8em, 1.2vw, 1em);
    margin-bottom: 4px;
  }
  
  .bet-btn {
    font-size: clamp(0.7em, 1vw, 0.8em);
    padding: 3px 6px;
    min-width: clamp(30px, 5vw, 40px);
  }
}

@media (max-width: 480px) {
  #crown-caste-frame {
    width: 98vw;
    height: 98vw;
    min-height: 320px;
  }
  
  #center-circle {
    width: clamp(80px, 16vw, 120px);
    height: clamp(80px, 16vw, 120px);
  }
  
  .crown-die {
    width: clamp(25px, 4.5vw, 35px);
    height: clamp(25px, 4.5vw, 35px);
    line-height: clamp(25px, 4.5vw, 35px);
    font-size: clamp(0.8em, 1.5vw, 1.1em);
  }
  
  .crown-die-group {
    gap: 2px;
    margin-top: 10%;
    margin-bottom: 30%;
  }
  
  .zone-north { 
    top: clamp(25px, 6vw, 40px); 
  }
  .zone-south { 
    bottom: clamp(25px, 6vw, 40px); 
  }
  .zone-west  { 
    left: clamp(25px, 6vw, 40px); 
  }
  .zone-east  { 
    right: clamp(25px, 6vw, 40px); 
  }
  
  .dice-triangle {
    width: clamp(40px, 7vw, 60px);
    height: clamp(40px, 7vw, 60px);
  }
  
  .zone-die {
    width: clamp(20px, 3.5vw, 30px);
    height: clamp(20px, 3.5vw, 30px);
    line-height: clamp(20px, 3.5vw, 30px);
    font-size: clamp(0.7em, 1.1vw, 0.9em);
  }
  
  .player-name {
    font-size: clamp(0.6em, 1.1vw, 0.8em);
    margin-bottom: 2px;
  }
  
  .stat-display {
    font-size: clamp(0.55em, 0.9vw, 0.7em);
    padding: 1px 3px;
    gap: 1px;
  }
  
  .betting-controls {
    flex-direction: column;
    gap: 3px;
  }
  
  .bet-btn {
    font-size: clamp(0.65em, 0.9vw, 0.75em);
    padding: 2px 5px;
  }
  
  #game-status {
    font-size: clamp(0.55em, 0.9vw, 0.65em);
    padding: 3px 5px;
  }
  
  #betting-panel {
    padding: 5px 8px;
  }
  
  .betting-title {
    font-size: clamp(0.7em, 1.1vw, 0.9em);
    margin-bottom: 3px;
  }
}

/* ========================================
   INTERACTION STATES
======================================== */
.clickable-die.can-roll {
  animation: pulse-green 1.5s infinite;
}

@keyframes pulse-green {
  0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.3); }
  50% { box-shadow: 0 0 15px rgba(0, 255, 0, 0.7); }
}

.clickable-die.can-lock {
  animation: pulse-blue 1.5s infinite;
}

@keyframes pulse-blue {
  0%, 100% { box-shadow: 0 0 5px rgba(0, 100, 255, 0.3); }
  50% { box-shadow: 0 0 15px rgba(0, 100, 255, 0.7); }
}

.game-disabled {
  pointer-events: none;
  opacity: 0.6;
}

.game-disabled .clickable-die,
.game-disabled .clickable-chips,
.game-disabled .clickable-crown {
  cursor: default;
}

/* ========================================
   GAME LAUNCH BUTTON STYLES
======================================== */
.start-minigame-button-wrapper {
  margin: clamp(8px, 2vw, 16px) 0;
  padding: clamp(12px, 2vw, 20px);
  background: linear-gradient(135deg, #3b2a26 0%, #2b1a17 100%);
  border: 2px solid #997c54;
  border-radius: 8px;
  font-family: 'Garamond', serif;
}

.crown-caste-game-info {
  margin-bottom: clamp(8px, 1.5vw, 12px);
  text-align: center;
}

.crown-caste-game-info h4 {
  color: #ffe98a;
  font-size: clamp(1.1em, 2vw, 1.3em);
  margin: 0 0 clamp(6px, 1vw, 8px) 0;
  font-weight: bold;
}

.game-details {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: clamp(8px, 1.5vw, 12px);
  margin-bottom: clamp(6px, 1vw, 8px);
}

.game-details span {
  color: #f0e6d2;
  font-size: clamp(0.8em, 1.3vw, 0.9em);
  display: flex;
  align-items: center;
  gap: 4px;
}

.stakes-level {
  font-weight: bold;
  color: #d4b26e;
}

.buy-in {
  color: #ffe98a;
}

.players {
  color: #c2a96b;
}

.house-rules-display {
  font-size: clamp(0.7em, 1.1vw, 0.8em);
  color: #a9864c;
  font-style: italic;
  margin-top: clamp(4px, 0.8vw, 6px);
  padding: clamp(4px, 0.8vw, 6px);
  background: rgba(0, 0, 0, 0.3);
  border-radius: 4px;
}

.start-minigame-button {
  width: 100%;
  background: linear-gradient(135deg, #705234 0%, #5a3f28 100%);
  color: #f0e6d2;
  font-family: inherit;
  border: 2px solid #c2a96b;
  padding: clamp(8px, 1.5vw, 12px) clamp(16px, 3vw, 24px);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.9em, 1.5vw, 1.1em);
  font-weight: bold;
  transition: all 0.3s ease;
}

.start-minigame-button:hover:not(:disabled) {
  background: linear-gradient(135deg, #8b6c45 0%, #6d4f35 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.start-minigame-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #444;
  border-color: #666;
  color: #999;
}

.minigame-warning {
  color: #ff6b6b;
  font-size: clamp(0.7em, 1.1vw, 0.8em);
  text-align: center;
  margin: clamp(6px, 1vw, 8px) 0 0 0;
  font-style: italic;
}

@media (max-width: 768px) {
  .game-details {
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  
  .start-minigame-button-wrapper {
    margin: 12px 0;
    padding: 16px;
  }
}

/* ========================================
   CUSTOM TOOLTIP STYLE (data-tooltip)
   (Scoped to prevent layout collisions)
======================================== */
.tooltip-parent {
  position: relative;
}

.tooltip-parent[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  background: rgba(0, 0, 0, 0.8);
  color: #f0e6d2;
  font-size: 0.75em;
  padding: 4px 6px;
  border-radius: 4px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 10;
  margin-bottom: 6px;
}

.tooltip-parent[data-tooltip]:hover::after {
  opacity: 1;
}

/* ========================================
   DICE ROLLING ANIMATION
======================================== */
.rolling {
  animation: dice-roll 0.1s infinite;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
  background-size: 400% 400%;
  animation: dice-roll 0.1s infinite, rainbow-bg 0.5s infinite;
  color: #fff !important;
  font-weight: bold;
  transform: scale(1.1);
  box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
}

@keyframes dice-roll {
  0%, 100% { transform: scale(1.1) rotate(0deg); }
  25% { transform: scale(1.15) rotate(2deg); }
  50% { transform: scale(1.1) rotate(0deg); }
  75% { transform: scale(1.15) rotate(-2deg); }
}

@keyframes rainbow-bg {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Crown dice rolling animation */
.crown-die.rolling {
  animation: crown-dice-roll 0.1s infinite;
  background: linear-gradient(45deg, #ffd700, #ffed4e, #f39c12, #e67e22);
  background-size: 400% 400%;
  animation: crown-dice-roll 0.1s infinite, gold-bg 0.5s infinite;
  color: #2c3e50 !important;
  font-weight: bold;
  transform: scale(1.1);
  box-shadow: 0 0 25px rgba(255, 215, 0, 0.9);
}

@keyframes crown-dice-roll {
  0%, 100% { transform: scale(1.1) rotate(0deg); }
  25% { transform: scale(1.15) rotate(3deg); }
  50% { transform: scale(1.1) rotate(0deg); }
  75% { transform: scale(1.15) rotate(-3deg); }
}

@keyframes gold-bg {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ========================================
   NEXT GAME PANEL STYLES
======================================== */
#next-game-panel {
  position: absolute;
  bottom: clamp(8px, 2vw, 12px);
  left: 50%;
  transform: translateX(-50%);
  background: #3b2a26;
  border: 2px solid #997c54;
  padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 20px);
  border-radius: 8px;
  z-index: 5;
  text-align: center;
}

.next-game-title {
  font-weight: bold;
  font-size: clamp(0.9em, 1.5vw, 1.1em);
  color: #ffe98a;
  margin-bottom: clamp(6px, 1vw, 8px);
}

.next-game-controls {
  display: flex;
  justify-content: center;
}

.next-game-button {
  background: linear-gradient(135deg, #d4af37, #b8941f);
  color: white;
  font-family: inherit;
  border: 2px solid #ffd700;
  padding: clamp(6px, 1vw, 8px) clamp(12px, 2vw, 16px);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.8em, 1.2vw, 0.9em);
  font-weight: bold;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.next-game-button:hover {
  background: linear-gradient(135deg, #e6c547, #c9a429);
  transform: translateY(-1px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}

.next-game-button:active {
  transform: translateY(0);
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
/* twine-user-stylesheet #6: "dialoguestyles.css" */
/* =============================
=      Conversation Styles     =
============================= */

#convoBox {
  padding: 1em;
  margin: 0;
  background: rgba(255, 255, 255, 0.01);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 0.5em;
  color: #eee;
  font-size: 1rem;
  flex-grow: 1;
  overflow-y: auto;
  scroll-padding-bottom: 2em;
  overflow-x: hidden;
  max-width: 80%;
}

#convoChoices {
  padding-left: 1em;
  margin-top: 1em;
}

#convoChoices p {
  margin: 0.5em 0;
}

#convoChoices a.link-internal {
  color: #a0e0ff;
  text-decoration: none;
  cursor: pointer;
  font-weight: bold;
}

#convoChoices a.link-internal:hover {
  text-decoration: underline;
}

/* =============================
=      Conversation Layout     =
============================= */

/* Let layout container fill full height of visible space */
#convoLayoutContainer {
  display: flex;
  flex-direction: row;
  gap: 5px;
  width: 80vw;
  height: 85vh; /* Fills full screen height */
  box-sizing: border-box;
  overflow: hidden;
}

#convoChoicesPanel {
  flex: 0.75;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  height: 100%;
  overflow: hidden;
  gap: 10px;
}

#convoBoxPanel {
  flex: 2;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden; /* 👈 Add this! */
  padding-right: 10px;
  gap: 10px;
}

.dialogue-choice {
  color: #9feaff;
  text-shadow: 1px 1px 2px #000;
  padding: 4px 8px;
  margin: 6px 0;
  transition: color 0.2s ease;
  cursor: pointer;
}

.dialogue-choice:hover {
  color: #ffffff;
  text-shadow: 1px 1px 3px #00c8ff;
}

#text-backdrop.in-dialogue #convoLayoutContainer {
  display: flex;
}

#text-backdrop.in-dialogue #convoChoicesPanel {
  width: 30%;
}

#text-backdrop.in-dialogue #convoBoxPanel {
  width: 70%;
}

.dialogue-choice.locked {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

/* =============================
=     Minigame Button Styles   =
============================= */

.start-minigame-button-wrapper {
  text-align: center;
  margin-top: 1.5em;
}

.start-minigame-button {
  background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
  color: #eee;
  font-size: 1.1em;
  font-weight: bold;
  padding: 0.75em 2em;
  border: 2px solid #777;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
  transition: all 0.25s ease;
  cursor: pointer;
  text-shadow: 0 1px 1px rgba(0,0,0,0.5);
  letter-spacing: 0.5px;
}

.start-minigame-button:hover {
  background: linear-gradient(145deg, #4a1f1f, #2e0e0e);
  border-color: #a33;
  color: #ffdcdc;
  box-shadow: 0 0 15px rgba(255, 64, 64, 0.4);
  transform: scale(1.05);
}

.start-minigame-button:active {
  transform: scale(0.98);
  box-shadow: 0 0 5px rgba(255, 64, 64, 0.5);
}

/* =============================
=       Conversation States    =
============================= */

.faded-entry {
  opacity: 0.6;
  transition: opacity 0.3s ease;
}

.active-entry {
  opacity: 1;
}

.dialogue-divider {
  width: 60%;
  height: 1px;
  background: linear-gradient(to right, transparent, #888, transparent);
  margin: 1em auto;
  opacity: 0.4;
}

/* =============================
=      Mobile Device Tweaks    =
============================= */

body.mobile-device #convoBoxPanel {
  padding-top: 0.5em;
  padding-bottom: 0.75em;
  padding-right: 0.5em;
}

body.mobile-device #convoChoicesPanel {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
}

body.mobile-device #convoBox {
  font-size: 0.95rem;
  padding: 0.75em 1em;
  margin: 0;
  min-height: 6em;
}

body.mobile-device .dialogue-choice {
  font-size: 1rem;
  padding: 6px 12px;
}

body.mobile-device #convoChoices {
  padding-left: 0.5em;
  margin-top: 0.5em;
}

body.portrait #convoLayoutContainer {
  gap: 14px;
}

body.landscape #convoLayoutContainer {
  gap: 20px;
  height:100vh
}

body.reduced-motion * {
  transition: none !important;
  animation: none !important;
}
/* twine-user-stylesheet #7: "inventory.css" */
/* =============================
=         Inventory UI         =
============================= */

/* Fullscreen dark overlay */
.inventory-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(26, 26, 26, 0.95);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Inner window panel */
.inventory-window {
    width: 98vw;
    height: 92vh;
    background-color: #1a1a1a;
    border: 1px solid #a18348;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* Top-level flex layout */
.inventory-flex {
    flex: 1;
    display: flex;
    flex-direction: row;
    gap: 15px;
    overflow: hidden;
}

/* Left / Right panel widths */
.inventory-left-panel {
    flex: 3 1 0%;
    min-width: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.inventory-content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: row;
    gap: 12px;
    overflow-y: auto;
}

/* Scrollbar styling (Chrome, Edge, Safari) */
.inventory-content-wrapper::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
.inventory-content-wrapper::-webkit-scrollbar-thumb {
    background-color: #555;
    border-radius: 4px;
}
.inventory-content-wrapper::-webkit-scrollbar-track {
    background-color: transparent;
}
/* Firefox scrollbar */
.inventory-content-wrapper {
    scrollbar-width: thin;
    scrollbar-color: #555 transparent;
}

.inventory-list-container {
    flex: 1.1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.inventory-right-panel {
    flex: 1 1 100px;
    max-width: 300px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
}

/* Divider */
.inventory-divider {
    width: 2px;
    background-color: #555;
}

/* Close button */
.inventory-close-btn {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 1.4em;
    background: none;
    border: none;
    color: #eee;
    cursor: pointer;
}
.inventory-close-btn:hover {
    color: #f88;
}

/* Tabs */
.inventory-tabs {
    display: flex;
    gap: 6px;
}
.inventory-tabs button {
    background-color: #333;
    color: #eee;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 8px;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.inventory-tabs button:hover {
    background-color: #555;
}
.inventory-tabs .lucide {
    width: 20px;
    height: 20px;
}

/* Inventory table */
.inventory-list {
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 5px;
    overflow-y: auto;
    flex: 1;
}
#inventory-table {
    width: 100%;
    border-collapse: collapse;
}
#inventory-table th,
#inventory-table td {
    text-align: center;
    padding: 6px;
    font-size: 0.85em;
    border-bottom: 1px solid #444;
    color: #ddd;
}

/* Selected item info */
.inventory-details {
    flex: 1;
    min-width: 250px;
    max-height: 100%;
    background-color: #1f1f1f;
    border: 1px solid #555;
    border-radius: 5px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#inventory-item-image {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    background-color: #333;
    border: 1px solid #666;
}
.inventory-description,
.inventory-flavor,
.inventory-info {
    font-size: 0.85em;
    color: #ccc;
}

/* Button grid */
.inventory-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: space-between;
}
.inventory-buttons button {
    flex: 1 0 calc(33% - 10px);
    font-size: 0.8em;
    padding: 6px;
    border: none;
    border-radius: 5px;
    background-color: #444;
    color: #fff;
    cursor: pointer;
}
.inventory-buttons button:hover {
    background-color: #666;
}

/* =============================
=       Paperdoll Layout       =
============================= */

.paperdoll-layout {
    display: flex;
    flex-direction: row;
    gap: 16px;
    align-items: flex-start;
    justify-content: flex-start;
    flex-wrap: nowrap;
  }
  
  /* Main silhouette */
  .paperdoll {
    position: relative;
    width: 200px;
    min-width: 200px;
    height: 400px;
    background-image: url('images/paperdoll_generic_silhouette.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border: 1px solid #555;
    border-radius: 5px;
    flex-shrink: 0;
  }
  
  /* Slot base */
  .paperdoll-slot {
    width: 48px;
    height: 48px;
    box-sizing: border-box;
    padding: 0;
    margin: 0;
    line-height: 1;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid #888;
    color: #fff;
    font-size: 0.7em;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 5px;
    pointer-events: none;
  }
  
  /* Position silhouette slots absolutely */
  .paperdoll .paperdoll-slot {
    position: absolute;
  }
  
  /* Paperdoll slot positions */
  .paperdoll-slot[data-slot="head"]     { top: 8%;   left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="chest"]    { top: 25%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="gloveL"]   { top: 28%;  left: 8%; }
  .paperdoll-slot[data-slot="gloveR"]   { top: 28%;  right: 8%; }
  .paperdoll-slot[data-slot="main"]     { top: 45%;  left: 4%; }
  .paperdoll-slot[data-slot="sec"]      { top: 45%;  right: 4%; }
  .paperdoll-slot[data-slot="pants"]    { top: 60%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="feet"]     { top: 78%;  left: 50%; transform: translateX(-50%); }
  
  /* Right-hand column */
  .paperdoll-right-column {
    display: flex;
    flex-direction: column;
    gap: 10px;
    justify-content: flex-start;
    flex-shrink: 0;
  }
  
  .paperdoll-right-column .paperdoll-slot {
    position: static;
    width: 48px;
    height: 48px;
    font-size: 0.75em;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid #888;
    color: #fff;
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  /* =============================
  =    Condensed Paperdoll Mode  =
  ============================= */
  
  .paperdoll-condensed {
    display: none;
  }
  
  /* Switch to condensed view earlier */
@media (max-width: 950px) {
    .paperdoll-layout {
      display: none;
    }
  
    .paperdoll-condensed {
        display: block;
        max-height: none;
        overflow-y: visible;
        padding: 1em;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0.5em;
        font-size: 0.9em;
        line-height: 1.5em;
        width: 100%;
    }
  
    .paperdoll-condensed div {
      margin-bottom: 0.5em;
    }
  }
  
/* twine-user-stylesheet #8: "layout.css" */
/* =============================
=     Custom Sidebar Layout    =
============================= */
#custom-sidebar {
	display: block;
	position: fixed;
	top: 0;
	left: 0;
	width: 260px;
	height: 100%;
	padding: 10px;
	background: url('https://www.transparenttextures.com/patterns/dark-leather.png'), #1a1a1a;
	background-blend-mode: overlay;
	background-size: 200px 200px;
	overflow-y: auto;
	border-right: 2px solid #3a3a3a;
	box-shadow: 2px 0 5px rgba(0,0,0,0.4);
	z-index: 1000;
	transition: transform 0.3s ease;
}

#passages {
	margin-left: 280px;
	padding: 20px;
	max-width: 900px;
}

/* =========================
=   Sidebar Toggle Button  =
========================= */
#sidebar-toggle {
	position: fixed;
	top: 10px;
	left: 260px;
	background: #222;
	color: white;
	border: 1px solid #888;
	padding: 4px 6px;
	cursor: pointer;
	z-index: 1100;
	font-family: 'Cinzel', serif;
	font-size: 1.2em;
	border-radius: 0 4px 4px 0;
	transition: left 0.3s ease;
}

#custom-sidebar.collapsed + #sidebar-toggle {
	left: 40px;
}

#sidebar-toggle svg {
	width: 20px;
	height: 20px;
	stroke: white;
}
/* twine-user-stylesheet #9: "maintext.css" */
/* =============================
=     Main Text Presentation   =
============================= */

/* === Responsive Font + Padding Adjustments === */
@media screen and (max-width: 800px) {
  #text-backdrop {
    padding: 1.5rem;
    font-size: 1rem;
  }
}
@media screen and (max-width: 600px) {
  #text-backdrop {
    padding: 1rem;
    font-size: 0.95rem;
  }
}
@media screen and (max-width: 500px) {
  #text-backdrop {
    padding: 0.75rem;
    font-size: 0.9rem;
  }
}

/* === Base HTML & Body === */
html, body {
  height: 100%;
  overflow: hidden;
  margin: 0;
  padding: 0;
}

/* === Main Text Container === */
#text-container {
  position: fixed;
  top: 0;
  left: 0;
  width: calc(100vw - 260px);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1;
  pointer-events: none;
  padding: 1rem;
  box-sizing: border-box;
  transition: margin-left 0.3s ease;
}

/* === Sidebar Collapsed/Expanded Adjustments === */
body.sidebar-collapsed #text-container {
  margin-left: 60px;
  width: calc(100vw - 60px);
}

body:not(.sidebar-collapsed) #text-container {
  margin-left: 260px;
  width: calc(100vw - 260px);
}

/* === Text Backdrop Main Style === */
#text-backdrop {
  background-color: rgba(240, 240, 240, 0.05);
  padding: 1.1rem;
  width: 100%;
  max-width: 850px;
  min-width: 300px;
  max-height: 90vh;
  overflow-y: auto;
  overflow-x: hidden;
  border-radius: 1.5rem;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
  font-family: 'Georgia', serif;
  font-size: clamp(0.95rem, 1.2vw + 0.5rem, 1.2rem);
  line-height: 1.6;
  color: #f0f0f0;
  pointer-events: auto;
  box-sizing: border-box;
  transition: all 0.3s ease;
}

/* === Dialogue Mode (Expanding Slightly) === */
#text-backdrop.in-dialogue {
  max-width: 1200px;
  min-height: 500px;
  padding-bottom: 1%;
  padding-top: 5%;
}

/* === Text Backdrop Scrollbar Styling === */
#text-backdrop::-webkit-scrollbar {
  width: 10px;
}
#text-backdrop::-webkit-scrollbar-track {
  background: #111;
}
#text-backdrop::-webkit-scrollbar-thumb {
  background: #666;
  border-radius: 5px;
}
#text-backdrop::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* === Hidden SugarCube Passages === */
#passages {
  position: absolute;
  top: -9999px;
  left: -9999px;
  width: 1px;
  height: 1px;
  overflow: hidden;
  opacity: 0;
  pointer-events: none;
}

/* === Current Active Passage === */
.passage-in {
  opacity: 1 !important;
}

/* === Dynamic Content Container === */
#dynamic-content {
  width: 100%;
}
.overlay-close-btn {
	position: absolute;
	top: 3%;
	right: 5%;
	background: none;
	border: 2px solid #ccc;
	color: white;
	font-size: 1.2rem;
	padding: 0.2rem 0.6rem;
	cursor: pointer;
	z-index: 10;
}
/* twine-user-stylesheet #10: "overlay.css" */
/* =============================
=         Overlay Base         =
============================= */
#overlay-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    background: url('images/parchment-bg.jpg') no-repeat center center;
    background-size: cover;
    background-color: #f4e8c1;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    border: 2px solid #8b6e47;
    max-height: 80vh;
    overflow-y: auto;
    font-family: 'Cinzel', serif;
}

#overlay-content {
    background: #111;
    color: white;
    padding: 20px;
    width: 80%;
    max-width: 800px;
    max-height: 90%;
    overflow-y: auto;
    border: 2px solid #666;
    border-radius: 8px;
    position: relative;
}

#overlay-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.1);
    color: white;
    border: none;
    font-size: 1.2em;
    cursor: pointer;
    padding: 4px 8px;
}

.overlay-hidden {
    display: none !important;
}
/* Overlay Base - End */
/* twine-user-stylesheet #11: "paperdoll.css" */
/* =============================
=       Paperdoll Layout       =
============================= */
.paperdoll {
    position: relative;
    width: auto;
    height: 90%;
    aspect-ratio: 1 / 2;
    background-image: url('images/paperdoll_generic_silhouette.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border: 1px solid #555;
    border-radius: 5px;
  }
  
  .paperdoll-slot {
    position: absolute;
    width: 48px;
    height: 48px;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid #888;
    color: #fff;
    font-size: 0.7em;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 5px;
    pointer-events: none;
  }
  
  .paperdoll-slot[data-slot="head"]     { top: 8%;   left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="face"]     { top: 8%;   right: -65px; }
  .paperdoll-slot[data-slot="necklace"] { top: 18%;  right: -65px; }
  .paperdoll-slot[data-slot="ring1"]    { top: 30%;  right: -65px; }
  .paperdoll-slot[data-slot="ring2"]    { top: 40%;  right: -65px; }
  .paperdoll-slot[data-slot="ring3"]    { top: 50%;  right: -65px; }
  .paperdoll-slot[data-slot="chest"]    { top: 25%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="gloveL"]   { top: 28%;  left: 8%; }
  .paperdoll-slot[data-slot="gloveR"]   { top: 28%;  right: 8%; }
  .paperdoll-slot[data-slot="main"]     { top: 45%;  left: 4%; }
  .paperdoll-slot[data-slot="sec"]      { top: 45%;  right: 4%; }
  .paperdoll-slot[data-slot="pants"]    { top: 60%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="feet"]     { top: 78%;  left: 50%; transform: translateX(-50%); }
  
/* twine-user-stylesheet #12: "sexscene-styles.css" */
/* ==============================
   🌶️ Sex Scene Layout
============================== */
#text-backdrop.in-sexscene #sexSceneLayoutContainer {
	display: flex;
	flex-direction: column;
	gap: 20px;
	width: 100%;
	height: 100%;
	box-sizing: border-box;
}

#sexSceneFeedbackPanel {
	flex: 0 0 auto;
	max-height: 25vh;
	overflow-y: auto;
	padding: 1em;
	border: 1px solid rgba(255, 255, 255, 0.1);
	border-radius: 8px;
	background: rgba(255, 255, 255, 0.02);
	color: #eee;
	font-size: 1rem;
}

#sexSceneActionsPanel {
	flex: 1 1 auto;
	overflow-y: auto;
	padding: 1em;
	border-radius: 6px;
	background: rgba(0, 0, 0, 0.2);
	color: #ccc;
}

.sexscene-group {
	margin-bottom: 0.5rem; /* reduce group spacing */
	padding-bottom: 0.5rem;
}

.sexscene-group h3 {
	font-size: 1rem; /* was probably 1.25rem+ before */
	margin-bottom: 0.15rem;
	margin-top: 0.5rem;
	line-height: 1.2;
	letter-spacing: 0.5px;
}


#sexSceneActionsBox button {
	margin: 0px;
	padding: 0.2em 0.5em;
	font-size: 0.95rem;
	border: 1px solid #777;
	border-radius: 10px;
	background: #2e2e2e;
	color: #fff;
	cursor: pointer;
	transition: all 0.2s ease;
}

#sexSceneActionsBox button:hover {
	background-color: #444;
}

button.active-sexact {
	color: white;
}

button.active-sexact.pending {
  box-shadow: 0 0 6px #fff;
}

/* 🌈 Smooth animated conic ring for ongoing sex acts */
@property --gradient-angle {
  syntax: "<angle>";
  initial-value: 0deg;
  inherits: false;
}

button.active-sexact.ongoing {
  position: relative;
  color: white;
  background: #2e2e2e; /* Static inner fill */
  border: 2px solid transparent;
  border-radius: 10px;
  z-index: 0;
  overflow: hidden;
}

button.active-sexact.ongoing::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  padding: 2px; /* Border thickness */
  background: conic-gradient(
    from var(--gradient-angle),
    #222222,
    #585858,
    #1b1b1b,
    #dbdbdb,
    #aaaaaa
  );
  animation: rotation 6s linear infinite;
  mask: 
    linear-gradient(#fff 0 0) content-box, 
    linear-gradient(#fff 0 0); 
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  z-index: -1;
}

button.active-sexact.ongoing::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  padding: 2px;
  background: conic-gradient(
    from var(--gradient-angle),
    #222222,
    #585858,
    #1b1b1b,
    #dbdbdb,
    #aaaaaa,
  );
  animation: rotation 6s linear infinite;

  /* Glow settings */
  filter: blur(12px);
  opacity: 0.45;
  z-index: -2;

  /* Ensure it shows outside the button's shape */
  mask: none;
  -webkit-mask: none;
  pointer-events: none;
}

@keyframes rotation {
  0% {
    --gradient-angle: 0deg;
  }
  100% {
    --gradient-angle: 360deg;
  }
}

#sexSceneFooterButtons {
	display: flex;
	justify-content: space-between;
	gap: 16em;
	margin-top: 2em;
}

#sexSceneContinueButton,
#sexSceneEndButton {
	flex: 1 1 auto;
}

/* twine-user-stylesheet #13: "shop-styles.css" */
/* =============================
   SHOP OVERLAY LAYOUT
============================= */
.shop-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(26, 26, 26, 0.95);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .shop-window {
    width: 98vw;
    height: 92vh;
    background-color: #1a1a1a;
    border: 1px solid #a18348;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .inventory-dual-panel {
    display: flex;
    gap: 15px;
    flex: 1;
    overflow: hidden;
  }
  
  .inventory-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #1a1a1a;
    border: 1px solid #a18348;
    border-radius: 10px;
    padding: 10px;
    gap: 10px;
  }
  
  .inventory-header {
    font-size: 1.4em;
    font-weight: bold;
    color: #ddd;
    text-align: center;
  }
  
  .inventory-tabs {
    display: flex;
    gap: 6px;
  }
  
  .inventory-tabs button {
    background-color: #333;
    color: #eee;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 8px;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  
  .inventory-tabs button:hover {
    background-color: #555;
  }
  
  .inventory-list {
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 5px;
    overflow-y: auto;
    flex: 1;
  }
  
  .inventory-list table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .inventory-list th,
  .inventory-list td {
    text-align: center;
    padding: 6px;
    font-size: 0.85em;
    border-bottom: 1px solid #444;
    color: #ddd;
  }
  
  .inventory-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1em;
    color: #eee;
  }
  
  .sell-button,
  .buy-button {
    padding: 6px 12px;
    font-size: 0.9em;
    background-color: #444;
    color: white;
    border: 1px solid #888;
    border-radius: 5px;
    cursor: pointer;
  }
  
  .sell-button:hover,
  .buy-button:hover {
    background-color: #666;
  }
  
  .gold-change {
    margin-left: 5px;
    font-weight: bold;
  }
  
  .gold-change.positive {
    color: #0f0;
  }
  
  .gold-change.negative {
    color: #f55;
  }
  
  /* =============================
     CONFIRM BUTTON STYLING
  ============================= */
  .shop-confirm-row {
    display: flex;
    justify-content: flex-end;
    padding-top: 10px;
  }
  
  .confirm-button {
    padding: 10px 18px;
    font-size: 1em;
    font-weight: bold;
    background-color: #4a773c;
    color: white;
    border: 1px solid #6fa45b;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }
  
  .confirm-button:hover {
    background-color: #5d8f4b;
  }
  
/* twine-user-stylesheet #14: "sidebar.css" */
/* =============================
=        Sidebar Main         
============================= */
#custom-sidebar {
	background: #111;
	color: white;
	display: flex;
	flex-direction: column;
	position: relative;
	width: 300px;
	transition: width 0.4s ease;
	overflow: auto;
	border-right: 2px solid #333;
	padding-bottom: 1%;
}

/* =============================
=       Sidebar Topbar        
============================= */
#sidebar-topbar {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 6px 10px;
	background: #222;
	border-bottom: 1px solid #444;
}

#sidebar-nav {
	display: flex;
	gap: 6px;
}

.sidebar-nav-btn {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	color: white;
	padding: 4px 8px;
	border-radius: 4px;
	cursor: pointer;
	transition: background 0.2s ease;
}

.sidebar-nav-btn:hover {
	background: rgba(255,255,255,0.15);
}

#sidebar-toggle {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	cursor: pointer;
	color: white;
	padding: 4px;
	border-radius: 4px;
	display: flex;
	align-items: center;
	justify-content: center;
	width: 36px;
	height: 36px;
	min-width: 36px;
	min-height: 36px;
}

#sidebar-arrow {
	pointer-events: none;
}

/* =============================
=      Sidebar Top Info       
============================= */
#sidebar-top-info {
	display: flex;
	flex-direction: column;
	gap: 6px;
	padding: 8px 10px;
	background: #181818;
	border-bottom: 1px solid #333;
	font-size: 0.85em;
}

#sidebar-location-weather {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

#sidebar-datetime {
	display: flex;
	flex-direction: column;
	gap: 2px;
}

#sidebar-gold {
	display: flex;
	align-items: center;
	gap: 4px;
	margin-top: 4px;
}

/* =============================
=       Sidebar Buttons       
============================= */
#custom-sidebar-buttons {
	margin-top: 10px;
	display: flex;
	flex-direction: column;
	gap: 8px;
	padding: 8px;
	border-bottom: 1px solid #555;
}

.button-single,
.button-pair {
	display: flex;
	gap: 6px;
}

#btn-saves {
	flex: 1;
	background: rgba(255, 255, 255, 0.05);
	color: white;
	border: 1px solid #888;
	padding: 6px 10px;
	border-radius: 4px;
	font-family: 'Cinzel', serif;
	font-size: 0.85em;
	font-weight: 700;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	text-shadow: 0 0 2px #000;
	transition: background 0.2s, transform 0.2s;
}

#btn-saves:hover {
	background: rgba(255, 255, 255, 0.15);
	transform: scale(1.03);
}

#btn-saves svg {
	width: 16px;
	height: 16px;
	stroke: white;
}

#ui-dialog {
	z-index: 9999; /* High enough to appear above other panels */
}

.sidebar-btn {
	flex: 1;
	background: rgba(255,255,255,0.05);
	color: white;
	border: 1px solid #888;
	padding: 6px 10px;
	border-radius: 4px;
	font-family: 'Cinzel', serif;
	font-size: 0.85em;
	font-weight: 700;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	text-shadow: 0 0 2px #000;
	transition: background 0.2s, transform 0.2s;
}

.sidebar-btn:hover {
	background: rgba(255,255,255,0.15);
	transform: scale(1.03);
}

.sidebar-btn svg {
	width: 16px;
	height: 16px;
	stroke: white;
}

/* =============================
=         Status Bars         
============================= */
.status-bar {
	display: flex;
	align-items: center;
	gap: 6px;
	background: rgba(255,255,255,0.05);
	border: 1px solid #666;
	border-radius: 4px;
	height: 24px;
	padding: 2px 6px;
	margin: 6px 10px;
	position: relative;
	overflow: hidden;
	font-size: 0.8em;
}

/* Icon styling */
.status-bar i,
.status-bar svg {
	width: 18px;
	height: 18px;
	min-width: 18px;
	min-height: 18px;
	stroke: white;
	pointer-events: none;
}

/* Label styling */
.status-bar span {
	position: relative;
	z-index: 2; /* Ensure it's above the fill */
	white-space: nowrap;
	color: white;
	text-shadow: 0 0 3px rgba(0, 0, 0, 0.8); /* Adds contrast glow */
	cursor: default;
}


/* NEW: Fill wrapper for width control */
.status-bar-fill-wrapper {
	position: absolute;
	left: 25px; /* Adjust based on icon + label + spacing */
	right: 6px;
	top: 50%;
	height: 70%;
	transform: translateY(-50%);
	pointer-events: none;
	z-index: 0;
}

/* Fill bar itself (set width dynamically in JS) */
.status-bar-fill {
	width: 0%;
	height: 100%;
	border-radius: 2px;
	transition: width 0.4s ease, background 0.3s ease;
}
/* Health: forest green to neon green */
#health-fill {
	background: linear-gradient(90deg, #375d38, #0b8110);
}

/* Fatigue: sky blue to midnight blue */
#fatigue-fill {
	background: linear-gradient(90deg, #001b40, #a2e9ff );
}

/* Composure: electric yellow to golden amber */
#composure-fill {
	background: linear-gradient(90deg,#c0a800, #fff77a );
}

/* Excitement: magenta pink to deep purple */
#excitement-fill {
	background: linear-gradient(90deg, #ff4fd8, #3b0063);
}

.bar-value {
	position: absolute;
	transform: translateY(-50%);
	color: #d6ffb9;
	font-weight: 700;
	font-size: 0.75em;
	opacity: 0;
	transition: opacity 0.2s ease;
	pointer-events: none;
	text-shadow: 0 0 2px #000;
	top: 20%
}
.status-bar:hover .bar-value {
	opacity: 1;
}
#health-value {

	left: 150px;
}

#fatigue-value {
	left: 150px;
}

#composure-value {
	left: 120px;
}

#excitement-value {
	left: 120px;
}

/* =============================
=      Level and Exp Bars     
============================= */
#sidebar-level-exp {
	padding: 8px 10px;
	font-size: 0.85em;
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.exp-bar {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	height: 10px;
	border-radius: 4px;
	overflow: hidden;
}

.exp-bar-fill {
	background: #42a5f5;
	height: 100%;
	width: 0%;
	transition: width 0.4s ease;
}

/* =============================
=        Summary View         
============================= */

#sidebar-summary {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: flex-start;
	gap: 6px;
	padding: 6px 4px;
	background: #181818;
	border-bottom: 1px solid #333;
	font-size: 0.65em;
	width: 100%;
	box-sizing: border-box;
}

/* Top Line Items */
#summary-time,
#summary-gold,
#summary-level,
#summary-date {
	font-size: 0.7em;
	text-align: center;
	word-break: break-word;
	line-height: 1.3;
}

/* Mini container for time, date, weather, etc. */
#summary-top {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 2px;
	width: 100%;
}

/* Compact vertical layout for 4 stat icons */
#summary-status-icons {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 4px;
}

/* Icon wrap container */
.summary-icon-wrap {
	position: relative;
	width: 32px;
	height: 32px;
	display: flex;
	align-items: center;
	justify-content: center;
}

/* Lucide icons inside summary view */
.summary-icon-wrap i {
	position: relative;
	z-index: 2;
	width: 18px;
	height: 18px;
	stroke-width: 2;
	color: white;
	transition: filter 0.3s ease;
	pointer-events: none;
}

/* Fill bar that grows behind each icon */
.summary-fill {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%;
	height: 0%;
	z-index: 1;
	border-radius: 4px;
	opacity: 0.5;
	transition: height 0.3s ease;
}

/* Stat-specific gradients (fills animate by JS) */
#summary-health-fill {
	background: linear-gradient(to top, #4caf50, #0b8110);
}
#summary-fatigue-fill {
	background: linear-gradient(to top, #a2e9ff, #001b40);
}
#summary-composure-fill {
	background: linear-gradient(to top, #fff77a, #c0a800);
}
#summary-excitement-fill {
	background: linear-gradient(to top, #ff4fd8, #3b0063);
}

/* Optional glow classes applied by JS */
#summary-status-icons i.low {
	filter: drop-shadow(0 0 2px #f44336cc);
}
#summary-status-icons i.mid {
	filter: drop-shadow(0 0 2px #ffc107cc);
}
#summary-status-icons i.high {
	filter: drop-shadow(0 0 3px #4caf50cc);
}

/* Level + mini-XP display block */
#summary-level-exp {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 4px;
	width: 80%;
}

/* XP progress bar styling */
.exp-bar-mini {
	background: rgba(255, 255, 255, 0.05);
	border: 1px solid #555;
	height: 6px;
	width: 100%;
	border-radius: 3px;
	overflow: hidden;
}

.exp-bar-fill-mini {
	background: #42a5f5;
	height: 100%;
	width: 0%;
	transition: width 0.4s ease;
}

/* Status effect icons (e.g. poisoned) */
#summary-conditions {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	align-items: center;
	gap: 4px;
	width: 100%;
}

/* =============================
=     Collapsed Sidebar       
============================= */
#custom-sidebar.collapsed {
	width: 50px;
}

/* Hide navigation arrows */
#custom-sidebar.collapsed #sidebar-nav {
	display: none;
}

/* Hide menu buttons (Character, Inventory, etc.) */
#custom-sidebar.collapsed #custom-sidebar-buttons {
	display: none !important;
}

/* Shrink status bars text */
#custom-sidebar.collapsed .status-bar span {
	display: none;
}

/* Shrink status bar fill left-right space */
#custom-sidebar.collapsed .status-bar-fill {
	left: 30px;
	right: 4px;
}

/* Sidebar toggle (arrow button) stays clickable */
#sidebar-toggle {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	cursor: pointer;
	color: white;
	padding: 4px;
	border-radius: 4px;
	display: flex;
	align-items: center;
	justify-content: center;
	width: 36px;
	height: 36px;
}

/* Sidebar arrow not separately clickable */
#sidebar-arrow {
	pointer-events: none;
}

/* =============================
=    Disabled Nav Buttons     
============================= */
.sidebar-nav-btn:disabled {
	background: rgba(255, 255, 255, 0.02);
	border: 1px solid #333;
	color: #888;
	cursor: not-allowed;
	pointer-events: none;
}

.sidebar-nav-btn:disabled i {
	stroke: #888;
}

/* =============================
=     Glow Effects Critical    
============================= */
.critical-status {
	animation: glowPulse 1.5s infinite alternate;
}

@keyframes glowPulse {
	from { filter: drop-shadow(0 0 5px #f44336); }
	to { filter: drop-shadow(0 0 15px #f44336); }
}
/* twine-user-stylesheet #15: "speech.css" */
/* =============================
=        Speech Bubbles        =
============================= */
.speech {
    display: flex;
    align-items: flex-start;
    gap: 1em;
    padding: 1em;
    border: 2px solid white;
    border-radius: 8px;
    background-color: rgba(0, 0, 0, 0.8);
    box-shadow: 5px 5px 3px black;
    margin-bottom: 0em;
    color: white;
}

.avatar {
    flex-shrink: 0;
    width: 128px;
    height: 192px;
    border-radius: 6px;
    border: 2px solid white;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.speech-content b {
    font-size: 1.2em;
    padding-bottom: 0.2em;
}

.speech-content hr {
    margin: 0.2em 0 0.5em 0;
    border: none;
    border-top: 1px solid #aaa;
}

.speech-content p {
    margin: 0;
    line-height: 1.5;
}
/* twine-user-stylesheet #16: "text-effects.css" */
/* =============================
=         Text Effects         =
============================= */
.wavy {
    display: inline-block;
    font-style: italic;
    animation: wave 1.4s infinite ease-in-out;
}

@keyframes wave {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-1px); }
    50% { transform: translateY(1px); }
    75% { transform: translateY(-1px); }
}

.fadein {
    animation: fadein 0.4s ease-in;
    display: inline-block;
    margin: 0;
}

@keyframes fadein {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.tightblock {
    display: block;
    margin: 0;
    padding: 0;
}

.whisper {
    font-style: italic;
    opacity: 0.75;
    animation: whisperFade 1.8s ease-in-out infinite alternate;
    display: inline-block;
}

@keyframes whisperFade {
    0%   { opacity: 0.65; transform: translateY(0px); }
    50%  { opacity: 0.85; transform: translateY(-1px); }
    100% { opacity: 0.65; transform: translateY(0px); }
}

.shaky {
    display: inline-block;
    animation: shake 0.3s infinite;
}

@keyframes shake {
    0%   { transform: translate(0px, 0px); }
    25%  { transform: translate(-1px, 1px); }
    50%  { transform: translate(1px, -1px); }
    75%  { transform: translate(-1px, -1px); }
    100% { transform: translate(1px, 1px); }
}

.fade-slow {
	opacity: 0;
	animation: fadeInSlow 2s ease-in-out forwards;
}

@keyframes fadeInSlow {
	from { opacity: 0; }
	to   { opacity: 1; }
}

.montage-fade {
	transition: opacity 0.6s ease-in-out;
	opacity: 1;
}

.montage-fade.fade-out {
	opacity: 0;
}

.montage-fade.fade-start {
	opacity: 0;
}
/* twine-user-stylesheet #17: "themes.css" */
/* =============================
=         Text Effects         =
============================= */
.wavy {
    display: inline-block;
    font-style: italic;
    animation: wave 1.4s infinite ease-in-out;
}

@keyframes wave {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-1px); }
    50% { transform: translateY(1px); }
    75% { transform: translateY(-1px); }
}

.fadein {
    animation: fadein 0.4s ease-in;
    display: inline-block;
    margin: 0;
}

@keyframes fadein {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.tightblock {
    display: block;
    margin: 0;
    padding: 0;
}

.whisper {
    font-style: italic;
    opacity: 0.75;
    animation: whisperFade 1.8s ease-in-out infinite alternate;
    display: inline-block;
}

@keyframes whisperFade {
    0%   { opacity: 0.65; transform: translateY(0px); }
    50%  { opacity: 0.85; transform: translateY(-1px); }
    100% { opacity: 0.65; transform: translateY(0px); }
}

.shaky {
    display: inline-block;
    animation: shake 0.3s infinite;
}

@keyframes shake {
    0%   { transform: translate(0px, 0px); }
    25%  { transform: translate(-1px, 1px); }
    50%  { transform: translate(1px, -1px); }
    75%  { transform: translate(-1px, -1px); }
    100% { transform: translate(1px, 1px); }
}
</style><script role="script" id="twine-user-script" type="text/twine-javascript">/* twine-user-script #1: "00_GlobalDeviceTypeAwareness.js" */
setup.isMobileDevice = function () {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
         (window.innerWidth <= 768 && window.innerHeight <= 1024);
};

// Detect current orientation
setup.isPortrait = function () {
  return window.matchMedia("(orientation: portrait)").matches;
};

setup.isLandscape = function () {
  return window.matchMedia("(orientation: landscape)").matches;
};

// Simple tablet detector (optional)
setup.isTabletDevice = function () {
  return setup.isMobileDevice() && window.devicePixelRatio <= 2 && Math.max(window.innerWidth, window.innerHeight) >= 834;
};

// Desktop check (opposite of mobile)
setup.isDesktop = function () {
  return !setup.isMobileDevice();
};

// Detects if user prefers reduced motion
setup.prefersReducedMotion = function () {
  return window.matchMedia("(prefers-reduced-motion: reduce)").matches;
};

// Detects if user prefers dark mode (can use to match system theme)
setup.prefersDarkMode = function () {
  return window.matchMedia("(prefers-color-scheme: dark)").matches;
};

setup.injectDeviceClasses = function () {
  const body = document.body;
  if (setup.isMobileDevice()) body.classList.add("mobile-device");
  else body.classList.add("desktop-device");

  if (setup.isTabletDevice()) body.classList.add("tablet-device");
  if (setup.isPortrait()) body.classList.add("portrait");
  else body.classList.add("landscape");

  if (setup.prefersDarkMode()) body.classList.add("dark-mode");
  if (setup.prefersReducedMotion()) body.classList.add("reduced-motion");
};

document.addEventListener("DOMContentLoaded", setup.injectDeviceClasses);
/* twine-user-script #2: "01_SnapshotNav.js" */
/* ===============================
   SNAPSHOT SYSTEM
   =============================== */

   setup.Snapshots = [];
   setup.CurrentSnapshotIndex = -1;
   setup.MaxSnapshots = 10;
   setup.suppressNextSnapshot = false;
   
   // Track UI states manually (optional per-feature)
   setup.getUIState = function () {
       return {
           dialogueMode: State.getVar('_dialogueMode') || false,
           shopOpen: State.getVar('_shopOpen') || false,
       };
   };
   
   setup.applyUIState = function (uiState) {
       if (uiState.dialogueMode !== undefined) State.setVar('_dialogueMode', uiState.dialogueMode);
       if (uiState.shopOpen !== undefined) State.setVar('_shopOpen', uiState.shopOpen);
   };
   
   setup.takeSnapshot = function () {
       const snapshot = {
           variables: clone(State.variables),
           temporary: clone(State.temporary),
           uiState: setup.getUIState(),
           passageName: passage(),
       };
   
       if (setup.CurrentSnapshotIndex < setup.Snapshots.length - 1) {
           setup.Snapshots = setup.Snapshots.slice(0, setup.CurrentSnapshotIndex + 1);
       }
   
       setup.Snapshots.push(snapshot);
   
       if (setup.Snapshots.length > setup.MaxSnapshots) {
           setup.Snapshots.shift();
       }
   
       setup.CurrentSnapshotIndex = setup.Snapshots.length - 1;
       setup.saveSnapshotsToStorage();
       setup.updateNavButtons();
   };
   
   setup.saveSnapshotsToStorage = function () {
       try {
           const serialized = JSON.stringify(setup.Snapshots);
           window.localStorage.setItem('game_snapshots', serialized);
       } catch (error) {
           console.error("[Snapshot] Failed to save snapshots:", error);
       }
   };
   
   setup.loadSnapshotsFromStorage = function () {
       try {
           const serialized = window.localStorage.getItem('game_snapshots');
           if (serialized) {
               setup.Snapshots = JSON.parse(serialized);
               setup.CurrentSnapshotIndex = setup.Snapshots.length - 1;
               console.log("[Snapshot] Snapshots restored from storage.");
           }
       } catch (error) {
           console.error("[Snapshot] Failed to load snapshots:", error);
           setup.Snapshots = [];
           setup.CurrentSnapshotIndex = -1;
       }
       setup.updateNavButtons();
   };
   
   setup.loadSnapshot = function (index) {
       if (index < 0 || index >= setup.Snapshots.length) {
           console.warn("[Snapshot] Tried to load invalid index:", index);
           return;
       }
   
       const snapshot = setup.Snapshots[index];
       if (!snapshot) {
           console.warn("[Snapshot] No snapshot at index:", index);
           return;
       }
   
       Object.assign(State.variables, clone(snapshot.variables));
       Object.assign(State.temporary, clone(snapshot.temporary));
       setup.applyUIState(snapshot.uiState);
   
       setup.CurrentSnapshotIndex = index;
       setup.suppressNextSnapshot = true;
   
       // ✅ Trigger UI hydration flag — let :passagerender handle rehydration
       State.variables.needsUIRehydrate = true;
   
       Engine.play(snapshot.passageName, true);
   
       setup.updateNavButtons();
   };
   
   setup.navBack = function () {
       if (setup.CurrentSnapshotIndex > 0) {
           setup.loadSnapshot(setup.CurrentSnapshotIndex - 1);
       } else {
           UI.alert("No earlier snapshots available.");
       }
   };
   
   setup.navForward = function () {
       if (setup.CurrentSnapshotIndex < setup.Snapshots.length - 1) {
           setup.loadSnapshot(setup.CurrentSnapshotIndex + 1);
       } else {
           UI.alert("No newer snapshots available.");
       }
   };
   
   setup.updateNavButtons = function () {
       const backBtn = document.getElementById("sidebar-nav-back");
       const forwardBtn = document.getElementById("sidebar-nav-forward");
   
       if (backBtn) {
           backBtn.disabled = setup.CurrentSnapshotIndex <= 0;
       }
       if (forwardBtn) {
           forwardBtn.disabled = setup.CurrentSnapshotIndex >= setup.Snapshots.length - 1;
       }
   };
   
   $(document).on(':passagedisplay', function () {
       if (setup.suppressNextSnapshot) {
           setup.suppressNextSnapshot = false;
           return;
       }
       setup.takeSnapshot();
   });
   
   setup.clearSnapshots = function () {
       setup.Snapshots = [];
       setup.CurrentSnapshotIndex = -1;
       window.localStorage.removeItem('game_snapshots');
       setup.updateNavButtons();
   };
   
   /* ===============================
      END SNAPSHOT SYSTEM
      =============================== */
   
/* twine-user-script #3: "03_setup_sidebarui.js" */
if (typeof setup === "undefined") {
	setup = {};
}

if (typeof setup.SidebarUI === "undefined") {
	setup.SidebarUI = {};
}
/* twine-user-script #4: "04_widgets.js" */
/* Background Macro */
Macro.add("bg", {
	handler: function () {
		const arg = this.args[0];
		if (typeof arg === "string") {
			const path = "images/background_" + arg + ".png";
			State.variables.bgImage = path;
			State.variables.bgImageSetThisPassage = true;

			// Immediately apply to background
			const el = document.getElementById("background-image");
			if (el) {
				el.style.backgroundImage = `url('${path}')`;
				console.log(`🖼️ Background updated to: ${path}`);
			} else {
				console.warn("⚠️ Could not find #background element.");
			}
		} else {
			return this.error("Invalid argument to <<bg>>. Expected a string like 'tavern'.");
		}
	}
});


/* SidebarUI Widget */
Macro.add("SidebarUI", {
	handler() {
      /*
		const sidebar = document.getElementById("custom-sidebar");
      
      console.log(sidebar);

		// Set bar fill width and value label
		const s = State.variables.player.status;
		function updateBar(id, current, max) {
			const fill = document.getElementById(`${id}-fill`);
			const value = document.getElementById(`${id}-value`);
			if (fill) fill.style.width = `${(current / max) * 100}%`;
			if (value) value.textContent = `${Math.round(current)} / ${Math.round(max)}`;
		}

		updateBar("health", s.health, s.maxHealth);
		updateBar("fatigue", s.fatigue, s.maxFatigue);
		updateBar("composure", s.composure, s.maxComposure);
		updateBar("excitement", s.excitement, s.maxExcitement);

		if (window.setup?.SidebarUI?.initialize) {
			console.log("[SidebarUI] Now initializing after Sidebar injection...");
			setup.SidebarUI.initialize();
		}

		if (window.lucide) {
			lucide.createIcons();
		} else {
			console.warn("Lucide not available at sidebar load time.");
		} */
	}
});




Macro.add("know", {
	handler() {
		const charId = this.args[0];
		if (!charId || !State.variables.characters?.[charId]) {
			return this.error(`Unknown character ID: ${charId}`);
		}

		State.variables.characters[charId].known = true;
	}
});


/* Dialogue Choice Button */
Macro.add("dialogueChoice", {
	skipArgs: false,
	handler() {
		const [label, target, flag] = this.args;
		const reusable = flag === "1" || flag === 1;

		if (!label || !target) {
			console.warn("<<dialogueChoice>> missing label or target");
			return;
		}

		const $button = $("<p>")
			.addClass("dialogue-choice")
			.text(label)
			.css("cursor", "pointer")
			.on("click", () => {
				console.groupCollapsed(`📌 [dialogueChoice] "${label}" → ${target}`);
				console.log("Reusable:", reusable);
				console.log("Phase:", State.variables.currentPhase);
				console.log("NPC:", State.variables.currentNPC);

				$button.remove();

				// Track globally if not reusable
				State.variables.usedDialogueOptions ??= {};
				if (!reusable) {
					State.variables.usedDialogueOptions[target] = true;
					console.log("✅ Marked non-reusable as used:", target);
				}

				// Track usage by phase + NPC
				const char = State.variables.currentNPC || "Unknown";
				const phase = State.variables.currentPhase ?? "X";
				const key = `Read_${phase}_${char}_${target}`;
				State.variables[key] ??= 0;
				State.variables[key]++;
				console.log("📊 Incremented:", key, "→", State.variables[key]);

				const $box = $("#convoBox");
				if ($box.length) {
					const preChildren = $box[0].children.length;

					$box.children().removeClass("active-entry").addClass("faded-entry");

					console.log("📥 Injecting widget: <<", target, ">>");
					try {
						Wikifier.wikifyEval(`<<${target}>>`);
					} catch (e) {
						console.error("❌ Error injecting widget:", e);
					}

					if (typeof setup.clearConvoChoices === "function") {
						setup.clearConvoChoices();
					} else {
						console.warn("⚠️ setup.clearConvoChoices not found");
					}

					const funcKey = `${char}_Conversation_Options_${phase}`;
					const phaseFunc = setup?.[funcKey];

					if (typeof phaseFunc === "function") {
						console.log(`🔁 Recalling setup.${funcKey}()`);
						phaseFunc();
					} else {
						console.warn(`⚠️ No phase function found for: ${funcKey}`);
					}

					setTimeout(() => {
						const box = $box[0];
						const entries = box.children;
						const newEntry = entries[preChildren];
						if (!newEntry) {
							console.warn("🕳 No new entry detected.");
							return;
						}

						const divider = document.createElement("div");
						divider.className = "dialogue-divider";
						box.insertBefore(divider, newEntry);

						newEntry.classList.add("active-entry");
						newEntry.classList.remove("faded-entry");

						const boxTop = box.getBoundingClientRect().top;
						const entryTop = newEntry.getBoundingClientRect().top;
						const offset = entryTop - boxTop;

						box.scrollTo({
							top: box.scrollTop + offset,
							behavior: "smooth"
						});
						console.log("🧭 Scrolled to new entry.");
					}, 10);
				} else {
					console.warn("⚠️ convoBox not found.");
				}

				console.groupEnd();
			});

		this.output.append($button[0]);
	}
});





/* Dialogue Tree Macro: Pulls current NPC & Phase and injects options */
Macro.add("DialogueTree", {
	handler() {
		const [characterName, phaseId] = this.args;

		if (!characterName || !phaseId) {
			console.error("DialogueTree: Missing character name or phase identifier.");
			return;
		}

		const v = State.variables;
		v.currentNPC = characterName;
		v.currentPhase = phaseId;

		if (typeof setup.clearConvoChoices === "function") {
			setup.clearConvoChoices();
		}

		// Always use flat naming: setup.char_Conversation_Options_phaseId
		const functionName = `${characterName}_Conversation_Options_${phaseId}`;
		const setupFunc = setup[functionName];

		if (typeof setupFunc !== "function") {
			console.error(`DialogueTree: Missing setup function '${functionName}'`);
			return;
		}

		console.log(`📂 [DialogueTree] Switching to: ${functionName}`);

		setTimeout(() => {
			const choiceEl = document.getElementById("convoChoices");
			if (!choiceEl) {
				console.warn("DialogueTree: #convoChoices not found.");
				return;
			}
			setupFunc();
		}, 0);
	}
});



/* Injects List of Choices into UI */
setup.addChoices = function (list) {
	const $container = $("#convoChoices");
	if (!$container.length) {
		console.warn("[addChoices] convoChoices not found.");
		return;
	}

	State.variables.usedDialogueOptions ??= {};

	list.forEach(([label, target, reusableFlag = 0]) => {
		const reusable = reusableFlag === 1 || reusableFlag === "1";
		const used = State.variables.usedDialogueOptions[target];

		if (used && !reusable) {
			console.log(`[addChoices] Skipping used non-reusable choice: ${target}`);
			return;
		}

		const macroCall = `<<dialogueChoice "${label}" "${target}" "${reusable ? 1 : 0}">>`;
		new Wikifier($container[0], macroCall);
	});
};

/* 📌 Minigame Start Button */
Macro.add("OpenConvoGame", {
	handler() {
		const npcId = this.args[0];
		const char = State.variables.characters?.[npcId];

		if (!npcId || !char) {
			return this.error("OpenConvoGame requires a valid NPC ID.");
		}

		const uniqueId = `start-minigame-${npcId}`;
		const btnHTML = `
			<div id="${uniqueId}" class="start-minigame-button-wrapper">
				<button class="start-minigame-button" onclick="
					setup.ConvoUI.renderMinigame('${npcId}');
					const wrapper = document.getElementById('${uniqueId}');
					if (wrapper) {
						wrapper.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
						wrapper.style.opacity = '0';
						wrapper.style.transform = 'translateY(-10px)';
						setTimeout(() => wrapper.remove(), 400);
					}
				">
					Get to know ${char.name}
				</button>
			</div>
		`;

		const target = document.getElementById("convoBox");
		if (target) {
			target.insertAdjacentHTML("beforeend", btnHTML);
		} else {
			console.warn("[OpenConvoGame] #convoBox not found.");
		}
	}
});


Macro.add("CrownAndCaste", {
	handler() {
	  const args = this.args;
	  const buyIn = parseFloat(args[0]);
	  const npcIds = args.slice(1, 4).filter(id => id && id !== "");
  
	  const validStakes = ["low", "standard", "high"];
	  const knownHouseRules = ["golden-tax", "split-line", "blessing-of-sixes", "royal-flush"];
  
	  // Optional arguments after NPCs
	  const remaining = args.slice(4);
	  let stakes = "standard";
	  let houseRules = [];
	  let winPassage = null;
	  let losePassage = null;
	  let playerFavor = null;
  
	  for (const arg of remaining) {
		const lower = String(arg).toLowerCase();
		if (validStakes.includes(lower)) {
		  stakes = lower;
		} else if (knownHouseRules.includes(lower)) {
		  houseRules.push(lower);
		} else if (!isNaN(parseFloat(arg)) && parseFloat(arg) > 1) {
		  playerFavor = parseFloat(arg);
		} else if (!winPassage) {
		  winPassage = arg;
		} else if (!losePassage) {
		  losePassage = arg;
		}
	  }
  
	  if (!losePassage && winPassage) losePassage = winPassage;
  
	  if (isNaN(buyIn)) {
		return this.error("CrownAndCaste requires a numeric buy-in as the first argument.");
	  }
  
	  const characters = State.variables.characters;
	  const sessionPlayers = ["jaylie"];
  
	  npcIds.forEach(id => {
		const cleanId = id.trim();

		if (characters?.[cleanId]) {
			// Matches a real character in the characters object
			sessionPlayers.push(cleanId);
		} else if (cleanId.toLowerCase() === "ghost") {
			sessionPlayers.push("ghost");
		} else {
			// Allow literal name as a fallback
			sessionPlayers.push({ name: cleanId });
		}
		});

  
	  if (sessionPlayers.length < 2) {
		return this.error("Crown & Caste requires at least 2 players (including you).");
	  }
	  if (sessionPlayers.length > 4) {
		sessionPlayers.splice(4);
	  }
  
	  const playerGold = State.variables.inventory_player?.gold_coin || 0;
	  const hasEnoughGold = playerGold >= buyIn;
  
	  const stakesDisplay = stakes === "low" ? "Low Stakes" :
							stakes === "high" ? "High Stakes" :
							"Standard Stakes";
  
	  const sessionKey = `crown-and-caste-${Date.now()}`;
	  const uniqueId = `start-cnc-${sessionKey}`;
	  const buttonId = `btn-${uniqueId}`;
	  const goldIcon = `<i data-lucide='coins'></i>`;
  
	  const houseRulesDisplay = houseRules.length > 0
		? `<div class="house-rules-display">House Rules: ${houseRules.join(", ")}</div>` : "";
  
	  const btnHTML = `
		<div id="${uniqueId}" class="start-minigame-button-wrapper">
		  <div class="crown-caste-game-info">
			<h4>Crown & Caste Table</h4>
			<div class="game-details">
			  <span class="stakes-level">${stakesDisplay}</span>
			  <span class="buy-in">Buy-In: ${buyIn} ${goldIcon}</span>
			  <span class="players">Players: ${sessionPlayers.length}/4</span>
			</div>
			${houseRulesDisplay}
		  </div>
		  <button class="start-minigame-button" id="${buttonId}" ${hasEnoughGold ? "" : "disabled"}>
			${hasEnoughGold ? "Join Game" : "Insufficient Gold"}
		  </button>
		  ${!hasEnoughGold ? `<p class='minigame-warning'>(Need ${buyIn}g to join this table)</p>` : ""}
		</div>
	  `;
  
	  $(this.output).append(btnHTML);
  
	  setTimeout(() => {
		const buttonEl = document.getElementById(buttonId);
		if (buttonEl && hasEnoughGold) {
		  buttonEl.addEventListener("click", () => {
			console.log("[CrownAndCaste] 🟢 Starting game...");
			console.log(`[CrownAndCaste] Stakes: ${stakes}, Rules: ${houseRules}`);
			console.log(`[CrownAndCaste] Routes: Win → ${winPassage}, Lose → ${losePassage}`);
			if (playerFavor) console.log(`[CrownAndCaste] Player Favor Modifier: ${playerFavor}`);
  
			if (State.variables.inventory_player?.gold_coin) {
			  State.variables.inventory_player.gold_coin -= buyIn;
			}
  
			// Store metadata
			State.temporary.ccBuyIn = buyIn;
			State.temporary.ccStakes = stakes;
			State.temporary.ccHouseRules = houseRules;
			State.temporary.ccWinPassage = winPassage;
			State.temporary.ccLosePassage = losePassage;
			State.temporary.ccPlayerFavor = playerFavor ?? null;
  
			setup.CrownAndCaste.initSession(sessionPlayers, stakes, houseRules, playerFavor, buyIn);
			setup.CrownAndCaste.startGame();
			setup.CrownAndCasteUI.renderMinigame();
  
			const wrapper = document.getElementById(uniqueId);
			if (wrapper) {
			  wrapper.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
			  wrapper.style.opacity = '0';
			  wrapper.style.transform = 'translateY(-10px)';
			  setTimeout(() => wrapper.remove(), 400);
			}
  
			if (window.lucide) lucide.createIcons();
		  });
		}
	  }, 50);
	}
  });
  
  



/* Optional Utility: Clears conversation snapshot state */
Macro.add("ClearSnapshots", {
	handler() {
		if (typeof setup.clearSnapshots === 'function') {
			setup.clearSnapshots();
		} else {
			console.warn("[ClearSnapshots] setup.clearSnapshots function not found.");
		}
	}
});


/* Character Relation Changing Macro */
Macro.add("relation", {
	skipArgs: false,
	handler() {
		if (this.args.length < 3) {
			return this.error("Usage: <<relation 'characterId' 'stat' value ['set' or 'add']>>");
		}

		const [charId, stat, rawValue, mode = "add"] = this.args;
		const chars = State.variables.characters;
		const char = chars?.[charId];

		if (!char) return this.error(`Character '${charId}' not found.`);
		if (!["trust", "affection", "rapport", "tension", "cooldown"].includes(stat)) {
			return this.error(`Stat '${stat}' is not a valid relationship field.`);
		}

		const value = parseFloat(rawValue);
		if (isNaN(value)) {
			return this.error("Value must be a number.");
		}

		if (mode === "set") {
			char[stat] = value;
		} else if (mode === "add") {
			char[stat] = (char[stat] ?? 0) + value;
		} else {
			return this.error("Mode must be 'add' or 'set'.");
		}

		// Optionally log or visually confirm
		console.log(`[relation] ${mode} ${value} to ${charId}.${stat} → ${char[stat]}`);
	}
});

Macro.add("SceneFadeInNow", {
	handler() {
		setTimeout(() => {
			const nodes = document.querySelectorAll("#montage .fade-start");
			nodes.forEach(n => n.classList.remove("fade-start"));
			console.log(`[SceneFadeInNow] ${nodes.length} element(s) faded in.`);
		}, 20);
	}
});

Macro.add("StartSexScene", {
	skipArgs: false,
	handler() {
	  const args = this.args;
  
	  console.log("[SexScene] 🔹 Macro Triggered");
	  console.log("[SexScene] Arguments Received:", args);
  
	  if (!args.length) {
		return this.error("<<StartSexScene>> requires at least one NPC ID.");
	  }
  
	  let label = "Have Sex";
	  let npcIdList = "";
	  let positionOverride = null;
  
	  if (args.length === 1) {
		npcIdList = args[0];
		console.log(`[SexScene] Using default label. Target NPCs: ${npcIdList}`);
	  } else if (args.length >= 2) {
		label = args[0];
		npcIdList = args[1];
		if (args[2]) {
		  positionOverride = args[2];
		  console.log(`[SexScene] Position override specified: ${positionOverride}`);
		}
		console.log(`[SexScene] Custom label: ${label} | Target NPCs: ${npcIdList}`);
	  }
  
	  const $link = $("<span>")
		.addClass("macro-link")
		.wiki(label)
		.css("cursor", "pointer")
		.on("click", () => {
		  console.log("[SexScene] 🔸 Link clicked. Beginning setup...");
  
		  // Initialize body states
		  setup.initializeSexSceneStates(npcIdList);
		  console.log("[SexScene] ✅ States initialized via setup.initializeSexSceneStates");
  
		  // Store participants
		  const npcArray = npcIdList.split(",").map(id => id.trim());
		  State.variables.sexSceneParticipants = {
			player: "player",
			npcs: npcArray
		  };
		  console.log("[SexScene] 🧍 Participants set:", State.variables.sexSceneParticipants);
  
		  // Set up environment
		  State.variables.sexSceneEnvironment = {
			location: State.activePassage,
			furniture: ["floor", "wall"],
			positionOverride: positionOverride ?? null
		  };
		  console.log("[SexScene] 🛋️ Environment defined:", State.variables.sexSceneEnvironment);
  
		  // Launch scene
		  console.log("[SexScene] 🚪 Entering ::SexScene passage...");
		  Engine.play("SexScene");
		});
  
	  $(this.output).append($link);
	}
  });
  
Macro.add("EndSexScene", {
	handler() {
		if (this.args.length === 0 || typeof this.args[0] !== "string") {
			return this.error("You must provide a valid passage name as a string.");
		}

		const exitTarget = this.args[0];
		State.variables.sexSceneExitTarget = exitTarget;

		console.log(`[SexSceneInit] 📍 Exit passage set to '${exitTarget}'`);
	}
});


 console.log("✅ widgets.js loaded");
/* twine-user-script #5: "cssPathFix.js" */
if (
	document.location.href.toLowerCase().includes("/twine/scratch/") ||
	document.location.href.toLowerCase().includes("/temp/") ||
	document.location.href.toLowerCase().includes("/private/") ||
	hasOwnProperty.call(window, "storyFormat")
) {
	$(document).one(":passagerender", function () {
		setTimeout(function () {
			$(".avatar").each(function () {
				var url = $(this).css("background-image");
				url = url.replace(/\"/gi, "").replace(')', '');
				url = url.slice(url.lastIndexOf("/") + 1);
				$(this).css("background-image", "url('file:///C:/Games/My%20Game/" + url + "')");
			});
		});
	});
}
/* twine-user-script #6: "01_playerdata.js" */
State.variables.player = {
	// === Identity ===
	name: "Jaylie",
	age: 18,
	dob: "Unknown",
	race: "Human",
	gender: "Female",

	// === Leveling ===
	level: 1,
	experience: 69,
	experienceToNextLevel: 100,

	// === Attributes (Perk-based) ===
	attributes: {
		strength: 5,
		agility: 5,
		toughness: 5,
		charisma: 5,
		intelligence: 5,
		insight: 5
	},

	// === Primary Skills (Earn XP individually) ===
	primarySkills: {
		athletics: { value: 0, xp: 0 },
		acrobatics: { value: 0, xp: 0 },
		sleightOfHand: { value: 0, xp: 0 },
		stealth: { value: 0, xp: 0 },
		fortitude: { value: 0, xp: 0 },
		willpower: { value: 0, xp: 0 },
		deception: { value: 0, xp: 0 },
		intimidation: { value: 0, xp: 0 },
		performance: { value: 0, xp: 0 },
		persuasion: { value: 0, xp: 0 },
		magic: { value: 0, xp: 0 },
		investigation: { value: 0, xp: 0 },
		religion: { value: 0, xp: 0 },
		history: { value: 0, xp: 0 },
		perception: { value: 0, xp: 0 },
		survival: { value: 0, xp: 0 },
		medicine: { value: 0, xp: 0 }
	},

	// === Secondary Skills (Earn XP individually) ===
	secondarySkills: {
		riding: { value: 100, xp: 0 },
		dancing: { value: 100, xp: 0 },
		swimming: { value: 100, xp: 0 },
		cleaning: { value: 100, xp: 0 },
		disguise: { value: 100, xp: 0 },
		hands: { value: 100, xp: 0 },
		mouth: { value: 100, xp: 0 },
		breasts: { value: 100, xp: 0 },
		vagina: { value: 100, xp: 0 },
		anus: { value: 100, xp: 0 }
	},

	// === Equipment ===
	equipment: {
		weaponMain: "Fists",
		weaponOffhand: "None",
		armor: "Simple Clothes"
	},

	/* === Carry === */
	carryWeight: {
		current: 0,
	},


	// === Body Anatomy ===
	body: {
		height: 64, // inches
		breastSize: 2, // modest
		buttSize: 2, // modest
		bodyType: 3, // average
		lipFullness: 2, // modest
		skinTone: "fair",
		muscleTone: 2, // fit
		hipWidth: 2, // wide
		bodyHair: 1, // light
		voiceTone: "gentle",
		hairColor: "auburn",
		hairStyle: "wavy",
		hairLength: 20, // mid-back
		eyeColor: "hazel green",

		// Functional anatomy
		vagina: true,
		clitoris: true,
	},

	// === Current Status ===
	status: {
		health: 100,
		maxHealth: 100,
		fatigue: 25,
		maxFatigue: 100,
		composure: 100,
		maxComposure: 100,
		excitement: 15,
		maxExcitement: 100,
		isCumming: false,

		// Conditional Status Effects
		poisoned: 0,
		maxPoisoned: 100,
		intoxicated: 0,
		maxIntoxicated: 100,
		charmed: 0,
		maxCharmed: 100,
		burning: false,
		bleeding: 0,
		maxBleeding: 50,
		stunned: false
	},

	/* ==================== */
	/* - Player Inventory - */
	/* ==================== */

		/* === Carry === */
	carryWeight: {
		current: 0,
	},

};

console.log("✅ PlayerData loaded successfully.");
/* twine-user-script #7: "02_initVars.js" */
State.variables.inventory_player = Object.assign(
	{},
	State.variables.player.startingInventory
);

State.variables.DEBUG = true;

// Tavern state tracking
State.variables.seenTavernSpace = false;
/* twine-user-script #8: "03_worldstate.js" */
State.variables.world = {
    // === Time and Calendar ===
    dayOfYear: 1,     // 1-400
    year: 12219,      // After Impact (AI)
    hour: 6,
    minute: 0,
    is24HourFormat: true,  // toggleable from settings
  
    // === Weather ===
    weather: "Clear", // Clear, Rain, Storm, Snow, Fog
  
    // === Location ===
    locationName: "Unknown",
  
    // === Environmental Flags (future expansion) ===
    specialEvent: null, // e.g., "Harvest Festival"
  };
  console.log("WorldData is loaded.");
/* twine-user-script #9: "04_Generated_NPCData.js" */
/* twine-user-script #10: "04_character.js" */
/* ================================
=  Character Dialogue & Avatars  =
================================ */

setup.initializeCharacters = function () {
	return{
		jaylie: {
			name: "Jaylie",
			defaultName: "Jaylie",
			known: true,
			avatar: "images/portrait_jaylie.png",
			color: "white",
			bgColor: "rgba(110, 43, 54, 0.8)",

			isPlayer: true, // Optional: May be used to prevent this character from appearing in random events

			// Optional fallback portrait info — no runtime body data needed here
			pronouns: {
				subject: "she",
				object: "her",
				possessive: "her",
				reflexive: "herself",
				noun: "woman"
			},

			// Optional static traits used only for fallback conversations
			traits: ["Curious", "Stubborn", "Playful"],
			socialStyle: "Warm"
		},

		
  
		adda: {
			name: "Mistress Adda",
			defaultName: "Brothel Mistress",
			known: false,
			avatar: "images/portrait_mistressadda.png",
			color: "white",
			bgColor: "rgba(32, 32, 32, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Dominant", "Wise", "Seductive"],
			inclinations: ["bondage", "praise", "service"],
			motivations: ["Control", "Guidance"],
			socialStyle: "Regal",
			
			pronouns: {
				subject: "she",         // he / they
				object: "her",          // him / them
				possessive: "her",      // his / their
				reflexive: "herself",   // himself / themself
				noun: "woman"           // man / person
			  },
			  
			body: {
				height: 69, // 5'9"
				breastSize: 4, // "large"
				buttSize: 3, // "round"
				bodyType: 4, // "curvy"
				lipFullness: 3, // "full"
				skinTone: "olive",
				muscleTone: 2, // "fit"
				hipWidth: 3, // "very wide"
				bodyHair: 1, // "light"
				voiceTone: "commanding",
				hairColor: "iron-gray with black undertones",
				hairStyle: "elegantly pinned with loose waves",
				hairLength: 20, // "mid-back"
				eyeColor: "dark hazel"
			},
		
			preferences: {
				sexualActs: {
					likes: [
						"Dominate", "Bondage_Use", "Praise_G",
						"Spank_G", "HairPulling_G", "DirtyTalk_G",
						"Vaginal_P", "Oral_R", "OrgasmControl_G"
					],
					dislikes: ["Submit", "Clit_Rub", "Blindfold_R"]
				},
				bodyTypes: {
					likes: ["SlimWaist", "BigButt", "Curvy", "Fit"],
					dislikes: ["Emaciated", "VeryHairy"]
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "modest",
						breastSize: "medium"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
  
		kallot: {
			name: "Kallot",
			defaultName: "Drunk Man",
			known: false,
			avatar: "images/portrait_kallot.png",
			color: "white",
			bgColor: "rgba(159, 172, 138, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Cynical", "Melancholic", "Awkward"],
			inclinations: ["voyeurism", "vanilla", "submission"],
			motivations: ["Redemption", "Connection"],
			socialStyle: "Humble",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 68, // 5'8"
				breastSize: null,
				buttSize: 3, // "round"
				penisSize: 6.5, // inches
				bodyType: 5, // "thick"
				lipFullness: 2, // "modest"
				skinTone: "brown",
				muscleTone: 3, // "athletic"
				hipWidth: 2, // "modest"
				bodyHair: 3, // "hairy"
				voiceTone: "gentle",
				hairColor: "dark brown",
				hairStyle: "short and messy",
				hairLength: 2, // ~short
				eyeColor: "muddy blue"
			},
		
			preferences: {
				sexualActs: {
					likes: ["Oral_R", "Oral_G", "Vaginal_P", "Voyeurism", "Submit", "Kissing", "Cuddling"],
					dislikes: ["Dominate", "Spank_G", "Degrade_G"]
				},
				bodyTypes: {
					likes: ["Curvy", "Soft", "Average"],
					dislikes: ["Ripped", "Broad", "VeryTall"]
				},
				partners: {
					genderPreference: {
						male: 0.1,
						female: 0.9
					},
					anatomyPreference: {
						breastSize: "large",
						buttSize: "plump"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
  
		marie: {
			name: "Marie",
			defaultName: "Brothel Girl",
			known: false,
			avatar: "images/portrait_marie.png",
			color: "white",
			bgColor: "rgba(197, 126, 65, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Introverted", "Guarded", "Submissive"],
			inclinations: ["praise", "service", "submission"],
			motivations: ["Safety", "Freedom"],
			socialStyle: "Reserved",
			
			pronouns: {
				subject: "she",         // he / they
				object: "her",          // him / them
				possessive: "her",      // his / their
				reflexive: "herself",   // himself / themself
				noun: "woman"           // man / person
			  },
			  
			body: {
				height: 61, // 5'1"
				breastSize: 1, // "small"
				buttSize: 2, // "modest"
				bodyType: 1, // "slender"
				lipFullness: 2, // "modest"
				skinTone: "porcelain",
				muscleTone: 0, // "soft"
				hipWidth: 1, // "modest"
				bodyHair: 0, // "smooth"
				voiceTone: "hushed",
				hairColor: "blonde",
				hairStyle: "loose and natural",
				hairLength: 5, // "mid-back"
				eyeColor: "green"
			},
		
			preferences: {
				sexualActs: {
					likes: ["Praise_G", "Oral_G", "Oral_R", "Cuddling", "Kissing", "Fingering_R", "BreastPlay_R"],
					dislikes: ["Spank_G", "HairPulling_G", "Choke_G", "Anal_P", "Clit_Rub"]
				},
				bodyTypes: {
					likes: ["Curvy", "Soft", "Fit"],
					dislikes: ["Ripped", "VeryTall", "Broad"]
				},
				partners: {
					genderPreference: {
						male: 0.3,
						female: 0.7
					},
					anatomyPreference: {
						breastSize: "large",
						penisSize: "modest"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
  
		eristan: {
			name: "Eristan Velthar",
			defaultName: "Madman",
			known: false,
			avatar: "images/portrait_eristan.png",
			color: "white",
			bgColor: "rgba(53, 18, 4, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Detached", "Curious", "Traumatized"],
			inclinations: ["chastity", "abstinence", "masochism"],
			motivations: ["Prophecy", "Protection"],
			socialStyle: "Unhinged",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 70, // 5'10"
				breastSize: null,
				buttSize: 0, // "flat"
				bodyType: 0, // "emaciated"
				lipFullness: 1, // "narrow"
				skinTone: "fair",
				muscleTone: 0, // "soft"
				hipWidth: 0, // "narrow"
				bodyHair: 2, // "natural"
				voiceTone: "breathy",
				hairColor: "ashen gray",
				hairStyle: "wild and unkempt",
				hairLength: 4, // "shoulder-length"
				eyeColor: "cloudy blue",
				penisSize: 9.5 // destiny's joke
			},
		
			preferences: {
				sexualActs: {
					likes: [],
					dislikes: [
						"Oral_R", "Oral_G", "Vaginal_P", "Anal_P", "Toys_OnSelf",
						"Toys_Use", "Kissing", "Cuddling", "DirtyTalk_R", "Dominate", "Submit"
					]
				},
				bodyTypes: {
					likes: [],
					dislikes: ["Curvy", "Voluptuous", "Fit", "Broad"]
				},
				partners: {
					genderPreference: {
						male: 0.9,
						female: 0.1
					},
					anatomyPreference: {
						penisSize: "irrelevant",
						breastSize: "irrelevant"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		

		harroc: {
			name: "Harroc",
			defaultName: "Barkeep",
			known: true,
			avatar: "images/portrait_harroc.png",
			color: "white",
			bgColor: "rgba(65, 48, 35, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Stoic", "Kind", "Guarded"],
			inclinations: ["vanilla", "monogamy", "aftercare"],
			motivations: ["Duty", "Redemption"],
			socialStyle: "Grizzled",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 76, // 6'4"
				breastSize: null,
				buttSize: 2, // "modest"
				bodyType: 6, // "heavyset"
				lipFullness: 2, // "modest"
				skinTone: "brown",
				muscleTone: 5, // "muscular"
				hipWidth: 1, // "modest"
				bodyHair: 3, // "hairy"
				voiceTone: "commanding",
				hairColor: "grizzled black",
				hairStyle: "bald with beard",
				hairLength: 2, // ~"short"
				eyeColor: "dark brown",
				penisSize: 7.5
			},
		
			preferences: {
				sexualActs: {
					likes: ["Vaginal_P", "Cuddling", "Kissing", "BreastPlay_G", "Submit"],
					dislikes: ["Choke_G", "Spank_G", "Toys_Use", "Anal_P"]
				},
				bodyTypes: {
					likes: ["Curvy", "Thick", "Strong"],
					dislikes: ["Slender", "Emaciated"]
				},
				partners: {
					genderPreference: {
						female: 1.0,
						male: 0.0
					},
					anatomyPreference: {
						breastSize: "large",
						penisSize: null
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},

		tesska: {
			name: "Tesska",
			defaultName: "Barmaid",
			known: false,
			avatar: "images/portrait_tesska.png",
			color: "white",
			bgColor: "rgba(189, 108, 99, 0.85)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Flirty", "Crude", "Confident"],
			inclinations: ["exhibitionist", "teasing", "dominant"],
			motivations: ["Freedom", "Excitement"],
			socialStyle: "Feisty",

			pronouns: {
				subject: "she",         // he / they
				object: "her",          // him / them
				possessive: "her",      // his / their
				reflexive: "herself",   // himself / themself
				noun: "woman"           // man / person
			  },
			  
		
			body: {
				height: 64, // 5'4"
				breastSize: 4, // "large"
				buttSize: 3, // "round"
				bodyType: 5, // "thick"
				lipFullness: 3, // "full"
				skinTone: "golden",
				muscleTone: 4, // "defined"
				hipWidth: 2, // "wide"
				bodyHair: 1, // "light"
				voiceTone: "melodic",
				hairColor: "fiery red",
				hairStyle: "braided",
				hairLength: 5, // "mid-back"
				eyeColor: "hazel"
			},
		
			preferences: {
				sexualActs: {
					likes: ["Oral_G", "Oral_R", "Spank_G", "HairPulling_G", "Vaginal_P", "Toys_Use", "Dominate"],
					dislikes: ["Submit", "Choke_R"]
				},
				bodyTypes: {
					likes: ["Muscular", "Broad", "Defined"],
					dislikes: ["Emaciated", "Soft"]
				},
				partners: {
					genderPreference: {
						male: 0.9,
						female: 0.1
					},
					anatomyPreference: {
						penisSize: "large",
						breastSize: "medium"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
		allura: {
			name: "Allura",
			defaultName: "Exotic Hostess",
			known: false,
			avatar: "images/portrait_allura.png",
			color: "white",
			bgColor: "rgba(20, 152, 232, 0.6)",

			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,

			traits: ["Flirty", "Cynical", "Confident"],
			inclinations: ["bondage", "dominant", "sadism", "exhibitionism"],
			motivations: ["Pleasure", "Family"],
			socialStyle: "Seductive",
			
			pronouns: {
				subject: "she",
				object: "her",
				possessive: "her",
				reflexive: "herself",
				noun: "woman"
			},

			body: {
				height: 68, // 5'8"
				breastSize: 5, // "very large"
				buttSize: 4, // "plump"
				bodyType: 4, // "curvy"
				lipFullness: 4, // "plump"
				skinTone: "midnight blue",
				muscleTone: 3, // "athletic"
				hipWidth: 3, // "very wide"
				bodyHair: 0, // "smooth"
				voiceTone: "breathy",
				hairColor: "black",
				hairStyle: "voluminous and wild",
				hairLength: 6, // "waist-length"
				eyeColor: "gold",
				horns: "small curled obsidian",
				ears: "long and pointed",

				// Required anatomy
				vagina: true,
				buttSize: 3,
				anus: true,
				clitoris: true,
				penisSize: 4
			},

			preferences: {
				sexualActs: {
					likes: [
						"Dominate", "Bondage_Use", "Choke_G", "Spank_G", "Toys_Use",
						"Oral_G", "Oral_R", "FaceSit", "Praise_G", "DirtyTalk_G", "Vaginal_P"
					],
					dislikes: ["Submit", "Cuddling", "Creampie_Preference"]
				},
				bodyTypes: {
					likes: ["Defined", "Broad", "Fit", "Muscular"],
					dislikes: ["Soft", "Emaciated"]
				},
				partners: {
					genderPreference: {
						male: 0.6,
						female: 0.4
					},
					anatomyPreference: {
						penisSize: "large",
						breastSize: "medium"
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},
	
		darian: {
			name: "Darian",
			defaultName: "Male Host",
			known: false,
			avatar: "images/portrait_darian.png",
			color: "white",
			bgColor: "rgba(126, 66, 0, 0.6)",
		
			trust: 3,
			affection: 0,
			rapport: 1.0,
			tension: 0,
			cooldown: 0,
		
			traits: ["Flirty", "Confident", "Charming"],
			inclinations: ["voyeurism", "exhibitionism", "praise", "gentle"],
			motivations: ["Pleasure", "Connection"],
			socialStyle: "Charming",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },

			body: {
				height: 70, // 5'10"
				breastSize: null,
				buttSize: 3, // "round"
				bodyType: 3, // "average"
				lipFullness: 3, // "full"
				skinTone: 5, // "deep brown"
				muscleTone: 4, // "defined"
				hipWidth: 2, // "modest"
				bodyHair: 1, // "light"
				voiceTone: "melodic",
				hairColor: "black",
				hairStyle: "short and soft",
				hairLength: "short",
				eyeColor: "warm brown",
				penisSize: 7 // inches – proportional, generous but not absurd
			},
		
			preferences: {
				sexualActs: {
					likes: [
						"Praise_G", "Kissing", "Oral_R", "Oral_G", "Cuddling", 
						"Vaginal_P", "Anal_P", "RomanticPlay", "SensualMassage"
					],
					dislikes: ["Degrade_G", "Choke_G", "Spank_G"]
				},
				bodyTypes: {
					likes: ["Curvy", "Average", "Fit", "Soft"],
					dislikes: ["Broad", "VeryTall"]
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "modest",
						breastSize: "full"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
		bert: {
			name: "Bert",
			defaultName: "Brothel Bartender",
			known: false,
			avatar: "images/portrait_bert.png",
			color: "white",
			bgColor: "rgba(74, 76, 69, 0.6)",
		
			trust: 0,
			affection: 0,
			rapport: 1.0,
			tension: 0,
			cooldown: 0,
		
			traits: ["Stoic", "Cynical", "Guarded"],
			inclinations: ["voyeurism", "abstinence"],
			motivations: ["Loyalty", "Devotion"],
			socialStyle: "Stoic",

			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 70, // 5'10"
				breastSize: null,
				buttSize: 2, // modest
				bodyType: 5, // thick
				lipFullness: 1, // narrow
				skinTone: 2, // golden
				muscleTone: 3, // athletic
				hipWidth: 1, // modest
				bodyHair: 2, // natural
				voiceTone: "raspy",
				hairColor: "black with graying at temples",
				hairStyle: "neatly parted",
				hairLength: "cropped",
				eyeColor: "iron gray",
				penisSize: 5.5 // statistically average, likely unused
			},
		
			preferences: {
				sexualActs: {
					likes: [],
					dislikes: ["Oral_G", "Oral_R", "Vaginal_P", "Anal_P", "Toys_Use", "Submit", "Dominate"]
				},
				bodyTypes: {
					likes: [],
					dislikes: []
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "irrelevant",
						breastSize: "irrelevant"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},

		redmarrow: {
			name: "Leopold Redmarrow",
			defaultName: "Bounty Hunter",
			known: false,
			avatar: "images/portrait_redmarrow.png", // You can swap in your actual filename
			color: "white",
			bgColor: "rgba(132, 54, 54, 0.75)",

			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,

			traits: ["Flashy", "Evasive", "Charismatic"],
			inclinations: ["performance", "control", "deception"],
			motivations: ["Reputation", "Comfort"],
			socialStyle: "Charming",

			pronouns: {
				subject: "he",
				object: "him",
				possessive: "his",
				reflexive: "himself",
				noun: "man"
			},

			body: {
				height: 71, // 5'11"
				breastSize: null,
				buttSize: 2, // "modest"
				bodyType: 3, // "average"
				lipFullness: 3, // "full"
				skinTone: "light olive",
				muscleTone: 2, // "fit"
				hipWidth: 2, // "modest"
				bodyHair: 1, // "light"
				voiceTone: "silken",
				hairColor: "rich chestnut brown",
				hairStyle: "slicked back under a wide-brimmed hat",
				hairLength: 3, // "short-medium"
				eyeColor: "hazel",
				penisSize: 6.5 // enough for bravado
			},

			preferences: {
				sexualActs: {
					likes: ["Praise_R", "Teasing", "Oral_R", "RomanticPlay"],
					dislikes: ["Submit", "Cuddling", "Anal_P"]
				},
				bodyTypes: {
					likes: ["Elegant", "Fit", "Mysterious"],
					dislikes: ["Disheveled", "OverlyMuscular"]
				},
				partners: {
					genderPreference: {
						male: 0.4,
						female: 0.6
					},
					anatomyPreference: {
						penisSize: "modest",
						breastSize: "medium"
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},

		brakka: {
			name: "Brakka",
			defaultName: "Half-Orc Fighter",
			known: false,
			avatar: "images/portrait_brakka.png", // Swap with actual path
			color: "white",
			bgColor: "rgba(85, 110, 73, 0.8)",

			trust: 0,
			affection: 0,
			rapport: 0.4,
			tension: 0,

			traits: ["Blunt", "Short-Tempered", "Independent"],
			inclinations: ["dominance", "violence", "solitude"],
			motivations: ["Strength", "Respect"],
			socialStyle: "Rough",

			pronouns: {
				subject: "she",
				object: "her",
				possessive: "her",
				reflexive: "herself",
				noun: "woman"
			},

			body: {
				height: 73, // 6'1"
				breastSize: 2, // "modest"
				buttSize: 2, // "modest"
				bodyType: 5, // "muscular"
				lipFullness: 2, // "modest"
				skinTone: "greenish bronze",
				muscleTone: 6, // "ripped"
				hipWidth: 2, // "modest"
				bodyHair: 2, // "natural"
				voiceTone: "gravelly",
				hairColor: "black",
				hairStyle: "shaved sides, top tied back",
				hairLength: 2, // "short"
				eyeColor: "amber"
			},

			preferences: {
				sexualActs: {
					likes: ["Dominate", "Spank_G", "WrestlePlay", "Teasing"],
					dislikes: ["Cuddling", "Praise_R", "Service"]
				},
				bodyTypes: {
					likes: ["Strong", "Lean", "Fit"],
					dislikes: ["Delicate", "OverlySoft"]
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "large",
						breastSize: "irrelevant"
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},

		sarjan: {
			name: "Sarjan",
			defaultName: "Dice Rat Leader",
			known: false,
			avatar: "images/portrait_sarjan.png", // Placeholder path
			color: "white",
			bgColor: "rgba(80, 40, 20, 0.85)",

			trust: -1,
			affection: 0,
			rapport: 0.3,
			tension: 0.6,

			traits: ["Crass", "Mocking", "Dominant"],
			inclinations: ["gambling", "taunting", "misogyny"],
			motivations: ["Control", "Entertainment"],
			socialStyle: "Brash",

			pronouns: {
				subject: "he",
				object: "him",
				possessive: "his",
				reflexive: "himself",
				noun: "man"
			},

			body: {
				height: 69, // 5'9"
				breastSize: null,
				buttSize: 2, // "modest"
				bodyType: 3, // "average"
				lipFullness: 1, // "narrow"
				skinTone: "sallow tan",
				muscleTone: 3, // "defined"
				hipWidth: 2, // "modest"
				bodyHair: 2, // "natural"
				voiceTone: "grating",
				hairColor: "dirty blonde",
				hairStyle: "greased back",
				hairLength: 2, // "short"
				eyeColor: "murky green",
				penisSize: 5.5
			},

			preferences: {
				sexualActs: {
					likes: ["Dominate", "Oral_R", "FaceSit", "Degrade_G"],
					dislikes: ["Submit", "Praise_G", "RomanticPlay"]
				},
				bodyTypes: {
					likes: ["Petite", "Curvy", "Busty"],
					dislikes: ["Muscular", "Androgynous"]
				},
				partners: {
					genderPreference: {
						male: 0.0,
						female: 1.0
					},
					anatomyPreference: {
						breastSize: "large",
						penisSize: null
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},


		/* Minor characters */
		diceratone: {
			name: "Dice Rat 1",
			defaultName: "Skinny Dice-Rat",
			known: false,
			avatar: "images/portrait_diceratone.png", // Placeholder path
			color: "white",
			bgColor: "rgba(182, 89, 2, 0.85)",
		},
		dicerattwo: {
			name: "Dice Rat 2",
			defaultName: "Fat Dice-Rat",
			known: false,
			avatar: "images/portrait_dicerattwo.png", // Placeholder path
			color: "white",
			bgColor: "rgba(182, 89, 2, 0.85)",
		},

	};
};
  
  /* Character Dialogue & Avatars - End */
/* twine-user-script #11: "05_sidebarlogic.js" */
setup.SidebarUI = {
	update() {
		if (!State.variables.player || !State.variables.world) {
			console.warn("SidebarUI: Player or World data missing.");
			return;
		}
		this.updateStatuses();
		this.updateCarryWeight();
		this.updateLevelAndExp();
		this.updateGold();
		this.updateTime();
		this.updateDate();
		this.updateWeather();
		this.updateSummaryIcons();
	},

	updateStatuses() {
		const status = State.variables.player.status;

		const bars = [
			{ id: "health", value: status.health, max: status.maxHealth },
			{ id: "fatigue", value: status.fatigue, max: status.maxFatigue },
			{ id: "composure", value: status.composure, max: status.maxComposure },
			{ id: "excitement", value: status.excitement, max: status.maxExcitement }
		];

		bars.forEach(bar => {
			const fill = document.getElementById(`${bar.id}-fill`);
			if (fill) {
				const percent = (bar.value / bar.max) * 100;
				fill.style.width = `${percent}%`;

				if (percent >= 70) {
					fill.style.background = "linear-gradient(90deg, #4caf50, #81c784)";
				} else if (percent >= 30) {
					fill.style.background = "linear-gradient(90deg, #ff9800, #ffc107)";
				} else {
					fill.style.background = "linear-gradient(90deg, #f44336, #e57373)";
				}
			}
		});
	},

	updateCarryWeight() {
		const weight = State.variables.player.carryWeight;
		const carryContainer = document.getElementById("sidebar-carryweight");
		const carryFill = document.getElementById("carry-fill");
		const carryText = document.getElementById("carryweight-text");

		const percent = (weight.current / weight.max) * 100;

		if (percent >= 85) {
			carryContainer.style.display = "block";
			carryFill.style.width = `${percent}%`;
			carryText.textContent = `Carryweight: ${weight.current}/${weight.max}`;
		} else {
			carryContainer.style.display = "none";
		}
	},

	updateLevelAndExp() {
		const player = State.variables.player;
		const expPercent = (player.experience / player.experienceToNextLevel) * 100;

		const expFill = document.getElementById("exp-fill");
		const expText = document.getElementById("exp-text");
		const levelText = document.getElementById("sidebar-level");

		if (expFill) expFill.style.width = `${expPercent}%`;
		if (expText) expText.textContent = `${player.experience}/${player.experienceToNextLevel} XP`;
		if (levelText) levelText.textContent = `Lvl ${player.level}`;

		const miniFill = document.getElementById("exp-fill-mini");
		const miniLevel = document.getElementById("summary-level");
		if (miniFill) miniFill.style.width = `${expPercent}%`;
		if (miniLevel) miniLevel.textContent = `Lvl ${player.level}`;
	},

	updateTime() {
		const world = State.variables.world;
		if (!world) return;

		const hours = world.hour;
		const minutes = world.minute.toString().padStart(2, "0");
		let timeString = "";

		if (world.is24HourFormat) {
			timeString = `${hours}:${minutes}`;
		} else {
			const suffix = hours >= 12 ? "PM" : "AM";
			const hour12 = ((hours + 11) % 12 + 1);
			timeString = `${hour12}:${minutes} ${suffix}`;
		}

		const timeDisplay = document.getElementById("sidebar-time");
		const timeSummary = document.getElementById("summary-time");

		if (timeDisplay) timeDisplay.textContent = timeString;
		if (timeSummary) timeSummary.textContent = timeString;
	},

	updateDate() {
		const world = State.variables.world;
		if (!world) return;

		const seasons = ["Rain", "Sun", "Harvest", "Snow"];
		const seasonIndex = Math.floor((world.dayOfYear - 1) / 100);
		const seasonDay = ((world.dayOfYear - 1) % 100) + 1;
		const seasonName = seasons[seasonIndex] || "Unknown";

		const dateString = `${seasonDay} of ${seasonName}, ${world.year} AI`;

		const dateDisplay = document.getElementById("sidebar-date");
		if (dateDisplay) dateDisplay.textContent = dateString;
	},

	updateWeather() {
		const world = State.variables.world;
		const icon = document.getElementById("sidebar-weather-icon");

		if (!icon) return;

		const weatherIcons = {
			"Clear": "sun",
			"Rain": "cloud-rain",
			"Storm": "cloud-lightning",
			"Snow": "snowflake",
			"Fog": "cloud-fog"
		};

		const weatherName = world.weather || "Clear";
		const iconName = weatherIcons[weatherName] || "sun";

		icon.setAttribute("data-lucide", iconName);
		icon.setAttribute("title", weatherName);

		if (window.lucide) {
			lucide.createIcons();
		}
	},

	updateSummaryIcons() {
		const status = State.variables.player.status;

		const icons = [
			{ id: "summary-health", fillId: "summary-health-fill", value: status.health, max: status.maxHealth },
			{ id: "summary-fatigue", fillId: "summary-fatigue-fill", value: status.fatigue, max: status.maxFatigue },
			{ id: "summary-composure", fillId: "summary-composure-fill", value: status.composure, max: status.maxComposure },
			{ id: "summary-excitement", fillId: "summary-excitement-fill", value: status.excitement, max: status.maxExcitement }
		];

		icons.forEach(icon => {
			const iconEl = document.getElementById(icon.id);
			const fillEl = document.getElementById(icon.fillId);
			const percent = Math.max(0, Math.min(100, (icon.value / icon.max) * 100));

			if (fillEl) {
				fillEl.style.height = `${percent}%`;
			}

			if (iconEl) {
				iconEl.classList.remove("low", "mid", "high");

				if (percent >= 70) {
					iconEl.classList.add("high");
					iconEl.style.filter = "drop-shadow(0 0 3px #4caf50cc)";
				} else if (percent >= 30) {
					iconEl.classList.add("mid");
					iconEl.style.filter = "drop-shadow(0 0 2px #ffc107cc)";
				} else {
					iconEl.classList.add("low");
					iconEl.style.filter = "drop-shadow(0 0 2px #f44336cc)";
				}
			}
		});
	},

	getGoldAmount() {
		const inventory = State.variables.inventory_player;
		if (!inventory) return 0;

		return inventory["gold_coin"] || 0;
	},

	updateGold() {
		const gold = this.getGoldAmount();
		const goldDisplay = document.getElementById("sidebar-gold-amount");
		const goldSummary = document.getElementById("summary-gold");

		const formattedGold = gold >= 1000 ? (gold / 1000).toFixed(1) + "K" : gold;

		if (goldDisplay) goldDisplay.textContent = formattedGold;
		if (goldSummary) goldSummary.textContent = formattedGold;
	},

	initialize() {
		console.log("[SidebarUI] Initializing SidebarUI...");
		const toggleButton = document.getElementById("sidebar-toggle");

		if (!toggleButton) {
			console.warn("[SidebarUI] Sidebar toggle button not found during initialize().");
			return;
		}

		toggleButton.addEventListener("click", () => {
			console.log("[SidebarUI] Collapse button clicked!");
			this.toggleSidebar();
		});

		this.startAutoRefresh();
		this.tryLucideIcons();
	},

	toggleSidebar() {
		const sidebar = document.getElementById("custom-sidebar");
		const arrow = document.getElementById("sidebar-arrow");
		const toggleButton = document.getElementById("sidebar-toggle");
		const summary = document.getElementById("sidebar-summary");
		const content = document.getElementById("sidebar-content");

		if (!sidebar || !summary || !content) {
			console.warn("[SidebarUI] Sidebar or required elements not found.");
			return;
		}

		sidebar.classList.toggle("collapsed");
		const isCollapsed = sidebar.classList.contains("collapsed");

		// Set class on <body>
		document.body.classList.toggle("sidebar-collapsed", isCollapsed);

		// Flip arrow
		if (arrow) {
			arrow.style.transform = isCollapsed ? "rotate(180deg)" : "rotate(0deg)";
		}

		// Fix toggle button position
		if (toggleButton) {
			toggleButton.style.position = isCollapsed ? "initial" : "fixed";
		}

		// Show/hide summary vs full content
		summary.style.display = isCollapsed ? "flex" : "none";
		content.style.display = isCollapsed ? "none" : "block";

		// Update all sidebar data (including summary icons)
		this.update();

		console.log(`[SidebarUI] Sidebar is now ${isCollapsed ? "collapsed" : "expanded"}.`);
	},


	startAutoRefresh() {
		if (this._refreshTimer) {
			clearInterval(this._refreshTimer);
		}
		this._refreshTimer = setInterval(() => {
			this.updateSidebar();
		}, 1000);
	},

	updateSidebar() {
		const player = State.variables.player;
		const world = State.variables.world;
		const inventory = State.variables.inventory || [];

		if (!player || !world) {
			console.warn("[SidebarUI] Player or WorldState missing — cannot update sidebar.");
			return;
		}

		this.updateText("sidebar-time", this.formatWorldTime(world.hour, world.minute, world.is24HourFormat));
		this.updateText("sidebar-date", this.formatWorldDate(world.dayOfYear, world.year));
		this.updateText("sidebar-location", world.locationName || "Unknown Location");

		this.updateWeatherIcon(world.weather);

		const goldAmount = this.findGoldAmount(inventory);
		this.updateText("sidebar-gold-amount", goldAmount);
		this.updateText("summary-gold", this.abbreviateGold(goldAmount));

		this.updateText("summary-level", `Lvl ${player.level}`);
		this.updateExpBars(player);
		this.updateStatusBars(player);

		this.updateStatusIcon("summary-health", player.status.health, player.status.maxHealth);
		this.updateStatusIcon("summary-fatigue", player.status.fatigue, player.status.maxFatigue, true);
		this.updateStatusIcon("summary-composure", player.status.composure, player.status.maxComposure);
		this.updateStatusIcon("summary-excitement", player.status.excitement, player.status.maxExcitement);

		this.updateConditionalStatusIcons(player.status);
	},

	updateText(id, text) {
		const el = document.getElementById(id);
		if (el) el.textContent = text;
	},

	updateWeatherIcon(weatherType) {
		const icon = document.getElementById("sidebar-weather-icon");
		if (!icon) return;

		const weatherIcons = {
			"Clear": "sun",
			"Rain": "cloud-rain",
			"Storm": "cloud-lightning",
			"Snow": "cloud-snow",
			"Fog": "cloud-fog"
		};

		const iconName = weatherIcons[weatherType] || "sun";
		icon.setAttribute("data-lucide", iconName);

		if (window.lucide) {
			lucide.createIcons();
		}
	},

	findGoldAmount(inventory) {
		const goldItem = inventory.find(item => item.key === "gold_coin");
		return goldItem ? goldItem.amount : 0;
	},

	abbreviateGold(amount) {
		if (amount >= 1000000) return (amount / 1000000).toFixed(1) + "M";
		if (amount >= 1000) return (amount / 1000).toFixed(1) + "K";
		return amount.toString();
	},

	updateExpBars(player) {
		const percent = Math.min((player.experience / player.experienceToNextLevel) * 100, 100);
		const mainFill = document.getElementById("exp-fill");
		const miniFill = document.getElementById("exp-fill-mini");

		if (mainFill) mainFill.style.width = `${percent}%`;
		if (miniFill) miniFill.style.width = `${percent}%`;

		this.updateText("exp-text", `${player.experience}/${player.experienceToNextLevel} XP`);
	},

	updateStatusBars(player) {
		this.setFillWidth("health-fill", (player.status.health / player.status.maxHealth) * 100);
		this.setFillWidth("fatigue-fill", (player.status.fatigue / player.status.maxFatigue) * 100);
		this.setFillWidth("composure-fill", (player.status.composure / player.status.maxComposure) * 100);
		this.setFillWidth("excitement-fill", (player.status.excitement / player.status.maxExcitement) * 100);
	},

	setFillWidth(id, percent) {
		const fill = document.getElementById(id);
		if (fill) {
			fill.style.width = `${Math.min(Math.max(percent, 0), 100)}%`;
		}
	},

	updateStatusIcon(iconId, current, max, inverse = false) {
		const icon = document.getElementById(iconId);
		if (!icon) return;

		const ratio = current / max;
		let color = "white";

		if (inverse) {
			if (ratio >= 0.75) color = "red";
			else if (ratio >= 0.5) color = "orange";
			else color = "green";
		} else {
			if (ratio <= 0.25) color = "red";
			else if (ratio <= 0.5) color = "orange";
			else color = "green";
		}

		icon.style.stroke = color;
	},

	updateConditionalStatusIcons(status) {
		const container = document.getElementById("summary-conditions");
		if (!container) return;

		container.innerHTML = "";

		const effects = [
			{ key: "poisoned", icon: "skull" },
			{ key: "intoxicated", icon: "glass-water" },
			{ key: "charmed", icon: "heart-handshake" },
			{ key: "burning", icon: "flame" },
			{ key: "bleeding", icon: "droplet" },
			{ key: "stunned", icon: "zap-off" }
		];

		effects.forEach(effect => {
			if (status[effect.key]) {
				const newIcon = document.createElement("i");
				newIcon.setAttribute("data-lucide", effect.icon);
				newIcon.style.width = "16px";
				newIcon.style.height = "16px";
				container.appendChild(newIcon);
			}
		});

		if (window.lucide) {
			lucide.createIcons();
		}
	},

	formatWorldTime(hour, minute, is24h) {
		if (is24h) {
			return `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}`;
		} else {
			const ampm = hour >= 12 ? "PM" : "AM";
			const h12 = hour % 12 || 12;
			return `${h12}:${minute.toString().padStart(2, "0")} ${ampm}`;
		}
	},

	formatWorldDate(dayOfYear, year) {
		const seasons = ["Rain", "Sun", "Harvest", "Snow"];
		const seasonLength = 100;
		const seasonIndex = Math.floor((dayOfYear - 1) / seasonLength);
		const seasonDay = ((dayOfYear - 1) % seasonLength) + 1;
		const season = seasons[seasonIndex] || "Unknown";

		return `${seasonDay} of ${season}, ${year} AI`;
	},

	tryLucideIcons() {
		if (typeof lucide !== "undefined") {
			lucide.createIcons();
			console.log("[SidebarUI] Lucide icons rendered successfully!");
		} else {
			console.warn("[SidebarUI] Lucide not ready yet — retrying in 250ms...");
			setTimeout(this.tryLucideIcons, 250);
		}
	}
};

  
  $(document).on(":storyready", () => {
	const btn = document.getElementById("btn-saves");
	if (btn) {
		btn.addEventListener("click", () => {
			console.log("[DEBUG] Save button clicked.");
			if (typeof Dialog === "undefined") {
				console.error("[ERROR] Dialog object is not defined.");
			} else {
				console.log("[DEBUG] Dialog.open available:", typeof Dialog.open);
				UI.saves();
			}
		});
		if (window.lucide) lucide.createIcons();
	} else {
      console.error("[ERROR] Save button not found");
    }

	// Ensure UI system is initialized only after DOM is ready
	if (typeof UI !== "undefined" && typeof UI.init === "function") {
		console.log("[DEBUG] Calling UI.init()");
		UI.init();
	} else {
		console.error("[ERROR] UI.init is not available.");
	}
});



/* twine-user-script #12: "06_loader.js" */
(() => {
	function getMessage(O) {
		if (O == null) return 'unknown error';
		return typeof O === 'object' && 'message' in O ? O.message : String(O);
	}

	Story.lookup('tags', 'style').forEach((p, i) => {
		try {
			const swrap = new StyleWrapper(document.createElement('style'));
			swrap.add(Scripting.evalJavaScript('`' + p.text.trim() + '`'));
			jQuery(swrap.style).appendTo(document.head).attr({
				id: `style-story-extra-${i}`,
				name: p.title,
				type: 'text/css'
			});
		} catch (ex) {
			console.error(ex);
			Alert.error(p.name, getMessage(ex));
		}
	});

	Story.lookup('tags', 'script').forEach(p => {
		try {
			Scripting.evalJavaScript(p.text);
		} catch (ex) {
			console.error(ex);
			Alert.error(p.name, getMessage(ex));
		}
	});
})();
/* twine-user-script #13: "07_lucide.js" */
var lucideScript = document.createElement('script');
lucideScript.src = 'https://unpkg.com/lucide@latest';
lucideScript.onload = function () {
	console.log("✅ Lucide icons loaded.");
	window.lucideReady = true;
};
document.head.appendChild(lucideScript);

function renderLucideIconsSafely() {
	console.log("🔄 Attempting to render Lucide icons...");
	if (window.lucideReady && window.lucide && window.lucide.createIcons) {
		console.log("✅ Lucide is ready — rendering icons now.");
		window.lucide.createIcons();
	} else {
		console.log("⏳ Lucide not ready yet... retrying in 50ms");
		setTimeout(renderLucideIconsSafely, 50);
	}
}
/* twine-user-script #14: "08_debugTools.js" */
postdisplay["logItemData"] = function () {
	if (setup.ItemData) {
		console.log("📦 Available items:", Object.keys(setup.ItemData));
	} else {
		console.error("❌ setup.ItemData is not defined.");
	}
};
/* twine-user-script #15: "01_InventoryLibrary.js" */
/* =============================
= ITEM METADATA LOADER - START =
============================= */
if (typeof setup === 'undefined') {
	setup = {};
}
if (typeof setup.ItemData === 'undefined') {
	setup.ItemData = {};
}
/* =============================
=     Weapons - Daggers     =
============================= */
setup.ItemData.dagger_silver = {
  id: "longsword_silver",
  name: "Silvered Dagger",
  type: "weapon",
  subtype: "dagger",
  tags: ["piercing", "1H", "anti-undead"],
  material: "Silver",
  rarity: 1,
  damage: { piercing:[3,6]},
  weight: 1.5,
  value: 450,
  img: "weapon_dagger_silver.png",
  description: "A silver-plated longsword favored by monster hunters. Effective against undead."
};

/* =============================
=     Weapons - Longswords     =
============================= */
setup.ItemData.test_longsword = {
  id: "test_longsword",
  name: "TEST_Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "1H", "devOnly"],
  material: "Debugium",
  rarity: 0,
  damage: { slashing: 1 },
  weight: 1.0,
  value: 0,
  img: "default.png",
  description: "Developer test item. Should never appear in gameplay."
};
setup.ItemData.longsword_wood = {
  id: "longsword_wood",
  name: "Wooden Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H"],
  material: "Wood",
  rarity: 1,
  damage: { slashing: 1, blunt: 1 },
  weight: 4.5,
  value: 35,
  img: "longsword_wood.png",
  description: "A crude longsword carved from hardwood. Splinters easily but better than bare fists."
};
setup.ItemData.longsword_iron = {
  id: "longsword_iron",
  name: "Iron Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H"],
  material: "Iron",
  rarity: 1,
  damage: { slashing: 4, piercing: 2 },
  weight: 6.0,
  value: 120,
  img: "longsword_iron.png",
  description: "A basic iron longsword. Cheap, functional, and widely available."
};
setup.ItemData.longsword_steel = {
  id: "longsword_steel",
  name: "Steel Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H"],
  material: "Steel",
  rarity: 1,
  damage: { slashing: 6, piercing: 3 },
  weight: 5.5,
  value: 280,
  img: "longsword_steel.png",
  description: "A dependable steel blade with a good balance of weight and edge."
};
setup.ItemData.longsword_silver = {
  id: "longsword_silver",
  name: "Silvered Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "anti-undead"],
  material: "Silver",
  rarity: 1,
  damage: { slashing: 6, piercing: 4 },
  weight: 5.5,
  value: 750,
  img: "longsword_silver.png",
  description: "A silver-plated longsword favored by monster hunters. Effective against undead."
};
setup.ItemData.longsword_mithril = {
  id: "longsword_mithril",
  name: "Mithril Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "lightweight"],
  material: "Mithril",
  rarity: 1,
  damage: { slashing: 12, piercing: 10 },
  weight: 2.5,
  value: 5555,
  img: "longsword_mithril.png",
  description: "An elegantly forged mithril blade—light as air, sharp as steel."
};
setup.ItemData.longsword_adamantine = {
  id: "longsword_adamantine",
  name: "Adamantine Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "armor-piercing"],
  material: "Adamantine",
  rarity: 1,
  damage: { slashing: 14, piercing: 9 },
  weight: 7.0,
  value: 6000,
  img: "longsword_adamantine.png",
  description: "A heavy, unyielding blade forged from adamantine. Ideal for cleaving through armor."
};
setup.ItemData.longsword_obsidian = {
  id: "longsword_obsidian",
  name: "Obsidian Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "brittle"],
  material: "Obsidian",
  rarity: 1,
  damage: { slashing: 12, piercing: 4 },
  weight: 5.0,
  value: 420,
  img: "longsword_obsidian.png",
  description: "Forged from volcanic glass. Razor sharp but fragile—handle with care."
};
setup.ItemData.longsword_eldwood = {
  id: "longsword_eldwood",
  name: "Eldwood Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "nature-attuned", "lightweight"],
  material: "Eldwood",
  rarity: 1,
  damage: { slashing: 7, piercing: 5 },
  weight: 2.5,
  value: 400,
  img: "longsword_eldwood.png",
  description: "Made from magically reinforced Eldwood. Lighter than steel and flexible."
};
setup.ItemData.longsword_starforged = {
  id: "longsword_starforged",
  name: "Starforged Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "magic-conductive"],
  material: "Starforged Alloy",
  rarity: 1,
  damage: { slashing: 18, piercing: 12 },
  weight: 4.0,
  value: 11480,
  img: "longsword_starforged.png",
  description: "Forged from metal fallen from the stars. Emits a faint, pulsing energy."
};

/* =============================
=        Weapons - Spears      =
============================= */
setup.ItemData.spear_wood = {
  id: "spear_wood",
  name: "Wooden Spear",
  type: "weapon",
  subtype: "spear",
  tags: ["piercing", "2H", "reach"],
  material: "Wood",
  rarity: 1,
  damage: { piercing: 2 },
  weight: 4.0,
  value: 30,
  img: "spear_wood.png",
  description: "A long wooden shaft sharpened to a point. Basic, but effective at range."
};
setup.ItemData.spear_obsidian = {
	id: "spear_obsidian",
	name: "Obsidian Spear",
	type: "weapon",
	subtype: "spear",
	tags: ["piercing", "2H", "reach", "brittle"],
	material: "Obsidian",
	rarity: 1,
	damage: { piercing: 11, slashing: 1 },
	weight: 4.5,
	value: 390,
	img: "spear_obsidian.png",
	description: "A razor-sharp obsidian tip gives this spear excellent cutting power—if it doesn't shatter."
};
setup.ItemData.spear_eldwood = {
	id: "spear_eldwood",
	name: "Eldwood Spear",
	type: "weapon",
	subtype: "spear",
	tags: ["piercing", "2H", "reach", "nature-attuned", "lightweight"],
	material: "Eldwood",
	rarity: 1,
	damage: { piercing: 9 },
	weight: 2.8,
	value: 390,
	img: "spear_eldwood.png",
	description: "Light, flexible, and magically attuned to natural energies. A favorite of forest guardians."
};
setup.ItemData.spear_starforged = {
	id: "spear_starforged",
	name: "Starforged Spear",
	type: "weapon",
	subtype: "spear",
	tags: ["piercing", "2H", "reach", "magic-conductive"],
	material: "Starforged Alloy",
	rarity: 1,
	damage: { piercing: 16, slashing: 2 },
	weight: 3.8,
	value: 11000,
	img: "spear_starforged.png",
	description: "A sleek weapon of alien alloy, humming faintly with arcane resonance."
};

/* =============================
=          Armor Items         =
============================= */
setup.ItemData.test_helmet = {
	id: "test_helmet",
	name: "TEST_Helmet",
	type: "armor",
	subtype: "helmet",
	tags: ["head", "light", "devOnly"],
	material: "Debugium",
	rarity: 0,
	resist: { slashing: 1, blunt: 1 },
	weight: 0.5,
	value: 0,
	img: "default.png",
	description: "Developer test helmet. Not for actual use."
};

/* =============================
=      Consumable Items        =
============================= */
setup.ItemData.test_snack = {
	id: "test_snack",
	name: "TEST_Snack",
	type: "consumable",
	subtype: "food",
	tags: ["healing", "devOnly"],
	stats: { health: 1, energy: 1 },
	weight: 0.1,
	value: 0,
	img: "default.png",
	description: "Consumable test item. Used for system validation."
};
/* =============================
=      Literature Items        =
============================= */
 setup.ItemData["scroll_firebolt"] = {
	id: "scroll_firebolt",
	name: "Scroll of Firebolt",
	type: "literature",
	subtype: "scroll",
	tags: ["magic", "single-use", "spell"],
	weight: 0.1,
	value: 35,
	img: "scroll_firebolt.png",
	description: "A tightly rolled parchment containing the incantation for Firebolt.",
	effects: "Casts Firebolt when read. Consumed upon use."
};
 
  
/* =============================
=       Quest Items            =
============================= */
setup.ItemData.test_scroll = {
	id: "test_questscroll",
	name: "TEST_QuestScroll",
	type: "quest",
	subtype: "debug",
	tags: ["quest", "devOnly"],
	weight: 0.0,
	value: 0,
	img: "default.png",
	description: "Placeholder scroll for quest system testing."
};

/* =============================
=         Misc Items           =
============================= */
setup.ItemData.test_token = {
	id: "test_token",
	name: "TEST_Token",
	type: "misc",
	subtype: "debug",
	tags: ["trinket", "devOnly"],
	weight: 0.2,
	value: 0,
	img: "default.png",
	description: "Debug token for inventory/UI validation. Not obtainable."
};
setup.ItemData.gold_coin = {
	id: "gold_coin",
	name: "Gold Coin",
	type: "misc",
	subtype: "currency",
	tags: ["currency", "non-negotiable"],
	weight: 0.01,
	value: 1,
	img: "default.png",
	description: "A single gold coin. Stamped and standardized. Its value never fluctuates.",
	fixedValue: true
};
setup.ItemData.lucky_horseshoe = {
	id: "lucky_horseshoe",
	name: "Lucky Horseshoe",
	type: "misc",
	subtype: "curio",
	tags: ["trinket", "buff-lucky"],
	weight: 0.3,
	value: 10,
	img: "default.png",
	description: "A slightly bent iron horseshoe said to bring good fortune to its bearer.",
	effects: "Grants the 'Lucky' buff while in inventory. Increases favorability of dice rolls."
};

/* =============================
=       Crown Dice Items       =
============================= */
setup.ItemData.crown_die_balanced = {
	id: "crown_die_balanced",
	name: "Balanced Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "balanced"],
	weight: 0.1,
	value: 50,
	img: "default.png",
	description: "A perfectly balanced eight-sided die made from polished bone. Standard d8 probabilities.",
	roll() {
		return Math.ceil(Math.random() * 8);
	}
};

setup.ItemData.crown_die_even_weighted = {
	id: "crown_die_even_weighted",
	name: "Even-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "even-weighted"],
	weight: 0.1,
	value: 120,
	img: "default.png",
	description: "A crown die with subtle weight distribution favoring even numbers (2, 4, 6, 8).",
	roll() {
		const rand = Math.random();
		// 60% chance for even numbers (2,4,6,8), 40% for odd (1,3,5,7)
		if (rand < 0.6) {
			return [2, 4, 6, 8][Math.floor(Math.random() * 4)];
		} else {
			return [1, 3, 5, 7][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_odd_weighted = {
	id: "crown_die_odd_weighted",
	name: "Odd-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "odd-weighted"],
	weight: 0.1,
	value: 120,
	img: "default.png",
	description: "A crown die with subtle weight distribution favoring odd numbers (1, 3, 5, 7).",
	roll() {
		const rand = Math.random();
		// 60% chance for odd numbers (1,3,5,7), 40% for even (2,4,6,8)
		if (rand < 0.6) {
			return [1, 3, 5, 7][Math.floor(Math.random() * 4)];
		} else {
			return [2, 4, 6, 8][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_high_weighted = {
	id: "crown_die_high_weighted",
	name: "High-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "high-weighted"],
	weight: 0.1,
	value: 180,
	img: "default.png",
	description: "A crown die weighted to favor higher numbers (5, 6, 7, 8).",
	roll() {
		const rand = Math.random();
		// 65% chance for high numbers (5,6,7,8), 35% for low (1,2,3,4)
		if (rand < 0.65) {
			return [5, 6, 7, 8][Math.floor(Math.random() * 4)];
		} else {
			return [1, 2, 3, 4][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_low_weighted = {
	id: "crown_die_low_weighted",
	name: "Low-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "low-weighted"],
	weight: 0.1,
	value: 180,
	img: "default.png",
	description: "A crown die weighted to favor lower numbers (1, 2, 3, 4).",
	roll() {
		const rand = Math.random();
		// 65% chance for low numbers (1,2,3,4), 35% for high (5,6,7,8)
		if (rand < 0.65) {
			return [1, 2, 3, 4][Math.floor(Math.random() * 4)];
		} else {
			return [5, 6, 7, 8][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_lucky = {
	id: "crown_die_lucky",
	name: "Lucky Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "lucky", "rare"],
	weight: 0.1,
	value: 300,
	img: "default.png",
	description: "A rare crown die carved from lucky stone. Slightly favors rolling 7s and 8s.",
	roll() {
		const rand = Math.random();
		// 30% chance for 7 or 8, 70% for normal distribution
		if (rand < 0.15) {
			return 7;
		} else if (rand < 0.30) {
			return 8;
		} else {
			return Math.ceil(Math.random() * 8);
		}
	}
};

console.log("✅ ItemData loaded:", Object.keys(setup.ItemData));
/* =============================
= ITEM METADATA LOADER - END =
============================= */
/* twine-user-script #16: "02_InventorySystem.js" */

/* Utility: Find item metadata from unified pool */
function getItemMetadata(id) {
	debugLog(`📦 getItemMetadata() called with id: '${id}'`);

	if (!setup.ItemData) {
		console.error("❌ setup.ItemData is undefined!");
		return null;
	}

	const item = setup.ItemData[id];
	if (!item) {
		console.warn(`⚠️ Item '${id}' NOT found in setup.ItemData.`);
		return null;
	}

	debugLog(`✅ Item '${id}' found in setup.ItemData:`, item);
	return item;
}
window.getItemMetadata = getItemMetadata;

/* Inventory Column Templates */
setup.inventoryHeaders = {
	all: ["Item Name", "Type", "Weight", "Value", "Amount"],
	weapons: ["Item Name", "Subtype", "Damage", "Weight", "Value", "Amount"],
	armor: ["Item Name", "Slot", "Armor Value", "Armor Class", "Weight", "Value", "Amount"],
	consumable: ["Item Name", "Consumable Type", "Affected Stats", "Stat Amounts", "Weight", "Value", "Amount"],
	quest: ["Item Name", "Subtype", "Weight", "Value", "Amount"],
	misc: ["Item Name", "Subtype", "Weight", "Value", "Amount"]
};

/* Highlight Active Inventory Tab */
setup.selectInventoryTab = function(category) {
	document.querySelectorAll(".inv-tab").forEach(btn => btn.classList.remove("active"));
	const active = document.querySelector(`.inv-tab[data-tab="${category}"]`);
	if (active) active.classList.add("active");

	setup.renderInventory("player", category);
};

/* Format Helpers */
setup.renderDamageIcons = function(damage) {
	if (!damage) return "";
	return Object.entries(damage).map(([type, val]) => `|${type}| ${val}`).join(" ");
};

setup.renderStatEffects = function(effects) {
	if (!effects) return "";
	return Object.entries(effects).map(([stat, val]) => `|${stat}| ${val}`).join(" ");
};

/* Macro: Add or Subtract Items from Inventory */
/* Structure: <<additem "target" "itemId" amount>> */
/* Example usage: <<additem "player" "gold_coin" 100>> */
Macro.add("additem", {
	handler() {
		console.log("🔥 [additem] macro invoked — args:", this.args);

		const [target, itemId, amountRaw] = this.args;
		const amount = parseInt(amountRaw);

		if (!target || !itemId || isNaN(amount)) {
			console.warn("⚠️ [additem] called with invalid or missing arguments:", this.args);
			console.warn("⚠️ Expected usage: additem 'target' 'itemId' amount — skipping execution.");
			return;
		}

		const itemData = getItemMetadata(itemId);
		if (!itemData) {
			console.warn(`⚠️ Item '${itemId}' not found in metadata — cannot add to inventory.`);
			return;
		}

		const varName = `inventory_${target}`;
		if (!State.variables[varName]) {
			debugLog(`📦 No inventory found for '${target}' — creating new one`);
			State.variables[varName] = {};
		}

		const inventory = State.variables[varName];

		if (!inventory[itemId]) {
			inventory[itemId] = 0;
			debugLog(`📦 Initializing '${itemId}' to 0 in '${target}' inventory`);
		}

		inventory[itemId] += amount;
		debugLog(`➕ '${itemId}' in '${target}' inventory is now: ${inventory[itemId]}`);

		if (inventory[itemId] <= 0) {
			debugLog(`🗑️ '${itemId}' count zero or below — removing from inventory`);
			delete inventory[itemId];
		}

		/* === Sidebar update on run === */
		if (setup.SidebarUI?.update) {
			setup.SidebarUI.update();
		}
	}
});


/* Drop Button Logic - Start */
function dropCustomAmount() {
	const amount = prompt("How many do you want to drop?");
	const parsed = parseInt(amount);
	if (!isNaN(parsed) && parsed > 0) {
		console.log(`🗑️ Would drop ${parsed} item(s) — placeholder logic`);
		// TODO: Hook into additem with negative value
	} else {
		alert("Invalid number.");
	}
}
/* Drop Button Logic - End */

/* Renderer: Inventory Display */
setup.renderInventory = function (target = "player", category = "all") {
	debugLog(`🧾 renderInventory() for '${target}' — Category: '${category}'`);

	const inventory = State.variables[`inventory_${target}`];
	if (!inventory) {
		console.warn(`⚠️ No inventory found for '${target}'`);
		return `<tr><td colspan="6"><em>Inventory is empty.</em></td></tr>`;
	}

	const tableBody = document.getElementById("inventory-list");
	const tableHead = document.querySelector("#inventory-table thead tr");

	if (!tableBody || !tableHead) {
		console.warn("⚠️ Table structure not found.");
		return;
	}

	// Reset table head
	tableHead.innerHTML = "";
	const headers = setup.inventoryHeaders[category] || setup.inventoryHeaders["all"];
	headers.forEach(h => {
		const th = document.createElement("th");
		th.textContent = h;
		tableHead.appendChild(th);
	});

	// Reset body
	tableBody.innerHTML = "";
	let itemsShown = 0;

	for (const itemId in inventory) {
		const quantity = inventory[itemId];
		const item = getItemMetadata(itemId);
		if (!item) continue;

		if (category !== "all" && item.type !== category && item.subtype !== category) {
			continue;
		}

		const tr = document.createElement("tr");
		tr.classList.add("inventory-row");
		tr.dataset.itemId = item.id;

		// Row content per category
		let rowHTML = "";

		switch (category) {
			case "weapons":
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.subtype || ""}</td>`;
				rowHTML += `<td>${setup.renderDamageIcons(item.damage)}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;

			case "armor":
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.slot || "—"}</td>`;
				rowHTML += `<td>${setup.renderDamageIcons(item.armor || {})}</td>`;
				rowHTML += `<td>${item.armorClass || "Unarmored"}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;

			case "consumable":
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.subtype || ""}</td>`;
				rowHTML += `<td>${setup.renderStatEffects(item.effects)}</td>`;
				rowHTML += `<td>${setup.renderStatEffects(item.effects)}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;

			default:
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.subtype || item.type}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;
		}

		tr.innerHTML = rowHTML;
		tableBody.appendChild(tr);
		itemsShown++;
	}

	if (itemsShown === 0) {
		tableBody.innerHTML = `<tr><td colspan="${headers.length}"><em>No items in this category.</em></td></tr>`;
	}
};

/* Condensed Paperdoll Support */
setup.updateCondensedPaperdoll = function () {
  const equipped = State.variables.equipped || {};

  const slotMap = [
    "head", "face", "neck", "back", "chest", "main", "sec",
    "pants", "feet", "ring1", "ring2", "ring3"
  ];

  // Standard slots
  slotMap.forEach(slot => {
    const el = document.getElementById(`slot-${slot}-text`);
    if (el) {
      const item = equipped[slot];
      el.textContent = item ? item.name || item.id : "Empty";
    }
  });

  // Special case: gloves (shared)
  const glovesEl = document.getElementById(`slot-gloves-text`);
  if (glovesEl) {
    const gloveItem = equipped["gloves"];
    glovesEl.textContent = gloveItem ? gloveItem.name || gloveItem.id : "Empty";
  }
};

document.addEventListener("DOMContentLoaded", () => {
  if (setup.updateCondensedPaperdoll) setup.updateCondensedPaperdoll();
});


/* =============================== */
/* Carryweight Logic Implemenation */
/* =============================== */
setup.calculateMaxCarryWeight = function () {
	const strength = State.variables.player?.attributes?.strength || 1;
	return 30 + (strength * 5); // 30 base + 5 per Strength point
};

setup.calculateInventoryWeight = function (target = "player") {
	const inventory = State.variables[`inventory_${target}`];
	if (!inventory) return 0;

	let totalWeight = 0;

	for (const itemId in inventory) {
		const item = getItemMetadata(itemId);
		const amount = inventory[itemId];

		if (item?.weight) {
			totalWeight += item.weight * amount;
		}
	}

	return totalWeight;
};

setup.updatePlayerCarryWeight = function () {
	const player = State.variables.player;
	if (!player) return;

	const currentWeight = setup.calculateInventoryWeight("player");
	const maxWeight = setup.calculateMaxCarryWeight();

	player.carryWeight = {
		current: currentWeight,
		max: maxWeight
	};
};



window.setup = setup;
/* twine-user-script #17: "03_overlayManager.js" */
window.openOverlay = function (source) {
	const body = document.getElementById("overlay-body");
	if (!body) return;

	body.innerHTML = "";

	const normalized = source.toLowerCase();

	// Force file-based overlays for naming conventions like -page or -sheet
	if (normalized.endsWith(".html") || normalized.includes("-page") || normalized.includes("-sheet")) {
		const filename = normalized.endsWith(".html") ? normalized : `${normalized}.html`;
		setup.loadOverlayHTML("overlay-body", filename);
	} else {
		new Wikifier(body, `<<include [[${source}]]>>`);
	}

	document.getElementById("overlay-panel").classList.remove("overlay-hidden");
	renderLucideIconsSafely?.();
};


window.closeOverlay = function () {
	const panel = document.getElementById("overlay-panel");
	if (!panel) return;
	panel.classList.add("overlay-hidden");
	document.getElementById("overlay-body").innerHTML = "";
};

setup.loadOverlayHTML = async function (overlayId, filename) {
	const container = document.getElementById(overlayId);
	if (!container) {
		console.warn(`❌ Could not find element #${overlayId}`);
		return;
	}

	try {
		const response = await fetch(`overlays/${filename}`);
		const html = await response.text();
		container.innerHTML = html;

		// Re-run Lucide icon rendering if needed
		if (window.lucide) lucide.createIcons();
	} catch (err) {
		console.error(`❌ Error loading overlay file '${filename}':`, err);
	}
};
/* twine-user-script #18: "04_PassageInjector.js" */
// ===============================
//  Move Rendered Passage Content into #text-backdrop (Prose Mode Only)
// ===============================

$(document).on(':passagerender', function () {
	// Optional: Disable transition glitch on initial load
	document.body.classList.add("rendering");

	setTimeout(function () {
		const passage = document.querySelector('#passages > .passage');
		const backdrop = document.getElementById('text-backdrop');

		if (!passage || !backdrop) {
			console.warn("⚠️ Could not move passage content:", {
				passageFound: !!passage,
				backdropFound: !!backdrop
			});
			document.body.classList.remove("rendering");
			return;
		}

		// Skip layout injection if it's handled by the dialogue system
		const isDialogue = passage.innerHTML.includes("StartDialogueLayout");
		if (isDialogue) {
			console.log("[PassageInjector] Skipping injection (dialogue layout will take over)");
			document.body.classList.remove("rendering");
			return;
		}

		backdrop.innerHTML = "";       // Clear old content
		backdrop.appendChild(passage); // Physically move the rendered content
		if (!setup.prefersReducedMotion?.()) {
			backdrop.scrollTo({ top: 0, behavior: "smooth" });
		} else {
			backdrop.scrollTop = 0;
		}


		// Sync sidebar layout class with actual state
		const sidebar = document.getElementById("custom-sidebar");
		if (sidebar) {
			if (sidebar.classList.contains("collapsed")) {
				document.body.classList.add("sidebar-collapsed");
			} else {
				document.body.classList.remove("sidebar-collapsed");
			}
		}

		document.body.classList.remove("rendering");
	}, 0);
});


// ===============================
//  Update Sidebar Summary (Unrelated to Dialogue)
// ===============================
$(document).on(':passagedisplay', function () {
	if (window.setup?.SidebarUI?.updateSummary) {
		setup.SidebarUI.updateSummary();
	}
});
/* twine-user-script #19: "05_BackgroundSystem.js" */
$(document).on(':passagedisplay', function () {
	const bgDiv = document.getElementById("background-image");

	// If no new background was set, fallback to default
	if (!State.variables.bgImageSetThisPassage) {
		State.variables.bgImage = "images/background_default.png";
	}

	const url = State.variables.bgImage;
	if (bgDiv) {
		bgDiv.style.backgroundImage = `url('${url}')`;
	}

	// Reset flag for next passage
	delete State.variables.bgImageSetThisPassage;
});
/* twine-user-script #20: "06_ShopSystem.js" */
setup.ShopSystem = {
  activeCategory: "all",

  renderBothInventories(category = "all") {
    this.activeCategory = category;
    this.renderInventory("player", category);
    this.renderInventory("shop", category);
    this.updateTabHighlight(category);
  },

  renderInventory(source, category) {
    const inventory = State.variables[`inventory_${source}`];
    const tableId = source === "shop" ? "shop-inventory-list" : "player-inventory-list";
    const tableBody = document.getElementById(tableId);

    tableBody.innerHTML = "";
    const filteredItems = this.getFilteredItems(source, category);

    filteredItems.forEach(({ id, quantity }) => {
      const item = getItemMetadata(id);
      const row = document.createElement("tr");
      row.dataset.itemId = id;
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.type}</td>
        <td>${item.weight}</td>
        <td>${item.value}</td>
        <td>x${quantity}</td>
      `;
      row.onclick = () => this.toggleSelection(source, id);
      tableBody.appendChild(row);
    });
  },

  getFilteredItems(source, category) {
    const inventory = State.variables[`inventory_${source}`] || {};
    const results = [];
    for (const id in inventory) {
      const item = getItemMetadata(id);
      if (!item) continue;
      if (category === "all" || item.type === category || item.subtype === category) {
        results.push({ id, quantity: inventory[id] });
      }
    }
    return results;
  },

  toggleSelection(source, itemId) {
    const key = `pending_${source}`;
    const pending = State.temporary[key] || (State.temporary[key] = {});
    pending[itemId] = !pending[itemId];
    this.refreshVisuals();
  },

  refreshVisuals() {
    this.renderInventory("player", this.activeCategory);
    this.renderInventory("shop", this.activeCategory);
  },

  confirmTransaction() {
    const shopInv = State.variables.inventory_shop;
    const playerInv = State.variables.inventory_player;
    const pendingShop = State.temporary.pending_shop || {};
    const pendingPlayer = State.temporary.pending_player || {};

    let playerGold = State.variables.player_gold;
    let shopGold = State.variables.shop_gold;

    // Buying from shop
    for (const id in pendingShop) {
      if (!pendingShop[id]) continue;
      const item = getItemMetadata(id);
      if (!item) continue;
      if (playerGold >= item.value) {
        shopInv[id] = (shopInv[id] || 0) - 1;
        playerInv[id] = (playerInv[id] || 0) + 1;
        playerGold -= item.value;
        shopGold += item.value;
      }
    }

    // Selling to shop
    for (const id in pendingPlayer) {
      if (!pendingPlayer[id]) continue;
      const item = getItemMetadata(id);
      if (!item) continue;
      if ((shopGold >= item.value) && (playerInv[id] > 0)) {
        shopInv[id] = (shopInv[id] || 0) + 1;
        playerInv[id] -= 1;
        playerGold += item.value;
        shopGold -= item.value;
      }
    }

    // Update gold trackers
    State.variables.player_gold = playerGold;
    State.variables.shop_gold = shopGold;
    delete State.temporary.pending_shop;
    delete State.temporary.pending_player;
    this.closeOverlay();
  },

  updateTabHighlight(category) {
    document.querySelectorAll(".inv-tab").forEach(btn => btn.classList.remove("active"));
    const btn = document.querySelector(`.inv-tab[onclick*='${category}']`);
    if (btn) btn.classList.add("active");
  },

  closeOverlay() {
    const panel = document.getElementById("overlay-panel");
    if (panel) panel.classList.add("overlay-hidden");
    // Return to conversation state here if needed
  }
};
/* twine-user-script #21: "08_conversation_minigame.js" */
// 08_conversation_minigame.js

setup.ConvoGame = {
  start(npcId) {
    const npc = State.variables.characters[npcId];
    if (!npc) {
      console.error(`[ConvoGame] Invalid NPC ID: ${npcId}`);
      return;
    }
  
    State.temporary.convo = {
      npcId,
      turn: 1,
      maxTurn: 25,
      tension: 0,
      maxTension: npc.maxTension ?? 3,
      rapport: 0.5, // (make sure initial rapport is 0.5, right?)
      trustGained: 0,
      affectionGained: 0,
      ended: false,
      usedTropes: [],
      giftsGiven: [],
      promptMod: 0,
      heatTier: 1,
      lastCheckpoint: {
        trust: 0,
        affection: 0,
        turn: 0
      },
      luckLog: [], // ✅ Comma placed correctly, and luckLog is OUTSIDE lastCheckpoint
    };
    
  
    this.render();
  },
  openTutorial() {
    document.getElementById("tutorial-overlay").classList.add("active");
  },
  
  closeTutorial() {
    document.getElementById("tutorial-overlay").classList.remove("active");
  },
  
  render() {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];
    if (!npc) return;
  
    // Increase difficulty with each checkpoint (every 5 turns)
    convo.promptMod = Math.floor((convo.turn - 1) / 5);
  
    const prompt = setup.getConvoPrompt(npc);
    convo.currentPrompt = prompt;
  
    document.getElementById("convo-npc-name").textContent = npc.name ?? "???";
    document.getElementById("convo-npc-prompt").textContent = prompt.text ?? "…";
  
    document.getElementById("gain-trust").textContent = convo.trustGained;
    document.getElementById("gain-affection").textContent = convo.affectionGained;
    document.getElementById("convo-rapport").textContent = convo.rapport.toFixed(1);
    document.getElementById("convo-tension").textContent = convo.tension;
    document.getElementById("convo-max-tension").textContent = convo.maxTension;
  
    document.getElementById("convo-avatar").src = npc.avatar || "images/portrait_default.png";
  
    this.injectChoices();
  },
  
  applyHeatEffects() {
    const convoOverlay = document.querySelector(".convo-window");
    if (!convoOverlay) return;
  
    // Remove old heat classes
    convoOverlay.classList.remove("heat-1", "heat-2", "heat-3", "heat-4", "heat-5");
  
    const convo = State.temporary.convo;
    const heatTier = convo.heatTier ?? 1;
  
    // Apply new heat class based on current heat tier
    convoOverlay.classList.add(`heat-${heatTier}`);
  },
  
  injectChoices() {
  const convo = State.temporary.convo;
  const choiceBox = document.getElementById("convo-choices");
  if (!choiceBox) return;

  choiceBox.innerHTML = "";

  const tierList = setup.ConvoTropesByTier?.[convo.heatTier] ?? [];

  if (tierList.length === 0) {
    choiceBox.innerHTML = "<em>No conversation options available.</em>";
    console.warn(`[ConvoUI] No tropes found for HAWT™ tier ${convo.heatTier}`);
    return;
  }

  const unused = tierList.filter(trope => !convo.usedTropes.includes(trope.label));

  // Cryptographically secure shuffle
  function cryptoShuffle(array) {
    const arr = array.slice(); // Clone to avoid mutation
    for (let i = arr.length - 1; i > 0; i--) {
      const rand = window.crypto.getRandomValues(new Uint32Array(1))[0] / 2 ** 32;
      const j = Math.floor(rand * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  const shuffled = cryptoShuffle(unused);
  const finalTropes = shuffled.slice(0, 4);

  if (finalTropes.length === 0) {
    choiceBox.innerHTML = "<em>No conversation options available.</em>";
    return;
  }

  for (const trope of finalTropes) {
    const btn = document.createElement("button");
    btn.textContent = `${trope.label} (${this.getSuccessChance(trope)}%)`;
    btn.onclick = () => this.handleChoice(trope);
    choiceBox.appendChild(btn);
  }

  setup.ConvoUI.animateChoices(choiceBox);
},


  handleChoice(trope) {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];
  
    convo.usedTropes.push(trope.label.toLowerCase().replace(/\s+/g, ""));
  
    const roll = window.crypto.getRandomValues(new Uint32Array(1))[0] / 2**32 * 100;

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log(`[ConvoGame] 🎲 Roll: ${roll.toFixed(2)} vs. Success Chance: ${this.getSuccessChance(trope)}%`);
    }

    const chance = this.getSuccessChance(trope);
    const success = roll <= chance;
    // Log luck tracking
    State.temporary.convo.luckLog.push({
      chance: chance,  // The success chance offered
      result: success ? 1 : 0 // 1 = success, 0 = fail
    });

    const clickedButton = event?.target ?? null; // Get the clicked button for particles
  
    if (success) {
      if (trope.effects.trust) {
        convo.trustGained += trope.effects.trust;
        setup.ConvoGame.spawnParticles("trust", trope.effects.trust, clickedButton);
        for (let i = 0; i < Math.floor(Math.random() * 3) + 2; i++) {
          setup.ConvoGame.spawnParticles("trust-bonus", 1, clickedButton);
        }
      }
      if (trope.effects.affection) {
        convo.affectionGained += trope.effects.affection;
        setup.ConvoGame.spawnParticles("affection", trope.effects.affection, clickedButton);
        for (let i = 0; i < Math.floor(Math.random() * 3) + 2; i++) {
          setup.ConvoGame.spawnParticles("affection-bonus", 1, clickedButton);
        }
      }
      // 🚫 No rapport gain here anymore!
    }
     else {
      convo.tension++;
  
      // Fail particles
      if (trope.effects.trust) {
        setup.ConvoGame.spawnParticles("fail-trust", 1, clickedButton);
      } else if (trope.effects.affection) {
        setup.ConvoGame.spawnParticles("fail-affection", 1, clickedButton);
      }
  
      // Shake and grey out button
      if (clickedButton) {
        clickedButton.classList.add("shake", "grey-out");
        setTimeout(() => {
          clickedButton.classList.remove("shake", "grey-out");
        }, 300);
      }
    }
  
    this.updateTurnProgress(success);
  
    if (convo.turn % 5 === 0) {
      convo.lastCheckpoint = {
        trust: convo.trustGained,
        affection: convo.affectionGained,
        turn: convo.turn
      };
    
      convo.rapport = Math.min(convo.rapport + 0.1, 2.0); // Cap rapport at 2.0 for safety
      console.log(`[ConvoGame] 🧪 Rapport increased to ${convo.rapport.toFixed(2)} at checkpoint.`);
      console.log(`[ConvoGame] ✅ Checkpoint saved at turn ${convo.turn}`, convo.lastCheckpoint);
    }
    
  
    convo.turn++;
  
    // Cap the game manually at turn 26
    if (convo.turn > 25) {
      convo.ended = true;
      console.log(`[ConvoGame] 🛑 Maximum turn cap reached at turn ${convo.turn}. Ending minigame.`);
      this.end();
      return;
    }
  
    if ((convo.turn - 1) % 5 === 0 && convo.turn > 1) {
      convo.heatTier = Math.min(convo.heatTier + 1, 5);
      console.log(`[ConvoGame] 🔥 Heat tier escalated to ${convo.heatTier}`);
    }
  
    this.applyHeatEffects();
  
    if (convo.tension >= convo.maxTension) {
      convo.trustGained = 0;
      convo.affectionGained = 0;
      convo.ended = true;
      console.log(`[ConvoGame] ❌ Max tension reached. Progress wiped.`);
      this.end();
      return;
    }
  
    this.render();
  },

  getSuccessChance(trope) {
    const convo = State.temporary.convo;
    const globalDifficultyModifier = 20; // 🔥 Global difficulty tweak: lowers success by 20%
  
    const base = 100 - trope.baseDifficulty - globalDifficultyModifier;
    const adjusted = base - (convo.promptMod * 5); // Still gets harder every checkpoint
  
    return Math.max(5, adjusted); // ✅ Only a floor at 5%, no ceiling
  },
  

  exitEarly() {
    const convo = State.temporary.convo;
    convo.trustGained = convo.lastCheckpoint.trust;
    convo.affectionGained = convo.lastCheckpoint.affection;
    convo.ended = true;
    console.log(`[ConvoGame] 🛑 Player exited manually. Reverting to last checkpoint.`);
    this.end();
  },

  end() {
    const convo = State.temporary.convo;
  
    const convoBody = document.getElementById("convo-body");
    const resultBox = document.getElementById("convo-results");
  
    if (convoBody) convoBody.classList.add("hidden");
    if (resultBox) resultBox.classList.remove("hidden");
  
    // Calculate final trust/affection based on rapport multiplier
    const finalMultiplier = convo.rapport ?? 1.0;
    const rawTrust = convo.trustGained;
    const rawAffection = convo.affectionGained;
    const finalTrust = +(rawTrust * finalMultiplier).toFixed(2);
    const finalAffection = +(rawAffection * finalMultiplier).toFixed(2);
  
    // Save the final scaled values
    convo.trustGained = finalTrust;
    convo.affectionGained = finalAffection;
  
   // Display results
    document.getElementById("convo-result-status").textContent = convo.tension >= convo.maxTension ? "Failure" : "Success!";

    document.getElementById("convo-result-trust").innerHTML = `
      Base Trust: +${rawTrust} | Base Affection: +${rawAffection}<br>
      Rapport Multiplier: x${finalMultiplier.toFixed(2)}
      <hr style="border: 0; height: 1px; background: #555; margin: 8px 0;">
      <strong>Final Trust: +${finalTrust} | Final Affection: +${finalAffection}</strong>
    `;

    document.getElementById("convo-result-affection").innerHTML = "";

  
    const closeBtn = document.getElementById("convo-result-close");
    if (closeBtn) {
      closeBtn.onclick = () => {
        window.closeOverlay();
      };
    }
    // ✅ After overlay is closed, refresh conversation UI if we're still on that NPC
    const npcId = convo.npcId;
    const phase = State.variables.currentPhase;
    const currentNPC = State.variables.currentNPC;

    if (currentNPC === npcId && typeof setup?.[`${npcId}_Conversation_Options_${phase}`] === "function") {
      setTimeout(() => {
        console.log(`[ConvoGame] 🔁 Refreshing conversation UI for ${npcId} in phase ${phase}`);
        setup[`${npcId}_Conversation_Options_${phase}`]();
      }, 300);
    }

    // Disable all leftover choice buttons
    const buttons = document.querySelectorAll("#convo-choices button");
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.pointerEvents = "none";
      btn.style.opacity = "0.5";
    });
  
    // Save gains back to NPC
    const npc = State.variables.characters[convo.npcId];
    if (npc) {
      npc.trust = (npc.trust || 0) + finalTrust;
      npc.affection = (npc.affection || 0) + finalAffection;
    }
  
    console.log("[ConvoGame] Conversation finished.", convo);
  
    // Luck Tracker Report
    const luckLog = convo.luckLog ?? [];
    if (luckLog.length > 0) {
      const totalExpected = luckLog.reduce((sum, entry) => sum + (entry.chance / 100), 0);
      const totalActual = luckLog.reduce((sum, entry) => sum + entry.result, 0);
      const luckScore = +(totalActual - totalExpected).toFixed(2);
  
      let luckDescriptor = "Average Luck";
      if (luckScore >= 1) luckDescriptor = "Incredibly Lucky!";
      else if (luckScore >= 0.5) luckDescriptor = "Very Lucky!";
      else if (luckScore <= -1) luckDescriptor = "Cursed!";
      else if (luckScore <= -0.5) luckDescriptor = "Unlucky!";
  
      console.log(`[ConvoGame] 🍀 Session Luck Report:`);
      console.log(`Expected Successes: ${totalExpected.toFixed(2)}`);
      console.log(`Actual Successes: ${totalActual}`);
      console.log(`Luck Score: ${luckScore} (${luckDescriptor})`);
    }
  },
  
  

  updateTurnProgress(success) {
    const convo = State.temporary.convo;
    const segmentsContainer = document.querySelector(".turn-progress-bar");
    let segments = segmentsContainer.querySelectorAll(".turn-segment");
    const currentIndex = (convo.turn - 1) % 5;
  
    // If we are starting a new block (Turn 6, 11, 16...), rebuild the segments
    if (currentIndex === 0 && convo.turn > 1) {
      // Clear old segments
      segmentsContainer.querySelectorAll(".turn-segment").forEach(seg => seg.remove());
  
      // Create 5 new pending segments
      for (let i = 0; i < 5; i++) {
        const newSeg = document.createElement("div");
        newSeg.classList.add("turn-segment", "pending");
        segmentsContainer.insertBefore(newSeg, document.getElementById("convo-max-turn"));
      }
  
      // Refresh segment list
      segments = segmentsContainer.querySelectorAll(".turn-segment");
  
      // Also update the block number (5 ➔ 10 ➔ 15 ➔ etc.)
      const blockNumber = Math.ceil(convo.turn / 5) * 5;
      document.getElementById("convo-max-turn").textContent = blockNumber;
    }
  
    // Now safely mark the current turn's segment
    if (segments[currentIndex]) {
      segments[currentIndex].classList.remove("pending");
      segments[currentIndex].classList.add(success ? "success" : "fail");
    }
  },
  
  spawnParticles(type, count, originButton) {
    const container = document.getElementById("conversation-overlay");
    if (!container || !originButton) return;
  
    const originRect = originButton.getBoundingClientRect();
    const overlayRect = container.getBoundingClientRect();
    const originX = originRect.left + (originRect.width / 2) - overlayRect.left;
    const originY = originRect.top + (originRect.height / 2) - overlayRect.top;
  
    for (let i = 0; i < count; i++) {
      const particle = document.createElement("div");
      particle.classList.add("particle");
  
      // Determine what kind of particle
      if (type === "trust") {
        particle.classList.add("trust-particle");
        particle.textContent = "🤝";
      } else if (type === "affection") {
        particle.classList.add("affection-particle");
        particle.textContent = "❤️";
      } else if (type === "trust-bonus") {
        particle.classList.add("trust-particle");
        particle.textContent = "⭐";
      } else if (type === "affection-bonus") {
        particle.classList.add("affection-particle");
        particle.textContent = "🌸";
      } else if (type === "fail-trust") {
        particle.classList.add("fail-particle");
        particle.textContent = "😢";
      } else if (type === "fail-affection") {
        particle.classList.add("fail-particle");
        particle.textContent = "💔";
      }
  
      particle.style.left = `${originX}px`;
      particle.style.top = `${originY}px`;
  
      container.appendChild(particle);
  
      // Animate with random directions if success, straight down if fail
      let targetX = originX;
      let targetY = originY;

      if (type.startsWith("fail")) {
        // FAIL = straight downward
        targetY = originY + (60 + Math.random() * 40);
      } else {
        // SUCCESS = random pop upward (-45 to +45 from UP)
        const angle = (Math.random() * 90) + 225; // 225° to 315°
        const distance = 60 + Math.random() * 40;
        const rad = angle * (Math.PI / 180);
        targetX = originX + Math.cos(rad) * distance;
        targetY = originY + Math.sin(rad) * distance; // +sin, not minus!
      }


      particle.animate([
        { transform: `translate(0px, 0px)`, opacity: 1 },
        { transform: `translate(${targetX - originX}px, ${targetY - originY}px)`, opacity: 0 }
      ], {
        duration: 800 + Math.random() * 400,
        easing: "ease-out",
        fill: "forwards"
      });
  
      // Remove after animation
      setTimeout(() => {
        particle.remove();
      }, 1200);
    }
  },
  
};
/* twine-user-script #22: "09_conversation_ui.js" */
// 09_conversation_ui.js

setup.ConvoUI = {
  renderMinigame(npcId) {
    window.openOverlay("convo-minigame-page");
  
    setTimeout(() => {
      setup.ConvoGame.start(npcId);
  
      // Attach End Conversation button logic
      const endButton = document.getElementById("end-button");
      if (endButton) {
        endButton.onclick = () => {
          setup.ConvoGame.exitEarly();
        };
      }
  
      const giftButton = document.getElementById("gift-button");
      if (giftButton) {
        giftButton.onclick = () => {
          setup.ConvoUI.giveGiftMenu();
        };
      }
  
    }, 100); // slight delay to ensure overlay body contents have been injected
  
    if (State.variables.DEBUG || setup.DEBUG) {
      console.log(`[ConvoUI] Minigame started with NPC: ${npcId}`);
    }
  },
  
  
  render() {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];
  
    // Set NPC name
    document.getElementById("convo-npc-name").textContent = npc.known ? npc.name : "???";
  
    // Set NPC prompt
    const promptObj = setup.getConvoPrompt(npc);
    convo.currentPrompt = promptObj;
    document.getElementById("convo-npc-prompt").textContent = promptObj.text;
  
    // Set Avatars
    document.getElementById("convo-avatar").src = npc.avatar || "images/placeholder_npc.png";
    document.getElementById("player-avatar").src = "images/portrait_jaylie.png"; // or player avatar logic later
  
    // Inject choices
    setup.ConvoGame.injectChoices(promptObj);
  
    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[ConvoUI] Minigame UI rendered:", {
        npc: convo.npcId,
        prompt: promptObj,
      });
    }
  },
  openTutorial() {
    const overlay = document.getElementById("tutorial-overlay");
    if (overlay) {
      overlay.classList.add("active");
      overlay.classList.remove("hidden");
    }
  },

  closeTutorial() {
    const overlay = document.getElementById("tutorial-overlay");
    if (overlay) {
      overlay.classList.remove("active");
      overlay.classList.add("hidden");
    }
  },
  
  updateMeta() {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];

    document.getElementById("convo-turn").textContent = convo.turn;
    document.getElementById("convo-rapport").textContent = convo.rapport.toFixed(1);
    document.getElementById("convo-tension").textContent = `${convo.tension} / ${convo.maxTension}`;
    document.getElementById("gain-trust").textContent = convo.trustGained;
    document.getElementById("gain-affection").textContent = convo.affectionGained;

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log(`[ConvoUI] Meta updated:`, {
        turn: convo.turn,
        rapport: convo.rapport,
        tension: convo.tension,
        trust: convo.trustGained,
        affection: convo.affectionGained,
      });
    }
  },

  closeMinigame() {
    const overlay = document.getElementById("conversation-overlay");
    if (overlay) {
      overlay.classList.add("overlay-hidden");
    }

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[ConvoUI] Minigame overlay hidden.");
    }
  },

  giveGiftMenu() {
    alert("Gift system not yet implemented!");
    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[ConvoUI] Gift system placeholder triggered.");
    }
  }
  
};
setup.ConvoUI.animateChoices = function(container) {
  const buttons = container.querySelectorAll("button");
  buttons.forEach((btn, index) => {
    setTimeout(() => {
      btn.classList.add("animate-choice");
    }, index * 100);
  });
};



/* twine-user-script #23: "10_dialogueSetup.js" */
// ===============================
// 📦 Dialogue Layout Macros
// ===============================

// Injects the side-by-side convo UI and moves passage content to convoBox
Macro.add("StartDialogueLayout", {
	handler() {
		const backdrop = document.getElementById('text-backdrop');
		if (!backdrop) {
			console.warn("<<StartDialogueLayout>> failed: #text-backdrop not found.");
			return;
		}

		backdrop.classList.add("in-dialogue");
		backdrop.innerHTML = `
			<div id="convoLayoutContainer">
				<div id="convoChoicesPanel"><div id="convoChoices"></div></div>
				<div id="convoBoxPanel"><div id="convoBox"></div></div>
			</div>
		`;

		const tryInjectPassage = () => {
			const passage = document.querySelector('#passages > .passage');
			const convoBox = document.getElementById('convoBox');
			if (passage && convoBox) {
				convoBox.appendChild(passage);
			} else {
				requestAnimationFrame(tryInjectPassage);
			}
		};

		tryInjectPassage();

		// Force sidebar layout class sync (compensate margin)
		const sidebar = document.getElementById("custom-sidebar");
		if (sidebar) {
			if (sidebar.classList.contains("collapsed")) {
				document.body.classList.add("sidebar-collapsed");
			} else {
				document.body.classList.remove("sidebar-collapsed");
			}
		}
	}
});

// Removes dialogue layout formatting
Macro.add("EndDialogueLayout", {
	handler() {
		const backdrop = document.getElementById('text-backdrop');
		if (backdrop) {
			backdrop.classList.remove("in-dialogue");
		}
	}
});

// Clears the choices box
setup.clearConvoChoices = function () {
	const choicesPanel = document.getElementById("convoChoices");
	if (choicesPanel) {
		choicesPanel.innerHTML = "";
	}
};

// Core choice injector
setup.addChoices = function (list) {
	const $container = $("#convoChoices");
	if (!$container.length) {
		console.warn("[addChoices] convoChoices not found.");
		return;
	}

	$container.empty();
	State.variables.usedDialogueOptions ??= {};

	list.forEach(([label, target, reuseFlag = 0, status = "normal"]) => {
		const reusable = reuseFlag === 1 || reuseFlag === "1";
		const used = State.variables.usedDialogueOptions[target];

		// Locked choice (unmet requirements)
		if (status === "locked") {
			const $button = $("<p>")
				.addClass("dialogue-choice locked")
				.text(label);
			$container.append($button);
			return;
		}

		// Skip used non-reusable
		if (used && !reusable) {
			console.log(`[addChoices] Skipping used non-reusable choice: ${target}`);
			return;
		}

		const macroCall = `<<dialogueChoice "${label}" "${target}" "${reusable ? 1 : 0}">>`;
		console.log(`[addChoices] Injecting: ${macroCall}`);
		new Wikifier($container[0], macroCall);
	});
};

// Internal helper to add a single choice (just wraps in a list)
setup.addChoice = function (label, passage, reuseFlag = 0) {
	setup.addChoices([[label, passage, reuseFlag]]);
};

// ✅ New: Universal smartChoice function
setup.smartChoice = function (label, target, {
	aff = null,
	trust = null,
	rapport = null,
	tension = null,
	cooldown = null,
	variable = null,
	notVariable = null,
	item = null,
	quest = null,
	compare = null,
	conditions = null,
	usedMin = null,
	hideIf = null,
	logic = "and",
	hide = false,
	reuse = 0,
	logUnlock = null,
	tags = []
} = {}) {
	const v = State.variables;
	const t = State.temporary;
	const chars = v.characters;
	const npc = v.currentNPC;
	const phase = v.currentPhase;

	const debug = true;
	let checks = [];

	if (debug) {
		console.groupCollapsed(`[smartChoice] ${label}`);
		console.log("Target:", target);
		console.log("Character:", npc, "| Phase:", phase);
	}

	// Early hide check
	if (hideIf) {
		let shouldHide = false;

		const resolve = (val) =>
			typeof val === "string" && val.startsWith("!") ? !setup._resolvePath(val.slice(1), v) : !!setup._resolvePath(val, v);

		if (hideIf.variable !== undefined) {
			shouldHide = resolve(hideIf.variable);
			if (debug) console.log(`hideIf.variable →`, shouldHide);
		}
		if (!shouldHide && hideIf.item) {
			const [id, count] = hideIf.item;
			const result = (v.inventory?.[id] ?? 0) < count;
			shouldHide = result;
			if (debug) console.log(`hideIf.item →`, result);
		}
		if (!shouldHide && hideIf.quest) {
			const [path, min] = hideIf.quest;
			const val = path.split(".").reduce((o, k) => o?.[k], v.quests ?? {});
			const result = (val ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.quest →`, result);
		}
		if (!shouldHide && hideIf.aff) {
			const [id, min] = hideIf.aff;
			const result = (chars?.[id]?.affection ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.aff →`, result);
		}
		if (!shouldHide && hideIf.trust) {
			const [id, min] = hideIf.trust;
			const result = (chars?.[id]?.trust ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.trust →`, result);
		}
		if (!shouldHide && hideIf.rapport) {
			const [id, min] = hideIf.rapport;
			const result = (chars?.[id]?.rapport ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.rapport →`, result);
		}
		if (!shouldHide && hideIf.tension) {
			const [id, max] = hideIf.tension;
			const result = (chars?.[id]?.tension ?? 0) > max;
			shouldHide = result;
			if (debug) console.log(`hideIf.tension →`, result);
		}
		if (!shouldHide && hideIf.cooldown) {
			const [id, max] = hideIf.cooldown;
			const result = (chars?.[id]?.cooldown ?? 0) > max;
			shouldHide = result;
			if (debug) console.log(`hideIf.cooldown →`, result);
		}
		if (!shouldHide && typeof hideIf.conditions === "function") {
			const result = !!hideIf.conditions(v);
			shouldHide = result;
			if (debug) console.log(`hideIf.conditions →`, result);
		}
		if (shouldHide) {
			if (debug) console.log("→ Choice hidden due to hideIf.");
			console.groupEnd();
			return null;
		}
	}

	// Relationship stats
	if (aff) {
		const [id, min] = aff;
		const result = (chars?.[id]?.affection ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`affection[${id}] >= ${min}? →`, result);
	}
	if (trust) {
		const [id, min] = trust;
		const result = (chars?.[id]?.trust ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`trust[${id}] >= ${min}? →`, result);
	}
	if (rapport) {
		const [id, min] = rapport;
		const result = (chars?.[id]?.rapport ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`rapport[${id}] >= ${min}? →`, result);
	}
	if (tension) {
		const [id, max] = tension;
		const result = (chars?.[id]?.tension ?? 0) <= max;
		checks.push(result);
		if (debug) console.log(`tension[${id}] <= ${max}? →`, result);
	}
	if (cooldown) {
		const [id, max] = cooldown;
		const result = (chars?.[id]?.cooldown ?? 0) <= max;
		checks.push(result);
		if (debug) console.log(`cooldown[${id}] <= ${max}? →`, result);
	}

	// Variable checks
	if (variable) {
		const result = !!v[variable];
		checks.push(result);
		if (debug) console.log(`variable[${variable}] →`, result);
	}
	if (notVariable) {
		const result = !v[notVariable];
		checks.push(result);
		if (debug) console.log(`notVariable[${notVariable}] →`, result);
	}

	// Inventory
	if (item) {
		const [id, count] = item;
		const result = (v.inventory?.[id] ?? 0) >= count;
		checks.push(result);
		if (debug) console.log(`item[${id}] x${count} →`, result);
	}

	// Quest
	if (quest) {
		const [path, min] = quest;
		const val = path.split(".").reduce((o, k) => o?.[k], v.quests ?? {});
		const result = (val ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`quest[${path}] >= ${min}? →`, result);
	}

	// Custom condition
	if (typeof conditions === "function") {
		const result = !!conditions(v);
		checks.push(result);
		if (debug) console.log(`custom condition →`, result);
	}

	// UsedMin
	if (usedMin !== null && npc && phase !== undefined) {
		const readVars = Object.entries(v)
			.filter(([key]) => key.startsWith(`Read_${phase}_${npc}_`))
			.map(([, value]) => value);
		const count = readVars.filter(val => val >= 1).length;
		const result = count >= usedMin;
		checks.push(result);
		if (debug) console.log(`usedMin[${usedMin}] →`, result, `(found: ${count})`);
	}

	// Compare logic
	if (compare) {
		const value = typeof compare.value === "string" ? setup._resolvePath(compare.value, v) : compare.value;
		const against = typeof compare.against === "string" ? setup._resolvePath(compare.against, v) : compare.against;
		const opMap = {
			"==": value == against,
			"===": value === against,
			"!=": value != against,
			"!==": value !== against,
			"<": value < against,
			"<=": value <= against,
			">": value > against,
			">=": value >= against
		};
		const result = opMap[compare.op];
		checks.push(result);
		if (debug) console.log(`compare ${compare.value} ${compare.op} ${compare.against} →`, result);
	}

	const passed = logic === "or" ? checks.some(Boolean) : checks.every(Boolean);
	if (debug) console.log("PASS LOGIC:", logic, "→", passed);
	if (debug) console.groupEnd();

	// Log tags
	if (passed && tags?.length > 0) {
		v.choiceTags ??= [];
		tags.forEach(tag => {
			if (!v.choiceTags.includes(tag)) v.choiceTags.push(tag);
		});
	}

	// Log unlock variable
	if (passed && logUnlock) {
		v[logUnlock] = true;
	}

	if (passed) return [label, target, reuse];
	if (!hide) return [label, null, reuse, "locked"];
	return null;
};



// Path resolver (supports nested vars like "$characters.marie.affection")
setup._resolvePath = function (path, source = State.variables) {
	return path.split(".").reduce((acc, key) => acc?.[key], source);
};



// ✅ Batch version: Array of smartChoice calls
setup.smartChoices = function (list) {
	const final = [];
	for (const opt of list) {
		const entry = setup.smartChoice(opt.label, opt.target, {
			aff: opt.aff,
			trust: opt.trust,
			rapport: opt.rapport,
			tension: opt.tension,
			cooldown: opt.cooldown,
			variable: opt.variable,
			notVariable: opt.notVariable,
			item: opt.item,
			quest: opt.quest,
			compare: opt.compare,
			conditions: opt.conditions,
			usedMin: opt.usedMin,
			hideIf: opt.hideIf, // ✅ pass through hideIf
			logic: opt.logic ?? "and",
			hide: opt.hide ?? false,
			reuse: opt.reuse ?? 0,
			logUnlock: opt.logUnlock,
			tags: opt.tags ?? []
		});
		if (entry) final.push(entry);
	}
	setup.addChoices(final);
};



/* twine-user-script #24: "11_BodyDescriptorsDB.js" */
// dev/js/02_systems/11_BodyDescriptorsDB.js
// Centralized enum and descriptor logic for body-related features

const BodyDescriptors = {
  breastSize: ["flat", "small", "modest", "full", "large", "very large", "massive"],
  buttSize: ["flat", "tight", "modest", "round", "plump", "large", "voluptuous"],
  bodyType: ["emaciated", "slender", "lean", "average", "curvy", "thick", "heavyset", "broad"],
  lipFullness: ["thin", "narrow", "modest", "full", "plump", "voluptuous"],
  muscleTone: ["soft", "slightly toned", "fit", "athletic", "defined", "muscular", "ripped"],
  hipWidth: ["narrow", "modest", "wide", "very wide"],
  bodyHair: ["smooth", "light", "natural", "hairy", "very hairy"],

  hairLengthMap: [
    { label: "bald", max: 0 },
    { label: "buzzed", max: 1 },
    { label: "cropped", max: 3 },
    { label: "short", max: 6 },
    { label: "ear-length", max: 8 },
    { label: "jaw-length", max: 10 },
    { label: "shoulder-length", max: 14 },
    { label: "mid-back", max: 20 },
    { label: "waist-length", max: 26 },
    { label: "butt-length", max: 34 },
    { label: "floor-length", max: Infinity }
  ],

  heightDescriptor(heightInInches) {
    if (heightInInches <= 48) return "extremely short";
    if (heightInInches <= 54) return "short";
    if (heightInInches <= 60) return "below average height";
    if (heightInInches <= 66) return "average height";
    if (heightInInches <= 72) return "tall";
    if (heightInInches <= 78) return "very tall";
    return "towering";
  },

  penisSizeDesc(sizeInInches) {
    if (sizeInInches < 3.5) return "small";
    if (sizeInInches < 5.5) return "modest";
    if (sizeInInches < 7) return "average";
    if (sizeInInches < 8.5) return "large";
    return "very large";
  },

  getHairLengthLabel(inches) {
    for (const entry of this.hairLengthMap) {
      if (inches <= entry.max) return entry.label;
    }
    return "unknown length";
  },

  describeHair(profile) {
    const lengthLabel = this.getHairLengthLabel(profile.hairLength || 0);
    return `${lengthLabel} ${profile.hairStyle || "unstyled"} ${profile.hairColor || "hair"}`;
  },

  describeEyes(profile) {
    return `${profile.eyeColor || "unknown"} eyes`;
  },

  describeBody(profile) {
    let height = this.heightDescriptor(profile.height);
    let build = this.bodyType[profile.bodyType];
    let breasts = profile.breastSize != null ? this.breastSize[profile.breastSize] + " breasts" : null;
    let butt = profile.buttSize != null ? this.buttSize[profile.buttSize] + " butt" : null;

    return `A ${height}, ${build} build${breasts ? ", with " + breasts : ""}${butt ? ", and a " + butt : ""}.`;
  },

  describeFullAppearance(profile) {
    return `${this.describeBody(profile)} ${profile.skinTone} skin, ${this.describeHair(profile)}, and ${this.describeEyes(profile)}.`;
  }
};

setup.BodyDescriptors = BodyDescriptors;
/* twine-user-script #25: "12_GlobalTextResolver.js" */
setup.resolveCharacterText = function (text, npc) {
    if (!npc || typeof npc !== "object") return text;
  
    const p = npc.pronouns || {};
    const b = npc.body || {};
  
    // Descriptive helpers
    const bd = setup.BodyDescriptors || {};
    const getBody = (index, arr) => arr?.[index] || "unknown";
    const getHairLength = (inches) => {
      if (!bd.getHairLengthLabel) return `${inches} inches`;
      return bd.getHairLengthLabel(inches);
    };
  
    // Resolution map
    const replacements = {
      "<<npc.name>>": npc.name || "they",
      "<<npc.they>>": p.subject || "they",
      "<<npc.them>>": p.object || "them",
      "<<npc.their>>": p.possessive || "their",
      "<<npc.theirs>>": p.possessive + "s" || "theirs",
      "<<npc.themself>>": p.reflexive || "themself",
      "<<npc.noun>>": p.noun || "person",
      "<<npc.eyecolor>>": b.eyeColor || "unknown",
      "<<npc.hairColor>>": b.hairColor || "unknown",
      "<<npc.hairStyle>>": b.hairStyle || "unstyled",
      "<<npc.hairLength>>": getHairLength(b.hairLength || 0),
      "<<npc.skinTone>>": b.skinTone || "skin",
      "<<npc.voiceTone>>": b.voiceTone || "neutral",
      "<<npc.bodyType>>": getBody(b.bodyType, bd.bodyType),
      "<<npc.buttSize>>": getBody(b.buttSize, bd.buttSize),
      "<<npc.breastSize>>": b.breastSize != null ? getBody(b.breastSize, bd.breastSize) : "",
      "<<npc.penisSize>>": b.penisSize != null ? `${b.penisSize.toFixed(1)} inch` : ""
    };
  
    // Apply all replacements
    for (const [key, value] of Object.entries(replacements)) {
      const safeVal = (value || "").toString();
      text = text.replaceAll(key, safeVal);
    }
  
    return text;
  };
  
/* twine-user-script #26: "12_SexScene_Logic.js" */
// ===============================
// 🍑 Initialize Sex Scene State
// ===============================
setup.initializeSexSceneStates = function (npcIdListString) {
	console.log("[SexSceneInit] Initializing sex scene states...");

	const defaultPartState = () => ({
		occupiedBy: null,
		bound: false,
		gagged: false,
		disabled: false
	});

	const detectBodyParts = (char) => {
		const body = char.body || {};
		const parts = {};
		const summary = [];

		// Core anatomy
		parts.mouth = defaultPartState();
		summary.push("Mouth");

		parts.leftHand = defaultPartState();
		parts.rightHand = defaultPartState();
		summary.push("Left Hand", "Right Hand");

		parts.feet = defaultPartState();
		summary.push("Feet");

		parts.anus = defaultPartState();
		summary.push("Anus");

		if (body.penisSize != null) {
			parts.penis = defaultPartState();
			summary.push(`Penis (${body.penisSize}in)`);
		}

		if (body.vagina) {
			parts.vagina = defaultPartState();
			parts.clitoris = defaultPartState();
			summary.push("Vagina", "Clitoris");
		}

		if (body.breastSize > 0) {
			parts.breasts = defaultPartState();
			summary.push(`Breasts (size ${body.breastSize})`);
		}

		return { parts, summary };
	};

	// === PLAYER INIT ===
	const playerChar = State.variables.player;
	const playerPartsData = detectBodyParts(playerChar);

	State.variables.sexScenePlayerState = {
		id: "player",
		name: "You",
		parts: playerPartsData.parts,
		orgasmCount: 0
	};

	// These should always reset during scene init
	State.variables.sexScenePendingActions = [];
	State.variables.sexSceneOngoingActions = [];

	console.log(`[SexSceneInit] 🧍 Player Anatomy Parts: ${playerPartsData.summary.join(", ")}`);

	// === PARTNERS INIT ===
	const partnerIds = npcIdListString.split(",").map(id => id.trim());
	State.variables.sexScenePartnerStates = {};

	for (const id of partnerIds) {
		const npc = State.variables.characters[id];
		if (!npc) {
			console.warn(`[SexSceneInit] ❌ Character '${id}' not found.`);
			continue;
		}

		const npcPartsData = detectBodyParts(npc);

		State.variables.sexScenePartnerStates[id] = {
			id,
			name: npc.name ?? id,
			parts: npcPartsData.parts,
			orgasmCount: 0,
			lastReceivedAction: null
		};

		console.log(`[SexSceneInit] 👤 ${npc.name}'s Anatomy Parts: ${npcPartsData.summary.join(", ")}`);
	}

	console.log("[SexSceneInit] ✅ Sex scene state initialized.");

	// === Have NPC(s) decide initial action before first turn
	const npcIds = Object.keys(State.variables.sexScenePartnerStates ?? {});
	for (const npcId of npcIds) {
		setup.npcDecideActions(npcId);
	}


};


// ===============================
// 💄 Layout Macros
// ===============================
Macro.add("StartSexSceneLayout", {
	handler() {
		const backdrop = document.getElementById("text-backdrop");
		if (!backdrop) {
			console.warn("[SexSceneLayout] ⚠️ Could not find #text-backdrop.");
			return;
		}

		console.log("[SexSceneLayout] 🔹 Initializing layout...");

		backdrop.classList.add("in-sexscene");
		backdrop.innerHTML = `
			<div id="sexSceneLayoutContainer">
				<div id="sexSceneFeedbackPanel"><div id="sexSceneFeedbackBox"></div></div>
				<div id="sexSceneStatusPanel"></div>
				<div id="sexSceneActionsPanel"><div id="sexSceneActionsBox"></div></div>
			</div>
		`;

		console.log("[SexSceneLayout] ✅ HTML structure injected.");

		const tryInjectPassage = () => {
			const passage = document.querySelector('#passages > .passage');
			const feedbackBox = document.getElementById("sexSceneFeedbackBox");

			if (passage && feedbackBox) {
				feedbackBox.appendChild(passage);
				console.log("[SexSceneLayout] ✅ Passage content moved to feedback panel.");

				// ✅ Once layout is stable, render the actions
				setup.renderSexSceneActions();
			} else {
				console.log("[SexSceneLayout] ⏳ Waiting for passage render...");
				requestAnimationFrame(tryInjectPassage);
			}
		};

		tryInjectPassage();
	}
});


Macro.add("EndSexSceneLayout", {
	handler() {
		const backdrop = document.getElementById("text-backdrop");
		if (backdrop?.classList.contains("in-sexscene")) {
			backdrop.classList.remove("in-sexscene");
			console.log("[SexSceneLayout] 🔸 Layout class removed.");
		} else {
			console.warn("[SexSceneLayout] ⚠️ Tried to end layout, but class wasn't present.");
		}
	}
});



/* Body Part Detector */
setup.detectBodyParts = function (body) {
	const parts = {};

	if (!body || typeof body !== "object") return parts;

	// Core anatomy defaults (included unless explicitly false)
	if (body.mouth !== false) parts.mouth = {};
	if (body.hands !== false) parts.hand = {}; // normalized to single "hand"
	if (body.feet !== false) parts.feet = {};

	// Anus present unless explicitly excluded
	if (body.anus !== false || body.buttSize >= 0) parts.anus = {};

	// Sexual anatomy
	if (body.vagina) parts.vagina = {};
	if (body.clitoris) parts.clitoris = {};
	if (body.penisSize != null) parts.penis = {};
	if (body.breastSize > 0) parts.breasts = {};

	return parts;
};


// ===============================
// 🎛️ Render Action Buttons
// ===============================
setup.renderSexSceneActions = function () {
	console.log("[SexSceneRender] 🔄 Rendering available sex actions...");

	const $wrapper = document.getElementById("sexSceneActionsBox");
	if (!$wrapper) {
		console.warn("[SexSceneRender] ❌ #sexSceneActionsBox not found.");
		return;
	}
	$wrapper.innerHTML = "";

	const playerState = State.variables.sexScenePlayerState;
	const playerChar = State.variables.player;
	const playerSkills = playerChar.skills || {};
	const partnerId = Object.keys(State.variables.sexScenePartnerStates ?? {})[0];
	const partnerState = State.variables.sexScenePartnerStates?.[partnerId];
	const partnerChar = State.variables.characters?.[partnerId];

	if (!playerState || !partnerState || !partnerChar) {
		console.error("[SexSceneRender] ❌ Missing player or NPC state.");
		return;
	}

	const pending = State.variables.sexScenePendingActions ?? [];
	const ongoing = State.variables.sexSceneOngoingActions ?? [];
	const isCumming = playerChar.status?.isCumming === true;
	const allowedClimax = State.variables.sexSceneFilteredOrgasmOptions ?? [];

	const groupedActions = {};
	const hands = ["leftHand", "rightHand"];
	const bodyParts = ["mouth", "feet", "anus", "penis", "vagina", "breasts"];
	[...hands, ...bodyParts].forEach(part => groupedActions[part] = []);

	// Track stage levels by group + hand
	const activeStageMap = {};
	for (const entry of ongoing) {
		const act = setup.SexualActsDB[entry.label];
		if (act?.stageGroup) {
			const key = act.stageGroup + (entry.assignedHand ?? "");
			const current = activeStageMap[key] ?? -1;
			activeStageMap[key] = Math.max(current, act.stageLevel);
		}
	}

// === Filter and group valid actions
	for (const [label, act] of Object.entries(setup.SexualActsDB)) {
		if (act.giver !== "player" || !Array.isArray(act.subjectParts)) continue;

		const isActClimax = !!act.isCumming;
		if (isCumming !== isActClimax) {
			console.log(`[OrgasmFilter] ❌ Skipping '${label}' — isCumming mismatch.`);
			continue;
		}

		// === Orgasm-specific debug filtering
		if (isCumming && isActClimax) {
			const missingSubject = act.subjectParts.filter(p => !playerState.parts?.[p]);
			const missingObject = act.objectParts?.filter(p => !partnerState.parts?.[p]) ?? [];

			if (missingSubject.length > 0) {
				console.log(`[OrgasmFilter] ❌ '${label}' skipped — player missing: ${missingSubject.join(", ")}`);
				continue;
			}
			if (missingObject.length > 0) {
				console.log(`[OrgasmFilter] ❌ '${label}' skipped — partner missing: ${missingObject.join(", ")}`);
				continue;
			}
			if (typeof allowedClimax !== "undefined" && allowedClimax.length > 0 && !allowedClimax.includes(label)) {
				console.log(`[OrgasmFilter] ❌ '${label}' skipped — not in allowedClimax list.`);
				continue;
			}

			console.log(`[OrgasmFilter] ✅ '${label}' PASSED — valid climax option.`);
		}

		// === Skill check
		if (act.skillsRequired && !Object.entries(act.skillsRequired).every(
			([skill, min]) => (playerSkills[skill] ?? 0) >= min
		)) continue;

		// === Hand actions
		const isHandAction = act.subjectParts.includes("hand");
		if (isHandAction) {
			hands.forEach(hand => {
				const handState = playerState.parts?.[hand];
				if (!handState || handState.bound || handState.disabled) return;

				let visible = true;
				if (act.stageGroup) {
					const key = act.stageGroup + hand;
					const level = activeStageMap[key] ?? -1;
					visible = [0, level, level + 1].includes(act.stageLevel);
				}
				if (!visible) return;

				groupedActions[hand].push({ label, act, assignedHand: hand });
			});
			continue;
		}

		// === Non-hand actions
		const allPartsValid = act.subjectParts.every(part => {
			const state = playerState.parts?.[part];
			return state && !state.bound && !state.disabled;
		});
		if (!allPartsValid) continue;

		let visible = true;
		if (act.stageGroup) {
			const key = act.stageGroup;
			const level = activeStageMap[key] ?? -1;
			visible = [0, level, level + 1].includes(act.stageLevel);
		}
		if (!visible) continue;

		const primary = act.subjectParts[0];
		groupedActions[primary].push({ label, act });
	}



	// Render UI groups
	for (const [part, actions] of Object.entries(groupedActions)) {
		const $group = document.createElement("div");
		$group.classList.add("sexscene-group");
		$group.innerHTML = `<h3>${part.toUpperCase()}</h3>`;

		// REST button
		const restLabel = `__REST_${part}`;
		const isRestPending = pending.some(p => p.label === restLabel);
		const isRestOngoing = ongoing.every(p =>
			(p.assignedHand ?? null) !== part &&
			!setup.SexualActsDB[p.label]?.subjectParts?.includes(part)
		);

		const $rest = document.createElement("button");
		$rest.textContent = "Rest";
		$rest.classList.add("rest-button");
		if (isRestPending) {
			$rest.classList.add("active-sexact", "pending");
		} else if (isRestOngoing) {
			$rest.classList.add("active-sexact", "ongoing");
		}
		$rest.onclick = () => setup.toggleRestAction(part);
		$group.appendChild($rest);

		actions.forEach(entry => {
			const $btn = document.createElement("button");
			$btn.textContent = entry.act.label;

			const isPending = pending.some(p =>
				p.label === entry.label &&
				(p.assignedHand ?? null) === (entry.assignedHand ?? null)
			);
			const isOngoing = ongoing.some(p =>
				p.label === entry.label &&
				(p.assignedHand ?? null) === (entry.assignedHand ?? null)
			);

			if (isPending) $btn.classList.add("active-sexact", "pending");
			else if (isOngoing) $btn.classList.add("active-sexact", "ongoing");

			$btn.onclick = () => setup.toggleSexAction(entry.label, entry.assignedHand);
			$group.appendChild($btn);
		});

		$wrapper.appendChild($group);
	}

	setup.renderSexSceneContinueButton();
};



// ===============================
// 🔘 Track & Toggle Pending Actions
// ===============================
setup.toggleSexAction = function (label, assignedHand = null) {
	const act = setup.SexualActsDB[label];
	if (!act) {
		console.warn(`[SexSceneAction] ❌ Unknown label: '${label}'`);
		return;
	}

	let queue = State.variables.sexScenePendingActions ?? [];
	queue = [...queue]; // Defensive copy to avoid mutation bugs

	if (assignedHand) {
		// Remove any action currently using this hand
		const existingIndex = queue.findIndex(entry => entry.assignedHand === assignedHand);
		if (existingIndex >= 0) {
			console.log(`[SexSceneAction] 🔄 Removed existing '${queue[existingIndex].label}' on '${assignedHand}'.`);
			queue.splice(existingIndex, 1);
		}

		queue.push({ label, assignedHand });
		console.log(`[SexSceneAction] ✅ Assigned '${label}' to '${assignedHand}'.`);
	} else {
		// Radio group logic — clear any conflicting non-hand actions
		const subjectParts = act.subjectParts || [];

		queue = queue.filter(entry => {
			const existing = setup.SexualActsDB[entry.label];
			if (!existing || entry.assignedHand) return true;

			const conflict = existing.subjectParts?.some(part => subjectParts.includes(part));
			if (conflict) {
				console.log(`[SexSceneAction] 🔁 '${entry.label}' removed (conflict with '${label}').`);
				return false;
			}
			return true;
		});

		queue.push({ label });
		console.log(`[SexSceneAction] ✅ Queued '${label}' (non-hand).`);
	}

	State.variables.sexScenePendingActions = queue;
	setup.renderSexSceneActions();
};


/* Continue Button and logic handler */
setup.renderSexSceneContinueButton = function () {
	const $wrapper = document.getElementById("sexSceneActionsBox");
	if (!$wrapper) {
		console.warn("[SexSceneRender] ❌ Cannot render Continue button: #sexSceneActionsBox missing.");
		return;
	}

	// Remove existing footer buttons if present
	const existing = document.getElementById("sexSceneFooterButtons");
	if (existing) existing.remove();

	// Create a new footer container with flex layout
	const $footer = document.createElement("div");
	$footer.id = "sexSceneFooterButtons";
	

	// --- Continue Button (left side)
	const $continue = document.createElement("button");
	$continue.id = "sexSceneContinueButton";
	$continue.textContent = "Continue";
	$continue.style.flex = "1";

	const pending = State.variables.sexScenePendingActions ?? [];
	const ongoing = State.variables.sexSceneOngoingActions ?? [];
	const isCumming = State.variables.player?.status?.isCumming === true;

	let isEnabled = false;
	if (isCumming) {
		isEnabled = pending.some(p => setup.SexualActsDB[p.label]?.isCumming);
	} else {
		isEnabled = pending.length > 0 || ongoing.length > 0;
	}

	$continue.disabled = !isEnabled;
	$continue.classList.toggle("disabled", !isEnabled);
	$continue.onclick = setup.handleSexSceneContinue;

	// --- End Scene Button (right side)
	const $end = document.createElement("button");
	$end.id = "sexSceneEndButton";
	$end.textContent = "End Scene";
	$end.style.flex = "1";
	$end.onclick = () => {
		const exitTarget = State.variables.sexSceneExitTarget || "AfterSexFallback";
		console.log(`[SexSceneExit] 🚪 Exiting to: ${exitTarget}`);
		Engine.play(exitTarget);
	};

	// Append in new order: Continue (left), End (right)
	$footer.appendChild($continue);
	$footer.appendChild($end);
	$wrapper.appendChild($footer);
};



setup.toggleRestAction = function (part) {
	let queue = State.variables.sexScenePendingActions ?? [];
	const cleanedQueue = [];

	for (const entry of queue) {
		const label = entry.label;

		// Always remove other rest actions (you only get one per part)
		if (label.startsWith("__REST_")) continue;

		const act = setup.SexualActsDB[label];
		if (!act) continue;

		// Remove actions assigned to this hand or involving this part
		const isHandMatch = entry.assignedHand === part;
		const isPartMatch = act.subjectParts?.includes(part);

		if (isHandMatch || isPartMatch) continue;

		cleanedQueue.push(entry);
	}

	// Add the new rest action
	cleanedQueue.push({ label: `__REST_${part}` });

	State.variables.sexScenePendingActions = cleanedQueue;

	console.log(`[RestAction] 🧘 Queued rest for '${part}'.`);
	setup.renderSexSceneActions();
};



setup.handleSexSceneContinue = function () {
	console.log("[SexScene] ▶️ CONTINUE TURN");

	let pending = State.variables.sexScenePendingActions ?? [];
	const ongoing = State.variables.sexSceneOngoingActions ?? [];

	// Use ongoing if nothing new is selected
	if (pending.length === 0 && ongoing.length > 0) {
		console.log("[SexScene] 🔁 No new actions selected — reusing ongoing actions.");
		pending = [...ongoing];
		State.variables.sexScenePendingActions = pending;
	}

	if (pending.length === 0) {
		console.log("[SexScene] ⚠️ No actions selected this turn, and no fallback found.");
		return;
	}

	const feedbackBox = document.getElementById("sexSceneFeedbackBox");
	if (feedbackBox) feedbackBox.innerHTML = "";

	const playerStatus = State.variables.player.status;
	const partnerId = Object.keys(State.variables.sexScenePartnerStates ?? {})[0];
	const partnerChar = State.variables.characters[partnerId];
	const partnerState = State.variables.sexScenePartnerStates[partnerId];
	const playerState = State.variables.sexScenePlayerState;
	const partnerStatus = partnerChar.status;

	const isCumming = playerStatus.isCumming ?? false;
	let playerClimaxResolved = false;

	let newOngoing = [...ongoing];
	const npcFeedback = [];
	const playerFeedback = [];

	for (const entry of pending) {
		const label = entry.label;

		// === REST HANDLING
		if (label.startsWith("__REST_")) {
			const restedPart = label.replace("__REST_", "");
			console.log(`[SexScene] 💤 Resting '${restedPart}' — clearing associated actions.`);
			newOngoing = newOngoing.filter(p => {
				const act = setup.SexualActsDB[p.label];
				if (!act) return true;
				const handMatch = p.assignedHand === restedPart;
				const partMatch = act.subjectParts?.includes(restedPart);
				return !(handMatch || partMatch);
			});
			continue;
		}

		const act = setup.SexualActsDB[label];
		if (!act) {
			console.warn(`[SexScene] ❌ Unknown action '${label}'.`);
			continue;
		}

		console.log(`[SexScene] ➤ Applying action '${label}'...`);

		// === Orgasm Resolution
		if (isCumming && act.isCumming) {
			const climaxLines = setup.SexSceneResponses[label]?.climax ?? [];
			const line = climaxLines.length
				? climaxLines[Math.floor(Math.random() * climaxLines.length)]
				: "You groan and release with a shudder.";
			playerFeedback.push(line);

			playerStatus.excitement = 0;
			playerStatus.fatigue = Math.min(playerStatus.fatigue + 40, playerStatus.maxFatigue);
			playerStatus.isCumming = false;
			playerClimaxResolved = true;

			// ✅ Force delayed render refresh after orgasm resolution
			setTimeout(() => {
				if (document.getElementById("sexSceneActionsBox")) {
					console.log("[SexSceneFix] 🔁 Post-orgasm refresh triggered.");
					setup.renderSexSceneActions();
				}
			}, 50); // Delay ensures DOM is ready


			console.log(`[SexScene] ✅ Orgasm resolved with '${label}'.`);
			console.log("   ➕ Excitement reset, fatigue increased.");
			continue; // Do not persist
		}

		// === Arousal Gain
		playerStatus.excitement += act.baseExcitement?.subject ?? 0;
		partnerStatus.excitement += act.baseExcitement?.object ?? 0;

		console.log(`   ➕ Player excitement: ${playerStatus.excitement}`);
		console.log(`   ➕ ${partnerChar.name} excitement: ${partnerStatus.excitement}`);

		partnerState.lastReceivedAction = label;

		// === Ongoing Action Update
		const hand = entry.assignedHand ?? null;
		newOngoing = newOngoing.filter(p => {
			const other = setup.SexualActsDB[p.label];
			if (!other) return true;
			const sameGroup = act.stageGroup && other.stageGroup === act.stageGroup;
			const sameHand = hand ? p.assignedHand === hand : true;
			return !(sameGroup && sameHand);
		});

		if (act.togglable) {
			newOngoing.push({ label, assignedHand: hand });
		} else {
			// Default back to Rest for non-togglable actions
			const restPart = hand ?? act.subjectParts?.[0];
			if (restPart) {
				const restLabel = `__REST_${restPart}`;
				if (!pending.some(p => p.label === restLabel)) {
					pending.push({ label: restLabel });
					console.log(`[SexScene] 🔁 Defaulting '${restPart}' to Rest after non-togglable '${label}'.`);
				}
			}
		}

		// === Feedback Text
		let flavor = "Neutral";
		if (partnerChar.preferences?.sexualActs?.likes?.includes(label)) flavor = "Liked";
		if (partnerChar.preferences?.sexualActs?.dislikes?.includes(label)) flavor = "Disliked";

		const responseList = setup.SexSceneResponses[label]?.[flavor] ?? [];
		const response = responseList.length
			? responseList[Math.floor(Math.random() * responseList.length)]
			: `${partnerChar.name} reacts passively.`;

		(act.receiver === "player" ? playerFeedback : npcFeedback).push(response);

		// === Orgasm Triggers (Post-action)
		if (!isCumming && partnerStatus.excitement >= partnerStatus.maxExcitement) {
			console.log(`[SexScene] 🚨 ${partnerChar.name} orgasm triggered.`);
			setup.triggerOrgasm(partnerId);
		}

		if (!isCumming && playerStatus.excitement >= playerStatus.maxExcitement) {
			console.log("[SexScene] 🚨 Player orgasm triggered.");
			setup.triggerOrgasm("player");
		}
	}

	// === Cleanup & Rerender
	if (!playerClimaxResolved) {
		const validOngoing = newOngoing.filter(entry => {
			const act = setup.SexualActsDB[entry.label];
			if (!act || act.isCumming || act.togglable === false) return false;

			const partOk = act.subjectParts.every(part => {
				const resolved = part === "hand" ? entry.assignedHand : part;
				const state = playerState.parts?.[resolved];
				return state && !state.bound && !state.disabled;
			});
			if (!partOk) return false;

			if (act.objectParts?.some(p => !partnerState.parts?.[p])) return false;

			if (act.skillsRequired) {
				for (const [skill, min] of Object.entries(act.skillsRequired)) {
					if ((State.variables.player.skills?.[skill] ?? 0) < min) return false;
				}
			}

			return true;
		});

		State.variables.sexSceneOngoingActions = validOngoing;
		State.variables.sexScenePendingActions = [];
		setup.renderSexSceneActions();

		// === Run NPC Turn
		const npcIds = Object.keys(State.variables.sexScenePartnerStates ?? {});
		for (const npcId of npcIds) {
			setup.npcDecideActions(npcId);
		}

	}

	// === Render Feedback
	if (feedbackBox) {
		if (npcFeedback.length > 0) {
			const npcPara = document.createElement("p");
			npcPara.innerHTML = npcFeedback.map(l => `<span>${l}</span>`).join(" ");
			feedbackBox.appendChild(npcPara);
		}
		if (playerFeedback.length > 0) {
			const playerPara = document.createElement("p");
			playerPara.innerHTML = playerFeedback.map(l => `<span>${l}</span>`).join(" ");
			feedbackBox.appendChild(playerPara);
		}
	}

	console.groupCollapsed("[SexScene] 🧷 Final Ongoing Actions");
	console.dir(State.variables.sexSceneOngoingActions);
	console.groupEnd();
	console.log("[SexScene] 🔁 Turn complete.");
};


/* ======================================================
   ORGASM TRIGGER & FEEDBACK SYSTEM
 ===================================================== */

setup.triggerOrgasm = function (charId) {
	const isPlayer = charId === "player";
	const char = isPlayer ? State.variables.player : State.variables.characters?.[charId];
	const state = isPlayer ? State.variables.sexScenePlayerState : State.variables.sexSceneNPCStates?.[charId];

	if (!char || !state) {
		console.warn(`[Orgasm] ❌ Could not resolve character or state for '${charId}'.`);
		return;
	}

	// Clamp excitement and apply fatigue
	char.status.excitement = 0;
	char.status.fatigue = Math.min(char.status.fatigue + 40, char.status.maxFatigue);

	console.log(`[Orgasm] 💦 ${isPlayer ? "Player" : char.name} orgasmed.`);
	console.log(`   ➡️ Fatigue now: ${char.status.fatigue}/${char.status.maxFatigue}`);

	if (!isPlayer) {
		setup.displayNPCOrgasmFeedback?.(charId);
		return;
	}

	const hasPenis = !!state.parts?.penis;
	const hasVagina = !!state.parts?.vagina;

	// === Auto-orgasm for vagina-only players
	if (!hasPenis && hasVagina) {
		console.log("[Orgasm] ✅ Auto-resolving climax for vagina-only player.");

		const feedbackBox = document.getElementById("sexSceneFeedbackBox");
		if (feedbackBox) {
			const p = document.createElement("p");
			p.innerHTML = "A wave of pleasure crashes over you as your body trembles in release.";
			feedbackBox.appendChild(p);
		}

		char.status.isCumming = false;
		State.variables.sexScenePendingActions = [];
		State.variables.sexSceneOngoingActions = [];

		setup.renderSexSceneActions();
		return;
	}

	// === Manual orgasm resolution (requires orgasm choice action)
	char.status.isCumming = true;
	console.log("[Orgasm] 🚩 Player is now in 'isCumming' resolution phase.");

	// ✅ Clear ongoing, and force every body part to rest
	State.variables.sexSceneOngoingActions = [];
	State.variables.sexScenePendingActions = [];

	const parts = Object.keys(state.parts ?? {});
	for (const part of parts) {
		State.variables.sexScenePendingActions.push({ label: `__REST_${part}` });
		console.log(`[Orgasm] 🔄 Forcing '${part}' to REST (pending) during orgasm resolution.`);
	}

	// ✅ Display prompt
	const feedbackBox = document.getElementById("sexSceneFeedbackBox");
	if (feedbackBox) {
		const p = document.createElement("p");
		p.innerHTML = "You're right at the edge. How do you want to finish?";
		feedbackBox.appendChild(p);
		console.log("[OrgasmUI] 💬 Prompt rendered in feedback box.");
	}

	// ✅ Trigger rerender to reflect forced REST state
	setup.renderSexSceneActions();
};


setup.autoResolveVaginalOrgasm = function () {
	const feedbackBox = document.getElementById("sexSceneFeedbackBox");
	if (!feedbackBox) {
		console.warn("[Orgasm] ❌ Feedback box not found for auto-orgasm.");
		return;
	}

	const p = document.createElement("p");
	p.innerHTML = "A wave of pleasure crashes over you as your body trembles in release.";
	feedbackBox.appendChild(p);

	// Reset orgasm state and clear queued actions
	State.variables.player.status.isCumming = false;
	State.variables.player.status.excitement = 0;
	State.variables.sexScenePendingActions = [];
	State.variables.sexSceneOngoingActions = [];

	setup.renderSexSceneActions();
	console.log("[Orgasm] ✅ Auto-orgasm complete.");
};


setup.displayNPCOrgasmFeedback = function (npcId) {
	const state = State.variables.sexSceneNPCStates?.[npcId];
	const lastAct = state?.lastReceivedAction ?? null;
	const npc = State.variables.characters?.[npcId];
	const feedbackBox = document.getElementById("sexSceneFeedbackBox");

	if (!npc || !feedbackBox) {
		console.warn(`[OrgasmFeedback] ❌ Missing NPC or feedbackBox for '${npcId}'.`);
		return;
	}

	let climaxText = `${npc.name} orgasms, body trembling with release.`; // Default fallback

	if (lastAct) {
		const response = setup.SexSceneResponses[lastAct];
		const climaxLines = response?.climax ?? [];

		if (Array.isArray(climaxLines) && climaxLines.length > 0) {
			climaxText = climaxLines[Math.floor(Math.random() * climaxLines.length)];
			console.log(`[OrgasmFeedback] 💬 '${npc.name}' climax response sourced from '${lastAct}'.`);
		} else {
			console.log(`[OrgasmFeedback] ⚠️ No climax lines found for '${lastAct}'. Using fallback.`);
		}
	} else {
		console.log(`[OrgasmFeedback] ⚠️ No lastReceivedAction for '${npc.name}'. Using fallback.`);
	}

	const p = document.createElement("p");
	try {
		const span = document.createElement("span");
		new Wikifier(span, climaxText);
		p.innerHTML = span.innerHTML;
	} catch (err) {
		console.warn(`[OrgasmFeedback] ❌ Error parsing climax text: ${err.message}`);
		p.textContent = climaxText;
	}

	feedbackBox.appendChild(p);
};

setup.scheduleSexSceneRefresh = function () {
	console.log("[SexSceneFix] ⏳ Scheduling post-passage render refresh...");

	requestAnimationFrame(() => {
		setTimeout(() => {
			if (document.getElementById("sexSceneActionsBox")) {
				console.log("[SexSceneFix] 🔁 Forcing UI refresh after passage load.");
				setup.renderSexSceneActions();
			} else {
				console.warn("[SexSceneFix] ⚠️ Action box not found. Skipping refresh.");
			}
		}, 50); // tweak if needed
	});
};


setup.offerPlayerOrgasmChoices = function () {
	const box = document.getElementById("sexSceneFeedbackBox");
	if (!box) {
		console.warn("[OrgasmUI] ❌ Feedback box not found — cannot render prompt.");
		return;
	}

	// ✅ Insert the prompt at the bottom of feedback
	const p = document.createElement("p");
	p.innerHTML = "You're right at the edge. How do you want to finish?";
	box.appendChild(p);
	console.log("[OrgasmUI] 💬 Prompt inserted. Context-aware orgasm filtering in progress...");

	const playerState = State.variables.sexScenePlayerState;
	const ongoing = State.variables.sexSceneOngoingActions ?? [];

	// 🧠 Derive orgasm context based on ongoing stimulation
	const contextTags = new Set();

	for (const entry of ongoing) {
		const act = setup.SexualActsDB[entry.label];
		if (!act || act.isCumming) continue;

		// Include object parts to derive physical context
		act.objectParts?.forEach(part => {
			if (part === "vagina") contextTags.add("vaginal_internal");
			if (part === "anus") contextTags.add("anal_internal");
			if (part === "face") contextTags.add("facial");
			if (["breasts", "feet", "mouth", "clitoris"].includes(part)) contextTags.add("external");
		});

		// Add inclination context
		act.inclinationTags?.forEach(tag => {
			if (["penetration", "control", "release", "dominance"].includes(tag)) {
				contextTags.add(tag);
			}
		});
	}

	// 🔍 Find valid orgasm actions for the current context
	const playerParts = playerState?.parts ?? {};
	const partnerId = Object.keys(State.variables.sexScenePartnerStates ?? {})[0];
	const partnerParts = State.variables.sexScenePartnerStates?.[partnerId]?.parts ?? {};

	const validOptions = [];

	for (const [label, act] of Object.entries(setup.SexualActsDB)) {
		if (!act.isCumming) continue;

		const hasPlayerParts = act.subjectParts.every(part => playerParts[part]);
		const hasPartnerParts = act.objectParts.every(part => partnerParts[part]);
		if (!hasPlayerParts || !hasPartnerParts) continue;

		const match = act.orgasmTags?.some(tag => contextTags.has(tag));
		if (match) {
			validOptions.push({ label, act });
		}
	}

	// 🛑 Fallback: if no context matches, show all options
	if (validOptions.length === 0) {
		console.warn("[OrgasmUI] ⚠️ No orgasm actions matched context — showing all by default.");
		for (const [label, act] of Object.entries(setup.SexualActsDB)) {
			if (act.isCumming) {
				const hasPlayerParts = act.subjectParts.every(part => playerParts[part]);
				const hasPartnerParts = act.objectParts.every(part => partnerParts[part]);
				if (hasPlayerParts && hasPartnerParts) {
					validOptions.push({ label, act });
				}
			}
		}
	}

	// 👻 Inject filtered orgasm options directly into UI groups on next render
	State.variables.sexSceneFilteredOrgasmOptions = validOptions.map(opt => opt.label);
	console.log(`[OrgasmUI] ✅ ${validOptions.length} orgasm options queued for button render.`);
	setup.renderSexSceneActions(); // Re-render buttons now that options are filtered
};



/*=========================================================================================
================= NPC DECISION MAKING =====================================================
======================================================================================== */
setup.partExists = function (part, partsObj) {
	switch (part) {
		case "hand":
			return !!(partsObj.leftHand || partsObj.rightHand);
		case "genital":
			return !!(partsObj.penis || partsObj.vagina);
		default:
			return !!partsObj[part];
	}
};


setup.npcDecideActions = function (npcId) {
	const npc = State.variables.characters?.[npcId];
	const npcState = State.variables.sexScenePartnerStates?.[npcId];
	const playerState = State.variables.sexScenePlayerState;

	if (!npc || !npcState || !playerState) {
		console.warn(`[NPC AI] ❌ Could not resolve required data for '${npcId}'.`);
		return;
	}

	const availableActs = [];

	for (const [label, act] of Object.entries(setup.SexualActsDB)) {
		if (act.giver !== "npc" || act.receiver !== "player") continue;
		if (act.isCumming) continue;

		// Use partExists to validate anatomy
		const npcHasParts = act.subjectParts.every(p => setup.partExists(p, npcState.parts));
		const playerHasParts = act.objectParts.every(p => setup.partExists(p, playerState.parts));
		if (!npcHasParts || !playerHasParts) continue;

		const score = setup.npcEvaluateAction(npc, act);
		availableActs.push({ label, score });
	}

	if (availableActs.length === 0) {
		console.warn(`[NPC AI] ⚠ No valid acts found for '${npc?.name ?? npcId}'.`);
		return;
	}

	const topActs = availableActs.sort((a, b) => b.score - a.score).slice(0, 3);
	const chosen = topActs[Math.floor(Math.random() * topActs.length)];

	if (State.variables.sexScenePendingActions.some(p => p.label === chosen.label)) {
		console.log(`[NPC AI] ⚠ '${npc.name}' attempted to reuse '${chosen.label}'. Skipping.`);
		return;
	}

	console.log(`[NPC AI] 🤔 '${npc.name}' selects '${chosen.label}' (score: ${chosen.score})`);

	npcState.recentActs = npcState.recentActs ?? [];
	npcState.recentActs.push(chosen.label);

	State.variables.sexScenePendingActions.push({
		label: chosen.label,
		data: setup.SexualActsDB[chosen.label]
	});
};



setup.npcEvaluateAction = function (npc, act) {
	let score = 10;

	const npcPrefs = npc.preferences?.sexualActs;
	const npcInclinations = npc.inclinations ?? [];
	const npcStatus = npc.status ?? {};
	const playerStatus = State.variables.player?.status ?? {};
	const mood = State.variables.sexScenePartnerStates?.[npc.id]?.mood ?? null;

	// === Preferences
	if (npcPrefs?.likes?.includes(act.label)) score += 20;
	if (npcPrefs?.dislikes?.includes(act.label)) score -= 20;

	// === Fatigue / Excitement
	if (npcStatus.excitement >= 70 && act.stageLevel >= 1) score += 15;
	if (npcStatus.fatigue >= 70 && act.stageLevel <= 0) score += 10;

	if (playerStatus.excitement >= 80 && act.baseExcitement?.object >= 10) score += 10;

	// === Inclinations
	if (act.inclinationTags) {
		for (const tag of act.inclinationTags) {
			if (npcInclinations.includes(tag)) score += 5;
		}
	}

	// === Mood Biasing
	if (mood === "aggressive" && act.stageLevel >= 1) score += 8;
	if (mood === "gentle" && act.stageLevel === 0) score += 8;
	if (mood === "teasing" && act.stageLevel === 0 && act.inclinationTags?.includes("tease")) {
		score += 10;
	}

	// === Small randomness for variation
	score += Math.random() * 5;

	return score;
};


setup.npcMoodInit = function (npcId) {
	const state = State.variables.sexScenePartnerStates?.[npcId];
	if (!state) {
		console.warn(`[NPC AI] ❌ Cannot assign mood — no partner state for '${npcId}'.`);
		return;
	}

	const moods = ["aggressive", "teasing", "gentle"];
	const index = Math.floor(Math.random() * moods.length);
	const mood = moods[index];

	state.mood = mood;

	console.log(`[NPC AI] 🎭 '${npcId}' mood initialized as '${mood}'.`);
};


setup.npcInclinationShift = function (npcId) {
	const npc = State.variables.characters?.[npcId];
	const npcState = State.variables.sexScenePartnerStates?.[npcId];
	if (!npc || !npcState?.recentActs?.length) return;

	const seen = new Set();

	for (const actLabel of npcState.recentActs) {
		if (seen.has(actLabel)) continue;
		seen.add(actLabel);

		if (Math.random() > 0.1) continue; // 10% chance to learn

		const act = setup.SexualActsDB[actLabel];
		if (!act?.inclinationTags) continue;

		for (const tag of act.inclinationTags) {
			if (!npc.inclinations?.includes(tag)) {
				npc.inclinations = npc.inclinations ?? [];
				npc.inclinations.push(tag);
				console.log(`[NPC AI] 🌱 '${npc.name}' developed inclination toward '${tag}' from '${actLabel}'.`);
			}
		}
	}

	npcState.recentActs = []; // Clear tracking
};
/* twine-user-script #27: "15_npcSystems.js" */
setup.NPCs = [];

setup.generateNPC = function (gender, race, archetypeName, seed) {
    const archetype = setup.Archetypes[archetypeName];
    const rng = new Math.seedrandom(seed ?? Math.random());

    const namePool = setup.NamePools[race]?.[gender];
    const name = namePool[Math.floor(rng() * namePool.length)];

    const stats = {};
    for (let stat in archetype.statRanges) {
        const [min, max] = archetype.statRanges[stat];
        stats[stat] = Math.floor(rng() * (max - min + 1)) + min;
    }

    const trait = setup.Traits[Math.floor(rng() * setup.Traits.length)];
    const inclination = setup.Inclinations[Math.floor(rng() * setup.Inclinations.length)];
    const style = archetype.styles[Math.floor(rng() * archetype.styles.length)];

    const npc = {
        id: `npc-${Date.now()}-${Math.floor(rng() * 1000)}`,
        name,
        gender,
        race,
        archetype: archetypeName,
        stats,
        trait,
        inclination,
        style
    };

    setup.NPCs.push(npc);
    return npc;
};

setup.filterNPCs = function (criteria = {}) {
    return setup.NPCs.filter(npc => {
        return Object.entries(criteria).every(([key, val]) => {
            return npc[key] === val || (Array.isArray(val) && val.includes(npc[key]));
        });
    });
};
/* twine-user-script #28: "CrownAndCasteLogic.js" */
setup.CrownAndCaste = {
  // ==========================
  // 1. Core Initialization
  // ==========================

initSession(playerIds, stakes = "standard", houseRules = [], playerFavor = 1.0, buyIn = 15) {
  const maxPlayers = 4;
  const finalIds = playerIds.slice(0, maxPlayers);

  const generatedPlayers = finalIds.map((id, index) => {
    const basePlayer = {
      gold: buyIn,
      chips: 3,
      casteDice: [null, null, null],
      locks: [false, false, false],
      combo: null,
      scoreRank: null,
      isEliminated: false,
      bet: 0,
    };

    // 🧍 Player (always first)
    if (index === 0) {
      return {
        ...basePlayer,
        name: typeof id === "string" ? id : "You",
        isPlayer: true,
        isGhost: false,
      };
    }

    // 👻 Generic Ghost
    if (id === "ghost") {
      return {
        ...basePlayer,
        name: `Ghost ${index}`,
        isPlayer: false,
        isGhost: true,
      };
    }

    // 📝 Custom literal name object (e.g., { name: "Stranger" })
    if (typeof id === "object" && id.name) {
      return {
        ...basePlayer,
        name: id.name,
        isPlayer: false,
        isGhost: false,
        npcId: `custom-${index}`,
      };
    }

    // 🧠 Standard character from character list
    const npc = State.variables.characters?.[id];
    return {
      ...basePlayer,
      name: npc?.name || `Unknown (${id})`,
      isPlayer: false,
      isGhost: false,
      npcId: id,
    };
  });

  State.temporary.ccSession = {
    players: generatedPlayers,
    dealerIndex: Math.floor(Math.random() * generatedPlayers.length),
    currentRound: 1,
    currentPlayerIndex: 0,
    crownDice: [null, null, null],
    crownLocks: [false, false, false],
    crownProtected: false,
    gameNumber: 1,
    totalGamesInSession: 0,
    pot: 0,
    turnPhase: "betting",
    gamesSinceChipRefresh: 0,
    gameComplete: false,
    stakes: stakes,
    chipCost: setup.CrownAndCaste.getChipCost(stakes),
    houseRules: houseRules,
    playerFavor: playerFavor
  };

  console.log(`[CrownAndCaste] Session initialized with ${generatedPlayers.length} players (Buy-In: ${buyIn}g)`);
},  
  
  hasHouseRule(ruleName) {
    const session = State.temporary.ccSession;
    return session.houseRules && session.houseRules.includes(ruleName);
  },

  getStandardBet(stakes) {
    switch (stakes.toLowerCase()) {
      case "low": return 3;
      case "standard": return 5;
      case "high": return 10;
      default: return 5;
    }
  },

  getChipCost(stakes) {
    switch (stakes.toLowerCase()) {
      case "low": return 2;
      case "standard": return 3;
      case "high": return 5;
      default: return 3;
    }
  },
  
startGame() {
  const session = State.temporary.ccSession;

  if (!session || !session.players) {
    console.error("[CrownAndCaste] No session found. Call initSession first.");
    return;
  }

  session.currentRound = 1;
  session.currentPlayerIndex = 0;
  session.pot = 0;
  session.turnPhase = "rolling";
  session.crownDice = [null, null, null];
  session.crownLocks = [false, false, false];
  session.crownProtected = false;
  session.turnsTakenThisRound = 0;
  session.gameComplete = false;

  // 🎯 Determine active (non-eliminated) players
  const activePlayers = session.players.filter(p => !p.isEliminated);
  let standardBet = this.getStandardBet(session.stakes);

  // 💰 Double bet if only 2 players remain
  if (activePlayers.length === 2) {
    standardBet *= 2;
    console.log(`[CrownAndCaste] Only 2 players remain — doubling base bet to ${standardBet}g.`);
  }

  for (const player of session.players) {
    player.casteDice = [null, null, null];
    player.locks = [false, false, false];
    player.combo = null;
    player.scoreRank = null;
    player.usedChipThisTurn = false;

    // 💰 Deduct standard bet or go all-in
    const betAmount = Math.min(player.gold, standardBet);
    player.bet = betAmount;
    player.gold -= betAmount;
    session.pot += betAmount;

    console.log(`[CrownAndCaste] ${player.name} bet ${betAmount}g. Remaining gold: ${player.gold}`);
  }

  // 🎲 Roll Crown Die 1 to start
  this.rollCrownDie(0);

  // 🕹 First active (non-eliminated) player goes first
  for (let i = 0; i < session.players.length; i++) {
    const p = session.players[i];
    if (!p.isEliminated) {
      session.currentPlayerIndex = i;
      this.rollCasteDice(i);
      if (!p.isPlayer) this.processNPCTurn(i);
      break;
    }
  }

  console.log(`[CrownAndCaste] Game ${session.gameNumber} started. Standard bet applied: ${standardBet}g`);
},



  startNextGame() {
    const session = State.temporary.ccSession;

    if (!session || !session.players) {
      console.error("[CrownAndCaste] No session found. Cannot start next game.");
      return;
    }

    if (!session.gameComplete) {
      console.warn("[CrownAndCaste] Current game is not complete. Cannot start next game.");
      return;
    }

    console.log(`[CrownAndCaste] Starting next game (Game ${session.gameNumber}) in session...`);
    
    // Start the next game
    this.startGame();
    
    // Update UI to reflect new game state
    this.updateUI();
  },



  endTurn() {
    const session = State.temporary.ccSession;

    // 🛑 Guard against recursive turn-ending loops
    if (session._currentlyEndingTurn) {
      console.warn("[CrownAndCaste] Prevented recursive endTurn call.");
      return;
    }
    session._currentlyEndingTurn = true;

    const currentPlayer = session.players[session.currentPlayerIndex];
    console.log(`[CrownAndCaste] Ending turn for ${currentPlayer.name}`);

    // 🧮 Track that one player just finished their turn
    session.turnsTakenThisRound++;

    const players = session.players;
    const activePlayers = players.filter(p => !p.isEliminated).length;
    const roundComplete = session.turnsTakenThisRound >= activePlayers;

    console.log(`[CrownAndCaste] Turn ${session.turnsTakenThisRound}/${activePlayers} completed. Round complete: ${roundComplete}`);

    if (roundComplete) {
      if (session.currentRound < 3) {
        // 🔁 Advance to next round
        session.currentRound++;
        session.turnsTakenThisRound = 0;

        console.log(`[CrownAndCaste] Advancing to Round ${session.currentRound}`);

        // 🎲 Roll the next Crown Die
        this.rollCrownDie(session.currentRound - 1);

        // 🔄 Reset chip usage for all players (1 chip per round)
        session.players.forEach(p => {
          p.usedChipThisTurn = false;
        });

        // 👑 Start next round with first player after dealer
        session.currentPlayerIndex = this.getNextPlayerClockwise(session.dealerIndex);
        const starter = session.players[session.currentPlayerIndex];
        console.log(`[CrownAndCaste] Round ${session.currentRound} starts with ${starter.name}`);

        // 🎲 Auto-roll their unlocked Caste Dice
        this.rollCasteDice(session.currentPlayerIndex);

        // ✅ Resume game
        session._currentlyEndingTurn = false;
        this.updateUI();

        if (!starter.isPlayer) {
          this.scheduleNPCTurn(session.currentPlayerIndex);
        }

        return;

      } else {
        // ✅ Final round completed — lock all dice before resolving
        session.players.forEach(p => {
          if (!p.isEliminated) {
            p.locks = [true, true, true];
          }
        });

        session.crownLocks = [true, true, true];
        session.crownProtected = true;

        console.log("[CrownAndCaste] Final round reached — all dice have been locked.");
        console.log("[CrownAndCaste] Final round completed. Resolving game...");

        session._currentlyEndingTurn = false;
        this.resolveGame();
        return;
      }
    }


    // 🔁 Continue to next player in same round
    const nextPlayerIndex = this.getNextPlayerClockwise(session.currentPlayerIndex);
    if (nextPlayerIndex === -1) {
      console.warn("[CrownAndCaste] No next player found!");
      session._currentlyEndingTurn = false;
      return;
    }

    session.currentPlayerIndex = nextPlayerIndex;
    const nextPlayer = session.players[nextPlayerIndex];
    console.log(`[CrownAndCaste] Next turn: ${nextPlayer.name}`);

    if (session.currentRound > 1) {
      this.rollCasteDice(nextPlayerIndex);
    }

    session._currentlyEndingTurn = false;
    this.updateUI();

    if (!nextPlayer.isPlayer) {
      this.scheduleNPCTurn(nextPlayerIndex);
    }
  },


  updateUI() {
    if (setup.CrownAndCasteUI?.updateGameStatus) {
      setup.CrownAndCasteUI.updateGameStatus();
    }
    if (setup.CrownAndCasteUI?.updateInteractionStates) {
      setup.CrownAndCasteUI.updateInteractionStates();
    }
    if (setup.CrownAndCasteUI?.renderPlayerPanels) {
      setup.CrownAndCasteUI.renderPlayerPanels();
    }
    if (setup.CrownAndCasteUI?.renderCrownDice) {
      setup.CrownAndCasteUI.renderCrownDice();
    }
  },

  scheduleNPCTurn(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    console.log(`[CrownAndCaste] Scheduling NPC turn for ${npc.name}`);
    
    // Process NPC actions immediately
    this.processNPCDiceActions(playerIndex);
    this.processNPCChipStrategy(playerIndex);
    
    // Schedule turn end after delay
    setTimeout(() => {
      if (!session._currentlyEndingTurn && session.currentPlayerIndex === playerIndex) {
        console.log(`[CrownAndCaste] Auto-ending turn for NPC ${npc.name}`);
        this.endTurn();
      }
    }, 1500);
  },

  advancePhase() {
    const session = State.temporary.ccSession;
    
    switch (session.turnPhase) {
      case "crown-roll":
        this.rollCrownDie(session.currentRound - 1);
        session.turnPhase = "player-actions";
        session.currentPlayerIndex = this.getNextPlayerClockwise(session.dealerIndex);
        break;
        
      case "player-actions":
        if (this.allPlayersActed()) {
          if (session.currentRound < 3) {
            session.currentRound++;
            session.turnPhase = "crown-roll";
          } else {
            this.resolveGame();
          }
        } else {
          session.currentPlayerIndex = this.getNextPlayerClockwise(session.currentPlayerIndex);
        }
        break;
    }
  },

  endSession() {
    const session = State.temporary.ccSession;
    
    // Reset all chips at session end
    session.players.forEach(p => {
      if (!p.isEliminated) {
        p.chips = 3;
      }
    });
    
    console.log("[CrownAndCaste] Session ended. All Control Chips reset.");
  },
  // ==========================
  // 2. Dice Logic
  // ==========================

  rollCasteDice(playerIndex) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];

    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Cannot roll dice for player index ${playerIndex}`);
      return;
    }

    for (let i = 0; i < 3; i++) {
      if (!player.locks[i]) {
        // Always reroll unlocked dice in Rounds 2 and 3
        if (session.currentRound > 1 || player.casteDice[i] === null) {
          player.casteDice[i] = this.rollDie();
        }
      }
    }

    console.log(`[CrownAndCaste] Rolled Caste Dice for ${player.name}:`, player.casteDice);

    // 🟠 House Rule: Cutthroat Caste
    if (this.hasHouseRule?.("cutthroat-caste")) {
      const hasLockedDie = player.locks.some(lock => lock);
      if (!hasLockedDie) {
        console.warn(`[CrownAndCaste] Cutthroat Caste: ${player.name} must lock at least one die.`);
        // Simple enforcement: auto-lock first die
        player.locks[0] = true;
        console.log(`[CrownAndCaste] Cutthroat Caste enforced: auto-locked die 1 for ${player.name}.`);
      }
    }

    if (setup.CrownAndCasteUI?.updateDiceDisplay) {
      setup.CrownAndCasteUI.updateDiceDisplay(playerIndex);
    }
  },


  lockDie(playerIndex, dieIndex) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];

    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Cannot toggle lock for player index ${playerIndex}`);
      return;
    }

    if (dieIndex < 0 || dieIndex >= 3) {
      console.warn(`[CrownAndCaste] Invalid die index: ${dieIndex}`);
      return;
    }

    const isLocked = player.locks[dieIndex];

    if (!isLocked) {
      // Locking is always allowed
      player.locks[dieIndex] = true;
      console.log(`[CrownAndCaste] ${player.name} locked die ${dieIndex + 1}`);
    } else {
      // Unlocking only allowed in Round 1
      if (session.currentRound === 1) {
        player.locks[dieIndex] = false;
        console.log(`[CrownAndCaste] ${player.name} unlocked die ${dieIndex + 1}`);
      } else {
        console.warn(`[CrownAndCaste] ${player.name} cannot unlock die after Round 1.`);
        setup.CrownAndCasteUI?.showFeedback?.("You can't unlock dice in later rounds!");
        return; // Stop here; don't call UI update
      }
    }

    // Update lock icon
    if (setup.CrownAndCasteUI?.updateLockDisplay) {
      setup.CrownAndCasteUI.updateLockDisplay(playerIndex, dieIndex, player.locks[dieIndex]);
    }
  },


  rollCrownDie(index, { isControlChip = false } = {}) {
    const session = State.temporary.ccSession;

    if (index < 0 || index > 2) {
      console.warn(`[CrownAndCaste] Invalid Crown Die index: ${index}`);
      return;
    }

    if (isControlChip && session.crownProtected) {
      console.warn(`[CrownAndCaste] Crown is protected. Cannot reroll Crown Die ${index + 1} via Control Chip.`);
      return;
    }

    const dealer = session.players[session.dealerIndex];
    const customDie = this.getDealerCrownDie(dealer, index);

    const value = (customDie && typeof customDie.roll === "function")
      ? customDie.roll()
      : this.rollDie();

    session.crownDice[index] = value;

    console.log(`[CrownAndCaste] Crown Die ${index + 1} rolled: ${value}${customDie ? ` (using ${customDie.name})` : ""}`);

    if (setup.CrownAndCasteUI?.updateCrownDisplay) {
      setup.CrownAndCasteUI.updateCrownDisplay(index, value);
    }
  },


  getDealerCrownDie(dealer, index) {
    if (!dealer || dealer.isEliminated) return null;
    
    // Get dealer's inventory
    const dealerInventory = State.variables[`inventory_${dealer.isPlayer ? 'player' : dealer.npcId}`];
    if (!dealerInventory) return null;
    
    // Find Crown dice in inventory
    const crownDiceIds = Object.keys(dealerInventory).filter(itemId => {
      const item = getItemMetadata(itemId);
      return item && item.subtype === "crown-die";
    });
    
    if (crownDiceIds.length === 0) return null;
    
    // Use the crown die at the specified index, or cycle through available ones
    const selectedId = crownDiceIds[index % crownDiceIds.length];
    return getItemMetadata(selectedId);
  },


  lockCrownDice() {
    const session = State.temporary.ccSession;

    session.crownProtected = true;
    session.crownLocks = [true, true, true];

    console.log(`[CrownAndCaste] Crown has been protected. All Crown Dice are now locked.`);

    if (setup.CrownAndCasteUI?.updateCrownLockDisplay) {
      for (let i = 0; i < 3; i++) {
        setup.CrownAndCasteUI.updateCrownLockDisplay(i, true);
      }
    }
  },

  // ==========================
  // 3. Control Chips
  // ==========================

  useControlChip(playerIndex, actionType, targetIndex = null) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];

    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Invalid or eliminated player for chip use.`);
      return;
    }

    if (player.usedChipThisTurn) {
      console.warn(`[CrownAndCaste] ${player.name} already used a Control Chip this turn.`);
      return;
    }

    if (playerIndex === session.dealerIndex) {
      console.warn(`[CrownAndCaste] Dealer cannot use Control Chips.`);
      return;
    }

    if (actionType === "reroll-other" && targetIndex === session.dealerIndex) {
      console.warn("[CrownAndCaste] Cannot target dealer with Control Chips.");
      return;
    }

    if (player.chips <= 0) {
      console.warn(`[CrownAndCaste] Player ${player.name} has no Control Chips left.`);
      return;
    }

    let chipCost = session.chipCost || 2;
    if (this.hasHouseRule("golden-tax")) {
      chipCost += 1;
    }

    const actualCost = Math.min(chipCost, player.gold); // Fortune's Mercy
    player.gold -= actualCost;
    session.pot += actualCost; // Add to pot
    player.chips--;
    player.usedChipThisTurn = true;

    console.log(`[CrownAndCaste] ${player.name} used a Control Chip (${actionType}), paid ${actualCost}g.`);

    switch (actionType) {
      case "reroll-own": {
        if (targetIndex === null || targetIndex < 0 || targetIndex >= 3) {
          console.warn("[CrownAndCaste] Invalid targetIndex for reroll-own.");
          return;
        }

        if (!player.locks[targetIndex]) {
          console.warn(`[CrownAndCaste] Cannot reroll an unlocked die.`);
          return;
        }

        player.casteDice[targetIndex] = this.rollDie();
        console.log(`[CrownAndCaste] ${player.name} rerolled their locked die ${targetIndex + 1}.`);
        break;
      }

      case "reroll-other": {
        const targetInfo = targetIndex; // now expecting { targetPlayerIndex, dieIndex }
        const targetPlayer = session.players[targetInfo.targetPlayerIndex];

        if (!targetPlayer || targetPlayer.isEliminated || targetInfo.targetPlayerIndex === playerIndex) {
          console.warn("[CrownAndCaste] Invalid target for reroll-other.");
          return;
        }

        const dieIndex = targetInfo.dieIndex;

        if (
          dieIndex < 0 || dieIndex >= 3 ||
          !targetPlayer.locks[dieIndex]
        ) {
          console.warn(`[CrownAndCaste] Cannot reroll die ${dieIndex + 1} — not locked or invalid.`);
          return;
        }

        const oldValue = targetPlayer.casteDice[dieIndex];
        const newValue = this.rollDie();
        targetPlayer.casteDice[dieIndex] = newValue;

        console.log(`[CrownAndCaste] ${player.name} rerolled ${targetPlayer.name}'s locked die ${dieIndex + 1} (was ${oldValue}, now ${newValue}).`);

        if (setup.CrownAndCasteUI?.renderPlayerPanels) {
          setup.CrownAndCasteUI.renderPlayerPanels();
        }

        break;
      }



      case "reroll-crown": {
        if (targetIndex === null || targetIndex < 0 || targetIndex >= 3) {
          console.warn("[CrownAndCaste] Invalid crown die index for reroll.");
          return;
        }

        if (session.crownLocks[targetIndex]) {
          console.warn("[CrownAndCaste] That Crown Die is locked. Cannot reroll.");
          return;
        }

        if (session.crownDice[targetIndex] === null) {
          console.warn("[CrownAndCaste] Cannot reroll an unrolled Crown Die.");
          return;
        }

        this.rollCrownDie(targetIndex);
        console.log(`[CrownAndCaste] ${player.name} rerolled Crown Die ${targetIndex + 1}.`);
        break;
      }



      case "lock-crown": {
        this.lockCrownDice();
        console.log(`[CrownAndCaste] ${player.name} used a chip to Protect the Crown.`);
        break;
      }

      default:
        console.warn(`[CrownAndCaste] Unknown actionType: ${actionType}`);
        break;
    }

    if (setup.CrownAndCasteUI?.updateChipDisplay) {
      setup.CrownAndCasteUI.updateChipDisplay(playerIndex, player.chips, player.gold);
    }
  },

  canUseControlChip(playerIndex) {
    const session = State.temporary.ccSession;
    const player = session.players?.[playerIndex];
    
    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Cannot use chip: invalid or eliminated player at index ${playerIndex}.`);
      return false;
    }

    if (playerIndex === session.dealerIndex) {
      console.log(`[CrownAndCaste] Dealer cannot use Control Chips.`);
      return false;
    }

    if (player.usedChipThisTurn) {
      console.log(`[CrownAndCaste] ${player.name} already used a Control Chip this turn.`);
      return false;
    }
  
    const hasChips = player.chips > 0;
  
    if (!hasChips) {
      console.log(`[CrownAndCaste] ${player.name} has no Control Chips left.`);
    }
  
    return hasChips;
  },
  

  // ==========================
  // 4. Scoring & Results
  // ==========================

  resolveGame() {
    const session = State.temporary.ccSession;

    if (!session || !session.players || session.players.length === 0) {
      console.error("[CrownAndCaste] Cannot resolve game: no session or players found.");
      return;
    }

    // Evaluate each player's combo
    session.players.forEach((p, i) => {
      const hasTripleSix = p.casteDice.filter(d => d === 6).length === 3;
      if (hasTripleSix && this.hasHouseRule?.("blessing-of-sixes")) {
        p.combo = { name: "Blessing of Sixes", usedDice: [0, 1, 2], rank: 999 };
        p.scoreRank = 999;
        console.log(`[CrownAndCaste] ${p.name} triggered Blessing of Sixes!`);
      } else {
        p.combo = this.evaluateCombos(p); // { name, details? }
        p.scoreRank = this.rankCombo(p.combo.name);
        console.log(`[CrownAndCaste] ${p.name}'s combo: ${p.combo.name} (Rank ${p.scoreRank})`);
      }
    });

    // Find highest ranked player(s)
    const ranked = session.players.map((p, i) => ({ index: i, rank: p.scoreRank }));
    ranked.sort((a, b) => b.rank - a.rank); // highest rank first

    const topRank = ranked[0].rank;
    const tied = ranked.filter(r => r.rank === topRank);
    let winnerIndex;

    if (tied.length > 1) {
      winnerIndex = this.breakTie(tied.map(r => r.index));
      console.log(`[CrownAndCaste] Tie-breaker selected winner: ${session.players[winnerIndex].name}`);
    } else {
      winnerIndex = tied[0].index;
      console.log(`[CrownAndCaste] Winner: ${session.players[winnerIndex].name}`);
    }

    // Award pot
    this.adjustGold(winnerIndex, session.pot);
    console.log(`[CrownAndCaste] ${session.players[winnerIndex].name} receives ${session.pot}g.`);

    // Advance session state
    session.totalGamesInSession++;
    session.gameNumber++;
    session.gamesSinceChipRefresh++;
    session.gameComplete = true;
    this.advanceDealer();

    if (session.gamesSinceChipRefresh >= 3) {
      this.refreshControlChips();
      session.gamesSinceChipRefresh = 0;
      console.log("[CrownAndCaste] All control chips have been refreshed after 3 games.");
    }

    this.checkElimination(winnerIndex);

    // Optional UI result trigger
    if (setup.CrownAndCasteUI?.showGameResult) {
      setup.CrownAndCasteUI.showGameResult(winnerIndex);
    }
  },

  
  evaluateCombos(player) {
    const session = State.temporary.ccSession;

    if (!session || !player || player.isEliminated) {
      console.warn("[CrownAndCaste] Cannot evaluate combos: invalid session or player.");
      return { name: "High Dice", usedDice: [], rank: 0 };
    }

    const fullDiceSet = player.casteDice.concat(session.crownDice);
    const result = setup.CrownAndCasteCombos.evaluate(fullDiceSet);

    if (!result || !result.name) {
      console.warn("[CrownAndCaste] Invalid combo evaluation result. Defaulting to High Dice.");
      return { name: "High Dice", usedDice: [], rank: 0 };
    }

    // 🟣 House Rule: Royal Flush enforcement
    if (
      this.hasHouseRule?.("royal-flush") &&
      (result.name === "Octline" || result.name === "Split Line")
    ) {
      const usesOnlyCrownDice = result.usedDice.every(i => i >= 3);
      if (!usesOnlyCrownDice) {
        console.log("[CrownAndCaste] Royal Flush rule active — straight invalidated.");
        return { name: "High Dice", usedDice: [], rank: 0 };
      }
    }

    return result;
  },  

  rankCombo(name) {
    if (!name || typeof name !== "string") {
      console.warn("[CrownAndCaste] Invalid combo name for ranking.");
      return 0;
    }
  
    const rank = setup.CrownAndCasteCombos?.rankIndex?.(name);
  
    if (typeof rank !== "number") {
      console.warn(`[CrownAndCaste] Unknown combo name: '${name}'. Defaulting to rank 0.`);
      return 0;
    }
  
    return rank;
  },
  

  breakTie(indices) {
    const session = State.temporary.ccSession;
    const candidates = indices.map(i => ({
      index: i,
      player: session.players[i],
    }));

    // 1. Compare full combo values (e.g., [7, 3] beats [6, 5])
    const sortComboValues = player => {
      const dice = player.casteDice.concat(session.crownDice);
      const counts = {};
      for (let die of dice) counts[die] = (counts[die] || 0) + 1;

      const values = Object.entries(counts)
        .filter(([_, c]) => c >= 2)
        .map(([v]) => parseInt(v))
        .sort((a, b) => b - a); // Descending

      return values;
    };

    candidates.sort((a, b) => {
      const aVals = sortComboValues(a.player);
      const bVals = sortComboValues(b.player);
      for (let i = 0; i < Math.max(aVals.length, bVals.length); i++) {
        if ((aVals[i] || 0) > (bVals[i] || 0)) return -1;
        if ((aVals[i] || 0) < (bVals[i] || 0)) return 1;
      }
      return 0; // Still tied
    });

    const bestComboScore = sortComboValues(candidates[0].player).join(",");
    const tiedByCombo = candidates.filter(c =>
      sortComboValues(c.player).join(",") === bestComboScore
    );

    if (tiedByCombo.length === 1) return tiedByCombo[0].index;

    // 2. Most Caste Dice used in the combo
    const maxCasteUsed = Math.max(...tiedByCombo.map(c =>
      c.player.combo.usedDice.filter(i => i < 3).length
    ));
    const tiedByCaste = tiedByCombo.filter(c =>
      c.player.combo.usedDice.filter(i => i < 3).length === maxCasteUsed
    );
    if (tiedByCaste.length === 1) return tiedByCaste[0].index;

    // 3. Highest sum of unused dice
    const tiedByUnused = [];
    let highestUnusedSum = -1;
    for (const c of tiedByCaste) {
      const fullDice = c.player.casteDice.concat(session.crownDice);
      const unused = fullDice.filter((_, i) => !c.player.combo.usedDice.includes(i));
      const total = unused.reduce((sum, val) => sum + val, 0);
      if (total > highestUnusedSum) {
        highestUnusedSum = total;
        tiedByUnused.length = 0;
        tiedByUnused.push(c);
      } else if (total === highestUnusedSum) {
        tiedByUnused.push(c);
      }
    }
    if (tiedByUnused.length === 1) return tiedByUnused[0].index;

    // 4. Sudden-death roll
    const rolled = tiedByUnused.map(f => ({
      index: f.index,
      roll: this.rollDie() + this.rollDie() + this.rollDie()
    }));
    rolled.sort((a, b) => b.roll - a.roll);
    console.log(`[CrownAndCaste] Tie-break resolved by sudden-death roll: ${rolled[0].roll}`);
    return rolled[0].index;
  },

  

  // ==========================
  // 5. Betting & Pot
  // ==========================
  initiateBetting() {
    const session = State.temporary.ccSession;
    session.turnPhase = "betting";
    session.betsRevealed = false;
    
    // Reset all bets
    session.players.forEach(p => {
      if (!p.isEliminated) {
        p.bet = 0;
        p.betPlaced = false;
      }
    });
  },

  placeBet(playerIndex, amount) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];
    
    if (session.turnPhase !== "betting") {
      console.warn("[CrownAndCaste] Not in betting phase.");
      return false;
    }
    
    if (amount < 3 || amount > 10) {
      console.warn("[CrownAndCaste] Bet must be between 3g and 10g.");
      return false;
    }
    
    if (amount > player.gold) {
      console.warn("[CrownAndCaste] Insufficient gold for bet.");
      return false;
    }
    
    player.bet = amount;
    player.betPlaced = true;
    
    // Check if all players have bet
    const allBetsPlaced = session.players
      .filter(p => !p.isEliminated)
      .every(p => p.betPlaced);
      
    if (allBetsPlaced) {
      this.revealBets();
    }
    
    return true;
  },

    collectBets() {
      const session = State.temporary.ccSession;
      const minBet = 3;
      const maxBet = 10;
    
      session.pot = 0;
    
      session.players.forEach((p, i) => {
        if (p.isEliminated) {
          console.log(`[CrownAndCaste] Skipping bet for eliminated player: ${p.name}`);
          p.bet = 0;
          return;
        }
    
        // Auto-bet logic (static for now, can expand later with UI)
        const desiredBet = minBet;
    
        // Apply Fortune's Mercy if they can't afford minimum
        const actualBet = Math.min(desiredBet, p.gold);
        p.gold -= actualBet;
        p.bet = actualBet;
        session.pot += actualBet;
    
        console.log(`[CrownAndCaste] ${p.name} bet ${actualBet}g. Remaining: ${p.gold}g`);
      });
    
      console.log(`[CrownAndCaste] Total pot is now ${session.pot}g.`);
    },  

  adjustGold(playerIndex, amount) {
    const session = State.temporary.ccSession;
    const player = session.players?.[playerIndex];
  
    if (!player) {
      console.warn(`[CrownAndCaste] adjustGold failed: invalid player index ${playerIndex}`);
      return;
    }
  
    if (player.isEliminated) {
      console.log(`[CrownAndCaste] adjustGold ignored for eliminated player: ${player.name}`);
      return;
    }
  
    player.gold += amount;
    console.log(`[CrownAndCaste] ${player.name} gold adjusted by ${amount}. New total: ${player.gold}g`);
  },  

  revealBets() {
    const session = State.temporary.ccSession;
    session.betsRevealed = true;
    session.pot = 0;
    
    session.players.forEach(p => {
      if (!p.isEliminated && p.betPlaced) {
        p.gold -= p.bet;
        session.pot += p.bet;
      }
    });
    
    session.turnPhase = "rolling";
    console.log(`[CrownAndCaste] All bets revealed. Total pot: ${session.pot}g`);
    
    // ✅ Automatically roll first Crown die and first player's caste dice
    this.rollCrownDie(0);
    this.rollCasteDice(0); // Roll first player's caste dice immediately
    
    // Set current player to first player for turn management
    session.currentPlayerIndex = 0;
  },

  allPlayersActed() {
    const session = State.temporary.ccSession;
    return session.players
      .filter(p => !p.isEliminated)
      .every(p => p.hasActedThisRound || false);
  },

  processAllNPCBets() {
    const session = State.temporary.ccSession;
    
    // Process bets for all NPCs
    session.players.forEach((player, index) => {
      if (!player.isPlayer && !player.isEliminated && !player.betPlaced) {
        this.processNPCBetting(index);
      }
    });
  },
  // ==========================
  // 6. Session Management
  // ==========================

  advanceDealer() {
    const session = State.temporary.ccSession;
    const totalPlayers = session.players.length;
  
    let nextDealer = session.dealerIndex;
  
    for (let i = 0; i < totalPlayers; i++) {
      nextDealer = (nextDealer - 1 + totalPlayers) % totalPlayers;
      if (!session.players[nextDealer].isEliminated) {
        session.dealerIndex = nextDealer;
        console.log(`[CrownAndCaste] New dealer is ${session.players[nextDealer].name}`);
        return;
      }
    }
  
    console.warn("[CrownAndCaste] Could not assign a new dealer. All players eliminated?");
  },  

  refreshControlChips() {
    const session = State.temporary.ccSession;
  
    session.players.forEach(p => {
      if (!p.isEliminated) {
        p.chips = 3;
        console.log(`[CrownAndCaste] ${p.name}'s Control Chips refreshed to 3.`);
      }
    });
  },
  

  checkElimination(winnerIndex = null) {
    const session = State.temporary.ccSession;

    session.players.forEach((p, i) => {
      const isWinner = i === winnerIndex;
      if (!p.isEliminated && !isWinner && p.gold <= 0) {
        p.isEliminated = true;
        console.log(`[CrownAndCaste] ${p.name} has been eliminated (0g remaining after loss).`);
      }
    });
  },

  
  // ==========================
  // 7. NPC AI System
  // ==========================



  processNPCBetting(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const personality = this.getNPCPersonality(npc);
    
    // Calculate bet based on personality and game state
    let betAmount = 3; // minimum bet
    
    // Aggressive personalities bet higher
    if (personality.aggression > 0.7) {
      betAmount = Math.min(10, npc.gold);
    } else if (personality.aggression > 0.4) {
      betAmount = Math.min(7, npc.gold);
    } else if (personality.confidence > 0.6) {
      betAmount = Math.min(5, npc.gold);
    }
    
    // Risk assessment based on current gold
    if (npc.gold <= 10) {
      betAmount = Math.min(3, npc.gold); // Conservative when low on gold
    }
    
    // Add some randomness
    const variance = Math.random() * 0.3 - 0.15; // ±15%
    betAmount = Math.max(3, Math.min(10, Math.floor(betAmount * (1 + variance))));
    betAmount = Math.min(betAmount, npc.gold);
    
    console.log(`[CrownAndCaste] ${npc.name} bets ${betAmount}g (personality: aggression=${personality.aggression.toFixed(2)}, confidence=${personality.confidence.toFixed(2)})`);
    
    this.placeBet(playerIndex, betAmount);
  },

  processNPCTurn(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];

    if (!npc || npc.isPlayer || npc.isEliminated) {
      console.warn(`[CrownAndCaste] Invalid NPC for turn processing: ${playerIndex}`);
      return;
    }

    console.log(`[CrownAndCaste] Processing NPC turn for ${npc.name}`);

    switch (session.turnPhase) {
      case "betting":
        this.processNPCBetting(playerIndex);
        break;
      case "rolling":
        this.processNPCRolling(playerIndex);
        break;
      default:
        this.processNPCGameplay(playerIndex);
        break;
    }

    // ❌ NO auto-end turn here — that's handled by scheduleNPCAction (UI-controlled)
  },


  processNPCRolling(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // Roll dice if they haven't been rolled yet
    if (npc.casteDice.every(die => die === null)) {
      this.rollCasteDice(playerIndex);
    }
    
    // Decide on locking strategy
    this.processNPCLockingStrategy(playerIndex);
  },

  processNPCGameplay(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // First, handle dice rolling and locking
    this.processNPCDiceActions(playerIndex);
    
    // Then consider using control chips
    this.processNPCChipStrategy(playerIndex);
  },

  processNPCDiceActions(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // Roll dice if any are unrolled
    if (npc.casteDice.some(die => die === null)) {
      this.rollCasteDice(playerIndex);
    }
    
    // Apply locking strategy
    this.processNPCLockingStrategy(playerIndex);
  },

  processNPCLockingStrategy(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const personality = this.getNPCPersonality(npc);
    
    if (npc.casteDice.some(die => die === null)) {
      return; // Wait until all dice are rolled
    }
    
    // Analyze current hand
    const analysis = this.analyzeNPCHand(playerIndex);
    
    // Lock dice based on strategy
    for (let i = 0; i < 3; i++) {
      if (npc.locks[i]) continue; // Already locked
      
      const shouldLock = this.shouldNPCLockDie(playerIndex, i, analysis, personality);
      if (shouldLock) {
        this.lockDie(playerIndex, i);
      }
    }
  },

  shouldNPCLockDie(playerIndex, dieIndex, analysis, personality) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const dieValue = npc.casteDice[dieIndex];
    
    // Always lock high-value dice (7-8) unless going for specific combos
    if (dieValue >= 7 && !analysis.hasSpecialCombo) {
      return true;
    }
    
    // Lock dice that are part of pairs/triplets
    if (analysis.pairs.includes(dieValue) || analysis.triplets.includes(dieValue)) {
      return true;
    }
    
    // Conservative players lock medium-high dice (5-6)
    if (personality.risk < 0.4 && dieValue >= 5) {
      return true;
    }
    
    // Aggressive players might keep rolling for better combos
    if (personality.risk > 0.7 && session.currentRound < 3) {
      return false;
    }
    
    // Lock dice that contribute to straights
    if (analysis.straightPotential && analysis.straightDice.includes(dieIndex)) {
      return true;
    }
    
    return false;
  },

  processNPCChipStrategy(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const personality = this.getNPCPersonality(npc);
    
    if (!this.canUseControlChip(playerIndex)) {
      return;
    }
    
    // Decide whether to use a chip this turn
    const shouldUseChip = this.shouldNPCUseChip(playerIndex, personality);
    
    if (shouldUseChip) {
      const chipAction = this.chooseNPCChipAction(playerIndex, personality);
      this.executeNPCChipAction(playerIndex, chipAction);
    }
  },

  shouldNPCUseChip(playerIndex, personality) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // Don't use chips if low on them and conservative
    if (npc.chips <= 1 && personality.risk < 0.5) {
      return false;
    }
    
    // More likely to use chips in later rounds
    const roundFactor = session.currentRound / 3;
    
    // More likely to use chips if behind in gold
    const avgGold = session.players.reduce((sum, p) => sum + p.gold, 0) / session.players.length;
    const goldFactor = npc.gold < avgGold ? 1.5 : 1.0;
    
    // Base probability based on personality
    let probability = personality.aggression * 0.3 + personality.risk * 0.2;
    probability *= roundFactor * goldFactor;
    
    return Math.random() < probability;
  },

  chooseNPCChipAction(playerIndex, personality) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const analysis = this.analyzeNPCHand(playerIndex);
    
    const actions = [];
    
    // Consider rerolling own locked dice
    const lockedDice = npc.locks.map((locked, i) => locked ? i : null).filter(i => i !== null);
    if (lockedDice.length > 0) {
      actions.push({
        type: "reroll-own",
        target: lockedDice[Math.floor(Math.random() * lockedDice.length)],
        priority: analysis.hasGoodHand ? 0.2 : 0.8
      });
    }
    
    // Consider rerolling other players' dice (sabotage)
    if (personality.aggression > 0.5) {
      const targets = this.findNPCRerollTargets(playerIndex);
      targets.forEach(target => {
        actions.push({
          type: "reroll-other",
          target: target.playerIndex,
          priority: target.threat * personality.aggression
        });
      });
    }
    
    // Consider protecting the crown
    if (!session.crownProtected && session.currentRound >= 2) {
      actions.push({
        type: "lock-crown",
        target: null,
        priority: 0.3 + (session.currentRound - 1) * 0.3
      });
    }
    
    // Choose action with highest priority
    if (actions.length === 0) return null;
    
    actions.sort((a, b) => b.priority - a.priority);
    return actions[0];
  },

  executeNPCChipAction(playerIndex, action) {
    if (!action) return;
    
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    console.log(`[CrownAndCaste] ${npc.name} uses Control Chip for ${action.type}`);
    
    this.useControlChip(playerIndex, action.type, action.target);
  },

  findNPCRerollTargets(playerIndex) {
    const session = State.temporary.ccSession;
    const targets = [];
    
    session.players.forEach((player, i) => {
      if (i === playerIndex || player.isEliminated || i === session.dealerIndex) {
        return;
      }
      
      const analysis = this.analyzeNPCHand(i);
      const threat = this.calculatePlayerThreat(i, analysis);
      
      if (threat > 0.5) {
        targets.push({ playerIndex: i, threat });
      }
    });
    
    return targets.sort((a, b) => b.threat - a.threat);
  },

  calculatePlayerThreat(playerIndex, analysis) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];
    
    let threat = 0;
    
    // High gold = higher threat
    const avgGold = session.players.reduce((sum, p) => sum + p.gold, 0) / session.players.length;
    if (player.gold > avgGold) {
      threat += 0.3;
    }
    
    // Good hand = higher threat
    if (analysis.hasGoodHand) {
      threat += 0.4;
    }
    
    // Many chips = higher threat
    if (player.chips > 2) {
      threat += 0.2;
    }
    
    // High dice values = higher threat
    const avgDieValue = player.casteDice.reduce((sum, die) => sum + (die || 0), 0) / 3;
    if (avgDieValue > 5) {
      threat += 0.3;
    }
    
    return Math.min(1.0, threat);
  },

  analyzeNPCHand(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const fullDice = npc.casteDice.concat(session.crownDice);
    
    // Count occurrences
    const counts = {};
    fullDice.forEach(die => {
      if (die !== null) {
        counts[die] = (counts[die] || 0) + 1;
      }
    });
    
    const pairs = Object.keys(counts).filter(val => counts[val] === 2).map(Number);
    const triplets = Object.keys(counts).filter(val => counts[val] >= 3).map(Number);
    
    // Check for straight potential
    const sortedDice = fullDice.filter(d => d !== null).sort((a, b) => a - b);
    const straightPotential = this.checkStraightPotential(sortedDice);
    
    // Evaluate hand strength
    const combo = this.evaluateCombos(npc);
    const hasGoodHand = combo && this.rankCombo(combo.name) > 5;
    
    return {
      pairs,
      triplets,
      straightPotential: straightPotential.potential,
      straightDice: straightPotential.dice,
      hasGoodHand,
      hasSpecialCombo: triplets.length > 0 || pairs.length > 1,
      combo
    };
  },

  checkStraightPotential(sortedDice) {
    if (sortedDice.length < 4) {
      return { potential: false, dice: [] };
    }
    
    // Look for sequences of 4+ consecutive numbers
    for (let i = 0; i <= sortedDice.length - 4; i++) {
      let consecutive = 1;
      const sequenceDice = [i];
      
      for (let j = i + 1; j < sortedDice.length; j++) {
        if (sortedDice[j] === sortedDice[j-1] + 1) {
          consecutive++;
          sequenceDice.push(j);
        } else if (sortedDice[j] !== sortedDice[j-1]) {
          break;
        }
      }
      
      if (consecutive >= 4) {
        return { potential: true, dice: sequenceDice };
      }
    }
    
    return { potential: false, dice: [] };
  },

  getNPCPersonality(npc) {
    // Extract personality from character data
    const character = State.variables.characters?.[npc.npcId];
    
    if (!character) {
      // Default personality for ghost players
      return {
        aggression: 0.5,
        risk: 0.5,
        confidence: 0.5,
        cunning: 0.5
      };
    }
    
    // Map character traits to gambling personality
    const traits = character.traits || [];
    const socialStyle = character.socialStyle || "Neutral";
    
    let aggression = 0.5;
    let risk = 0.5;
    let confidence = 0.5;
    let cunning = 0.5;
    
    // Adjust based on traits
    traits.forEach(trait => {
      switch (trait.toLowerCase()) {
        case "confident":
        case "dominant":
        case "flashy":
          confidence += 0.3;
          aggression += 0.2;
          break;
        case "cynical":
        case "cunning":
        case "evasive":
          cunning += 0.3;
          risk -= 0.1;
          break;
        case "stoic":
        case "guarded":
          risk -= 0.2;
          aggression -= 0.1;
          break;
        case "flirty":
        case "charming":
          confidence += 0.2;
          cunning += 0.1;
          break;
        case "crude":
        case "feisty":
          aggression += 0.3;
          risk += 0.2;
          break;
        case "submissive":
        case "introverted":
          aggression -= 0.3;
          confidence -= 0.2;
          break;
        case "traumatized":
        case "detached":
          risk -= 0.3;
          aggression -= 0.2;
          break;
      }
    });
    
    // Adjust based on social style
    switch (socialStyle.toLowerCase()) {
      case "regal":
      case "commanding":
        confidence += 0.2;
        aggression += 0.1;
        break;
      case "seductive":
      case "charming":
        cunning += 0.2;
        confidence += 0.1;
        break;
      case "feisty":
        aggression += 0.3;
        risk += 0.2;
        break;
      case "humble":
      case "reserved":
        aggression -= 0.2;
        confidence -= 0.1;
        break;
      case "unhinged":
        risk += 0.4;
        aggression += 0.2;
        break;
      case "grizzled":
      case "stoic":
        risk -= 0.1;
        cunning += 0.1;
        break;
    }
    
    // Clamp values between 0 and 1
    return {
      aggression: Math.max(0, Math.min(1, aggression)),
      risk: Math.max(0, Math.min(1, risk)),
      confidence: Math.max(0, Math.min(1, confidence)),
      cunning: Math.max(0, Math.min(1, cunning))
    };
  },

  // ==========================
  // 8. Helpers
  // ==========================

    rollDie(playerIndex = null) {
      const buffer = new Uint8Array(1);
      window.crypto.getRandomValues(buffer);
      const raw = buffer[0] / 256;
      const baseValue = Math.floor(raw * 8) + 1;
    
      const session = State.temporary.ccSession;
      let value = baseValue;
    
      // 🎲 Apply bias if playerFavor is active
      if (playerIndex === 0 && session?.playerFavor && session.playerFavor > 1.0) {
        const bias = session.playerFavor;
        const biasedRaw = Math.pow(raw, 1 / bias);
        const biasedValue = Math.floor(biasedRaw * 8) + 1;
        value = Math.min(8, Math.max(1, biasedValue));
    
        console.log(
          `[CrownAndCaste] Rolled (playerFavor=${bias.toFixed(2)}): ` +
          `raw=${raw.toFixed(3)} → base=${baseValue}, biasedRaw=${biasedRaw.toFixed(3)} → biased=${biasedValue}, final=${value}`
        );
      } else {
        console.log(`[CrownAndCaste] Rolled die: raw=${raw.toFixed(3)} → ${value}`);
      }
    
      return value;
    },
  
 

  // ✨ Pseudo-rolling animation for dice (flavor feature)
  async rollDieWithAnimation(elementId, finalValue = null) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.warn(`[CrownAndCaste] Cannot animate die: element ${elementId} not found`);
      return finalValue || this.rollDie();
    }

    const actualValue = finalValue || this.rollDie();
    const animationDuration = 1500 + Math.random() * 1000; // 1.5-2.5 seconds
    const startTime = Date.now();

    // Add animation class for visual effects
    element.classList.add('rolling');

    const animate = () => {
      const elapsed = Date.now() - startTime;
      const progress = elapsed / animationDuration;

      if (progress < 1) {
        // Show random values during animation
        const randomValue = Math.floor(Math.random() * 8) + 1;
        element.textContent = randomValue;
        requestAnimationFrame(animate);
      } else {
        // Animation complete - show final value
        element.textContent = actualValue;
        element.classList.remove('rolling');
        console.log(`[CrownAndCaste] Die animation complete: ${actualValue}`);
      }
    };

    animate();
    
    // Return a promise that resolves when animation completes
    return new Promise(resolve => {
      setTimeout(() => resolve(actualValue), animationDuration);
    });
  },

  logSessionState() {
    console.log("[CrownAndCaste] Current session state:");
    console.log(JSON.stringify(State.temporary.ccSession, null, 2));
  },

  getNextPlayerClockwise(currentIndex) {
    const session = State.temporary.ccSession;
    const totalPlayers = session.players.length;
    
    for (let i = 1; i <= totalPlayers; i++) {
      const nextIndex = (currentIndex + i) % totalPlayers;
      if (!session.players[nextIndex].isEliminated) {
        return nextIndex;
      }
    }
    return -1; // No valid players found
  },
  
  

};



  // ==========================
  // 8. Combos Logic
  // ==========================
setup.CrownAndCasteCombos = {
RANKS: [                        
  "High Dice",           
  "Single Pair",         
  "Dual Pairs",          
  "Triplet",             
  "Tri-Crown",           
  "Line of Five Unpaired",
  "Jester's Court",      
  "Courtesan's Quad",    
  "Line of Five Paired", 
  "Split Line",          
  "Octline",             
  "Courtly Quad",        
  "Royal Spread",        
  "Fivefold Glory",      
  "Imperial Crown"       
  ],

  rankIndex(name) {
    return this.RANKS.indexOf(name);
  },

  evaluate(diceArray) {
    const counts = {};
    for (const die of diceArray) {
      counts[die] = (counts[die] || 0) + 1;
    }

    const values = diceArray.slice().sort((a, b) => a - b);
    const unique = [...new Set(values)];
    const countValues = Object.values(counts).sort((a, b) => b - a);

    const hasNOfKind = n => Object.values(counts).includes(n);
    const getAllOfCount = n => Object.entries(counts).filter(([_, c]) => c === n).map(([v]) => parseInt(v));
    const isStraight = (len = 6) => {
      for (let i = 0; i <= values.length - len; i++) {
        let streak = 1;
        for (let j = i; j < i + len - 1; j++) {
          if (values[j + 1] !== values[j] + 1) break;
          streak++;
        }
        if (streak === len) return true;
      }
      return false;
    };

    const countPairs = () => getAllOfCount(2).length;
    const countTriplets = () => getAllOfCount(3).length;

    const combo = (name) => ({
      name,
      usedDice: [...Array(6).keys()], // placeholder
      rank: this.rankIndex(name)
    });

    if (countValues[0] === 6) return combo("Imperial Crown");
    if (countValues[0] === 5) return combo("Fivefold Glory");
    if (countTriplets() === 2) return combo("Royal Spread");
    if (countValues[0] === 4 && countValues[1] === 2) return combo("Courtly Quad");
    if (isStraight(6)) return combo("Octline");
    if (hasSplitLine(values)) return combo("Split Line");
    if (countValues[0] === 4 && countValues[1] <= 1) return combo("Courtesan's Quad");
    if (countPairs() === 3) return combo("Jester's Court");

    if (hasFiveInARow(values)) {
      const fiveInRow = getFiveInRowValues(values);
      const sixthDie = values.find(v => !fiveInRow.includes(v));
      if (sixthDie !== undefined && fiveInRow.includes(sixthDie)) {
        return combo("Line of Five Paired");
      } else {
        return combo("Line of Five Unpaired");
      }
    }

    if (countValues.includes(3) && countValues.includes(2)) return combo("Tri-Crown");
    if (countValues[0] === 3) return combo("Triplet");
    if (countPairs() === 2) return combo("Dual Pairs");
    if (countPairs() === 1) return combo("Single Pair");

    return combo("High Dice");
  }
};

function hasSplitLine(values) {
  const sorted = values.slice().sort((a, b) => a - b);

  // Try every combination of two 3-length straights that do not reuse dice values
  for (let i = 0; i < sorted.length; i++) {
    for (let j = i + 1; j < sorted.length; j++) {
      for (let k = j + 1; k < sorted.length; k++) {
        const first = [sorted[i], sorted[j], sorted[k]];
        if (!isConsecutive(first)) continue;

        // Remove the dice used in the first straight (by index, not just value)
        const remaining = [...values];
        for (const val of first) {
          const index = remaining.indexOf(val);
          if (index !== -1) remaining.splice(index, 1);
        }

        // Try to find a second non-overlapping 3-straight in the remaining dice
        remaining.sort((a, b) => a - b);
        for (let a = 0; a < remaining.length; a++) {
          for (let b = a + 1; b < remaining.length; b++) {
            for (let c = b + 1; c < remaining.length; c++) {
              const second = [remaining[a], remaining[b], remaining[c]];
              if (isConsecutive(second)) {
                return true;
              }
            }
          }
        }
      }
    }
  }

  return false;
}

function isConsecutive(arr) {
  return arr[1] === arr[0] + 1 && arr[2] === arr[1] + 1;
}


function hasFiveInARow(values) {
  const unique = [...new Set(values)].sort((a, b) => a - b);
  for (let i = 0; i <= unique.length - 5; i++) {
    let isStraight = true;
    for (let j = 0; j < 4; j++) {
      if (unique[i + j + 1] !== unique[i + j] + 1) {
        isStraight = false;
        break;
      }
    }
    if (isStraight) return true;
  }
  return false;
}

function getFiveInRowValues(values) {
  const unique = [...new Set(values)].sort((a, b) => a - b);
  for (let i = 0; i <= unique.length - 5; i++) {
    const segment = unique.slice(i, i + 5);
    let isStraight = true;
    for (let j = 0; j < 4; j++) {
      if (segment[j + 1] !== segment[j] + 1) {
        isStraight = false;
        break;
      }
    }
    if (isStraight) return segment;
  }
  return [];
}
/* twine-user-script #29: "CrownAndCasteUI.js" */
setup.CrownAndCasteUI = {
  chipMode: false,
  
  renderMinigame() {
    window.openOverlay("crown-and-caste-page");

    setTimeout(() => {
      this.initializeEventListeners();
      this.initializeOrientationDetection();
      this.highlightCurrentPlayer();
      this.renderCrownDice();
      this.renderPot();
      this.renderPlayerPanels();
      this.updateGameStatus();
      this.updateInteractionStates();

      if (State.variables.DEBUG || setup.DEBUG) {
        console.log("[CrownAndCasteUI] Game UI initialized.");
      }
    }, 100);
  },

  closeMinigame() {
    const overlay = document.getElementById("crown-and-caste-page");
    if (overlay) {
      overlay.classList.add("overlay-hidden");
    }

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[CrownAndCasteUI] Minigame overlay hidden.");
    }
  },

  initializeEventListeners() {
    // Dice click handlers
    document.querySelectorAll('.clickable-die').forEach(die => {
      die.addEventListener('click', (e) => this.handleDieClick(e));
    });

    // Chip click handlers
    document.querySelectorAll('.clickable-chips').forEach(chips => {
      chips.addEventListener('click', (e) => this.handleChipClick(e));
    });

    // Individual Crown Die click handlers (for rerolling via chip)
    document.querySelectorAll('.clickable-crown-die').forEach(el => {
      el.addEventListener('click', (e) => this.handleCrownDieClick(e));
    });

    // ✅ Backup: click on crown circle triggers protect crown (unless a die was clicked)
    const crownCircle = document.getElementById('center-circle');
    if (crownCircle) {
      crownCircle.addEventListener('click', (e) => {
        // Skip if the click originated inside a clickable die
        if (e.target.closest('.clickable-crown-die')) return;

        this.handleCrownClick(e);
      });
    }

    // Betting button handlers
    document.querySelectorAll('.bet-btn').forEach(btn => {
      btn.addEventListener('click', (e) => this.handleBetClick(e));
    });

    // End Turn button
    const endTurn = document.getElementById('end-turn-btn');
    if (endTurn) {
      endTurn.addEventListener('click', () => {
        setup.CrownAndCaste.endTurn();
        setup.CrownAndCasteUI.updateGameStatus();
        setup.CrownAndCasteUI.updateInteractionStates();
      });
    }

    // Next Game button handler
    const nextGameBtn = document.getElementById('next-game-btn');
    if (nextGameBtn) {
      nextGameBtn.addEventListener('click', () => {
        setup.CrownAndCasteUI.hideGameResult(); // ⬅ ensure result panel hides
        setup.CrownAndCaste.startNextGame();     // ⬅ resets state and rolls
        setup.CrownAndCasteUI.updateGameStatus();
        setup.CrownAndCasteUI.updateInteractionStates();
        setup.CrownAndCasteUI.renderPlayerPanels();
        setup.CrownAndCasteUI.renderCrownDice();
        setup.CrownAndCasteUI.renderPot();
      });
    }

    const endGameBtn = document.getElementById("end-game-btn");
    if (endGameBtn) {
      endGameBtn.addEventListener("click", () => {
        try {
          closeOverlay();
        } catch (e) {
          console.warn("closeOverlay() not available:", e);
        }

        const session = State.temporary;
        const game = session.ccSession;

        const player = game?.players?.find(p => p.isPlayer);
        const playerWon = player && player.gold > 0;
        const exitPassage = playerWon ? session.ccWinPassage : session.ccLosePassage;

        // 💰 Distribute winnings if the player won
        if (playerWon && typeof State.variables.inventory_player?.gold_coin === "number") {
          State.variables.inventory_player.gold_coin += game.pot;
          console.log(`[CrownAndCaste] Player awarded ${game.pot}g from the pot.`);
        }

        setup.CrownAndCasteUI.cleanupTable();

        if (exitPassage) {
          Engine.play(exitPassage);
        } else {
          console.warn("[CrownAndCaste] No valid exit passage found, falling back to default.");
          Engine.play("ReturnToFair");
        }
      });
    }
  },


  cleanupTable() {
    const frame = document.getElementById("crown-caste-frame");
    if (frame) frame.remove();

    // Reset session state
    delete State.temporary.ccSession;
    delete State.temporary.ccBuyIn;
    delete State.temporary.ccStakes;
    delete State.temporary.ccHouseRules;

    console.log("[CrownAndCasteUI] Crown & Caste session ended.");
  },


  handleDieClick(event) {
    const die = event.target;
    const playerIndex = parseInt(die.dataset.player);
    const dieIndex = parseInt(die.dataset.die);
    const session = State.temporary.ccSession;
    const currentPlayer = session.players[session.currentPlayerIndex];

    // Don't allow dice interaction during betting phase
    if (session.turnPhase === "betting") {
      this.showFeedback("Cannot interact with dice during betting phase!");
      return;
    }

    // Only allow interaction if it's the player's turn
    if (!currentPlayer.isPlayer) {
      this.showFeedback("Not your turn!");
      return;
    }

    if (this.chipMode) {
      // Control chip mode - reroll locked dice
      this.handleChipDieReroll(playerIndex, dieIndex);
    } else if (playerIndex === 0) {
      // Normal mode - player's own dice
      this.handlePlayerDieAction(dieIndex);
    } else {
      this.showFeedback("You can only interact with your own dice!");
    }
  },

  handlePlayerDieAction(dieIndex) {
    const session = State.temporary.ccSession;
    const player = session.players[0]; // Player is always index 0

    if (player.casteDice[dieIndex] === null) {
      // Roll unlocked die
      setup.CrownAndCaste.rollCasteDice(0);
      this.showFeedback("Dice rolled!");
    } else {
      // Toggle lock
      setup.CrownAndCaste.lockDie(0, dieIndex);
      const isLocked = player.locks[dieIndex];
      this.showFeedback(isLocked ? "Die locked!" : "Die unlocked!");
    }
    
    this.updateInteractionStates();
  },

  handleChipDieReroll(playerIndex, dieIndex) {
    const session = State.temporary.ccSession;
    const targetPlayer = session.players[playerIndex];

    if (!targetPlayer.locks[dieIndex]) {
      this.showFeedback("Can only reroll locked dice!");
      return;
    }

    if (playerIndex === 0) {
      // Reroll own locked die
      setup.CrownAndCaste.useControlChip(0, "reroll-own", dieIndex);
      this.showFeedback("Rerolled your locked die!");
    } else {
      // Reroll specific locked die of another player
      setup.CrownAndCaste.useControlChip(0, "reroll-other", {
        targetPlayerIndex: playerIndex,
        dieIndex: dieIndex
      });
      this.showFeedback(`Rerolled ${targetPlayer.name}'s locked die!`);
    }

    this.chipMode = false;
    this.updateInteractionStates();
  },

  handleChipClick(event) {
    const chipDisplay = event.target.closest('.chip-display');
    const playerIndex = parseInt(chipDisplay.closest('.player-zone').dataset.playerIndex);
    const session = State.temporary.ccSession;

    // Don't allow chip usage during betting phase
    if (session.turnPhase === "betting") {
      this.showFeedback("Cannot use chips during betting phase!");
      return;
    }

    // Only allow player to use their own chips
    if (playerIndex !== 0) {
      this.showFeedback("You can only use your own Control Chips!");
      return;
    }

    if (!setup.CrownAndCaste.canUseControlChip(0)) {
      this.showFeedback("Cannot use Control Chip right now!");
      return;
    }

    // Toggle chip mode
    this.chipMode = !this.chipMode;
    this.updateInteractionStates();
    
    if (this.chipMode) {
      this.showFeedback("Control Chip activated! Click dice to reroll or crown to protect.");
    } else {
      this.showFeedback("Control Chip mode deactivated.");
    }
  },

  handleCrownDieClick(event) {
    const session = State.temporary.ccSession;

    const dieEl = event.currentTarget; // ✅ Always use currentTarget
    const dieIndex = parseInt(dieEl.dataset.index, 10);

    if (isNaN(dieIndex) || dieIndex < 0 || dieIndex > 2) {
      console.warn("[CrownAndCasteUI] Invalid crown die index clicked.");
      return;
    }

    if (!this.chipMode) {
      this.showFeedback("Activate Control Chip mode first!");
      return;
    }

    setup.CrownAndCaste.useControlChip(0, "reroll-crown", dieIndex);
    this.showFeedback(`Rerolled Crown Die ${dieIndex + 1}`);
    this.chipMode = false;
    this.updateInteractionStates();
  },

  handleCrownClick(event) {
    const session = State.temporary.ccSession;

    // Don't allow crown interaction during betting phase
    if (session.turnPhase === "betting") {
      this.showFeedback("Cannot interact with crown during betting phase!");
      return;
    }

    if (!this.chipMode) {
      this.showFeedback("Activate Control Chip mode first!");
      return;
    }

    // Use chip to protect crown
    setup.CrownAndCaste.useControlChip(0, "lock-crown");
    this.showFeedback("Crown protected!");
    this.chipMode = false;
    this.updateInteractionStates();
  },

  handleBetClick(event) {
    const amount = parseInt(event.target.dataset.amount);
    const success = setup.CrownAndCaste.placeBet(0, amount);
    
    if (success) {
      this.showFeedback(`Bet placed: ${amount}g`);
      
      // Process all NPC bets automatically after a short delay
      setTimeout(() => {
        setup.CrownAndCaste.processAllNPCBets();
        this.updateGameStatus();
        this.renderPlayerPanels();
        this.renderPot();
        this.updateInteractionStates();
      }, 500);
    } else {
      this.showFeedback("Cannot place that bet!");
    }
  },

  updateInteractionStates() {
    const session = State.temporary.ccSession;
    const currentPlayer = session.players[session.currentPlayerIndex];
    const isPlayerTurn = currentPlayer.isPlayer;
    const isBettingPhase = session.turnPhase === "betting";

    // Disable specific game interactions during betting, but NOT the betting panel
    const gameElements = document.querySelectorAll('.clickable-die, .chip-button, .crown-die');
    gameElements.forEach(el => {
      el.classList.toggle('disabled-during-betting', isBettingPhase);
    });

    // Update chip mode visual state
    document.querySelectorAll('.chip-display').forEach(display => {
      display.classList.toggle('active', this.chipMode);
    });

    // Update crown circle state
    const crownCircle = document.getElementById('center-circle');
    if (crownCircle) {
      crownCircle.classList.toggle('chip-mode', this.chipMode);
    }

    // Update dice interaction states
    document.querySelectorAll('.clickable-die').forEach(die => {
      const playerIndex = parseInt(die.dataset.player);
      const dieIndex = parseInt(die.dataset.die);
      const player = session.players[playerIndex];

      die.classList.remove('can-roll', 'can-lock', 'chip-target');

      // 🛡 Fix: Guard against undefined players
      if (!player) return;

      if (isBettingPhase || !isPlayerTurn) return;

      if (this.chipMode) {
        if (player.locks[dieIndex]) {
          die.classList.add('chip-target');
        }
      } else if (playerIndex === 0) {
        if (player.casteDice[dieIndex] === null) {
          die.classList.add('can-roll');
        } else {
          die.classList.add('can-lock');
        }
      }
    });


    // Show betting panel only during betting phase and player's turn
    const bettingPanel = document.getElementById('betting-panel');
    if (bettingPanel) {
      const showBetting = isBettingPhase && isPlayerTurn;
      bettingPanel.style.display = showBetting ? 'block' : 'none';
    }

    // Show or hide End Turn button
    const endTurnPanel = document.getElementById('player-actions');
    if (endTurnPanel) {
      const showEndTurn = isPlayerTurn && !isBettingPhase && !session.gameComplete;
      endTurnPanel.style.display = showEndTurn ? 'block' : 'none';
    }

    // Show or hide Next Game button
    const nextGamePanel = document.getElementById('next-game-panel');
    if (nextGamePanel) {
      const showNextGame = session.gameComplete;
      nextGamePanel.style.display = showNextGame ? 'block' : 'none';
    }

    // Update crown protected indicator
    const protectedIndicator = document.getElementById('crown-protected');
    if (protectedIndicator) {
      protectedIndicator.style.display = session.crownProtected ? 'block' : 'none';
    }
  },


  updateGameStatus() {
    const session = State.temporary.ccSession;
    const currentPlayer = session.players[session.currentPlayerIndex];

    const turnEl = document.getElementById('current-turn');
    const roundEl = document.getElementById('current-round');
    const phaseEl = document.getElementById('game-phase');

    if (turnEl) {
      turnEl.textContent = currentPlayer.isPlayer ? "Your Turn" : `${currentPlayer.name}'s Turn`;
    }

    if (roundEl) {
      roundEl.textContent = `Round ${session.currentRound}`;
    }

    if (phaseEl) {
      const phaseText = session.turnPhase === "betting" ? "Betting Phase" : 
                       session.turnPhase === "rolling" ? "Rolling Phase" : 
                       "Game Phase";
      phaseEl.textContent = phaseText;
    }

    // Trigger NPC actions if it's an NPC's turn
    if (!currentPlayer.isPlayer && !currentPlayer.isEliminated) {
      this.scheduleNPCAction(session.currentPlayerIndex);
    }
  },

  scheduleNPCAction(playerIndex) {
    // Add a delay to make NPC actions feel more natural
    setTimeout(() => {
      if (setup.CrownAndCaste.processNPCTurn) {
        setup.CrownAndCaste.processNPCTurn(playerIndex);
        
        // Update UI after NPC action
        setTimeout(() => {
          this.renderPlayerPanels();
          this.renderCrownDice();
          this.renderPot();
          this.highlightCurrentPlayer();
          this.updateInteractionStates();
        }, 500);
      }
    }, 1000 + Math.random() * 1500); // 1-2.5 second delay for realism
  },

  showFeedback(message) {
    const feedback = document.getElementById('action-feedback');
    if (feedback) {
      feedback.textContent = message;
      feedback.classList.add('show');
      
      setTimeout(() => {
        feedback.classList.remove('show');
      }, 2000);
    }
  },

  highlightCurrentPlayer() {
    const session = State.temporary.ccSession;
    const currentId = this.getPositionId(session.currentPlayerIndex);
    const panels = document.querySelectorAll(".player-zone");

    panels.forEach(panel => {
      panel.classList.remove("active-player", "current-turn");
      if (panel.id === currentId) {
        panel.classList.add("active-player", "current-turn");
      }
    });
  },

  getPositionId(index) {
    switch (index) {
      case 0: return "bottom-center"; // Player
      case 1: return "middle-left";   // NPC 1
      case 2: return "top-center";    // NPC 2
      case 3: return "middle-right";  // NPC 3
      default: return `unknown-${index}`;
    }
  },

  renderCrownDice() {
    const session = State.temporary.ccSession;
    session.crownDice.forEach((val, i) => {
      const el = document.getElementById(`crown-die-${i + 1}`);
      if (el) {
        el.textContent = val ?? "?";
        el.classList.toggle("locked", session.crownLocks[i]);
      }
    });
  },

  renderPot() {
    const session = State.temporary.ccSession;
    const potDisplay = document.getElementById("crown-pot");
    if (potDisplay) {
      potDisplay.textContent = `Pot: ${session.pot}g`;
    }
  },

  renderPlayerPanels() {
    const session = State.temporary.ccSession;

    session.players.forEach((p, i) => {
      const containerId = this.getPositionId(i);
      const el = document.getElementById(containerId);
      if (!el) return;

      const goldEl = el.querySelector(".gold-amount");
      const chipEl = el.querySelector(".chip-count");
      const nameEl = el.querySelector(".player-name");

      if (goldEl) goldEl.textContent = p.gold;
      if (chipEl) chipEl.textContent = p.chips;
      if (nameEl) {
        const baseName = p.name || `Player ${i + 1}`;
        const isDealer = i === session.dealerIndex;

        nameEl.innerHTML = isDealer
          ? `<i class="lucide crown-icon" data-lucide="crown"></i> ${baseName}`
          : baseName;
      }

      p.casteDice.forEach((val, j) => {
        const dieEl = el.querySelector(`#${containerId}-die-${j + 1}`);
        if (dieEl) {
          dieEl.textContent = val ?? "?";
          dieEl.classList.toggle("locked", p.locks[j]);
        }
      });
    });
    if (window.lucide) lucide.createIcons();
  },

  updateChipDisplay(playerIndex, chipCount, goldCount) {
    const containerId = this.getPositionId(playerIndex);
    const el = document.getElementById(containerId);
    if (el) {
      const chipEl = el.querySelector(".chip-count");
      const goldEl = el.querySelector(".gold-amount");
      if (chipEl) chipEl.textContent = chipCount;
      if (goldEl) goldEl.textContent = goldCount;
    }
    this.updateInteractionStates();
  },

  updateCrownDisplay(index, value) {
    const el = document.getElementById(`crown-die-${index + 1}`);
    if (el) el.textContent = value;
  },

  updateCrownLockDisplay(index, isLocked) {
    const el = document.getElementById(`crown-die-${index + 1}`);
    if (el) {
      el.classList.toggle("locked", isLocked);
    }
  },

  updateLockDisplay(playerIndex, dieIndex, isLocked) {
    const containerId = this.getPositionId(playerIndex);
    const el = document.getElementById(`${containerId}-die-${dieIndex + 1}`);
    if (el) {
      el.classList.toggle("locked", isLocked);
    }
    this.updateInteractionStates();
  },

  updateDiceDisplay(playerIndex) {
    this.renderPlayerPanels();
    this.updateInteractionStates();
  },

  showGameResult(winnerIndex) {
    const session = State.temporary.ccSession;
    const winner = session.players[winnerIndex];

    const resultMessage = `${winner.name} wins the game and takes ${session.pot}g!`;
    setup.CrownAndCasteUI.showFeedback(resultMessage);

    const nextPanel = document.getElementById("next-game-panel");
    const endPanel = document.getElementById("end-game-panel");
    const player = session.players.find(p => p.isPlayer);

    const otherActive = session.players.filter(p => !p.isPlayer && !p.isEliminated && p.gold > 0).length;
    const playerHasGold = player && player.gold > 0;

    const shouldEnd =
      !playerHasGold || // You're broke
      otherActive === 0; // You're alone

    if (shouldEnd && endPanel) {
      endPanel.style.display = "block";
    } else if (!shouldEnd && nextPanel) {
      nextPanel.style.display = "block";
    }

    // 💡 Freeze interaction visuals
    setup.CrownAndCasteUI.disableBoard();
  },


  initializeOrientationDetection() {
    // Only run on mobile devices
    if (!this.isMobileDevice()) return;

    this.checkOrientation();
    
    // Listen for orientation changes
    window.addEventListener('orientationchange', () => {
      setTimeout(() => this.checkOrientation(), 100);
    });
    
    // Also listen for resize events as a fallback
    window.addEventListener('resize', () => {
      setTimeout(() => this.checkOrientation(), 100);
    });
  },

  isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
           (window.innerWidth <= 768 && window.innerHeight <= 1024);
  },

  checkOrientation() {
    if (!this.isMobileDevice()) return;

    const orientationWarning = document.getElementById('orientation-warning');
    if (!orientationWarning) return;

    const isLandscape = window.innerWidth > window.innerHeight;
    
    if (isLandscape) {
      // Show warning in landscape mode
      orientationWarning.style.display = 'flex';
      if (State.variables.DEBUG || setup.DEBUG) {
        console.log("[CrownAndCasteUI] Landscape orientation detected, showing rotation warning");
      }
    } else {
      // Hide warning in portrait mode
      orientationWarning.style.display = 'none';
      if (State.variables.DEBUG || setup.DEBUG) {
        console.log("[CrownAndCasteUI] Portrait orientation detected, hiding rotation warning");
      }
    }
  },

  hideGameResult() {
    const panel = document.getElementById("next-game-panel");
    if (panel) {
      panel.style.display = "none";
    }
  },

  disableBoard() {
    const frame = document.getElementById("crown-caste-frame");
    if (frame) {
      frame.classList.add("board-disabled");
    }
  }

};
/* twine-user-script #30: "01_speechMacro.js" */
Macro.add('speech', {
	tags: null,
	handler: function () {
		const id = this.args[0];
		const text = this.payload[0].contents.trim();
		const char = State.variables.characters?.[id] || {};
		const displayName = (char.known && char.name) ? char.name : char.defaultName || "???";
		const avatar = char.avatar || "images/default.png";
		const color = char.color || "white";
		const bgColor = char.bgColor || "rgba(0, 0, 0, 0.8)";

		const output = `
			<div class="speech" style="color:${color}; background-color:${bgColor};">
				<span class="avatar" style="background-image: url('${avatar}');"></span>
				<div class="speech-content">
					<b>${displayName}</b>
					<hr>
					<p>${text}</p>
				</div>
			</div>
		`;

		$(this.output).wiki(output.trim());
	}
});
/* twine-user-script #31: "02_fogtextMacro.js" */
Macro.add("fogtext", {
	tags: null,
	handler: function () {
		const difficulty = parseInt(this.args[0]);
		const skill = this.args[1].toLowerCase();
		const content = this.payload[0].contents.trim();
		const fogId = "fogtext-" + Math.random().toString(36).substr(2, 9);

		if (isNaN(difficulty) || !skill) {
			return this.error("Invalid parameters: fogtext [difficulty] [skill]");
		}

		const skillValue =
			(State.variables.skills && State.variables.skills[skill]?.value) ??
			(State.variables.attributes && State.variables.attributes[skill]) ?? 0;

		const roll = random(1, 20);
		const total = roll + skillValue;
		const passed = total >= difficulty;

		let html = `<div id="${fogId}" class="fog-container">`;

		if (typeof State.temporary.fogResults === "undefined") {
			State.temporary.fogResults = {};
		}

		const alreadyRolled = State.temporary.fogResults[fogId];

		if (alreadyRolled) {
			if (alreadyRolled.passed) {
				html += `<div class="fogtext" title="Passed ${skill} ${alreadyRolled.roll}+${alreadyRolled.skill} ≥ ${difficulty}">${content}</div>`;
			} else {
				html += `<div class="fog-fail">You rolled a ${alreadyRolled.roll} + ${alreadyRolled.skill} = ${alreadyRolled.total} for ${skill}. You needed ${difficulty}.<br><em>You cannot make out the details.</em></div>`;
			}
		} else {
			html += `<div class="fog-unchecked">???</div>`;
			html += `<button class="fog-roll-button" onclick="
				(function() {
					const roll = random(1, 20);
					const skillValue = (State.variables.skills && State.variables.skills['${skill}']?.value) ??
					                   (State.variables.attributes && State.variables.attributes['${skill}']) ?? 0;
					const total = roll + skillValue;
					const passed = total >= ${difficulty};
					State.temporary.fogResults['${fogId}'] = { roll: roll, skill: skillValue, total: total, passed: passed };
					Engine.play(Engine.active.passages[Engine.active.passages.length - 1].title);
				})()
			">Roll for ${skill.charAt(0).toUpperCase() + skill.slice(1)}</button>`;
		}

		html += `</div>`;
		$(this.output).wiki(html);
	}
});
/* twine-user-script #32: "adda.js" */
setup.adda_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "This place... it's yours?", target: "Adda_ThisPlaceIsYours" },
		{ label: "Your hosts really seem to care about you.", target: "Adda_HostsCare" },
		{ label: "You seem... different from the others.", target: "Adda_Different" },
		{ label: "How'd you end up starting this place?", target: "Adda_OriginStory", variable: "addaMentionedTakeover", hide: true },
		{ label: "You don't seem like someone people say no to.", target: "Adda_CommandPresence" },
		{ label: "Could you help me get a drink?", target: "Adda_OrderDrink" },
		{ label: "Can I get to know you better?", target: "Adda_StartMinigame", reuse: 0 },
		{ label: "Would you ever step away for something a little more private?", target: "Adda_GoPrivate", aff: ["adda", 10], trust: ["adda", 10], hide: true, logic: "or"},
        { label: "We can talk more later.", target: "GoodbyeAddaZero", reuse: 1 }
        
	]);
};

setup.adda_Conversation_Options_NoctailOrigin = function () {
	setup.smartChoices([
		{ label: "What was the brothel like before you took over?", target: "Adda_Origin_WhatWasItLike" },
		{ label: "Who was the previous owner?", target: "Adda_Origin_PreviousOwner" },
		{ label: "How did you get control of the place?", target: "Adda_Origin_HowSheTookIt" },
		{ label: "What changed under your leadership?", target: "Adda_Origin_ChangesMade" },
		{ label: "Any enemies left over from those days?", target: "Adda_Origin_LocalPolitics" },
		{ label: "Let's talk about something else.", target: "Adda_Origin_Exit", reuse: 1 }
	]);
};
/* twine-user-script #33: "allura.js" */
setup.allura_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{label: "Were you watching me?", target: "Allura_Watching" },
		{label: "Don't take this the wrong way, but you feel out of place here a little.",target: "Allura_OutOfPlace"},
		{ label: "Do you actually enjoy doing this?", target: "Allura_Enjoyment" },
		{ label: "Can I do anything to make your night?", 	target: "Allura_WhatCanIDo"},
		{label: "Would you mind ordering a drink for me?", target: "Allura_DrinkOrder"},
		{ label: "Would you want to go somewhere more private?", target: "Allura_GoSomewherePrivate", trust: ["allura", 4], aff: ["allura", 4], logic: "and", reuse: 1, hide: false},
		{ label: "We can talk more later.", target: "Allura_ReturnToParlor", reuse: 1, notVariable: "Read_Phase0_allura_Allura_GoSomewherePrivate", hide: true}
	]);
};

setup.allura_Conversation_Options_Phase1 = function () {
	setup.smartChoices([
		{
		label: "Your room is beautiful. Do they all look like this?",
		target: "AlluraRoom",
		notVariable: "Read_Phase1_allura_Allura_GetComfortable",
		hide: true
		},
		{
		label: "So… what do we do now?",
		target: "Allura_WhatDoNow",
		notVariable: "Read_Phase1_allura_Allura_GetComfortable",
		hide: true
		},
		{ label: "Do you mind if I get comfortable with you?", target: "Allura_GetComfortable" },
		{ label: "I want to get to know you better.", target: "AlluraOpenConvoMinigameOne", variable: "Read_Phase1_allura_Allura_GetComfortable", hide: false },
		{ label: "Can I ask you a little bit about your past?", target: "BackstoryStart", variable: "Read_Phase1_allura_Allura_GetComfortable", hide: false },
		{
			label: "Can I kiss you?",
			target: "KissAllura",
			variable: "Read_Phase1_allura_Allura_GetComfortable",
			notVariable: "Read_Phase1_allura_JustLay",
			aff: ["allura", 9],
			trust: ["allura", 10],
			hide: true
		},
		{
			label: "If it's alright… I'd like to just lay here with you.",
			target: "JustLay",
			variable: "Read_Phase1_allura_Allura_GetComfortable",
			notVariable: "Read_Phase1_allura_KissAllura",
			hide: true
		}
		  
		
	]);
};

setup.allura_Conversation_Options_alluraBackstory = function () {
	setup.smartChoices([
		{ label: "Where did you grow up?", target: "WhereAlluraGrewUp" },
		{ label: "Do you know much about your parents?", target: "Parentage" },
		{ label: "If you could go anywhere in the world, where would it be?", target: "TravelWish" },
		{ label: "What's the worst or strangest client you've ever had?", target: "StrangeClient" },
		{ label: "Let's talk about something else.", target: "BackstoryExit", reuse: 1 }
	]);
};

/* twine-user-script #34: "bert.js" */
setup.bert_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "What's on the menu?", target: "Bert_OpenShop", reuse: 1 },
		{ label: "What kind of drink would you make for me?", target: "Bert_CustomDrink" },
		{ label: "Why so serious?",	target: "Bert_SeriousResponse" },
		{label: "I want to get to know you better.", target: "Bert_DenyMinigame" },
		{ label: "Nevermind.", target: "Bert_ReturnToParlor", reuse: 1 }
	]);
};
/* twine-user-script #35: "brakka.js" */
setup.brakka_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "How are you doing tonight?", target: "Brakka_Howareyoutonight" },
        { label: "Why 'Silks'?", target: "Brakka_WhySilks", compare: {value: "$calledSilks", op: ">=", against: 3 }, hide: true },
		{ label: "You look like you’ve seen some fights.", target: "Brakka_FightComment" },
		{ label: "I just wanted to say hi.", target: "Brakka_HelloAttempt" },
		{ label: "Enjoy your meal.", target: "Brakka_ExitwithTournyInvite", notVariable: "Read_Phase0_brakka_Brakka_ExitwithTournyInvite", hide: true },
        { label: "Enjoy your meal.", target: "Brakka_ExitNormally", variable: "Read_Phase0_brakka_Brakka_ExitwithTournyInvite", reuse: 1, hide: true}
	]);
};
/* twine-user-script #36: "darian.js" */
/**
 * Darian Conversation Setup Functions
 * Phase-based choice logic matching the .tw widget definitions.
 */

/* Adds options for Phase 0: initial conversation */
setup.darian_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{
			label: "How long have you worked here?",
			target: "Darian_HowLongHere"
		},
		{
			label: "Do you actually enjoy this job?",
			target: "Darian_DoYouLikeJob"
		},
		{
			label: "That bracelet you're wearing... where did it come from?",
			target: "Darian_Bracelet"
		},
		{
			label: "Any chance I could convince you to pour me a drink?",
			target: "Darian_GetDrink"
		},
		{
			label: "You hum a lot. Were you a musician once?",
			target: "Darian_Humming"
		},		
		{
			label: "I'd like to get to know you better.",
			target: "Darian_StartMinigame",
			reuse: 0
		},
		{
			label: "Do you think we could go somewhere more private?",
			target: "Darian_GoPrivate",
			trust: ["darian", 6],
			aff: ["darian", 3],
			logic: "and"
		},
		{
			label: "Nevermind.",
			target: "Darian_ReturnToParlor",
			notVariable: "Read_Phase0_darian_Darian_GoPrivate",
			reuse: 1,
			hide: true
		}
	]);
};

setup.darian_Conversation_Options_Phase1 = function () {
	setup.smartChoices([
		{
			label: "I like your room. Are they all like this?",
			target: "Darian_RoomComment"
		},
		{
			label: "So... what do we do now?",
			target: "Darian_WhatNow"
		},
		{
			label: "So how has your night been?",
			target: "Darian_HowsYourNight"
		},
		{
			label: "Do you mind if I ask you some more personal questions?",
			target: "Darian_AskDeeper",
			reuse: 1
		},
		{
			label: "Do you mind if I kiss you?",
			target: "Darian_AskToKiss",
			trust: ["darian", 9],
			aff: ["darian", 6],
			logic: "and",
			notVariable: "Read_Phase1_darian_Darian_MusicRequest"
		},
		{
			label: "Would it be too much trouble to pass the time with some music?",
			target: "Darian_MusicRequest",
			trust: ["darian", 14],
			aff: ["darian", 9],
			logic: "and",
			notVariable: "Read_Phase1_darian_Darian_AskToKiss"
		}
	]);
};

setup.darian_Conversation_Options_DarianDialogueDuet = function () {
	setup.smartChoices([
		{
			label: "Who gave you that bracelet?",
			target: "DarianDuet_Bracelet"
		},
		{
			label: "What was it like to travel around performing?",
			target: "DarianDuet_Performing"
		},
		{
			label: "Why did you start working at the Noctail?",
			target: "DarianDuet_WhyNoctail"
		},
		{
			label: "Did you ever fall in love on stage?",
			target: "DarianDuet_StageLove"
		},
		{
			label: "Do you ever miss the life you had before all this?",
			target: "DarianDuet_MissOldLife"
		},
		{
			label: "What's the most beautiful thing you've ever seen?",
			target: "DarianDuet_MostBeautiful"
		},
		{
			label: "Let's talk about something else.",
			target: "ReturnToDarianPhase1",
			reuse: 1
		}
	]);
};

/* twine-user-script #37: "eristan.js" */
/* twine-user-script #38: "harroc.js" */
 setup.harroc_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "Could I get a drink, please?", target: "Harroc_OrderDrink" },
		{ label: "[Open Shop *placeholder*] Do you have a food menu, or is it just drinks?", target: "Harroc_OpenShop" },
		{ label: "Has it always been this quiet in here?", target: "Harroc_RecentEvents" },
		{ label: "Heard any interesting rumors lately?", target: "Harroc_Rumors" },
		{ label: "I'll let you get back to it.", target: "Harroc_Phase0_Goodbye", reuse: 1 }
	]);
};
/* twine-user-script #39: "kallot.js" */
/* twine-user-script #40: "marie.js" */
setup.marie_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "How are you doing?", target: "Marie_Howareyoudoing" },
		{ label: "Looks like you've had a rough night.", target: "Marie_ToughNight" },
		{ label: "I'm a good listener.", target: "Marie_SilentTreatment" },
		{ label: "I'm sorry, I'll go.", target: "Marie_ImSorryIllGo", variable: "marieCanApologize", hide: true }
	]);
};

setup.marie_Conversation_Options_Phase1 = function () {
	setup.smartChoices([
		{ label: "Why did you choose this kind of work?", target: "Marie_WhyThisWork" },
		{ label: "Are you friends with any of the other hosts?", target: "Marie_HostsOrFriends" },
		{ label: "Do you like it at the Noctail?", target: "DoYouLikeItHere" },
		{ label: "Have you ever lived anywhere else?", target: "Marie_LivedAnywhereElse" },
		{ label: "Are you looking forward to the fair tomorrow?", target: "Marie_TheFairTomorrow" },
		{ label: "I'd like to get to know you better.", target: "Marie_StartMinigameOne", reuse: 0 },
		{ label: "Do you think we could go somewhere more private?", target: "Marie_GoUpstairs", aff: ["marie", 8], trust: ["marie", 8], logic: "or", hide: false}, //The option in question.
		{ label: "We can talk more later.", target: "Marie_Phase1Goodbye", notVariable: "Read_Phase1_marie_Marie_GoUpstairs", hide: true},
		

	]);
};

setup.marie_Conversation_Options_Phase2 = function () {
	setup.smartChoices([
		{
			label: "I really like your room. Do they all look like this?",
			target: "Marie_RoomComment"
		},
		{
			label: "What do you want to do now?",
			target: "Marie_WhatNow"
		},
		{
			label: "Do you want to talk about what happened outside?",
			target: "Marie_TalkAboutIt_Success",
			compare: {
			  value: "characters.marie.trust",
			  op: ">=",
			  against: 10
			},
			hide: true
		},  
		{
			label: "Do you want to talk about what happened outside?",
			target: "Marie_TalkAboutIt_Fail",
			compare: {
				value: "characters.marie.trust",
				op: "<",
				against: 10
			},
			hide: true
		},  
		{
			label: "Can I touch you?",
			target: "Marie_AskToTouch",
			aff: ["marie", 15],
			notVariable: "Read_Phase2_marie_Marie_LayAndTalk",
			hide: true,
		},
		{
			label: "Want to just lay here and talk for a bit?",
			target: "Marie_LayAndTalk",
			notVariable: "Read_Phase2_marie_Marie_AskToTouch",
			hide: true			
		}
	]);
};


setup.marie_Conversation_Options_TheFight = function () {
	setup.smartChoices([
		{
			label: "How long have you and Kallot been... whatever you are?",
			target: "Marie_Fight_HowLong"
		},
		{
			label: "Do you think he meant to hurt you?",
			target: "Marie_Fight_Intent"
		},
		{
			label: "Has he ever scared you before tonight?",
			target: "Marie_Fight_Pattern"
		},
		{
			label: "Do you think you'll talk to him again after this?",
			target: "Marie_Fight_Forgiveness"
		},
		{
			label: "I helped him, you know...",
			target: "Jaylie_Helped_Kallot",
			variable: "helpedkallot",
			variable: "Read_TheFight_marie_Marie_Fight_Forgiveness",
			hide: true
			
		},
		{
			label: "What were you like before all this? Before the Noctail?",
			target: "Marie_Fight_Backstory"
		},
		{
			label: "We can talk about something else.",
			target: "Marie_Fight_Exit",
			reuse: 1
		}
	]);
};
/* twine-user-script #41: "redmarrow.js" */
setup.redmarrow_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "You always dress this sharp?", target: "Redmarrow_ArmorFlattery" },
		{ label: "What do you do for work?", target: "Redmarrow_JobPrompt" },
		{ label: "Redmarrow? That your real name?", target: "Redmarrow_NameOrigin", variable: "Read_Phase0_redmarrow_Redmarrow_JobPrompt", hide: true },
		{ label: "Can anyone take work from the Guild?", target: "Redmarrow_BountyQuest", variable: "Read_Phase0_redmarrow_Redmarrow_JobPrompt", hide: true },
		{ label: "About that job...", target: "Redmarrow_TheJob", variable: "readyForBoutyQuestion", hide: true, reuse:1 },
		{ label: "Enjoy your night.", target: "Redmarrow_Exit", reuse: 1 }
	]);
};

 

setup.redmarrow_Conversation_Options_TheFirstBounty = function () {
	setup.smartChoices([
		{
			label: "[Pay 20 :coin:] I would like to sign up for the guild.",
			target: "Redmarrow_BountySignUp",
			item: ["gold_coin", 20],
			hide: false
		},
        {label: "Can you tell who the target is again?", target: "Redmarrow_WhoIsItAgain", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1},
		{label: "How should I find him?", target: "HowFindTelVaras", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1},
		{label: "How much is this job paying again?", target: "TelVarasHowMuchPay", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1},
		{label: "Is there anything else I should know?", target: "TelVarasAnythingElse", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1 },
       	{ label: "Let's talk about something else.", target: "Redmarrow_ReturnBountytoPhase0", reuse: 1}
	]);

	// 👇 Inject Lucide icons for any :coin: placeholders
	setTimeout(() => {
	// Replace any span or text node that includes :coin: with actual icon injection
	$("#convoChoices p.dialogue-choice").each(function () {
		const $this = $(this);
		const html = $this.html();
		if (html.includes(":coin:")) {
			$this.html(html.replace(/:coin:/g, '<i data-lucide="coins"></i>'));
		}
	});
	if (window.lucide) lucide.createIcons();
}, 0);

};
/* twine-user-script #42: "tesska.js" */
// =======================
// Tesska Phase 0 Trigger Function
// =======================
setup.tesska_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "Can I get a drink?", target: "Tesska_GetDrink" },
		{ label: "It's kind of quiet in here tonight.", target: "Tesska_QuietNight" },
		{ label: "Do you always work nights?", target: "Tesska_WorkNights" },
		{ label: "How long have you and Harroc been running this place?", target: "Tesska_RunningThePlace", logic: "and", variable: "tesskaAskedWorkNights", hide: true },
		{ label: "Do you get many unusual customers?", target: "Tesska_UnusualCustomers" },

		// Exit options with corrected logic
		{ 
			label: "Thanks, I think I'll just sit quietly for a bit.", 
			target: "Tesska_Exit", 
			hideIf: { variable: "Read_Phase0_tesska_Tesska_GetDrink" }, 
			reuse: 1 
		},
		{ 
			label: "Thanks, I think I'm going to nurse this drink for a while.", 
			target: "Tesska_ExitDrink",  
			variable: "Read_Phase0_tesska_Tesska_GetDrink",
			reuse: 1, 
			hide: true
		},
	]);
};
/* twine-user-script #43: "02_DeclarativeDialogueSystem.js" */
// ===============================
// Declarative Dialogue Detection System
// ===============================

$(document).on(':passagerender', function (ev) {
	setTimeout(function () {
		const passageElement = document.querySelector('#passages > .passage');
		const backdrop = document.getElementById('text-backdrop');

		if (!passageElement || !backdrop) {
			console.warn("[DeclarativeSystem] Required elements missing.");
			return;
		}

		const passageHTML = passageElement.innerHTML;
		const isDialogueMode = passageHTML.includes('StartDialogueLayout');

		// 💣 Always wipe previous layout clean
		backdrop.innerHTML = "";
		backdrop.classList.remove("in-dialogue");

		// ☢️ Just in case — double-tap ghosts
		["convoChoices", "convoBox", "convoLayoutContainer", "convoBoxPanel", "convoChoicesPanel"].forEach(id => {
			const el = document.getElementById(id);
			if (el) {
				console.warn(`[DeclarativeSystem] Removing lingering #${id}`);
				el.remove();
			}
		});

		if (isDialogueMode) {
			console.log("[DeclarativeSystem] Rebuilding as DIALOGUE layout.");
			setup.startDialogueLayout();
		} else {
			console.log("[DeclarativeSystem] Normal prose passage — layout handled by injector.");
			// No action needed — prose will be injected by 04_PassageInjector.js
		}
	}, 20);
});

// ===============================
// Dialogue Layout Builder
// ===============================

setup.startDialogueLayout = function () {
	const backdrop = document.getElementById('text-backdrop');

	if (!backdrop) return;

	backdrop.classList.add('in-dialogue');

	backdrop.innerHTML = `
		<div id="convoLayoutContainer">
			<div id="convoChoicesPanel">
				<div id="convoChoices"></div>
			</div>
			<div id="convoBoxPanel">
				<div id="convoBox"></div>
			</div>
		</div>
	`;
};
/* twine-user-script #44: "SaveAPI.js" */
window.SaveAPI = window.SaveAPI || {};

SaveAPI.nativeSaveMenu = function () {
	try {
		if (typeof UI !== "undefined" && typeof UI.save === "function") {
			UI.save();
		} else {
			console.warn("UI.save() not available. Trying SugarCube fallback...");
			if (typeof Dialog !== "undefined" && typeof Dialog.open === "function") {
				Dialog.open("saves");
			} else {
				alert("Save menu still not available. Something deeper is wrong.");
			}
		}
	} catch (err) {
		console.error("Save menu call failed:", err);
		alert("Could not open save menu.");
	}
};
/* twine-user-script #45: "999_main.js" */
console.log("🔥 999_main.js loaded!");
// Basic setup
if (typeof setup === 'undefined') {
	setup = {};
}

// Debug logging
window.debugLog = function (...args) {
	if (State.variables.DEBUG) {
		console.log("📢 DEBUG:", ...args);
	}
};

// TEMP boot check
$(document).on(':passagestart', function () {
	console.log("🛠 StoryInit triggered.");
	if (setup.loadItemData) {
		console.log("🟢 setup.loadItemData exists. Running...");
		setup.loadItemData();
	} else {
		console.error("❌ setup.loadItemData is NOT defined yet.");
	}
});
/* twine-user-script #46: "SexScene_Acts.js" */
setup.SexualActsDB = {
	Oral_Penis_G_Tease: {
		label: "Tease Their Cock With Your Mouth",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 8 },
		preferenceTags: ["Oral_R", "Penis"],
		inclinationTags: ["tease", "service"],
		togglable: true
	},

	Oral_Penis_G_Suck: {
		label: "Suck Their Cock",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 15 },
		preferenceTags: ["Oral_R", "Penis"],
		inclinationTags: ["submission", "service"],
		togglable: true
	},

	Anal_G_Tease: {
		label: "Tease Their Asshole With Your Cock",
		category: "Anal",
		actionType: "anal",
		stageGroup: "anal_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["anus"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 6, object: 10 },
		preferenceTags: ["Anal_P", "Dominate"],
		inclinationTags: ["penetration", "dominance"],
		togglable: true
	},

	Anal_G_Penetrate: {
		label: "Penetrate Their Ass",
		category: "Anal",
		actionType: "anal",
		stageGroup: "anal_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["anus"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 12, object: 18 },
		preferenceTags: ["Anal_P", "Rough"],
		inclinationTags: ["penetration", "dominance"],
		togglable: true
	},

	Handjob_Clit_G_Tease: {
		label: "Tease Their Clit With Your Fingers",
		category: "Manual",
		actionType: "clitoral",
		stageGroup: "handjob_clit",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["clitoris"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 10 },
		preferenceTags: ["Clit_Rub", "Tease"],
		inclinationTags: ["gentle", "foreplay"],
		togglable: true
	},

	Handjob_Clit_G: {
		label: "Rub Their Clit",
		category: "Manual",
		actionType: "clitoral",
		stageGroup: "handjob_clit",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["clitoris"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 14 },
		preferenceTags: ["Clit_Rub", "Stimulation"],
		inclinationTags: ["service", "direct"],
		togglable: true
	},

	Boobjob_G_Tease: {
		label: "Tease Their Cock With Your Breasts",
		category: "Breast",
		actionType: "boobjob",
		stageGroup: "boobjob_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["breasts"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 9 },
		preferenceTags: ["BreastPlay_R", "Oral_G"],
		inclinationTags: ["tease", "visual"],
		togglable: true
	},

	Boobjob_G: {
		label: "Give Them a Boobjob",
		category: "Breast",
		actionType: "boobjob",
		stageGroup: "boobjob_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["breasts"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 16 },
		preferenceTags: ["BreastPlay_R", "Stimulation"],
		inclinationTags: ["visual", "submission"],
		togglable: true
	},

	Footjob_Vagina_G_Tease: {
		label: "Tease Their Pussy With Your Foot",
		category: "Feet",
		actionType: "footjob",
		stageGroup: "footjob_vagina",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["feet"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 9 },
		preferenceTags: ["Feet", "Pussy"],
		inclinationTags: ["fetish", "control"],
		togglable: true
	},

	Footjob_Vagina_G: {
		label: "Give Them a Footjob",
		category: "Feet",
		actionType: "footjob",
		stageGroup: "footjob_vagina",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["feet"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 13 },
		preferenceTags: ["Feet", "Pussy", "Stimulation"],
		inclinationTags: ["fetish", "playful"],
		togglable: true
	},

	Player_Cum_Anal_Inside: {
	label: "Cum Deep In Their Ass",
	category: "Orgasm",
	actionType: "orgasm",
	stageLevel: 0,
	isCumming: true,
	giver: "player",
	receiver: "npc",
	subjectParts: ["penis"],
	objectParts: ["anus"],
	orgasmTags: ["anal_internal", "penetration"],
	preferenceTags: ["Anal_P", "Orgasm_Inside"],
	inclinationTags: ["dominance", "release"],
	togglable: false
	},

	Player_Cum_Vaginal_Inside: {
		label: "Cum Deep In Their Pussy",
		category: "Orgasm",
		actionType: "orgasm",
		stageLevel: 0,
		isCumming: true,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["vagina"],
		orgasmTags: ["vaginal_internal", "penetration"],
		preferenceTags: ["Vaginal_P", "Orgasm_Inside"],
		inclinationTags: ["intimacy", "release"],
		togglable: false
	},

	Player_Cum_On_Face: {
		label: "Cum On Their Face",
		category: "Orgasm",
		actionType: "orgasm",
		stageLevel: 0,
		isCumming: true,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["face"], // not a tracked body part, but logically targeted
		orgasmTags: ["facial", "external"],
		preferenceTags: ["Oral_G", "Face_Cum"],
		inclinationTags: ["control", "messy"],
		togglable: false
	},







	/*  NPC ACTION LIST */
	/* HAND */
	Handjob_Penis_NPC_Tease: {
	label: "Stroke Your Cock Teasingly",
	giver: "npc",
	receiver: "player",
	subjectParts: ["hand"],
	objectParts: ["penis"],
	stageGroup: "Handjob_NPC",
	stageLevel: 0,
	baseExcitement: { subject: 5, object: 10 },
	inclinationTags: ["tease"],
	togglable: false
	},




	/* MOUTH */




	/* FEET */




	/* ANUS */




	/* PENIS */





	/* VAGINA */





	/* BREASTS */





};
/* twine-user-script #47: "SexScene_Responses.js" */
setup.SexSceneResponses = {
	Oral_Penis_G_Tease: {
		start: ["You brush your lips over their shaft, teasing with warm breath."],
		Neutral: ["You let your lips glide lazily along their length, maintaining just enough contact to keep them aching."],
		Liked: ["You tease every inch of their cock with slow licks and playful flicks of your tongue, drawing moans from deep in their throat."],
		Disliked: ["You lightly mouth their shaft, but they seem distracted, barely reacting."],
		climax: ["Their cock throbs against your lips, the teasing too much to bear."]
	},

	Oral_Penis_G_Suck: {
		start: ["You take them into your mouth, lips sealing around their length."],
		Neutral: ["You work your mouth steadily up and down their shaft, guided by the rhythm of their breath."],
		Liked: ["You suck with focused hunger, your tongue swirling and lips tight, earning sharp gasps and helpless thrusts."],
		Disliked: ["You suck slowly, but their tension suggests it's not quite doing it for them."],
		climax: ["They twitch and groan in your mouth, spilling warmth across your tongue."]
	},

	Anal_G_Tease: {
		start: ["You press your tip against their tight entrance, circling gently."],
		Neutral: ["You let your cock rest against their hole, rocking slowly, teasing the promise of more."],
		Liked: ["You grind your hips forward with just enough pressure to drive them wild, the tease perfectly cruel."],
		Disliked: ["You nudge at their ass, but they tense up, clearly not enjoying the attention."],
		climax: ["They shudder under you, overwhelmed by the slow torment."]
	},

	Anal_G_Penetrate: {
		start: ["You push inside them, stretching them open inch by inch."],
		Neutral: ["You thrust into their ass at a measured pace, relishing the way they tighten around you."],
		Liked: ["You drive in deep, your rhythm demanding and unrelenting—exactly how they want it."],
		Disliked: ["You push forward, but they flinch, their body stiff beneath you."],
		climax: ["You bury yourself to the hilt and release deep inside."]
	},

	Handjob_Clit_G_Tease: {
		start: ["You trail your fingers over their slit, barely grazing their clit."],
		Neutral: ["Your fingertips move in slow, spiraling circles that build delicious tension."],
		Liked: ["You ghost your fingers over their clit just how they love it, watching them twitch with need."],
		Disliked: ["You toy with their clit, but they barely react, their eyes distant."],
		climax: ["They twitch and moan as waves of pleasure ripple through them."]
	},

	Handjob_Clit_G: {
		start: ["You press against their clit and begin to rub firmly."],
		Neutral: ["You rub their clit with practiced rhythm, each motion drawing another breathy moan."],
		Liked: ["You circle and flick their clit with precision, sending shocks of pleasure through their core."],
		Disliked: ["You rub their clit, but they shift away slightly, clearly not enjoying the pressure."],
		climax: ["They cry out, clenching around nothing as they climax hard."]
	},

	Boobjob_G_Tease: {
		start: ["You squeeze your breasts together and brush them over their cock."],
		Neutral: ["You press your breasts around their shaft and begin to slide slowly."],
		Liked: ["You smother their cock between your breasts, shifting your body with sensual grace."],
		Disliked: ["You try to tease their cock with your breasts, but they glance away, unengaged."],
		climax: ["They groan, hips twitching helplessly against your chest."]
	},

	Boobjob_G: {
		start: ["You wrap their cock between your breasts and begin to move."],
		Neutral: ["You pump your chest with rhythmic motion, their shaft slick and straining between you."],
		Liked: ["You bounce your breasts enthusiastically, letting them watch every angle of your display."],
		Disliked: ["You move steadily, but their attention seems to wander—clearly not their favorite."],
		climax: ["Hot ropes shoot across your collarbone as they finish between your breasts."]
	},

	Footjob_Vagina_G_Tease: {
		start: ["You press your toes gently against their slit, tracing the outer lips."],
		Neutral: ["You drag your foot along their folds, the sensation strange but not unpleasant."],
		Liked: ["You tease their pussy with your toes in slow, deliberate patterns, and they gasp with delight."],
		Disliked: ["You press your foot between their thighs, but they shift uncomfortably at the contact."],
		climax: ["They arch with a cry as your toes coax their orgasm from them."]
	},

	Footjob_Vagina_G: {
		start: ["You rest your foot against their pussy and begin to move deliberately."],
		Neutral: ["You grind your sole against their clit, matching their breathing."],
		Liked: ["Your toes dance skillfully over their clit, and they shiver from the kinky pleasure."],
		Disliked: ["You slide your foot against their sex, but their expression is distracted, uninterested."],
		climax: ["They tremble beneath you, juices coating your foot as they climax."]
	},

  Player_Cum_Anal_Inside: {
	  climax: ["You gasp and drive yourself deeper as your release floods into their ass.",
		"A low moan escapes you as you pulse deep inside them, filling them completely." ]
  },

  Player_Cum_Vaginal_Inside: {
    climax: [
			"You bury yourself deep and fill their pussy with pulsing heat.",
			"A moan tears from your throat as you release inside their pussy, overwhelmed by the pressure."
		]
	},

	Player_Cum_On_Face: {
		climax: [
			"You pull up and let loose across their face, watching it paint their cheeks and lips.",
			"Your body jerks with each spurt as you cover their face with sticky warmth."
		]
	},








	/*  NPC ACTION LIST */
	/* NPC - HAND */
	Handjob_Penis_NPC_Tease: {
	Neutral: ["Their hand moves rhythmically along your length."],
	Liked: ["They give your cock a slow, teasing stroke that makes your breath catch."],
	Disliked: ["They stroke you without much care or focus."]
	},







	/* MOUTH */




	/* FEET */




	/* ANUS */




	/* PENIS */





	/* VAGINA */





	/* BREASTS */






};
/* twine-user-script #48: "convo_prompts.js" */
/* ======================================================
   Conversation Prompt Library
   ------------------------------------------------------
   Random prompt selector for the minigame. Each prompt:
   - Has a theme
   - Adjusts base difficulty
   - Unlocks at a trust+affection threshold
========================================================= */

setup.ConvoPrompts = [

  // Tier 1 - Small Talk, Light Curiosity
  { text: "What's your drink of choice?", theme: "light", baseDifficultyMod: 0, heatTier: 1 },
  { text: "What kind of weather puts you in a good mood?", theme: "light", baseDifficultyMod: 0, heatTier: 1 },
  { text: "If you could have any animal as a companion, what would it be?", theme: "whimsy", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Is there a food you just can't stand?", theme: "quirky", baseDifficultyMod: 0, heatTier: 1 },
  { text: "What's the strangest dream you've ever had?", theme: "weird", baseDifficultyMod: 2, heatTier: 1 },
  { text: "What do you think people misunderstand about you?", theme: "personal", baseDifficultyMod: 2, heatTier: 1 },
  { text: "What's your idea of comfort food?", theme: "quirky", baseDifficultyMod: 0, heatTier: 1 },
  { text: "Tell me a sound that makes you feel calm.", theme: "soft", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What's something small that always makes you smile?", theme: "light", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Are you more of a sunrise or sunset person?", theme: "whimsy", baseDifficultyMod: 0, heatTier: 1 },
  { text: "What's the most unusual habit you have?", theme: "quirky", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Do you talk to yourself? Out loud?", theme: "oddball", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Do you find silence peaceful or uncomfortable?", theme: "introspective", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What do you notice first when you walk into a room?", theme: "perception", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What's your favorite way to waste time?", theme: "quirky", baseDifficultyMod: 0, heatTier: 1 },
  { text: "If money wasn't an issue, what would you do every day?", theme: "dreamy", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What kind of music makes you feel alive?", theme: "personal", baseDifficultyMod: 1, heatTier: 1 },
  { text: "How do you normally spend your nights?", theme: "smalltalk", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Do you believe in fate, or is everything just random?", theme: "philosophy", baseDifficultyMod: 2, heatTier: 1 },
  { text: "What's the last thing that made you laugh really hard?", theme: "joy", baseDifficultyMod: 1, heatTier: 1 },

  // Tier 2 – Flirty, Teasing, Growing Interest
  { text: "Do you think I'm attractive?", theme: "flirty", baseDifficultyMod: 2, heatTier: 2 },
  { text: "What part of your body do you secretly like the most?", theme: "personal", baseDifficultyMod: 2, heatTier: 2 },
  { text: "How would you react if I told you I had a crush on you?", theme: "flirty", baseDifficultyMod: 2, heatTier: 2 },
  { text: "What's the most flattering thing someone's said to you?", theme: "vanity", baseDifficultyMod: 2, heatTier: 2 },
  { text: "What's something subtle that turns you on?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Would you let someone kiss you without asking?", theme: "boundaries", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What does your ideal first kiss look like?", theme: "romantic", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Do you like it when someone takes the lead?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What's your idea of a perfect flirtation?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Have you ever been caught checking someone out?", theme: "tease", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Where would you want someone to touch you during a slow dance?", theme: "suggestive", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What compliment would melt you every time?", theme: "vanity", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Do you like when someone teases you?", theme: "playful", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What's your favorite place to be kissed?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Would you let someone feed you something sweet?", theme: "intimate", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Would you be the one to make the first move?", theme: "challenge", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What kind of looks make your heart skip?", theme: "romantic", baseDifficultyMod: 2, heatTier: 2 },
  { text: "If I leaned in just a little… what would you do?", theme: "intimate", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Would you let someone touch your face?", theme: "boundaries", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What's something someone could say that would fluster you?", theme: "tease", baseDifficultyMod: 3, heatTier: 2 },

  // Tier 3 – Confessional, Vulnerability, Connection
  { text: "What scares you most about getting close to someone?", theme: "vulnerable", baseDifficultyMod: 3, heatTier: 3 },
  { text: "Have you ever fallen for someone you shouldn't have?", theme: "romantic", baseDifficultyMod: 2, heatTier: 3 },
  { text: "Is there a secret you've never told anyone?", theme: "confessional", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What part of yourself do you hide from most people?", theme: "shadow", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What would you do if we were alone right now?", theme: "intimate", baseDifficultyMod: 4, heatTier: 3 },
  { text: "Have you ever been hurt so badly it changed you?", theme: "emotional", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What do you crave more—intimacy or understanding?", theme: "introspective", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What's something that always makes you feel safe?", theme: "comfort", baseDifficultyMod: 3, heatTier: 3 },
  { text: "How do you act when you're falling in love?", theme: "romantic", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What does your ideal night look like—no limits?", theme: "dreamy", baseDifficultyMod: 3, heatTier: 3 },
  { text: "Is there something you've never forgiven yourself for?", theme: "emotional", baseDifficultyMod: 4, heatTier: 3 },
  { text: "Do you trust easily? Or does it take time?", theme: "guarded", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What would hurt you more—being forgotten or being betrayed?", theme: "trust", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What do you miss most about being a child?", theme: "nostalgia", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What kind of touch calms you down the most?", theme: "sensual", baseDifficultyMod: 3, heatTier: 3 },
  { text: "If you could erase one regret, would you do it?", theme: "contemplative", baseDifficultyMod: 2, heatTier: 3 },
  { text: "What would you do if you weren't afraid of failing?", theme: "aspiration", baseDifficultyMod: 3, heatTier: 3 },
  { text: "Do you believe people can really change?", theme: "philosophy", baseDifficultyMod: 3, heatTier: 3 },
  { text: "How do you know when someone truly cares?", theme: "introspective", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What's something beautiful that makes you sad?", theme: "melancholy", baseDifficultyMod: 3, heatTier: 3 },

  // Tier 4 – Romantic, Physical, Sensual
  { text: "Would you let someone undress you with their eyes?", theme: "bold", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you like the sound of your own name on someone else's lips?", theme: "flirty", baseDifficultyMod: 3, heatTier: 4 },
  { text: "What would you do if I leaned in closer right now?", theme: "intimate", baseDifficultyMod: 3, heatTier: 4 },
  { text: "Where do you like being kissed the most?", theme: "sensual", baseDifficultyMod: 4, heatTier: 4 },
  { text: "If I kissed you without warning, would you stop me?", theme: "challenge", baseDifficultyMod: 4, heatTier: 4 },
  { text: "What would you whisper in someone's ear to make them shiver?", theme: "tease", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you like it rough, or slow and teasing?", theme: "sensual", baseDifficultyMod: 4, heatTier: 4 },
  { text: "What's the most intimate moment you've ever shared with someone?", theme: "romantic", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Where would your hands wander first?", theme: "suggestive", baseDifficultyMod: 5, heatTier: 4 },
  { text: "Would you like to be touched like a secret?", theme: "poetic", baseDifficultyMod: 5, heatTier: 4 },
  { text: "Have you ever fantasized about someone in this room?", theme: "fantasy", baseDifficultyMod: 4, heatTier: 4 },
  { text: "If I traced your skin, would you shiver or smirk?", theme: "intimate", baseDifficultyMod: 5, heatTier: 4 },
  { text: "What part of your body do you wish someone adored more?", theme: "vulnerable", baseDifficultyMod: 4, heatTier: 4 },
  { text: "What's the most seductive thing someone's said to you?", theme: "memory", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you want someone who obeys… or someone who leads?", theme: "dominance", baseDifficultyMod: 4, heatTier: 4 },
  { text: "If I said 'touch me,' where would your hands go first?", theme: "command", baseDifficultyMod: 5, heatTier: 4 },
  { text: "If you were told to beg, would you?", theme: "powerplay", baseDifficultyMod: 5, heatTier: 4 },
  { text: "Would you prefer devotion or desire?", theme: "endearment", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you like being worshipped?", theme: "worship", baseDifficultyMod: 5, heatTier: 4 },
  { text: "If I pulled you into my lap, what would you do?", theme: "assertive", baseDifficultyMod: 5, heatTier: 4 },

  // Tier 5 – Erotic, Emotional Endgame
  { text: "Do you love me? Be honest.", theme: "serious", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Could you ever see us having a future together?", theme: "endgame", baseDifficultyMod: 5, heatTier: 5 },
  { text: "If I needed you to run away with me, would you?", theme: "commitment", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What would it take for you to give up everything for someone?", theme: "sacrifice", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you still care for me if I lost everything?", theme: "devotion", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If you woke up and I was gone forever, what would you miss most?", theme: "melancholy", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I asked you to disappear with me, would you say yes?", theme: "devotion", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Do you think soulmates are real… and are we?", theme: "endgame", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Could you be happy with just me, and no one else?", theme: "commitment", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you wait a lifetime if it meant we'd be together in the end?", theme: "patience", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I forgot who you were tomorrow, how would you remind me?", theme: "devastation", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Could you walk away from me if it meant I'd be safer?", theme: "sacrifice", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you rather die in my arms, or live not knowing if I loved you?", theme: "tragedy", baseDifficultyMod: 7, heatTier: 5 },
  { text: "If this world burned down tomorrow, would you still choose me?", theme: "rideordie", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What scares you more—losing me or never having me at all?", theme: "attachment", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you still love me if I lost my mind?", theme: "devotion", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What's more important—freedom or loyalty?", theme: "conflict", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I gave you everything, would it be enough?", theme: "yearning", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I whispered 'stay', would you?", theme: "poetic", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Are you mine?", theme: "claiming", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you kneel for someone like me?", theme: "submission", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I pushed you against the wall, would you resist?", theme: "dominance", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Do you want to be ruined slowly… or all at once?", theme: "control", baseDifficultyMod: 7, heatTier: 5 },
  { text: "What would you do if I told you not to make a sound?", theme: "tease", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Where would you want me to bite first?", theme: "nsfw", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you let me use you, if I promised to worship you after?", theme: "powerplay", baseDifficultyMod: 7, heatTier: 5 },
  { text: "If I said 'hands behind your back,' what would you do?", theme: "command", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Do you ache for the kind of touch that leaves bruises or poetry?", theme: "poetic", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you obey if I told you not to move?", theme: "control", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you rather moan my name or beg for forgiveness?", theme: "blasphemy", baseDifficultyMod: 8, heatTier: 5 },
  { text: "What would you whisper in my ear if I were on my knees?", theme: "reversal", baseDifficultyMod: 7, heatTier: 5 },
  { text: "What part of your body begs for attention but never asks?", theme: "vulnerable", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I told you I dreamed of tying you up, would you sleep better or worse tonight?", theme: "fantasy", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you still want me if I said you'd have to earn every touch?", theme: "challenge", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What would you let me do… if I said please?", theme: "restraint", baseDifficultyMod: 6, heatTier: 5 }

];

  
  // ================================
  // Select a valid prompt based on relationship
  // ================================
  
  setup.getConvoPrompt = function (npc) {
    const turn = State.temporary.convo?.turn ?? 1;
    const currentHeatTier = Math.min(5, Math.ceil(turn / 5)); // One tier per 5 turns
  
    const valid = setup.ConvoPrompts.filter(p => p.heatTier === currentHeatTier);
    const unseen = setup.ConvoPromptTracker.filterUnseen(valid);
  
    const chosen = unseen.length > 0 ? randomFrom(unseen) : randomFrom(valid);
  
    setup.ConvoPromptTracker.markShown(chosen.text);
    return chosen;
  };
  
  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  
// ================================
// Prompt Tracker (optional enhancement)
// ================================

setup.ConvoPromptTracker = {
    shownThisSession: [],
  
    reset() {
      this.shownThisSession = [];
      console.log("[ConvoPrompt] Tracker reset");
    },
  
    markShown(promptText) {
      this.shownThisSession.push(promptText);
    },
  
    filterUnseen(validPrompts) {
      return validPrompts.filter(p => !this.shownThisSession.includes(p.text));
    }
  };
  
/* twine-user-script #49: "convo_tropes.js" */
/* ======================================================
   Relationship Conversation Minigame Core System
   ------------------------------------------------------
   This system powers the turn-based interaction minigame
   between the player and NPCs, using: 
   - Traits to affect success chances
   - Rapport, Affection, Trust, and Tension stats
   - Motivations to influence prompt theming
   - Gifts to affect rapport/tension
   - Results screen on exit
   - Skill XP gain based on trope usage (1–3 XP)
========================================================= */

// ================================
// Conversation Tropes Definition
// ================================

setup.ConvoTropesByTier = {
  1: [ // Icebreakers, low risk
    {
      key: "joke",
      label: "Tell a Joke",
      skill: "performance",
      baseDifficulty: 8,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "ask_hobby",
      label: "Ask about their hobbies",
      skill: "insight",
      baseDifficulty: 7,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "relate",
      label: "Relate to them",
      skill: "insight",
      baseDifficulty: 8,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "compliment_clothes",
      label: "Compliment their outfit",
      skill: "persuasion",
      baseDifficulty: 9,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "tease_light",
      label: "Tease playfully",
      skill: "performance",
      baseDifficulty: 10,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "stay_silent",
      label: "Stay silent and observe",
      skill: "willpower",
      baseDifficulty: 6,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "make_fun_of_self",
      label: "Poke fun at yourself",
      skill: "wit",
      baseDifficulty: 9,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "ask_question",
      label: "Ask a personal question",
      skill: "insight",
      baseDifficulty: 10,
      effects: { trust: 2 },
      heatTier: 1
    },
    {
      key: "flirt_subtle",
      label: "Flirt (subtle)",
      skill: "persuasion",
      baseDifficulty: 10,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "observe_room",
      label: "Comment on the room",
      skill: "wit",
      baseDifficulty: 7,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "compliment_eyes",
      label: "Compliment their eyes",
      skill: "persuasion",
      baseDifficulty: 11,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "open_up_small",
      label: "Share a small truth",
      skill: "insight",
      baseDifficulty: 9,
      effects: { trust: 1 },
      heatTier: 1
    }
  ],
  2: [ // Flirty, bolder
    {
      key: "compliment_scent",
      label: "Compliment their scent",
      skill: "persuasion",
      baseDifficulty: 12,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "eye_contact",
      label: "Hold eye contact",
      skill: "willpower",
      baseDifficulty: 11,
      effects: { trust: 1, affection: 1 },
      heatTier: 2
    },
    {
      key: "comment_smile",
      label: "Compliment their smile",
      skill: "persuasion",
      baseDifficulty: 10,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "ask_romantic_prefs",
      label: "Ask what they're into",
      skill: "insight",
      baseDifficulty: 13,
      effects: { trust: 1 },
      heatTier: 2
    },
    {
      key: "tease_back",
      label: "Tease them right back",
      skill: "performance",
      baseDifficulty: 13,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "flirt_open",
      label: "Openly flirt",
      skill: "persuasion",
      baseDifficulty: 14,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "drop_innuendo",
      label: "Drop a suggestive line",
      skill: "wit",
      baseDifficulty: 15,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "mention_touch",
      label: "Mention how close they are",
      skill: "observation",
      baseDifficulty: 13,
      effects: { affection: 1 },
      heatTier: 2
    },
    {
      key: "mirror_posture",
      label: "Match their posture",
      skill: "hands",
      baseDifficulty: 10,
      effects: { trust: 1 },
      heatTier: 2
    },
    {
      key: "ask_dating",
      label: "Ask about past relationships",
      skill: "insight",
      baseDifficulty: 14,
      effects: { trust: 2 },
      heatTier: 2
    },
    {
      key: "touch_hand",
      label: "Gently touch their hand",
      skill: "hands",
      baseDifficulty: 16,
      effects: { affection: 3 },
      heatTier: 2
    },
    {
      key: "smile_genuine",
      label: "Smile genuinely",
      skill: "performance",
      baseDifficulty: 10,
      effects: { affection: 1 },
      heatTier: 2
    }
  ],
  3: [ // Emotional, bold, physical
    {
      key: "touch_face",
      label: "Brush a strand of hair aside",
      skill: "hands",
      baseDifficulty: 17,
      effects: { affection: 3 },
      heatTier: 3
    },
    {
      key: "share_secret",
      label: "Share a vulnerable secret",
      skill: "insight",
      baseDifficulty: 16,
      effects: { trust: 3 },
      heatTier: 3
    },
    {
      key: "compliment_body",
      label: "Compliment their body",
      skill: "persuasion",
      baseDifficulty: 17,
      effects: { affection: 2 },
      heatTier: 3
    },
    {
      key: "ask_fantasy",
      label: "Ask about a fantasy",
      skill: "insight",
      baseDifficulty: 18,
      effects: { trust: 2 },
      heatTier: 3
    },
    {
      key: "trace_finger",
      label: "Trace a finger on their arm",
      skill: "hands",
      baseDifficulty: 19,
      effects: { affection: 3 },
      heatTier: 3
    },
    {
      key: "confess_feelings",
      label: "Confess attraction",
      skill: "persuasion",
      baseDifficulty: 17,
      effects: { affection: 3, trust: 1 },
      heatTier: 3
    },
    {
      key: "talk_about_touch",
      label: "Ask how they feel about being touched",
      skill: "insight",
      baseDifficulty: 16,
      effects: { trust: 2 },
      heatTier: 3
    },
    {
      key: "suggest_alone",
      label: "Suggest going somewhere private",
      skill: "persuasion",
      baseDifficulty: 18,
      effects: { affection: 2 },
      heatTier: 3
    },
    {
      key: "touch_back",
      label: "Place a hand on their lower back",
      skill: "hands",
      baseDifficulty: 18,
      effects: { affection: 3 },
      heatTier: 3
    },
    {
      key: "make_promise",
      label: "Promise not to hurt them",
      skill: "willpower",
      baseDifficulty: 17,
      effects: { trust: 2 },
      heatTier: 3
    }
  ],
  4: [ // Intimate, romantic, dominant
    {
      key: "kiss",
      label: "Kiss them",
      skill: "mouth",
      baseDifficulty: 20,
      effects: { affection: 5 },
      heatTier: 4
    },
    {
      key: "bite_lip",
      label: "Bite your lip",
      skill: "performance",
      baseDifficulty: 19,
      effects: { affection: 3 },
      heatTier: 4
    },
    {
      key: "pull_closer",
      label: "Pull them closer",
      skill: "hands",
      baseDifficulty: 20,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "whisper",
      label: "Whisper into their ear",
      skill: "mouth",
      baseDifficulty: 19,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "ask_to_trust",
      label: "Ask them to trust you",
      skill: "persuasion",
      baseDifficulty: 21,
      effects: { trust: 3 },
      heatTier: 4
    },
    {
      key: "confess_lust",
      label: "Confess your desire",
      skill: "persuasion",
      baseDifficulty: 22,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "hand_on_hip",
      label: "Place a hand on their hip",
      skill: "hands",
      baseDifficulty: 21,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "slide_fingers",
      label: "Slide your fingers over theirs",
      skill: "hands",
      baseDifficulty: 20,
      effects: { affection: 3 },
      heatTier: 4
    },
    {
      key: "let_guard_down",
      label: "Let your guard down",
      skill: "willpower",
      baseDifficulty: 19,
      effects: { trust: 3 },
      heatTier: 4
    }
  ],
  5: [ // 🔞 Explicit, devotional, dominant/submissive
    {
      key: "submit",
      label: "Submit to their touch",
      skill: "willpower",
      baseDifficulty: 23,
      effects: { affection: 4 },
      heatTier: 5
    },
    {
      key: "bite_neck",
      label: "Bite their neck",
      skill: "mouth",
      baseDifficulty: 24,
      effects: { affection: 5 },
      heatTier: 5
    },
    {
      key: "worship",
      label: "Worship them softly",
      skill: "persuasion",
      baseDifficulty: 25,
      effects: { affection: 5, trust: 2 },
      heatTier: 5
    },
    {
      key: "dominant_command",
      label: "Command them to obey",
      skill: "intimidation",
      baseDifficulty: 26,
      effects: { trust: 2, affection: 3 },
      heatTier: 5
    },
    {
      key: "confess_fantasy",
      label: "Confess a fantasy",
      skill: "insight",
      baseDifficulty: 25,
      effects: { affection: 5 },
      heatTier: 5
    },
    {
      key: "pull_into_lap",
      label: "Pull them into your lap",
      skill: "hands",
      baseDifficulty: 26,
      effects: { affection: 5 },
      heatTier: 5
    },
    {
      key: "touch_thigh",
      label: "Touch their thigh",
      skill: "hands",
      baseDifficulty: 24,
      effects: { affection: 4 },
      heatTier: 5
    },
    {
      key: "look_down",
      label: "Look them over slowly",
      skill: "observation",
      baseDifficulty: 22,
      effects: { affection: 4 },
      heatTier: 5
    }
  ]
};
/* twine-user-script #50: "inclinations.js" */
/* ======================================================
   Inclination Library (Sexual Preferences / Kinks)
   ------------------------------------------------------
   These values are used to influence NSFW interactions,
   seduction-based fight actions, scene branching, and
   character compatibility. Future systems will allow 
   toggling content categories per player preference.
========================================================= */

// dev/js/data/inclinations.js
// Refactored to integrate sexual act tags directly for compatibility with NSFW preference logic

setup.Inclinations = {

  vanilla: {
    tags: ["safe", "basic"],
    acts: ["Kissing", "Cuddling", "EyeContact", "Oral_G", "Oral_R", "Vaginal_P"],
    soft: true,
    optional: true
  },

  praise: {
    tags: ["affirmation", "emotional"],
    acts: ["Praise_G", "DirtyTalk_G", "Dominate", "Kissing"],
    likes: ["being adored", "gentle domination"],
    optional: true
  },

  domination: {
    tags: ["dominant"],
    acts: ["Dominate", "Spank_G", "Choke_G", "Bondage_G", "HairPulling_G", "DirtyTalk_G", "OrgasmControl_G"],
    optional: true
  },

  submission: {
    tags: ["submissive"],
    acts: ["Submit", "Bondage_R", "Choke_R", "Spank_R", "HairPulling_R", "OrgasmControl_R"],
    optional: true
  },

  service: {
    tags: ["giving", "obedient"],
    acts: ["Oral_G", "Handjob_G", "Praise_G", "Cuddling", "Toys_Use", "Blindfold_G"],
    optional: true
  },

  exhibitionism: {
    tags: ["exposed", "thrill"],
    acts: ["Exhibition_Solo", "Exhibition_Sex", "Kissing", "FaceSit"],
    optional: true
  },

  voyeurism: {
    tags: ["watching", "observation"],
    acts: ["Voyeurism"],
    optional: true
  },

  roughplay: {
    tags: ["aggressive", "intense"],
    acts: ["Spank_G", "Choke_G", "HairPulling_G", "Bite_G", "Degrade_G"],
    optional: true
  },

  bondage: {
    tags: ["restraint", "control"],
    acts: ["Bondage_G", "Bondage_R", "Gag_Use", "Blindfold_R", "Blindfold_G"],
    optional: true
  },

  sensual: {
    tags: ["tender", "stimulating"],
    acts: ["Lick_Body", "NipplePlay_G", "NipplePlay_R", "Fingering_G", "Fingering_R", "BreastPlay_G", "BreastPlay_R"],
    optional: true
  },

  breeding: {
    tags: ["reproductive", "climax"],
    acts: ["Creampie", "Breeding_Kink", "Creampie_Preference"],
    optional: true
  },

  verbal: {
    tags: ["dirty talk", "expression"],
    acts: ["DirtyTalk_G", "DirtyTalk_R", "Praise_G", "Degrade_G", "Degrade_G"],
    optional: true
  },

  sensory: {
    tags: ["stimulus", "touch"],
    acts: ["Blindfold_R", "Blindfold_G", "WaxPlay"],
    optional: true
  },

  roleplay: {
    tags: ["imaginative", "character-based"],
    acts: ["Roleplay_Master", "Roleplay_Servant", "Roleplay_Teacher", "Roleplay_Stranger"],
    optional: true
  },

  riskplay: {
    tags: ["danger", "excitement"],
    acts: ["Risk_BeingCaught", "PowerImbalance"],
    optional: true
  }

};
/* twine-user-script #51: "motivations.js" */
/* ======================================================
   Motivation Library (Internal Drives / Narrative Goals)
   ------------------------------------------------------
   These define what makes an NPC "tick" and shape:
   - Personal quests
   - Loyalty and betrayal conditions
   - Behavioral patterns in and out of scenes
========================================================= */

setup.Motivations = {
    // Core Motivations
    justice: {
      tags: ["moral", "lawful"],
      notes: "Seeks fairness, hates corruption. May trigger vigilante behavior or formal quests."
    },
    revenge: {
      tags: ["vengeful", "emotional"],
      notes: "Drives actions based on past wrongs. Likely to spark intense personal quests."
    },
    power: {
      tags: ["ambition", "dominance"],
      notes: "Desires authority or superiority. Often manipulative or assertive."
    },
    knowledge: {
      tags: ["intellectual", "curious"],
      notes: "Seeks truth, secrets, arcane lore. May align with Scholar or Witchling archetypes."
    },
    survival: {
      tags: ["primal", "realist"],
      notes: "Wants to live above all. Can make pragmatic or cold decisions."
    },
    family: {
      tags: ["emotional", "relational"],
      notes: "Protective of kin or those they consider family. Likely to abandon duty to save them."
    },
    loyalty: {
      tags: ["duty", "bonded"],
      notes: "Values allegiances and service. Driven by oath, honor, or gratitude."
    },
    legacy: {
      tags: ["ambition", "mortal"],
      notes: "Wants to be remembered. Motivated by creation, influence, or children."
    },
  
    // Romantic / Intimate Motivations
    love: {
      tags: ["romantic", "emotional"],
      notes: "Seeks intimacy, connection. Will follow heart even at great cost."
    },
    lust: {
      tags: ["pleasure", "impulse"],
      notes: "Prioritizes desire, beauty, sex. May interfere with duty or logic."
    },
    thrill: {
      tags: ["risk", "chaotic"],
      notes: "Lives for danger, excitement. Motivated by unpredictability and adrenaline."
    },
  
    // Status-Based / Material
    wealth: {
      tags: ["greed", "material"],
      notes: "Motivated by money, luxuries, or gain. Can bribe, steal, or manipulate."
    },
    fame: {
      tags: ["recognition", "external"],
      notes: "Wants to be admired, known, or praised. May exaggerate deeds."
    },
    freedom: {
      tags: ["independence", "liberty"],
      notes: "Hates constraints. Resists authority and avoids entrapment."
    },
  
    // Kink-Aligned / Subtle Drives
    control: {
      tags: ["dominance", "power"],
      notes: "Wants to control others emotionally, socially, or sexually."
    },
    devotion: {
      tags: ["service", "loyalty"],
      notes: "Finds fulfillment in pleasing others. Can become obsessive."
    },
    shame: {
      tags: ["taboo", "emotional"],
      notes: "Defines self by guilt or desire for punishment. May seek degradation scenes."
    }
  };
  
/* twine-user-script #52: "npc_archetypes.js" */
setup.Archetypes = {
    "Warden": {
        tags: ["Guard", "Loyal", "Stoic"],
        statRanges: {
            strength: [6, 10],
            charisma: [1, 5],
            insight: [4, 7]
        },
        styles: ["Military", "Ironclad", "Minimalist"],
    },
    "Courtesan": {
        tags: ["Charmer", "Temptress", "Tactician"],
        statRanges: {
            charisma: [7, 10],
            agility: [4, 7],
            intelligence: [5, 8]
        },
        styles: ["Seductive", "Opulent", "Masked"]
    },
    "Witchling": {
        tags: ["Arcane", "Unsettling", "Reclusive"],
        statRanges: {
            intelligence: [8, 10],
            insight: [7, 10],
            toughness: [2, 5]
        },
        styles: ["Cloaked", "Ragged", "Unnatural"]
    }
};
/* twine-user-script #53: "npc_names.js" */
setup.NamePools = {
    human: {
        male: ["Joren", "Thalen", "Bryce", "Damas"],
        female: ["Lira", "Vaelyn", "Mira", "Seris"]
    },
    elf: {
        male: ["Thalor", "Caelith", "Aerendel"],
        female: ["Sylria", "Nimaris", "Vaelra"]
    },
    demon: {
        male: ["Khazar", "Velmuth", "Zereth"],
        female: ["Lilitha", "Zaria", "Nyx"]
    }
};
/* twine-user-script #54: "personality_traits.js" */
/* ======================================================
   Personality Trait Library (Core Behavioral / Emotional Traits)
   --------------------------------------------------------------
   These traits shape daily behavior, conversation dynamics,
   emotional response patterns, and flavor interactions.
========================================================= */

setup.PersonalityTraits = {
    optimistic: { conflicts: ["pessimistic"], tags: ["emotional"] },
    pessimistic: { conflicts: ["optimistic"], tags: ["emotional"] },
    stoic: { conflicts: ["expressive"], tags: ["emotional"] },
    expressive: { conflicts: ["stoic"], tags: ["emotional"] },
    cheerful: { tags: ["emotional"] },
    melancholic: { tags: ["emotional"] },
    cynical: { conflicts: ["idealistic"], tags: ["emotional"] },
    idealistic: { conflicts: ["cynical"], tags: ["emotional"] },
    empathic: { tags: ["emotional"] },
    detached: { conflicts: ["empathic"], tags: ["emotional"] },
  
    goofy: { conflicts: ["serious"], tags: ["social"] },
    serious: { conflicts: ["goofy"], tags: ["social"] },
    charismatic: { tags: ["social"] },
    awkward: { tags: ["social"] },
    introverted: { conflicts: ["extroverted"], tags: ["social"] },
    extroverted: { conflicts: ["introverted"], tags: ["social"] },
    polite: { conflicts: ["crude"], tags: ["social"] },
    crude: { conflicts: ["polite"], tags: ["social"] },
    jealous: { tags: ["emotional"] },
    insecure: { tags: ["emotional"] },
    confident: { tags: ["emotional"] },
    flirty: { tags: ["social"] },
    guarded: { conflicts: ["flirty"], tags: ["emotional"] },
    affectionate: { tags: ["emotional"] },
    ruthless: { conflicts: ["kind", "empathic"], tags: ["emotional"] },
    kind: { conflicts: ["ruthless"], tags: ["emotional"] },
    dominant: { conflicts: ["submissive"], tags: ["social"] },
    submissive: { conflicts: ["dominant"], tags: ["social"] },
    independent: { conflicts: ["clingy"], tags: ["emotional"] },
    clingy: { conflicts: ["independent"], tags: ["emotional"] },
  
    anxious: { conflicts: ["bold"], tags: ["emotional"] },
    bold: { conflicts: ["anxious"], tags: ["emotional"] },
    secretive: { tags: ["emotional"] },
    trusting: { tags: ["emotional"] },
    judgmental: { tags: ["emotional"] },
    curious: { tags: ["mental"] },
    routineOriented: { tags: ["quirk"] },
    chaotic: { tags: ["quirk"] },
    possessive: { tags: ["emotional"] },
    detachedRomantic: { tags: ["romantic"] },
    loveBombing: { tags: ["romantic"] },
  
    entitled: { conflicts: ["humble"], tags: ["class"] },
    humble: { conflicts: ["entitled"], tags: ["class"] },
    pious: { tags: ["moral"] },
    hedonistic: { tags: ["moral", "social"] },
    militant: { tags: ["social"] },
    scholar: { tags: ["intellectual"] },
    merchant: { tags: ["social"] }
  };
  
/* twine-user-script #55: "social_styles.js" */
/* ======================================================
   Social Style Library (Tone, Mannerisms, Social Presence)
   ------------------------------------------------------
   Affects how NPCs present themselves socially — their
   tone, word choice, mannerisms, and general vibe.
   Often blends with class, personality, or upbringing.
   Does NOT directly influence conversation mechanics.
========================================================= */

setup.SocialStyles = {
    warm: {
      tags: ["friendly", "open"],
      notes: "Speaks kindly, often smiles, tends to put others at ease."
    },
    cold: {
      tags: ["distant", "guarded"],
      notes: "Rarely emotive, hard to read, often blunt."
    },
    polite: {
      tags: ["formal", "measured"],
      notes: "Courteous and restrained, avoids vulgarity or informality."
    },
    crude: {
      tags: ["vulgar", "casual"],
      notes: "Swears, jokes off-color, generally relaxed in speech."
    },
    seductive: {
      tags: ["flirty", "charming"],
      notes: "Uses innuendo, body language, and tone to entice."
    },
    arrogant: {
      tags: ["haughty", "entitled"],
      notes: "Talks down to others, may use elevated or dismissive language."
    },
    humble: {
      tags: ["meek", "respectful"],
      notes: "Deferential, often puts themselves second, avoids spotlight."
    },
    theatrical: {
      tags: ["dramatic", "expressive"],
      notes: "Big hand gestures, vivid language, flair for storytelling."
    },
    stern: {
      tags: ["strict", "firm"],
      notes: "Controlled voice, serious tone, rarely jokes."
    },
    aloof: {
      tags: ["disengaged", "quiet"],
      notes: "Short answers, little emotion, easily distracted."
    },
    bubbly: {
      tags: ["energetic", "playful"],
      notes: "Talks fast, giggles, prone to tangents or excitement."
    },
    stoic: {
      tags: ["reserved", "emotionless"],
      notes: "Rarely shows emotion even under stress, speaks flatly."
    },
    theatrical: {
      tags: ["dramatic", "flamboyant"],
      notes: "Big emotions, expressive voice, sometimes over-the-top."
    },
    scholarly: {
      tags: ["academic", "precise"],
      notes: "Careful wording, references theory or history, avoids slang."
    },
    cunning: {
      tags: ["subtle", "manipulative"],
      notes: "May flatter or provoke to gain an edge, reads people quickly."
    }
  };
  
/* twine-user-script #56: "DataAuditor.js" */
setup.DataAuditor = {
    listUniqueValues(objectArray, property) {
      const values = objectArray.flatMap(item => {
        if (Array.isArray(item[property])) {
          return item[property].map(val => val.toLowerCase());
        } else if (item[property] !== undefined) {
          return [item[property].toLowerCase()];
        } else {
          return [];
        }
      });
      const uniqueValues = [...new Set(values)];
      console.log(`✅ Unique "${property}" values (${uniqueValues.length} total):`, uniqueValues.sort());
      return uniqueValues;
    },
  
    compareValues(listA, listB) {
      const lowerA = listA.map(val => val.toLowerCase());
      const lowerB = listB.map(val => val.toLowerCase());
      const missingFromB = lowerA.filter(val => !lowerB.includes(val));
      const missingFromA = lowerB.filter(val => !lowerA.includes(val));
      console.group("🧹 Data Comparison Results:");
      console.log("In A but missing from B:", missingFromB.length ? missingFromB : "None");
      console.log("In B but missing from A:", missingFromA.length ? missingFromA : "None");
      console.groupEnd();
    },
  
    auditMultipleArrays(arrays, property) {
      const merged = arrays.flat();
      return this.listUniqueValues(merged, property);
    },

    
  };
  window.audit = {
    prompts: {
      themes() {
        return setup.DataAuditor.listUniqueValues(setup.ConvoPrompts, "theme");
      },
      difficultyMods() {
        return setup.DataAuditor.listUniqueValues(setup.ConvoPrompts, "baseDifficultyMod");
      }
    },
    characters: {
      trustAndAffection() {
        const chars = State.variables.characters || {};
        console.group("🧡 Character Trust and Affection Levels:");
        Object.entries(chars).forEach(([id, char]) => {
          console.log(`${id}: Trust=${char.trust ?? 0} | Affection=${char.affection ?? 0}`);
        });
        console.groupEnd();
      }
    },
    
    tropes: {
      skills() {
        const allTropes = [
          ...setup.ConvoTropesByTier[1],
          ...setup.ConvoTropesByTier[2],
          ...setup.ConvoTropesByTier[3],
          ...setup.ConvoTropesByTier[4],
          ...setup.ConvoTropesByTier[5]
        ];
        return setup.DataAuditor.listUniqueValues(allTropes, "skill");
      },
      effects() {
        const allTropes = [].concat(
          ...Object.values(setup.ConvoTropesByTier)
        );
        const flatKeys = allTropes.flatMap(t => Object.keys(t.effects || {}));
        const unique = [...new Set(flatKeys)];
        console.log("Unique effect keys:", unique.sort());
        return unique;
      }
    },
  
    compare: {
      themesToTraits() {
        const themes = setup.DataAuditor.listUniqueValues(setup.ConvoPrompts, "theme");
        const allTraits = Object.values(State.variables.characters)
          .flatMap(c => c.traits || []);
        const traits = [...new Set(allTraits.map(t => t.toLowerCase()))];
        setup.DataAuditor.compareValues(themes, traits);
      }
    }
  };
  
/*
===========================================================
🧠 DataAuditor.js — Dev Cheatsheet
Quick reference for running audits and comparisons
===========================================================

✅ Quick Natural Language Macros:

audit.prompts.themes();            → List all unique prompt themes
audit.prompts.difficultyMods();     → List all prompt difficulty modifiers
audit.tropes.skills();              → List all skills used in tropes across all tiers
audit.tropes.effects();             → List all unique trust/affection effect keys
audit.compare.themesToTraits();     → Compare prompt themes vs NPC traits

-----------------------------------------------------------

✅ Print a live help menu anytime:
audit.help();

-----------------------------------------------------------

🧠 Run these in your browser's DevTools Console
after compiling your game with Tweego and loading index.html.

Pro Tip: You can suppress duplicate console returns by prefixing commands with 'void'.

Example:
void audit.prompts.themes();

===========================================================
*/

/* twine-user-script #57: "random-event.js" */
// repository: https://github.com/TweePower/twee-sugarcube-random-events

const debugLevel = 3; // max debug level

(function () {
    'use strict';

    /*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
var RandomEventAppExport;
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/ConstraintsVerificator.ts":
/*!***************************************!*\
  !*** ./src/ConstraintsVerificator.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ ConstraintsVerificator)\n/* harmony export */ });\n/* harmony import */ var _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./DebugLogCollector */ \"./src/DebugLogCollector.ts\");\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n\n\nclass ConstraintsVerificator {\n    constructor(sugarcubeFacade, tagsManager, randomEventStats) {\n        this.sugarcubeFacade = sugarcubeFacade;\n        this.tagsManager = tagsManager;\n        this.randomEventStats = randomEventStats;\n    }\n    verify(randomEvent, compiledTags, rewriteConfiguration) {\n        var _a, _b, _c;\n        let result = true;\n        let usedLimitationStrategyTags = [];\n        const debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        if (rewriteConfiguration.isValidateIsEnable === false) {\n            debugLogCollector.addLog(true, 'skip IsEnable verify', 2);\n        }\n        else {\n            const checkResult = this.verifyIsEnable((_a = rewriteConfiguration.isEnabled) !== null && _a !== void 0 ? _a : randomEvent.isEnabled);\n            result = checkResult.result;\n            debugLogCollector\n                .addLog(checkResult.result, `verify IsEnable using: ${rewriteConfiguration.isEnabled ? 'rewrite configuration' : 'passage metadata'}`, 2)\n                .increaseLevel()\n                .merge(checkResult.debugLogCollector)\n                .decreaseLevel();\n        }\n        if (result) {\n            if (rewriteConfiguration.isValidateFilter === false) {\n                debugLogCollector.addLog(true, 'skip filter verify', 2);\n            }\n            else {\n                const checkResult = this.verifyFilter((_b = rewriteConfiguration.filter) !== null && _b !== void 0 ? _b : randomEvent.filter);\n                result = checkResult.result;\n                debugLogCollector\n                    .addLog(checkResult.result, `verify filter using: ${rewriteConfiguration.filter ? 'rewrite configuration' : 'passage metadata'}`, 2)\n                    .increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n            }\n        }\n        if (result) {\n            let checkResult;\n            if (randomEvent._isLimitationStrategiesTagged) {\n                checkResult = this.verifyTaggedLimitationStrategy(randomEvent.passageName, randomEvent.limitationStrategies, compiledTags);\n            }\n            else {\n                checkResult = this.verifyNotTaggedLimitationStrategy(randomEvent.passageName, randomEvent.limitationStrategies, compiledTags);\n            }\n            result = checkResult.result;\n            debugLogCollector\n                .addLog(checkResult.result, `verify limitationStrategies using: 'passage metadata'`, 2)\n                .increaseLevel()\n                .merge(checkResult.debugLogCollector)\n                .decreaseLevel();\n            usedLimitationStrategyTags = checkResult.additionalData.usedLimitationStrategyTags;\n        }\n        if (result) {\n            if (rewriteConfiguration.isValidateThreshold === false) {\n                debugLogCollector.addLog(true, 'skip threshold verify', 2);\n            }\n            else {\n                const checkResult = this.verifyThreshold((_c = rewriteConfiguration.threshold) !== null && _c !== void 0 ? _c : randomEvent.threshold);\n                result = checkResult.result;\n                debugLogCollector\n                    .addLog(checkResult.result, `verify threshold using: ${rewriteConfiguration.threshold ? 'rewrite configuration' : 'passage metadata'}`, 2).increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n            }\n        }\n        return {\n            result,\n            debugLogCollector,\n            additionalData: {\n                usedLimitationStrategyTags\n            }\n        };\n    }\n    verifyIsEnable(isEnabled) {\n        const result = isEnabled;\n        return {\n            result,\n            debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(result, result ? 'event enabled' : 'event disabled', 3)\n        };\n    }\n    verifyFilter(filter) {\n        if (filter === true || filter === false) {\n            return {\n                result: filter,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(filter, `filter expression returns ${filter ? 'true' : 'false'}`, 3)\n            };\n        }\n        let result;\n        try {\n            result = this.sugarcubeFacade.runTeweeScript(filter);\n        }\n        catch (error) {\n            error.message = \"bad evaluation: \" + error.message;\n            throw error;\n        }\n        if (result !== true && result !== false) {\n            throw new Error(`invalid filter expression return type (expected: boolean: actual: ${typeof result})`);\n        }\n        return {\n            result,\n            debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(result, `filter expression returns ${result ? 'true' : 'false'}`, 3)\n        };\n    }\n    verifyTaggedLimitationStrategy(passageName, limitationStrategies, compiledTags) {\n        const debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        const usedLimitationStrategyTags = [];\n        let isSuccess = true;\n        if (limitationStrategies.length <= 0) {\n            return {\n                result: true,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"](),\n                additionalData: {\n                    usedLimitationStrategyTags: []\n                },\n            };\n        }\n        limitationStrategies.forEach(limitationStrategy => {\n            // skip all next if already found limitation which is not passed\n            if (isSuccess === false) {\n                return;\n            }\n            if (limitationStrategy.max <= 0) {\n                debugLogCollector.addLog(true, 'limitationStrategy max value <= 0', 3);\n                return;\n            }\n            if (limitationStrategy.tags.length > 0) {\n                const limitationStrategyTags = [...this.tagsManager.prepareTags(limitationStrategy.tags)];\n                // skip checking limitationStrategy when current compiled tags have not included `limitation.tags`\n                for (let i = 0; i < limitationStrategyTags.length; i++) {\n                    if (!compiledTags.includes(limitationStrategyTags[i])) {\n                        debugLogCollector\n                            .addLog(false, `tag '${limitationStrategyTags[i]}' not found in current tags`, 3)\n                            .increaseLevel()\n                            .increaseLevel()\n                            .addLog(null, `current tags   : ${compiledTags.join(', ')}`, 3)\n                            .addLog(null, `limitation tags: ${limitationStrategyTags.join(', ')}`, 3)\n                            .decreaseLevel()\n                            .decreaseLevel();\n                        return;\n                    }\n                }\n                const fullLimitationStrategyTags = [\n                    ...limitationStrategyTags,\n                    ...(limitationStrategy.isSeparate ? [passageName] : [])\n                ];\n                const fullLimitationStrategyTagsKey = this.tagsManager.convertTagsToStringKey(fullLimitationStrategyTags);\n                const actualFiredTagCount = this.randomEventStats.getTagRunCountActual(fullLimitationStrategyTagsKey);\n                if (actualFiredTagCount >= limitationStrategy.max) {\n                    isSuccess = false;\n                    debugLogCollector.addLog(false, `limitationStrategy with tags ['${limitationStrategyTags.join(', ')}'] have max value ${limitationStrategy.max} but already fired ${actualFiredTagCount} times`, 3);\n                    return;\n                }\n                else {\n                    usedLimitationStrategyTags.push(fullLimitationStrategyTags);\n                    debugLogCollector.addLog(true, `limitationStrategy with tags ['${limitationStrategyTags.join(', ')}'] have max value ${limitationStrategy.max} and already fired ${actualFiredTagCount} times`, 3);\n                }\n            }\n            else {\n                const actualFiredEventCount = this.randomEventStats.getPassageRunCountActual(passageName);\n                if (actualFiredEventCount >= limitationStrategy.max) {\n                    isSuccess = false;\n                    debugLogCollector.addLog(false, `limitationStrategy without tags have max value ${limitationStrategy.max} but already fired ${actualFiredEventCount} times`, 3);\n                    return;\n                }\n                else {\n                    debugLogCollector.addLog(true, `limitationStrategy without tags have max value ${limitationStrategy.max} and already fired ${actualFiredEventCount} times`, 3);\n                }\n            }\n        });\n        if (isSuccess && usedLimitationStrategyTags.length <= 0) {\n            isSuccess = false;\n            debugLogCollector.addLog(false, `not found any limitationStrategy where current tags cover all limitationStrategy tags (current tags: ${compiledTags.join(', ')}`, 3);\n        }\n        return {\n            result: isSuccess,\n            debugLogCollector,\n            additionalData: { usedLimitationStrategyTags }\n        };\n    }\n    verifyNotTaggedLimitationStrategy(passageName, limitationStrategies, compiledTags) {\n        const debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        const usedLimitationStrategyTags = [];\n        let isSuccess = true;\n        if (limitationStrategies.length <= 0) {\n            return {\n                result: true,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"](),\n                additionalData: {\n                    usedLimitationStrategyTags: []\n                },\n            };\n        }\n        limitationStrategies.forEach(limitationStrategy => {\n            if (limitationStrategy.max <= 0) {\n                debugLogCollector.addLog(true, 'limitationStrategy max value <= 0', 3);\n                return;\n            }\n            const actualFiredEventCount = this.randomEventStats.getPassageRunCountActual(passageName);\n            if (actualFiredEventCount >= limitationStrategy.max) {\n                isSuccess = false;\n                debugLogCollector.addLog(false, `random event have max value ${limitationStrategy.max} but already fired ${actualFiredEventCount} times`, 3);\n                return;\n            }\n            else {\n                debugLogCollector.addLog(true, `random event have max value ${limitationStrategy.max} and already fired ${actualFiredEventCount} times`, 3);\n            }\n        });\n        return {\n            result: isSuccess,\n            debugLogCollector,\n            additionalData: { usedLimitationStrategyTags }\n        };\n    }\n    verifyThreshold(threshold) {\n        let thresholdResult = 0;\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_1__.isNumber)(threshold)) {\n            try {\n                thresholdResult = this.sugarcubeFacade.runTeweeScript(threshold.toString());\n            }\n            catch (error) {\n                error.message = \"bad evaluation: \" + error.message;\n                throw error;\n            }\n        }\n        else {\n            thresholdResult = threshold;\n        }\n        if (thresholdResult >= 100) {\n            return {\n                result: true,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(true, 'threshold is equal to or greater than 100', 3)\n            };\n        }\n        const randomValue = Math.floor(Math.random() * 100);\n        if (randomValue > thresholdResult) {\n            return {\n                result: false,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(false, `random value is greater than threshold (random=${randomValue} > threshold=${thresholdResult})`, 3)\n            };\n        }\n        return {\n            result: true,\n            debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(true, 'threshold passed (random=' + randomValue + ' <= threshold=' + thresholdResult + ')', 3)\n        };\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/ConstraintsVerificator.ts?");

/***/ }),

/***/ "./src/DebugLogCollector.ts":
/*!**********************************!*\
  !*** ./src/DebugLogCollector.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ DebugLogCollector)\n/* harmony export */ });\nclass DebugLogCollector {\n    constructor(debugLevel = 0) {\n        this.debugLevel = debugLevel;\n        this.currentLevel = 0;\n        this.logs = [];\n        if (debugLevel !== 0 && debugLevel !== 1 && debugLevel !== 2 && debugLevel !== 3) {\n            throw new Error(\"Debug level should be 0, 1, 2 or 3\");\n        }\n    }\n    addLog(result, message, debugLevel, level) {\n        this.logs.push({\n            result: result,\n            message: message,\n            debugLevel: debugLevel,\n            level: level === undefined ? this.currentLevel : level,\n        });\n        return this;\n    }\n    merge(debugLogCollector) {\n        debugLogCollector.all().forEach(log => this.addLog(log.result, log.message, log.debugLevel, log.level + this.currentLevel));\n        return this;\n    }\n    increaseLevel() {\n        this.currentLevel++;\n        return this;\n    }\n    decreaseLevel() {\n        this.currentLevel--;\n        if (this.currentLevel < 0) {\n            this.currentLevel = 0;\n        }\n        return this;\n    }\n    get length() {\n        return this.logs.length;\n    }\n    all() {\n        return this.logs;\n    }\n    toString() {\n        return this.logs\n            .filter(log => log.debugLevel <= this.debugLevel)\n            .map(log => ('  '.repeat(log.level)) + (log.result === true ? '+ ' : (log.result === false ? '- ' : '')) + log.message)\n            .join(\"\\n\");\n    }\n    clear() {\n        this.currentLevel = 0;\n        this.logs = [];\n        return this;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/DebugLogCollector.ts?");

/***/ }),

/***/ "./src/Lock.ts":
/*!*********************!*\
  !*** ./src/Lock.ts ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ Lock)\n/* harmony export */ });\nclass Lock {\n    constructor() {\n        this.lockData = {\n            isLocked: false,\n            isForce: false,\n        };\n    }\n    acquire() {\n        if (this.lockData.isForce === false) {\n            this.lockData.isLocked = true;\n        }\n    }\n    release() {\n        if (this.lockData.isForce === false) {\n            this.lockData.isLocked = false;\n        }\n    }\n    forceAcquire() {\n        this.lockData.isLocked = true;\n        this.lockData.isForce = true;\n    }\n    forceRelease() {\n        this.lockData.isLocked = false;\n        this.lockData.isForce = false;\n    }\n    get isLocked() {\n        return this.lockData.isLocked;\n    }\n    get isForce() {\n        return this.lockData.isForce;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/Lock.ts?");

/***/ }),

/***/ "./src/RandomEventApp.ts":
/*!*******************************!*\
  !*** ./src/RandomEventApp.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RandomEventApp)\n/* harmony export */ });\n/* harmony import */ var _Lock__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Lock */ \"./src/Lock.ts\");\n/* harmony import */ var _DebugLogCollector__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./DebugLogCollector */ \"./src/DebugLogCollector.ts\");\n/* harmony import */ var _ConstraintsVerificator__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./ConstraintsVerificator */ \"./src/ConstraintsVerificator.ts\");\n/* harmony import */ var _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./enum/GroupTypeEnum */ \"./src/enum/GroupTypeEnum.ts\");\n/* harmony import */ var _TagsManager__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./TagsManager */ \"./src/TagsManager.ts\");\n/* harmony import */ var _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./error/PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n/* harmony import */ var _processors_RandomEventPassageMetadataProcessor__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./processors/RandomEventPassageMetadataProcessor */ \"./src/processors/RandomEventPassageMetadataProcessor.ts\");\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n/* harmony import */ var _macros_index__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./macros/index */ \"./src/macros/index.ts\");\n/* harmony import */ var _facade_SugarcubeFacade__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./facade/SugarcubeFacade */ \"./src/facade/SugarcubeFacade.ts\");\n/* harmony import */ var _RandomEventStats__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./RandomEventStats */ \"./src/RandomEventStats.ts\");\n\n\n\n\n\n\n\n\n\n\n\nclass RandomEventApp {\n    constructor(passageMetadataApp, debugLevel = 0) {\n        this.passageMetadataApp = passageMetadataApp;\n        this._passagesByTagIndex = {};\n        this._passagesByGroupIndex = {};\n        this.acquireLock = () => this.lock.acquire();\n        this.releaseLock = () => this.lock.release();\n        this.forceAcquireLock = () => this.lock.forceAcquire();\n        this.forceReleaseLock = () => this.lock.forceRelease();\n        this.has = (passageName) => this.passageMetadataApp.has(passageName);\n        this.find = (passageName) => this.passageMetadataApp.find(passageName);\n        this.sugarcubeFacade = new _facade_SugarcubeFacade__WEBPACK_IMPORTED_MODULE_9__[\"default\"]();\n        this.tagsManager = new _TagsManager__WEBPACK_IMPORTED_MODULE_4__[\"default\"](this.sugarcubeFacade);\n        this.lock = new _Lock__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        this.debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_1__[\"default\"](debugLevel);\n        this.randomEventStats = new _RandomEventStats__WEBPACK_IMPORTED_MODULE_10__[\"default\"](passageMetadataApp, this.tagsManager);\n        this.constraintsVerificator = new _ConstraintsVerificator__WEBPACK_IMPORTED_MODULE_2__[\"default\"](this.sugarcubeFacade, this.tagsManager, this.randomEventStats);\n        const randomEventPassageMetadataProcessor = new _processors_RandomEventPassageMetadataProcessor__WEBPACK_IMPORTED_MODULE_6__[\"default\"]();\n        passageMetadataApp.onBeforeAddMetadata.add((passageMetadataObject) => {\n            try {\n                randomEventPassageMetadataProcessor.process(passageMetadataObject);\n            }\n            catch (error) {\n                if (error instanceof _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_5__[\"default\"]) {\n                    let message = error.message;\n                    if (error.path.length > 0) {\n                        message += ' ';\n                        error.path.forEach((path, index) => {\n                            if (index === 0 || path[0] === '[') {\n                                message += path;\n                            }\n                            else {\n                                message += '.' + path;\n                            }\n                        });\n                    }\n                    let scopeMessage = [];\n                    if (error.expected !== null) {\n                        scopeMessage.push('expected ' + error.expected);\n                    }\n                    if (error.actual !== null) {\n                        scopeMessage.push('actual ' + error.actual);\n                    }\n                    throw new Error(`${message}${scopeMessage.join.length > 0 ? ` (${scopeMessage.join(', ')})` : ''}`);\n                }\n                throw error;\n            }\n        });\n        passageMetadataApp.onAfterAddMetadata.add((passageMetadata) => {\n            const data = passageMetadata.data;\n            if (data.tags.length > 0) {\n                data.tags.forEach((tag) => {\n                    if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isTweeScript)(tag)) {\n                        return;\n                    }\n                    if (this._passagesByTagIndex[tag] === undefined) {\n                        this._passagesByTagIndex[tag] = [];\n                    }\n                    this._passagesByTagIndex[tag].push(data.passageName);\n                });\n            }\n            if (data.groups.length > 0) {\n                data.groups.forEach((group) => {\n                    if (this._passagesByGroupIndex[group.name] === undefined) {\n                        this._passagesByGroupIndex[group.name] = [];\n                    }\n                    this._passagesByGroupIndex[group.name].push(data.passageName);\n                });\n            }\n        });\n        passageMetadataApp.onBeforeRestore.add((state) => {\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                const data = state[passageName];\n                if (data.e !== undefined) {\n                    data.isEnabled = data.e;\n                    delete data.e;\n                }\n            });\n        });\n        passageMetadataApp.onBeforeStore.add((state) => {\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                const data = state[passageName];\n                if (data.isEnabled !== undefined) {\n                    data.e = data.isEnabled;\n                    delete data.isEnabled;\n                }\n            });\n        });\n        (0,_macros_index__WEBPACK_IMPORTED_MODULE_8__[\"default\"])(this, passageMetadataApp, this.sugarcubeFacade);\n    }\n    get isLocked() {\n        return this.lock.isLocked;\n    }\n    ;\n    get isForceLocked() {\n        return this.lock.isForce;\n    }\n    ;\n    enable(passageName) {\n        if (!this.passageMetadataApp.has(passageName)) {\n            if (!this.sugarcubeFacade.hasPassage(passageName)) {\n                throw new Error(`passage \"${passageName}\" does not exist`);\n            }\n            if (this.passageMetadataApp.mode === 'byTag') {\n                throw new Error(`passage \"${passageName}\" exist but without tag \"${this.passageMetadataApp.modeParams.filterTag}\"`);\n            }\n            else {\n                throw new Error(`passage \"${passageName}\" does'n contain metadata`);\n            }\n        }\n        this.passageMetadataApp.get(passageName).setValue('isEnabled', true);\n        this.passageMetadataApp.storeState();\n    }\n    disable(passageName) {\n        if (!this.passageMetadataApp.has(passageName)) {\n            if (!this.sugarcubeFacade.hasPassage(passageName)) {\n                throw new Error(`passage \"${passageName}\" does not exist`);\n            }\n            if (this.passageMetadataApp.mode === 'byTag') {\n                throw new Error(`passage \"${passageName}\" exist but without tag \"${this.passageMetadataApp.modeParams.filterTag}\"`);\n            }\n            else {\n                throw new Error(`passage \"${passageName}\" does'n contain metadata`);\n            }\n        }\n        this.passageMetadataApp.get(passageName).setValue('isEnabled', false);\n        this.passageMetadataApp.storeState();\n    }\n    enableByTag(tag) {\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isArray)(this._passagesByTagIndex[tag])) {\n            this._passagesByTagIndex[tag].forEach((passageName) => {\n                const passageMetadata = this.passageMetadataApp.get(passageName);\n                passageMetadata.setValue('isEnabled', true);\n            });\n            this.passageMetadataApp.storeState();\n        }\n    }\n    disableByTag(tag) {\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isArray)(this._passagesByTagIndex[tag])) {\n            this._passagesByTagIndex[tag].forEach((passageName) => {\n                const passageMetadata = this.passageMetadataApp.get(passageName);\n                passageMetadata.setValue('isEnabled', false);\n            });\n            this.passageMetadataApp.storeState();\n        }\n    }\n    runRandomEvent(passageName, rewriteConfiguration) {\n        this.debugLogCollector.clear();\n        rewriteConfiguration = {\n            ...{\n                isValidateIsEnable: true,\n                isEnabled: null,\n                isValidateFilter: true,\n                filter: null,\n                isValidateLimitationStrategy: true,\n                limitationStrategy: null,\n                isValidateThreshold: true,\n                threshold: null,\n            },\n            ...(rewriteConfiguration !== null && rewriteConfiguration !== void 0 ? rewriteConfiguration : {})\n        };\n        if (!this.passageMetadataApp.has(passageName)) {\n            if (!this.sugarcubeFacade.hasPassage(passageName)) {\n                throw new Error(`passage \"${passageName}\" does not exist`);\n            }\n            throw new Error(`passage \"${passageName}\" exist but without tag \"${this.passageMetadataApp.modeParams.filterTag}\"`);\n        }\n        const passageMetadata = (this.passageMetadataApp.get(passageName)).data;\n        this.debugLogCollector.addLog(null, `Start random event ${passageMetadata.passageName}`, 1);\n        this.debugLogCollector.increaseLevel();\n        let result = true;\n        if (this.lock.isLocked) {\n            result = false;\n            this.debugLogCollector.addLog(null, `Skip because lock already acquired`, 1);\n            return {\n                isSuccess: result,\n                debugLogCollector: this.debugLogCollector,\n                passageMetadata,\n                usedTags: []\n            };\n        }\n        try {\n            const compiledTags = this.tagsManager.prepareTags(passageMetadata.tags);\n            const checkResult = this.constraintsVerificator.verify(passageMetadata, compiledTags, rewriteConfiguration);\n            this.debugLogCollector\n                .addLog(null, `Verify:`, 2)\n                .increaseLevel()\n                .merge(checkResult.debugLogCollector)\n                .decreaseLevel();\n            return {\n                isSuccess: checkResult.result,\n                debugLogCollector: this.debugLogCollector,\n                passageMetadata,\n                usedTags: passageMetadata._isLimitationStrategiesTagged ? checkResult.additionalData.usedLimitationStrategyTags : [compiledTags]\n            };\n        }\n        catch (error) {\n            // TODO add data to error\n            throw error;\n        }\n    }\n    runGroup(groupName, groupThreshold, rewriteConfiguration) {\n        this.debugLogCollector.clear();\n        rewriteConfiguration = {\n            ...{\n                isValidateIsEnable: true,\n                isEnable: null,\n                isValidateFilter: true,\n                filter: null,\n                isValidateLimitationStrategy: true,\n                limitationStrategy: null,\n                isValidateThreshold: true,\n                threshold: null,\n            },\n            ...(rewriteConfiguration !== null && rewriteConfiguration !== void 0 ? rewriteConfiguration : {})\n        };\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isArray)(this._passagesByGroupIndex[groupName])) {\n            throw new Error(`group \"${groupName}\" does not exist`);\n        }\n        this.debugLogCollector.addLog(null, `Start group ${groupName}`, 1);\n        this.debugLogCollector.increaseLevel();\n        let result = true;\n        if (this.lock.isLocked) {\n            result = false;\n            this.debugLogCollector.addLog(null, `Skip because lock already acquired`, 1);\n            return {\n                isSuccess: result,\n                debugLogCollector: this.debugLogCollector,\n            };\n        }\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isNumber)(groupThreshold) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isString)(groupThreshold)) {\n            try {\n                const checkResult = this.constraintsVerificator.verifyThreshold(groupThreshold);\n                result = checkResult.result;\n                this.debugLogCollector\n                    .addLog(null, 'Verify group threshold', 2)\n                    .increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n            }\n            catch (error) {\n                // TODO add data to error\n                throw error;\n            }\n            if (result === false) {\n                return {\n                    isSuccess: result,\n                    debugLogCollector: this.debugLogCollector,\n                };\n            }\n            rewriteConfiguration.isValidateThreshold = false;\n        }\n        this.debugLogCollector\n            .increaseLevel()\n            .addLog(null, 'Verify random events in group', 1)\n            .increaseLevel();\n        let totalWeight = 0;\n        const sucessRandomEventsResults = [];\n        for (let groupIndex = 0; groupIndex < this._passagesByGroupIndex[groupName].length; groupIndex++) {\n            const passageName = this._passagesByGroupIndex[groupName][groupIndex];\n            const passageMetadata = (this.passageMetadataApp.get(passageName)).data;\n            const group = passageMetadata.groups[passageMetadata._groupByNameIndex[groupName]];\n            this.debugLogCollector\n                .addLog(null, `Random event ${passageMetadata.passageName} with weight ${group.weight}`, 1)\n                .increaseLevel();\n            try {\n                const compiledTags = this.tagsManager.prepareTags(passageMetadata.tags);\n                const checkResult = this.constraintsVerificator.verify(passageMetadata, compiledTags, rewriteConfiguration);\n                const result = checkResult.result;\n                this.debugLogCollector\n                    .addLog(null, `Verify`, 2)\n                    .increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n                if (result) {\n                    totalWeight += group.weight;\n                    sucessRandomEventsResults.push({\n                        isSuccess: result,\n                        passageMetadata: passageMetadata,\n                        usedTags: passageMetadata._isLimitationStrategiesTagged ? checkResult.additionalData.usedLimitationStrategyTags : [compiledTags],\n                        group: group,\n                    });\n                }\n            }\n            catch (error) {\n                // TODO add data to error\n                throw error;\n            }\n            this.debugLogCollector.decreaseLevel();\n        }\n        if (sucessRandomEventsResults.length <= 0) {\n            result = false;\n            this.debugLogCollector.addLog(false, `not found any suitable random events in group`, 2);\n            return {\n                isSuccess: result,\n                debugLogCollector: this.debugLogCollector,\n            };\n        }\n        let winnerRandomEventResult = null;\n        if (sucessRandomEventsResults[0].group.type === _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_3__.GroupTypeEnum.Sequential) {\n            this.debugLogCollector\n                .addLog(true, `Find winner event`, 2)\n                .increaseLevel();\n            const sucessRandomEventsSequentialResults = sucessRandomEventsResults.filter((sucessRandomEventsResult) => {\n                return this.randomEventStats.getPassageRunCountHistory(sucessRandomEventsResult.passageMetadata.passageName) < sucessRandomEventsResult.group.sequentialCount;\n            });\n            this.debugLogCollector.addLog(true, `sequential search found ${sucessRandomEventsSequentialResults.length} siutable events`, 3);\n            if (sucessRandomEventsSequentialResults.length > 0) {\n                winnerRandomEventResult = sucessRandomEventsSequentialResults.sort((a, b) => {\n                    return a.group.sequentialIndex - b.group.sequentialIndex;\n                })[0];\n                this.debugLogCollector.addLog(true, `winner random event: ${winnerRandomEventResult.passageMetadata.passageName}`, 3);\n                return {\n                    isSuccess: result,\n                    debugLogCollector: this.debugLogCollector,\n                    passageMetadata: winnerRandomEventResult.passageMetadata,\n                    usedTags: winnerRandomEventResult.usedTags,\n                    group: winnerRandomEventResult.group,\n                };\n            }\n        }\n        let winnerWeight = Math.floor(Math.random() * totalWeight);\n        this.debugLogCollector.addLog(true, `total weight: ${totalWeight} | wittner weight: ${winnerWeight}`, 3);\n        for (let i = 0; i < sucessRandomEventsResults.length; i++) {\n            winnerWeight -= sucessRandomEventsResults[i].group.weight;\n            if (winnerWeight <= 0) {\n                winnerRandomEventResult = sucessRandomEventsResults[i];\n                break;\n            }\n        }\n        this.debugLogCollector.addLog(true, `winner random event: ${winnerRandomEventResult.passageMetadata.passageName}`, 3);\n        return {\n            isSuccess: result,\n            debugLogCollector: this.debugLogCollector,\n            passageMetadata: winnerRandomEventResult.passageMetadata,\n            usedTags: winnerRandomEventResult.usedTags,\n            group: winnerRandomEventResult.group,\n        };\n    }\n    incrementRunCounters(passageName, usedTags) {\n        this.randomEventStats.incrementPassageRunCount(passageName);\n        this.randomEventStats.incrementTagsRunCount(passageName, usedTags);\n        this.passageMetadataApp.storeState();\n    }\n    resetRunCounterByPassage(passageName) {\n        this.randomEventStats.resetPassageRunCount(passageName);\n        this.passageMetadataApp.storeState();\n    }\n    resetRunCounterByTag(tag) {\n        this.randomEventStats.resetTagsRunCount(tag);\n        this.passageMetadataApp.storeState();\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/RandomEventApp.ts?");

/***/ }),

/***/ "./src/RandomEventStats.ts":
/*!*********************************!*\
  !*** ./src/RandomEventStats.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RandomEventStats)\n/* harmony export */ });\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n\nclass RandomEventStats {\n    constructor(passageMetadataApp, tagsManager) {\n        this.passageMetadataApp = passageMetadataApp;\n        this.tagsManager = tagsManager;\n        this.passagesRunCountHistory = {};\n        this.passagesRunCountActual = {};\n        this.tagsRunCountHistory = {};\n        this.tagsRunCountActual = {};\n        this._passagesByTagIndex = {};\n        this._tagsStringKeysByPassageAndTagIndex = {};\n        this._tagsStringKeysIndex = {};\n        passageMetadataApp.onAfterAddMetadata.add((passageMetadata) => {\n            const data = passageMetadata.data;\n            data._stringTags.forEach((tag) => {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isString)(tag) || tag.length <= 0) {\n                    return;\n                }\n                if (this._passagesByTagIndex[tag] === undefined) {\n                    this._passagesByTagIndex[tag] = [];\n                }\n                this._passagesByTagIndex[tag].push(data.passageName);\n            });\n            data.limitationStrategies.forEach((limitationStrategy) => {\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(limitationStrategy.tags) && limitationStrategy.tags.length > 0) {\n                    const tags = limitationStrategy.tags;\n                    if (limitationStrategy.isSeparate === true) {\n                        tags.push(data.passageName);\n                    }\n                    const tagsStringKey = this.tagsManager.convertTagsToStringKey(tags);\n                    if (this._tagsStringKeysIndex[tagsStringKey] === undefined) {\n                        this._tagsStringKeysIndex[tagsStringKey] = [];\n                    }\n                    if (limitationStrategy.isSeparate === true) {\n                        tags.push(data.passageName);\n                    }\n                    limitationStrategy.tags.forEach((tag) => {\n                        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isString)(tag) || tag.length <= 0) {\n                            return;\n                        }\n                        if (this._passagesByTagIndex[tag] === undefined) {\n                            this._passagesByTagIndex[tag] = [];\n                        }\n                        if (!this._passagesByTagIndex[tag].includes(passageMetadata.passageName)) {\n                            this._passagesByTagIndex[tag].push(passageMetadata.passageName);\n                        }\n                        if (this._tagsStringKeysByPassageAndTagIndex[tag] === undefined) {\n                            this._tagsStringKeysByPassageAndTagIndex[tag] = {};\n                        }\n                        if (this._tagsStringKeysByPassageAndTagIndex[tag][data.passageName] === undefined) {\n                            this._tagsStringKeysByPassageAndTagIndex[tag][data.passageName] = [];\n                        }\n                        this._tagsStringKeysByPassageAndTagIndex[tag][data.passageName].push(tagsStringKey);\n                        if (!this._tagsStringKeysIndex[tagsStringKey].includes(tag)) {\n                            this._tagsStringKeysIndex[tagsStringKey].push(tag);\n                        }\n                    });\n                }\n            });\n        });\n        passageMetadataApp.onBeforeRestore.add((state) => {\n            console.log(state);\n            const tagsIndex = {};\n            if (state.__tags !== undefined) {\n                state.__tags.forEach((tag, index) => {\n                    tagsIndex[index] = tag;\n                });\n                delete state.__tags;\n            }\n            this.passagesRunCountHistory = {};\n            this.passagesRunCountActual = {};\n            this.tagsRunCountHistory = {};\n            this.tagsRunCountActual = {};\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                var _a, _b;\n                const data = state[passageName];\n                if (data._runCountActual === undefined) {\n                    data._runCountActual = 0;\n                }\n                if (data._runCountHistory === undefined) {\n                    data._runCountHistory = 0;\n                }\n                if (data._runCountByTagsActual === undefined) {\n                    data._runCountByTagsActual = {};\n                }\n                if (data._runCountByTagsHistory === undefined) {\n                    data._runCountByTagsHistory = {};\n                }\n                if (data.s !== undefined) {\n                    data._runCountActual = (_a = data.s.a) !== null && _a !== void 0 ? _a : data._runCountActual;\n                    data._runCountHistory = (_b = data.s.h) !== null && _b !== void 0 ? _b : data._runCountHistory;\n                    if (data.s.t !== undefined) {\n                        const tagsIndexes = Object.keys(data.s.t).map((index) => parseInt(index));\n                        tagsIndexes.forEach((tagIndex) => {\n                            if (data.s.t[tagIndex].a !== undefined) {\n                                data._runCountByTagsActual[tagsIndex[tagIndex]] = data.s.t[tagIndex].a;\n                            }\n                            if (data.s.t[tagIndex].h !== undefined) {\n                                data._runCountByTagsHistory[tagsIndex[tagIndex]] = data.s.t[tagIndex].h;\n                            }\n                        });\n                    }\n                    delete data.s;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountActual)) {\n                    this.passagesRunCountActual[passageName] = data._runCountActual;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountHistory)) {\n                    this.passagesRunCountHistory[passageName] = data._runCountHistory;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsActual)) {\n                    const tags = Object.keys(data._runCountByTagsActual);\n                    tags.forEach((tag) => {\n                        if (this.tagsRunCountActual[tag] === undefined) {\n                            this.tagsRunCountActual[tag] = 0;\n                        }\n                        this.tagsRunCountActual[tag] += data._runCountByTagsActual[tag];\n                    });\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsHistory)) {\n                    const tags = Object.keys(data._runCountByTagsHistory);\n                    tags.forEach((tag) => {\n                        if (this.tagsRunCountHistory[tag] === undefined) {\n                            this.tagsRunCountHistory[tag] = 0;\n                        }\n                        this.tagsRunCountHistory[tag] += data._runCountByTagsHistory[tag];\n                    });\n                }\n            });\n        });\n        passageMetadataApp.onBeforeStore.add((state) => {\n            let tagsIndexLength = 0;\n            const tagsIndex = {};\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                const data = state[passageName];\n                const optimizedStats = {};\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountActual)) {\n                    optimizedStats.a = data._runCountActual;\n                    delete data._runCountActual;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountHistory)) {\n                    optimizedStats.h = data._runCountHistory;\n                    delete data._runCountHistory;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsActual)) {\n                    const tags = Object.keys(data._runCountByTagsActual);\n                    if (tags.length > 0) {\n                        optimizedStats.t = {};\n                        tags.forEach((tag) => {\n                            if (tagsIndex[tag] === undefined) {\n                                tagsIndex[tag] = tagsIndexLength;\n                                tagsIndexLength++;\n                            }\n                            if (optimizedStats.t[tagsIndex[tag]] === undefined) {\n                                optimizedStats.t[tagsIndex[tag]] = {};\n                            }\n                            optimizedStats.t[tagsIndex[tag]].a = data._runCountByTagsActual[tag];\n                        });\n                    }\n                    delete data._runCountByTagsActual;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsHistory)) {\n                    const tags = Object.keys(data._runCountByTagsHistory);\n                    if (tags.length > 0) {\n                        if (optimizedStats.t === undefined) {\n                            optimizedStats.t = {};\n                        }\n                        tags.forEach((tag) => {\n                            if (tagsIndex[tag] === undefined) {\n                                tagsIndex[tag] = tagsIndexLength;\n                                tagsIndexLength++;\n                            }\n                            if (optimizedStats.t[tagsIndex[tag]] === undefined) {\n                                optimizedStats.t[tagsIndex[tag]] = {};\n                            }\n                            optimizedStats.t[tagsIndex[tag]].h = data._runCountByTagsHistory[tag];\n                        });\n                    }\n                    delete data._runCountByTagsHistory;\n                }\n                if (Object.keys(optimizedStats).length > 0) {\n                    data.s = optimizedStats;\n                }\n            });\n            if (tagsIndexLength > 0) {\n                state.__tags = Object.keys(tagsIndex);\n            }\n        });\n    }\n    incrementPassageRunCount(passageName, count = 1, isStoreImmediately = false) {\n        const passageMetadata = this.passageMetadataApp.get(passageName);\n        const runCountHistory = passageMetadata.data._runCountHistory + count;\n        const runCountActual = passageMetadata.data._runCountActual + count;\n        passageMetadata.setValue('_runCountHistory', runCountHistory);\n        passageMetadata.setValue('_runCountActual', runCountActual);\n        this.passagesRunCountHistory[passageName] = runCountHistory;\n        this.passagesRunCountActual[passageName] = runCountActual;\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    incrementTagsRunCount(passageName, tagsList, count = 1, isStoreImmediately = false) {\n        const passageMetadata = this.passageMetadataApp.get(passageName);\n        const currentRunCountByTagsHistory = passageMetadata.data._runCountByTagsHistory;\n        const currentRunCountByTagsActual = passageMetadata.data._runCountByTagsActual;\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(tagsList) && tagsList.length > 0) {\n            tagsList.forEach(tags => {\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(tags) && tags.length > 0) {\n                    const uniqueTags = [...tags].filter((tag, index, array) => array.indexOf(tag) === index);\n                    const tagsStringKey = this.tagsManager.convertTagsToStringKey(tags);\n                    uniqueTags.forEach(tag => {\n                        if (tag !== '') {\n                            currentRunCountByTagsHistory[tag] = currentRunCountByTagsHistory[tag] === undefined ? count : currentRunCountByTagsHistory[tag] + count;\n                            currentRunCountByTagsActual[tag] = currentRunCountByTagsActual[tag] === undefined ? count : currentRunCountByTagsActual[tag] + count;\n                            this.tagsRunCountHistory[tag] = this.tagsRunCountHistory[tag] === undefined ? count : this.tagsRunCountHistory[tag] + count;\n                            this.tagsRunCountActual[tag] = this.tagsRunCountActual[tag] === undefined ? count : this.tagsRunCountActual[tag] + count;\n                        }\n                    });\n                    if (tagsStringKey !== '') {\n                        currentRunCountByTagsHistory[tagsStringKey] = currentRunCountByTagsHistory[tagsStringKey] === undefined ? count : currentRunCountByTagsHistory[tagsStringKey] + count;\n                        currentRunCountByTagsActual[tagsStringKey] = currentRunCountByTagsActual[tagsStringKey] === undefined ? count : currentRunCountByTagsActual[tagsStringKey] + count;\n                        this.tagsRunCountHistory[tagsStringKey] = this.tagsRunCountHistory[tagsStringKey] === undefined ? count : this.tagsRunCountHistory[tagsStringKey] + count;\n                        this.tagsRunCountActual[tagsStringKey] = this.tagsRunCountActual[tagsStringKey] === undefined ? count : this.tagsRunCountActual[tagsStringKey] + count;\n                    }\n                }\n            });\n        }\n        passageMetadata.setValue('_runCountByTagsHistory', currentRunCountByTagsHistory);\n        passageMetadata.setValue('_runCountByTagsActual', currentRunCountByTagsActual);\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    resetPassageRunCount(passageName, isStoreImmediately = false) {\n        const passageMetadata = this.passageMetadataApp.get(passageName);\n        passageMetadata.setValue('_runCountActual', 0);\n        this.passagesRunCountActual[passageName] = 0;\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    resetTagsRunCount(tags, isStoreImmediately = false) {\n        if (!Array.isArray(tags)) {\n            tags = [tags];\n        }\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(tags)) {\n            tags.forEach((tag) => {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isString)(tag)) {\n                    throw new Error('Tag shouldb be string');\n                }\n                if (this.tagsRunCountActual[tag] !== undefined) {\n                    delete this.tagsRunCountActual[tag];\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(this._passagesByTagIndex[tag])) {\n                    this._passagesByTagIndex[tag].forEach((passageName) => {\n                        const passageMetadata = this.passageMetadataApp.get(passageName);\n                        passageMetadata.setValue('_runCountActual', 0);\n                        delete this.passagesRunCountActual[passageName];\n                        const runCountByTagsActual = { ...passageMetadata.data._runCountByTagsActual };\n                        delete runCountByTagsActual[tag];\n                        passageMetadata.setValue('_runCountByTagsActual', runCountByTagsActual);\n                    });\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(this._tagsStringKeysByPassageAndTagIndex[tag])) {\n                    const passageNames = Object.keys(this._tagsStringKeysByPassageAndTagIndex[tag]);\n                    passageNames.forEach((passageName) => {\n                        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(this._tagsStringKeysByPassageAndTagIndex[tag][passageName])) {\n                            const passageMetadata = this.passageMetadataApp.get(passageName);\n                            this._tagsStringKeysByPassageAndTagIndex[tag][passageName].forEach((tagsStringKey) => {\n                                const runCountByTagsActual = { ...passageMetadata.data._runCountByTagsActual };\n                                if (runCountByTagsActual[tagsStringKey] !== undefined) {\n                                    if (this._tagsStringKeysIndex[tagsStringKey] !== undefined) {\n                                        this._tagsStringKeysIndex[tagsStringKey].forEach((tagFromTagsStringKey) => {\n                                            if (runCountByTagsActual[tagFromTagsStringKey] !== undefined) {\n                                                delete runCountByTagsActual[tagFromTagsStringKey];\n                                            }\n                                            if (this.tagsRunCountActual[tagFromTagsStringKey] !== undefined) {\n                                                delete this.tagsRunCountActual[tagFromTagsStringKey];\n                                            }\n                                        });\n                                    }\n                                    delete runCountByTagsActual[tagsStringKey];\n                                }\n                                passageMetadata.setValue('_runCountByTagsActual', runCountByTagsActual);\n                                if (this.tagsRunCountActual[tagsStringKey] !== undefined) {\n                                    delete this.tagsRunCountActual[tagsStringKey];\n                                }\n                            });\n                        }\n                    });\n                }\n            });\n        }\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    getPassageRunCountActual(passageName) {\n        var _a;\n        return (_a = this.passagesRunCountActual[passageName]) !== null && _a !== void 0 ? _a : 0;\n    }\n    getPassageRunCountHistory(passageName) {\n        var _a;\n        return (_a = this.passagesRunCountHistory[passageName]) !== null && _a !== void 0 ? _a : 0;\n    }\n    getTagRunCountActual(tag) {\n        var _a;\n        return (_a = this.tagsRunCountActual[tag]) !== null && _a !== void 0 ? _a : 0;\n    }\n    getTagRunCountHistory(tag) {\n        var _a;\n        return (_a = this.tagsRunCountHistory[tag]) !== null && _a !== void 0 ? _a : 0;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/RandomEventStats.ts?");

/***/ }),

/***/ "./src/TagsManager.ts":
/*!****************************!*\
  !*** ./src/TagsManager.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ TagsManager)\n/* harmony export */ });\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n\nclass TagsManager {\n    constructor(sugarcubeFacade) {\n        this.sugarcubeFacade = sugarcubeFacade;\n    }\n    prepareTags(tags) {\n        return tags.map((tag) => {\n            if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isTweeScript)(tag)) {\n                return tag;\n            }\n            else {\n                try {\n                    return this.sugarcubeFacade.runTeweeScript(tag).trim().replace(' ', '__');\n                }\n                catch (error) {\n                    throw new Error(\"Invalid random event scripted tag: \" + tag);\n                }\n            }\n        }).sort();\n    }\n    convertTagsToStringKey(tags) {\n        return this.prepareTags(tags).join('_');\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/TagsManager.ts?");

/***/ }),

/***/ "./src/enum/GroupTypeEnum.ts":
/*!***********************************!*\
  !*** ./src/enum/GroupTypeEnum.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   GroupTypeEnum: () => (/* binding */ GroupTypeEnum)\n/* harmony export */ });\nvar GroupTypeEnum;\n(function (GroupTypeEnum) {\n    GroupTypeEnum[\"Random\"] = \"random\";\n    GroupTypeEnum[\"Sequential\"] = \"sequential\";\n})(GroupTypeEnum || (GroupTypeEnum = {}));\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/enum/GroupTypeEnum.ts?");

/***/ }),

/***/ "./src/enum/Type.ts":
/*!**************************!*\
  !*** ./src/enum/Type.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   TypeEnum: () => (/* binding */ TypeEnum)\n/* harmony export */ });\nvar TypeEnum;\n(function (TypeEnum) {\n    TypeEnum[\"Embedded\"] = \"embedded\";\n    TypeEnum[\"Goto\"] = \"goto\";\n})(TypeEnum || (TypeEnum = {}));\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/enum/Type.ts?");

/***/ }),

/***/ "./src/error/InvalidPassageMetadataValue.ts":
/*!**************************************************!*\
  !*** ./src/error/InvalidPassageMetadataValue.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ InvalidPassageMetadataValue)\n/* harmony export */ });\n/* harmony import */ var _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n\nclass InvalidPassageMetadataValue extends _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"] {\n    constructor(passageName = null, path = [], expected = null, actual = null) {\n        super('Invalid value', passageName, path, expected, actual);\n        Object.setPrototypeOf(this, _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"].prototype);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/InvalidPassageMetadataValue.ts?");

/***/ }),

/***/ "./src/error/InvalidPassageMetadataValueType.ts":
/*!******************************************************!*\
  !*** ./src/error/InvalidPassageMetadataValueType.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ InvalidPassageMetadataValueType)\n/* harmony export */ });\n/* harmony import */ var _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n\nclass InvalidPassageMetadataValueType extends _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"] {\n    constructor(passageName = null, path = [], expected = null, actual = null) {\n        super('Invalid type', passageName, path, expected, actual);\n        Object.setPrototypeOf(this, _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"].prototype);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/InvalidPassageMetadataValueType.ts?");

/***/ }),

/***/ "./src/error/PassageMetadataValidationError.ts":
/*!*****************************************************!*\
  !*** ./src/error/PassageMetadataValidationError.ts ***!
  \*****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ PassageMetadataValidationError)\n/* harmony export */ });\nclass PassageMetadataValidationError extends Error {\n    constructor(message, passageName = null, path = [], expected = null, actual = null) {\n        super(message);\n        this._path = [];\n        this._expected = null;\n        this._actual = null;\n        this._passageName = passageName;\n        this._path = path;\n        this._expected = expected;\n        this._actual = actual;\n        Object.setPrototypeOf(this, PassageMetadataValidationError.prototype);\n    }\n    static fromPreviousError(previousError, passageName = null, path = []) {\n        path = [\n            ...path,\n            ...(previousError instanceof PassageMetadataValidationError) ? previousError.path : []\n        ];\n        passageName = passageName !== null ? passageName : (previousError instanceof PassageMetadataValidationError) ? previousError.passageName : null;\n        const error = new PassageMetadataValidationError(previousError.message, passageName, previousError instanceof PassageMetadataValidationError ? previousError.expected : null, previousError instanceof PassageMetadataValidationError ? previousError.actual : null);\n        error.stack = previousError.stack;\n        return error;\n    }\n    get passageName() {\n        return this._passageName;\n    }\n    get path() {\n        return this._path;\n    }\n    get expected() {\n        return this._expected;\n    }\n    get actual() {\n        return this._actual;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/PassageMetadataValidationError.ts?");

/***/ }),

/***/ "./src/error/RequiredPassageMetadataValue.ts":
/*!***************************************************!*\
  !*** ./src/error/RequiredPassageMetadataValue.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RequiredPassageMetadataValue)\n/* harmony export */ });\n/* harmony import */ var _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n\nclass RequiredPassageMetadataValue extends _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"] {\n    constructor(condition, passageName = null, path = [], expected = null, actual = null) {\n        if (condition === null) {\n            super('Valie is required', passageName, path, expected, actual);\n        }\n        else {\n            super('Valie is required when ' + condition, passageName, path, expected, actual);\n        }\n        Object.setPrototypeOf(this, _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"].prototype);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/RequiredPassageMetadataValue.ts?");

/***/ }),

/***/ "./src/facade/SugarcubeFacade.ts":
/*!***************************************!*\
  !*** ./src/facade/SugarcubeFacade.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ SugarcubeFacade)\n/* harmony export */ });\nclass SugarcubeFacade {\n    getAllPassages() {\n        return Story.lookup();\n    }\n    runTeweeScript(expression) {\n        return Scripting.evalJavaScript(Scripting.parse(expression));\n    }\n    getCurrentPassage() {\n        return passage();\n    }\n    hasPassage(passageName) {\n        return Story.has(passageName);\n    }\n    getVariable(name) {\n        return State.variables[name];\n    }\n    saveVariable(name, value) {\n        State.variables[name] = value;\n    }\n    addMacros(name, options) {\n        Macro.add(name, options);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/facade/SugarcubeFacade.ts?");

/***/ }),

/***/ "./src/macros/index.ts":
/*!*****************************!*\
  !*** ./src/macros/index.ts ***!
  \*****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((randomEventApp, passageMetadataApp, sugarcubeFacade) => {\n    sugarcubeFacade.addMacros('REEnable', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                randomEventApp.enable(randomEventPassageName);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later\n    sugarcubeFacade.addMacros('REEnableByTag', {\n        handler: function () {\n            if (this.args.length !== 1) {\n                return this.error('Need to pass just 1 tag');\n            }\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event tag should be a string value');\n            }\n            try {\n                randomEventApp.enableByTag(this.args[0]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('REDisable', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                randomEventApp.disable(randomEventPassageName);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later\n    sugarcubeFacade.addMacros('REDisableByTag', {\n        handler: function () {\n            if (this.args.length !== 1) {\n                return this.error('Need to pass just 1 tag');\n            }\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event tag should be a string value');\n            }\n            try {\n                randomEventApp.disableByTag(this.args[0]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('REReset', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                randomEventApp.resetRunCounterByPassage(randomEventPassageName);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later\n    sugarcubeFacade.addMacros('REResetByTag', {\n        handler: function () {\n            if (this.args.length !== 1) {\n                return this.error('Need to pass just 1 tag');\n            }\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event tag should be a string value');\n            }\n            try {\n                randomEventApp.resetRunCounterByTag(this.args[0]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('RE', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                // TODO: maybe need to add more rewrite widget arguments\n                var result = randomEventApp.runRandomEvent(randomEventPassageName, {\n                    threshold: this.args[1]\n                });\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n            if (Config.debug) {\n                var debugLog = '';\n                if (result.debugLogCollector.debugLevel > 0) {\n                    debugLog = result.debugLogCollector.toString();\n                }\n                this.debugView.name = 'RE \"' + result.passageMetadata.passageName + '\"';\n                this.debugView.title = debugLog;\n                this.debugView.modes({\n                    nonvoid: true,\n                    hidden: false,\n                    invalid: !result.isSuccess\n                });\n                if (result.debugLogCollector.debugLevel > 0) {\n                    console.log(debugLog);\n                }\n            }\n            // TODO remove this\n            if (result.debugLogCollector.debugLevel > 0) {\n                var debugLog = '';\n                debugLog += result.debugLogCollector.toString();\n                console.log(debugLog);\n            }\n            if (result.isSuccess) {\n                randomEventApp.incrementRunCounters(result.passageMetadata.passageName, result.usedTags);\n                if (result.passageMetadata.type === 'embedded') {\n                    var $el = jQuery(this.output);\n                    $el.wiki(Story.get(result.passageMetadata.passageName).processText());\n                }\n                else {\n                    randomEventApp.acquireLock();\n                    setTimeout(function () { Engine.play(result.passageMetadata.passageName, true), Engine.minDomActionDelay; });\n                }\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('REGroup', {\n        handler: function () {\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event group name should be a string value');\n            }\n            var groupName = this.args[0];\n            try {\n                // TODO: maybe need to add more arguments\n                var result = randomEventApp.runGroup(groupName, this.args[1]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n            if (Config.debug) {\n                var debugLog = 'REGroup \"' + groupName + '\"';\n                if (result.debugLogCollector.debugLevel > 0) {\n                    debugLog = result.debugLogCollector.toString();\n                }\n                this.debugView.name = 'REGroup \"' + groupName + '\"';\n                this.debugView.title = debugLog;\n                this.debugView.modes({\n                    nonvoid: true,\n                    hidden: false,\n                    invalid: !result.isSuccess\n                });\n                if (result.debugLogCollector.debugLevel > 0) {\n                    console.log(debugLog);\n                }\n            }\n            // TODO remove this\n            if (result.debugLogCollector.debugLevel > 0) {\n                var debugLog = '';\n                debugLog += result.debugLogCollector.toString();\n                console.log(debugLog);\n            }\n            if (result.isSuccess) {\n                randomEventApp.incrementRunCounters(result.passageMetadata.passageName, result.usedTags);\n                if (result.passageMetadata.type === 'embedded') {\n                    var $el = jQuery(this.output);\n                    $el.wiki(Story.get(result.passageMetadata.passageName).processText());\n                }\n                else {\n                    randomEventApp.acquireLock();\n                    setTimeout(function () { Engine.play(result.passageMetadata.passageName, true), Engine.minDomActionDelay; });\n                }\n            }\n        },\n    });\n});\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/macros/index.ts?");

/***/ }),

/***/ "./src/processors/RandomEventPassageMetadataProcessor.ts":
/*!***************************************************************!*\
  !*** ./src/processors/RandomEventPassageMetadataProcessor.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RandomEventPassageMetadataProcessor)\n/* harmony export */ });\n/* harmony import */ var _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../error/InvalidPassageMetadataValueType */ \"./src/error/InvalidPassageMetadataValueType.ts\");\n/* harmony import */ var _error_InvalidPassageMetadataValue__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../error/InvalidPassageMetadataValue */ \"./src/error/InvalidPassageMetadataValue.ts\");\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n/* harmony import */ var _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../error/PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n/* harmony import */ var _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../enum/GroupTypeEnum */ \"./src/enum/GroupTypeEnum.ts\");\n/* harmony import */ var _error_RequiredPassageMetadataValue__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../error/RequiredPassageMetadataValue */ \"./src/error/RequiredPassageMetadataValue.ts\");\n/* harmony import */ var _enum_Type__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../enum/Type */ \"./src/enum/Type.ts\");\n\n\n\n\n\n\n\nclass RandomEventPassageMetadataProcessor {\n    // validate, normalize, enrich and build indexes for random event metadata\n    process(passageMetadataObject) {\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject)) {\n            // we shouldn't be here, passage metadata previously checked in PassageMetadataCollector, I added that check just in case\n            throw new Error(`Invalid passage metadata type (expected JSON object, actual ${typeof passageMetadataObject})`);\n        }\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.passageName)) {\n            // we shouldn't be here, passage name is always a string, I added that check just in case\n            throw new Error(`Invalid passage name type (expected string, actual ${typeof passageMetadataObject.passageName})`);\n        }\n        passageMetadataObject._isLimitationStrategiesTagged = false;\n        passageMetadataObject._groupByNameIndex = {};\n        passageMetadataObject._stringTags = [];\n        passageMetadataObject._runCountHistory = 0;\n        passageMetadataObject._runCountActual = 0;\n        passageMetadataObject._runCountByTagsHistory = {};\n        passageMetadataObject._runCountByTagsActual = {};\n        this.processIsEnabled(passageMetadataObject);\n        this.processGroups(passageMetadataObject);\n        this.processFilter(passageMetadataObject);\n        this.processType(passageMetadataObject);\n        this.processThreshold(passageMetadataObject);\n        this.processTags(passageMetadataObject);\n        this.processLimitationStrategies(passageMetadataObject);\n    }\n    processIsEnabled(passageMetadataObject) {\n        if (passageMetadataObject.isEnabled === undefined || passageMetadataObject.isEnabled === null) {\n            passageMetadataObject.isEnabled = true;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isBoolean)(passageMetadataObject.isEnabled)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'isEnabled'], 'boolean', typeof passageMetadataObject.isEnabled);\n        }\n    }\n    processGroups(passageMetadataObject) {\n        if (passageMetadataObject.groups === undefined || passageMetadataObject.groups === null) {\n            passageMetadataObject.groups = [];\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.groups) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.groups)) {\n            if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.groups)) {\n                passageMetadataObject.groups = [passageMetadataObject.groups];\n            }\n            for (let index = 0; index < passageMetadataObject.groups.length; index++) {\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups[index])) {\n                    passageMetadataObject.groups[index] = {\n                        name: passageMetadataObject.groups[index],\n                        weight: 10,\n                        type: _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random,\n                        sequentialIndex: null,\n                        sequentialCount: null,\n                    };\n                }\n                else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.groups[index])) {\n                    if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups[index].name)) {\n                        throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'name'], 'string', typeof passageMetadataObject.groups[index].name);\n                    }\n                    if (passageMetadataObject.groups[index].weight === undefined || passageMetadataObject.groups[index].weight === null) {\n                        passageMetadataObject.groups[index].weight = 10;\n                    }\n                    else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.groups[index].weight)) {\n                        throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'weight'], 'integer', typeof passageMetadataObject.groups[index].weight);\n                    }\n                    if (passageMetadataObject.groups[index].type === undefined || passageMetadataObject.groups[index].type === null) {\n                        passageMetadataObject.groups[index].type = _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random;\n                    }\n                    else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups[index].type)) {\n                        throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'type'], 'string', typeof passageMetadataObject.groups[index].type);\n                    }\n                    else if (passageMetadataObject.groups[index].type !== _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random && passageMetadataObject.groups[index].type !== _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential) {\n                        throw new _error_InvalidPassageMetadataValue__WEBPACK_IMPORTED_MODULE_1__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'type'], `\"${_enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random}\" or \"${_enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential}\"`, passageMetadataObject.groups[index].type);\n                    }\n                    if (passageMetadataObject.groups[index].type === _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential) {\n                        if (passageMetadataObject.groups[index].sequentialIndex === undefined) {\n                            throw new _error_RequiredPassageMetadataValue__WEBPACK_IMPORTED_MODULE_5__[\"default\"](`groupMetadata.type = \"${_enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential}\"`, passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'sequentialIndex']);\n                        }\n                        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.groups[index].sequentialIndex)) {\n                            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'sequentialIndex'], 'integer', typeof passageMetadataObject.groups[index].sequentialIndex);\n                        }\n                        if (passageMetadataObject.groups[index].sequentialCount === undefined || passageMetadataObject.groups[index].sequentialCount === null) {\n                            passageMetadataObject.groups[index].sequentialCount = 1;\n                        }\n                        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.groups[index].sequentialCount)) {\n                            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'sequentialCount'], 'integer', typeof passageMetadataObject.groups[index].sequentialCount);\n                        }\n                    }\n                }\n                passageMetadataObject._groupByNameIndex[passageMetadataObject.groups[index].name] = index;\n            }\n        }\n        else {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups'], 'string, object or array of strings or objects', typeof passageMetadataObject.groups);\n        }\n    }\n    processFilter(passageMetadataObject) {\n        if (passageMetadataObject.filter === undefined || passageMetadataObject.filter === null) {\n            passageMetadataObject.filter = true;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.filter) && !(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isBoolean)(passageMetadataObject.filter)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'filter'], 'string or boolean', typeof passageMetadataObject.filter);\n        }\n    }\n    processType(passageMetadataObject) {\n        if (passageMetadataObject.type === undefined || passageMetadataObject.type === null) {\n            passageMetadataObject.type = _enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Embedded;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.type)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'type'], 'string', typeof passageMetadataObject.type);\n        }\n        else if (passageMetadataObject.type !== _enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Embedded && passageMetadataObject.type !== _enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Goto) {\n            throw new _error_InvalidPassageMetadataValue__WEBPACK_IMPORTED_MODULE_1__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'type'], `\"${_enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Embedded}\" or \"${_enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Goto}\"`, passageMetadataObject.type);\n        }\n    }\n    processThreshold(passageMetadataObject) {\n        if (passageMetadataObject.threshold === undefined || passageMetadataObject.threshold === null) {\n            passageMetadataObject.threshold = 100;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isNumber)(passageMetadataObject.threshold) && !(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.threshold)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'threshold'], 'integer or string', typeof passageMetadataObject.threshold);\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isNumber)(passageMetadataObject.threshold)) {\n            if (passageMetadataObject.threshold < 0) {\n                throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should equal or greater than 0', passageMetadataObject.passageName, ['PassageMetadata', 'threshold']);\n            }\n            else if (passageMetadataObject.threshold > 100) {\n                throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should equal or less than 100', passageMetadataObject.passageName, ['PassageMetadata', 'threshold']);\n            }\n        }\n    }\n    processTags(passageMetadataObject) {\n        if (passageMetadataObject.tags === undefined || passageMetadataObject.tags === null) {\n            passageMetadataObject.tags = [];\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.tags) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.tags)) {\n            if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.tags)) {\n                passageMetadataObject.tags = [passageMetadataObject.tags];\n            }\n            for (let index = 0; index < passageMetadataObject.tags.length; index++) {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.tags[index])) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'tags', index], 'string', typeof passageMetadataObject.tags[index]);\n                }\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isTweeScript)(passageMetadataObject.tags[index])) {\n                    passageMetadataObject._stringTags.push(passageMetadataObject.tags[index]);\n                }\n            }\n        }\n    }\n    processLimitationStrategies(passageMetadataObject) {\n        if (passageMetadataObject.limitationStrategies === undefined || passageMetadataObject.limitationStrategies === null) {\n            passageMetadataObject.limitationStrategies = [];\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.limitationStrategies) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.limitationStrategies)) {\n            if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.limitationStrategies)) {\n                passageMetadataObject.limitationStrategies = [passageMetadataObject.limitationStrategies];\n            }\n            for (let index = 0; index < passageMetadataObject.limitationStrategies.length; index++) {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.limitationStrategies[index])) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index], 'object', typeof passageMetadataObject.limitationStrategies[index]);\n                }\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.limitationStrategies[index].max)) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'max'], 'integer', typeof passageMetadataObject.limitationStrategies[index].max);\n                }\n                if (passageMetadataObject.limitationStrategies[index].max < 0) {\n                    throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should equal or greater than 0', passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'max'], null, passageMetadataObject.limitationStrategies[index].max);\n                }\n                if (passageMetadataObject.limitationStrategies[index].isSeparate === undefined || passageMetadataObject.limitationStrategies[index].isSeparate === null) {\n                    passageMetadataObject.limitationStrategies[index].isSeparate = false;\n                }\n                else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isBoolean)(passageMetadataObject.limitationStrategies[index].isSeparate)) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'isSeparate'], 'boolean', typeof passageMetadataObject.limitationStrategies[index].isSeparate);\n                }\n                if (passageMetadataObject.limitationStrategies[index].tags === undefined || passageMetadataObject.limitationStrategies[index].tags === null) {\n                    passageMetadataObject.limitationStrategies[index].tags = [];\n                }\n                else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.limitationStrategies[index].tags) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.limitationStrategies[index].tags)) {\n                    if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.limitationStrategies[index].tags)) {\n                        passageMetadataObject.limitationStrategies[index].tags = [passageMetadataObject.limitationStrategies[index].tags];\n                    }\n                    for (let tagindex = 0; tagindex < passageMetadataObject.limitationStrategies[index].tags.length; tagindex++) {\n                        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.limitationStrategies[index].tags[tagindex])) {\n                            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'tags', tagindex], 'string', typeof passageMetadataObject.limitationStrategies[index].tags[tagindex]);\n                        }\n                        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isTweeScript)(passageMetadataObject.limitationStrategies[index].tags[tagindex])) {\n                            throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should not contain twee scripts', passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'tags', tagindex], 'string', typeof passageMetadataObject.limitationStrategies[index].tags[tagindex]);\n                        }\n                    }\n                }\n                if (passageMetadataObject.limitationStrategies[index].tags.length > 0) {\n                    passageMetadataObject.limitationStrategies[index]._isTagged = true;\n                    passageMetadataObject._isLimitationStrategiesTagged = true;\n                }\n                else {\n                    passageMetadataObject.limitationStrategies[index]._isTagged = false;\n                }\n            }\n        }\n        else {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies'], 'object or array', typeof passageMetadataObject.limitationStrategies);\n        }\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/processors/RandomEventPassageMetadataProcessor.ts?");

/***/ }),

/***/ "./src/tools/TypeChecker.ts":
/*!**********************************!*\
  !*** ./src/tools/TypeChecker.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   isArray: () => (/* binding */ isArray),\n/* harmony export */   isBoolean: () => (/* binding */ isBoolean),\n/* harmony export */   isFloat: () => (/* binding */ isFloat),\n/* harmony export */   isInteger: () => (/* binding */ isInteger),\n/* harmony export */   isNumber: () => (/* binding */ isNumber),\n/* harmony export */   isObject: () => (/* binding */ isObject),\n/* harmony export */   isString: () => (/* binding */ isString),\n/* harmony export */   isStringFloat: () => (/* binding */ isStringFloat),\n/* harmony export */   isStringInteger: () => (/* binding */ isStringInteger),\n/* harmony export */   isStringNumber: () => (/* binding */ isStringNumber),\n/* harmony export */   isTweeScript: () => (/* binding */ isTweeScript)\n/* harmony export */ });\nfunction isString(variable) {\n    return typeof variable === 'string' || variable instanceof String;\n}\nfunction isBoolean(variable) {\n    return typeof variable == \"boolean\" || variable instanceof Boolean;\n}\nfunction isArray(variable) {\n    return Object.prototype.toString.call(variable) === '[object Array]';\n}\nfunction isInteger(variable) {\n    return isNumber(variable) && variable % 1 === 0;\n}\nfunction isFloat(variable) {\n    return isNumber(variable) && variable % 1 !== 0;\n}\nfunction isNumber(variable) {\n    return typeof variable === 'number' && !isNaN(variable);\n}\nfunction isStringInteger(variable) {\n    return isString(variable) && !isNaN(variable) && isInteger(parseFloat(variable));\n}\nfunction isStringFloat(variable) {\n    return isString(variable) && !isNaN(variable) && isFloat(parseFloat(variable));\n}\nfunction isStringNumber(variable) {\n    return isString(variable) && !isNaN(variable) && isNumber(parseFloat(variable));\n}\nfunction isObject(variable) {\n    return typeof variable === 'object' && !Array.isArray(variable) && variable !== null;\n}\nfunction isTweeScript(variable) {\n    return isString(variable) && !(/^\\w+[\\w_\\- ]+$/.test(variable));\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/tools/TypeChecker.ts?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./src/RandomEventApp.ts");
/******/ 	RandomEventAppExport = __webpack_exports__;
/******/ 	
/******/ })()
;
    var RandomEventApp = RandomEventAppExport.default;

    function initialize() {
        var randomEventApp = new RandomEventApp(
            window.passageMetadataApp,
            debugLevel,
        );

        $(document).on(':passageend', function() {
            randomEventApp.releaseLock();
        });

        Config.navigation.override = (destinationPassage) => {
            if (randomEventApp.isLocked && !randomEventApp.has(destinationPassage)) {
                // if random event fired in <<button>> or <<link>>, return previous passage to normal history forward work
                return realCurrentPassage ?? passage();
            }

            return destinationPassage;
        };

        window.randomEventApp = randomEventApp;
    }

    window.addEventListener('passage-metadata-app-initialized', () => {
        initialize();
    });
    if (window.passageMetadataApp !== undefined) {
        initialize();
    }
}());
</script><tw-passagedata pid="1" name="SexScene" tags="" position="100,100" size="100,100">&lt;&lt;StartSexSceneLayout&gt;&gt;




&lt;&lt;run setup.renderSexSceneActions()&gt;&gt;</tw-passagedata><tw-passagedata pid="2" name="Adda_ThisPlaceIsYours" tags="widget" position="225,100" size="100,100">&lt;&lt;widget &quot;Adda_ThisPlaceIsYours&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;This place... it&#39;s all yours?&lt;&lt;/speech&gt;&gt;

  Adda lets out a breath, not quite a sigh—more like a release of tension she hadn&#39;t noticed she was holding. Her gaze sweeps slowly across the parlor as if seeing it for the first time in a while.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;It is. Every velvet curtain, every loose floorboard, every soul that walks through that door... I&#39;ve had a hand in it all.&lt;&lt;/speech&gt;&gt;

  She trails her fingers across the back of the chair beside her, the tips brushing the velvet like she&#39;s testing it for secrets. In the distance, laughter flutters from behind a curtain, followed by the muted clink of glass.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;When I took over this place, it was crumbling. In debt, in spirit, and in reputation. But I don&#39;t give up on things just because they&#39;re broken.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $addaMentionedTakeover = true&gt;&gt;

  She turns back to you, voice quieter now—more intimate.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I tore out the rot. Laid new bones. And I stitched it back together with silk, sweat, and no small amount of blood.&lt;&lt;/speech&gt;&gt;

  She smiles. Not a selfish smile, but one filled with unmistakable pride.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Now the city doesn&#39;t just know it... it respects it. Noctail&#39;s not just a place. It&#39;s a promise. One I intend to keep.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="3" name="Adda_HostsCare" tags="widget" position="350,100" size="100,100">&lt;&lt;widget &quot;Adda_HostsCare&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Your hosts really seem to care about you.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s expression softens—not in weakness, but in memory. She glances toward a group of them laughing quietly in a corner, her eyes flicking across each face like she&#39;s counting blessings.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;They do. And not because they&#39;re told to. It&#39;s... earned. Like anything worth having.&lt;&lt;/speech&gt;&gt;

  She folds her arms, the weight of her gaze returning to you.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I care about them. Every one of them. Not because it&#39;s good business—but because they deserve to be seen, protected... valued.&lt;&lt;/speech&gt;&gt;

  A deep rumble of thunder presses against the building&#39;s bones. Somewhere above, a window rattles gently in its frame. Adda doesn&#39;t flinch.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;This house doesn&#39;t run on coin or charm alone, Jaylie. It runs on trust. On knowing someone&#39;s got your back, even when the storm gets close.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="4" name="Adda_Different" tags="widget" position="475,100" size="100,100">&lt;&lt;widget &quot;Adda_Different&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;The others here—they smile, they charm, but with you it&#39;s different. They *listen.* Like they&#39;re waiting for your lead.&lt;&lt;/speech&gt;&gt;

  Adda smiles faintly, her eyes still sweeping the room before settling on you.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;They know I won&#39;t ask anything of them I wouldn&#39;t do myself. That earns you more than loyalty—it earns you weight.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You carry it well. There&#39;s a steadiness to you. Like… no matter what&#39;s happening out here, you&#39;ve already seen worse and lived through it.&lt;&lt;/speech&gt;&gt;

  Adda chuckles low in her throat, the sound warm but edged in memory.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Most who come into this line of work burn hot. Big fire, quick fade. They live fast, charm fast, fall fast. And the world wouldn&#39;t give two shits for their ashes.&lt;&lt;/speech&gt;&gt;

  Her gaze lingers on one of the hosts across the room—someone young, laughing a little too loudly.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I learned early that smoldering lasts longer. Still heat. Still flame, but you just… have to be more patient.&lt;&lt;/speech&gt;&gt;

  A soft rumble rolls through the building—distant thunder shifting the air, rattling the stemware behind the bar. Neither of you flinch.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And now you&#39;re the fire everyone gathers around.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s lips curl into a knowing smile.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Maybe. These men and women know how cold it gets when the fire goes out. I just do my best to make sure that doesn&#39;t happen.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="5" name="Adda_StartMinigame" tags="widget" position="600,100" size="100,100">&lt;&lt;widget &quot;Adda_StartMinigame&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Mind if I ask you a few real questions? I&#39;d like to know more about you.&lt;&lt;/speech&gt;&gt;

  Adda tilts her head, one brow lifting with quiet amusement.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;That depends—are you asking to understand me, or just hoping to catch me off guard?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Guess you&#39;ll have to find out.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s smirk softens. She nods once.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Alright then. Ask away.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;adda&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="6" name="Adda_OriginStory" tags="widget" position="725,100" size="100,100">&lt;&lt;widget &quot;Adda_OriginStory&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You mentioned taking this place over… mind if I ask you more about how that happened?&lt;&lt;/speech&gt;&gt;

  Adda&#39;s expression shifts slightly — not softer, but heavier. She leans her weight onto one hip, arms folding under her chest.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;It&#39;s not short. And it&#39;s not sweet. But it&#39;s mine. If you&#39;re really curious, I&#39;d be glad to share it with you.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;set $addaMentionedOrigin = true&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;adda&quot; &quot;NoctailOrigin&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="7" name="Adda_CommandPresence" tags="widget" position="850,100" size="100,100">&lt;&lt;widget &quot;Adda_CommandPresence&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;People seem to listen when you speak.&lt;&lt;/speech&gt;&gt;

  Adda lifts her chin slightly, a half-smile playing at her lips. Her eyes track a pair of patrons chuckling a little too loudly in the far corner.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;They listen because I don&#39;t waste words. And because they know I see everything that happens under this roof.&lt;&lt;/speech&gt;&gt;

  As if on cue, Bert slides past with a tray balanced flawlessly on one hand, delivering drinks with silent precision. Adda watches him for a moment, her gaze softening with approval.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;See that? I never once had to tell Bert what this place demands. He just understood. People like him... they make my job easier.&lt;&lt;/speech&gt;&gt;

  Her voice lowers, inviting you into a more intimate tone.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;But others... others needed to be taught. Taught to listen. Taught to respect. And sometimes, taught what happens when they don&#39;t.&lt;&lt;/speech&gt;&gt;

  You&#39;re not sure if she&#39;s talking about staff, guests, or someone else entirely. But there&#39;s a weight to her words that lands heavy, even in the warmth of the parlor.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You make it look effortless.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Effortless is always the result of effort well hidden, dear.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="8" name="Adda_OrderDrink" tags="widget" position="975,100" size="100,100">&lt;&lt;widget &quot;Adda_OrderDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could you help me get a drink?&lt;&lt;/speech&gt;&gt;

  Adda gives you a measured look, as if weighing what sort of drink might suit you… or perhaps what message she wants it to send.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Well of course, dear. You should have asked sooner. Bert—&lt;&lt;/speech&gt;&gt;

  She lifts two fingers, and without needing to raise her voice, catches his attention across the room. He nods once before turning to his station behind the bar.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Something full-bodied, dark at the center, with a kiss of spice. Just sweet enough to surprise you… and strong enough to be remembered in the morning.&lt;&lt;/speech&gt;&gt;

  A few moments later, Bert returns, fluid and precise in every motion, holding a cut-crystal glass that gleams like a gem in the low light.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;One *Velvet Verdict*, as requested.&lt;&lt;/speech&gt;&gt;

  The scent rises to meet you even before you lift it: smoke, black cherry, citrus oil, and something faintly floral—like crushed violets beneath warm stone.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Sip it slow. It should teach you something new about yourself with every sip.&lt;&lt;/speech&gt;&gt;

  You raise the glass, fingers brushing the beveled edge, and take a slow drink.

  It hits in waves—first the sweetness, like burnt sugar and ripe fruit, then a curl of warmth that lingers at the back of your throat. Beneath it all, a whisper of something earthy and elusive. Something older than you expected. There&#39;s complexity in it, the kind that hides a story you&#39;re not sure you&#39;re ready to hear.

  You exhale slowly, the alcohol blooming through your chest like warmth under thick blankets.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s… incredible.&lt;&lt;/speech&gt;&gt;

  Adda doesn&#39;t respond right away. She simply watches you, her lips curled into the faintest smile—like she already knew what you&#39;d say.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Bert doesn&#39;t miss. Neither do I.&lt;&lt;/speech&gt;&gt;

  The thunder outside rolls again, louder now, and the lights in the sconces flicker ever so slightly as if stirred by the storm&#39;s breath.
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="9" name="Adda_GoPrivate" tags="widget" position="1100,100" size="100,100">&lt;&lt;widget &quot;Adda_GoPrivate&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Would you ever step away for something a little more private?&lt;&lt;/speech&gt;&gt;

  For the first time in your entire conversation, Adda doesn&#39;t have an immediate answer. Her eyes soften just slightly, the sharp edge behind them dulled by something unspoken.

  She looks away, watching the parlor for a breath or two — the flick of a lighter at the bar, the rustle of skirts, the distant creak of the upstairs floor.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Well now… that&#39;s not a request I get very often anymore.&lt;&lt;/speech&gt;&gt;

  She turns back, lips curved just barely in a knowing smile.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;But since you&#39;ve gone and got me talking about the old days… sure. I wouldn&#39;t mind a little more reminiscing.&lt;&lt;/speech&gt;&gt;

  She moves gracefully to her feet, smoothing the front of her long black dress. A slow step toward you — deliberate, poised.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Just don&#39;t expect the same girl who used to work the floor. She&#39;s still in here somewhere… but you&#39;ll have to be clever to find her.&lt;&lt;/speech&gt;&gt;

  Without another word, she gestures for you to follow, and begins walking toward the a door just behind and to the side of the bar, one which you hadn&#39;t noticed was there before.

  [[You follow Adda into her private room.|Adda_PrivateScene]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 3&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 3&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="10" name="GoodbyeAddaZero" tags="widget" position="1225,100" size="100,100">&lt;&lt;widget &quot;GoodbyeAddaZero&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk more later.&lt;&lt;/speech&gt;&gt;

  Adda gives you a small, approving nod — not dismissive, but understanding.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Of course. The parlor&#39;s yours to roam. Just don&#39;t go falling for anyone too quickly, now.&lt;&lt;/speech&gt;&gt;

  Her lips curl in a subtle smirk, and she returns her attention to the room — already half-in, half-out of your conversation, watching the ebb and flow of her domain.

  You rise from the couch and glance around. The hush of the brothel settles over you again — warm light, distant laughter, the clink of glass, the faint rumble of thunder pulsing against the windows.

  [[You step away from Adda and return to the parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Adda Noctail Origin Convo Branch - Start */</tw-passagedata><tw-passagedata pid="11" name="Adda_Origin_WhatWasItLike" tags="widget" position="100,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_WhatWasItLike&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What was the brothel like before you took over?&lt;&lt;/speech&gt;&gt;

  Adda leans back against the velvet cushion, one leg crossed over the other, fingers tapping lightly on her knee.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Dusty. Desperate. The kind of place where eyes don&#39;t meet and names aren&#39;t asked. It made coin, sure—but it bled for it. No warmth, no rules, just survival with a smile.&lt;&lt;/speech&gt;&gt;

  Her voice tightens, just slightly.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;There were still good people under this roof. One in particular. She kept the light on in the dark, even when no one deserved it. The kind of person who made you sit straighter just by walking into a room.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s eyes drift upward, unfocused. A hint of warmth in the corner of her mouth, bittersweet.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;She used to say the walls had ears. So she made sure they only heard kindness. I thought it was naive at the time. Now? I think it&#39;s the bravest damn thing anyone ever tried in a place like this.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="12" name="Adda_Origin_PreviousOwner" tags="widget" position="225,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_PreviousOwner&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Who was the previous owner?&lt;&lt;/speech&gt;&gt;

  Adda&#39;s posture shifts at the question—just slightly. Her shoulders drop, the air around her suddenly quieter, like a memory is stepping between you both.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;That would be Lys. Though to call her the “owner” isn&#39;t quite right. She was never on the deed. Never had the keys, not really. But she ran the floor. Managed the girls. Kept the worst of the wolves at bay.&lt;&lt;/speech&gt;&gt;

  She folds her arms, eyes drifting to a point just over your shoulder.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;The real owners—the ones with coin and clean ledgers—didn&#39;t care what this place became, so long as it kept making money. Lys tried to shift that. Bit by bit. She made the rooms safer. Banned the regulars who didn&#39;t respect limits. Bought better wine, better sheets. Even lit the place in amber instead of white—said it made everyone feel warmer, softer.&lt;&lt;/speech&gt;&gt;

  Her lips press into a thin smile.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;But she ruffled the wrong feathers. There were men in high collars who didn&#39;t like that she had a voice. And even fewer liked that she didn&#39;t hide who she was. Said she was... unsettling. That her kind didn&#39;t belong in polite society, let alone business.&lt;&lt;/speech&gt;&gt;

  She runs a thumb along the edge of her ring.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I told her to keep her head down. She laughed in my face. Said, “You don&#39;t fix rot by pretending it smells sweet.”&lt;&lt;/speech&gt;&gt;

  There&#39;s silence for a moment. Even the parlor seems to hush.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;She was brave. And she paid for it.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="13" name="Adda_Origin_HowSheTookIt" tags="widget" position="350,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_HowSheTookIt&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So… how did you end up taking control of the Noctail?&lt;&lt;/speech&gt;&gt;

Adda doesn&#39;t answer immediately. Her fingers idly trace the rim of her glass, her gaze drifting to a quiet corner of the parlor as if searching for a memory still lingering there.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;It wasn&#39;t supposed to be me, you know. The one running things.&lt;&lt;/speech&gt;&gt;

The soft thunder outside rolls again, low and distant.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Lys—she was the heart of this place back then. Not in title, but in spirit. She had a way of making people feel seen. Made the girls stand taller. Made the guests a little less cruel. The plan was always for her to take over fully once the old owner finally let go.&lt;&lt;/speech&gt;&gt;

She lets out a dry breath, almost a laugh.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;But plans don&#39;t hold up well in this city. Not when people like Lys start asking for better. She&#39;d begun drawing lines—no more rent skimming from the Guild, no more silent bribes to the watch. Just… honest work, done with dignity. That ruffled more than a few feathers.&lt;&lt;/speech&gt;&gt;

Jaylie shifts slightly, the tension in Adda&#39;s voice registering now.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;One night, she didn&#39;t come back. No note. No farewell. Just… gone.&lt;&lt;/speech&gt;&gt;

She presses her lips together. The silence that follows is heavy, not just with grief but with unfinished justice.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;The old owner—he panicked. With Lys gone, the whole place started to fray. Clients got bolder. Staff grew scared. I wasn&#39;t in charge, but I was still here. Still loyal. And loud enough to matter.&lt;&lt;/speech&gt;&gt;

She finally meets your eyes.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I leaned on the right people. Called in favors. Found ways to make things… difficult for him. Let&#39;s just say the Guild figured it was better for their business if someone more stable took the reins. A deed signed under pressure is still a deed.&lt;&lt;/speech&gt;&gt;

She leans back, thoughtful.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I didn&#39;t steal this place. I claimed it. For her. For everyone still here. And for myself.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="14" name="Adda_Origin_ChangesMade" tags="widget" position="475,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_ChangesMade&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And once you took over… what changed?&lt;&lt;/speech&gt;&gt;

Adda gives a small grunt, not unkind—more reflective than anything. She swirls the liquid in her glass, the ice clinking softly like distant wind chimes.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Almost everything. But not all at once. You don&#39;t reshape a house like this with fire and hammers. You do it like a tailor—quiet snips and careful stitching. Little by little, until the seams hold different shapes.&lt;&lt;/speech&gt;&gt;

She shifts in her seat, eyes sweeping the room.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;First thing I did was remove the locks from the inside of the rooms. No one here should ever feel like they&#39;re trapped, even for show. Then I started cutting ties—with certain clients, certain fixers. If someone didn&#39;t treat my people like people, they were no longer welcome. No exceptions.&lt;&lt;/speech&gt;&gt;

Jaylie nods slowly, watching Adda&#39;s expression.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I hired guards that worked for the hosts, not just the clients. Switched contracts from oral deals to proper ones—signed, sealed, enforceable. Doesn&#39;t stop everything, but it gives us a shield if the law ever decides to remember we exist.&lt;&lt;/speech&gt;&gt;

A subtle crack of thunder echoes from outside, barely audible beneath the murmur of the parlor. Adda glances toward the window briefly, then back.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;The biggest change, though? I made it clear that no one here belongs to anyone. Not to me. Not to the house. Not to the city. Anyone can walk when they want—no debts. No shame. Stay because you choose to. Leave because you can.&lt;&lt;/speech&gt;&gt;

She pauses, looking back at Jaylie. Her voice softens.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Lys used to say that dignity was the rarest thing in places like this. So I built a home where it could grow.&lt;&lt;/speech&gt;&gt;

Jaylie watches her quietly for a beat before offering a small, genuine smile.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I think she&#39;d be proud.&lt;&lt;/speech&gt;&gt;

Adda returns the smile, just barely.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I hope so...&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="15" name="Adda_Origin_LocalPolitics" tags="widget" position="600,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_LocalPolitics&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Any enemies left over from those days?&lt;&lt;/speech&gt;&gt;

Adda&#39;s mouth curls—not into a smile, exactly, but something sharp and knowing. She leans back, exhaling slowly through her nose, like she&#39;s weighing which ghosts are safe to speak aloud.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;You don&#39;t clear a den of rats without some of them slipping through the cracks. A few of them scurry still. Names I&#39;d prefer you not repeat, unless you want your shoes filled with glass.&lt;&lt;/speech&gt;&gt;

She picks up her glass, takes a slow sip, then gestures lazily with it.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;There was a man named Vell. Muscle for one of the guilds, back when Lys was still alive. Thought he could own the house from the shadows—skim coin, push substances, threaten the girls if they didn&#39;t ‘perform&#39; to spec. I told him once to leave. The second time… I didn&#39;t ask.&lt;&lt;/speech&gt;&gt;

Her gaze flicks toward the far side of the parlor, where a pair of guests laugh too loudly before quieting again.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;He doesn&#39;t come around anymore. But he&#39;s not gone. Not really. The city has a long memory and a short leash, and some men never forget the bruise to their pride.&lt;&lt;/speech&gt;&gt;

Jaylie shifts slightly in her seat, sensing the weight behind her words.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Then there&#39;s the Nobleman&#39;s Club over on Fallow Row. Not a brothel, technically. More of a... gentleman&#39;s retreat. They don&#39;t like that we cut into their profits and do it without bowing. One of their chairs still sends little spies now and then, trying to find dirt on us.&lt;&lt;/speech&gt;&gt;

Thunder rolls distantly again, this time closer, the windows of the parlor murmuring with a soft, sympathetic rattle. Adda glances toward the sound, then turns her attention back.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;But none of them come here. Not anymore. They know what it costs. And I&#39;ve made it very clear—if anyone touches one of mine, I&#39;ll spend every last coin I have making sure it&#39;s the last thing they do.&lt;&lt;/speech&gt;&gt;

A pause hangs between you.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Remind me not to get on your bad side.&lt;&lt;/speech&gt;&gt;

Adda lets out a short, warm chuckle that almost cuts the tension.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Smart girl.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="16" name="Adda_Origin_Exit" tags="widget" position="725,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_Exit&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
You exhale softly, your fingers tracing the rim of your glass. Adda watches you for a moment, then shifts her weight in the seat, like she&#39;s letting go of something that had settled heavy on her shoulders.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We don&#39;t have to keep talking about the past.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;No. We don&#39;t. But thank you for asking. Not many care enough to hear it, let alone understand what it took to get here.&lt;&lt;/speech&gt;&gt;

Her gaze drifts for a moment—out toward the parlor where her hosts mingle, laugh, seduce, and survive. The room seems softer in the golden light, but the thunder outside is closer now. A low boom rolls through the walls, like a memory passing overhead.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Now then. You&#39;ve heard enough ghosts for one night, I think. Let&#39;s get back to the living.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;adda&quot; &quot;Phase0&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="17" name="Allura_Watching" tags="widget" position="850,225" size="100,100">&lt;&lt;widget &quot;Allura_Watching&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Were you watching me?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Of course I was.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

She says it like it costs her nothing. No hesitation. No apology. Her tail flicks lazily behind her again, curling in a figure eight.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Like I said before, you walked in like you didn&#39;t want anyone to notice, which only made it harder not to. And then... you looked at me like you were hoping I&#39;d notice anyway. I do not know how you expected me not to stare. It was the most entertaining thing I have seen all night.&lt;&lt;/speech&gt;&gt;

You open your mouth, caught somewhere between denial and deflection, but she doesn&#39;t give you room to find either.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;It&#39;s sweet, you know. The way your eyes try not to linger. The way you sit just far enough away to lie about your curiosity. Please go on and look all you want. I would not have dressed like this if I did not welcome it. I like how your gaze feels on my skin.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

She leans in just enough to make your pulse catch, but not so much that you could call her out for it. Her eyes are impossibly gold this close—like molten metal poured into a feline frame.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re very confident. I mean that in a good way of course.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mm. That&#39;s part of the fun. Most people want to be seen. They just don&#39;t know how to ask for it.&lt;&lt;/speech&gt;&gt;

She lifts her glass—something crimson and jeweled with condensation—and takes a sip without ever breaking eye contact. Then she tilts her head, just slightly.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So, Jaylie... now that I&#39;ve seen you, what will you show me next?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="18" name="Allura_OutOfPlace" tags="widget" position="975,225" size="100,100">&lt;&lt;widget &quot;Allura_OutOfPlace&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Don&#39;t take this the wrong way, but... you feel kind of out of place here.&lt;&lt;/speech&gt;&gt;

Allura freezes — dramatically, like a courtesan in a stage play. Her head tilts, her lips part slightly, and she places a hand to her chest with faux offense.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Out of place? You wound me, &lt;em&gt;petite&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She gives an exaggerated sigh, then lets her hand slide down to rest at her hip. Her smile returns, but it&#39;s sharper now — teasing, dangerous.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Here I thought I was the very portrait of hospitality. My tail&#39;s behaving, my cleavage is curated, my drink is full — and yet somehow, I am a misfit in my own chaise lounge.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;No, I didn&#39;t mean— I just meant that… I don&#39;t get it. You&#39;re stunning. Charismatic. You look like someone who should be draped in silks, surrounded by admirers. I guess I was surprised to find you alone.&lt;&lt;/speech&gt;&gt;

Allura&#39;s eyes narrow slightly, the mockery fading just a hair — enough to let something thoughtful flicker underneath.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah. So what you&#39;re saying is... I look like I should come with an entourage. A pedestal. A personal fan brigade?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I mean... yes? But in a nice way.&lt;&lt;/speech&gt;&gt;

Allura chuckles — a low, velvety sound. She sips her drink again and lets a moment pass before responding.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You&#39;re not wrong, mon trésor. I&#39;ve had those nights. But not all attention is desirable. And not every pedestal is worth standing on. Sometimes it&#39;s more fun to pick someone &lt;em&gt;specific&lt;/em&gt; to make the effort.&lt;&lt;/speech&gt;&gt;

Her tail flicks again, brushing your calf this time — slower, more deliberate.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;And tonight, I think I like being the mystery in the corner. The one worth crossing the room for. After all, it worked, no?&lt;&lt;/speech&gt;&gt;

You cannot even begin to argue with the logic. You look down and your hands in your lap and laugh to yourself for a moment. Then you look up at Allura. She stares at you. Her lips curling. Then together you both laugh louder, more heartily. It is the first time, you notice, that you have seen a truly revealing response from her. 

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; You got me. &lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="19" name="Allura_Enjoyment" tags="widget" position="1100,225" size="100,100">&lt;&lt;widget &quot;Allura_Enjoyment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I ask you something real?&lt;&lt;/speech&gt;&gt;

Allura arches a brow — the expression almost amused, but there&#39;s a flicker of something sharper beneath it. Caution, maybe. Or curiosity.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You just did, mon cœur. But go on. I&#39;m listening.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you actually enjoy this? I mean... not the show. Not the act. But the being here. Talking like this. Connecting with someone.&lt;&lt;/speech&gt;&gt;

The question lingers between you, heavier than the rest. For the first time, Allura doesn&#39;t immediately answer. She swirls her drink slowly, eyes focused on the glass like the answer might settle at the bottom.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You know what most people ask me?&lt;&lt;/speech&gt;&gt;

She doesn&#39;t wait for you to guess.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;They ask me what I charge. What I like. What I&#39;ll do and what I won&#39;t. You&#39;re the first person tonight who&#39;s asked if I &lt;em&gt;want&lt;/em&gt; to be here.&lt;&lt;/speech&gt;&gt;

She exhales slowly through her nose and leans back against the cushions, her posture more relaxed than before — not staged, not seductive. Just tired. Honest.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;The truth is… some nights, yes. I like the games. The theater of it all. There&#39;s power in being seen — in choosing how to be seen. But then there are nights where I feel like a painting left in the rain. Pretty from a distance, but bleeding underneath.&lt;&lt;/speech&gt;&gt;

Her voice never cracks. It doesn&#39;t need to. You hear the weight behind every syllable.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But talking like this? With you? That part I enjoy.&lt;&lt;/speech&gt;&gt;

She sets her glass down, empty now, and folds her hands neatly in her lap.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ask me another one like that, and I might even answer it honestly.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="20" name="Allura_WhatCanIDo" tags="widget" position="1225,225" size="100,100">&lt;&lt;widget &quot;Allura_WhatCanIDo&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If there was anything I could do — right now — to truly make the rest of your night… what would it be?&lt;&lt;/speech&gt;&gt;

Allura blinks.

Just once.

You catch the faintest hitch in her breath — like a stage performer who&#39;s forgotten her next line.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Now that...&lt;em&gt;that&#39;s&lt;/em&gt; a dangerous question.&lt;&lt;/speech&gt;&gt;

She says it quietly, almost to herself. No teasing, no act — not yet. She leans forward just a touch, like gravity&#39;s decided she should be closer to you now.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You&#39;d be surprised how few people ask that with any intention behind it. Most of them want a specific answer. One they can anticipate. One that makes them feel clever for guessing right.&lt;&lt;/speech&gt;&gt;

Her tail doesn&#39;t flick this time. It curls gently around one ankle, like a ribbon tied in thought.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But you…&lt;&lt;/speech&gt;&gt;

She lifts her eyes to meet yours, and for a moment, the room feels quieter. As if everything&#39;s paused to hear her answer too.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;If you mean it — if this isn&#39;t just another performance…?&lt;&lt;/speech&gt;&gt;

She smiles softly. Not like before. No hunger in it. Just something warm and fragile.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Then maybe you&#39;ve already done it. You asked the question.&lt;&lt;/speech&gt;&gt;

You feel a strange mix of pride and disappointment, as if you were upset that she didn&#39;t ask you to go fight the lightning outside—which but in this moment—something is making you feel like you could have done it.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 2&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="21" name="Allura_DrinkOrder" tags="widget" position="100,350" size="100,100">&lt;&lt;widget &quot;Allura_DrinkOrder&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Would you mind ordering a drink for me?&lt;&lt;/speech&gt;&gt;

Allura raises an eyebrow, her smile curling at the edges like parchment near flame.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mmm. Dangerous thing to offer a woman like me that much power, &lt;em&gt;chérie&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She turns slightly, catching Bert&#39;s eye across the room with a subtle flick of her fingers and a tilt of her chin.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Bert, love — something slow and seductive, but with a little teeth. Like me.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;bert&quot;&gt;&gt;Comin&#39; right up, madame.&lt;&lt;/speech&gt;&gt;

Moments later, a pale violet drink arrives in a crystal glass shaped like a blooming flower. The scent hits first—berries, wine, and something herbal beneath it.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;We call this one &lt;em&gt;Velvet Mercy&lt;/em&gt;. Tastes like a favor you didn&#39;t earn. Be careful with it.&lt;&lt;/speech&gt;&gt;

You lift the glass and sip. It&#39;s sweet, rich, and ends with a bitter curl that coils at the back of your throat like smoke.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s... complex.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Aren&#39;t we all?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="22" name="Allura_GoSomewherePrivate" tags="widget" position="225,350" size="100,100">&lt;&lt;widget &quot;Allura_GoSomewherePrivate&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Hey do you have maybe like a private room we could go to? We don&#39;t have to like... &lt;strong&gt;DO&lt;/strong&gt; anything, I just wanted to get to know you more.&lt;&lt;/speech&gt;&gt;

Allura&#39;s eyes shine and glow. She feigns emotional damage again, this time less dramatic.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So you want to do nothing with me? &lt;em&gt;Mon trésor.&lt;/em&gt; Here I was thinking my charms were working on you.&lt;&lt;/speech&gt;&gt;

You blush but don&#39;t get a chance to respond before she begins to stand. Her tail brushes down your leg like it has a mind of its own before she gathers to her feet.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Viens.&lt;/em&gt; Come then. Let&#39;s see if the air upstairs is any quieter.&lt;&lt;/speech&gt;&gt;

[[You take her hand and stand.|Allura_GoingUpstairs]]

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="23" name="Allura_ReturnToParlor" tags="widget" position="350,350" size="100,100">&lt;&lt;widget &quot;Allura_ReturnToParlor&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk more later.&lt;&lt;/speech&gt;&gt;

Allura stretches languidly on the chaise, her body language equal parts feline and flame.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Of course, &lt;em&gt;petite&lt;/em&gt;. I&#39;ll still be here — spinning webs and sipping slow poison.&lt;&lt;/speech&gt;&gt;

She raises her glass slightly toward you.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Don&#39;t stay gone too long, hmm? I find myself... growing fond.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
[[You rise and return to middle of the parlor.|Scene02_ReturnToParlor]]
[[You rise and return to middle of the parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="24" name="AlluraRoom" tags="widget" position="475,350" size="100,100">&lt;&lt;widget &quot;AlluraRoom&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Your room is beautiful. Do they all look like this?&lt;&lt;/speech&gt;&gt;

Allura smiles—not the wicked or sultry kind she often uses downstairs, but something softer. Something a little less prepared.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah, you flatter me, mon trésor. But no. Not quite like this.&lt;&lt;/speech&gt;&gt;

She glances around her space, her eyes catching on the hanging lanterns, the draped silks, the round bed cradled in shadow and color.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Each room here belongs to the one who lives in it. Decor is left to taste. Some are sparse. Others look like shrines. Mine...&lt;em&gt;mine is a cocoon&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She reaches her arms to either side, taking handfuls of sheets and pulls them in close to her chin. She softly sways back and forth as a moth would, preparing for the comfort of metamorphasis. 

&lt;&lt;speech &quot;allura&quot;&gt;&gt;I spend more time here than I do anywhere else. So I wanted it to feel like a dream I could live in. A place that would greet me with gentleness, even when the rest of the world is sharp.&lt;&lt;/speech&gt;&gt;

You nod, taking in the details. The smell. The light. The faint brush of silk against your sleeve as you shift where you sit.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It feels safe here.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;That is the idea. Intimacy without expectation. Warmth without heat. Unless you ask for it, of course.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Does it ever get difficult? Sleeping where you— &lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Fuck strangers for money?&lt;&lt;/speech&gt;&gt;

The bluntness catches you off guard. You just shrug a little.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;If I worked anywhere else in the city, it might. Here I know I am protected. Adda is not one easily trifled.&lt;&lt;/speech&gt;&gt;

She winks—playful again, but not dismissive. Just present. Just... Allura.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="25" name="Allura_WhatDoNow" tags="widget" position="600,350" size="100,100">&lt;&lt;widget &quot;Allura_WhatDoNow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So... what do we do now?&lt;&lt;/speech&gt;&gt;

Allura doesn&#39;t answer right away.

She moves to the edge of the bed and folds her legs beneath her, the sheer fabric of her skirt pooling around her like dusk caught in a net. Her eyes follow the gentle flicker of one of the lanterns for a beat before returning to you.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Such a simple question, and yet it always reveals so much.&lt;&lt;/speech&gt;&gt;

She pats the bed beside her—not insistently, just an invitation.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Do you ask because you want to be told what comes next? Or because you want permission to choose it yourself?&lt;&lt;/speech&gt;&gt;

You sit beside her, close enough to feel the warmth of her thigh near yours.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I don&#39;t know yet. Maybe both.&lt;&lt;/speech&gt;&gt;

Allura hums—a thoughtful, amused sound. She turns her body toward you, one hand gently resting between you both, fingers splayed on the silk.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Then let&#39;s just... &lt;em&gt;be&lt;/em&gt; here for a moment.&lt;&lt;/speech&gt;&gt;

She leans back slightly on her hands, her eyes still on yours.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;We don&#39;t have to name it. Not yet.&lt;&lt;/speech&gt;&gt;

Outside, the thunder murmurs like a distant conversation. Inside, the hush is almost sacred.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But I&#39;m glad you asked.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="26" name="Allura_GetComfortable" tags="widget" position="725,350" size="100,100">&lt;&lt;widget &quot;Allura_GetComfortable&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I… get comfortable with you?&lt;&lt;/speech&gt;&gt;

Allura&#39;s lips part, slow and deliberate. She doesn&#39;t blink. She doesn&#39;t breathe. Then—softly—she laughs.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Enfin, putain&lt;/em&gt;. Mon trésor, I thought you&#39;d never ask.&lt;&lt;/speech&gt;&gt;

She rises from the bed in a single, fluid motion, the sheer fabric of her robe catching the lantern light as it flows around her. Her steps toward you are slow, but not hesitant. Intentional. Like she&#39;s savoring the moment as much as the act.

She stops in front of you and holds out her hands—palms up, waiting.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;May I?&lt;&lt;/speech&gt;&gt;

You nod.

She starts with your boots, kneeling as she unlaces them one by one, her fingers brushing your calves, your ankles. Then your leather jerkin, her hands sliding beneath the hem to feel the warmth of your waist before peeling it away. Her touch never lingers longer than it needs to—but it never hurries either.

Next, she rises, her fingers teasing at the waistband of your trousers. She unbuttons them with slow precision, then draws them down your hips, past your thighs, until they fall away and you&#39;re left in only your long tunic and a pair of plain white panties.

You feel the cool air of the room against your skin, and her warmth just in front of you. She looks you over, not with hunger—but appreciation. Admiration.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;There. That&#39;s better.&lt;&lt;/speech&gt;&gt;

She guides you to the bed with a hand at your back and a whisper of a smile. The cushions embrace you as you sit. Then, without breaking eye contact, she climbs onto the bed beside you and drapes one leg over the other, close but not quite touching.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Comfort is a sacred thing, Jaylie. It&#39;s not always earned. But you? You wear it beautifully.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="27" name="AlluraOpenConvoMinigameOne" tags="widget" position="850,350" size="100,100">&lt;&lt;widget &quot;AlluraOpenConvoMinigameOne&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I want to get to know you better. Not just the part you show the room. I mean... you.&lt;&lt;/speech&gt;&gt;

Allura shifts where she sits, her eyes narrowing with intrigue. The corners of her lips curl—not into a smirk, but something softer.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah... a rare pleasure. Careful you don&#39;t go to far. I have been known to bite when provoked.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;allura&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="28" name="BackstoryStart" tags="widget" position="975,350" size="100,100">&lt;&lt;widget &quot;BackstoryStart&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I ask you a little bit about your past?&lt;&lt;/speech&gt;&gt;

Allura doesn&#39;t answer immediately. In fact for the first time she seems to be truly caught off guard. She cocks her head to the side and raises an eyebrow.

She reaches up an runs a delicate finger along your face, brushing your cheekbone down to your chin.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Now why would you want to go and do something like that?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I just want to know a little about where you come from.&lt;&lt;/speech&gt;&gt;

Allura seemed to ponder for a moment. The room is silent, she lightly tickles your chin with the tip of her nail.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You may ask anything you like. I am an open book. Not normally, I&#39;m not, but for you I will make an exception.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;allura&quot; &quot;alluraBackstory&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;
/* Allura Backstory Branch - Start */
    :: WhereAlluraGrewUp [widget]
    &lt;&lt;widget &quot;WhereAlluraGrewUp&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Where did you grow up?&lt;&lt;/speech&gt;&gt;

    Allura shifts on the bed, stretching one leg out beneath the silk and draping her arm across a cushion.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Far from here. Farther than you&#39;d guess, I think.&lt;&lt;/speech&gt;&gt;

    Her tone is gentle, not evasive—like she&#39;s choosing each word with care rather than caution.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;A small village in the eastern cliffs of Taramel. You wouldn&#39;t find it on most maps. A place of rock and wind and stubborn people who didn&#39;t take kindly to anything they couldn&#39;t explain. Especially not a girl with gold eyes, blue skin, and a tail.&lt;&lt;/speech&gt;&gt;

    She doesn&#39;t sound bitter, but there&#39;s a weight behind the words—something old and settled.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;My mother was from that village, but one day when I was around 8 years old I went out to watch the other kids play Fae-Ball. When I went back to our hut my mother was gone along with just about everything we owned, which wasn&#39;t much to begin with.&lt;&lt;/speech&gt;&gt;

    She watches your face closely as she talks. When you don&#39;t seem to be offering comment she continues.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;I stayed there only as long as I had to after that. I truly had no one and spent most of my time begging or scrounging for food. Eventually, I gathered enough coin to make it to the next closest town, down out of the mountains. Then I did that again and then again, until I eventually found myself across an ocean and living in Bastion.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you miss it? The cliffs. The people.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Not even for a second, but sometimes when I close my eyes and dream, I can still feel the moutain air blowing on my back, as if I&#39;m not to forget.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;set $currentPhase = &quot;alluraBackstory&quot;&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
   &lt;&lt;run setup[`allura_Conversation_Options_${$currentPhase}`]()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: Parentage [widget]
    &lt;&lt;widget &quot;Parentage&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you know much about your parents?&lt;&lt;/speech&gt;&gt;

    Allura leans back on one elbow, her gaze drifting to the lanterns above, watching them swing faintly with the wind outside.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;My mother, a little. My father... well, I know more about him than I&#39;d like to.&lt;&lt;/speech&gt;&gt;

    She runs a finger along the edge of a cushion, as if tracing the outline of a thought she hasn&#39;t quite dared to speak aloud.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;My mother was human. Village-born. Hard-edged. She worked with herbs—mostly tinctures and poultices, but also... other things. People came to her with needs they couldn&#39;t name. Secrets steeped in boiling water.&lt;&lt;/speech&gt;&gt;

    A faint chuckle escapes her lips, but there&#39;s no joy in it.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;She never spoke of my father. Not once. I asked often. I didn&#39;t understand what I was—so how could I know what he was?&lt;&lt;/speech&gt;&gt;

    She looks at you, her expression unreadable.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And what was he? Did she ever tell you?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;She told me, &quot;&lt;em&gt;C&#39;était une malédiction… qui m&#39;a laissée un cadeau.&lt;/em&gt;&quot;&lt;&lt;/speech&gt;&gt;

    She pauses, letting the words echo. You almost ask for clarification when she speaks again.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;A curse… that left a gift.&lt;&lt;/speech&gt;&gt;

    You see the shimmer of a tear, but she wipes it away before it can earn an identity.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;It wasn&#39;t until years later, in Altherin, that I met a Seer who told me more about my patronage. She did a ritual with a drop of my blood... and found a name buried deep inside it.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Traloin.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Is that a name I should know?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;If you studied the Jade Coast wars, you might. He wasn&#39;t just a demon. He was responsible for razing half of Medmarr and almost destroying Hale about two centuries ago.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.allura_Conversation_Options_alluraBackstory()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: TravelWish [widget]
    &lt;&lt;widget &quot;TravelWish&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If you could go anywhere in the world, where would it be?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Exciting. This question is far less depressing than I would have guessed you&#39;d ask. I like it all the same.&lt;&lt;/speech&gt;&gt;

    She traces a fingertip along the hem of her pillow, thoughtful.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Somewhere warm. Somewhere that I can get naked and run my feet through the sand and swim in water bluer than I am.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That sounds fun. I wouldn&#39;t mind a trip like that either.&lt;&lt;/speech&gt;&gt;

    Allura clicks her tongue at you a few times. A sound of disapproval.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Not a trip for me, &lt;em&gt;Mon Trésor&lt;/em&gt;. The day I find that place, I think I would stay there for the rest of time.&lt;&lt;/speech&gt;&gt;

    She looks at your almost dejected expression.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Still... I would not mind the company.&lt;&lt;/speech&gt;&gt;

    You smile at the invitation.

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 2&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 2&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.allura_Conversation_Options_alluraBackstory()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: StrangeClient [widget]
    &lt;&lt;widget &quot;StrangeClient&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What&#39;s the worst or strangest client you&#39;ve ever had?&lt;&lt;/speech&gt;&gt;

    Allura exhales a long breath through her nose, a single brow rising.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;You know, I thought you&#39;d ask that much sooner. Most people do. It&#39;s usually the first thing that drips out of their curiosity — the scandal, the grotesque, the half-formed fantasy of someone else&#39;s humiliation.&lt;&lt;/speech&gt;&gt;

    She swirls the drink in her hand once, slowly. The glass catches the lamplight like a gemstone.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;But since you&#39;ve waited until now, I&#39;ll reward your patience.&lt;&lt;/speech&gt;&gt;

    She smiles, but it doesn&#39;t quite reach her eyes.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;There was a man—years ago now. Noble type. Clean boots in a muddy city. Came in once a week, every week, like clockwork. Always asked for silence. Would lie down, fully clothed, on the bed. And just… cry.&lt;&lt;/speech&gt;&gt;

    You blink.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Cry?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Loudly. Unapologetically. Never said a word otherwise. No touching, no questions. Just weeping for the full hour. Then he&#39;d leave double payment and vanish into the street like fog.&lt;&lt;/speech&gt;&gt;

    She tilts her head back slightly, eyes drifting upward.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;I don&#39;t know what broke him, or why I was the one he chose to break in front of. But there&#39;s something sacred about being someone&#39;s safe place—even if they can&#39;t say your name.&lt;&lt;/speech&gt;&gt;

    A hush falls between you, deeper than the storm outside. You don&#39;t feel the need to fill it.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;That was the strangest. The worst? Perhaps another time.&lt;&lt;/speech&gt;&gt;

    She winks—softly this time—and sips her drink.

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.allura_Conversation_Options_alluraBackstory()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: BackstoryExit [widget]
    &lt;&lt;widget &quot;BackstoryExit&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Thanks for sharing all that with me. I&#39;d like to talk about something else now, if that&#39;s alright.&lt;&lt;/speech&gt;&gt;

    Allura gives a soft nod and a smile touched with warmth.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Of course, mon trésor. Curiosity comes in waves. I&#39;ll be here when the next one rises.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;DialogueTree &quot;allura&quot; &quot;Phase1&quot;&gt;&gt;
    &lt;&lt;/widget&gt;&gt;
/* Allura Backstory Branch - End */</tw-passagedata><tw-passagedata pid="29" name="KissAllura" tags="widget" position="1100,350" size="100,100">&lt;&lt;widget &quot;KissAllura&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I kiss you?&lt;&lt;/speech&gt;&gt;

Allura blinks—slow and deliberate. Her smile curves like a question, but she doesn&#39;t answer immediately. Instead, she shifts on the bed, drawing her knees up slightly as her fingers press into the silk.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You&#39;ve asked for a lot tonight, &lt;em&gt;mon trésor&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She leans toward you—but only just enough to make you ache for the rest of the distance.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But a kiss? A real one? That isn&#39;t something I give. It&#39;s something you take.&lt;&lt;/speech&gt;&gt;

You feel the room tilt—not physically, but like the air has changed. Her eyes hold yours, daring you to break the space between you. Your eyes lock on her lips, their luscious hue of blue drawing desire out of you all their own. 

She speaks slowly.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So come take it, if you want it.&lt;&lt;/speech&gt;&gt;

&lt;p&gt;You do.&lt;/p&gt;

You reach for her slowly, one hand brushing her cheek, the other resting on the edge of the bed for balance. And when your lips finally meet—gods, it&#39;s everything. Soft. Warm. Hungrier than you meant it to be, and slower than you expected. She tastes faintly of wine and pomegranate, and the kiss deepens before you even realize it has.

One of her hands finds your waist. The other curls behind your neck, anchoring you in the moment like she doesn&#39;t want it to end.

When you part, neither of you speak at first. Her forehead rests against yours, and her breath is a shared thing between you now.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mmm. Worth the wait. I am not done with you though, &lt;em&gt;Jaylie&lt;/em&gt;. &lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 3&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;StartSexScene &quot;allura&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Allura_PostSexPhase1&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="30" name="JustLay" tags="widget" position="1225,350" size="100,100">&lt;&lt;widget &quot;JustLay&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If it&#39;s alright... I think I&#39;d just like to lay here with you.&lt;&lt;/speech&gt;&gt;

Allura tilts her head, surprised—but not displeased. Her smile softens like warm silk folding.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;No rush, no performance... I like that. Come, then. Let&#39;s waste time beautifully.&lt;&lt;/speech&gt;&gt;

She pulls back a layer of cushions and makes space beside her with a lazy, fluid grace. You slide closer.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Lay your head here. Just for a while.&lt;&lt;/speech&gt;&gt;

[[You curl beside her and close your eyes.|Allura_JustLay_Route]]

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="31" name="Bert_DenyMinigame" tags="widget" position="100,475" size="100,100">&lt;&lt;widget &quot;Bert_DenyMinigame&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I want to get to know you better.&lt;&lt;/speech&gt;&gt;
  Bert does not break eye contact, nor does he hesiate for a moment in his polishing of the glass in his hand.
  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Unfortunately Miss, that&#39;s not on the menu.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.bert_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="32" name="Bert_OpenShop" tags="widget" position="225,475" size="100,100">&lt;&lt;widget &quot;Bert_OpenShop&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Drinks are listed behind me. If it&#39;s wet and numbs the tongue, I probably have it.&lt;&lt;/speech&gt;&gt;

  He glances toward a modest slate board mounted near the shelf. The handwriting is neat, efficient—chalked in white and underlined.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Ale, spirits, something local we call ‘Red Mercy&#39;—not for the faint-hearted. I&#39;ve also got roasted nuts if you need to fool your stomach into thinking it&#39;s eaten.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.openShop(&quot;bert&quot;)&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="33" name="Bert_CustomDrink" tags="widget" position="350,475" size="100,100">&lt;&lt;widget &quot;Bert_CustomDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I don&#39;t usually have such a selection to drink from. I&#39;m not even sure what to ask for.&lt;&lt;/speech&gt;&gt;
  Bert raises an eyebrow at you as if waiting for you to get the the point of your request.
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; Would you mind making something special for me? I&#39;ll trust your judgement.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt; Something special you say? I would delight in the occasion, Miss.&lt;&lt;/speech&gt;&gt;
    With a quick flourish of his arms, a shining metal cup is produced from under the counter, catching the glow of the hanging lanterns as if it had been waiting for just this moment. Bert runs a cloth over it with meticulous care, inspecting it like a jeweler inspecting a rare gem.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;You strike me as someone with fire in her spirit, but a touch of sadness behind the eyes. Let&#39;s see if we can match that with something... complicated.&lt;&lt;/speech&gt;&gt;

  He turns to the shelf behind him, fingers ghosting over rows of vividly colored bottles, some of which emit a faint shimmer or trace of smoke within their glass. He selects four: 
    -A bottle of *Whisperleaf Gin*—a pale green spirit known for its calming aftertaste
    - *Ashplum Cordial*—a dark, bitter-sweet reduction brewed in volcanic soil, 
    -A vial of *Feyroot Elixir*—glowing faintly pink and said to react to emotion, 
    -A twist-top jar of crushed *Iceblossom Petals*—frosted over like snowflakes.

  Bert begins to mix. 

  He measures with an instinctual confidence, pouring the gin in first—a sharp, cool base that fogs the metal cup. The cordial follows, swirling through like a bloodstain in silver. The elixir is added last, just a drop, but as it hits the mix, you swear the entire cup glows for a brief moment.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;And now for the ice...&lt;&lt;/speech&gt;&gt;

  He reaches into a chilled drawer and pulls out a single crystalline sphere—transparent, but with what looks like a tiny storm cloud suspended in its center. He cracks it gently against the bar&#39;s edge, letting the shards fall like glass snow into the cup. A cover is placed over the top, of the metal cup and Bert quickly begins to shake it with a certain measure and efficiency.

  After a moment, one of Bert&#39;s hands reaches from above and pulls down a conical, crystal glass. He sets the glass on its edge and gives it a spin. The glass twirls rapidly in place, balancing in such a way that almost defies reason.

  Quickly bert removes the lid of the metal container and pours into the glass as it spins. The contents create a spiral of green and blue which quickly meld together in a vibrant color reminiscent of a dark sea.

  Bert finishes by garnishing the rim with a single frozen petal and a twist of a dark citrus rind, its scent a faint mix of orange and something darker, more elusive.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Here we are madam. I call it a *Storm of Grace.* Because it looks delicate, tastes bold, and lingers longer than it should. Like some people.&lt;&lt;/speech&gt;&gt;

  He slides the drink towards you and watches you closely for a moment, awaiting your reaction.

  You bring the glass to your lips. Inhaling for a moment, you inhale an exciting aroma, sweet and light. You sip.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Wow. This is... incredible!&lt;&lt;/speech&gt;&gt;
  
  The bartender smiles, just a hint of pride, gone before you were sure you actually saw it. He nods ever so slightly.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt; Please enjoy Miss. This one is on the house, compliments of the Madam.&lt;&lt;/speech&gt;&gt;
  
  You glance over to Adda, watching from now so far away. You smile, raise your glass to her. She smiles and nods before turning her attention back to the rest of the parlor.
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.bert_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="34" name="Bert_SeriousResponse" tags="widget" position="475,475" size="100,100">&lt;&lt;widget &quot;Bert_SeriousResponse&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You seem to take your job very seriously.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Well one could hardly expect to deliver a standard of professionalism without taking one&#39;s occupation seriously, Ma&#39;am.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; So you aren&#39;t so serious in your personal life?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt; I like to keep things professional.&lt;&lt;/speech&gt;&gt;
  His avoidance of his personal life as a topic is palpable. You decide to drop the subject.
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.bert_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="35" name="Bert_ReturnToParlor" tags="widget" position="600,475" size="100,100">&lt;&lt;widget &quot;Bert_ReturnToParlor&quot;&gt;&gt;
&lt;&lt;append #convoBox&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I think I&#39;ll explore the rest of the parlor.&lt;&lt;/speech&gt;&gt;
&lt;&lt;speech &quot;bert&quot;&gt;&gt; Of course, Miss. Please enjoy your evening.&lt;&lt;/speech&gt;&gt;

[[You step away from the bar.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="36" name="Brakka_Howareyoutonight" tags="widget" position="725,475" size="100,100">&lt;&lt;widget &quot;Brakka_Howareyoutonight&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;How are you doing tonight?&lt;&lt;/speech&gt;&gt;

Brakka lifts her mug and downs a swig without looking at you.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;I must’ve looked like I was doing pretty damn well for you to walk up that casual.&lt;&lt;/speech&gt;&gt;

She wipes her mouth with the back of her hand and finally gives you a once-over.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Listen &lt;em&gt;Silks&lt;/em&gt;, unless you&#39;ve got business with me, I&#39;d prefer to finish my meal in peace so I can get home before this storm drowns the city.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

She let&#39;s out a little grunt before taking another swig from her mug, the foaming liquid runs down her chin which she wipes with the back of a greasy hand.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="37" name="Brakka_WhySilks" tags="widget" position="850,475" size="100,100">&lt;&lt;widget &quot;Brakka_WhySilks&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Why do you keep calling me &quot;Silks&quot;?&lt;&lt;/speech&gt;&gt;

Brakka doesn’t answer at first. She tears another bite from her mutton, chews, and swallows without rushing.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Because you&#39;re soft.&lt;&lt;/speech&gt;&gt;

You blink. She looks at you like that should’ve been the full explanation.

A beat passes. Brakka lets out a slow exhale—half sigh, half surrender—and gestures vaguely in your direction with the bone still in her hand.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You walk like the ground was paved for you. Like the floorboards were laid so your steps wouldn’t creak.&lt;&lt;/speech&gt;&gt;

She takes a quick bite of her mutton, but doesn&#39;t pause to chew. She continues, muffled, through thick chomps of meat.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You approach strangers like they owe you the conversation. Everything about you is soft. Your clothes. Your voice. Your hair. Your skin.&lt;&lt;/speech&gt;&gt;

She narrows her eyes, not unkindly—but weighing you.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You look like someone who’s never had to fight hard for much in her life. Like someone who’s known luxury. Silk sheets. Soft hands. Easy roads.&lt;&lt;/speech&gt;&gt;

She turns her gaze back toward the fire.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Talk to me again when you wear a few scars.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="38" name="Brakka_FightComment" tags="widget" position="975,475" size="100,100">&lt;&lt;widget &quot;Brakka_FightComment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You look like you’ve seen some fights.&lt;&lt;/speech&gt;&gt;

Brakka lets out a low grunt—could be amusement, could be approval. She tears off another bite of meat and speaks with her mouth half full.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Few. Guild sends me where the coin flows. Sometimes that’s escort duty. Sometimes it’s cracking skulls at the edge of the provinces.&lt;&lt;/speech&gt;&gt;

She finally looks at you, eyes sharp but not unkind.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;This city&#39;s soft, &lt;em&gt;Silks&lt;/em&gt;, but the bastards crawling outside it? They know how to bleed.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

She takes a swig from her mug and wipes her mouth with the back of her wrist.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;If you’re asking whether I’ve earned my scars—yeah. I’ve earned ’em.&lt;&lt;/speech&gt;&gt;

She goes quiet again, shifting her weight against the beam, her focus already drifting back to her meal.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="39" name="Brakka_HelloAttempt" tags="widget" position="1100,475" size="100,100">&lt;&lt;widget &quot;Brakka_HelloAttempt&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I just wanted to say hi.&lt;&lt;/speech&gt;&gt;

Brakka doesn’t look up. She just rips another chunk from the mutton bone and chews slowly, deliberately.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You just did.&lt;&lt;/speech&gt;&gt;

She finally lifts her eyes—just enough to make it feel like a warning.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Now unless you’re here to fight, drink, or pay off a debt, take your manners elsewhere, &lt;em&gt;Silks&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="40" name="Brakka_ExitwithTournyInvite" tags="widget" position="1225,475" size="100,100">&lt;&lt;widget &quot;Brakka_ExitwithTournyInvite&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Enjoy your meal.&lt;&lt;/speech&gt;&gt;

Brakka grunts—noncommittal, but not dismissive. She downs what’s left in her mug and eyes you over the rim.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;If you’re feeling not-so-soft, come find me during the fair.&lt;&lt;/speech&gt;&gt;

She tosses the bare mutton bone into the fire and cracks her knuckles one-handed.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Guild’s hosting a tournament. I’ll be there. Figured I’d offer you the chance to prove me wrong—or right. Either way, I’ll enjoy the show.&lt;&lt;/speech&gt;&gt;

&lt;&lt;if not $TalkedTo_Brakka&gt;&gt;
  &lt;&lt;set $TalkedTo_Brakka = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You step away from the hearth and return to the main tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="41" name="Brakka_ExitNormally" tags="widget" position="100,600" size="100,100">&lt;&lt;widget &quot;Brakka_ExitNormally&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Enjoy your meal.&lt;&lt;/speech&gt;&gt;

Brakka doesn’t look up—just raises her mug slightly in acknowledgment and takes a slow drink.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Might do, Silks.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

&lt;&lt;if not $TalkedTo_Brakka&gt;&gt;
  &lt;&lt;set $TalkedTo_Brakka = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You turn back toward the tavern’s main floor.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="42" name="Darian_HowLongHere" tags="widget" position="225,600" size="100,100">&lt;&lt;widget &quot;Darian_HowLongHere&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So how long have you worked here?&lt;&lt;/speech&gt;&gt;

Darian leans back a little, glancing around the room with something like fondness. Not for the building, necessarily—but for the people moving within it.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;A few years, give or take. I wasn&#39;t planning to stay this long, but... the place has a way of pulling you in.&lt;&lt;/speech&gt;&gt;

He shrugs, though there&#39;s more weight behind it than he lets on.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;It&#39;s not the walls, it&#39;s the people. We look after each other. You don&#39;t find that everywhere. Especially not in this line of work.&lt;&lt;/speech&gt;&gt;

He looks at you, warm but steady.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You learn a lot about someone when you&#39;re the reason they let their guard down. It&#39;s not always pretty. But sometimes... sometimes it&#39;s beautiful.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="43" name="Darian_DoYouLikeJob" tags="widget" position="350,600" size="100,100">&lt;&lt;widget &quot;Darian_DoYouLikeJob&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you actually enjoy this job?&lt;&lt;/speech&gt;&gt;

Darian&#39;s eyebrows lift slightly, then settle into a thoughtful expression. He doesn&#39;t laugh it off or dodge—it&#39;s clear he&#39;s been asked this before.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Some nights more than others.&lt;&lt;/speech&gt;&gt;

He smiles—genuine, not forced.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I won&#39;t pretend every moment is fulfilling. But I meet people. I learn from them. Sometimes I help them feel human again, even if just for a little while. That means something to me.&lt;&lt;/speech&gt;&gt;

His fingers absentmindedly trace the edge of a nearby glass, thoughtful.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;The job isn&#39;t really about what we do. It&#39;s about what people leave with. And when I get that part right... yeah. I like it.&lt;&lt;/speech&gt;&gt;


&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="44" name="Darian_Bracelet" tags="widget" position="475,600" size="100,100">&lt;&lt;widget &quot;Darian_Bracelet&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That bracelet you&#39;re wearing... where did it come from?&lt;&lt;/speech&gt;&gt;

Darian glances down at his wrist like he forgot it was even there. His fingers graze the band slowly, almost unconsciously.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;It was a gift. From someone important.&lt;&lt;/speech&gt;&gt;

He doesn&#39;t elaborate, not right away. His eyes lose focus for a moment—caught somewhere between memory and the present.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I&#39;ve worn it every day since they gave it to me. It&#39;s held up surprisingly well... not unlike the person who made it.&lt;&lt;/speech&gt;&gt;

There&#39;s a small pause—long enough for you to sense he&#39;s choosing what *not* to say.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Maybe I&#39;ll tell you more about it sometime. If the night keeps going like this.&lt;&lt;/speech&gt;&gt;

He offers a smile—not flirtatious this time, just sincere.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="45" name="Darian_GetDrink" tags="widget" position="600,600" size="100,100">&lt;&lt;widget &quot;Darian_GetDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think you could help me get a drink?&lt;&lt;/speech&gt;&gt;

Darian chuckles softly.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You asking because you want a drink, or because you want an excuse to talk to me longer?&lt;&lt;/speech&gt;&gt;

Before you can answer, he lifts a hand to catch Bert&#39;s attention.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Bert, can we get something a little warm but not too strong? Something for thinking, not forgetting.&lt;&lt;/speech&gt;&gt;

Bert grunts from the far end of the bar, already reaching for bottles.

&lt;&lt;speech &quot;bert&quot;&gt;&gt;So... not the ‘Red Mercy,&#39; then. Got it.&lt;&lt;/speech&gt;&gt;

Darian leans in slightly, lowering his voice.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;He pretends to be grumpy, but he&#39;s one of the kindest souls in this place. That drink you&#39;re about to get? He only makes it for people he actually likes.&lt;&lt;/speech&gt;&gt;

He straightens as Bert slides a glass across the counter. The liquid inside glows a soft amber, curling with steam.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Try that. It&#39;s got a name, but I like calling it &#39;Second Wind.&#39; Makes you feel like the night&#39;s still got promise.&lt;&lt;/speech&gt;&gt;

You lift the glass and breathe in.

The aroma is warm and spiced—notes of orange peel, clove, and something almost floral beneath the heat. When you take a sip, it&#39;s smoother than you expected. The burn is soft, the flavor deep. It blooms across your tongue like dusk settling into firelight.

It doesn&#39;t dull your senses. It *clarifies* them.

You lower the glass, exhaling slow.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s... actually perfect.&lt;&lt;/speech&gt;&gt;

Darian smiles. Not smug. Just pleased.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I thought you might say that.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="46" name="Darian_Humming" tags="widget" position="725,600" size="100,100">&lt;&lt;widget &quot;Darian_Humming&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You hum a lot. Were you a musician once?&lt;&lt;/speech&gt;&gt;

Darian pauses, the question catching him mid-thought. He laughs softly—but there&#39;s a heaviness under it, like the air changes just a little.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Yeah... I was. Before all this.&lt;&lt;/speech&gt;&gt;

He glances down at his hands, flexing his fingers like they still remember a different rhythm.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I was trained in opera. Classical stuff. Big stages, packed halls, fancy suits with too much starch in the collars.&lt;&lt;/speech&gt;&gt;

His eyes go distant for a moment.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I used to love it. Music made sense in ways life didn&#39;t. I could climb an aria like a staircase and feel like I&#39;d gone somewhere worth arriving.&lt;&lt;/speech&gt;&gt;

A quiet beat.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;But that was before. Before a lot of things changed.&lt;&lt;/speech&gt;&gt;

He doesn&#39;t say more—not here, not yet—but you can tell the story&#39;s still close behind his smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Now I hum to keep pieces of it close. Not for performance. Just... for me.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="47" name="Darian_StartMinigame" tags="widget" position="850,600" size="100,100">&lt;&lt;widget &quot;Darian_StartMinigame&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I just want to get to know you better.&lt;&lt;/speech&gt;&gt;

Darian tilts his head, his expression unreadable for a moment—thoughtful, maybe a little surprised. Then he smiles, slow and sincere.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;That&#39;s not something I hear very often. At least not from people who mean it.&lt;&lt;/speech&gt;&gt;

He leans against the bar, arms folded lightly.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Alright, then. Let&#39;s talk. But fair warning—I&#39;m not always the easiest book to read.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;darian&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="48" name="Darian_GoPrivate" tags="widget" position="975,600" size="100,100">&lt;&lt;widget &quot;Darian_GoPrivate&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think we could go somewhere more private?&lt;&lt;/speech&gt;&gt;

Darian doesn&#39;t answer immediately. His gaze lingers on you a moment longer than usual, soft but searching.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;We could. If that&#39;s really what you want.&lt;&lt;/speech&gt;&gt;

His voice isn&#39;t challenging—it&#39;s careful, like he wants to be sure you&#39;re not asking just to fill the space between you.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;My room in the hallway upstairs is relatively quiet this time of night, and far more private overall. No one will bother us there.&lt;&lt;/speech&gt;&gt;

He steps forward, extending a hand—not dramatic, not performative. Just steady.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Come on. I&#39;ll walk with you.&lt;&lt;/speech&gt;&gt;

[[You take his hand and follow him.|Darian_GoingUpstairs]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="49" name="Darian_ReturnToParlor" tags="widget" position="1100,600" size="100,100">&lt;&lt;widget &quot;Darian_ReturnToParlor&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I hope you don&#39;t mind, I think I am going to explore the parlor a bit more.&lt;&lt;/speech&gt;&gt;

Darian nods, easy and warm.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Of course. The night&#39;s still young—plenty of stories left to find.&lt;&lt;/speech&gt;&gt;

He gives a small bow of the head and gestures subtly back toward the center of the lounge.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;If you change your mind... you know where to find me.&lt;&lt;/speech&gt;&gt;

[[You walk back to the middle of the parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="50" name="Darian_RoomComment" tags="widget" position="1225,600" size="100,100">&lt;&lt;widget &quot;Darian_RoomComment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I like your room. Are they all like this?&lt;&lt;/speech&gt;&gt;

Darian smiles faintly, glancing around at the heavy curtain-lined walls like he&#39;s seeing them through someone else&#39;s eyes.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Not quite. Each host decorates their own. Some lean decadent. Others lean... chaotic.&lt;&lt;/speech&gt;&gt;

He runs a hand along one of the thick curtains.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;These started as an attempt to make the place feel more like a theater. Turns out, they&#39;re also pretty good at keeping sound in. Which is useful, apparently, because not all the customers enjoy spontaneous arias through the walls.&lt;&lt;/speech&gt;&gt;

He laughs softly, then looks at you with just a hint of that stage-smile beneath the surface.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I try not to take it personally, but I do sing quieter now.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="51" name="Darian_WhatNow" tags="widget" position="100,725" size="100,100">&lt;&lt;widget &quot;Darian_WhatNow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So... what do we do now?&lt;&lt;/speech&gt;&gt;

Darian leans back slightly, resting his hands behind him on the bed. His smile curves just a little, thoughtful rather than teasing.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;That depends on what you need from tonight.&lt;&lt;/speech&gt;&gt;

He shifts to look at you more directly, his tone quiet but grounded.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Some people come here to forget. Others come to feel something real. A few aren&#39;t even sure why they showed up—they just didn&#39;t want to be alone.&lt;&lt;/speech&gt;&gt;

He shrugs—not indifferent, but understanding.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I don&#39;t have a script for this part. We write it together.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="52" name="Darian_HowsYourNight" tags="widget" position="225,725" size="100,100">&lt;&lt;widget &quot;Darian_HowsYourNight&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So how&#39;s your night been? You know... before I showed up and clearly became the highlight of it.&lt;&lt;/speech&gt;&gt;

Darian laughs, low and honest.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Dangerously bold of you to assume you were the highlight at all. I&#39;ll have you know I have been proposed to by &lt;em&gt;three&lt;/em&gt; women tonight.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Only three? Clearly you&#39;re slipping.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;darian&quot;&gt;&gt;One of them offered me a goat in exchange. I almost said yes just to see if she&#39;d actually follow through.&lt;&lt;/speech&gt;&gt;

You both laugh for a moment before the room goes quiet again. The walls absorbing the laughs like they were hungry for it. Darian speaks again through a half-hearted smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;But in truth? It&#39;s been a long night. Not bad. Just... long. The kind that leaves you a little quiet inside.&lt;&lt;/speech&gt;&gt;

He exhales gently, like saying that out loud takes some of the weight off.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Still, you showing up when you did? Definitely helped balance the scales.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="53" name="Darian_AskDeeper" tags="widget" position="350,725" size="100,100">&lt;&lt;widget &quot;Darian_AskDeeper&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I ask you some more personal questions?&lt;&lt;/speech&gt;&gt;

Darian arches a brow, his smile tugging crooked at the edges.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You can—but they won&#39;t come cheap.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh. I, uh... I have coin.&lt;&lt;/speech&gt;&gt;

He laughs softly, shaking his head.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Keep your coin, girl. I meant you&#39;ll pay with answers of your own.&lt;&lt;/speech&gt;&gt;

He leans forward slightly, eyes steady now—no longer teasing.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Fair exchange. You ask. I ask. We both leave a little lighter.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;darian&quot; &quot;DarianDialogueDuet&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;


/*DarianDialogueDuet - Start */
    :: DarianDuet_Bracelet [widget]
    &lt;&lt;widget &quot;DarianDuet_Bracelet&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Tell me about that bracelet.&lt;&lt;/speech&gt;&gt;

    Darian lifts his wrist slightly, glancing at the worn gold band like he forgot it was there. His smile twists—not embarrassed, exactly. Just private.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;That&#39;s not a question.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Alright, fine. Who gave you the bracelet?&lt;&lt;/speech&gt;&gt;

    He runs his thumb over the clasp once. Slowly.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;My sister. The one person who knew me before the stage, before the noise. She made it by hand when we were younger. Said I needed something to wear that wasn&#39;t an act.&lt;&lt;/speech&gt;&gt;

    A beat.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I don&#39;t take it off. Not ever.&lt;&lt;/speech&gt;&gt;

    He lets that linger, then leans slightly closer—eyes on you now, not the bracelet.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;My turn.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Who is this girl wearing royal-cut leather, trying so hard not to be a girl?&lt;&lt;/speech&gt;&gt;

    You freeze.

    It isn&#39;t accusation. It&#39;s observation. Quiet. Precise.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;You carry yourself like a noble, but you look at people like you&#39;re still hoping you can be one of them. That&#39;s not common. Especially not in this city.&lt;&lt;/speech&gt;&gt;

    You open your mouth, but the words come slower than you expect.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re sharp. I am a noble. I don&#39;t get out often enough because of it, so moments like this are special to me. I often wish I was on this side of that wall. Being born never felt much like the gift people make it out to be.&lt;&lt;/speech&gt;&gt;

    Darian&#39;s voice softens.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Keep it up then noble-girl. Perhaps you&#39;ll be a &#39;noble of the people&#39; one day. Gods know we don&#39;t have enough of those. Common folk starve while the rich can eat themselves to bursting.&lt;&lt;/speech&gt;&gt;

    You frown slightly. Darian notices.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I apologize. That wasn&#39;t an accusation. Quite the opposite. Like I said, we need more people like you.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_Performing [widget]
    &lt;&lt;widget &quot;DarianDuet_Performing&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What was it like to travel around performing?&lt;&lt;/speech&gt;&gt;

    Darian leans back against the curtain-lined wall, head tilted, gaze drifting.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Lonely. But rewarding. Like lighting candles in the dark and hoping someone out there is warmed by the glow.&lt;&lt;/speech&gt;&gt;

    He breathes out through his nose, not quite a sigh.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;For a while, my sister traveled with me. She was the pragmatic one. Knew when to rest. Knew when I was pushing too hard. She got sick, though. Had to settle. I stayed close when I could... but life pulls in too many directions.&lt;&lt;/speech&gt;&gt;

    He doesn&#39;t say the rest right away. He just looks down at his hands.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;When she passed, I didn&#39;t even know until days after. No final song. No goodbye. Just... silence. And after that, the stage never felt like it had room for me anymore.&lt;&lt;/speech&gt;&gt;

    He looks solemn for a moment before looking back at you.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Your turn.&lt;&lt;/speech&gt;&gt;

    He looks at you now, not accusing, but searching.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Was it your mother or father?&lt;&lt;/speech&gt;&gt;

    You blink.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;One of them died. I can tell. You speak like someone who carries the absence of a parent like a second name.&lt;&lt;/speech&gt;&gt;

    You hesitate, then lower your gaze.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;My mother. She died giving birth to me.&lt;&lt;/speech&gt;&gt;

    He nods slowly. Not with pity—just understanding.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I thought so. You don&#39;t dress like a girl who was raised by her mother.&lt;&lt;/speech&gt;&gt;

    You glance down at yourself, a soft scoff rising from your throat.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Guess I didn&#39;t realize that was a style now.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Not style. Energy. You dress like someone who had to learn softness the hard way.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_WhyNoctail [widget]
    &lt;&lt;widget &quot;DarianDuet_WhyNoctail&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Why did you start working at the Noctail?&lt;&lt;/speech&gt;&gt;

    Darian gives a short laugh—one with no real humor behind it.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Because there&#39;s no applause in grief. And no stage that wants a broken voice.&lt;&lt;/speech&gt;&gt;

    He shifts, hands clasped loosely in his lap.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;After my sister passed, I couldn&#39;t sing without feeling like the echo was chasing me. I tried. Gods, I tried. But every theater felt too big. Too empty.&lt;&lt;/speech&gt;&gt;

    His voice lowers.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;So I came here. Not because I wanted to be touched, or paid, or even needed... but because I wanted to disappear into something smaller. Something real. Where no one claps when you bleed well.&lt;&lt;/speech&gt;&gt;

    He pauses, then looks around the room—not wistfully, but with something close to gratitude.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Strange thing is... I didn&#39;t disappear. I just stopped performing. And somewhere in the quiet, I started to feel like I belonged again.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;The others here—Adda, Bert, Marie... they became something like family. They don&#39;t need me to dazzle. They just need me to show up. And I can do that.&lt;&lt;/speech&gt;&gt;

    He lets the silence settle. Then:

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Now it&#39;s my turn...Why did *you* come here tonight?&lt;&lt;/speech&gt;&gt;

    You falter—not because you don&#39;t know, but because no one&#39;s asked it quite like that.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Honestly? I&#39;m not sure. I went out tonight because I wanted to drink.&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t let that sit.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;What were you trying to drown?&lt;&lt;/speech&gt;&gt;

    You hesitate, gaze falling.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It&#39;s my birthday.&lt;&lt;/speech&gt;&gt;

    He blinks once, then nods—like it clicks into place.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;My birthdays have never been a happy occasion. Just reminders. Of what&#39;s gone. Of what&#39;s expected. Of what I&#39;ll never quite live up to.&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t interrupt. He just watches you, steady as the curtains lining his room.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Then I&#39;m glad you came here. And I hope, just for tonight... you get to forget every bit of that.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_StageLove [widget]
    &lt;&lt;widget &quot;DarianDuet_StageLove&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Did you ever fall in love on stage?&lt;&lt;/speech&gt;&gt;

    Darian laughs, the sound low but fond—like a memory he&#39;s already forgiven himself for.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Far too many times. It&#39;s a dangerous thing, singing love into the dark and pretending you don&#39;t mean it.&lt;&lt;/speech&gt;&gt;

    He leans forward, elbows on knees.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I fell for duets, for glances across the wings, for the way some people touched your hand like it was the first time &lt;strong&gt;every&lt;/strong&gt;time. But the stage is a mirror, not a home. Love there doesn&#39;t last—it just echoes.&lt;&lt;/speech&gt;&gt;

    His smile falters, just slightly.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Still, I&#39;d be lying if I said I didn&#39;t chase it. And some of those moments? They were real. Even if they didn&#39;t survive the final bow.&lt;&lt;/speech&gt;&gt;

    He meets your gaze again.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;My turn.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;When was the last time someone looked at you and didn&#39;t want something?&lt;&lt;/speech&gt;&gt;

    The question hits deeper than you expect. You try to answer—but nothing comes right away.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I... don&#39;t know.&lt;&lt;/speech&gt;&gt;

    You smile, but it&#39;s brittle.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Maybe that&#39;s why I&#39;m here.&lt;&lt;/speech&gt;&gt;

    Darian watches you for a breath, then nods. The air between you shifts—quieter now, but fuller.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Then I hope I&#39;m not the exception. Just the reminder you deserved.&lt;&lt;/speech&gt;&gt;

    He says it without ceremony. No smile. No teasing tone. Just truth.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;That you&#39;re still worth looking at... without wanting to take anything away.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_MissOldLife [widget]
    &lt;&lt;widget &quot;DarianDuet_MissOldLife&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you ever miss the life you had before all this?&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t answer right away. His gaze drops—not distant, but inward. Like he&#39;s checking a wound to see if it still stings.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;No. Not exactly.&lt;&lt;/speech&gt;&gt;

    He leans back, the curtain behind him pressing in like quiet velvet.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I remember it fondly. The stages. The travel. The music. The way it all felt like I was part of something larger than myself.&lt;&lt;/speech&gt;&gt;

    A pause.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;But missing it... that would mean wanting it back. And I know what it would cost to have that again.&lt;&lt;/speech&gt;&gt;

    He taps the bracelet lightly with one finger.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I don&#39;t need the stage. I needed her. The rest was just echo.&lt;&lt;/speech&gt;&gt;

    He glances at you—not fragile, but stripped down to something real.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Your turn. Where would you go if you didn&#39;t have to be anyone tonight?&lt;&lt;/speech&gt;&gt;

    You think on it for a moment.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Poor choice of question. It answers itself don&#39;t you think? This was my attempt at not being anyone tonight. Yet it still feels like running away from something rather than being something else.&lt;&lt;/speech&gt;&gt;

    Darian smiles gently.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Then maybe it&#39;s not about being something else. Maybe it&#39;s about letting yourself &lt;strong&gt;be&lt;/strong&gt;, without needing a title to go with it.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_MostBeautiful [widget]
    &lt;&lt;widget &quot;DarianDuet_MostBeautiful&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What&#39;s the most beautiful thing you&#39;ve ever seen?&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t answer immediately. When he does, it&#39;s without flourish.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Oh I remember. Once after a show I found myself not quite able to go to sleep, so I went out and explored the city. The theater I had been in, I learned, was brand new because the old one in the city had burned down. Rather than build on top of the ashes, the town left the old theater still standing. I made a mission of finding it.&lt;&lt;/speech&gt;&gt;

    He smiles faintly, the memory distant but polished.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I found the old theater a few blocks away and was terrified upon my approach because I heard a truly haunting voice coming from within. I&#39;ve no clue what came over me because despite thinking it must be haunted I was drawn inside like a sailor to a siren. There was no vengeful spirit though, just a girl standing on the remnants of the old stage, singing her heart out to an empty theater, now an audience of one. Her voice cracked halfway through, and she laughed at herself. Kept singing anyway. That was years ago. I never learned her name. But I still remember how the sound carried through the rain.&lt;&lt;/speech&gt;&gt;

    He turns to you now—softer, but not fragile.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;What about you? What moment do you carry around when the world&#39;s too loud?&lt;&lt;/speech&gt;&gt;

    You breathe in, slow. A flicker of something rises—small, strange, but real.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;There&#39;s a well behind the old barracks. When I was a child, I used to sit there and listen to the wind echo down the stone. It sounded like a voice trying to remember a song it had almost forgotten.&lt;&lt;/speech&gt;&gt;

    Darian&#39;s gaze doesn&#39;t waver.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Maybe that&#39;s what we are, then. Songs trying to remember themselves.&lt;&lt;/speech&gt;&gt;

    You laugh at him, not cruelly. 

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You are so full of cheesey clichés.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: ReturnToDarianPhase1 [widget]
    &lt;&lt;widget &quot;ReturnToDarianPhase1&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Let&#39;s talk about something else.&lt;&lt;/speech&gt;&gt;

    Darian nods once, as if to say: *Of course.*

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;The world will still be waiting for us after the quiet. No need to rush back into it.&lt;&lt;/speech&gt;&gt;

    He leans back slightly, letting the moment stretch just long enough to breathe.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;So... what else would you like to know?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase1&quot;&gt;&gt;
    &lt;&lt;/widget&gt;&gt;
/* DarianDialogueDuet - End */</tw-passagedata><tw-passagedata pid="54" name="Darian_AskToKiss" tags="widget" position="475,725" size="100,100">&lt;&lt;widget &quot;Darian_AskToKiss&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I kiss you?&lt;&lt;/speech&gt;&gt;

Darian doesn&#39;t respond immediately. He watches you for a moment, the playful glint in his eyes softening into something steadier.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You could have, you know. Without asking.&lt;&lt;/speech&gt;&gt;

He says it gently—not dismissively, but as if to say *you don&#39;t need permission to be kind.*

&lt;&lt;speech &quot;darian&quot;&gt;&gt;But I&#39;m glad you did.&lt;&lt;/speech&gt;&gt;

He leans forward—not fast, not hesitant—and meets you halfway.

The kiss is quiet. Warm. Intentional. The kind that doesn&#39;t ask for anything back.

His hand brushes your cheek like he&#39;s trying to memorize its shape. When the kiss breaks, he doesn&#39;t move far—just far enough to breathe.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Well... that ruined me a little.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could we take it further?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You don&#39;t need to as—&lt;&lt;/speech&gt;&gt;

You kiss him again. More passionately.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;StartSexScene &quot;darian&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Darian_PostSexPhase1&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="55" name="Darian_MusicRequest" tags="widget" position="600,725" size="100,100">&lt;&lt;widget &quot;Darian_MusicRequest&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;p&gt;You glance around the room, then back at Darian. The question escapes you before you can second-guess it.&lt;/p&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Would it be too much trouble... to pass the time with some music?&lt;&lt;/speech&gt;&gt;

For a moment, Darian doesn&#39;t speak. He just watches you. Not guarded—but still. Like you&#39;ve opened a door he hasn&#39;t walked through in years.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You&#39;re the first person who&#39;s asked that in a long time.&lt;&lt;/speech&gt;&gt;

[[He gives you a warm, welcoming smile.|Darian_MusicMontage]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="56" name="Dummy_Placeholder_Locked" tags="widget" position="725,725" size="100,100">&lt;&lt;widget &quot;Dummy_Placeholder_Locked&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;em&gt;This option is currently locked.&lt;/em&gt;
  &lt;&lt;/append&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="57" name="Harroc_OrderDrink" tags="widget" position="850,725" size="100,100">&lt;&lt;widget &quot;Harroc_OrderDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could I get a drink, please?&lt;&lt;/speech&gt;&gt;

  Harroc pauses mid-wipe on a tankard, eyes sliding to meet yours without turning his head. His voice is steady, low.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;You could. But that didn&#39;t sound like someone who *wants* a drink. Try again.&lt;&lt;/speech&gt;&gt;

  You blink. He doesn&#39;t look angry—just expectant. Testing.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;...Alright. I want a drink. Something strong. Something that proves I&#39;m not just a girl in a dress, out past her bedtime.&lt;&lt;/speech&gt;&gt;

  That gets the faintest grunt of approval. He sets the mug down and turns away to pour.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Better.&lt;&lt;/speech&gt;&gt;

  He slides a dark, frothy brew toward you. The mug is heavy, the liquid inside smelling faintly of burnt caramel and black pepper.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Locals call it Emberjaw. Kicks harder than it starts. Like most things worth finishing.&lt;&lt;/speech&gt;&gt;

  You take a sip—it hits your tongue smooth, then sears your throat with a trailing warmth. You try not to cough.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s... intense.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;That&#39;s the idea.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="58" name="Harroc_RecentEvents" tags="widget" position="975,725" size="100,100">&lt;&lt;widget &quot;Harroc_RecentEvents&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Has it always been this quiet in here?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;No.&lt;&lt;/speech&gt;&gt;

  He doesn&#39;t elaborate. Just goes back to wiping the rim of a thick mug, gaze drifting over the room without much interest.

  You wait a beat. Then try again.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Is it just... one of those nights, or is something going on?&lt;&lt;/speech&gt;&gt;

  Harroc finally shrugs. Not dismissive—just honest.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Fair starts tomorrow. Most folk are home, saving coin or nursing livers. Fewer fights that way. Easier cleanup.&lt;&lt;/speech&gt;&gt;

  He sets the mug down and grabs another without looking at you.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Two nights from now, this place&#39;ll smell like sweat, cheap wine, and regret. Tonight&#39;s just the pause.&lt;&lt;/speech&gt;&gt;

  A log pops loudly in the hearth behind you. He doesn&#39;t react.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="59" name="Harroc_OpenShop" tags="widget" position="1100,725" size="100,100">&lt;&lt;widget &quot;Harroc_OpenShop&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you have a food menu, or is it just drinks?&lt;&lt;/speech&gt;&gt;

  Harroc doesn&#39;t stop what he&#39;s doing—just gestures with a thick thumb toward a chalkboard hung crooked on the wall behind him.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Menu&#39;s there. Three kinds of stew. Bread if it&#39;s not gone. Couple of pickled things in jars. Mostly drinks though.&lt;&lt;/speech&gt;&gt;

  He grabs a bottle, uncorks it, sniffs it, and nods to himself.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;People don&#39;t come here for variety. They come because it stays open, and I don&#39;t water anything down.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.openShop(&quot;harroc&quot;)&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="60" name="Harroc_Rumors" tags="widget" position="1225,725" size="100,100">&lt;&lt;widget &quot;Harroc_Rumors&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Aside from the fair, you heard about anything interesting lately?&lt;&lt;/speech&gt;&gt;

  Harroc doesn&#39;t look up, just sets a clean mug down on the bar with a dull *clunk*.  

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Aside from the usual bounty-hunter and underworld nonsense, the city&#39;s been quiet. Think either everything&#39;s going fine, which it&#39;s usual not, or the city is just holding its breath waiting for something to happen.&lt;&lt;/speech&gt;&gt;

  You give him an eyebrow.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What do you mean about the underworld nonsense.&lt;&lt;/speech&gt;&gt;

  Harroc finally looks up at you, as serious as you have seen him tonight.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Don&#39;t you go worrying about that, not something you should muddy yer&#39; boots with.&lt;&lt;/speech&gt;&gt;  

  His tone seems final, and you decide not to press the issue. The criminal element in Bastion is something you always knew existed, but no matter who you ask, you never manage to learn much about it.

  He picks up another mug. Starts wiping again.  

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What about the bounty hunter stuff?&lt;&lt;/speech&gt;&gt;

  He doesn&#39;t quite sigh so much as deflate a little.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Want to know about that? Talk to the fella in the corner over there. Think he&#39;s with the guild.&lt;&lt;/speech&gt;&gt;

  He moves onto the next mug with his rag.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Somethin&#39; else, girl?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;harroc&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="61" name="Harroc_Phase0_Goodbye" tags="widget" position="100,850" size="100,100">&lt;&lt;widget &quot;Harroc_Phase0_Goodbye&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You offer Harroc a small nod.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I&#39;ll let you get back to it.&lt;&lt;/speech&gt;&gt;

He grunts in acknowledgment, still polishing the same mug with practiced, absent motions. The clink of glass and quiet murmur of voices fills the space as you turn away.

&lt;&lt;if not $TalkedTo_Harroc&gt;&gt;
  &lt;&lt;set $TalkedTo_Harroc = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You walk back toward the main area of the tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="62" name="Marie_Howareyoudoing" tags="widget" position="225,850" size="100,100">&lt;&lt;widget &quot;Marie_Howareyoudoing&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I&#39;m Jaylie, by the way.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;know &quot;marie&quot;&gt;&gt;&lt;&lt;speech &quot;marie&quot;&gt;&gt; Marie.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; How are you doing?&lt;&lt;/speech&gt;&gt;
    
    Her face twists in annoyance. Likely more than she even intended.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt; Oh just wonderful. This night is going so well. Can&#39;t you tell?&lt;&lt;/speech&gt;&gt;
    You frown at her sarcasm. She isn&#39;t looking at you, but you felt her eyes roll.
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;set $marieCanApologize = true&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="63" name="Marie_ToughNight" tags="widget" position="350,850" size="100,100">&lt;&lt;widget &quot;Marie_ToughNight&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    You try softening your tone, hoping to break through whatever storm is brewing behind her eyes.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Looks like you&#39;ve had a rough night.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Is it the scowl, the clenched jaw, or the ‘go away&#39; energy that gave it away?&lt;&lt;/speech&gt;&gt;

    She exhales through her nose. Not quite a laugh, not quite a sigh.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Either way, ten points to you for perception.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;set $marieCanApologize = true&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="64" name="Marie_SilentTreatment" tags="widget" position="475,850" size="100,100">&lt;&lt;widget &quot;Marie_SilentTreatment&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    You glance at her, then at the space between you both. It stretches like a wall you can&#39;t climb.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You know, if it helps, you can talk to me about what happened. I&#39;ve been told I can be a good listener.&lt;&lt;/speech&gt;&gt;

    Marie doesn&#39;t answer at first. Just blinks slowly, then tilts her head ever so slightly in your direction.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t need to talk about it. Especially to strangers who sit next to me like I&#39;m a stray cat that needs saving.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;set $marieCanApologize = true&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="65" name="Marie_ImSorryIllGo" tags="widget" position="600,850" size="100,100">&lt;&lt;widget &quot;Marie_ImSorryIllGo&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    Obviously not getting anywhere, with her you get up to leave.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I&#39;m gonna go. I hope your night gets a little better.&lt;&lt;/speech&gt;&gt;
    
    You turn to leave and make it only a step before you feel a hand on your hand, soft and warm. You turn and look back at the girl. Her eyes meet yours for the first time.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;I&#39;m sorry, Jaylie. That&#39;s not who I am. That man just really brought the worst out of me. Think we can start again?&lt;&lt;/speech&gt;&gt;

    You hesitate for a brief moment, then smile and nod at her. She gently pulls your hand, guiding you back to the couch.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you for trying to check on me.&lt;&lt;/speech&gt;&gt;

    She smiles. It looks a little forced, but you can tell she is genuinely trying.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;I&#39;m sorry. This isn&#39;t how I normally am. It&#39;s just been... a night. But I&#39;d like to start over, if you don&#39;t mind.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; Don&#39;t worry about it at all. I definitely have my bad days too, but nothing like what you have to deal with.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 2&gt;&gt;
  &lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase1&quot;&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Marie Phase 1 Dialogue Options */</tw-passagedata><tw-passagedata pid="66" name="Marie_WhyThisWork" tags="widget" position="725,850" size="100,100">&lt;&lt;widget &quot;Marie_WhyThisWork&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Why did you choose this kind of work?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Chose? That&#39;s generous. I chose not to starve. Turns out I&#39;m good at more than surviving, though. I learned how to turn the game in my favor.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;bg &quot;Scene02_LessAngryHost&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="67" name="Marie_HostsOrFriends" tags="widget" position="850,850" size="100,100">&lt;&lt;widget &quot;Marie_HostsOrFriends&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Are the other hosts your friends... or just coworkers?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Depends on who you ask, probably. Generally though, these are really good people. Some better than others. We definitely fight, step on each other&#39;s toes sometimes maybe. These people are the one&#39;s who pull you out after a long night though. It helps that Mistress Adda is a very good boss.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I can imagine how that would make a big difference. I can&#39;t imagine doing this job surrounded by people you don&#39;t trust or like.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="68" name="Marie_DoYouLikeItHere" tags="widget" position="975,850" size="100,100">&lt;&lt;widget &quot;DoYouLikeItHere&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you like it here? The Nuzzling Noctail, I mean.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Days like today I don&#39;t, but I have to remember that there are far worse establishments in the city. Worse jobs altogether, really. 
  
  Honestly though the good people do outnumber the bad. The bad just tend to make sure they are more memorable.
  
  I go to bed at night with a full belly, and coin in my purse though. I also can&#39;t think of anywhere else I would rather be working.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="69" name="Marie_LivedAnywhereElse" tags="widget" position="1100,850" size="100,100">&lt;&lt;widget &quot;Marie_LivedAnywhereElse&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Have you ever lived or traveled outside the city?&lt;&lt;/speech&gt;&gt;

  Marie&#39;s expression lights up and she genuinely smiles for a moment. 

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I was born in Albcorr, actually. I don&#39;t remember it very well. My family moved here when I was very little. Sometimes I have dreams though... I think they are memories. The tall trees. The green fields. The open sky, not choked with chimney smoke.&lt;&lt;/speech&gt;&gt;

  Her smile fades a little, but you can still tell she is thinking about it fondly.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I&#39;ve saved my coin for years. I want to go back one day. I want to see the trees. I want to &lt;strong&gt;CLIMB&lt;/strong&gt; one. I want to sleep out in the fields covered only by a blanket of stars. Go so far away from the city that the only voice I would ever have to hear is my own... or maybe a friend&#39;s&lt;&lt;/speech&gt;&gt;

  She glances at you, and smiles warmly.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Well, all you had to do was ask. Let&#39;s go now!&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh, sure let&#39;s go, my bags are packed!&lt;&lt;/speech&gt;&gt;

  As if waiting for this, lightning strikes somewhere in the distance, thunder lightly rumbles the building. Crystal and glass chime and tink for a moment.

  You and marie look at each other with straight faces, the burst into simultaneous laughter.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Okay maybe not tonight. But I could be the friend one day.&lt;&lt;/speech&gt;&gt;

  Marie scrunches her shoulder to her chin and gives you a playful look.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt; You promise, friend?&lt;&lt;/speech&gt;&gt;

  You both laugh again.
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="70" name="Marie_TheFairTomorrow" tags="widget" position="1225,850" size="100,100">&lt;&lt;widget &quot;Marie_TheFairTomorrow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Are you looking forward to the fair tomorrow?&lt;&lt;/speech&gt;&gt;
 
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh definitely! I love the fair. I don&#39;t have to work the mornings, so I will spend most of my time looking at all the foreign jewellry and animals most likely. Then if I am lucky, maybe I&#39;ll meet some hunky foreigner for the evening.&lt;&lt;/speech&gt;&gt;

  You both laugh at the thought.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I hope they treat you like a queen for the day.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;How about you? Will you be in attendence tomorrow?&lt;&lt;/speech&gt;&gt;

  Your face falls a bit. The question was fair play, and still somehow catches you off guard. Summoning thoughts of your mom.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;The fair is always a little hard for me. Reminds me a lot of my mom. She died right around this time of year... When I was born actually.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh I am sorry to hear that. So you never got to know her?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Well not for a long time. But around the time I was about eight my dad started telling me more stories about her. She was the best type of person to exist. She was a healer. Dedicated her life to helping others.&lt;&lt;/speech&gt;&gt;

  You frown a little. A tear wells in the corner of your eye. Marie notices and reaches out, wiping it away with her thumb. She cups your cheek and just smiles. You reach up and grab her hand, wrapping her fingers in yours and pulling it down to your lap. 

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It was nice being able to learn about who she was, but sometimes it was still hard, because then I always felt like I had to live up to her standards. I&#39;m afraid I could live a hundred lifetimes though and never be half the woman she was.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Well if it&#39;s any consolation, you are making my night better. You couldn&#39;t be all bad.&lt;&lt;/speech&gt;&gt;

  You laugh a little, a short hearty chuckle. You trace her knuckle with your thumb.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re not so bad yourself.&lt;&lt;/speech&gt;&gt;

  She lets out a sharp chuckle and slaps your hand lightly.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh I know I&#39;m a right bitch sometimes. But I do try to be a good person.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 8&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="71" name="Marie_StartMinigameOne" tags="widget" position="100,975" size="100,100">&lt;&lt;widget &quot;Marie_StartMinigameOne&quot;&gt;&gt;

  &lt;&lt;append #convoBox&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If you don&#39;t mind, I would really like to get to know you better.&lt;&lt;/speech&gt;&gt;
    
    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh Gods. I am sure that you&#39;d be happier talking to someone else around here.&lt;&lt;/speech&gt;&gt;

    You grin at her. She looks back at you and her lips crack into a sly smile.
    
    &lt;&lt;speech &quot;marie&quot;&gt;&gt;...but if you *really* want to know me, don&#39;t say I didn&#39;t warn you.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;marie&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="72" name="Marie_GoUpstairs" tags="widget" position="225,975" size="100,100">&lt;&lt;widget &quot;Marie_GoUpstairs&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Hey do you by chance—&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Want to go somewhere more private? I have just the place upstairs.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You read my mind. Lead the way.&lt;&lt;/speech&gt;&gt;

    You and Marie stand from your velvet couch and she takes you by the hand, leading you through the parlor, back towards the entrance. You pass through the heavy velvet curtain and make your way up the stairs. The air thickens even more with the smell of incense and perfume as you ascend.

    At the top of the stairs, Marie leads you down a long, narrow hallway before stopping at a non-descript door. She opens it and gestures for you to enter first.

    [[You enter Marie&#39;s room.|Marie_UpstairsPhase1]]
    &lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="73" name="Marie_Phase1Goodbye" tags="widget" position="350,975" size="100,100">&lt;&lt;widget &quot;Marie_Phase1Goodbye&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk more later.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Sure. I&#39;ll be here. Try not to get swallowed by the velvet in the meantime.&lt;&lt;/speech&gt;&gt;

[[Leave Marie and Return to the Parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Marie Phase 2 Start */</tw-passagedata><tw-passagedata pid="74" name="Marie_RoomComment" tags="widget" position="475,975" size="100,100">&lt;&lt;widget &quot;Marie_RoomComment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I really like your room. Do they all look like this?&lt;&lt;/speech&gt;&gt;

Marie looks at you like you&#39;ve just said something suspicious. She glances around her own space, then back at you with a raised brow.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;You like *this* room? With the busted light sconce and the “aesthetic” wall stain I&#39;ve covered with a bookshelf?&lt;&lt;/speech&gt;&gt;

You laugh softly.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Yeah. There&#39;s not a lot here—but what is here says a lot about you. Most people in your position wouldn&#39;t be able to read let alone fill their time with philosophy, art, and history. Also your bookshelf did its job. I had no clue about the stain.&lt;&lt;/speech&gt;&gt;

Marie lets out a small chuckle– a short, quick huff of air through her nose– and stares at you for a beat longer than necessary. You realize that you possibly just betrayed a piece of your &#39;cover&#39; which had not been exposed before. You feel Marie&#39;s eyes look you up and down. They are not cold, just... uncertain. Then she leans back a little against the wall, her voice softening.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Well. That&#39;s either the smoothest deflection I&#39;ve heard tonight... or the first honest thing.&lt;&lt;/speech&gt;&gt;

She doesn&#39;t press it. But she doesn&#39;t look away either.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase2()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="75" name="Marie_WhatNow" tags="widget" position="600,975" size="100,100">&lt;&lt;widget &quot;Marie_WhatNow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What do you want to do now?&lt;&lt;/speech&gt;&gt;

Marie turns her head slightly, eyes narrowing in mild amusement. Not mocking—just thoughtful.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t mean to sound indifferent, but you are the own who pays to be here.&lt;&lt;/speech&gt;&gt;

She stretches her legs out a bit, brushing her fingers along the edge of the quilt like she&#39;s grounding herself in the fabric.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;That usually makes you the one who gets to decide.&lt;&lt;/speech&gt;&gt;

There&#39;s a pause. Just long enough to let the implication settle.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;But if you&#39;re asking because you *actually* care what I want...&lt;&lt;/speech&gt;&gt;

She glances at you, eyes sharp but not unkind.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;...then I&#39;d say: talk a little, sit a little, maybe let the night happen slowly for once.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase2()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="76" name="Marie_TalkAboutIt_Success" tags="widget" position="725,975" size="100,100">&lt;&lt;widget &quot;Marie_TalkAboutIt_Success&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you want to talk about what happened outside?&lt;&lt;/speech&gt;&gt;

Marie exhales slowly through her nose and tilts her head back against the wall. Her eyes drift toward the ceiling like she&#39;s counting breaths—or deciding if she wants to let them out.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Kallot and I… it&#39;s complicated.&lt;&lt;/speech&gt;&gt;

She lets that hang for a moment before continuing, voice quiet but clear.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;He&#39;s not usually like that. He&#39;s kind. Gentle. The kind of drunk who rambles about stars and apologizes for existing too much. But tonight he was…&lt;&lt;/speech&gt;&gt;

She trails off, shakes her head once.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;He was angry. Dismissive. I&#39;ve never seen him like that. I thought maybe he came to see me—but it was like I wasn&#39;t even there.&lt;&lt;/speech&gt;&gt;

Her fingers curl into the edge of the quilt again.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I want to forgive him. I do. But I don&#39;t understand why he was like that. Why he *chose* to be like that.&lt;&lt;/speech&gt;&gt;

She finally looks at you. Really looks at you.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;You ever see someone you care about... shift into someone you don&#39;t recognize? Just long enough to scare you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;marie&quot; &quot;TheFight&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;
  /* Marie Talk about TheFight Branch - Start */
  :: Marie_Fight_HowLong [widget]
  &lt;&lt;widget &quot;Marie_Fight_HowLong&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;How long have you and Kallot been... whatever you are?&lt;&lt;/speech&gt;&gt;

  Marie lifts one eyebrow at the phrasing, but there&#39;s no venom in it. Just tired humor.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;That&#39;s one way to put it.&lt;&lt;/speech&gt;&gt;

  She draws her legs up slightly and rests her chin on her knees, eyes fixed on the opposite wall as she answers.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;We met about a year ago. He came to the brothel drunk one night, but not... messy. Just lonely. Sad in this quiet, polite kind of way that made me feel like I couldn&#39;t be mean to him, even if I wanted to.&lt;&lt;/speech&gt;&gt;

  She gives a faint, private smile.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;He didn&#39;t even ask for anything. Just talked to me. Listened too. Came back the next week with a book he thought I&#39;d like. Some old thing about myths from the Inner Isles. It had footnotes. He highlighted the wrong parts, but still—&lt;&lt;/speech&gt;&gt;

  She stops herself, looking back to you.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Anyway. It just kind of happened. We&#39;d talk. Sometimes he&#39;d hold my hand. Sometimes I&#39;d let him fall asleep on my shoulder. I don&#39;t know what to call that, but… it was something.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Marie_Fight_Intent [widget]
  &lt;&lt;widget &quot;Marie_Fight_Intent&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think he meant to hurt you?&lt;&lt;/speech&gt;&gt;

  Marie&#39;s jaw tightens slightly. She doesn&#39;t answer right away. When she finally does, it&#39;s with a kind of careful quiet, like she&#39;s placing each word on a scale.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;No.&lt;&lt;/speech&gt;&gt;

  A beat.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t think so. Not *like that.*&lt;&lt;/speech&gt;&gt;

  She folds her arms across her chest, not defensive—more like she&#39;s holding herself in place.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;He&#39;s never laid a hand on me. Not when I didn&#39;t want him to. He&#39;s the type to apologize if his elbow brushed me by mistake. That&#39;s... who I thought he was.&lt;&lt;/speech&gt;&gt;

  She exhales slowly, the breath catching on something unsaid.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;But words? Being cold? Acting like I was a stranger? I think maybe part of him *did* want to push me away. And maybe that part didn&#39;t care how much it would sting.&lt;&lt;/speech&gt;&gt;

  She doesn&#39;t cry. She doesn&#39;t need to.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Sometimes people hurt you just enough that you&#39;ll walk away... so they won&#39;t have to.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I hope this doesn&#39;t come across like I am trying to defend his actions. He hurt you and it&#39;s okay for you to feel like that, but maybe he did have something extra going on. Something that made him act out like that. I don&#39;t know him, obviously, but maybe there is more to the story that only Kallot knows.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 2&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;


  :: Marie_Fight_Pattern [widget]
  &lt;&lt;widget &quot;Marie_Fight_Pattern&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Has he ever scared you before tonight?&lt;&lt;/speech&gt;&gt;

  Marie&#39;s mouth pulls into a line—not frowning, just thoughtful. She glances toward the door, then back at you.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;No. Not once.&lt;&lt;/speech&gt;&gt;

  She shifts slightly on the bed, fingers fidgeting with the corner of the quilt.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Even when he drinks, he&#39;s... careful. Polite, even. If anything, he&#39;s usually the one looking scared—like he&#39;s afraid of taking up too much space.&lt;&lt;/speech&gt;&gt;

  She pauses, then adds with a lowered voice:

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I know he&#39;s tied up in something. Work, maybe. Maybe worse. He&#39;s never said it outright, but I&#39;ve heard names. Watched the way he changes when certain people come around.&lt;&lt;/speech&gt;&gt;

  She meets your eyes now, steady and certain.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;But even then, he never raised his voice. Never made me flinch. That&#39;s why tonight was...&lt;&lt;/speech&gt;&gt;

  She exhales through her nose.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;It felt like looking at a stranger wearing someone I cared about.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;/append&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;
  
  :: Marie_Fight_Forgiveness [widget]
  &lt;&lt;widget &quot;Marie_Fight_Forgiveness&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think you&#39;ll talk to him again after this?&lt;&lt;/speech&gt;&gt;

  Marie doesn&#39;t answer right away. She draws one leg beneath her, adjusting her posture like the question physically shifted her balance.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t know.&lt;&lt;/speech&gt;&gt;

  Her voice isn&#39;t cold—it&#39;s honest. Worn a little thin at the edges.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I want to. Part of me does, anyway. The part that still believes this was... an outlier. A bad night. Something explainable.&lt;&lt;/speech&gt;&gt;

  She looks down at her hands, thumbs idly tracing one another.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;But if I open that door and he&#39;s still wearing that same face—the one from tonight—I don&#39;t think I could pretend it didn&#39;t scare me.&lt;&lt;/speech&gt;&gt;

  She swallows. Not hard. Not dramatic. Just a quiet moment of choosing her next words carefully.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I think forgiveness is easier when you understand *why* someone hurt you. When you can file it under something that makes sense. But right now... I&#39;ve got nothing to file it under.&lt;&lt;/speech&gt;&gt;

  She glances back at you with a faint, almost bitter smile.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Maybe that&#39;s the hardest part. Not the pain. The silence that follows it.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Jaylie_Helped_Kallot [widget]
  &lt;&lt;widget &quot;Jaylie_Helped_Kallot&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I helped him, you know...&lt;&lt;/speech&gt;&gt;

  Marie tilts her head slightly, curious but guarded.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;You what?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Out on the pavement I mean. You hit him really good and he was bleeding so I pulled him to the alley, out of the rain and put a bandage on his head. When I did he woke up for a second and smiled at me long enough to tell me my hair was pretty.&lt;&lt;/speech&gt;&gt;

  You nod slowly, thinking back to that rain-drenched street. The weight of his body. The blood. The way he smiled, even half-conscious.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I didn&#39;t know him. I didn&#39;t know you. He just looked like he wouldn&#39;t do so well if he was left out there.&lt;&lt;/speech&gt;&gt;

  Marie doesn&#39;t speak for a few seconds. Her gaze drifts—not away from you, but somewhere distant. Somewhere inside.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;That sounds like him. I nearly killed him, and there he was smiling about it like an idiot.&lt;&lt;/speech&gt;&gt;

  She gives a quiet laugh. It&#39;s not bitter.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you... For not leaving him, not walking past.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 4&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 4&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Marie_Fight_Backstory [widget]
  &lt;&lt;widget &quot;Marie_Fight_Backstory&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What were you like before all this? Before the Noctail?&lt;&lt;/speech&gt;&gt;

  Marie blinks, clearly caught off guard—not upset, just surprised by the question.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;That&#39;s... not something people usually ask.&lt;&lt;/speech&gt;&gt;

  She looks down for a moment, pulling her knees in closer to her chest as if the question peeled away some layer of armor.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I was quieter, believe it or not. Not in the sulking-in-a-corner way, just... always in my head. I used to read in stairwells, write notes in margins. I wanted to be a scribe, maybe. Work in a library. Somewhere with ink stains and silence and no customers to please.&lt;&lt;/speech&gt;&gt;

  A small smile tugs at her mouth—genuine, if faint.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I was also naïve. Thought I could change the world with enough wit and well-placed sarcasm. Thought people would see value in me just because I was smart and sharp and didn&#39;t take shit from anyone.&lt;&lt;/speech&gt;&gt;

  She looks at you then, more open than before. Not vulnerable—just honest.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Turns out, none of that pays rent. But it still lives in here.&lt;&lt;/speech&gt;&gt;

  She taps two fingers gently against her temple.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;And some nights, like this one... I let her back out, just for a little while.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 2&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Marie_Fight_Exit [widget]
  &lt;&lt;widget &quot;Marie_Fight_Exit&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk about something else, if you&#39;d like.&lt;&lt;/speech&gt;&gt;

  Marie exhales through her nose—not in annoyance, but relief. Not because the conversation was too much, but because you knew when to let go.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Thanks. It&#39;s not that I mind talking about it... just sometimes you don&#39;t realize how heavy something is until you say it out loud.&lt;&lt;/speech&gt;&gt;

  She adjusts her posture slightly, her tone lighter now—like she&#39;s shaking off a weight but not ignoring it.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Besides, this was supposed to be your night, wasn&#39;t it?&lt;&lt;/speech&gt;&gt;

  There&#39;s a faint smile. Not a performance. Just a moment of softness.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;So... what do you want to talk about instead?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase2&quot;&gt;&gt;
  &lt;&lt;/widget&gt;&gt;
/* End of TheFight Branch */</tw-passagedata><tw-passagedata pid="77" name="Marie_TalkAboutIt_Fail" tags="widget" position="850,975" size="100,100">&lt;&lt;widget &quot;Marie_TalkAboutIt_Fail&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you want to talk about what happened outside?&lt;&lt;/speech&gt;&gt;

Marie&#39;s expression hardens immediately—not dramatically, but enough to feel the shift. Her jaw tightens. Her eyes narrow just slightly.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you for offering, but I think that I am just going to let it simmer a little longer. I don&#39;t mean any offense, but I hope you understand.&lt;&lt;/speech&gt;&gt;

She seems sincere, and you aren&#39;t about to push it any further.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;No problem. If you change your mind let me know. Otherwise let&#39;s just try to enjoy the rest of the night.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you, Jaylie.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase2()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="78" name="Marie_AskToTouch" tags="widget" position="975,975" size="100,100">&lt;&lt;widget &quot;Marie_AskToTouch&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I touch you?&lt;&lt;/speech&gt;&gt;

Marie blinks, her breath catching just slightly. Not from fear—but from the weight of the question. You can see it in the way she looks at you now. Like she&#39;s measuring something. Like no one&#39;s asked her *that* before—not like this.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;You&#39;re... asking?&lt;&lt;/speech&gt;&gt;

She says it softly, more observation than surprise. Her voice drops to a hush, and she leans in—just enough that you feel the warmth between you shift.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Of course. I don&#39;t really know another way.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thats the most innocent thing I think I have ever heard in this room.&lt;&lt;/speech&gt;&gt;

She extends one hand toward you, palm open, fingers still. Waiting.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Go on, then. Just... be gentle.&lt;&lt;/speech&gt;&gt;

You take her hand. She doesn&#39;t pull away.

She just holds it there, eyes never leaving yours, her thumb brushing once—light as breath—against your skin.

With your other hand you reach up to her cheek and gently caress the softness of her face. As you do she leans into your hand slightly, like a cat excited to be touched. You lean towards her. She follows your lead.

When your lips melt you have a hard time thinking the best way to describe the sensation. Not explosions, not passion. The closest thing that comes to mind is contentment. You hold the position for a moment that feels much longer than it likely was, your lips locked together.

When you pull apart Marie does not look directly at you, but speaks downward, her breath shorter than you&#39;d expect it to be.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Lay down on your back.&lt;&lt;/speech&gt;&gt;

You don&#39;t hesitate to comply.



&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 2&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;StartSexScene &quot;marie&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Marie_PostSexPhase1&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="79" name="Marie_LayAndTalk" tags="widget" position="1100,975" size="100,100">&lt;&lt;widget &quot;Marie_LayAndTalk&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If it&#39;s alright... I think I&#39;d just like to lay here with you.&lt;&lt;/speech&gt;&gt;

Marie doesn&#39;t answer right away. She shifts slightly, thoughtful, and then—surprisingly—smiles.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Yeah. That actually sounds... really nice.&lt;&lt;/speech&gt;&gt;

She scoots back and folds the blanket down beside her. The gesture is plain, but there&#39;s something careful in it. She&#39;s not offering a show. She&#39;s offering *space*.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Just don&#39;t snore. I&#39;ve already had enough surprises for one night.&lt;&lt;/speech&gt;&gt;

You both laugh, quiet and close.

[[You settle in beside her and let the quiet take over.|Marie_JustLay_Route]]

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="80" name="Redmarrow_ArmorFlattery" tags="widget" position="1225,975" size="100,100">&lt;&lt;widget &quot;Redmarrow_ArmorFlattery&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You nod toward his outfit, eyebrows raised.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You always dress this sharp, or is tonight special?&lt;&lt;/speech&gt;&gt;

He doesn&#39;t look up right away—just finishes a long, deliberate stroke of his whetstone before setting the blade aside.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;A professional must cultivate presence. Fear is a language, girl—and sometimes the only way to speak it is with polish and posture.&lt;&lt;/speech&gt;&gt;

His voice is smooth, deliberate—like every word was chosen for maximum effect. There&#39;s a hint of a foreign accent, just enough to sound exotic without quite placing it. Every syllable lands with the flair of a man who enjoys being listened to.

He lifts his glass, swirling the inky red liquid like it&#39;s blood.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Besides, if you knew how many lives this armor&#39;s saved, you&#39;d understand why I keep it looking just the right kind of worn.&lt;&lt;/speech&gt;&gt;

You can&#39;t help a soft laugh. You question for a moment if armor is meant to save any lives other than the wearer&#39;s but decide against questioning this out loud.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You kinda look like you stepped out of a painting.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Good. I intend to be remembered like one.&lt;&lt;/speech&gt;&gt;

Your comment was less a compliment and more an observation, but he obviously took it to his ego anyhow.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="81" name="Redmarrow_JobPrompt" tags="widget" position="100,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_JobPrompt&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You tilt your head slightly, taking in the armor, the dagger, the air of self-importance.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So… what do you do, exactly? You look like you&#39;re either waiting for a duel or a portrait session.&lt;&lt;/speech&gt;&gt;

He chuckles softly, finally setting down his glass.
&lt;&lt;know &quot;redmarrow&quot;&gt;&gt;
&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Both, if I&#39;m lucky. But officially? I&#39;m a licensed bounty contractor—charter-recognized and Guild-backed. Dangerous work, of course, but Leopold Redmarrow does not shy from danger.&lt;&lt;/speech&gt;&gt;

He leans forward, resting one elbow on the table with the confidence of a man who knows how to fill space.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Most days, it&#39;s chasing coin. Some days, justice. And every so often, something a bit more... poetic.&lt;&lt;/speech&gt;&gt;

You&#39;re not sure what “poetic” bounty work looks like, but he clearly thinks it sounds impressive.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So you catch criminals for money.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;That&#39;s the skeleton of it, sure. But when you dress the bones in legend and legacy, it walks a bit taller.&lt;&lt;/speech&gt;&gt;

He flashes a smile so polished it might as well be part of his armor.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="82" name="Redmarrow_NameOrigin" tags="widget" position="225,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_NameOrigin&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You squint slightly, letting your tone ride the edge of teasing.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Redmarrow? That your real name?&lt;&lt;/speech&gt;&gt;

He smirks before you even finish the question, like he&#39;s been waiting for this exact moment.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Ah. The question behind all great men.&lt;&lt;/speech&gt;&gt;

He picks up his glass again, but doesn&#39;t drink—just holds it aloft like a toast to himself.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Some are born into names. Others earn them. And a rare few... are wise enough to choose their own before fate does it for them.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s not really an answer. Which are you?&lt;&lt;/speech&gt;&gt;

He winks, finally sipping the wine.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;If the name fits, wears well, and inspires fear in your enemies—what more proof of its truth do you need?&lt;&lt;/speech&gt;&gt;

You get the sense that “truth” is a negotiable concept for Leopold Redmarrow.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="83" name="Redmarrow_BountyQuest" tags="widget" position="350,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_BountyQuest&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can anyone take work from the Guild? Or do you have to be invited or something?&lt;&lt;/speech&gt;&gt;

Redmarrow leans back slightly, resting one boot on the leg of the table like he&#39;s posing for a statue.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Not normally, no. To be properly registered, you need to be recruited by an active member, sign the charter, and—of course—pay the initiation fees.&lt;&lt;/speech&gt;&gt;

He swirls his wine and grins.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;You know how it is. Spend money to make money.&lt;&lt;/speech&gt;&gt;

You raise an eyebrow.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So it&#39;s expensive?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Costly? No, no. *Efficient.* Twenty gold covers all the paperwork. And, coincidentally, I happen to have a contract I could share that would more than offset that upfront cost.&lt;&lt;/speech&gt;&gt;

He taps his dagger lightly against the table. Not threatening—just a gesture, a rhythm.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Opportunity knocks quietly, girl. Better you answer now than regret it later.&lt;&lt;/speech&gt;&gt;

He gestures vaguely, as if the very concept of time is slipping through your fingers.

&lt;&lt;/append&gt;&gt;
&lt;&lt;set $readyForBoutyQuestion = true&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="84" name="Redmarrow_TheJob" tags="widget" position="475,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_TheJob&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;About that job you mentioned...&lt;&lt;/speech&gt;&gt;

He doesn&#39;t answer right away—just gives you a slow smile, like you passed some invisible test.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;I&#39;m glad to see you&#39;re thinking about it. Before we get down to brass tacks. Do you have the twenty gold?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;redmarrow&quot; &quot;TheFirstBounty&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Redmarrow_TheFirstBounty Branch - Start */

    :: Redmarrow_BountySignUp [widget]
&lt;&lt;widget &quot;Redmarrow_BountySignUp&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I want to join the bounty hunter&#39;s guild.&lt;&lt;/speech&gt;&gt;

You place the coin down on the table.

Leopold sweeps it up with one smooth motion—almost too smooth, like he&#39;s done this *a lot*. He doesn&#39;t even check the weight.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;A wise investment, er–.&lt;&lt;/speech&gt;&gt;

You realize you haven&#39;t shared your name yet.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Jaylie.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;A wise investment, Jaylie.&lt;&lt;/speech&gt;&gt;

He pulls a folded scrap of parchment from inside his coat and slides it toward you like it&#39;s contraband.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Target&#39;s a pickpocket named Tel Varas. He&#39;s known well enough around the city, and he&#39;s slipped past the Wardens more times than they care to admit. So much so, apparently that the City passed it to the guild. He&#39;s not dangerous, just slimy.&lt;&lt;/speech&gt;&gt;

You glance down at the parchment. It&#39;s vague. A name, a rough sketch, and a few scribbled locations—none of it official.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;This looks like it was written in a tavern bathroom.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Field work is messy, girl. Welcome to the Guild.&lt;&lt;/speech&gt;&gt;

He raises his glass in your direction, utterly satisfied with himself.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do I need to sign anything else to become an official member?&lt;&lt;/speech&gt;&gt;

He chuckles at you flatly.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;I wouldn&#39;t dream of wasting your time with that nonsense until after you have your first mark on your belt.&lt;&lt;/speech&gt;&gt;

He smiles—content, apparently, that the conversation is over.

&lt;&lt;/append&gt;&gt;
&lt;&lt;bg &quot;PayingTheBountyHunter&quot;&gt;&gt;
&lt;&lt;additem &quot;player&quot; &quot;gold_coin&quot; -20&gt;&gt;
/*&lt;&lt;set $quests.bounty_cutpurse = { active: true, name: &quot;Tel Varas&quot;, paidRedmarrow: true }&gt;&gt;*/
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="85" name="Redmarrow_WhoIsItAgain" tags="widget" position="600,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_WhoIsItAgain&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can you remind me who the target is again?&lt;&lt;/speech&gt;&gt;

Redmarrow gives a slight, theatrical sigh—but it&#39;s performative, not impatient.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Tel Varas. Pickpocket. Slippery. Not dangerous, just irritating. Like a fly that knows how to open windows.&lt;&lt;/speech&gt;&gt;

He taps the parchment again with one finger.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;He&#39;s been dipping through the outer wards for weeks. The city watch is tired of chasing him in circles, so they handed it off to the Guild. Which means us.&lt;&lt;/speech&gt;&gt;

He sips from his glass like he just summarized a real war criminal.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="86" name="HowFindTelVaras" tags="widget" position="725,1100" size="100,100">&lt;&lt;widget &quot;HowFindTelVaras&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Any idea where I should start looking for him?&lt;&lt;/speech&gt;&gt;

Redmarrow waves a hand vaguely, like the question&#39;s too mundane for a man of his rank.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;If I knew *exactly* where he was, I wouldn&#39;t need to outsource the job, would I?&lt;&lt;/speech&gt;&gt;

He leans back with an easy smirk.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;But word is he&#39;s been casing the outer wards. And with the fair about to start, let&#39;s just say it&#39;s a pickpocket&#39;s wet dream.&lt;&lt;/speech&gt;&gt;

He taps his temple with one gloved finger.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Trust your instincts. Rats like him always sniff out the biggest crumbs.&lt;&lt;/speech&gt;&gt;

You imagine he might be stay close to the fairgrounds in King Market square over the next few days.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="87" name="TelVarasHowMuchPay" tags="widget" position="850,1100" size="100,100">&lt;&lt;widget &quot;TelVarasHowMuchPay&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And how much is this job paying again?&lt;&lt;/speech&gt;&gt;

Redmarrow grins like he&#39;s just been waiting for the question.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Official bounty on Tel Varas is a hundred gold.&lt;&lt;/speech&gt;&gt;

He lets the number hang in the air for a beat, watching your reaction.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Modest by Guild standards, but for a first mark? It&#39;s a fine stepping stone.&lt;&lt;/speech&gt;&gt;

He lifts his glass again, just shy of a toast.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Of course, final payout depends on paperwork, processing, deductions… you know. Standard procedure.&lt;&lt;/speech&gt;&gt;

He says it like he&#39;s quoting an invisible rulebook that only he has access to.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="88" name="TelVarasAnythingElse" tags="widget" position="975,1100" size="100,100">&lt;&lt;widget &quot;TelVarasAnythingElse&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Is there anything else I should know before I go after him?&lt;&lt;/speech&gt;&gt;

Redmarrow hesitates—just for a breath—then offers a casual shrug.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Technically… there&#39;s a standing bonus if any stolen goods are recovered intact.&lt;&lt;/speech&gt;&gt;

He says it lightly, like he&#39;s not sure why he even bothered mentioning it.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Twenty percent of their appraised value, paid out separately. But that&#39;s the kind of thing that only comes up if you&#39;re *very* lucky and *very* quick.&lt;&lt;/speech&gt;&gt;

He waves a hand as if to dismiss the thought entirely.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Just focus on the bounty. Clean job, clear proof, no complications—that&#39;s how you build a name.&lt;&lt;/speech&gt;&gt;

He smiles like he&#39;s being helpful, but you can feel the unspoken asterisk hovering behind his words.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="89" name="Redmarrow_ReturnBountytoPhase0" tags="widget" position="1100,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_ReturnBountytoPhase0&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Let&#39;s talk about something else.&lt;&lt;/speech&gt;&gt;

Redmarrow gives a faint nod and adjusts his posture, as if shedding the whole “professional” act without hesitation.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;As you like. I can be versatile.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;bg &quot;Scene03_ApproachBountyHunter&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;redmarrow&quot; &quot;Phase0&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="90" name="Redmarrow_Exit" tags="widget" position="1225,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_Exit&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Enjoy your night.&lt;&lt;/speech&gt;&gt;

Redmarrow gives a shallow nod, swirling his glass slowly before taking a measured sip.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;I intend to. Should fortune favor you, perhaps you&#39;ll earn the same.&lt;&lt;/speech&gt;&gt;

&lt;&lt;if not $TalkedTo_Redmarrow&gt;&gt;
  &lt;&lt;set $TalkedTo_Redmarrow = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You turn back toward the tavern&#39;s main floor.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="91" name="Tesska_GetDrink" tags="widget" position="100,1225" size="100,100">&lt;&lt;widget &quot;Tesska_GetDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
	&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could I get a drink? Nothing fancy. Just... something real.&lt;&lt;/speech&gt;&gt;
	&lt;&lt;set $tesskaOrderedDrink = true&gt;&gt;
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Coming right up, sugar. Nothing wrong with wanting something simple that still gets the job done. You want flavor or fire? &#39;Cause I can give you both, but I won&#39;t lie—one of &#39;em&#39;s a bit harder to forget.&lt;&lt;/speech&gt;&gt;
	
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Let&#39;s start with something strong, I think. I&#39;ll work my way toward flavor.&lt;&lt;/speech&gt;&gt;
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Attagirl. One mug of Strongarm Swill, coming up. First one&#39;s free &#39;cus I like the look of ya.&lt;&lt;/speech&gt;&gt;
	
  &lt;p&gt;You watch her cross to the bar and shout something over to Harroc. He doesn&#39;t respond, but reaches for a barrel tap without looking and draws a dark amber drink into a battered tin mug. Tesska slides it in front of you a moment later, and gives the table a soft knock with her knuckle.&lt;/p&gt;
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Drink it fast if you hate yourself. Slow if you&#39;re tryin&#39; to find out whether you do.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="92" name="Tesska_QuietNight" tags="widget" position="225,1225" size="100,100">&lt;&lt;widget &quot;Tesska_QuietNight&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
	&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It&#39;s kind of quiet in here tonight.&lt;&lt;/speech&gt;&gt;
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mmhmm. If you asked Harroc, he&#39;d say folks are savin&#39; their strength for the fair. Three days of booze, music, and regrets.&lt;&lt;/speech&gt;&gt;
	
  She chuckles and wipes a bit of condensation from your table.
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;But me? I think something&#39;s in the air. Knights have been too quiet. Too polite. Feels like the city&#39;s holdin&#39; its breath for something, and not the good kind.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="93" name="Tesska_DoYouWorkNights" tags="widget" position="350,1225" size="100,100">&lt;&lt;widget &quot;Tesska_WorkNights&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you always work nights?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mmh, nights, days. When you want to keep a place like this running in the city you never stop working.&lt;&lt;/speech&gt;&gt;

  Your face fills with shock for a moment, realizing your mistake. 

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh I am sorry, it was unfair of me to assume—&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Oh hush, don&#39;t fret so much, Sweetheart. It happens more than you think. I have gotten used to it ever since the big guy came into my life. People see his big shiny dome and the wall of muscle and think he must have constructed this whole place himself with logs and stones he cut with his bare hands. Truth is, I was running this place long before Harroc ever stepped out of the ring.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;set State.variables.hintedharrocfighter = true&gt;&gt;
  You take another moment to look around the room. The rafters, the center hearth, the walls, tables, benches and stools. You have to appreciate for a moment how pristine things look. Some of the furniture is a little beat up, sure, but you figure all of those are just stories.

  A distant crack of thunder shakes you from your inspection. Tesska hardly seems to notice, her eyes pointed towards the bar.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Though don&#39;t get me wrong... watching him behind that counter with his arms all flexed and grumbly? Not a bad view while I work.&lt;&lt;/speech&gt;&gt;

  You watch Tesska&#39;s face as she looks over at Harroc. It&#39;s full of a mix of desire and love. You realize only then that Harroc has hardly looked away from Tesska either. They are obviously quite taken by each other.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;But yes, sweetheart. I happily work most every night. Daytime drinkers are hardly any fun, the nights are when lips get loose and coin purses empty.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;set $tesskaTalkedAboutNights = true&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;widget &quot;Tesska_HowLongYouAndHarroc&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So... how long have &lt;em&gt;you&lt;/em&gt; been running the place? And how long&#39;s Harroc been part of it?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mm. Careful now, sweetheart. Ask questions like that and I might just fall in love.&lt;&lt;/speech&gt;&gt;

  She leans slightly closer as she says it, her voice velvet-wrapped and playful. Then, with a shift in posture and a glimmer of pride, she eases back into her usual rhythm.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;I bought this place just short of fifteen years ago. Back when the hearth cracked worse than the mugs and the roof cried harder than the patrons.&lt;&lt;/speech&gt;&gt;

  She chuckles softly, folding her arms beneath her chest.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;I cleaned it up, ran it smart, made it safe. For a while it was just me and a handful of stubborn regulars. Then after a few years of thinking I bit off more than I could chew, Harroc started showing up. Silent, broody, respectful—every tavern has a few. But he kept showing up. And then one night I caught him tossing a rowdy drunk through the door without ever spilling a drop of his own drink and... well. The rest is sweaty, romantic history.&lt;&lt;/speech&gt;&gt;

  She glances toward the bar again where Harroc, stoic as ever, appears to be polishing the same mug as always.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;He moved in about six months after that. Been glued to the floor ever since. Calls me his boss, but we both know better. He&#39;s the spine, sure. But I&#39;m the soul.&lt;&lt;/speech&gt;&gt;

  A gust of wind blows against the front wall of the building. You hear the supports of the building crackle, but not falter. A daring whistling as the building cuts the storm like a rock in the sea.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;It may be my baby, but that man is the only thing that has kept me and this place from blowing away.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="94" name="Tesska_UnusualCustomers" tags="widget" position="475,1225" size="100,100">&lt;&lt;widget &quot;Tesska_UnusualCustomers&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you get a lot of unusual customers in here?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Unusual? What, like wide-eyed princesses trying their best to look like they are slumming it with the common-folk?&lt;&lt;/speech&gt;&gt;

  You feel your cheeks flush, and she catches it instantly.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Relax, sweetheart. I don&#39;t mean it cruel. Your secret&#39;s not out. I&#39;m just not as innebriated like the rest of this lot, and keeping your wits about you is a requirement for this job. It&#39;s not every day a girl like you walks in looking like she&#39;s never had to split a tab or fend off a drunkard.&lt;&lt;/speech&gt;&gt;

  She leans a little closer, voice lowered just enough to feel like a secret.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;But yes. We get our share. Half-orc mercenaries like Drekka over there, who bathe in ale more than water. Quiet types with knives too clean and coin too heavy. Once had a man come in wearing a full suit of armor just to drink milk. Sat for three hours. Didn&#39;t say a word. Tipped a whole gold and walked out.&lt;&lt;/speech&gt;&gt;&lt;&lt;know &quot;brakka&quot;&gt;&gt;
    
  She pauses as if waiting for your expression—then grins when you meet her eyes.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Point is, Bastion&#39;s big. It spills strange folks into every corner, especially places with warmth and liquor. You stay long enough, you&#39;ll see a few things that&#39;ll make your palace stories feel quaint.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="95" name="Tesska_Exit" tags="widget" position="600,1225" size="100,100">&lt;&lt;widget &quot;Tesska_Exit&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Thanks, Tesska. I think I&#39;ll just sit quietly for a bit.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Suit yourself, sweetheart. But if you get bored, I&#39;m just a holler away—as long as I&#39;m not elbow-deep in someone else&#39;s bad decisions.&lt;&lt;/speech&gt;&gt;

  She winks, then turns with a little extra sway in her hips as she walks away, glancing once over her shoulder to make sure you&#39;re watching.

  &lt;&lt;if not $TalkedTo_Tesska&gt;&gt;
    &lt;&lt;set $TalkedTo_Tesska = true&gt;&gt;
    &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
  &lt;&lt;/if&gt;&gt;

  &lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
    &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
    [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
  &lt;&lt;/if&gt;&gt;
  [[Look around the tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="96" name="Tesska_ExitDrink" tags="widget" position="725,1225" size="100,100">&lt;&lt;widget &quot;Tesska_ExitDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I think I&#39;m just going to nurse this drink for a while. Thanks again.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mmh, take your time with it. Good drinks—and good company—are meant to be savored.&lt;&lt;/speech&gt;&gt;

  She taps her knuckle lightly on the table, gives you a knowing smile, and glides off into the crowd like she owns every beam and brick of the room.

  &lt;&lt;if not $TalkedTo_Tesska&gt;&gt;
    &lt;&lt;set $TalkedTo_Tesska = true&gt;&gt;
    &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
  &lt;&lt;/if&gt;&gt;

  &lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
    &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
    [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
  &lt;&lt;/if&gt;&gt;

  [[Look around the tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="97" name="FireConvergence" tags="" position="850,1225" size="100,100"></tw-passagedata><tw-passagedata pid="98" name="NPCGenerator" tags="widget" position="1675,350" size="100,100">&lt;&lt;widget &quot;GenerateNPC&quot;&gt;&gt;
&lt;&lt;set _npc to setup.generateNPC(&quot;female&quot;, &quot;human&quot;, &quot;Courtesan&quot;)&gt;&gt;
&lt;&lt;print &quot;Generated NPC: &quot;&gt;&gt;
&lt;&lt;print _npc.name&gt;&gt; the &lt;&lt;_npc.archetype&gt;&gt; (&lt;&lt;_npc.race&gt;&gt;)
&lt;&lt;print &quot;Style: &quot; + _npc.style&gt;&gt;
&lt;&lt;print &quot;Trait: &quot; + _npc.trait + &quot;, Inclination: &quot; + _npc.inclination&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="99" name="StoryAuthor" tags="" position="100,0" size="100,100">Pmoe</tw-passagedata><tw-passagedata pid="100" name="StoryAuthorInfo" tags="" position="200,0" size="100,100">Copyright © 2025 Parker Lee Christiansen. All Rights Reserved.</tw-passagedata><tw-passagedata pid="101" name="StoryBanner" tags="" position="300,0" size="100,100">&lt;b&gt;Liff Origins&lt;/b&gt; — Jaylie</tw-passagedata><tw-passagedata pid="102" name="StoryDisplay" tags="startup nobr" position="500,0" size="100,100">&lt;!-- No longer used for sidebar logic --&gt;</tw-passagedata><tw-passagedata pid="103" name="StoryInit" tags="" position="600,0" size="100,100">&lt;&lt;if $DEBUG is true&gt;&gt;
  &lt;&lt;print Macro.has(&quot;SidebarUI&quot;)&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;run setup.NPCs = []&gt;&gt;
&lt;&lt;run setup.Seed = Math.seedrandom(&quot;liff&quot;)&gt;&gt;

&lt;&lt;SidebarUI&gt;&gt; &lt;!-- still injects your custom sidebar layout --&gt;
&lt;&lt;run State.variables.characters = setup.initializeCharacters()&gt;&gt;

&lt;&lt;run
	(() =&gt; {
		const path = State.variables.bgImage;
		const el = document.getElementById(&quot;background&quot;);
		if (path &amp;&amp; el) {
			el.style.backgroundImage = `url(&#39;${path}&#39;)`;
			console.log(`🖼️ Background applied on init: ${path}`);
		}
	})();
&gt;&gt;</tw-passagedata><tw-passagedata pid="104" name="StoryInterface" tags="" position="700,0" size="100,100">&lt;!-- =============================
=     Required SugarCube Node    =
============================= --&gt;
&lt;div id=&quot;passages&quot;&gt;&lt;/div&gt;

&lt;!-- =============================
=     Main Visual Structure      =
============================= --&gt;
&lt;div id=&quot;background-image&quot;&gt;&lt;/div&gt;

&lt;div id=&quot;text-container&quot;&gt;
  &lt;div id=&quot;text-backdrop&quot;&gt;
    &lt;!-- This will either get populated with dialogue layout OR reattached #dynamic-content --&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;!-- =============================
=        Custom Sidebar         =
============================= --&gt;
&lt;div id=&quot;custom-sidebar&quot; data-passage=&quot;sidebar&quot;&gt;&lt;/div&gt;

&lt;!-- =============================
=         Overlay Panel          =
============================= --&gt;
&lt;div id=&quot;overlay-panel&quot; class=&quot;overlay-hidden&quot;&gt;
  &lt;div id=&quot;overlay-body&quot;&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;!--===============================
=  Conversation Overlay Startup   =
================================--&gt;
&lt;div id=&quot;conversation-overlay&quot; class=&quot;convo-overlay overlay-hidden&quot;&gt;
    &lt;div class=&quot;convo-window&quot;&gt;
    &lt;img id=&quot;convo-avatar&quot; src=&quot;&quot; alt=&quot;Avatar&quot; /&gt;
    &lt;h2 id=&quot;convo-npc-name&quot;&gt;&lt;/h2&gt;
    &lt;div id=&quot;convo-npc-style&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;convo-npc-prompt&quot; class=&quot;convo-prompt&quot;&gt;&lt;/div&gt;

    &lt;div class=&quot;convo-choices&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;convo-actions&quot;&gt;
      &lt;!-- Action buttons here --&gt;
    &lt;/div&gt;

    &lt;div class=&quot;convo-results&quot;&gt;
      &lt;p id=&quot;convo-summary-gains&quot;&gt;&lt;/p&gt;
      &lt;p id=&quot;convo-summary-rapport&quot;&gt;&lt;/p&gt;
      &lt;p id=&quot;convo-summary-gifts&quot;&gt;&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;


&lt;!--===============================
=  Crown &amp; Caste Overlay Startup =
================================--&gt;
&lt;div id=&quot;crown-and-caste-page&quot; class=&quot;overlay-hidden&quot;&gt;

  &lt;div id=&quot;crown-caste-frame&quot;&gt;
    
    &lt;!-- Crown Dice Center Circle --&gt;
    &lt;div id=&quot;center-circle&quot;&gt;
      &lt;div class=&quot;crown-die&quot; id=&quot;crown-die-1&quot;&gt;?&lt;/div&gt;
      &lt;div class=&quot;crown-die&quot; id=&quot;crown-die-2&quot;&gt;?&lt;/div&gt;
      &lt;div class=&quot;crown-die&quot; id=&quot;crown-die-3&quot;&gt;?&lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Quadrant Player Zones --&gt;
    &lt;div id=&quot;top-left&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;
    &lt;div id=&quot;top-right&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;
    &lt;div id=&quot;bottom-left&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;
    &lt;div id=&quot;bottom-right&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;

    &lt;!-- Action Panel --&gt;
    &lt;div id=&quot;action-panel&quot;&gt;
      &lt;div id=&quot;action-title&quot;&gt;Your Turn&lt;/div&gt;
      &lt;button id=&quot;btn-roll&quot;&gt;Roll&lt;/button&gt;
      &lt;button id=&quot;btn-lock&quot;&gt;Lock/Unlock&lt;/button&gt;
      &lt;button id=&quot;btn-chip&quot;&gt;Use Chip&lt;/button&gt;
      &lt;button id=&quot;btn-end&quot;&gt;End Turn&lt;/button&gt;
    &lt;/div&gt;

  &lt;/div&gt;

&lt;/div&gt;</tw-passagedata><tw-passagedata pid="105" name="StoryMenu" tags="" position="800,0" size="100,100">* [[Credits]]
* [[Help]]</tw-passagedata><tw-passagedata pid="106" name="StorySubtitle" tags="" position="900,0" size="100,100">A Liff Story.</tw-passagedata><tw-passagedata pid="107" name="Start" tags="" position="25,150" size="100,100">&lt;&lt;bg &quot;default&quot;&gt;&gt;&lt;&lt;ClearSnapshots&gt;&gt;&lt;&lt;additem &quot;player&quot; &quot;gold_coin&quot; 100&gt;&gt;
# Introduction

Hello there and welcome to Liff Origins: Jaylie. This is my first game-development project and an introduction to the World of Liff, a fantasy world all my own where this small prequel and my planned future project, Adventures of Liff,  will take place.

In this story you play from the perspective of //Jaylie Primmon//, the Princess and heir to the throne of the Kingdom of Bastion. 

This story will contain elements of an &#39;&#39;ADULT/MATURE&#39;&#39; nature. Content like this is typically prohibited by law to be consumed by non-adults (18-21 in most places). By continuing with this story you confirm that you are legally allowed to consume this type of content wherever you are. 

[[Go forth and journey on|StoryStart_Scene01]]

[[Wait I am NOT an adult|Underage_Response]]

/*Placeholder */
[[Skip to Tavern|Scene03_TheSpace]]</tw-passagedata><tw-passagedata pid="108" name="Underage_Response" tags="" position="275,150" size="100,100">&#39;&#39;Get out of here!&#39;&#39;</tw-passagedata><tw-passagedata pid="109" name="Scene02_AddasGreeting" tags="" position="75,650" size="100,100">&lt;&lt;bg &quot;Scene02_AddaGreeting&quot;&gt;&gt;
&lt;&lt;speech &quot;adda&quot;&gt;&gt;You will have to forgive me for staring. If I didn&#39;t know any better I would have thought royalty had just walked into my humble parlor.&lt;&lt;/speech&gt;&gt;
	
	She gives you a thoughtful wink.
&lt;&lt;set $characters[&quot;adda&quot;].known = true&gt;&gt;
&lt;&lt;speech &quot;adda&quot;&gt;&gt;My name is Adda. The locals call me Mistress Adda, or Madam Adda, and this is my establishment, The Nuzzling Noctail. I assure you we have anything that could suit the needs of…&lt;&lt;/speech&gt;&gt;

	She looks you up and down, staring rather obviously at your hair, obviously recognizing its shade.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;...even the most discerning of clientele. May I ask what you&#39;d like to be called, &lt;em&gt;young Lady?&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

You shuffle uncomfortably for a moment. Coming in here seemed like such a great moment only seconds ago and now you stand before Mistress Adda whom you feel unpacked your whole identity in mere seconds.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I suppose Jaylie would be fine, right?&lt;&lt;/speech&gt;&gt;

	You swear you&#39;d never felt more unsure of yourself than you suddenly were in this exact moment.

&lt;&lt;speech &quot;adda&quot;&gt;&gt; Not to worry, Jaylie. My hosts are all trained to uphold the utmost discretion, not that many of them are as observant as myself… &lt;span class=&quot;whisper&quot;&gt;your highness&lt;/span&gt;.&lt;&lt;/speech&gt;&gt;

You take a moment to catch your breath and find your tongue.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Well thank you Madam Adda. I appreciate the hospitality and the discretion. Now if I may ask, what would one girl have to do to get a birthday drink for herself in your fine establishment? &lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;
&lt;em&gt;Birthday!?&lt;/em&gt; But of course! Why don&#39;t you follow me into the parlor. Let&#39;s get you comfortable. There&#39;s a bar if you want something to drink, but any of my talented hosts will be happy to assist you.&lt;&lt;/speech&gt;&gt;

&lt;p&gt;You follow Mistress Adda through a set of velvet red curtains and [[into the parlor|TheBrothelParlorOverview]].&lt;/p&gt;</tw-passagedata><tw-passagedata pid="110" name="Scene02_BrothelBar" tags="" position="1225,1350" size="100,100">&lt;&lt;bg &quot;Scene02_TheBrothelParlor&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You make your way across the plush floor toward the bar, the air thick with perfume and low conversation. The man behind the counter is a picture of precision — tall, thin, immaculately dressed in a crimson waistcoat. His dark hair is slicked back without a single strand out of place, and the thick, hemispherical mustache above his lip gives him the appearance of someone who might scowl by default… if he ever showed enough expression to scowl.

At the moment, he&#39;s in the middle of mixing a drink — tossing a silver shaker through the air, flipping a small glass behind his back, and catching it without so much as glancing down. The movements are practiced, fluid, and somehow both showy and completely effortless.

Without looking your way, he pours the drink with one final flourish and slides it across the bar to a waiting hand.

Only then does he turn to you.

&lt;&lt;speech &quot;bert&quot;&gt;&gt;Can I get you something to drink? Maybe something to loosen your inhibitions. Or sharpen them, if that&#39;s more your taste.&lt;&lt;/speech&gt;&gt;

His voice is calm. Clipped. Not unfriendly — just focused. Every word is perfectly enunciated, with not a syllable wasted.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It&#39;s my birthday, actually. Thought I&#39;d treat myself.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;bert&quot;&gt;&gt;In that case, the first one&#39;s on the house. Anything in particular you like? Or shall I surprise you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;bert&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="111" name="Scene02_ReturnToParlor" tags="" position="75,775" size="100,100">&lt;&lt;bg &quot;parloroverview&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

The familiar blend of perfume, wine, and something unplaceably warm hits you again as you step back into the middle of the parlor. The scent doesn&#39;t surprise you this time—it, but welcomes you, like returning to a book left open mid-page.

The hush still lingers, that velvety quiet filled with murmured voices and the occasional laugh from unseen corners. Somewhere above, the faint rhythm of movement—floorboards creaking in time with breath—reminds you that pleasure here takes many forms, not all of them spoken.

Low golden light from the crystal sconces bathes the space in its usual amber glow. The shadows aren&#39;t as deep now that your eyes have adjusted, but they still seem to hold secrets just out of reach. Plush couches and marble tables remain as inviting as ever, though the cushions now bear the soft impressions of earlier guests. The room doesn&#39;t reset; it evolves.

Behind the bar, the bartender is polishing glassware, his crimson waistcoat catching the light as he leans into a quiet routine. He spares you a glance, but it&#39;s less assessing this time—more like acknowledgment. Recognition.

Adda stands where she often does, by the column in the corner, hands folded in front of her. Her posture is poised, but you catch a slight tilt to her head, as if curious what you&#39;ve learned since last you spoke. She offers a brief smile without words. For her, that&#39;s warmth enough.

The blue-tinted, half-demon still sprawls across her chaise, though her eyes narrow slightly when she sees you again. Her tail twitches once, idly, like a cat deciding whether to approach. She watches you longer than before.

The blonde hostest sits off to one side of the Parlor. Her expression is flat and uninviting, but she stills seems like she might be shaken from the confrontation you witnessed in the street.

The male host moves from space to space, quietly and respectfully checking on other guests and hosts. His vest-shirt is still scandalously unbuttoned, his smile is practiced yet warm. When he notices you looking he nods .

From here, you may:
[[Approach the bar.|Scene02_BrothelBar]]
[[Approach the half-demon woman.|Scene02_TalkToExotic]]
[[Approach the male host.|Scene02_TalkToMaleHost]]
[[Approach the blonde hostest.|Scene02_TalkToAngryHost]]
[[Approach Adda, the Brothel Mistress.|Scene02_TalkToAdda]]</tw-passagedata><tw-passagedata pid="112" name="Scene02_TalkToAdda" tags="" position="225,1475" size="100,100">&lt;&lt;bg &quot;Scene02_TalkToAdda&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

Mistress Adda stands with one hand resting lightly on the back of a velvet chair, her other cradling a delicate crystal glass of something deep amber. She is half-illuminated by the glow of a nearby sconce, her dark gown catching the light like polished coal. Her posture is perfect—spine straight, shoulders regal—but there is something soft in her gaze as she watches you approach.

She doesn&#39;t speak at first. Just lets her eyes travel over you with the weight of someone who misses nothing. Then, a faint smirk curls the corner of her mouth.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;You walk like someone who&#39;s trying to appear casual... but hasn&#39;t decided whether to flee or fight.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Maybe I&#39;m still deciding.&lt;&lt;/speech&gt;&gt;

She chuckles—a low, warm sound—and gestures to the seat across from her.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Then sit. Speak. Let&#39;s see if I can help you make up your mind.&lt;&lt;/speech&gt;&gt;

You take a seat, and Adda sits next to you, tucking her knees close to yours. Her posture is personal, but not what you would call intimate. The chair is plush beneath you, the fabric warm from the heat of the room. Adda watches you settle with the ease of someone used to holding court.

&lt;&lt;DialogueTree &quot;adda&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="113" name="Scene02_TalkToAngryHost" tags="" position="350,1475" size="100,100">&lt;&lt;bg &quot;Scene02_TalkToAngryHost&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You approach the blonde girl, who had thrown the horseshoe at the man outside. She turns half a face towards you as you sit on the couch next to her. Her face is soft, but she is obviously annoyed.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I sit here with you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I suppose you can. I&#39;m not much in the mood to talk.&lt;&lt;/speech&gt;&gt;

You take a seat next to her, your knees pointed away from her, making sure to give her space. She seems to stare at everything in the room but you.

&lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="114" name="Scene02_TalkToExotic" tags="" position="25,900" size="100,100">&lt;&lt;bg &quot;parlorallura&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You drift toward the velvet chaise, where the blue-skinned woman is laying, drawn more by the stillness around it than the woman herself—at first.

Then her eyes find you. Golden, slitted like a cat&#39;s, and too calm for the room they&#39;re in.

She doesn&#39;t rise. She doesn&#39;t need to.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You walk like someone hoping not to be noticed… and yet, here you are.&lt;&lt;/speech&gt;&gt;

Her voice is warm and low, with an accent that paints every vowel like a slow drag of silk. She doesn&#39;t smile, exactly—but her lips curl at the edges, just enough to make you feel seen.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Sorry, I just...&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah-ah.&lt;&lt;/speech&gt;&gt; 

She lifts a finger, not to silence you, but to taste the moment. Her tail curls idly along the back of the couch.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Let&#39;s not ruin it with apologies. Come. Sit. Lie, if you prefer.&lt;&lt;/speech&gt;&gt;

You hesitate only long enough to feel foolish, then ease onto the edge of the chaise. The cushion dips beneath you, a hush of perfume and velvet rising around your skin.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mmm. Much better. Now… what name do I have the pleasure of toying with tonight?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Jaylie.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Jaylie.&lt;em&gt; Such a soft name. But there&#39;s something beneath it, I think. Something sharp.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

She tilts her head and watches you like she&#39;s measuring shadows in candlelight.
&lt;&lt;know &quot;allura&quot;&gt;&gt;
&lt;&lt;speech &quot;allura&quot;&gt;&gt;You may call me Allura. For now.&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;allura&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="115" name="Scene02_TalkToMaleHost" tags="" position="600,1475" size="100,100">&lt;&lt;bg &quot;parlordarian&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You find him standing near one of the larger couches, laughing gently with a pair of guests as he pours wine into their cups. His presence is easy—casual, but not careless. Confident, but never imposing. He thanks them with a soft smile and turns just in time to catch your approach.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Good evening, my lady. Looking for someone to share it with?&lt;&lt;/speech&gt;&gt;

There&#39;s a charm in his voice, but not the kind that smothers. He doesn&#39;t try too hard, just offers the warmth of someone who&#39;s good at reading what people need, and giving only as much as they&#39;re comfortable taking.

You notice his eyes flick briefly toward one of the other hosts in the room, checking in without missing a beat. It&#39;s subtle, but you catch it again later—his gaze always wandering protectively, watching the others like a quiet sentinel.

He turns his attention fully back to you.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Most folks who come in here are either looking to forget… or to feel something. Not always the same thing.&lt;&lt;/speech&gt;&gt;

He says it gently, almost like it&#39;s a well-worn lyric he&#39;s sung a thousand times.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And which are you?&lt;&lt;/speech&gt;&gt;

He chuckles, brushing one hand through his thick, short-cropped hair. A thin golden bracelet glints on his wrist, a simple, yet beautiful, braided-metal piece. You spot tiny inscriptions etched into the broad clasp, but you can&#39;t quite make them out.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Me? I&#39;m here to make sure no one leaves feeling worse than they came in. Maybe inspire a few songs in peoples&#39; souls.&lt;&lt;/speech&gt;&gt;

He gives a short whistle—just a few notes. It&#39;s simple, a melody that feels nostalgic even if you&#39;ve never heard it before.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You&#39;ve got that look, you know. Like a song I haven&#39;t heard in a long time.&lt;&lt;/speech&gt;&gt;

He freezes slightly, just for a second. His sudden expression draws a chortle from somewhere deep within you. He looks like he didn&#39;t mean to say it out loud. He laughs himself, awkwardly.
&lt;&lt;set $characters[&quot;darian&quot;].known = true&gt;&gt;
&lt;&lt;speech &quot;darian&quot;&gt;&gt;Sorry. That was... cliché. I&#39;m better when I&#39;m not trying so hard. I am Darian by the way.&lt;&lt;/speech&gt;&gt;

You can&#39;t help but smile. There&#39;s something very real about him—beneath the smooth edges and trained elegance, a softness that feels rare in a place like this.

&lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="116" name="Scene02_TheBrothelEntry" tags="" position="75,550" size="100,100">&lt;&lt;bg &quot;Scene02_TheBrothelEntry&quot;&gt;&gt;

You walk up to the steps of the brothel and look up at the dark and heavy door. On either side of it are frosted glass windows which bathe you in a diffused orange glow of the warm fire-light within.  
You walk up the few steps, pull on the handle, open the door and step inside.  

Once inside you see, just ahead of you a narrow staircase adorned with opulent candle-holders ascends to the next floor. To your left the room opens up into a very inviting space filled with plush furniture upholstered in crimson velvet, lined in gold filigree.  

As your boots echo across the floor boards at your entry you hear a familiar voice,  
&lt;&lt;speech &quot;adda&quot;&gt;&gt; I swear if that is you again, Kallot, I will not need the wardens to kill you–&lt;&lt;/speech&gt;&gt;

The madam from before walks around the corner of the wall from an area of the main room which you couldn&#39;t see before. Her scowl melts the moment she sees it&#39;s you — not Kallot. You assume that must be the name of the man outside.  
&lt;&lt;set $characters[&quot;kallot&quot;].known = true&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt; Oh, I&#39;m sorry my dear. You must forgive me, I thought you were that lecherous roach out on the pavement again. Please! Come inside, allow me to remove that soaked cloak for you. &lt;&lt;/speech&gt;&gt;

&lt;span id=&quot;brothel-reveal&quot;&gt;She approaches you, heels clicking on the ground, arms outstretched toward your &lt;&lt;link &quot;cloak&quot;&gt;&gt;
  &lt;&lt;replace &quot;#brothel-reveal&quot;&gt;&gt;
    &lt;p&gt;She approaches you, heels clicking on the ground, arms outstretched toward your cloak.
	&lt;p&gt;She unclasps your cloak and draws back your hood, revealing your face and hair. The warmth of the room brushes your cheeks. Her smile softens.&lt;/p&gt;
    &lt;&lt;speech &quot;adda&quot;&gt;&gt; &lt;em&gt;Ahhh.&lt;/em&gt; What have we [[here?|Scene02_AddasGreeting]] &lt;&lt;/speech&gt;&gt;
  &lt;&lt;/replace&gt;&gt;
&lt;&lt;/link&gt;&gt;&lt;/span&gt;</tw-passagedata><tw-passagedata pid="117" name="TheBrothelParlorOverview" tags="" position="75,775" size="100,100">&lt;&lt;bg &quot;parloroverview&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Please, Jaylie. Make yourself comfortable. Drink if you wish. Speak with whoever calls to you. No pressure. No expectations. Just enjoy yourself.&lt;&lt;/speech&gt;&gt;
The scent hits you first — a blend of perfume, wine, and something warmer, deeper. Not quite sweat. Not quite incense. Something in between.

A hush seems to hang over the parlor, but it&#39;s not silent. Muted voices murmur from shadowed corners, glassware clinks against trays, and faintly—almost imperceptibly—soft, rhythmic sounds drift from the rooms above. Moans, maybe. Laughter. The creak of old floorboards under shifting weight.


Low golden light spills from crystal sconces along the walls, casting velvet shadows over the space. The parlor is wide and low-ceilinged, wrapped in plush couches, tufted chairs, and elaborate floor cushions arranged around small marble tables. Deep reds, rich purples, and blacks dominate the palette—each surface layered and inviting, like the room itself is daring you to touch.

The bar runs along the far western wall, its surface an elegant arc of dark mahogany carved with lewd but tasteful reliefs. The bartender, a thin man in a crimson waistcoat and far too many rings, gestures with flair as he pours a glowing amber spirit into a cut-crystal glass. His dark hair is perfectly slicked back. His brown eyes meet yours for only a moment. He sports a stylish, thick, well-groomed mustache which covers most of his mouth in a neat hemispherical shape.

Mistress Adda lingers near a column in the corner of the room, eyes calm but sharp. She speaks to no one now, content to observe, like a spider sitting comfortably at the center of her web. You see her eyes dart from one side of the room to another, perhaps making sure everyone is behaving. You get an occasional momentary glance mixed with a warm smile, before she returns to the rest of the Parlor with her scanning eyes.

To your right, a woman leans lazily across a velvet chaise—half-demon by the look of her. Midnight skin, speckled with tiny bright blue bioluminescent marks as if she was wearing the night sky itself on her skin. She has curling horns, and golden eyes that catch the light even when she&#39;s still. Her tail flicks lazily behind her as she watches you, smiling with the kind of hunger that doesn&#39;t belong to mortals. When your eyes meet her you can&#39;t help but feel your heart speed in your chest.

A soft scoff draws your attention as another figure steps back into the room—Marie. Her blouse has been hastily repaired, though the fabric still strains where the tear once split open. Her hair is neat save for a few strands gone astray, but her scowl is sharp. Adda&#39;s eyes meet hers as she enters. A silent exchange passes between them, and Marie&#39;s expression softens—if only slightly. She crosses the floor quickly, heels clicking like punctuation marks, seemingly avoiding anyone&#39;s gaze including your own.

From behind one of the larger couches, a male host appears—dark skinned, broad-shouldered, clean-shaven, with a silk shirt left scandalously half-unbuttoned. He flashes you a smile, the kind that&#39;s too practiced to be genuine, with teeth whiter than a pearls, before he returns to a quiet conversation with a pair of guests lounging nearby.


From here, you may:
[[Approach Adda again and speak with her.|Scene02_TalkToAdda]]
[[Approach the bar and request a drink.|Scene02_BrothelBar]]
[[Speak to the exotic half-demon woman.|Scene02_TalkToExotic]]
[[Strike up a conversation with the male host.|Scene02_TalkToMaleHost]]
[[Follow the upset host and try to speak with her.|Scene02_TalkToAngryHost]]</tw-passagedata><tw-passagedata pid="118" name="Adda_PostSexPhase1" tags="" position="975,1475" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Adda_PostSexPhase1&quot;&gt;&gt;

Adda rises before you&#39;ve even shifted. She moves with quiet finality, gathering her dark blue dress from its heap on the floor and pulling it up her body and onto her arms. The silky material falls against her skin like it never left.

You sit up slowly as she crosses to a low shelf tucked behind the bar. A ceramic teapot waits—still warm, still full. She pours a single cup, adds a measured spoon of honey, stirs without looking.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Apologies if you were hoping to linger, but I have a business to run. Cuddling doesn&#39;t keep the lights on.&lt;&lt;/speech&gt;&gt;

She says it without cruelty. Just truth. You watch the steam rise from her cup as she takes a sip and exhales—quiet, focused. Already in the next moment.

You begin to dress. She doesn&#39;t rush you, but she doesn&#39;t slow down either. The calm between you isn&#39;t intimate—it&#39;s professional. Familiar. Like two performers striking the final pose before the curtain falls.

When you&#39;re both ready, she moves to the inner door leading back to the parlor and opens it with a practiced flick of the wrist.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Come. Let&#39;s not make the others wonder if I&#39;ve decided to retire on a whim.&lt;&lt;/speech&gt;&gt;

You follow her through the velvet curtain. The parlor is quieter now, low laughter and murmured voices brushing the candlelit air. She walks with purpose, already surveying the room, reading it like a ledger.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You really do see everything that happens here, don&#39;t you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I have to. This house only works because someone&#39;s watching when the rest of the world blinks.&lt;&lt;/speech&gt;&gt;

You&#39;re halfway across the floor when it happens.

Light. So bright it swallows everything—color, shape, thought. The room vanishes in a white roar. And then—

Sound. A thunderclap so close it doesn&#39;t crack—it detonates.

Glass behind the bar bursts. The floor lurches. Every guest in the room freezes.

Adda&#39;s head snaps toward the front curtain, her voice suddenly all business.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;That wasn&#39;t distant. Move.&lt;&lt;/speech&gt;&gt;

You push forward with her, the curtain parting beneath your hands. At the brothel&#39;s entrance, the door rattles against its frame.

Through the windows, down the street—

A flicker of orange.

It grows. It dances.

It burns.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[...Fire.|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="119" name="Adda_PrivateScene" tags="" position="1100,1475" size="100,100">&lt;&lt;bg &quot;Adda_PrivateScene&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

The door to her private chamber closes with a decisive click behind you. The sound echoes in the stillness like a judgment passed. No music, no muffled laughter from the floor below—just the rich silence of a room that doesn&#39;t often welcome guests.

Adda moves without hurry, shedding her outer shawl and draping it over a chaise as though undressing were a form of punctuation. Everything about the space feels deliberate. The scent of saffron and roses lingers in the warm air, catching in your throat.

She doesn&#39;t look at you right away. Instead, she adjusts a lamp on the wall, softening the light until it pools golden across the silk-covered bed.

Then she turns. And that gaze of hers—steady, dark, faintly amused—lands on you like a touch.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I&#39;m not sure that you recognize quite how rare it is for someone to be standing here in the position you are in, young Lady. I have not taken anyone back here in quite some time.&lt;&lt;/speech&gt;&gt;

Her voice is velvet wrapped around something sharper. It&#39;s not a question. It&#39;s a reminder.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;So. Shall I reward your diligence... or teach you what it *really* means to please a mistress?&lt;&lt;/speech&gt;&gt;

She steps closer, slowly—never hurrying, never uncertain. One hand reaches out, gliding up your arm, fingertips dragging softly toward your neck. A test, maybe. Or a promise.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Strip, darling. Slowly. I want to see if you can follow orders... before I give the ones that matter.&lt;&lt;/speech&gt;&gt;

&lt;&lt;StartSexScene &quot;adda&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Adda_PostSexPhase1&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="120" name="Allura_GoingUpstairs" tags="" position="1225,1475" size="100,100">&lt;&lt;bg &quot;Allura_GoingUpstairs&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;
&lt;p&gt;You follow her through the parlor, back towards the entrance, and through the heavy velvet curtain. She leads you all the way to the stairs by one hand. As you get to the bottom of the stairs lightning cracks, and thunder bellows. The entryway is illuminated in flashing light for a moment and the foundation shakes be beneath your feet. Allura pauses on the second step; she pivots, facing the glass door.&lt;/p&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Certainly, I hope this storm breaks before morning. Would be a shame for it to ruin the fair.&lt;&lt;/speech&gt;&gt;

She turns on her heels once more and climbs the rest of the stairs holding her skirt in her hands as to not step on it. You follow behind her closely.

At the top of the stairs you enter a long, narrow hallway lined with ten or so doors, each — you assume — belonging to a different host. Allura stops at the second door on the left. She leans against the door frame, turns and looks at you.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Welcome to my humble abode, Mon trésor.&lt;&lt;/speech&gt;&gt;

She reaches down and turns the handle to the door, pushing it open and gesturing with her arm for you to [[step inside.|Allura_UpstairsPhase1]]</tw-passagedata><tw-passagedata pid="121" name="Allura_JustLay_Route" tags="" position="100,1600" size="100,100">&lt;&lt;set $currentPhase = &quot;None&quot;&gt;&gt;&lt;&lt;bg &quot;Allura_JustLay_Route&quot;&gt;&gt;
&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;div id=&quot;montage&quot;&gt;
	&lt;p&gt;You settle in beside her, head finding a soft spot in the sea of cushions. Allura doesn&#39;t pull you close—she lets you come to her at your own pace. But her presence is magnetic, and soon your shoulders touch. Her tail coils near your leg, not quite brushing it.&lt;/p&gt;

	&lt;p&gt;One of her hands finds your hair. She brushes it back, slow and rhythmic, untangling knots that weren&#39;t really there. You close your eyes to the sound of her gentle breathing and the soft hiss of rain outside the window.&lt;/p&gt;
&lt;/div&gt;

&lt;span id=&quot;montage-link&quot;&gt;
	&lt;&lt;link &quot;Some time passes.&quot;&gt;&gt;
		&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
			&lt;&lt;append &quot;#montage&quot;&gt;&gt;
				&lt;div class=&quot;montage-fade fade-start&quot;&gt;
					&lt;p&gt;The lamp light flickers as a draft slips through the hallway. You shift to your side and feel the cushions dip with her weight as she mirrors you.&lt;/p&gt;
					&lt;&lt;speech &quot;allura&quot;&gt;&gt;You tense when you think too much... It makes your bones feel noisy.&lt;&lt;/speech&gt;&gt;
					&lt;p&gt;You laugh, then stifle it when her fingers slide back up to your neck.&lt;/p&gt;
					&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Ooh... Don&#39;t stop.&lt;&lt;/speech&gt;&gt;
				&lt;/div&gt;
			&lt;&lt;/append&gt;&gt;
			&lt;&lt;SceneFadeInNow&gt;&gt;

			&lt;span id=&quot;montage-link&quot;&gt;
				&lt;&lt;link &quot;More time passes.&quot;&gt;&gt;
					&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
						&lt;&lt;append &quot;#montage&quot;&gt;&gt;
							&lt;div class=&quot;montage-fade fade-start&quot;&gt;
								&lt;p&gt;Allura hums now. A tune you don&#39;t recognize. You&#39;re both facing the ceiling, barely touching.&lt;/p&gt;
								&lt;p&gt;Eventually, she shifts closer and drapes one leg across yours, lazily.&lt;/p&gt;
								&lt;&lt;speech &quot;allura&quot;&gt;&gt;Still breathing?&lt;&lt;/speech&gt;&gt;
								&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Best hour of my life.&lt;&lt;/speech&gt;&gt;
								&lt;p&gt;You reply without thinking. She smiles at that. Not the coy one. The real one.&lt;/p&gt;
							&lt;/div&gt;
						&lt;&lt;/append&gt;&gt;
						&lt;&lt;SceneFadeInNow&gt;&gt;

						&lt;span id=&quot;montage-link&quot;&gt;
							&lt;&lt;link &quot;Even more time passes.&quot;&gt;&gt;
								&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
									&lt;&lt;append &quot;#montage&quot;&gt;&gt;
										&lt;div class=&quot;montage-fade fade-start&quot;&gt;
											&lt;p&gt;You don&#39;t remember who moved first, but at some point, you&#39;re tucked against her completely.&lt;/p&gt;
											&lt;p&gt;“You know,” she says, voice quiet and rich, “you&#39;re dangerous in your own way. You&#39;re kind.”&lt;/p&gt;
											&lt;p&gt;You want to say something clever. Instead, you nuzzle her collarbone and say, “Then let me be dangerous a little longer.”&lt;/p&gt;
										&lt;/div&gt;&lt;&lt;/append&gt;&gt;&lt;&lt;SceneFadeInNow&gt;&gt;&lt;&lt;timed 5s&gt;&gt;
										&lt;&lt;replace &quot;#finalLink&quot;&gt;&gt;
											&lt;p&gt;&lt;a id=&quot;finalLink&quot; class=&quot;fade-slow&quot; href=&quot;EverythinggoeswhiteLightningStrikeScene&quot;&gt;Suddenly—&lt;/a&gt;&lt;/p&gt;
										&lt;&lt;/replace&gt;&gt;
									&lt;&lt;/timed&gt;&gt;
								&lt;&lt;/replace&gt;&gt;
							&lt;&lt;/link&gt;&gt;
						&lt;/span&gt;
					&lt;&lt;/replace&gt;&gt;
				&lt;&lt;/link&gt;&gt;
			&lt;/span&gt;
		&lt;&lt;/replace&gt;&gt;
	&lt;&lt;/link&gt;&gt;
&lt;/span&gt;

&lt;div id=&quot;finalLink&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="122" name="Allura_PostSexPhase1" tags="" position="225,1600" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Allura_PostSexPhase1&quot;&gt;&gt;

Allura lounges beside you like a goddess painted into silk—one leg draped over yours, her skin glowing with the heat of what just passed. She doesn&#39;t speak right away. She just exists there beside you—smug, sensual, and devastatingly at ease.

She stretches slowly, arms above her head, the fabric of her robe slipping from one shoulder.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Mmm. Mon trésor...&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

Her voice curls around the words like incense.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You are full of surprises. I thought I had you mapped by now—but then you go and do &lt;em&gt;that&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

You raise an eyebrow. She smirks.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That was you thinking you had me figured out?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Of course. I always think that. Until someone proves me wrong. Which you did—deliciously.&lt;&lt;/speech&gt;&gt;

She rolls onto her side, propping her head on one hand, and drags a single nail lightly down your chest.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Tell me… was it always in you? That hunger? That nerve? Or did I bring it out of you?&lt;&lt;/speech&gt;&gt;

You open your mouth to respond—

And then the world ends.

A blinding flash detonates against the window, bathing the room in pure white. There&#39;s no delay. No pause.

The thunderclap that follows is instant and violent, like the sky itself has been torn open above you. The bed trembles beneath you. The perfume in the air turns sharp. You can taste the charge on your tongue.

Allura bolts upright—fluid, alert. Her playfulness gone in an instant.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Putain de merde—&lt;/em&gt; that was &lt;strong&gt;close.&lt;/strong&gt;&lt;&lt;/speech&gt;&gt;

She moves to the window without waiting, yanking the curtain back. Her eyes narrow.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;There. Down the street.&lt;&lt;/speech&gt;&gt;

You move beside her following her gaze.

An orange glow is climbing the darkness—faint, flickering... spreading.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[...Fire.|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="123" name="Allura_UpstairsPhase1" tags="" position="350,1600" size="100,100">&lt;&lt;bg &quot;Allura_UpstairsPhase1&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You aren&#39;t entirely sure what you expected, but her room surprises you in more ways than one.

It&#39;s dimly lit — not from lack of light, but from choice. A cluster of colored glass lanterns hang in the far corner, casting hues of deep amethyst, rose, and sea-green across the velvet drapes that hang like soft walls over real ones. The air smells faintly of sandalwood and something sweeter, darker — like black cherries left to soak in wine.

The space is smaller than you&#39;d imagined. Intimate. A circular bed rests low to the floor, draped in sheer curtains and piled with cushions in every shade of desire. There&#39;s no vanity, no mirror. No trace of a mask waiting to be put back on. Just an old record player humming gently in the corner with no record turning.

Allura doesn&#39;t close the door behind you right away. She steps past you, brushing your shoulder with hers as she enters, letting her fingers linger on your arm. Her voice loses some of its playful cadence as she speaks next.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Most people don&#39;t make it this far without trying to impress me, or undress me. You seem to want neither. Or maybe both. Perhaps you have not decided yet, either.&lt;&lt;/speech&gt;&gt;

She turns to face you again, her hands resting on her hips, her silhouette framed by the soft light behind her.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So... what shall we do with this quiet?&lt;&lt;/speech&gt;&gt;

You turn and close the door, the bolt clicks into place and now the two of you feel truly alone. When you&#39;ve turned back around Allura is laid back on the mattress, her arms reached above her head. She is calm. She is vulnerable. You can&#39;t help but feel like she truly wants to be in here with you.

&lt;&lt;DialogueTree &quot;allura&quot; &quot;Phase1&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="124" name="Darian_GoingUpstairs" tags="" position="475,1600" size="100,100">&lt;&lt;bg &quot;Darian_GoingUpstairs&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

You follow him out of the parlor and through the heavy velvet-curtained hall, past the lingering music and soft laughter of the parlor. He guides you by the hand the whole way— a proper gentleman&#39;s escort.

As you reach the foot of the stairs, thunder rolls distantly outside. Darian glances toward the door but says nothing. He simply smiles and starts up the steps, his boots light on the old wood.

The hallway above is quiet, lined with rooms like small forgotten stories. Some doors are closed. A few are cracked just enough to spill warm light into the hall.

He leads you to the very end—furthest from everything else—and pauses at a door with a subtle, worn plaque. Not a number. A name.

The brass is dulled with age, but you can make out the engraving: *Avelen*.

He catches your glance.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Stage name. From another life. I like to keep it there for nostalgia now.&lt;&lt;/speech&gt;&gt;

He opens the door without ceremony, stepping aside to let you enter first.

[[You step into his room.|Darian_UpstairsPhase1]]</tw-passagedata><tw-passagedata pid="125" name="Darian_MusicMontage" tags="" position="600,1600" size="100,100">&lt;&lt;bg &quot;DarianMusicMontage&quot;&gt;&gt;
&lt;&lt;set $currentPhase = &quot;None&quot;&gt;&gt;
&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;div id=&quot;montage&quot;&gt;
	&lt;p&gt;Darian crosses the room and brushes the dust cover off a dark upright piano tucked into a curtained alcove. It looks worn but carefully maintained—like it&#39;s been waiting, not forgotten. He runs a hand across the keys once without pressing them, then sits.&lt;/p&gt;

	&lt;p&gt;He doesn&#39;t look at you right away. He just closes his eyes and breathes in. Then his fingers begin to move.&lt;/p&gt;
&lt;/div&gt;

&lt;span id=&quot;montage-link&quot;&gt;
	&lt;&lt;link &quot;Some time passes.&quot;&gt;&gt;
		&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
			&lt;&lt;append &quot;#montage&quot;&gt;&gt;
				&lt;div class=&quot;montage-fade fade-start&quot;&gt;
					&lt;p&gt;At first, it&#39;s only piano. A slow, minor melody that unfolds like candlelight—soft and flickering. The chords are melancholy but not sad. Reflective. Like something that remembers joy without claiming it.&lt;/p&gt;

					&lt;p&gt;You close your eyes. The curtains absorb every echo. This isn&#39;t a performance. It&#39;s a confession.&lt;/p&gt;
				&lt;/div&gt;
			&lt;&lt;/append&gt;&gt;
			&lt;&lt;SceneFadeInNow&gt;&gt;

			&lt;span id=&quot;montage-link&quot;&gt;
				&lt;&lt;link &quot;More time passes.&quot;&gt;&gt;
					&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
						&lt;&lt;append &quot;#montage&quot;&gt;&gt;
							&lt;div class=&quot;montage-fade fade-start&quot;&gt;
								&lt;p&gt;Then he begins to sing.&lt;/p&gt;

								&lt;blockquote&gt;
								&lt;i&gt;“In halls of glass and violet dusk,&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;I wandered once, and dared to trust.&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;The silence watched, the shadows stayed—&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;and yet I sang, though light decayed.”&lt;/i&gt;&lt;br&gt;&lt;br&gt;

								&lt;i&gt;“My sister&#39;s laugh, my mother&#39;s grace,&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;the echo lost in every place.&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;I sing not now to be adored—&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;I sing for ghosts I can&#39;t afford.”&lt;/i&gt;
								&lt;/blockquote&gt;

								&lt;p&gt;His voice is soft, low, haunting. Every note feels chosen. Earned. You don&#39;t move. You don&#39;t breathe too loudly. You just &lt;em&gt;listen&lt;/em&gt;.&lt;/p&gt;
							&lt;/div&gt;
						&lt;&lt;/append&gt;&gt;
						&lt;&lt;SceneFadeInNow&gt;&gt;

						&lt;span id=&quot;montage-link&quot;&gt;
							&lt;&lt;link &quot;Even more time passes.&quot;&gt;&gt;
								&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
									&lt;&lt;append &quot;#montage&quot;&gt;&gt;
										&lt;div class=&quot;montage-fade fade-start&quot;&gt;
											&lt;p&gt;The final note fades into silence. Darian lets his hands fall away from the keys slowly, like he&#39;s afraid the stillness will shatter if he moves too quickly.&lt;/p&gt;

											&lt;p&gt;He looks at you—really looks at you. There&#39;s no performer left in him. Just a man who let go of something heavy and wants to know if it landed softly.&lt;/p&gt;

											&lt;&lt;speech &quot;darian&quot;&gt;&gt;That song&#39;s never had an audience before.&lt;&lt;/speech&gt;&gt;

											&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You should give it more often. If not to them... then to yourself.&lt;&lt;/speech&gt;&gt;

											&lt;p&gt;He smiles, small but warm. His hand lingers near yours, not touching. Just close enough that you feel it.&lt;/p&gt;
										&lt;/div&gt;
									&lt;&lt;/append&gt;&gt;
									&lt;&lt;SceneFadeInNow&gt;&gt;

									&lt;&lt;timed 5s&gt;&gt;
										&lt;&lt;replace &quot;#finalLink&quot;&gt;&gt;
											&lt;p&gt;&lt;a id=&quot;finalLink&quot; class=&quot;fade-slow&quot; href=&quot;EverythinggoeswhiteLightningStrikeScene&quot;&gt;Suddenly—&lt;/a&gt;&lt;/p&gt;
										&lt;&lt;/replace&gt;&gt;
									&lt;&lt;/timed&gt;&gt;
								&lt;&lt;/replace&gt;&gt;
							&lt;&lt;/link&gt;&gt;
						&lt;/span&gt;
					&lt;&lt;/replace&gt;&gt;
				&lt;&lt;/link&gt;&gt;
			&lt;/span&gt;
		&lt;&lt;/replace&gt;&gt;
	&lt;&lt;/link&gt;&gt;
&lt;/span&gt;

&lt;div id=&quot;finalLink&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="126" name="Darian_PostSexPhase1" tags="" position="725,1600" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Darian_PostSexPhase1&quot;&gt;&gt;

Darian lies beside you, one arm behind his head, the other tracing slow, absent lines along your upper arm. His skin is cool, covered in a sweet sheen of sweat. You feel the rise and fall of his breath as it slowly steadies.

For a while, he just gazes up at the ceiling, silent. When he finally speaks, his voice is soft—mellowed by the moment.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You know… I used to think there was nothing sweeter than holding a final note and hearing a crowd hold its breath.&lt;&lt;/speech&gt;&gt;

He glances toward you, lips curling into a faint, crooked smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;That… might be the first thing to ever compete.&lt;&lt;/speech&gt;&gt;

You smack his arm with a grin, laughing.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Gods! How do you still have lame pickup lines &lt;em&gt;after&lt;/em&gt;?&lt;&lt;/speech&gt;&gt;

He rolls onto his side, brushing a knuckle along your collarbone—light as a sigh.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You&#39;re right, that was terrible.&lt;&lt;/speech&gt;&gt;

Your lips curl into a devilish smile as you lean in.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh, so I was that bad, then?&lt;&lt;/speech&gt;&gt;

His face flushes. The smile falters. He stammers an awkward apology. You burst out laughing as he bows his head in exaggerated defeat.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Please, have mercy on me, woman. You do something to me—I lose my edge.&lt;&lt;/speech&gt;&gt;

You&#39;re just about to reply when the world erupts.

A flash of white fills the room—brilliant, blinding, immediate. No delay. The explosion that follows shakes the walls and rattles the floor beneath you.

You feel it in your bones. The hair on your body stands on end. There&#39;s a sharp taste of metal on your tongue.

As the light fades, you blink rapidly, trying to clear your vision. You cross to the window, searching the street outside for answers.

Just down the road, a faint orange glow flickers.

At first, it looks like lamplight.

But then you realize the truth.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[Fire!|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="127" name="Darian_UpstairsPhase1" tags="" position="850,1600" size="100,100">&lt;&lt;bg &quot;Darian_UpstairsPhase1&quot;&gt;&gt;&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You step inside, and the first thing you notice is the quiet.

Not the absence of sound—but a kind of intentional stillness, like the room was waiting for you. The lighting is soft, coming from an old floor lamp with a tasseled shade that throws golden light across the space. No garish colors. No scent of perfume or smoke. Just wood polish, old books, and something faintly herbal.

The furniture is modest and well kept—an upright piano stands against one wall, its top dusted and adorned with a single framed photo turned inward. Beside it, a stack of music books, some well-worn, some pristine. One still bears a theater stamp from another city. Another life.

A velvet armchair sits near the bed, and atop it lies a folded overcoat and a small, flat tin. You recognize it immediately for what it is: a vocal tin, used by singers to keep their throat warm and clear.

There&#39;s no mirror. No vanity. But on the wall above the bed hangs a tapestry—simple, woven, depicting a great lake beneath a starry sky. No name, no inscription. Just still water and distant light.

Darian closes the door behind you gently.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;It&#39;s not much, but it&#39;s mine. What I&#39;ve held onto. What I&#39;ve let go.&lt;&lt;/speech&gt;&gt;

He steps past you and gestures to the bed with a soft smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Make yourself comfortable. You&#39;re safe here.&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase1&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="128" name="Marie_JustLay_Route" tags="" position="975,1600" size="100,100">&lt;&lt;set $currentPhase = &quot;None&quot;&gt;&gt;&lt;&lt;bg &quot;Marie_JustLay_Route&quot;&gt;&gt;
&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;div id=&quot;montage&quot;&gt;
	&lt;p&gt;You lie on your side, facing her. Marie&#39;s hair spills over her pillow in soft, tangled waves. She watches you—not intensely, but openly, like she&#39;s studying something she never thought she&#39;d have a chance to.&lt;/p&gt;

	&lt;p&gt;You both say nothing for a while. Her fingertips trail small patterns on the quilt between you.&lt;/p&gt;
&lt;/div&gt;

&lt;span id=&quot;montage-link&quot;&gt;
	&lt;&lt;link &quot;Some time passes.&quot;&gt;&gt;
		&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
			&lt;&lt;append &quot;#montage&quot;&gt;&gt;
				&lt;div class=&quot;montage-fade fade-start&quot;&gt;
					&lt;p&gt;The rain outside ticks against the window like a soft metronome. Marie shifts closer, not quite touching you. Her voice is quiet when it comes.&lt;/p&gt;

					&lt;&lt;speech &quot;marie&quot;&gt;&gt;Do you ever think about how different your life might&#39;ve been... if you&#39;d just taken one wrong turn and never noticed?&lt;&lt;/speech&gt;&gt;

					&lt;p&gt;You hum in reply. She smiles faintly and lets it drop.&lt;/p&gt;
				&lt;/div&gt;
			&lt;&lt;/append&gt;&gt;
			&lt;&lt;SceneFadeInNow&gt;&gt;

			&lt;span id=&quot;montage-link&quot;&gt;
				&lt;&lt;link &quot;More time passes.&quot;&gt;&gt;
					&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
						&lt;&lt;append &quot;#montage&quot;&gt;&gt;
							&lt;div class=&quot;montage-fade fade-start&quot;&gt;
								&lt;p&gt;You&#39;re both lying on your backs now, staring at the ceiling. Marie lifts one hand and slowly traces constellations you can&#39;t see in the wooden grain above.&lt;/p&gt;

								&lt;&lt;speech &quot;marie&quot;&gt;&gt;They say in Medmarr there&#39;s a lake so deep, it reflects the stars even at noon.&lt;&lt;/speech&gt;&gt;

								&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Have you seen it?&lt;&lt;/speech&gt;&gt;

								&lt;&lt;speech &quot;marie&quot;&gt;&gt;No. But I want to. And I&#39;d rather not go alone.&lt;&lt;/speech&gt;&gt;
							&lt;/div&gt;
						&lt;&lt;/append&gt;&gt;
						&lt;&lt;SceneFadeInNow&gt;&gt;

						&lt;span id=&quot;montage-link&quot;&gt;
							&lt;&lt;link &quot;Even more time passes.&quot;&gt;&gt;
								&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
									&lt;&lt;append &quot;#montage&quot;&gt;&gt;
										&lt;div class=&quot;montage-fade fade-start&quot;&gt;
											&lt;p&gt;At some point, your head finds her shoulder, and her hand settles just above your hip. Neither of you say anything for a long time.&lt;/p&gt;

											&lt;p&gt;Then softly—so softly you almost miss it—she murmurs:&lt;/p&gt;

											&lt;&lt;speech &quot;marie&quot;&gt;&gt;Stay a little longer. Just until the rain stops.&lt;&lt;/speech&gt;&gt;
										&lt;/div&gt;
									&lt;&lt;/append&gt;&gt;
									&lt;&lt;SceneFadeInNow&gt;&gt;&lt;&lt;timed 5s&gt;&gt;&lt;&lt;replace &quot;#finalLink&quot;&gt;&gt;&lt;p&gt;&lt;a id=&quot;finalLink&quot; class=&quot;fade-slow&quot; href=&quot;EverythinggoeswhiteLightningStrikeScene&quot;&gt;Suddenly—&lt;/a&gt;&lt;/p&gt;
									&lt;&lt;/replace&gt;&gt;
									&lt;&lt;/timed&gt;&gt;
								&lt;&lt;/replace&gt;&gt;
							&lt;&lt;/link&gt;&gt;
						&lt;/span&gt;
					&lt;&lt;/replace&gt;&gt;
				&lt;&lt;/link&gt;&gt;
			&lt;/span&gt;
		&lt;&lt;/replace&gt;&gt;
	&lt;&lt;/link&gt;&gt;
&lt;/span&gt;

&lt;div id=&quot;finalLink&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="129" name="Marie_PostSexPhase1" tags="" position="1100,1600" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Marie_PostSexPhase1&quot;&gt;&gt;

Marie lies with her back to you, the candlelight tracing gentle edges across her curves. The bedsheets cling to her hips, one leg stretched long, the other bent in close. She&#39;s quiet. Not withdrawn—just still, like she&#39;s waiting to remember how to breathe.

You reach out, grazing your fingertips down her arm. She doesn&#39;t flinch. Doesn&#39;t speak. Not until a long breath slips out of her nose.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I—&lt;&lt;/speech&gt;&gt;

She looks at you with something between a frown and confusion.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What is it?&lt;&lt;/speech&gt;&gt;

She tries again.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I just don&#39;t know how you did that. You came in here looking innocent as a mouse, disarmed me right in the middle of feeling like an angry feral Noctail and got me to do all of that.&lt;&lt;/speech&gt;&gt;

You can&#39;t help but chuckle a little, an act which almost seems to annoy and confuse Marie even more. She looks at you with her brilliant emerald eyes, waiting for an answer.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If it makes you feel any better, that was not at all the way I expected tonight to go either.&lt;&lt;/speech&gt;&gt;

She finally relents. She smiles.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you for not letting my entire night be awful. It was really nice that you came along. Maybe next time I can learn a thing or two about you instead of you letting me talk about my problems the whole time.&lt;&lt;/speech&gt;&gt;

You nod against the silence. No quip. No follow-up. Just listening.

She shifts slightly, rolling enough that her shoulder brushes yours. A pause. Then a sigh—softer now.

Then it happens.

A blinding flash. Light so white it devours the room, your sight, your sense of space. There&#39;s no time to react before the sound comes—a thunderclap so immediate and powerful it feels like a war drum in your ribs.

Marie is up in an instant. No panic—just motion. A practiced readiness. Her eyes sharpen.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Gods, what the hell?&lt;&lt;/speech&gt;&gt;

You&#39;re already pulling yourself up, heartbeat tripping over itself.

You cross to the window and draw the curtain back. Down the street, an orange glow is licking upward into the night.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[...Fire.|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="130" name="Marie_UpstairsPhase1" tags="" position="1225,1600" size="100,100">&lt;&lt;bg &quot;Marie_UpstairsPhase1&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

You follow Marie through the parlor without a word. She doesn&#39;t take your hand to lead you, but does not go too far in front of you either. She consistently glances over her shoulder to maintain her distance to you. 

She parts the velvet curtain with one hand and steps into the entry hall. A rumble of thunder rolls through the foundation just as you reach the staircase. Marie pauses at the bottom, her gaze fixed on the door, though she does not comment.

She ascends slowly, as if she is trying to make sure of her own balance with each step, her heels soft against the wood. You trail behind her up a narrow staircase, then down a hallway lined with numbered doors. Faint murmurs echo behind some of them. Laughter behind others.

Marie stops at the third door on the left, near the end. It is decorated with simple red jewels, similar in color to the broach she wears. She hesitates—not dramatically, just enough for you to notice—then opens the door and motions gracefully with one hand for you to step inside first.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;This one&#39;s me.&lt;&lt;/speech&gt;&gt;

[[You approached the doorway and take a step inside.|Marie_UpstairsPhase2]]</tw-passagedata><tw-passagedata pid="131" name="Marie_UpstairsPhase2" tags="" position="100,1725" size="100,100">&lt;&lt;bg &quot;Marie_UpstairsPhase2&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You aren&#39;t sure what you expected from Marie&#39;s room, but this… this is surprising.

It&#39;s small, and intimate, but thoughtfully arranged. A single bookshelf stands beside the bed, filled with a modest but curated collection—titles on history, philosophy, poetry, even a few old plays. A soft wool shawl hangs from a hook near the door. The bed is neat, tucked with military precision, save for a few deliberate comforts: an embroidered pillow with frayed edges, a stitched quilt that looks older than the rest of the room&#39;s furnishings.

There are no mirrors. But pinned beside the shelf, a few charcoal sketches are tacked to the wall—faces, flowers, a narrow field beneath a moon. All done by hand. All precise.

Marie closes the door behind you, then quietly turns the lock. The sound is subtle, not ominous. More… final. As though she&#39;s sealing the room off from the noise outside.

She walks past you and sits on the edge of the bed, smoothing the blanket before shifting back to rest against the wall. Then, glancing to the side, she pats the space beside her without a word.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Come sit with me, Jaylie.&lt;&lt;/speech&gt;&gt;

You move to sit beside her. The bed dips gently beneath your weight, but Marie doesn&#39;t shift away. She just pulls her knees up and lets her shoulder brush lightly against yours. As you rest a hard shape pokes your butt. You stand up again to look at what you sat on and Marie reaches beneath the pillow and pulls out a book– &lt;em&gt;Avian Varieties of Medmarr&lt;/em&gt;.
&lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh sorry about that, I was reading this early this morning and must have forgotten to put it back on the shelf. You mind?&lt;&lt;/speech&gt;&gt;

You are closer to the bookshelf so she hands it to you. You take it in your hands and the pages of the book naturally fall open to a page about the &lt;em&gt;Suma&lt;/em&gt; an apparent waterfowl native to the Myridin Lake. The book has a colorised depiction of the creature, perched in the shallows on long, stalky legs, and sporting a vibrant, colorful arrangement of pointed feathers. It&#39;s eyes are intelligent and thoughtful, as if the artist asked the bird to pose and so it had purposely complied. On the opposite page is a half done charcoal recreation of the same bird. Marie&#39;s work.

You look at her and smile before you close the book, turn and place it neatly next to the other&#39;s on the shelf.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re quite the artist.&lt;&lt;/speech&gt;&gt;

She smiles and scoffs; you see blush forming in her cheeks.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;An artist? No. They are just doodles... But anyway... now that we&#39;re alone... what kind of guest are you planning to be?&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase2&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="132" name="Scene01_2a_TheBrothelFront" tags="" position="75,350" size="100,100">&lt;&lt;bg &quot;Scene01_2a_TheBrothelFront&quot;&gt;&gt;
&lt;&lt;speech &quot;adda&quot;&gt;&gt;	
&quot;You &lt;em&gt;lowlife bastard&lt;/em&gt;! Show your face here again I will have you killed, you worm. Trust me every other establishment in the city will hear of you too. You&#39;re lucky I don&#39;t have you lashed in the square.&quot;
&lt;&lt;/speech&gt;&gt;
	
	The man begins to pull up his pants while he states his case.

&lt;&lt;speech &quot;kallot&quot;&gt;&gt;	
&quot;Oooh come *hic* onnn. I &#39;ardly even touched the bitch!&quot;
&lt;&lt;/speech&gt;&gt;
	The apparent &quot;bitch&quot; in question lunged to the front of the group, aggressively shoving the rest to the side. A classically beautiful girl with blonde hair, emerald eyes and rosy cheeks, you noticed immediately the state of disrepair her dress was in, the lacy collar torn down to her midriff exposing her shapely breasts which jiggled with the excitement of her movements. What you didn&#39;t notice immediately was the metallic object which she produced seemingly from nowhere at all. 

	/* Angry Brothel Girl (Marie) .marie #c57e41 */
&lt;&lt;speech &quot;marie&quot;&gt;&gt;
&quot;Bitch, is it? &lt;em&gt;BITCH?!&lt;/em&gt;
&lt;&lt;/speech&gt;&gt;

With astonishing accuracy she launched the projectile, the light of the brothel&#39;s interior glinting off its finish for a fraction of a moment before it collided with the drunken man squarely in the middle of his forehead. The round metal bounced and hit the ground. After what seemed like ages, so too did the man fall, stiff as a board, onto his back. 

&lt;&lt;speech &quot;marie&quot;&gt;&gt;
&quot;Fucking swine.&quot;
&lt;&lt;/speech&gt;&gt;

	
Apparently satisfied with her own work, the girl turns heel, only half covering herself before turning to reenter the establishment, disappearing from view.

	The man in the street does not move again.
 &lt;&lt;set $watchedhsthrow = true&gt;&gt;
/* Referenced if the player still chooses to walk away after seeing marie throw the shoe */

The scene quickly dissipates as the rest of the brothel girls make their way back inside. The brothel&#39;s madam reaches outside, taking hold of the door and with a final scoff and a look down towards the man on the cobblestones, she closes the door. The orange glow on the street nearly disappears.

[[You approach the unconscious man|Scene01_2b_TheBrothelFront]]

[[Forget him. They might have drinks in there.|Scene02_TheBrothelEntry]]

[[That place seems like trouble. I should head to the tavern.|Scene01_2b_ToTheTavern]]</tw-passagedata><tw-passagedata pid="133" name="Scene01_2b_TheBrothelFront" tags="" position="75,450" size="100,100">&lt;&lt;bg &quot;Scene01_2b_TheBrothelFront&quot;&gt;&gt;
Soaking in rain and now shadowed by darkness, you approach the man. Your heels click quietly on the cobblestone as you draw near. Without so much as a crouch you look upon his immobile form, examining him.

	The man is human, that much is obvious. He has dark hair, which in its drenched state mixed with the darkness of the fallen night, you cannot tell if it&#39;s brown or black. He has a rather chiselled look and were it not for the performance you just witnessed from him, you might&#39;ve even considered him attractive.

	A steady stream of blood flows from the fresh wound on his forehead. Its darkness is quickly washed away by thick, heavy raindrops falling freely upon his still form in rhythmic taps. The wound seems superficial enough, but he surely will feel it in the morning. 

	Remembering the metal object that acted as the man&#39;s undoing, you glance around him to see what exactly it was that the woman had thrown.

	After a moment you see it. You bend over at the waist and pick up an &lt;em&gt;unusually&lt;/em&gt; small horseshoe. Suddenly a question dawns on you.

	&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;&lt;em&gt;Where the hell had she pulled this from?&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

&lt;div id=&quot;horseshoe-choice&quot;&gt;
Do you &lt;&lt;link &quot;take it&quot;&gt;&gt;
	&lt;&lt;replace &quot;#horseshoe-choice&quot;&gt;&gt;&lt;span class=&quot;tightblock&quot;&gt;You decide to keep it.&lt;/span&gt;&lt;&lt;/replace&gt;&gt;
	&lt;&lt;append &quot;#horseshoe-result&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	You tuck the horseshoe into your belt.
	&lt;&lt;additem &quot;player&quot; &quot;lucky_horseshoe&quot; 1&gt;&gt;
	&lt;&lt;append &quot;#horseshoe-followup&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	You glance back over at the man and a mix of emotions flow through you.&lt;br&gt;
	[[Maybe you should help him|Scene01_2c_HelpHim]]&lt;br&gt;
	He did get himself into this situation. [[The brothel looks more inviting anyway.|Scene02_TheBrothelEntry]]&lt;br&gt;
	[[I really should get going to the tavern.|Scene01_2b_ToTheTavern]]
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
&lt;&lt;/link&gt;&gt; or &lt;&lt;link &quot;leave it&quot;&gt;&gt;
	&lt;&lt;replace &quot;#horseshoe-choice&quot;&gt;&gt;&lt;span class=&quot;tightblock&quot;&gt;You can&#39;t think of any type of need for the object and half-heartedly toss it back to the ground at your feet. &lt;/span&gt;&lt;&lt;/replace&gt;&gt;
	&lt;&lt;append &quot;#horseshoe-result&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	&lt;&lt;append &quot;#horseshoe-followup&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	You glance back over at the man and a mix of emotions flow through you.&lt;br&gt;
	[[Maybe you should help him|Scene01_2c_HelpHim]]&lt;br&gt;
	He did get himself into this situation. [[The brothel looks more inviting anyway.|Scene02_TheBrothelEntry]]&lt;br&gt;
	[[I really should get going to the tavern.|Scene01_2b_ToTheTavern]]
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
&lt;&lt;/link&gt;&gt;?
&lt;/div&gt;

&lt;div id=&quot;horseshoe-result&quot;&gt;&lt;/div&gt;
&lt;div id=&quot;horseshoe-followup&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="134" name="Scene01_2b_ToTheTavern" tags="" position="225,300" size="100,100">&lt;&lt;bg &quot;Scene01_2b_ToTheTavern&quot;&gt;&gt;
&lt;&lt;if $watchedhsthrow&gt;&gt;
&lt;p&gt;Thinking it is better to not insert yourself where it is not your business, you turn away from the commotion and continue down Kings Street towards the [[tavern|Scene01_2c_ToTheTavern]].&lt;/p&gt;
&lt;&lt;else&gt;&gt;
Certainly whatever that is about is none of your business. As you turn your head and keep walking down Kings Street you pull your hood more firmly against the hardening rain. After just a few steps you hear muffled through the rain,
&lt;&lt;speech &quot;marie&quot;&gt;&gt;&lt;span class=&quot;faintvoice&quot;&gt;&quot;Bitch, is it? &lt;em&gt;BITCH?!&lt;/em&gt;&quot;&lt;/span&gt; /*Fog text macro/ roll perception to hear this through the rain while walking away, needs correcting in its current state */&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;&lt;em&gt;[[I would hate to be that guy right now.|Scene01_2c_ToTheTavern]]&lt;/em&gt;&lt;&lt;/speech&gt;&gt;
&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="135" name="Scene01_2c_HelpHim" tags="" position="600,1725" size="100,100">&lt;&lt;bg &quot;Scene01_2c_HelpHim&quot;&gt;&gt;
&lt;&lt;set $helpedkallot = true&gt;&gt;
Falling harder now, the rain continues to pour mercilessly upon the bloodied man. Pools of water mixed with a deep crimson fill the divots of his closed eyes. 

You let out a sigh.
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can&#39;t leave you here.&lt;&lt;/speech&gt;&gt;

You lean down and grab him by his shirt, pulling him out of his prone position and slowly dragging him from the middle of the street. After a few moments of dragging him towards the alley, you manage to prop the man up against the side of the building, protecting him from the worst of the weather underneath the eaves of the roof. Here at least, you think, he will be slightly protected from the elements.

Once again you examine the wound on his head. It has already begun to swell. In his new sitting position the bleeding, however, seems to have slowed at least a bit. Still you decide it may help to give it some pressure and coverage. You reach into your cloak and produce a ratty handkerchief.

You twirl the cloth into a coiled rope shape and reach over the man&#39;s head, wrapping the coil tightly against his forehead and tying it off at the back of his skull. As you do this, the drunkard for the first time since getting hit begins to move. He looks up at you with sleepy, crossed eyes, and then of all things, smiles. 

&lt;&lt;speech &quot;kallot&quot;&gt;&gt; &quot;You have such lovely *hic* hair. &lt;&lt;/speech&gt;&gt;

His eyes instantly droop again and once more consciousness escapes him. 

You finish your knot and then stand. Without bringing him to an infirmary and ruining your own night, you suppose this is the best you can do. It is certainly more than he probably deserves. 

I really should get going to the [[tavern.|Scene01_2b_ToTheTavern]]
All this dragging men in the rain has the [[brothel|Scene02_TheBrothelEntry]] looking great.</tw-passagedata><tw-passagedata pid="136" name="Scene01_2c_ToTheTavern" tags="" position="475,150" size="100,100">&lt;&lt;bg &quot;Scene01_2c_ToTheTavern&quot;&gt;&gt;
Before long you step beneath the tall, ornately carved stone archway that marks the edge of King&#39;s Market Square, and the world opens wide before you.
The square, paved in a mosaic of dark, glistening cobblestone, stretches out like a dull mirror beneath the gray, cloud-choked sky. Rain pools in the dips between stones, reflecting the warm lantern-light bleeding from shuttered shopfronts and upper-floor windows. The buildings that encircle the square are tall, sturdy things—crafted of dark stone, carved cornices, and slate roofs slick with rain. Their angles stand proud and immovable, like sentinels bearing witness to centuries of trade, betrayal, and proclamation.
But now, in the wake of the sudden Spring storm, the square lies mostly deserted. Only a few figures hurry through the mist, cloaks pulled tight, heads bowed against the water and wind.
And yet one man stands firm in the center of it all.
A ragged canopy—stitched of mismatched fabrics and affixed to a crooked wooden frame—shelters him from the worst of the weather. Beneath it, on a makeshift crate, the man looms like a scarecrow imbued with the powers of a voice. His face is sunken and pale, his eyes wild and rimmed with red, and his hands flail with frantic rhythm as he speaks to no one and everyone.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; “They &lt;em&gt;dream in the roots&lt;/em&gt;, I tell you! The dead—they &lt;em&gt;wait&lt;/em&gt; in the roots! And when the &lt;em&gt;youngest&lt;/em&gt; bleeds her mother&#39;s name, the &lt;em&gt;rain shall never stop&lt;/em&gt;.” &lt;&lt;/speech&gt;&gt;
His voice carries despite the rain, crisp and too-clear. He points at passersby as they scurry past him, damning them one by one with vague gestures and mad proclamations.
You keep your distance as best you can, adjusting your path to give him a wide berth. But his head snaps toward you the moment you step into the open.
His eyes lock with yours.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt;  &lt;em&gt;You.&lt;/em&gt; &lt;em&gt;You.&lt;/em&gt; &lt;&lt;/speech&gt;&gt;
[[You freeze.|Scene01_2d_TheCrier]]</tw-passagedata><tw-passagedata pid="137" name="Scene01_2d_TheCrier" tags="" position="475,250" size="100,100">&lt;&lt;bg &quot;Scene01_2d_TheCrier&quot;&gt;&gt;
The man&#39;s gaze is intense. His large, pitted eyes open up something in you and you feel unable to break free of him.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; The &lt;em&gt;Kind one&#39;s echo&lt;/em&gt;. The &lt;em&gt;shackled flame&lt;/em&gt;... The &lt;em&gt;storm that walks&lt;/em&gt;. &lt;&lt;/speech&gt;&gt;
The man climbs down from his box, stepping from beneath the imaginary shelter of his canopy and into the rain. A hard wind blows against him as he quickly approaches you, what is left of his scrappy white hair flowing freely around the form of his face. You feel stuck in place.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; &lt;em&gt;Hear me, girl!&lt;/em&gt; You come from a place whence you shall &lt;em&gt;never truly return&lt;/em&gt;. Your eyes shall be the ones of &lt;em&gt;darkness&lt;/em&gt; which men &lt;em&gt;pray not meet&lt;/em&gt;. Don&#39;t you understand!? The &lt;em&gt;crimson goddess curses you already&lt;/em&gt;. You will have no choice—&lt;em&gt;but now you do&lt;/em&gt;!&lt;&lt;/speech&gt;&gt;
He reaches through the air toward you. The lurching motion snaps you from the trance you felt during his approach. As you step back, he collapses to the ground where you just stood.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; Only &lt;em&gt;you&lt;/em&gt; can spare the city from the grip of &lt;em&gt;darkness&lt;/em&gt;, but that darkness will &lt;em&gt;plant its seeds in you&lt;/em&gt;. &lt;&lt;/speech&gt;&gt;
His head drops to the ground and he continues to mumble quietly at your feet. His words hang in the air like wet wool—heavy, clinging, impossible to shake off.
At a loss for words you just begin to walk away, unable to pull your eyes from the man crumpled on the ground.
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; &lt;em&gt;What the fuck…madman.&lt;/em&gt; &lt;&lt;/speech&gt;&gt;
You move away from him quickly, your boots tapping sharply on stone as you cross the rain-streaked square. Finally, you peel your eyes away from his form and toward the far side of the square, where the tavern waits—a squat, inviting shape glowing with amber warmth. The laughter and clatter of its patrons drift just loud enough to break through the rain and invite you closer.
Still… you feel the weight of his words pressing against your back, long after you&#39;ve turned away.

After a moment you step up to the door and step inside the [[Three Sips Dragon.|Scene03_ThreeSipsDragon_Entry]]</tw-passagedata><tw-passagedata pid="138" name="Scene01_1" tags="" position="75,250" size="100,100">&lt;&lt;bg &quot;Scene01_1&quot;&gt;&gt;
You continue walking, your cloak flowing in the wet air behind you. You reach up and pull the hood of your cloak further over your ears and hair. It&#39;s times like these that your lineage can be an annoyance. The prolific dark maroon of your hair is a trait that you shared with your mother, Queen Ralmorra the Kind.

	If the queen&#39;s reputation were to be believed, your mother was closer to being a saint than anyone whom you&#39;d ever met in your life. She was a pinnacle of good in the Kingdom, and often spent her days among the people, using her training as a doctor from her life before becoming royalty to personally take care of her subjects. This was something your father often talked about in a tone that started sweet on his tongue, but always turned sour in his mouth; the memory of Ralmora&#39;s passing weighing on his very soul.

/* First instance of &quot;speech&quot;. Needs formatting with portrait, outline, and proper coloring (.jaylie #A24857, Light Maroon). */  

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; &lt;em&gt;If only I&#39;d met her.&lt;/em&gt; &lt;&lt;/speech&gt;&gt;
Off to your left a sudden commotion grabs your attention as the front door of an establishment, apparently a brothel or something of the sort, bursts open. A man goes flying to the cold hard stones of the street. Standing in the doorway, covered by the warm, dry glow of candlelight, a group of women stand, scantily clad in colorful dresses. The woman in the front of the group, older than the rest and clad in a slightly more reserved attire of darker greys and black, seems to be the one who shoved the man. 

You assume she is the Mistress of the establishment.

[[Stop and pay attention to the commotion.|Scene01_2a_TheBrothelFront]]

[[That&#39;s none of my business. I have places to be.|Scene01_2b_ToTheTavern]]</tw-passagedata><tw-passagedata pid="139" name="StoryStart_Scene01" tags="" position="50,100" size="100,100">&lt;&lt;bg &quot;StoryStart_Scene01&quot;&gt;&gt;
Rain falls on the cobblestone streets all around you. The end of the day for the city is apparent, made obvious in the sounds of shops being shuttered and family dinners muffled by foggy glass. You suppose now would be the moment the oranges and purples of the sky would begin melting into the blackness of moonless night, however the sudden rain clouds clog the sky above.

You are one of few people left on the street. Most others find themselves covering their heads as they frantically secure their wares, or usher their families and children through the doors of their house in an attempt to escape the sudden Spring shower. You, however, are not the least bothered. The rain could never be an issue to you. After all you have a mission, a goal in mind. 

	You need a [[drink|Scene01_1]].</tw-passagedata><tw-passagedata pid="140" name="DiceRat_CallEvent" tags="" position="1225,1725" size="100,100">A sharp clatter of dice and shouted curses cuts through the tavern’s usual noise. You turn toward the game table just in time to see one of the players—the only one not laughing—get up in a huff, knocking his chair back hard enough to draw more than a few stares. His face is red, his coin purse lighter, and his pride clearly wounded.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi, wipe that look off your face, handsome! You still got your boots—should be thankin’ me for lettin&#39; you walk out with those.&lt;&lt;/speech&gt;&gt;

The loudest of the trio kicks the empty chair with his boot, sending it spinning. His companions wheeze with laughter, like it’s the best thing they’ve seen all week.

Then his eyes find you across the tavern.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi! Red! You keen to play? Chair’s warm and luck’s waitin’. Won’t even make you polish me knob. Unless you lose, of course.&lt;&lt;/speech&gt;&gt;

The others cackle again, one of them already shuffling the dice in his hands, eager for a new mark—or maybe just new entertainment.

[[Approach the Dice Table.|Scene03_DiceIntro]]

[[Ignore Sarjan and head back to the tavern.|Scene03_SkipDiceGame]]</tw-passagedata><tw-passagedata pid="141" name="PostCAndCLose" tags="" position="100,1850" size="100,100">&lt;&lt;bg &quot;crownandcaste-table&quot;&gt;&gt;

Sarjan leans back with both arms wide, the clatter of the final dice still echoing as he rakes the pot toward himself with smug, meaty fingers.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Better luck next time, sweetheart. If you’re lucky, I’ll even let you polish the pot before I win it again.&lt;&lt;/speech&gt;&gt;

The two dice rats hoot like they’ve just witnessed divine comedy. One of them nearly chokes on his drink.

You exhale slowly. You lost, sure — but not by much. And you’ll be damned if Sarjan gets to strut away without at least one bruise to his pride.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You know, Sarjan… it’s impressive, really. Takes a special kind of man to win a game of chance and still sound like he’s compensating.&lt;&lt;/speech&gt;&gt;

The laughter cuts off like a blade through string.

Sarjan blinks.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;The fuck you just say to me?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh, I’m sorry — did I use too many syllables? I meant: you’ve got the dice, but not the stones.&lt;&lt;/speech&gt;&gt;

A sharp silence snaps through the table. Even the air feels tense, like the tavern itself is holding its breath.

Sarjan’s jaw tightens. His face goes crimson, mouth twisted in an ugly, wet sneer.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;That’s it, you little brat—&lt;em&gt;I’ll show you stones!&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

[[He lunges across the table!|TavernFightScene]]</tw-passagedata><tw-passagedata pid="142" name="PostCAndCWinFightSetup" tags="" position="225,1850" size="100,100">&lt;&lt;bg &quot;crownandcaste-table&quot;&gt;&gt;

The final die clatters to a stop. A perfect lineup. Your hand barely touches the table before Sarjan slams his fist down, scattering chips and curses alike.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Huh. Would you look at that.&lt;&lt;/speech&gt;&gt;

You stretch lazily, letting the silence thicken. Then you grin — all teeth and satisfaction — and rake the pot toward your side of the table.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Some beginner&#39;s luck, huh?.&lt;&lt;/speech&gt;&gt;

The dice rats fall silent. One of them lets out a stifled snort that he tries to smother in his drink. The other looks like he just bit his own tongue.

Sarjan’s face twists. His nostrils flare, his knuckles whiten, and for a heartbeat it looks like he’s chewing on nails instead of words.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;You little—&lt;em&gt;slitch&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

He stands so fast his chair topples backwards, hitting the tavern floor with a dull crack.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;You think you&#39;re clever, is that it?!&lt;&lt;/speech&gt;&gt;

The air shifts. The nearby chatter dies off. The dice rats scoot back from the table, suddenly very interested in the far corners of the room.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What&#39;s the matter? Can&#39;t take a little loss without flipping the table?&lt;&lt;/speech&gt;&gt;

Sarjan’s hand twitches toward his belt — not quite drawing anything, but close enough to set your pulse humming.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;I’ll show you what losing feels like.&lt;&lt;/speech&gt;&gt;

[[He charges you!|TavernFightScene]]</tw-passagedata><tw-passagedata pid="143" name="Scene03_ApproachBountyHunter" tags="" position="350,1850" size="100,100">&lt;&lt;StartDialogueLayout&gt;&gt;&lt;&lt;bg &quot;Scene03_ApproachBountyHunter&quot;&gt;&gt;
The man in the corner doesn&#39;t look up as you approach—not at first. He continues dragging a whetstone down the edge of his dagger in slow, practiced strokes. His cloak is pulled back just enough to reveal a polished leather chestplate too clean to have seen real battle. The dark, tailored armor gleams faintly in the firelight, stitched with crimson threading that looks more decorative than durable.

Atop his head sits a wide-brimmed hat—deep gray, too dramatic for this tavern by half—plumed with a long, vividly colored feather that arcs like a banner. Everything about him is curated. Styled. Flashy. From the glint of his rings to the way his boots rest just-so, crossed at the ankle.

Eventually, he speaks—low, smooth, like a man who assumes you came here on purpose.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Something I can help you with?&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;redmarrow&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="144" name="Scene03_BarkeepDialogue" tags="" position="375,600" size="100,100">&lt;&lt;bg &quot;threesipsdragon_bar&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You decide to approach the bar and finally get your drink. As you approach, movement in the rafters catches your attention. You turn your gaze upward.

An orange-spotted noctail, which you hadn&#39;t noticed before, extends its rear into the air, pulling itself into a long, satisfying stretch. You watch for a moment as the feline finishes stretching and effortlessly bounds across the width of the room to a rafter on the opposite side, nearly thirty feet away. Despite the commonality of noctails in the city, their grace always amazes you.

You reach the bar and take a seat on a thick, heavy stool. Scooting closer, you settle your elbows onto the polished wood.

The barman steps forward and leans heavily onto the bar in front of you, resting his bulk onto hands as wide as battleaxes.

&lt;&lt;DialogueTree &quot;harroc&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="145" name="Scene03_DiceIntro" tags="" position="600,1850" size="100,100">&lt;&lt;bg &quot;crownandcaste-table&quot;&gt;&gt;

You slide into the now-empty chair. The other three players are already grinning like cats who’ve cornered a crippled mouse. Dice clatter between them—worn bone cubes inked with strange symbols and dark smudges that might be blood, or just years of spilled drink.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Right then. Pay attention, Red. I’m not explainin’ this twice.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;diceratone&quot;&gt;&gt;That&#39;s right tell er&#39; Sarjan!&lt;&lt;/speech&gt;&gt;&lt;&lt;know &quot;sarjan&quot;&gt;&gt;

Sarjan looks at the man who spoke with a stern scowl. Swiftly he reaches across the table and slaps the dice-rat across the ear.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;If you wouldn&#39;t fucking interrupt me, I&#39;d a been explainin&#39; it to er&#39; already.&lt;&lt;/speech&gt;&gt;

The second yes-man chuckles. The firs just leans in, holding his ear, looking sorry.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;This here&#39;s Crown and Caste. Four players, three dice each, the &lt;strong&gt;Caste dice&lt;/strong&gt;, and three shared dice in the middle, the &lt;strong&gt;Crown dice&lt;/strong&gt; Your goal? Lock the best damn combonation you can in three turns. There&#39;s bout fifteen combonations or so, but most of them are self-explanatory.&lt;&lt;/speech&gt;&gt;

He lifts a dice cup and shakes it once for show. The sound is oddly threatening.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;We take turns rollin’. Each roll, you can lock in dice— if ye&#39; don&#39;t they are rerolled on the next turn. But once you lock &#39;em, they stay. No backsies.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;dicerattwo&quot;&gt;&gt;And you’ve only got three rolls total—unless you burn a Control Chip to cheat fate.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;diceratone&quot;&gt;&gt;Or to fuck yourself over more efficiently. Depends how clever you are.&lt;&lt;/speech&gt;&gt;

Sarjan flashes a grin like a rusted dagger.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Scoring&#39;s simple if your brain ain&#39;t mush. Straights, groups of the same number, groups of pairs... Highest score wins the round, gets the pot. Second highest? Don&#39;t fucking matter none, if you ain&#39;t first yer last.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Lose all your coin, and you&#39;re out.&lt;&lt;/speech&gt;&gt;

The dice rattle again. Sarjan slides the pot to the center of the table.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Alright, Jaylie. Let&#39;s see if you’ve got more than hot air behind that smirk.&lt;&lt;/speech&gt;&gt;

&lt;&lt;CrownAndCaste 15 &quot;Dice Rat 1&quot; &quot;sarjan&quot; &quot;Dice Rat 2&quot; &quot;PostCAndCWinFightSetup&quot; &quot;PostCAndCLose&quot; 2.5&gt;&gt;</tw-passagedata><tw-passagedata pid="146" name="Scene03_DiceRatRejection" tags="" position="725,1850" size="100,100">You approach the dice table—a clutter of ale mugs, crumpled betting slips, and three loud mouths with louder laughs. Four players are seated, but it’s clear who’s holding court: a wiry, mean-eyed man with a scar across his chin and a voice like gravel marinated in whiskey. 

He sees you coming before you say a word.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi, lads—would you look at that? The tavern’s got dessert walkin’ over on two legs.&lt;&lt;/speech&gt;&gt;

The other two snicker, elbowing each other.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you have room for one more?&lt;&lt;/speech&gt;&gt;

Sarjan leans back in his chair, boots up on the table like he owns the place.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Mmm... tempting. But unless you’re plannin’ to warm my lap or polish me knob while we play, I’d say we’re full up, sweetheart.&lt;&lt;/speech&gt;&gt;

The others howl with laughter, slapping the table and nearly spilling their drinks. One of them mimes scooting over, only to wave you off with a wink.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Come back when one of these pissants loses all their coin—shouldn’t take long.&lt;&lt;/speech&gt;&gt;

You stand there for a beat, the heat of their laughter washing over you. Then you turn and walk away.


[[Return to the tavern.|Scene03_TheSpace]]</tw-passagedata><tw-passagedata pid="147" name="Scene03_Firewatcher" tags="" position="850,1850" size="100,100">&lt;&lt;StartDialogueLayout&gt;&gt;&lt;&lt;set $calledSilks to $calledSilks or 0&gt;&gt;
As you step toward the hearth, the half-orc woman turns just slightly—enough to clock you, not enough to welcome you.

She sizes you up with a glance, tearing another bite from the mutton before speaking.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Your perfume is ruining the taste of my dinner. What do you want, Silks?&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

&lt;&lt;DialogueTree &quot;brakka&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="148" name="Scene03_SecludedCorner" tags="" position="975,1850" size="100,100">&lt;&lt;bg &quot;Scene03_SecludedCorner&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You slip between the tables and claim a worn corner booth by yourself. The wood creaks under your weight, the seat still warm from whoever sat here last. For a moment, you watch the flicker of firelight dance across the floor, the sound of clinking mugs and shouted laughter rolling over you like a tide.

She approaches from the side, hips swaying with purpose and a smirk already playing on her lips.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;You drinking alone tonight, Miss?.&lt;&lt;/speech&gt;&gt;

You smile but don&#39;t have a chance to respond. She rests a hand on the table, leaning just close enough to let the scent of something floral and strong—like lilac and whiskey—hit you at once.
&lt;&lt;set $characters[&quot;tesska&quot;].known = true&gt;&gt;
&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Name&#39;s Tesska. Can I get you something, sweetheart? Or are you just here to make the furniture look pretty?&lt;&lt;/speech&gt;&gt;

You glance up to meet her gaze—bright, mischievous, and utterly unbothered.
&lt;&lt;set $tesskaOrderedDrink = false&gt;&gt;
&lt;&lt;DialogueTree &quot;tesska&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="149" name="Scene03_SkipDiceGame" tags="" position="1100,1850" size="100,100">&lt;&lt;bg &quot;tavern-fight-pending&quot;&gt;&gt;

You fold your arms and cock your head, giving the man at the table the kind of look normally reserved for roaches in breadboxes.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I think I’d rather scrub the floor with my tongue than sit next to you.&lt;&lt;/speech&gt;&gt;

The table goes still.

The boisterous man blinks—just once. Then the grin drains from his face like bad beer through a split mug.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi, what’d you say to me?&lt;&lt;/speech&gt;&gt;

His cronies glance at each other, not sure whether to laugh or duck. Sarjan shoves back from the table, rising to full height—narrow, twitchy, all brittle swagger and wounded pride.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;I was tryin’ to be friendly, you cocky little twat. Should’ve known a mouth like yours came without a brain to slow it down.&lt;&lt;/speech&gt;&gt;

You smile, razor-thin.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Then I guess we both learned something tonight.&lt;&lt;/speech&gt;&gt;

Chairs scrape. A tankard hits the floor. One of the cronies mutters “Shit...” just as Sarjan lunges.

[[The tavern erupts in chaos.|TavernFightScene]]</tw-passagedata><tw-passagedata pid="150" name="Scene03_TheSpace" tags="" position="475,450" size="100,100">&lt;&lt;EndDialogueLayout&gt;&gt;&lt;&lt;bg &quot;threesipsdragon&quot;&gt;&gt;&lt;&lt;set $TavernTalkCount to $TavernTalkCount or 0&gt;&gt;
&lt;&lt;if !$seenTavernSpace&gt;&gt;
Surrounding the center hearth, more than a dozen figures cluster at thick wooden tables—scarred by knives, stained by drink, and mismatched in shape. The fire’s warmth ripples outward, licking the cracked flagstone floor and painting the rafters above in flickering gold.
&lt;&lt;/if&gt;&gt;

The bar stretches along the eastern wall, its counter worn smooth by time and tension. Behind it stands the barkeep—massive, grim, and seemingly committed to the slow execution of a single glass. He polishes it with the focus of a man settling a grudge.

Slumped beside him, head buried in his arms, a man snores softly into the crook of his elbow. Judging by the wobble of his stool and the crust of dried ale at his chin, he’s been a fixture of that spot for hours—if not days.

Across the room, a barmaid threads through the crowd with practiced grace, a tray of frothing mugs balanced in one hand like a weapon. Her braid swings like a pendulum, and her boots make no sound against the stone.

&lt;&lt;if !$seenTavernSpace&gt;&gt;
One of the patrons—red-faced and too drunk to remember his own hands—reaches for her as she passes. Without breaking stride, she twists at the waist and slams his wrist against the table with a move so fluid it seems rehearsed.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt; &quot;Try that again and you’ll be wearin’ your bollocks like earrings.&quot;&lt;&lt;/speech&gt;&gt;

The room barely reacts. The man yelps, but no one comes to his defense.
&lt;&lt;/if&gt;&gt;

The offender and his two friends stew in their corner, muttering into overturned tankards and picking half-heartedly at the bones of a shared meat pie.

Elsewhere, at a long communal bench near the hearth’s edge, an older man eats in silence. He’s flanked by two others—both silent, both chewing with the intensity of soldiers pretending not to listen.

Nearby, a more raucous table erupts with noise. Four men are locked in a tense dice game, knuckles white, coins scattered, curses loud. One slams the table with a triumphant shout as the bones scatter, while another curses so creatively he draws a laugh from a table over.

In the far northwestern corner, a figure reclines beneath the shadow of his own wide-brimmed hat. His legs are propped on the table’s edge, and in one hand he methodically sharpens a thin-bladed dagger. Between strokes, he sips from a delicate stemmed glass filled with something dark and expensive-looking. He doesn’t seem to notice—or care—that anyone else exists.

Leaning against a thick support beam near the hearth, a hulking woman watches the room with quiet disdain. She doesn’t sit—just looms, like she’s too restless or too proud to claim a seat.

A heavy fur is draped across her shoulders, its coarse texture concealing her chest without much ceremony. Her arms are bare—cords of muscle twisted like ropes beneath green-tinged skin. She wears no shirt, just a leather wrap beneath the fur and a belt strapped tight across her exposed midriff. From the belt hangs more fur, forming a crude skirt that sways with her movements.

In one hand, she grips a massive leg of mutton. In the other, a heavy metal mug of ale or something equally punishing. At her hip rests a greatsword nearly as tall as she is, the tip of its battered sheath brushing the floor with each subtle shift of her stance.

She tears off a bite of meat with thicker-than-average teeth, then scans the room with eyes that dare someone—anyone—to ruin her meal.

&lt;&lt;set $seenTavernSpace = true&gt;&gt;

From here, you may:
[[Approach the bar and speak with the barkeeper.|Scene03_BarkeepDialogue]]
[[Try your luck joining the dice game.|Scene03_DiceRatRejection]]
[[Approach the cloaked man in the corner.|Scene03_ApproachBountyHunter]]
[[Observe the half-orc woman.|Scene03_Firewatcher]]
[[Find an unoccupied corner and sit alone.|Scene03_SecludedCorner]]</tw-passagedata><tw-passagedata pid="151" name="Scene03_ThreeSipsDragon_Entry" tags="" position="475,350" size="100,100">&lt;&lt;bg &quot;threesipsdragon&quot;&gt;&gt;
You pull open the heavy oaken door and step inside. The wind whips at the precipice behind you but the warmth of the hearth greets you like the warm hug of a fellow, you instinctively lower your hood, water spilling down off of it.
Inside the Three Sips Dragon /* Thinking about having inline words you can hover over or click on to show little lore boxes like Alt-Text, entering a passage with one of these words will also add that information to the codex like a living and growing lore-book */, the air is thick with smoke, laughter, and the scent of hearth-brewed ale. Lanterns swing slightly overhead, their flickering light dancing across polished wood beams and walls darkened with age and spilled stories. The tavern&#39;s heart—a great firepit sunk into the floor—crackles merrily near the center of the room, casting long shadows that play on the faces of patrons scattered throughout.
A few eyes drift toward you, but none linger. Bastion is full of cloaked figures in rain-soaked hoods. No one spares much mind for another.
Except one.
&lt;&lt;speech &quot;randompatron1&quot;&gt;&gt; &quot;&lt;strong&gt;Close the damn door&lt;/strong&gt;, you&#39;re lettin&#39; the warm out, girl!&quot; &lt;&lt;/speech&gt;&gt;
Someone near the hearth waves a half-eaten leg of something at you without even turning. A few chuckles follow.
Heeding his words, you reach behind you and close the door, and just like that you are absorbed into the room.
To your right, the bar stretches across the far wall, worn smooth by time and elbows. Behind it, a man, tall and thick as a tree trunk, polishes a glass that doesn&#39;t seem to need polishing. His head is a shining dome, rich with wrinkled skin, his face, nestled atop a thick dark beard, is etched with long years and longer nights, but his eyes—piercing and pale blue—fix on you the moment you lower your hood.
He does little to acknowledge your existence aside from a half-hearted glance, barely longer than a blink.
[[You look around at the rest of the room.|Scene03_TheSpace]]</tw-passagedata><tw-passagedata pid="152" name="TavernLightningScene" tags="" position="225,1975" size="100,100">A flash.
White, searing, god-sent.

It splits the sky—and the tavern—down the spine. The thunder follows instantly, as if the world itself forgot to blink.

The Noctail shrieks from the rafters, flailing into a tangle of limbs and panicked wings. It slams against the floorboards, scrabbling under tables as tankards crash and patrons shout in stunned confusion.

The air turns electric, thick with ozone. You taste metal.
Your teeth buzz. Your ears ring with a high, cruel whine that drowns out the world.

The foundation of the Three Sips Dragon shudders, beams groaning in protest. Dust and plaster rain from the ceiling.

All of it—
The noise, the light, the vertigo—
Lasts less than a heartbeat.

But in that moment, it feels as though time refused to move forward.

It lingers.

Burns into your vision.

Stays behind your eyes.

After a moment you blink the brightness away. The world returns to you. 

Tesska moved from behind you at some point and now stands near a large window at the front of the room. She looks out onto the street.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Gods... Is that—&lt;&lt;/speech&gt;&gt;

You quickly walk up next to her, matching your gaze with her&#39;s.

Far down the street, you see a flickering orange glow. At first, it seems like lantern light. Then it brightens—flares—and the realization hits like a punch to the gut.


&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[Fire—|FireConvergence]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="153" name="TavernFightScene" tags="" position="350,1975" size="100,100">The table explodes as Sarjan shoves it aside, dice, coins, and drinks scatter like startled birds. He lunges—red-faced, snarling, swinging for your head.

He doesn’t get close.

A flash of motion—something huge moving between you—and suddenly you’re &lt;em&gt;falling&lt;/em&gt; backward. A firm hand pushes you clear, and you&#39;re caught in a pair of arms that smell faintly of citrus and sweat.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Oof—gotcha, sweetheart.&lt;&lt;/speech&gt;&gt;

Tesska holds your weight from behind like it is nothing to her. You turn your head and see her face—intimately close—she bites her lip looking towards her husband.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Watch this, girl. It&#39;s always my favorite when the big guy gets worked up.&lt;&lt;/speech&gt;&gt;

Tesska&#39;s words ooze with a sexual tension that leads you to not doubt that what she said was true. You turn back towards Harroc.

Sarjan, after being pushed away from you took a moment to recalibrate. He looks at Harroc, the new object of his rage. He swings wildly. Harroc catches the hook with absolutely zero effort. You see Harroc&#39;s grip tighten and a quick series of pops eminate from Sarjan&#39;s now likely broken hand.

With another twist of his arm, and a shove, Sarjan is launched towards the main entrance of the tavern. Harroc with his free hands grabs the other two dice-rats. The skinny one by his ear, the same one Sarjan had slapped not so long ago; the fat one by his collar. Harroc moves with purpose, it&#39;s like watching a wild bear claiming its territory.

The two henchies in tow, Harroc approaches Sarjan once more before giving a powerful kick to his chest sending the drunkard soaring through the door. The sound of the heavy rain suddenly fills the tavern, and as if Harroc himself summoned it, a crack of thunder booms from somewhere in the distance. The men vanish into the downpour for only a moment. 

Harroc enters again, only slightly wet, as if the rain itself wasn&#39;t going to fuck with him tonight. His facial expression blank, untelling.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;&lt;em&gt;Isn&#39;t he incredible?&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

You don&#39;t have time to answer before Harroc walks up to you and in his slow methodical boom of a voice says

&lt;&lt;speech &quot;harroc&quot;&gt;&gt;&#39;Get that you’ve got something to prove. Just don’t do it in Tesska&#39;s bar.&lt;&lt;/speech&gt;&gt;

His tone does not leave room for a proper response. You swallow hard, realizing you&#39;d been holding your breath.

You nod at him. 

Tesska stands you back up properly. Harroc moves back to his spot behind the bar, as if nothing had happened.



[[Suddenly your surrounding melt in a bright flash—|TavernLightningScene]]</tw-passagedata><tw-passagedata pid="154" name="TestRealm_ConvoMinigame" tags="" position="475,1975" size="100,100">&lt;div id=&quot;convoBox&quot;&gt;&lt;/div&gt;
&lt;div id=&quot;convoChoices&quot;&gt;&lt;/div&gt;

&lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="155" name="sidebar" tags="nobr" position="1400,100" size="100,100">
		&lt;div id=&quot;sidebar-topbar&quot;&gt;
			&lt;div id=&quot;sidebar-nav&quot;&gt;
				&lt;button id=&quot;sidebar-nav-back&quot; class=&quot;sidebar-nav-btn&quot; onclick=&quot;setup.SidebarUI.navBack()&quot;&gt;
					&lt;i data-lucide=&quot;undo-2&quot;&gt;&lt;/i&gt;
				&lt;/button&gt;
				&lt;button id=&quot;sidebar-nav-forward&quot; class=&quot;sidebar-nav-btn&quot; onclick=&quot;setup.SidebarUI.navForward()&quot;&gt;
					&lt;i data-lucide=&quot;redo-2&quot;&gt;&lt;/i&gt;
				&lt;/button&gt;
			&lt;/div&gt;
			&lt;button id=&quot;sidebar-toggle&quot; type=&quot;button&quot; class=&quot;sidebar-btn&quot;&gt;
				&lt;i id=&quot;sidebar-arrow&quot; data-lucide=&quot;arrow-left&quot;&gt;&lt;/i&gt;
			&lt;/button&gt;
		&lt;/div&gt;


			&lt;!-- Collapsed Summary --&gt;
			&lt;div id=&quot;sidebar-summary&quot; style=&quot;display: none; flex-direction: column; align-items: center; gap: 8px;&quot;&gt;
				&lt;span id=&quot;summary-time&quot;&gt;--:--&lt;/span&gt;
				&lt;span id=&quot;summary-date&quot;&gt;Loading Date...&lt;/span&gt;
				&lt;div id=&quot;summary-location-weather&quot; style=&quot;display: flex; flex-direction: column; align-items: center;&quot;&gt;
					&lt;i id=&quot;sidebar-weather-icon&quot; data-lucide=&quot;sun&quot; title=&quot;Clear Skies&quot;&gt;&lt;/i&gt;
					&lt;span id=&quot;summary-location&quot;&gt;Unknown&lt;/span&gt;
				&lt;/div&gt;
				&lt;span id=&quot;summary-gold&quot;&gt;0&lt;/span&gt;
				&lt;div id=&quot;summary-status-icons&quot;&gt;
					&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-health-wrap&quot;&gt;
						&lt;div class=&quot;summary-fill&quot; id=&quot;summary-health-fill&quot;&gt;&lt;/div&gt;
						&lt;i id=&quot;summary-health&quot; data-lucide=&quot;heart&quot;&gt;&lt;/i&gt;
					&lt;/div&gt;
					&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-fatigue-wrap&quot;&gt;
						&lt;div class=&quot;summary-fill&quot; id=&quot;summary-fatigue-fill&quot;&gt;&lt;/div&gt;
						&lt;i id=&quot;summary-fatigue&quot; data-lucide=&quot;zap&quot;&gt;&lt;/i&gt;
					&lt;/div&gt;
					&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-composure-wrap&quot;&gt;
						&lt;div class=&quot;summary-fill&quot; id=&quot;summary-composure-fill&quot;&gt;&lt;/div&gt;
						&lt;i id=&quot;summary-composure&quot; data-lucide=&quot;brain&quot;&gt;&lt;/i&gt;
					&lt;/div&gt;
					&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-excitement-wrap&quot;&gt;
						&lt;div class=&quot;summary-fill&quot; id=&quot;summary-excitement-fill&quot;&gt;&lt;/div&gt;
						&lt;i id=&quot;summary-excitement&quot; data-lucide=&quot;flame&quot;&gt;&lt;/i&gt;
					&lt;/div&gt;
				&lt;/div&gt;
				&lt;div id=&quot;summary-level-exp&quot; style=&quot;display: flex; flex-direction: column; align-items: center;&quot;&gt;
					&lt;span id=&quot;summary-level&quot;&gt;Lvl 1&lt;/span&gt;
					&lt;div class=&quot;exp-bar-mini&quot;&gt;
						&lt;div class=&quot;exp-bar-fill-mini&quot; id=&quot;exp-fill-mini&quot;&gt;&lt;/div&gt;
					&lt;/div&gt;
				&lt;/div&gt;
				&lt;div id=&quot;summary-conditions&quot;&gt;&lt;/div&gt;
			&lt;/div&gt;

			&lt;!-- Main Scrollable Content --&gt;
			&lt;div id=&quot;sidebar-content&quot;&gt;
				&lt;div id=&quot;sidebar-top-info&quot;&gt;
					&lt;div id=&quot;sidebar-datetime&quot;&gt;
						&lt;span id=&quot;sidebar-time&quot;&gt;--:--&lt;/span&gt;
						&lt;span id=&quot;sidebar-date&quot;&gt;Loading Date...&lt;/span&gt;
					&lt;/div&gt;
					&lt;div id=&quot;sidebar-location-weather&quot;&gt;
						&lt;span id=&quot;sidebar-location&quot;&gt;Unknown Location&lt;/span&gt;
						&lt;i id=&quot;sidebar-weather-icon&quot; data-lucide=&quot;sun&quot; title=&quot;Clear Skies&quot;&gt;&lt;/i&gt;
					&lt;/div&gt;
					&lt;div id=&quot;sidebar-gold&quot;&gt;
						&lt;i data-lucide=&quot;coins&quot;&gt;&lt;/i&gt; &lt;span id=&quot;sidebar-gold-amount&quot;&gt;0&lt;/span&gt;
					&lt;/div&gt;
				&lt;/div&gt;

				&lt;div id=&quot;sidebar-status-tracker&quot;&gt;
					&lt;div class=&quot;status-bar&quot; id=&quot;health-bar&quot;&gt;
						&lt;i data-lucide=&quot;heart&quot;&gt;&lt;/i&gt;
						&lt;span&gt;Health&lt;/span&gt;
						&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
							&lt;div class=&quot;status-bar-fill&quot; id=&quot;health-fill&quot;&gt;&lt;/div&gt;
						&lt;/div&gt;
						&lt;span class=&quot;bar-value&quot; id=&quot;health-value&quot;&gt;&lt;/span&gt;
					&lt;/div&gt;
					&lt;div class=&quot;status-bar&quot; id=&quot;fatigue-bar&quot;&gt;
						&lt;i data-lucide=&quot;zap&quot;&gt;&lt;/i&gt;
						&lt;span&gt;Fatigue&lt;/span&gt;
						&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
							&lt;div class=&quot;status-bar-fill&quot; id=&quot;fatigue-fill&quot;&gt;&lt;/div&gt;
						&lt;/div&gt;
						&lt;span class=&quot;bar-value&quot; id=&quot;fatigue-value&quot;&gt;&lt;/span&gt;
					&lt;/div&gt;
					&lt;div class=&quot;status-bar&quot; id=&quot;composure-bar&quot;&gt;
						&lt;i data-lucide=&quot;brain&quot;&gt;&lt;/i&gt;
						&lt;span&gt;Composure&lt;/span&gt;
						&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
							&lt;div class=&quot;status-bar-fill&quot; id=&quot;composure-fill&quot;&gt;&lt;/div&gt;
						&lt;/div&gt;
						&lt;span class=&quot;bar-value&quot; id=&quot;composure-value&quot;&gt;&lt;/span&gt;
					&lt;/div&gt;
					&lt;div class=&quot;status-bar&quot; id=&quot;excitement-bar&quot;&gt;
						&lt;i data-lucide=&quot;flame&quot;&gt;&lt;/i&gt;
						&lt;span&gt;Excitement&lt;/span&gt;
						&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
							&lt;div class=&quot;status-bar-fill&quot; id=&quot;excitement-fill&quot;&gt;&lt;/div&gt;
						&lt;/div&gt;
						&lt;span class=&quot;bar-value&quot; id=&quot;excitement-value&quot;&gt;&lt;/span&gt;
					&lt;/div&gt;
					&lt;div id=&quot;conditional-status-bars&quot;&gt;&lt;/div&gt;
				&lt;/div&gt;

				&lt;div id=&quot;sidebar-carryweight&quot; style=&quot;display:none;&quot;&gt;
					&lt;i data-lucide=&quot;package&quot;&gt;&lt;/i&gt; &lt;span id=&quot;carryweight-text&quot;&gt;Carryweight: 0/100&lt;/span&gt;
					&lt;div class=&quot;status-bar-carry&quot;&gt;
						&lt;div class=&quot;carry-bar-fill&quot; id=&quot;carry-fill&quot;&gt;&lt;/div&gt;
					&lt;/div&gt;
				&lt;/div&gt;

				&lt;div id=&quot;sidebar-level-exp&quot;&gt;
					&lt;span id=&quot;sidebar-level&quot;&gt;Lvl 1&lt;/span&gt;
					&lt;div class=&quot;exp-bar&quot;&gt;
						&lt;div class=&quot;exp-bar-fill&quot; id=&quot;exp-fill&quot;&gt;&lt;/div&gt;
					&lt;/div&gt;
					&lt;span id=&quot;exp-text&quot;&gt;0/100 XP&lt;/span&gt;
				&lt;/div&gt;

				&lt;div id=&quot;custom-sidebar-buttons&quot;&gt;
					&lt;div class=&quot;button-single&quot;&gt;
						&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;character-sheet&#39;)&quot;&gt;
							&lt;i data-lucide=&quot;scroll-text&quot;&gt;&lt;/i&gt; Character
						&lt;/button&gt;
					&lt;/div&gt;
					&lt;div class=&quot;button-single&quot;&gt;
						&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;inventory-page&#39;)&quot;&gt;
							&lt;i data-lucide=&quot;backpack&quot;&gt;&lt;/i&gt; Inventory
						&lt;/button&gt;
					&lt;/div&gt;
					&lt;div class=&quot;button-pair&quot;&gt;
						&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;journal-page&#39;)&quot;&gt;
							&lt;i data-lucide=&quot;book-open&quot;&gt;&lt;/i&gt; Journal
						&lt;/button&gt;
						&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;people-page&#39;)&quot;&gt;
							&lt;i data-lucide=&quot;users&quot;&gt;&lt;/i&gt; People
						&lt;/button&gt;
					&lt;/div&gt;
					&lt;div class=&quot;button-pair&quot;&gt;
						&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;stats-page&#39;)&quot;&gt;
							&lt;i data-lucide=&quot;brain&quot;&gt;&lt;/i&gt; Stats
						&lt;/button&gt;
						&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;achievements-page&#39;)&quot;&gt;
							&lt;i data-lucide=&quot;star&quot;&gt;&lt;/i&gt; Achievements
						&lt;/button&gt;
					&lt;/div&gt;
					&lt;div class=&quot;button-pair&quot;&gt;
						&lt;button id=&quot;btn-saves&quot; class=&quot;sidebar-btn&quot;&gt;
							&lt;i data-lucide=&quot;save&quot;&gt;&lt;/i&gt; Saves
						&lt;/button&gt;
                        &lt;&lt;button &#39;&lt;i data-lucide=&quot;save&quot;&gt;&lt;/i&gt; Saves&#39;&gt;&gt;
                        	&lt;&lt;run UI.saves()&gt;&gt;
                        &lt;&lt;/button&gt;&gt;
						&lt;button class=&quot;sidebar-btn&quot;&gt;
							&lt;i data-lucide=&quot;settings&quot;&gt;&lt;/i&gt; Options
						&lt;/button&gt;
					&lt;/div&gt;
				&lt;/div&gt;
			&lt;/div&gt;
            
&lt;&lt;done&gt;&gt;
&lt;&lt;script&gt;&gt;

		/* Set bar fill width and value label */
		const s = State.variables.player.status;
		function updateBar(id, current, max) {
			const fill = document.getElementById(`${id}-fill`);
			const value = document.getElementById(`${id}-value`);
			if (fill) fill.style.width = `${(current / max) * 100}%`;
			if (value) value.textContent = `${Math.round(current)} / ${Math.round(max)}`;
		}

		updateBar(&quot;health&quot;, s.health, s.maxHealth);
		updateBar(&quot;fatigue&quot;, s.fatigue, s.maxFatigue);
		updateBar(&quot;composure&quot;, s.composure, s.maxComposure);
		updateBar(&quot;excitement&quot;, s.excitement, s.maxExcitement);

	    setup.SidebarUI.initialize();

		if (window.lucide) {
			lucide.createIcons();
		} else {
			console.warn(&quot;Lucide not available at sidebar load time.&quot;);
		}
&lt;&lt;/script&gt;&gt;
&lt;&lt;/done&gt;&gt;</tw-passagedata></tw-storydata>
	<script id="script-sugarcube" type="text/javascript">
	/*! SugarCube JS */
	if(document.documentElement.getAttribute("data-init")==="loading"){(function(window,document,jQuery,undefined){"use strict";var _excluded=["bubbles","cancelable","composed","detail"],_excluded2=["bubbles","cancelable"],_excluded3=["state"];function _toConsumableArray(r){return _arrayWithoutHoles(r)||_iterableToArray(r)||_unsupportedIterableToArray(r)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(r){if("undefined"!=typeof Symbol&&null!=r[Symbol.iterator]||null!=r["@@iterator"])return Array.from(r)}function _arrayWithoutHoles(r){if(Array.isArray(r))return _arrayLikeToArray(r)}function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==_typeof(i)?i:i+""}function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function _objectWithoutProperties(e,t){if(null==e)return{};var o,r,i=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)o=s[r],t.includes(o)||{}.propertyIsEnumerable.call(e,o)&&(i[o]=e[o])}return i}function _objectWithoutPropertiesLoose(r,e){if(null==r)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.includes(n))continue;t[n]=r[n]}return t}function _slicedToArray(r,e){return _arrayWithHoles(r)||_iterableToArrayLimit(r,e)||_unsupportedIterableToArray(r,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}function _arrayWithHoles(r){if(Array.isArray(r))return r}function _typeof(o){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}var errorPrologRegExp=/^(?:(?:uncaught\s+(?:exception:\s+)?)?\w*(?:error|exception|_err):\s+)+/i,Alert=function(){function mesg(where,error,isFatal,isUncaught){var mesg="Error",nice="A".concat(isFatal?" fatal":"n"," error has occurred.");nice+=isFatal?" Aborting.":" You may be able to continue, but some parts may not work properly.";var isObject=null!==error&&"object"===_typeof(error),what=(isObject&&"message"in error?String(error.message).replace(errorPrologRegExp,""):String(error)).trim()||"unknown error";null!=where&&(mesg+=" [".concat(where,"]")),mesg+=": ".concat(what,"."),isObject&&"stack"in error&&(mesg+="\n\nStack Trace:\n".concat(error.stack)),mesg&&(nice+="\n\n".concat(mesg)),isUncaught||console[isFatal?"error":"warn"](mesg),window.alert(nice)}var origOnError;return origOnError=window.onerror,window.onerror=function(what,source,lineNum,colNum,error){"complete"===document.readyState?mesg(null,null!=error?error:what,!1,!0):(mesg(null,null!=error?error:what,!0,!0),window.onerror=origOnError,"function"==typeof window.onerror&&window.onerror.apply(this,arguments))},Object.preventExtensions(Object.create(null,{error:{value:function(where,error){mesg(where,error)}},fatal:{value:function(where,error){mesg(where,error,!0)}}}))}(),Patterns=(wsMap=new Map([[" ","\\u0020"],["\f","\\f"],["\n","\\n"],["\r","\\r"],["\t","\\t"],["\v","\\v"],[" ","\\u00a0"],[" ","\\u1680"],["᠎","\\u180e"],[" ","\\u2000"],[" ","\\u2001"],[" ","\\u2002"],[" ","\\u2003"],[" ","\\u2004"],[" ","\\u2005"],[" ","\\u2006"],[" ","\\u2007"],[" ","\\u2008"],[" ","\\u2009"],[" ","\\u200a"],["\u2028","\\u2028"],["\u2029","\\u2029"],[" ","\\u202f"],[" ","\\u205f"],["　","\\u3000"],["\ufeff","\\ufeff"]]),wsRe=/^\s$/,missing="",wsMap.forEach((function(pat,char){wsRe.test(char)||(missing+=pat)})),space=missing?"[\\s".concat(missing,"]"):"\\s",spaceNoTerminator="[\\u0020\\f\\t\\v\\u00a0\\u1680\\u180e\\u2000-\\u200a\\u202f\\u205f\\u3000\\ufeff]",notSpace="\\s"===space?"\\S":space.replace(/^\[/,"[^"),anyChar="(?:.|".concat("[\\n\\r\\u2028\\u2029]",")"),anyLetter="[0-9A-Z_a-z\\-\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u00ff\\u0150\\u0170\\u0151\\u0171]",anyLetterStrict=anyLetter.replace("\\-",""),identifier="".concat("[$A-Z_a-z]").concat("[$0-9A-Z_a-z]","*"),variable="[$_]"+identifier,htmlTagName="[A-Za-z](?:".concat(cENChar="(?:[\\x2D.0-9A-Z_a-z\\xB7\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u037D\\u037F-\\u1FFF\\u200C\\u200D\\u203F\\u2040\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD]|[\\uD800-\\uDB7F][\\uDC00-\\uDFFF])","*-").concat(cENChar,"*|[0-9A-Za-z]*)"),twStyle="(".concat(anyLetter,"+)\\(([^\\)\\|\\n]+)\\):"),cssStyle="".concat(spaceNoTerminator,"*(").concat(anyLetter,"+)").concat(spaceNoTerminator,"*:([^;\\|\\n]+);"),idOrClass="".concat(spaceNoTerminator,"*((?:").concat("[#.]").concat(anyLetter,"+").concat(spaceNoTerminator,"*)+);"),inlineCss="".concat(twStyle,"|").concat(cssStyle,"|").concat(idOrClass),url="(?:file|https?|mailto|ftp|javascript|irc|news|data):[^\\s'\"]+",externalUrl=url.replace(/\|javascript|\|data/g,""),Object.freeze(Object.assign(Object.create(null),{space:space,spaceNoTerminator:spaceNoTerminator,lineTerminator:"[\\n\\r\\u2028\\u2029]",notSpace:notSpace,anyChar:anyChar,anyLetter:anyLetter,anyLetterStrict:anyLetterStrict,identifierFirstChar:"[$A-Z_a-z]",identifierNextChar:"[$0-9A-Z_a-z]",identifier:identifier,variableSigil:"[$_]",variable:variable,macroName:"[A-Za-z][\\w-]*|[=-]",templateName:"[A-Za-z][\\w-]*",htmlTagName:htmlTagName,cssIdOrClassSigil:"[#.]",cssImage:"\\[[<>]?[Ii][Mm][Gg]\\[(?:\\s|\\S)*?\\]\\]+",inlineCss:inlineCss,url:url,externalUrl:externalUrl}))),wsMap,wsRe,missing,cENChar,twStyle,cssStyle,idOrClass,space,spaceNoTerminator,notSpace,anyChar,anyLetter,anyLetterStrict,identifier,variable,htmlTagName,inlineCss,url,externalUrl;!function(){var startWSRe,endWSRe,_trimString=(startWSRe=new RegExp("^".concat(Patterns.space).concat(Patterns.space,"*")),endWSRe=new RegExp("".concat(Patterns.space).concat(Patterns.space,"*$")),function(str,where){var val=String(str);if(!val)return val;switch(where){case"start":return startWSRe.test(val)?val.replace(startWSRe,""):val;case"end":return endWSRe.test(val)?val.replace(endWSRe,""):val;default:throw new Error('_trimString called with incorrect where parameter value: "'.concat(where,'"'))}});function _createPadString(length,padding){var targetLength=Number.parseInt(length,10)||0;if(targetLength<1)return"";var padString=void 0===padding?"":String(padding);for(""===padString&&(padString=" ");padString.length<targetLength;){var curPadLength=padString.length,remainingLength=targetLength-curPadLength;padString+=curPadLength>remainingLength?padString.slice(0,remainingLength):padString}return padString.length>targetLength&&(padString=padString.slice(0,targetLength)),padString}if(Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,writable:!0,value:function flat(){if(null==this)throw new TypeError("Array.prototype.flat called on null or undefined");var depth=0===arguments.length?1:Number(arguments[0])||0;if(depth<1)return Array.prototype.slice.call(this);var push=Array.prototype.push;return Array.prototype.reduce.call(this,(function(acc,cur){return cur instanceof Array?push.apply(acc,flat.call(cur,depth-1)):acc.push(cur),acc}),[])}}),Array.prototype.flatMap||Object.defineProperty(Array.prototype,"flatMap",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.flatMap called on null or undefined");return Array.prototype.map.apply(this,arguments).flat()}}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includes called on null or undefined");if(0===arguments.length)return!1;var length=this.length>>>0;if(0===length)return!1;var needle=arguments[0],i=Number(arguments[1])||0;for(i<0&&(i=Math.max(0,length+i));i<length;++i){var value=this[i];if(value===needle||value!=value&&needle!=needle)return!0}return!1}}),Object.entries||Object.defineProperty(Object,"entries",{configurable:!0,writable:!0,value:function(obj){if("object"!==_typeof(obj)||null===obj)throw new TypeError("Object.entries object parameter must be an object");return Object.keys(obj).map((function(key){return[key,obj[key]]}))}}),Object.fromEntries||Object.defineProperty(Object,"fromEntries",{configurable:!0,writable:!0,value:function(iter){return Array.from(iter).reduce((function(acc,pair){if(Object(pair)!==pair)throw new TypeError("Object.fromEntries iterable parameter must yield objects");return pair[0]in acc?Object.defineProperty(acc,pair[0],{configurable:!0,enumerable:!0,writable:!0,value:pair[1]}):acc[pair[0]]=pair[1],acc}),{})}}),Object.getOwnPropertyDescriptors||Object.defineProperty(Object,"getOwnPropertyDescriptors",{configurable:!0,writable:!0,value:function(obj){if(null==obj)throw new TypeError("Object.getOwnPropertyDescriptors object parameter is null or undefined");var O=Object(obj);return Reflect.ownKeys(O).reduce((function(acc,key){var desc=Object.getOwnPropertyDescriptor(O,key);return void 0!==desc&&(key in acc?Object.defineProperty(acc,key,{configurable:!0,enumerable:!0,writable:!0,value:desc}):acc[key]=desc),acc}),{})}}),!Object.hasOwn){var _hasOwnProperty=Object.prototype.hasOwnProperty;Object.defineProperty(Object,"hasOwn",{configurable:!0,writable:!0,value:function(O,P){return _hasOwnProperty.call(Object(O),P)}})}Object.values||Object.defineProperty(Object,"values",{configurable:!0,writable:!0,value:function(obj){if("object"!==_typeof(obj)||null===obj)throw new TypeError("Object.values object parameter must be an object");return Object.keys(obj).map((function(key){return obj[key]}))}}),String.prototype.padStart||Object.defineProperty(String.prototype,"padStart",{configurable:!0,writable:!0,value:function(length,padding){if(null==this)throw new TypeError("String.prototype.padStart called on null or undefined");var baseString=String(this),baseLength=baseString.length,targetLength=Number.parseInt(length,10);return targetLength<=baseLength?baseString:_createPadString(targetLength-baseLength,padding)+baseString}}),String.prototype.padEnd||Object.defineProperty(String.prototype,"padEnd",{configurable:!0,writable:!0,value:function(length,padding){if(null==this)throw new TypeError("String.prototype.padEnd called on null or undefined");var baseString=String(this),baseLength=baseString.length,targetLength=Number.parseInt(length,10);return targetLength<=baseLength?baseString:baseString+_createPadString(targetLength-baseLength,padding)}}),String.prototype.trimStart||Object.defineProperty(String.prototype,"trimStart",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimStart called on null or undefined");return _trimString(this,"start")}}),String.prototype.trimLeft||Object.defineProperty(String.prototype,"trimLeft",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimLeft called on null or undefined");return _trimString(this,"start")}}),String.prototype.trimEnd||Object.defineProperty(String.prototype,"trimEnd",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimEnd called on null or undefined");return _trimString(this,"end")}}),String.prototype.trimRight||Object.defineProperty(String.prototype,"trimRight",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimRight called on null or undefined");return _trimString(this,"end")}})}(),function(){var _regExpMetaCharsRe,_hasRegExpMetaCharsRe,_formatRegExp,_hasFormatRegExp,_nativeMathRandom=Math.random;function _random(){var min,max;switch(arguments.length){case 0:throw new Error("_random called with insufficient parameters");case 1:min=0,max=arguments[0];break;default:min=arguments[0],max=arguments[1]}if(min>max){var _ref=[max,min];min=_ref[0],max=_ref[1]}return Math.floor(_nativeMathRandom()*(max-min+1))+min}function _randomIndex(length,boundsArgs){var min,max;switch(boundsArgs.length){case 1:min=0,max=length-1;break;case 2:min=0,max=Math.trunc(boundsArgs[1]);break;default:min=Math.trunc(boundsArgs[1]),max=Math.trunc(boundsArgs[2])}return Number.isNaN(min)?min=0:!Number.isFinite(min)||min>=length?min=length-1:min<0&&(min=length+min)<0&&(min=0),Number.isNaN(max)?max=0:(!Number.isFinite(max)||max>=length||max<0&&(max=length+max)<0)&&(max=length-1),_random(min,max)}function _getCodePointStartAndEnd(str,pos){var code=str.charCodeAt(pos);if(Number.isNaN(code))return{char:"",start:-1,end:-1};if(code<55296||code>57343)return{char:str.charAt(pos),start:pos,end:pos};if(code>=55296&&code<=56319){var nextPos=pos+1;if(nextPos>=str.length)throw new Error("high surrogate without trailing low surrogate");var nextCode=str.charCodeAt(nextPos);if(nextCode<56320||nextCode>57343)throw new Error("high surrogate without trailing low surrogate");return{char:str.charAt(pos)+str.charAt(nextPos),start:pos,end:nextPos}}if(0===pos)throw new Error("low surrogate without leading high surrogate");var prevPos=pos-1,prevCode=str.charCodeAt(prevPos);if(prevCode<55296||prevCode>56319)throw new Error("low surrogate without leading high surrogate");return{char:str.charAt(prevPos)+str.charAt(pos),start:prevPos,end:pos}}Object.defineProperty(Array.prototype,"concatUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.concatUnique called on null or undefined");var result=Array.from(this);if(0===arguments.length)return result;var items=Array.prototype.reduce.call(arguments,(function(prev,cur){return prev.concat(cur)}),[]),addSize=items.length;if(0===addSize)return result;for(var indexOf=Array.prototype.indexOf,push=Array.prototype.push,i=0;i<addSize;++i){var value=items[i];-1===indexOf.call(result,value)&&push.call(result,value)}return result}}),Object.defineProperty(Array.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.count called on null or undefined");for(var indexOf=Array.prototype.indexOf,needle=arguments[0],pos=Number(arguments[1])||0,count=0;-1!==(pos=indexOf.call(this,needle,pos));)++count,++pos;return count}}),Object.defineProperty(Array.prototype,"countWith",{configurable:!0,writable:!0,value:function(predicate,thisArg){if(null==this)throw new TypeError("Array.prototype.countWith called on null or undefined");if("function"!=typeof predicate)throw new Error("Array.prototype.countWith predicate parameter must be a function");var length=this.length>>>0;if(0===length)return 0;for(var count=0,i=0;i<length;++i)predicate.call(thisArg,this[i],i,this)&&++count;return count}}),Object.defineProperty(Array.prototype,"deleteAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.deleteAll called on null or undefined");if(0===arguments.length)return[];var length=this.length>>>0;if(0===length)return[];for(var needles=Array.prototype.concat.apply([],arguments),needlesLength=needles.length,indices=[],i=0;i<length;++i)for(var value=this[i],j=0;j<needlesLength;++j){var needle=needles[j];if(value===needle||value!=value&&needle!=needle){indices.push(i);break}}for(var result=[],_i=0,iend=indices.length;_i<iend;++_i)result[_i]=this[indices[_i]];for(var splice=Array.prototype.splice,_i2=indices.length-1;_i2>=0;--_i2)splice.call(this,indices[_i2],1);return result}}),Object.defineProperty(Array.prototype,"deleteAt",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.deleteAt called on null or undefined");if(0===arguments.length)return[];var length=this.length>>>0;if(0===length)return[];for(var splice=Array.prototype.splice,cpyIndices=Array.from(new Set(Array.from(arguments).map((function(x){return x<0?Math.max(0,length+x):x}))).values()),delIndices=Array.from(cpyIndices).sort((function(a,b){return b-a})),result=[],i=0,iend=cpyIndices.length;i<iend;++i)result[i]=this[cpyIndices[i]];for(var _i3=0,_iend=delIndices.length;_i3<_iend;++_i3)splice.call(this,delIndices[_i3],1);return result}}),Object.defineProperty(Array.prototype,"deleteFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.deleteFirst called on null or undefined");if(0!==arguments.length){var length=this.length>>>0;if(0!==length){for(var splice=Array.prototype.splice,needles=Array.prototype.concat.apply([],arguments),result=[],i=0;i<length&&needles.length>0;++i)for(var value=this[i],j=0;j<needles.length;++j){var needle=needles[j];if(value===needle||value!=value&&needle!=needle){result.push(value),splice.call(this,i--,1),needles.splice(j--,1);break}}return result}}}}),Object.defineProperty(Array.prototype,"deleteLast",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.deleteLast called on null or undefined");if(0!==arguments.length){var length=this.length>>>0;if(0!==length){for(var splice=Array.prototype.splice,needles=Array.prototype.concat.apply([],arguments),result=[],i=length-1;i>=0&&needles.length>0;--i)for(var value=this[i],j=0;j<needles.length;++j){var needle=needles[j];if(value===needle||value!=value&&needle!=needle){result.push(value),splice.call(this,i++,1),needles.splice(j--,1);break}}return result}}}}),Object.defineProperty(Array.prototype,"deleteWith",{configurable:!0,writable:!0,value:function(predicate,thisArg){if(null==this)throw new TypeError("Array.prototype.deleteWith called on null or undefined");if("function"!=typeof predicate)throw new Error("Array.prototype.deleteWith predicate parameter must be a function");var length=this.length>>>0;if(0===length)return[];for(var splice=Array.prototype.splice,indices=[],result=[],i=0;i<length;++i)predicate.call(thisArg,this[i],i,this)&&(result.push(this[i]),indices.push(i));for(var _i4=indices.length-1;_i4>=0;--_i4)splice.call(this,indices[_i4],1);return result}}),Object.defineProperty(Array.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.first called on null or undefined");if(0!==this.length>>>0)return this[0]}}),Object.defineProperty(Array.prototype,"includesAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAll called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAll.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var i=0,iend=arguments.length;i<iend;++i)if(!Array.prototype.some.call(this,(function(val){return val===this.val||val!=val&&this.val!=this.val}),{val:arguments[i]}))return!1;return!0}}),Object.defineProperty(Array.prototype,"includesAny",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAny called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAny.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var i=0,iend=arguments.length;i<iend;++i)if(Array.prototype.some.call(this,(function(val){return val===this.val||val!=val&&this.val!=this.val}),{val:arguments[i]}))return!0;return!1}}),Object.defineProperty(Array.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.last called on null or undefined");var length=this.length>>>0;if(0!==length)return this[length-1]}}),Object.defineProperty(Array.prototype,"pluck",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pluck called on null or undefined");var length=this.length>>>0;if(0!==length){var index=0===arguments.length?_random(0,length-1):_randomIndex(length,Array.from(arguments));return Array.prototype.splice.call(this,index,1)[0]}}}),Object.defineProperty(Array.prototype,"pluckMany",{configurable:!0,writable:!0,value:function(wantSize){if(null==this)throw new TypeError("Array.prototype.pluckMany called on null or undefined");var length=this.length>>>0;if(0===length)return[];var want=Math.trunc(wantSize);if(!Number.isInteger(want))throw new Error("Array.prototype.pluckMany want parameter must be an integer");if(want<1)return[];want>length&&(want=length);var splice=Array.prototype.splice,result=[],max=length-1;do{result.push(splice.call(this,_random(0,max--),1)[0])}while(result.length<want);return result}}),Object.defineProperty(Array.prototype,"pushUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pushUnique called on null or undefined");var addSize=arguments.length;if(0===addSize)return this.length>>>0;for(var indexOf=Array.prototype.indexOf,push=Array.prototype.push,i=0;i<addSize;++i){var value=arguments[i];-1===indexOf.call(this,value)&&push.call(this,value)}return this.length>>>0}}),Object.defineProperty(Array.prototype,"random",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.random called on null or undefined");var length=this.length>>>0;if(0!==length)return this[0===arguments.length?_random(0,length-1):_randomIndex(length,Array.from(arguments))]}}),Object.defineProperty(Array.prototype,"randomMany",{configurable:!0,writable:!0,value:function(wantSize){if(null==this)throw new TypeError("Array.prototype.randomMany called on null or undefined");var length=this.length>>>0;if(0===length)return[];var want=Math.trunc(wantSize);if(!Number.isInteger(want))throw new Error("Array.prototype.randomMany want parameter must be an integer");if(want<1)return[];want>length&&(want=length);var picked=new Map,result=[],max=length-1;do{var i=void 0;do{i=_random(0,max)}while(picked.has(i));picked.set(i,!0),result.push(this[i])}while(result.length<want);return result}}),Object.defineProperty(Array.prototype,"shuffle",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.shuffle called on null or undefined");var length=this.length>>>0;if(0===length)return this;for(var i=length-1;i>0;--i){var j=Math.floor(_nativeMathRandom()*(i+1));if(i!==j){var swap=this[i];this[i]=this[j],this[j]=swap}}return this}}),Object.defineProperty(Array.prototype,"toShuffled",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.toShuffled called on null or undefined");return Array.from(this).shuffle()}}),Object.defineProperty(Array.prototype,"toUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.toUnique called on null or undefined");return Array.from(new Set(this))}}),Object.defineProperty(Array.prototype,"unshiftUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.unshiftUnique called on null or undefined");var addSize=arguments.length;if(0===addSize)return this.length>>>0;for(var indexOf=Array.prototype.indexOf,unshift=Array.prototype.unshift,i=0;i<addSize;++i){var value=arguments[i];-1===indexOf.call(this,value)&&unshift.call(this,value)}return this.length>>>0}}),Object.defineProperty(Function.prototype,"partial",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Function.prototype.partial called on null or undefined");var slice=Array.prototype.slice,fn=this,bound=slice.call(arguments,0);return function(){for(var applied=[],argc=0,i=0;i<bound.length;++i)applied.push(bound[i]===undefined?arguments[argc++]:bound[i]);return fn.apply(this,applied.concat(slice.call(arguments,argc)))}}}),Object.defineProperty(Math,"clamp",{configurable:!0,writable:!0,value:function(num,min,max){if(3!==arguments.length)throw new Error("Math.clamp called with an incorrect number of parameters (want: 3, received: ".concat(arguments.length,")"));var value=Number(num),minVal=Number(min),maxVal=Number(max);if(minVal>maxVal){var _ref2=[maxVal,minVal];minVal=_ref2[0],maxVal=_ref2[1]}return Math.min(Math.max(value,minVal),maxVal)}}),RegExp.escape||(_regExpMetaCharsRe=/[\\^$*+?.()|[\]{}]/g,_hasRegExpMetaCharsRe=new RegExp(_regExpMetaCharsRe.source),Object.defineProperty(RegExp,"escape",{configurable:!0,writable:!0,value:function(str){var val=String(str);return val&&_hasRegExpMetaCharsRe.test(val)?val.replace(_regExpMetaCharsRe,"\\$&"):val}})),_formatRegExp=/{(\d+)(?:,([+-]?\d+))?}/g,_hasFormatRegExp=new RegExp(_formatRegExp.source),Object.defineProperty(String,"format",{configurable:!0,writable:!0,value:function(format){if(arguments.length<2)return 0===arguments.length?"":format;var args=2===arguments.length&&Array.isArray(arguments[1])?Array.from(arguments[1]):Array.prototype.slice.call(arguments,1);return 0===args.length?format:_hasFormatRegExp.test(format)?(_formatRegExp.lastIndex=0,format.replace(_formatRegExp,(function(match,index,align){var retval=args[index];if(null==retval)return"";for(;"function"==typeof retval;)retval=retval();switch(_typeof(retval)){case"string":break;case"object":retval=JSON.stringify(retval);break;default:retval=String(retval)}return function(str,align,pad){if(!align)return str;var plen=Math.abs(align)-str.length;if(plen<1)return str;var padding=String(pad).repeat(plen);return align<0?str+padding:padding+str}(retval,align?Number.parseInt(align,10):0," ")}))):format}}),Object.defineProperty(String.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.count called on null or undefined");var needle=String(arguments[0]||"");if(""===needle)return 0;for(var indexOf=String.prototype.indexOf,step=needle.length,pos=Number(arguments[1])||0,count=0;-1!==(pos=indexOf.call(this,needle,pos));)++count,pos+=step;return count}}),Object.defineProperty(String.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.first called on null or undefined");return _getCodePointStartAndEnd(String(this),0).char}}),Object.defineProperty(String.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.last called on null or undefined");var str=String(this);return _getCodePointStartAndEnd(str,str.length-1).char}}),Object.defineProperty(String.prototype,"splice",{configurable:!0,writable:!0,value:function(startAt,delCount,replacement){if(null==this)throw new TypeError("String.prototype.splice called on null or undefined");var length=this.length>>>0;if(0===length)return"";var start=Number(startAt);Number.isSafeInteger(start)?start<0&&(start+=length)<0&&(start=0):start=0,start>length&&(start=length);var count=Number(delCount);(!Number.isSafeInteger(count)||count<0)&&(count=0);var res=this.slice(0,start);return void 0!==replacement&&(res+=replacement),start+count<length&&(res+=this.slice(start+count)),res}}),Object.defineProperty(String.prototype,"splitOrEmpty",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.splitOrEmpty called on null or undefined");return""===String(this)?[]:String.prototype.split.apply(this,arguments)}}),Object.defineProperty(String.prototype,"toLocaleUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toLocaleUpperFirst called on null or undefined");var str=String(this),_getCodePointStartAnd3=_getCodePointStartAndEnd(str,0),char=_getCodePointStartAnd3.char,end=_getCodePointStartAnd3.end;return-1===end?"":char.toLocaleUpperCase()+str.slice(end+1)}}),Object.defineProperty(String.prototype,"toUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toUpperFirst called on null or undefined");var str=String(this),_getCodePointStartAnd4=_getCodePointStartAndEnd(str,0),char=_getCodePointStartAnd4.char,end=_getCodePointStartAnd4.end;return-1===end?"":char.toUpperCase()+str.slice(end+1)}}),Object.defineProperty(Array.prototype,"delete",{configurable:!0,writable:!0,value:function(){if(console.warn("[DEPRECATED] <Array>.delete() is deprecated."),null==this)throw new TypeError("Array.prototype.delete called on null or undefined");return Array.prototype.deleteAll.apply(this,arguments)}}),Object.defineProperty(JSON,"reviveWrapper",{configurable:!0,writable:!0,value:function(code,data){if(console.warn("[DEPRECATED] JSON.reviveWrapper() is deprecated."),"string"!=typeof code)throw new TypeError("JSON.reviveWrapper code parameter must be a string");return Serial.createReviver(code,data)}}),Object.defineProperty(Math,"easeInOut",{configurable:!0,writable:!0,value:function(num){return console.warn("[DEPRECATED] Math.easeInOut() is deprecated."),1-(Math.cos(Number(num)*Math.PI)+1)/2}}),Object.defineProperty(Number.prototype,"clamp",{configurable:!0,writable:!0,value:function(){if(console.warn("[DEPRECATED] <Number>.clamp() is deprecated."),null==this)throw new TypeError("Number.prototype.clamp called on null or undefined");if(2!==arguments.length)throw new Error("Number.prototype.clamp called with an incorrect number of parameters (want: 2, received: ".concat(arguments.length,")"));return Math.clamp(this,arguments[0],arguments[1])}})}(),function(){function onKeypressFn(ev){13!==ev.which&&32!==ev.which||(ev.preventDefault(),triggerEvent("click",getActiveElement()||this))}function onClickFnWrapper(fn){return function(){var $this=jQuery(this);$this.ariaIsDisabled()||($this.is("[aria-pressed]")&&$this.attr("aria-pressed","true"===$this.attr("aria-pressed")?"false":"true"),fn.apply(this,arguments))}}function disableTabindex(el){if(!el.hasAttribute("data-last-tabindex")){var tabindex=el.getAttribute("tabindex");el.setAttribute("data-last-tabindex",null!==tabindex?tabindex.trim():"")}el.setAttribute("tabindex",-1)}function restoreTabindex(el){var lastTabindex=el.getAttribute("data-last-tabindex");null!==lastTabindex&&(el.removeAttribute("data-last-tabindex"),""===lastTabindex?el.removeAttribute("tabindex"):el.setAttribute("tabindex",lastTabindex))}jQuery.fn.extend({ariaClick:function(options,handler){if(0===this.length||0===arguments.length)return this;var opts=options,fn=handler;return null==fn&&(fn=opts,opts=undefined),"string"!=typeof(opts=jQuery.extend({namespace:undefined,one:!1,selector:undefined,data:undefined,role:undefined,tabindex:0,controls:undefined,pressed:undefined,label:undefined},opts)).namespace?opts.namespace="":"."!==opts.namespace[0]&&(opts.namespace=".".concat(opts.namespace)),"boolean"==typeof opts.pressed&&(opts.pressed=opts.pressed?"true":"false"),this.filter("button").prop("type","button"),null!=opts.role?this.attr("role",opts.role):this.not("[role]").filter("a,[data-passage]").attr("role","link").end().not("a").not("[data-passage]").attr("role","button").end().end().end(),this.attr("tabindex",opts.tabindex),null!=opts.controls&&this.attr("aria-controls",opts.controls),null!=opts.pressed&&this.attr("aria-pressed",opts.pressed),null!=opts.label&&this.attr({"aria-label":opts.label,title:opts.label}),this.not("button").on("keypress.aria-clickable".concat(opts.namespace),opts.selector,onKeypressFn),this.on("click.aria-clickable".concat(opts.namespace),opts.selector,opts.data,opts.one?function(fn){return onClickFnWrapper((function(){jQuery(this).off(".aria-clickable").removeAttr("role tabindex aria-controls aria-pressed").filter("button").prop("disabled",!0),fn.apply(this,arguments)}))}(fn):onClickFnWrapper(fn)),this},ariaDisabled:function(disable){if(0===this.length||0===arguments.length)return this;var $nonDisableable=this.not("button,fieldset,input,menuitem,optgroup,option,select,textarea"),$disableable=this.filter("button,fieldset,input,menuitem,optgroup,option,select,textarea");return disable?($nonDisableable.each((function(){this.setAttribute("disabled","disabled"),this.setAttribute("aria-disabled","true"),disableTabindex(this)})),$disableable.each((function(){this.disabled=!0,this.setAttribute("aria-disabled","true"),disableTabindex(this)}))):($nonDisableable.each((function(){this.removeAttribute("disabled"),this.removeAttribute("aria-disabled"),restoreTabindex(this)})),$disableable.each((function(){this.disabled=!1,this.removeAttribute("aria-disabled"),restoreTabindex(this)}))),this},ariaIsDisabled:function(){return this.is("[disabled]")}})}(),jQuery.fn.extend({getForbiddenInteractiveContentTagNames:function(){if(0===this.length)return[];var forbidden=new Set;return this.find("a,button,fieldset,form,input,menuitem,optgroup,option,select,textarea").each((function(_,el){return forbidden.add(el.nodeName.toLowerCase())})),Array.from(forbidden)}}),jQuery.extend({wikiWithOptions:function(options){for(var _len=arguments.length,sources=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)sources[_key-1]=arguments[_key];if(0!==sources.length){var frag=document.createDocumentFragment();sources.forEach((function(content){return new Wikifier(frag,content,options)}));var errors=Array.from(frag.querySelectorAll(".error")).map((function(errEl){return errEl.textContent.replace(errorPrologRegExp,"")}));if(errors.length>0)throw new Error(errors.join("; "))}},wiki:function(){for(var _len2=arguments.length,sources=new Array(_len2),_key2=0;_key2<_len2;_key2++)sources[_key2]=arguments[_key2];this.wikiWithOptions.apply(this,[undefined].concat(sources))},wikiPassage:function(name){this.wikiWithOptions(undefined,Story.get(name).processText())}}),jQuery.fn.extend({wikiWithOptions:function(options){for(var _len3=arguments.length,sources=new Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++)sources[_key3-1]=arguments[_key3];if(0===this.length||0===sources.length)return this;var frag=document.createDocumentFragment();return sources.forEach((function(content){return new Wikifier(frag,content,options)})),this.append(frag),this},wiki:function(){for(var _len4=arguments.length,sources=new Array(_len4),_key4=0;_key4<_len4;_key4++)sources[_key4]=arguments[_key4];return this.wikiWithOptions.apply(this,[undefined].concat(sources))},wikiPassage:function(name){return this.wikiWithOptions(undefined,Story.get(name).processText())}});var Browser=(userAgent=navigator.userAgent.toLowerCase(),winPhone=userAgent.includes("windows phone"),isMobile=Object.freeze({Android:!winPhone&&userAgent.includes("android"),BlackBerry:/blackberry|bb10/.test(userAgent),iOS:!winPhone&&/ip(?:hone|ad|od)/.test(userAgent),Opera:!winPhone&&("object"===_typeof(window.operamini)||userAgent.includes("opera mini")),Windows:winPhone||/iemobile|wpdesktop/.test(userAgent),any:function(){return isMobile.Android||isMobile.BlackBerry||isMobile.iOS||isMobile.Opera||isMobile.Windows}}),isGecko=!isMobile.Windows&&!/khtml|trident|edge/.test(userAgent)&&userAgent.includes("gecko"),isIE=!userAgent.includes("opera")&&/msie|trident/.test(userAgent),ieVersion=isIE?(ver=/(?:msie\s+|rv:)(\d+\.\d)/.exec(userAgent))?Number(ver[1]):0:null,isOpera=userAgent.includes("opera")||userAgent.includes(" opr/"),operaVersion=isOpera?function(){var ver=new RegExp("".concat(/khtml|chrome/.test(userAgent)?"opr":"version","\\/(\\d+\\.\\d+)")).exec(userAgent);return ver?Number(ver[1]):0}():null,isVivaldi=userAgent.includes("vivaldi"),Object.freeze(Object.assign(Object.create(null),{userAgent:userAgent,isMobile:isMobile,isGecko:isGecko,isIE:isIE,ieVersion:ieVersion,isOpera:isOpera,operaVersion:operaVersion,isVivaldi:isVivaldi}))),ver,userAgent,winPhone,isMobile,isGecko,isIE,ieVersion,isOpera,operaVersion,isVivaldi,Has=(hasAudioElement=function(){try{return"function"==typeof document.createElement("audio").canPlayType}catch(ex){}return!1}(),hasFile=function(){try{return"Blob"in window&&"File"in window&&"FileList"in window&&"FileReader"in window&&(!Browser.isOpera||Browser.operaVersion>=15)}catch(ex){}return!1}(),hasGeolocation=function(){try{return"geolocation"in navigator&&"function"==typeof navigator.geolocation.getCurrentPosition&&"function"==typeof navigator.geolocation.watchPosition}catch(ex){}return!1}(),hasMutationObserver=function(){try{return"MutationObserver"in window&&"function"==typeof window.MutationObserver}catch(ex){}return!1}(),hasPerformance=function(){try{return"performance"in window&&"function"==typeof window.performance.now}catch(ex){}return!1}(),hasTouch=function(){try{return"ontouchstart"in window||!!window.DocumentTouch&&document instanceof window.DocumentTouch||!!navigator.maxTouchPoints||!!navigator.msMaxTouchPoints}catch(ex){}return!1}(),hasTransitionEndEvent=function(){try{for(var teMap=new Map([["transition","transitionend"],["MSTransition","msTransitionEnd"],["WebkitTransition","webkitTransitionEnd"],["MozTransition","transitionend"]]),teKeys=Array.from(teMap.keys()),el=document.createElement("div"),i=0;i<teKeys.length;++i)if(el.style[teKeys[i]]!==undefined)return teMap.get(teKeys[i])}catch(ex){}return!1}(),Object.freeze(Object.assign(Object.create(null),{audio:hasAudioElement,fileAPI:hasFile,geolocation:hasGeolocation,mutationObserver:hasMutationObserver,performance:hasPerformance,touch:hasTouch,transitionEndEvent:hasTransitionEndEvent}))),hasAudioElement,hasFile,hasGeolocation,hasMutationObserver,hasPerformance,hasTouch,hasTransitionEndEvent,Fullscreen=function(){var _hasPromise,vendor=function(){try{return Object.freeze([{isEnabled:"fullscreenEnabled",element:"fullscreenElement",requestFn:"requestFullscreen",exitFn:"exitFullscreen",changeEvent:"fullscreenchange",errorEvent:"fullscreenerror"},{isEnabled:"webkitFullscreenEnabled",element:"webkitFullscreenElement",requestFn:"webkitRequestFullscreen",exitFn:"webkitExitFullscreen",changeEvent:"webkitfullscreenchange",errorEvent:"webkitfullscreenerror"},{isEnabled:"mozFullScreenEnabled",element:"mozFullScreenElement",requestFn:"mozRequestFullScreen",exitFn:"mozCancelFullScreen",changeEvent:"mozfullscreenchange",errorEvent:"mozfullscreenerror"},{isEnabled:"msFullscreenEnabled",element:"msFullscreenElement",requestFn:"msRequestFullscreen",exitFn:"msExitFullscreen",changeEvent:"MSFullscreenChange",errorEvent:"MSFullscreenError"}].find((function(vnd){return vnd.isEnabled in document})))}catch(ex){}return undefined}(),_returnsPromise=(_hasPromise=null,function(){if(null!==_hasPromise)return _hasPromise;if(_hasPromise=!1,vendor)try{var value=document.exitFullscreen();value.catch((function(){})),_hasPromise=value instanceof Promise}catch(ex){}return _hasPromise});function _selectElement(requestedEl){var selectedEl=requestedEl||document.documentElement;return selectedEl===document.documentElement&&("msRequestFullscreen"===vendor.requestFn||Browser.isOpera&&Browser.operaVersion<15)&&(selectedEl=document.body),selectedEl}function isFullscreen(){return Boolean(vendor&&document[vendor.element])}function requestFullscreen(options,requestedEl){if(!vendor)return Promise.reject(new Error("fullscreen not supported"));var element=_selectElement(requestedEl);if("function"!=typeof element[vendor.requestFn])return Promise.reject(new Error("fullscreen not supported"));if(isFullscreen())return Promise.resolve();if(_returnsPromise())return element[vendor.requestFn](options);var namespace=".Fullscreen_requestFullscreen";return new Promise((function(resolve,reject){var $element=jQuery(element);$element.off(namespace).one("".concat(vendor.errorEvent).concat(namespace," ").concat(vendor.changeEvent).concat(namespace),(function(ev){$element.off(namespace),ev.type===vendor.errorEvent?reject(new Error("unknown fullscreen request error")):resolve()})),element[vendor.requestFn](options)}))}function exitFullscreen(){if(!vendor||"function"!=typeof document[vendor.exitFn])return Promise.reject(new TypeError("fullscreen not supported"));if(!isFullscreen())return Promise.reject(new TypeError("fullscreen mode not active"));if(_returnsPromise())return document[vendor.exitFn]();var namespace=".Fullscreen_exitFullscreen";return new Promise((function(resolve,reject){var $document=jQuery(document);$document.off(namespace).one("".concat(vendor.errorEvent).concat(namespace," ").concat(vendor.changeEvent).concat(namespace),(function(ev){$document.off(namespace),ev.type===vendor.errorEvent?reject(new Error("unknown fullscreen exit error")):resolve()})),document[vendor.exitFn]()}))}return Object.preventExtensions(Object.create(null,{vendor:{get:function(){return vendor}},element:{get:function(){return vendor?document[vendor.element]:null}},isEnabled:{value:function(){return Boolean(vendor&&document[vendor.isEnabled])}},isFullscreen:{value:isFullscreen},request:{value:requestFullscreen},exit:{value:exitFullscreen},toggle:{value:function(options,requestedEl){return isFullscreen()?exitFullscreen():requestFullscreen(options,requestedEl)}},onChange:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);jQuery(element).on(vendor.changeEvent,handlerFn)}}},offChange:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);handlerFn?jQuery(element).off(vendor.changeEvent,handlerFn):jQuery(element).off(vendor.changeEvent)}}},onError:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);jQuery(element).on(vendor.errorEvent,handlerFn)}}},offError:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);handlerFn?jQuery(element).off(vendor.errorEvent,handlerFn):jQuery(element).off(vendor.errorEvent)}}}}))}(),Outliner=function(){var lastEvent,styleEl=null;function outlinerHide(){document.documentElement.removeAttribute("data-outlines"),styleEl.styleSheet?styleEl.styleSheet.cssText="*:focus{outline:none;}":styleEl.textContent="*:focus{outline:none;}"}function outlinerShow(){document.documentElement.setAttribute("data-outlines",""),styleEl.styleSheet?styleEl.styleSheet.cssText="":styleEl.textContent=""}return Object.preventExtensions(Object.create(null,{init:{value:function(){styleEl||(styleEl=document.createElement("style"),jQuery(styleEl).attr({id:"style-outliner",type:"text/css"}).appendTo(document.head),jQuery(document).on("mousedown.style-outliner keydown.style-outliner",(function(ev){ev.type!==lastEvent&&(lastEvent=ev.type,"keydown"===ev.type?outlinerShow():outlinerHide())})),lastEvent="mousedown",outlinerHide())}},hide:{value:outlinerHide},show:{value:outlinerShow}}))}(),Serial=function(){var supportedTypes=Object.freeze([{id:"Date",get reference(){return Date.prototype},method:function(){return["(revive:date)",this.toISOString()]}},{id:"Function",get reference(){return Function.prototype},method:function(){return["(revive:)",["(".concat(this.toString(),")")]]}},{id:"Map",get reference(){return Map.prototype},method:function(){return["(revive:map)",Array.from(this)]}},{id:"RegExp",get reference(){return RegExp.prototype},method:function(){return["(revive:)",[this.toString()]]}},{id:"Set",get reference(){return Set.prototype},method:function(){return["(revive:set)",Array.from(this)]}}]);function createReviver(code,data){if("string"!=typeof code)throw new TypeError("Serial.createReviver code parameter must be a string");return["(revive:)",[code,data]]}function parse(text,reviver){return JSON.parse(text,(function(key,val){var value=val;if(value instanceof Array&&2===value.length)switch(value[0]){case"(revive:set)":value=new Set(value[1]);break;case"(revive:map)":value=new Map(value[1]);break;case"(revive:date)":value=new Date(value[1]);break;case"(revive:eval)":case"(revive:)":try{var $ReviveData$=value[1][1];value=eval(value[1][0])}catch(ex){}}if("function"==typeof reviver)try{value=reviver(key,value)}catch(ex){}return value}))}function stringify(value,replacer,space){var origMethodCache=new Map;supportedTypes.forEach((function(_ref3){var id=_ref3.id,reference=_ref3.reference,method=_ref3.method;Object.hasOwn(reference,"toJSON")&&origMethodCache.set(id,reference.toJSON),Object.defineProperty(reference,"toJSON",{configurable:!0,writable:!0,value:method})}));var notation=JSON.stringify(value,(function(key,val){var value=val;if("function"==typeof replacer)try{value=replacer(key,value)}catch(ex){}switch(value){case undefined:value=["(revive:)",["undefined"]];break;case 1/0:value=["(revive:)",["Infinity"]]}return value}),space);return supportedTypes.forEach((function(_ref4){var id=_ref4.id,reference=_ref4.reference;origMethodCache.has(id)?(Object.defineProperty(reference,"toJSON",{configurable:!0,writable:!0,value:origMethodCache.get(id)}),origMethodCache.delete(id)):delete reference.toJSON})),notation}return Object.preventExtensions(Object.create(null,{createReviver:{value:createReviver},parse:{value:parse},stringify:{value:stringify}}))}(),Visibility=(vendor=function(){try{return Object.freeze([{hiddenProperty:"hidden",stateProperty:"visibilityState",changeEvent:"visibilitychange"},{hiddenProperty:"webkitHidden",stateProperty:"webkitVisibilityState",changeEvent:"webkitvisibilitychange"},{hiddenProperty:"mozHidden",stateProperty:"mozVisibilityState",changeEvent:"mozvisibilitychange"},{hiddenProperty:"msHidden",stateProperty:"msVisibilityState",changeEvent:"msvisibilitychange"}].find((function(vnd){return vnd.hiddenProperty in document})))}catch(ex){}return undefined}(),Object.preventExtensions(Object.create(null,{vendor:{get:function(){return vendor}},state:{get:function(){return vendor&&document[vendor.stateProperty]||"visible"}},isEnabled:{value:function(){return Boolean(vendor)}},isHidden:{value:function(){return Boolean(vendor&&document[vendor.hiddenProperty])}},hiddenProperty:{value:vendor&&vendor.hiddenProperty},stateProperty:{value:vendor&&vendor.stateProperty},changeEvent:{value:vendor&&vendor.changeEvent}}))),vendor;function appendError(output,message,source){var $wrapper=jQuery(document.createElement("div")),$toggle=jQuery(document.createElement("button")),$source=jQuery(document.createElement("pre")),mesg="".concat(L10n.get("errorViewTitle"),": ").concat(message||"unknown error");return $toggle.addClass("error-toggle").ariaClick({label:L10n.get("errorViewLabelToggle")},(function(){$toggle.hasClass("enabled")?($toggle.removeClass("enabled"),$source.attr({"aria-hidden":!0,hidden:"hidden"})):($toggle.addClass("enabled"),$source.removeAttr("aria-hidden hidden"))})).appendTo($wrapper),jQuery(document.createElement("span")).addClass("error").text(mesg).appendTo($wrapper),jQuery(document.createElement("code")).text(source).appendTo($source),$source.addClass("error-source").attr({"aria-hidden":!0,hidden:"hidden"}).appendTo($wrapper),$wrapper.addClass("error-view").appendTo(output),console.warn("".concat(mesg,"\n\t").concat(source.replace(/\n/g,"\n\t"))),!1}var throwError=appendError;function charAndPosAt(string,position){var str=String(string),pos=Math.trunc(position),code=str.charCodeAt(pos);if(Number.isNaN(code))return{char:"",start:-1,end:-1};var retval={char:str.charAt(pos),start:pos,end:pos};if(code<55296||code>57343)return retval;if(code>=55296&&code<=56319){var nextPos=pos+1;if(nextPos>=str.length)return retval;var nextCode=str.charCodeAt(nextPos);return nextCode<56320||nextCode>57343||(retval.char=retval.char+str.charAt(nextPos),retval.end=nextPos),retval}if(0===pos)return retval;var prevPos=pos-1,prevCode=str.charCodeAt(prevPos);return prevCode<55296||prevCode>56319||(retval.char=str.charAt(prevPos)+retval.char,retval.start=prevPos),retval}function clone(O){if("object"!==_typeof(O)||null===O)return O;if("function"==typeof O.clone)return O.clone(!0);var copy;if(O instanceof Array)copy=new Array(O.length);else if(O instanceof Date)copy=new Date(O.getTime());else if(O instanceof Map)copy=new Map,O.forEach((function(val,key){return copy.set(clone(key),clone(val))}));else if(O instanceof RegExp)copy=new RegExp(O);else if(O instanceof Set)copy=new Set,O.forEach((function(val){return copy.add(clone(val))}));else{var type=getTypeOf(O);if("Object"!==type)throw new TypeError("attempted to clone unsupported type: ".concat(type));copy=Object.create(Object.getPrototypeOf(O))}return Object.keys(O).forEach((function(P){return copy[P]=clone(O[P])})),copy}var convertBreaks=function(){var isNotSpaceRE=new RegExp(Patterns.notSpace);function isParagraphEmpty(para){if(!para.hasChildNodes())return!0;for(var nodes=para.childNodes,length=nodes.length,i=0;i<length;++i){var node=nodes[i];switch(node.nodeType){case Node.TEXT_NODE:if(isNotSpaceRE.test(node.nodeValue))return!1;break;case Node.COMMENT_NODE:break;default:return!1}}return!0}return function(source){for(var node,output=document.createDocumentFragment(),para=document.createElement("p");null!==(node=source.firstChild);){if(node.nodeType===Node.ELEMENT_NODE)switch(node.nodeName.toUpperCase()){case"BR":if(null!==node.nextSibling&&node.nextSibling.nodeType===Node.ELEMENT_NODE&&"BR"===node.nextSibling.nodeName.toUpperCase()){source.removeChild(node.nextSibling),source.removeChild(node),isParagraphEmpty(para)||output.appendChild(para),para=document.createElement("p");continue}if(isParagraphEmpty(para)){source.removeChild(node);continue}break;case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":isParagraphEmpty(para)||(output.appendChild(para),para=document.createElement("p")),output.appendChild(node);continue}para.appendChild(node)}isParagraphEmpty(para)||output.appendChild(para),source.appendChild(output)}}(),createFilename=(illegalCharsRE=/[\x00-\x1f"#$%&'*+,/:;<=>?\\^`|\x7f-\x9f]+/g,function(str){return String(str).trim().replace(illegalCharsRE,"")}),illegalCharsRE,createSlug=function(){var illegalCharsRE=/[\x00-\x20!-/:-@[-^`{-\x9f]+/g,isInvalidSlugRE=/^-*$/,storySigilRE=/^\$/,tempSigilRE=/^_/;return function(str){var base=String(str).trim(),legacy=base.replace(/[^\w\s\u2013\u2014-]+/g,"").replace(/[_\s\u2013\u2014-]+/g,"-").toLocaleLowerCase();return isInvalidSlugRE.test(legacy)?base.replace(storySigilRE,"").replace(tempSigilRE,"-").replace(illegalCharsRE,""):legacy}}();function cssPropToDOMProp(cssName){if(!cssName.includes("-"))switch(cssName){case"bgcolor":return"backgroundColor";case"float":return"cssFloat";default:return cssName}return("-ms-"===cssName.slice(0,4)?cssName.slice(1):cssName).split("-").map((function(part,i){return 0===i?part:part.toUpperFirst()})).join("")}var cssTimeToMS=(cssTimeRE=/^([+-]?(?:\d*\.)?\d+)([Mm]?[Ss])$/,function(cssTime){var match=cssTimeRE.exec(String(cssTime));if(null===match)throw new SyntaxError('invalid time value syntax: "'.concat(cssTime,'"'));var msec=Number(match[1]);if(1===match[2].length&&(msec*=1e3),Number.isNaN(msec)||!Number.isFinite(msec))throw new RangeError('invalid time value: "'.concat(cssTime,'"'));return msec}),cssTimeRE,decodeEntities=(escapedHtmlRE=/&(?:amp|#38|#x26|lt|#60|#x3c|gt|#62|#x3e|quot|#34|#x22|apos|#39|#x27|#96|#x60);/gi,hasEscapedHtmlRE=new RegExp(escapedHtmlRE.source,"i"),escapedHtmlTable=enumFrom({"&amp;":"&","&#38;":"&","&#x26;":"&","&lt;":"<","&#60;":"<","&#x3c;":"<","&gt;":">","&#62;":">","&#x3e;":">","&quot;":'"',"&#34;":'"',"&#x22;":'"',"&apos;":"'","&#39;":"'","&#x27;":"'","&#96;":"`","&#x60;":"`"}),function(str){if(null==str)return"";var val=String(str);return val&&hasEscapedHtmlRE.test(val)?val.replace(escapedHtmlRE,(function(entity){return escapedHtmlTable[entity.toLowerCase()]})):val}),escapedHtmlRE,hasEscapedHtmlRE,escapedHtmlTable,encodeEntities=(htmlCharsRE=/[&<>"'`]/g,hasHtmlCharsRE=new RegExp(htmlCharsRE.source),htmlCharsTable=enumFrom({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"}),function(str){if(null==str)return"";var val=String(str);return val&&hasHtmlCharsRE.test(val)?val.replace(htmlCharsRE,(function(ch){return htmlCharsTable[ch]})):val}),htmlCharsRE,hasHtmlCharsRE,htmlCharsTable,encodeMarkup=(markupCharsRE=/[!"#$&'*\-/<=>?@[\\\]^_`{|}~]/g,hasMarkupCharsRE=new RegExp(markupCharsRE.source),markupCharsTable=enumFrom({"!":"&#33;",'"':"&quot;","#":"&#35;",$:"&#36;","&":"&amp;","'":"&#39;","*":"&#42;","-":"&#45;","/":"&#47;","<":"&lt;","=":"&#61;",">":"&gt;","?":"&#63;","@":"&#64;","[":"&#91;","\\":"&#92;","]":"&#93;","^":"&#94;",_:"&#95;","`":"&#96;","{":"&#123;","|":"&#124;","}":"&#125;","~":"&#126;"}),function(str){if(null==str)return"";var val=String(str);return val&&hasMarkupCharsRE.test(val)?val.replace(markupCharsRE,(function(ch){return markupCharsTable[ch]})):val}),markupCharsRE,hasMarkupCharsRE,markupCharsTable,enquote=(unescapedDQuoteRE=/(^|[^\\])(")/g,unescapedSQuoteRE=/(^|[^\\])(')/g,function(string){for(var dqCount=0,sqCount=0,i=0;i<string.length;++i)switch(string[i]){case"\\":++i;break;case'"':++dqCount;break;case"'":++sqCount}if(0===dqCount)return'"'.concat(string,'"');if(0===sqCount)return"'".concat(string,"'");var quote=dqCount<=sqCount?'"':"'";return"".concat(quote).concat(string.replace('"'===quote?unescapedDQuoteRE:unescapedSQuoteRE,"$1\\$2")).concat(quote)}),unescapedDQuoteRE,unescapedSQuoteRE;function enumFrom(O){var pEnum=Object.create(null);if(O instanceof Array)O.forEach((function(val,i){return pEnum[String(val)]=i}));else if(O instanceof Set)Array.from(O).forEach((function(val,i){return pEnum[String(val)]=i}));else if(O instanceof Map)O.forEach((function(val,key){return pEnum[String(key)]=val}));else{if(null===O||"object"!==_typeof(O)||Object.getPrototypeOf(O)!==Object.prototype)throw new TypeError("enumFrom object parameter must be an Array, Map, Set, or generic object");Object.assign(pEnum,O)}return Object.freeze(Object.defineProperties(pEnum,{nameFrom:{value:function(needle){var entry=Object.entries(this).find((function(entry){return entry[1]===needle}));return entry?entry[0]:undefined}}}))}var exceptionFrom=(extraProps=Object.freeze(["code","data","result","stack","columnNumber","fileName","lineNumber","description","number"]),function(original,exceptionType,override){if(null===original||"object"!==_typeof(original))throw new Error("exceptionFrom original parameter must be an object");if("function"!=typeof exceptionType)throw new Error("exceptionFrom exceptionType parameter must be an error type constructor");var overrideType=_typeof(override);if("undefined"!==overrideType&&"string"!==overrideType&&"object"!==overrideType)throw new Error("exceptionFrom override parameter must be an object or string");var propValues=new Map;extraProps.forEach((function(name){void 0!==original[name]&&propValues.set(name,original[name])})),"string"===overrideType?propValues.set("message",override):"object"===overrideType&&null!==override&&Object.getOwnPropertyNames(override).forEach((function(name){void 0!==override[name]&&propValues.set(name,override[name])}));var ex=new exceptionType(propValues.get("message"));return propValues.delete("message"),propValues.forEach((function(value,name){void 0===ex[name]?Object.defineProperty(ex,name,{value:value,configurable:!0,writable:!0}):ex[name]=value})),ex}),extraProps;function getActiveElement(){try{return document.activeElement||null}catch(ex){return null}}function getErrorMessage(O){return null==O?"unknown error":"object"===_typeof(O)&&"message"in O?O.message:String(O)}var getToStringTag=(toString=Object.prototype.toString,slice=String.prototype.slice,"[object Object]"===toString.call(new Map)?function(O){return O instanceof Map?"Map":O instanceof Set?"Set":slice.call(toString.call(O),8,-1)}:function(O){return slice.call(toString.call(O),8,-1)}),toString,slice,getTypeOf=function(){var toString=Object.prototype.toString,slice=String.prototype.slice;return function(O){if(null===O)return"null";var baseType=_typeof(O);return"object"===baseType?slice.call(toString.call(O),8,-1):baseType}}(),hasMediaQuery="function"!=typeof window.matchMedia?function(){return!1}:function(mediaQuery){return window.matchMedia(mediaQuery).matches},isExternalLink=(externalUrlRE=new RegExp("^".concat(Patterns.externalUrl),"gim"),fingerprintRE=/[/\\?]/,function(link){return!Story.has(link)&&(externalUrlRE.test(link)||fingerprintRE.test(link))}),externalUrlRE,fingerprintRE;function msToCSSTime(msec){if("number"!=typeof msec||Number.isNaN(msec)||!Number.isFinite(msec)){var what;switch(_typeof(msec)){case"string":what='"'.concat(msec,'"');break;case"number":what=String(msec);break;default:what=getTypeOf(msec)}throw new TypeError("invalid milliseconds value: ".concat(what))}return"".concat(msec,"ms")}var now=(clock=Has.performance?performance:Date,function(){return clock.now()}),clock,onUserActivation=(uaEvents=Object.freeze(["keydown","mousedown","pointerdown","pointerup","touchend"]),function(namespace,callback){jQuery(document).off(namespace).on(uaEvents.map((function(name){return"".concat(name).concat(namespace)})).join(" "),(function(ev){callback(ev).then((function(){return jQuery(document).off(namespace)}),(function(ex){if("NotAllowedError"!==ex.name)throw jQuery(document).off(namespace),ex}))}))}),uaEvents;function parseURL(url){var parser=document.createElement("a"),searchParams=Object.create(null);parser.href=url,parser.search&&parser.search.replace(/^\?/,"").splitOrEmpty(/(?:&(?:amp;)?|;)/).forEach((function(query){var _query$split2=_slicedToArray(query.split("="),2),key=_query$split2[0],value=_query$split2[1];Object.hasOwn(searchParams,key)?searchParams[key].push(value):searchParams[key]=[value]}));var pathname=parser.host&&"/"!==parser.pathname[0]?"/".concat(parser.pathname):parser.pathname;return Object.freeze(Object.assign(Object.create(null),{href:parser.href,protocol:parser.protocol,host:parser.host,hostname:parser.hostname,port:parser.port,path:"".concat(pathname).concat(parser.search),pathname:pathname,search:parser.search,searchParams:Object.freeze(searchParams),hash:parser.hash}))}function sameValueZero(a,b){return a===b||a!=a&&b!=b}var scrubEventKey=function(){var separatorKey,decimalKey;if("undefined"!=typeof Intl&&"function"==typeof Intl.NumberFormat){var match=(new Intl.NumberFormat).format(111111.5).match(/(\D*)\d+(\D*)\d$/);match&&(separatorKey=match[1],decimalKey=match[2])}return separatorKey||decimalKey||(separatorKey=",",decimalKey="."),function(key){switch(key){case"Scroll":return"ScrollLock";case"Spacebar":return" ";case"Left":return"ArrowLeft";case"Right":return"ArrowRight";case"Up":return"ArrowUp";case"Down":return"ArrowDown";case"Del":return"Delete";case"Crsel":return"CrSel";case"Exsel":return"ExSel";case"Esc":return"Escape";case"Apps":return"ContextMenu";case"Nonconvert":return"NonConvert";case"MediaNextTrack":return"MediaTrackNext";case"MediaPreviousTrack":return"MediaTrackPrevious";case"VolumeUp":return"AudioVolumeUp";case"VolumeDown":return"AudioVolumeDown";case"VolumeMute":return"AudioVolumeMute";case"Zoom":return"ZoomToggle";case"SelectMedia":case"MediaSelect":return"LaunchMediaPlayer";case"Add":return"+";case"Divide":return"/";case"Multiply":return"*";case"Subtract":return"-";case"Decimal":return decimalKey;case"Separator":return separatorKey}return key}}(),setDisplayTitle=function(title,isPlainText){if("string"!=typeof title)throw new TypeError("title parameter must be a string (received: ".concat(getTypeOf(title),")"));var render,text;isPlainText?text=render=title.trim():(render=document.createDocumentFragment(),new Wikifier(render,title,{noCleanup:!0}),text=function(source){for(var node,copy=source.cloneNode(!0),frag=document.createDocumentFragment();null!==(node=copy.firstChild);){if(node.nodeType===Node.ELEMENT_NODE)switch(node.nodeName.toUpperCase()){case"BR":case"DIV":case"P":frag.appendChild(document.createTextNode(" "))}frag.appendChild(node)}return frag.textContent}(render).trim()),document.title=Config.passages.displayTitles&&""!==State.passage&&State.passage!==Config.passages.start?"".concat(State.passage," | ").concat(text):text,jQuery("#story-title").empty().append(render)};function setPageElement(idOrElement,titles,defaultText){var el="object"===_typeof(idOrElement)?idOrElement:document.getElementById(idOrElement);if(null==el)return null;var ids=titles instanceof Array?titles:[titles];jQuery(el).empty();for(var i=0;i<ids.length;++i)if(Story.has(ids[i]))return new Wikifier(el,Story.get(ids[i]).processText().trim()),el;if(null!=defaultText){var text=String(defaultText).trim();""!==text&&new Wikifier(el,text)}return el}function stringFrom(value){switch(_typeof(value)){case"function":return"[function]";case"number":if(Number.isNaN(value))return"[number NaN]";break;case"object":if(null===value)return"[null]";if(value instanceof Array)return value.map((function(val){return stringFrom(val)})).join(", ");if(value instanceof Set)return Array.from(value).map((function(val){return stringFrom(val)})).join(", ");if(value instanceof Map){var result=Array.from(value).map((function(_ref5){var _ref6=_slicedToArray(_ref5,2),key=_ref6[0],val=_ref6[1];return"".concat(stringFrom(key)," → ").concat(stringFrom(val))}));return"{ ".concat(result.join(", ")," }")}if(value instanceof Date)return value.toLocaleString();if(value instanceof Element){if(value===document.documentElement||value===document.head||value===document.body)throw new Error("illegal operation; attempting to convert the <html>, <head>, or <body> tags to string is not allowed");return value.outerHTML}if(value instanceof Node)return value.textContent;break;case"symbol":var desc=void 0!==value.description?' "'.concat(value.description,'"'):"";return"[symbol".concat(desc,"]");case"undefined":return"[undefined]"}return String(value)}var triggerEvent=(createEvent=function(){try{return new CustomEvent("click",{bubbles:!0}),function(name,options){for(var _Object$assign=Object.assign({bubbles:!0,cancelable:!0,composed:!1},options),bubbles=_Object$assign.bubbles,cancelable=_Object$assign.cancelable,composed=_Object$assign.composed,detail=_Object$assign.detail,custom=_objectWithoutProperties(_Object$assign,_excluded),event=new CustomEvent(name,{bubbles:bubbles,cancelable:cancelable,composed:composed,detail:detail}),i=0,keys=Object.keys(custom);i<keys.length;++i){var key=keys[i];void 0!==custom[key]&&(event[key]=options[key])}return event}}catch(ex){return function(name,options){for(var _Object$assign2=Object.assign({bubbles:!0,cancelable:!0},options),bubbles=_Object$assign2.bubbles,cancelable=_Object$assign2.cancelable,custom=_objectWithoutProperties(_Object$assign2,_excluded2),event=document.createEvent("Event"),i=0,keys=Object.keys(custom);i<keys.length;++i){var key=keys[i];void 0!==custom[key]&&(event[key]=options[key])}return event.initEvent(name,bubbles,cancelable),event}}}(),function(name,targets,options){var event=createEvent(name,options),elems=[];if(targets)if(targets instanceof jQuery||targets instanceof NodeList||targets instanceof Array)for(var i=0;i<targets.length;++i)elems.push(targets[i]);else elems.push(targets);else elems.push(document);for(var _i5=0;_i5<elems.length;++_i5)elems[_i5].dispatchEvent(event)}),createEvent,SimpleStore=(_adapters=[],_initialized=null,Object.preventExtensions(Object.create(null,{adapters:{value:_adapters},create:{value:function(storageId,persistent){if(_initialized)return _initialized.create(storageId,persistent);for(var i=0;i<_adapters.length;++i)if(_adapters[i].init(storageId,persistent))return(_initialized=_adapters[i]).create(storageId,persistent);throw new Error("No valid storage adapters found")}}}))),_adapters,_initialized,_MAX_EXPIRY,_MIN_EXPIRY,_ok,CookieAdapter;SimpleStore.adapters.push(function(){var _ok=!1,WebStorageAdapter=function(){function WebStorageAdapter(storageId,persistent){_classCallCheck(this,WebStorageAdapter);var prefix="".concat(storageId,"."),engine=null,name=null;persistent?(engine=window.localStorage,name="localStorage"):(engine=window.sessionStorage,name="sessionStorage"),Object.defineProperties(this,{_engine:{value:engine},_prefix:{value:prefix},_prefixRe:{value:new RegExp("^".concat(RegExp.escape(prefix)))},name:{value:name},id:{value:storageId},persistent:{value:Boolean(persistent)}})}return _createClass(WebStorageAdapter,[{key:"size",get:function(){return this.keys().length}},{key:"keys",value:function(){for(var keys=[],i=0;i<this._engine.length;++i){var key=this._engine.key(i);this._prefixRe.test(key)&&keys.push(key.replace(this._prefixRe,""))}return keys}},{key:"has",value:function(key){return!("string"!=typeof key||!key)&&Object.hasOwn(this._engine,this._prefix+key)}},{key:"get",value:function(key){if("string"!=typeof key||!key)return null;var value=this._engine.getItem(this._prefix+key);return null==value?null:WebStorageAdapter._deserialize(value)}},{key:"set",value:function(key,value){if("string"!=typeof key||!key)return!1;try{this._engine.setItem(this._prefix+key,WebStorageAdapter._serialize(value))}catch(ex){if(isQuotaDOMException(ex))throw exceptionFrom(ex,Error,{cause:{origin:ex},message:"".concat(this.name," quota exceeded")});throw ex}return!0}},{key:"delete",value:function(key){return!("string"!=typeof key||!key)&&(this._engine.removeItem(this._prefix+key),!0)}},{key:"clear",value:function(){for(var keys=this.keys(),i=0,length=keys.length;i<length;++i)this.delete(keys[i]);return!0}}],[{key:"_serialize",value:function(obj){return LZString.compressToUTF16(Serial.stringify(obj))}},{key:"_deserialize",value:function(str){return Serial.parse(LZString.decompressFromUTF16(str))}}])}();var isQuotaErrorRE=/quota.?(?:exceeded|reached)/i;function isQuotaDOMException(ex){return ex instanceof DOMException&&(22===ex.code||1014===ex.code||isQuotaErrorRE.test(ex.name)||isQuotaErrorRE.test(ex.message))}return Object.preventExtensions(Object.create(null,{init:{value:function(){function hasWebStorage(storeId){var store;try{store=window[storeId];var val="_sc_".concat(String(Date.now()));store.setItem(val,val);var result=store.getItem(val)===val;return store.removeItem(val),result}catch(ex){return store&&0!==store.length&&isQuotaDOMException(ex)}}return _ok=hasWebStorage("localStorage")&&hasWebStorage("sessionStorage")}},create:{value:function(storageId,persistent){if(!_ok)throw new Error("adapter not initialized");return new WebStorageAdapter(storageId,persistent)}}}))}()),SimpleStore.adapters.push((_MAX_EXPIRY="Tue, 19 Jan 2038 03:14:07 GMT",_MIN_EXPIRY="Thu, 01 Jan 1970 00:00:00 GMT",_ok=!1,CookieAdapter=function(){function CookieAdapter(storageId,persistent){_classCallCheck(this,CookieAdapter);var prefix="".concat(storageId).concat(persistent?"!":"*",".");Object.defineProperties(this,{_prefix:{value:prefix},_prefixRe:{value:new RegExp("^".concat(RegExp.escape(prefix)))},name:{value:"cookie"},id:{value:storageId},persistent:{value:Boolean(persistent)}})}return _createClass(CookieAdapter,[{key:"size",get:function(){return this.keys().length}},{key:"keys",value:function(){if(""===document.cookie)return[];for(var cookies=document.cookie.split(/;\s*/),keys=[],i=0;i<cookies.length;++i){var kvPair=cookies[i].split("="),key=decodeURIComponent(kvPair[0]);this._prefixRe.test(key)&&""!==decodeURIComponent(kvPair[1])&&keys.push(key.replace(this._prefixRe,""))}return keys}},{key:"has",value:function(key){return!("string"!=typeof key||!key)&&null!==CookieAdapter._getCookie(this._prefix+key)}},{key:"get",value:function(key){if("string"!=typeof key||!key)return null;var value=CookieAdapter._getCookie(this._prefix+key);return null===value?null:CookieAdapter._deserialize(value)}},{key:"set",value:function(key,value){if("string"!=typeof key||!key)return!1;try{if(CookieAdapter._setCookie(this._prefix+key,CookieAdapter._serialize(value),this.persistent?_MAX_EXPIRY:undefined),!this.has(key))throw new Error("unknown validation error during set")}catch(ex){throw exceptionFrom(ex,Error,{cause:{origin:ex},message:"cookie error: ".concat(ex.message)})}return!0}},{key:"delete",value:function(key){if("string"!=typeof key||!key||!this.has(key))return!1;try{if(CookieAdapter._setCookie(this._prefix+key,undefined,_MIN_EXPIRY),this.has(key))throw new Error("unknown validation error during delete")}catch(ex){throw exceptionFrom(ex,Error,{cause:{origin:ex},message:"cookie error: ".concat(ex.message)})}return!0}},{key:"clear",value:function(){for(var keys=this.keys(),i=0,length=keys.length;i<length;++i)this.delete(keys[i]);return!0}}],[{key:"_getCookie",value:function(prefixedKey){if(!prefixedKey||""===document.cookie)return null;for(var cookies=document.cookie.split(/;\s*/),i=0;i<cookies.length;++i){var kvPair=cookies[i].split("=");if(prefixedKey===decodeURIComponent(kvPair[0]))return decodeURIComponent(kvPair[1])||null}return null}},{key:"_setCookie",value:function(prefixedKey,value,expiry){if(prefixedKey){var payload="".concat(encodeURIComponent(prefixedKey),"=");null!=value&&(payload+=encodeURIComponent(value)),null!=expiry&&(payload+="; expires=".concat(expiry)),payload+="; path=/",document.cookie=payload}}},{key:"_serialize",value:function(obj){return LZString.compressToBase64(Serial.stringify(obj))}},{key:"_deserialize",value:function(str){return Serial.parse(LZString.decompressFromBase64(str))}}])}(),Object.preventExtensions(Object.create(null,{init:{value:function(storageId){try{var tid="_sc_".concat(String(Date.now()));CookieAdapter._setCookie(tid,CookieAdapter._serialize(tid),undefined),_ok=CookieAdapter._deserialize(CookieAdapter._getCookie(tid))===tid,CookieAdapter._setCookie(tid,undefined,_MIN_EXPIRY)}catch(ex){_ok=!1}return _ok&&function(storageId){if(""!==document.cookie)for(var oldPrefix="".concat(storageId,"."),oldPrefixRe=new RegExp("^".concat(RegExp.escape(oldPrefix))),persistPrefix="".concat(storageId,"!."),sessionPrefix="".concat(storageId,"*."),sessionTestRe=/\.(?:state|rcWarn)$/,cookies=document.cookie.split(/;\s*/),_loop=function(){var kvPair=cookies[i].split("="),key=decodeURIComponent(kvPair[0]);if(oldPrefixRe.test(key)){var value=decodeURIComponent(kvPair[1]);if(""!==value){var persist=!sessionTestRe.test(key);CookieAdapter._setCookie(key,undefined,_MIN_EXPIRY),CookieAdapter._setCookie(key.replace(oldPrefixRe,(function(){return persist?persistPrefix:sessionPrefix})),value,persist?_MAX_EXPIRY:undefined)}}},i=0;i<cookies.length;++i)_loop()}(storageId),_ok}},create:{value:function(storageId,persistent){if(!_ok)throw new Error("adapter not initialized");return new CookieAdapter(storageId,persistent)}}}))));var DebugView=function(){function DebugView(parent,type,name,title){_classCallCheck(this,DebugView),Object.defineProperties(this,{parent:{value:parent},view:{value:document.createElement("span")},break:{value:document.createElement("wbr")}}),jQuery(this.view).attr({title:title,"aria-label":title,"data-type":null!=type?type:"","data-name":null!=name?name:""}).addClass("debug"),jQuery(this.break).addClass("debug hidden"),this.parent.appendChild(this.view),this.parent.appendChild(this.break)}return _createClass(DebugView,[{key:"output",get:function(){return this.view}},{key:"type",get:function(){return this.view.getAttribute("data-type")},set:function(type){this.view.setAttribute("data-type",null!=type?type:"")}},{key:"name",get:function(){return this.view.getAttribute("data-name")},set:function(name){this.view.setAttribute("data-name",null!=name?name:"")}},{key:"title",get:function(){return this.view.title},set:function(title){this.view.title=title}},{key:"append",value:function(el){return jQuery(this.view).append(el),this}},{key:"modes",value:function(options){if(null==options){var current={};return this.view.className.splitOrEmpty(/\s+/).forEach((function(name){"debug"!==name&&(current[name]=!0)})),current}if("object"===_typeof(options))return Object.keys(options).forEach((function(name){this[options[name]?"addClass":"removeClass"](name)}),jQuery(this.view)),this;throw new Error("DebugView.prototype.modes options parameter must be an object or null/undefined")}},{key:"remove",value:function(){var $view=jQuery(this.view);this.view.hasChildNodes()&&$view.contents().appendTo(this.parent),$view.remove(),jQuery(this.break).remove()}}],[{key:"isEnabled",value:function(){return"enabled"===jQuery(document.documentElement).attr("data-debug-view")}},{key:"enable",value:function(){jQuery(document.documentElement).attr("data-debug-view","enabled"),triggerEvent(":debugviewupdate")}},{key:"disable",value:function(){jQuery(document.documentElement).removeAttr("data-debug-view"),triggerEvent(":debugviewupdate")}},{key:"toggle",value:function(){DebugView.isEnabled()?DebugView.disable():DebugView.enable()}}])}(),NodeTyper=function(){return _createClass((function NodeTyper(config){if(_classCallCheck(this,NodeTyper),"object"!==_typeof(config)||null===config)throw new Error("config parameter must be an object (received: ".concat(getTypeOf(config),")"));if(!(Object.hasOwn(config,"targetNode")&&config.targetNode instanceof Node))throw new Error('config parameter object "targetNode" property must be a node');Object.defineProperties(this,{node:{value:config.targetNode},childNodes:{value:[]},nodeValue:{writable:!0,value:""},appendTo:{writable:!0,value:config.parentNode||null},classNames:{writable:!0,value:config.classNames||null},finished:{writable:!0,value:!1}});var childNode,node=this.node;for(node.nodeValue&&(this.nodeValue=node.nodeValue,node.nodeValue="");null!==(childNode=node.firstChild);)this.childNodes.push(new NodeTyper({targetNode:childNode,parentNode:node,classNames:this.classNames})),node.removeChild(childNode)}),[{key:"finish",value:function(){for(;this.type(!0););return!1}},{key:"type",value:function(flush){if(this.finished)return!1;if(this.appendTo){if(this.appendTo.appendChild(this.node),this.appendTo=null,this.node.nodeType!==Node.ELEMENT_NODE&&this.node.nodeType!==Node.TEXT_NODE||"none"===jQuery(this.node.parentNode).css("display"))return this.finish();this.node.parentNode&&this.classNames&&jQuery(this.node.parentNode).addClass(this.classNames)}if(this.nodeValue){if(flush)this.node.nodeValue+=this.nodeValue,this.nodeValue="";else{var _charAndPosAt=charAndPosAt(this.nodeValue,0),char=_charAndPosAt.char,start=_charAndPosAt.start,end=_charAndPosAt.end;this.node.nodeValue+=char,this.nodeValue=this.nodeValue.slice(1+end-start)}return!0}this.classNames&&(jQuery(this.node.parentNode).removeClass(this.classNames),this.classNames=null);for(var childNodes=this.childNodes;childNodes.length>0;){if(childNodes[0].type())return!0;childNodes.shift()}return this.finished=!0,!1}}])}(),StyleWrapper=(_imageMarkupRe=new RegExp(Patterns.cssImage,"g"),_hasImageMarkupRe=new RegExp(Patterns.cssImage),function(){return _createClass((function StyleWrapper(style){if(_classCallCheck(this,StyleWrapper),null==style)throw new TypeError("StyleWrapper style parameter must be an HTMLStyleElement object");Object.defineProperties(this,{style:{value:style}})}),[{key:"isEmpty",value:function(){return 0===this.style.cssRules.length}},{key:"set",value:function(rawCss){this.clear(),this.add(rawCss)}},{key:"add",value:function(rawCss){var css=rawCss;_hasImageMarkupRe.test(css)&&(_imageMarkupRe.lastIndex=0,css=css.replace(_imageMarkupRe,(function(wikiImage){var markup=Wikifier.helpers.parseSquareBracketedMarkup({source:wikiImage,matchStart:0});if(Object.hasOwn(markup,"error")||markup.pos<wikiImage.length)return wikiImage;var source=markup.source;if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(source=passage.text.trim())}return'url("'.concat(source.replace(/"/g,"%22"),'")')}))),this.style.styleSheet?this.style.styleSheet.cssText+=css:this.style.appendChild(document.createTextNode(css))}},{key:"clear",value:function(){this.style.styleSheet?this.style.styleSheet.cssText="":jQuery(this.style).empty()}}])}()),_imageMarkupRe,_hasImageMarkupRe,Diff=function(){var Op=enumFrom({Delete:0,SpliceArray:1,Copy:2,CopyDate:3});function isNumeric(O){var num;switch(_typeof(O)){case"number":num=O;break;case"string":num=Number(O);break;default:return!1}return!Number.isNaN(num)&&Number.isFinite(num)}return Object.preventExtensions(Object.create(null,{Op:{value:Op},diff:{value:function diff(a,b){for(var aOpKey,toString=Object.prototype.toString,aIsArray=a instanceof Array,delta=Object.create(null),keys=[].concat(_toConsumableArray(Object.keys(a)),_toConsumableArray(Object.keys(b))).sort().filter((function(val,i,arr){return 0===i||arr[i-1]!==val})),isAOpKey=function(key){return key===aOpKey},i=0,klen=keys.length;i<klen;++i){var key=keys[i],aVal=a[key],bVal=b[key];if(Object.hasOwn(a,key))if(Object.hasOwn(b,key)){if(aVal===bVal)continue;if(_typeof(aVal)===_typeof(bVal))if("function"==typeof aVal)aVal.toString()!==bVal.toString()&&(delta[key]=[Op.Copy,bVal]);else if("object"!==_typeof(aVal)||null===aVal)delta[key]=[Op.Copy,bVal];else{var aValType=toString.call(aVal);if(aValType===toString.call(bVal))if(aVal instanceof Date)aVal.getTime()!==bVal.getTime()&&(delta[key]=[Op.Copy,clone(bVal)]);else if(aVal instanceof Map)delta[key]=[Op.Copy,clone(bVal)];else if(aVal instanceof RegExp)aVal.toString()!==bVal.toString()&&(delta[key]=[Op.Copy,clone(bVal)]);else if(aVal instanceof Set)delta[key]=[Op.Copy,clone(bVal)];else if(aVal instanceof Array||"[object Object]"===aValType){var subDelta=diff(aVal,bVal);null!==subDelta&&(delta[key]=subDelta)}else delta[key]=[Op.Copy,clone(bVal)];else delta[key]=[Op.Copy,clone(bVal)]}else delta[key]=[Op.Copy,"object"!==_typeof(bVal)||null===bVal?bVal:clone(bVal)]}else if(aIsArray&&isNumeric(key)){var index=Number(key);if(!aOpKey){aOpKey="";do{aOpKey+="~"}while(keys.some(isAOpKey));delta[aOpKey]=[Op.SpliceArray,index,index]}index<delta[aOpKey][1]&&(delta[aOpKey][1]=index),index>delta[aOpKey][2]&&(delta[aOpKey][2]=index)}else delta[key]=Op.Delete;else delta[key]=[Op.Copy,"object"!==_typeof(bVal)||null===bVal?bVal:clone(bVal)]}return Object.keys(delta).length>0?delta:null}},patch:{value:function patch(orig,delta){for(var keys=delta?Object.keys(delta):[],patched=clone(orig),i=0,klen=keys.length;i<klen;++i){var key=keys[i],value=delta[key];if(value===Op.Delete)delete patched[key];else if(value instanceof Array)switch(value[0]){case Op.SpliceArray:patched.splice(value[1],value[2]-value[1]+1);break;case Op.Copy:patched[key]=clone(value[1]);break;case Op.CopyDate:patched[key]=new Date(value[1])}else patched[key]=patch(patched[key],value)}return patched}}}))}(),L10n=(replaceRE=/\{\w+\}/g,hasReplaceRE=new RegExp(replaceRE.source),Object.preventExtensions(Object.create(null,{init:{value:function(){}},get:{value:function(ids,overrides){if(!ids)return"";var id=(Array.isArray(ids)?ids:[ids]).find((function(id){return Object.hasOwn(l10nStrings,id)}));if(!id)return"";for(var value=l10nStrings[id],i=0;hasReplaceRE.test(value);){if(++i>50)throw new Error("L10n.get exceeded maximum replacement depth, probable infinite loop");replaceRE.lastIndex=0,value=value.replace(replaceRE,(function(replacement){var rid=replacement.slice(1,-1);return overrides&&Object.hasOwn(overrides,rid)?overrides[rid]:Object.hasOwn(l10nStrings,rid)?l10nStrings[rid]:void 0}))}return value}}}))),replaceRE,hasReplaceRE,l10nStrings={textAbort:"Abort",textAborting:"Aborting",textCancel:"Cancel",textClear:"Clear",textClose:"Close",textDelete:"Delete",textExport:"Export",textIdentity:"game",textImport:"Import",textLoad:"Load",textOff:"Off",textOk:"OK",textOn:"On",textSave:"Save",textTurn:"Turn",errorNonexistentPassage:'the passage "{passage}" does not exist',warningNoStorage:"All usable storage APIs are missing. Possible causes are a disabled third-party cookie setting, which also affects Web Storage, or a private browsing mode.",warningNoWebStorage:"The Web Storage API is missing, so this {textIdentity} is running in a degraded mode. You may be able to continue, however, some parts may not work properly.",warningDegraded:"Some capabilities required to support this {textIdentity} are missing, so it is running in a degraded mode. You may be able to continue, however, some parts may not work properly.",warningNoSaves:"Some capabilities required to support saves are missing, so saves have been disabled for this session.",saveErrorDisallowed:"Saving is currently disallowed.",saveErrorDecodeFail:"unable to decode save, likely due to corruption",saveErrorDiskLoadFail:"failed to load save file from disk",saveErrorIdMismatch:"save is from the wrong {textIdentity}",saveErrorInvalidData:"save is missing required data, likely due to corruption",saveErrorLoadTooEarly:"cannot load save this early",saveErrorNonexistent:"save does not exist",uiBarLabelToggle:"Toggle the UI bar",uiBarLabelBackward:"Go backward within the {textIdentity} history",uiBarLabelForward:"Go forward within the {textIdentity} history",uiBarLabelJumpto:"Jump to a specific point within the {textIdentity} history",alertTitle:"Alert",restartTitle:"Restart",restartMesgPrompt:"All unsaved progress will be lost. Are you sure that you want to restart?",continueTitle:"Continue",savesTitle:"Saves",savesHeaderBrowser:"In Browser",savesHeaderDisk:"On Disk",savesLabelBrowserClear:"Clear all browser saves",savesLabelBrowserExport:"Export browser saves to bundle",savesLabelBrowserImport:"Import browser saves from bundle",savesLabelDiskLoad:"Load from disk",savesLabelDiskSave:"Save to disk",savesTextBrowserAuto:"Auto",savesTextBrowserSlot:"Slot",savesTextNoDate:"unknown date",settingsTitle:"Settings",settingsTextReset:"Reset to Defaults",errorViewTitle:"Error",errorViewLabelToggle:"Toggle the error view",debugBarLabelToggle:"Toggle the debug bar",debugBarLabelViewsToggle:"Toggle the debug views",debugBarLabelWatchAdd:"Add a new watch",debugBarLabelWatchAll:"Watch all",debugBarLabelWatchClear:"Clear all watches",debugBarLabelWatchDelete:"Delete this watch",debugBarLabelWatchPlaceholder:"variable name",debugBarLabelPassagePlaceholder:"passage name",debugBarLabelPassagePlay:"Play passage",debugBarLabelWatchToggle:"Toggle the watch panel",debugBarMesgNoWatches:"No watches set",debugBarTextAdd:"Add",debugBarTextPassage:"Passage",debugBarTextViews:"Views",debugBarTextWatch:"Watch",macroBackText:"Back",macroReturnText:"Return",autoloadTitle:"Autoload",autoloadMesgPrompt:"An autosave exists. Load it now or go to the start?",autoloadTextCancel:"Go to start",autoloadTextOk:"Load autosave",jumptoTitle:"Jump To",jumptoMesgUnavailable:"No jump points currently available…",shareTitle:"Share"},Config=(_addVisitedLinkClass=!1,_cleanupWikifierOutput=!1,_debug=!1,_enableOptionalDebugging=!1,_loadDelay=0,_audioPauseOnFadeToZero=!0,_audioPreloadMetadata=!0,_historyControls=!0,_historyMaxStates=40,_macrosMaxLoopIterations=1e3,_macrosTypeSkipKey=" ",_macrosTypeVisitedPassages=!0,_passagesDisplayTitles=!1,_passagesNobr=!1,_savesMaxAuto=0,_savesMaxSlot=8,_uiStowBarInitially=800,_uiUpdateStoryElements=!0,errPassagesDescriptionsDeprecated="[DEPRECATED] Config.passages.descriptions has been deprecated, see Config.saves.descriptions instead",errSavesAutoloadDeprecated="[DEPRECATED] Config.saves.autoload has been deprecated, see the Save.browser.continue API instead",_baseSavesAutosaveDeprecated="[DEPRECATED] Config.saves.autosave has been deprecated",errSavesOnLoadDeprecated="[DEPRECATED] Config.saves.onLoad has been deprecated, see the Save.onLoad API instead",errSavesOnSaveDeprecated="[DEPRECATED] Config.saves.onSave has been deprecated, see the Save.onSave API instead",errSavesSlotsDeprecated="[DEPRECATED] Config.saves.slots has been deprecated, see Config.saves.maxSlotSaves instead",Object.freeze({get addVisitedLinkClass(){return _addVisitedLinkClass},set addVisitedLinkClass(value){_addVisitedLinkClass=Boolean(value)},get cleanupWikifierOutput(){return _cleanupWikifierOutput},set cleanupWikifierOutput(value){_cleanupWikifierOutput=Boolean(value)},get debug(){return _debug},set debug(value){_debug=Boolean(value)},get enableOptionalDebugging(){return _enableOptionalDebugging},set enableOptionalDebugging(value){_enableOptionalDebugging=Boolean(value)},get loadDelay(){return _loadDelay},set loadDelay(value){if(!Number.isSafeInteger(value)||value<0)throw new RangeError("Config.loadDelay must be a non-negative integer");_loadDelay=value},audio:Object.freeze({get pauseOnFadeToZero(){return _audioPauseOnFadeToZero},set pauseOnFadeToZero(value){_audioPauseOnFadeToZero=Boolean(value)},get preloadMetadata(){return _audioPreloadMetadata},set preloadMetadata(value){_audioPreloadMetadata=Boolean(value)}}),history:Object.freeze({get controls(){return _historyControls},set controls(value){var controls=Boolean(value);if(1===_historyMaxStates&&controls)throw new Error("Config.history.controls must be false when Config.history.maxStates is 1");_historyControls=controls},get maxStates(){return _historyMaxStates},set maxStates(value){if(!Number.isSafeInteger(value)||value<1)throw new RangeError("Config.history.maxStates must be a positive integer");_historyMaxStates=value,_historyControls&&1===value&&(_historyControls=!1)}}),macros:Object.freeze({get maxLoopIterations(){return _macrosMaxLoopIterations},set maxLoopIterations(value){if(!Number.isSafeInteger(value)||value<1)throw new RangeError("Config.macros.maxLoopIterations must be a positive integer");_macrosMaxLoopIterations=value},get typeSkipKey(){return _macrosTypeSkipKey},set typeSkipKey(value){_macrosTypeSkipKey=String(value)},get typeVisitedPassages(){return _macrosTypeVisitedPassages},set typeVisitedPassages(value){_macrosTypeVisitedPassages=Boolean(value)},get ifAssignmentError(){throw new Error("[DEPRECATED] Config.macros.ifAssignmentError has been deprecated, see Config.enableOptionalDebugging instead")},set ifAssignmentError(value){console.warn("[DEPRECATED] Config.macros.ifAssignmentError has been deprecated, see Config.enableOptionalDebugging instead"),Config.enableOptionalDebugging=value}}),navigation:Object.freeze({get override(){return _navigationOverride},set override(value){if(!(null==value||value instanceof Function))throw new TypeError("Config.navigation.override must be a function or null/undefined (received: ".concat(getTypeOf(value),")"));_navigationOverride=value}}),passages:Object.freeze({get displayTitles(){return _passagesDisplayTitles},set displayTitles(value){_passagesDisplayTitles=Boolean(value)},get nobr(){return _passagesNobr},set nobr(value){_passagesNobr=Boolean(value)},get onProcess(){return _passagesOnProcess},set onProcess(value){if(null!=value){var valueType=getTypeOf(value);if("function"!==valueType)throw new TypeError("Config.passages.onProcess must be a function or null/undefined (received: ".concat(valueType,")"))}_passagesOnProcess=value},get start(){return _passagesStart},set start(value){if(null!=value){var valueType=getTypeOf(value);if("string"!==valueType)throw new TypeError("Config.passages.start must be a string or null/undefined (received: ".concat(valueType,")"))}_passagesStart=value},get transitionOut(){return _passagesTransitionOut},set transitionOut(value){if(null!=value){var valueType=getTypeOf(value);if("string"!==valueType&&("number"!==valueType||!Number.isSafeInteger(value)||value<0))throw new TypeError("Config.passages.transitionOut must be a string, non-negative integer, or null/undefined (received: ".concat(valueType,")"))}_passagesTransitionOut=value},get descriptions(){throw new Error(errPassagesDescriptionsDeprecated)},set descriptions(value){switch(console.warn(errPassagesDescriptionsDeprecated),_typeof(value)){case"boolean":value&&!Config.saves.descriptions&&(Config.saves.descriptions=function(){return State.passage});break;case"function":Config.saves.descriptions||(Config.saves.descriptions=value);break;case"undefined":case"object":if(value&&!Config.saves.descriptions){var dict=value;Config.saves.descriptions=function(){return Object.hasOwn(dict,State.passage)&&dict[State.passage]}}break;default:throw new TypeError("Config.passages.descriptions must be a boolean, object, function, or null/undefined (received: ".concat(getTypeOf(value),")"))}}}),saves:Object.freeze({get descriptions(){return _savesDescriptions},set descriptions(value){if(!(null==value||value instanceof Function))throw new TypeError("Config.saves.descriptions must be a function or null/undefined (received: ".concat(getTypeOf(value),")"));_savesDescriptions=value},get id(){return _savesId},set id(value){if("string"!=typeof value||""===value)throw new TypeError("Config.saves.id must be a non-empty string (received: ".concat(getTypeOf(value),")"));_savesId=value},get isAllowed(){return _savesIsAllowed},set isAllowed(value){if(!(null==value||value instanceof Function))throw new TypeError("Config.saves.isAllowed must be a function or null/undefined (received: ".concat(getTypeOf(value),")"));_savesIsAllowed=value},get maxAutoSaves(){return _savesMaxAuto},set maxAutoSaves(value){if(!Number.isInteger(value))throw new TypeError("Config.saves.maxAutoSaves must be an integer");if(value<0||value>Save.MAX_INDEX+1)throw new RangeError("Config.saves.maxAutoSaves out of bounds (range: 0–".concat(Save.MAX_INDEX+1,"; received: ").concat(value,")"));_savesMaxAuto=value},get maxSlotSaves(){return _savesMaxSlot},set maxSlotSaves(value){if(!Number.isInteger(value))throw new TypeError("Config.saves.maxSlotSaves must be an integer");if(value<0||value>Save.MAX_INDEX+1)throw new RangeError("Config.saves.maxSlotSaves out of bounds (range: 0–".concat(Save.MAX_INDEX+1,"; received: ").concat(value,")"));_savesMaxSlot=value},get metadata(){return _savesMetadata},set metadata(value){if(!(null==value||value instanceof Function))throw new TypeError("Config.saves.metadata must be a function or null/undefined (received: ".concat(getTypeOf(value),")"));_savesMetadata=value},get version(){return _savesVersion},set version(value){_savesVersion=value},get _internal_autoload_(){return _savesAutoload},get autoload(){return console.warn(errSavesAutoloadDeprecated),_savesAutoload},set autoload(value){if(console.warn(errSavesAutoloadDeprecated),null!=value){var valueType=getTypeOf(value);if("boolean"!==valueType&&("string"!==valueType||"prompt"!==value)&&"function"!==valueType)throw new TypeError("Config.saves.autoload must be a boolean, string ('prompt'), function, or null/undefined (received: ".concat(valueType,")"))}_savesAutoload=value},get autosave(){throw new Error("".concat(_baseSavesAutosaveDeprecated,", see Config.saves.maxAutoSaves and Config.saves.isAllowed instead"))},set autosave(value){switch(_typeof(value)){case"boolean":console.warn("".concat(_baseSavesAutosaveDeprecated,", for boolean usage see Config.saves.maxAutoSaves instead"));break;case"function":if(console.warn("".concat(_baseSavesAutosaveDeprecated,", for function usage see Config.saves.isAllowed instead")),!Config.saves.isAllowed){var callback=value;Config.saves.isAllowed=function(saveType){return saveType!==Save.Type.Auto||callback(saveType)}}break;default:if(console.warn("".concat(_baseSavesAutosaveDeprecated,", for tag usage see Config.saves.isAllowed instead")),!(value instanceof Array)||0===value.length||value.some((function(tag){return"string"!=typeof tag}))){var valueType=getTypeOf(value);throw new TypeError("Config.saves.autosave must be a boolean, Array<string>, function, or null/undefined (received: ".concat(valueType).concat("Array"===valueType?"<any>":"",")"))}if(!Config.saves.isAllowed){var userTags=value;Config.saves.isAllowed=function(saveType){return saveType!==Save.Type.Auto||userTags.includesAny(Story.get(State.passage).tags)}}}0===Config.saves.maxAutoSaves&&(Config.saves.maxAutoSaves=1)},get onLoad(){throw new Error(errSavesOnLoadDeprecated)},set onLoad(value){console.warn(errSavesOnLoadDeprecated),Save.onLoad.add(value)},get onSave(){throw new Error(errSavesOnSaveDeprecated)},set onSave(value){console.warn(errSavesOnSaveDeprecated),Save.onSave.add(value)},get slots(){throw new Error(errSavesSlotsDeprecated)},set slots(value){console.warn(errSavesSlotsDeprecated),Config.saves.maxSlotSaves=value},get tryDiskOnMobile(){return console.warn("[DEPRECATED] Config.saves.tryDiskOnMobile has been deprecated"),!0},set tryDiskOnMobile(value){console.warn("[DEPRECATED] Config.saves.tryDiskOnMobile has been deprecated")}}),ui:Object.freeze({get stowBarInitially(){return _uiStowBarInitially},set stowBarInitially(value){var valueType=getTypeOf(value);if("boolean"!==valueType&&("number"!==valueType||!Number.isSafeInteger(value)||value<0))throw new TypeError("Config.ui.stowBarInitially must be a boolean or non-negative integer (received: ".concat(valueType,")"));_uiStowBarInitially=value},get updateStoryElements(){return _uiUpdateStoryElements},set updateStoryElements(value){_uiUpdateStoryElements=Boolean(value)}})})),_navigationOverride,_passagesStart,_passagesOnProcess,_passagesTransitionOut,_savesDescriptions,_savesId,_savesIsAllowed,_savesMetadata,_savesVersion,_savesAutoload,_addVisitedLinkClass,_cleanupWikifierOutput,_debug,_enableOptionalDebugging,_loadDelay,_audioPauseOnFadeToZero,_audioPreloadMetadata,_historyControls,_historyMaxStates,_macrosMaxLoopIterations,_macrosTypeSkipKey,_macrosTypeVisitedPassages,_passagesDisplayTitles,_passagesNobr,_savesMaxAuto,_savesMaxSlot,_uiStowBarInitially,_uiUpdateStoryElements,errPassagesDescriptionsDeprecated,errSavesAutoloadDeprecated,_baseSavesAutosaveDeprecated,errSavesOnLoadDeprecated,errSavesOnSaveDeprecated,errSavesSlotsDeprecated,SimpleAudio=function(){var _hasPromise,_specialIds=Object.freeze([":not",":all",":looped",":muted",":paused",":playing",":stopped"]),_formatSpecRe=/^([\w-]+)\s*\|\s*(\S.*)$/,_badIdRe=/[:\s]/,_tracks=new Map,_groups=new Map,_lists=new Map,_subscribers=new Map,_masterRate=1,_masterVolume=1,_masterMute=!1,_masterMuteOnHidden=!1,_playReturnsPromise=(_hasPromise=null,function(){if(null!==_hasPromise)return _hasPromise;if(_hasPromise=!1,Has.audio)try{var audio=document.createElement("audio");audio.muted=!0;var value=audio.play();value.catch((function(){})),_hasPromise=value instanceof Promise}catch(ex){}return _hasPromise}),AudioTrack=function(){function AudioTrack(obj){if(_classCallCheck(this,AudioTrack),obj instanceof Array)this._create(obj);else{if(!(obj instanceof AudioTrack))throw new Error("sources parameter must be either an array, of URIs or source objects, or an AudioTrack instance");this._copy(obj)}}return _createClass(AudioTrack,[{key:"_create",value:function(sourceList){var dataUriRe=/^data:\s*audio\/(?:x-)?([^;,]+)\s*[;,]/i,extRe=/\.([^./\\]+)$/,formats=AudioTrack.formats,usedSources=[],audio=document.createElement("audio");audio.preload="none",sourceList.forEach((function(src){var srcUri=null;switch(_typeof(src)){case"string":var match;if("data:"===src.slice(0,5)){if(null===(match=dataUriRe.exec(src)))throw new Error("source data URI missing media type")}else if(null===(match=extRe.exec(parseURL(src).pathname)))throw new Error("source URL missing file extension");formats[match[1]]&&(srcUri=src);break;case"object":if(null===src)throw new Error("source object cannot be null");if(!Object.hasOwn(src,"src"))throw new Error('source object missing required "src" property');if(!Object.hasOwn(src,"format"))throw new Error('source object missing required "format" property');formats[src.format]&&(srcUri=src.src);break;default:throw new Error("invalid source value (type: ".concat(_typeof(src),")"))}if(null!==srcUri){var source=document.createElement("source");source.src=srcUri,audio.appendChild(source),usedSources.push(srcUri)}})),audio.hasChildNodes()&&Config.audio.preloadMetadata&&(audio.preload="metadata"),this._finalize(audio,usedSources,clone(sourceList))}},{key:"_copy",value:function(obj){this._finalize(obj.audio.cloneNode(!0),clone(obj.sources),clone(obj.originals))}},{key:"_finalize",value:function(audio,sources,originals){var _this=this;Object.defineProperties(this,{audio:{configurable:!0,value:audio},sources:{value:Object.freeze(sources)},originals:{value:Object.freeze(originals)},_error:{writable:!0,value:!1},_faderId:{writable:!0,value:null},_mute:{writable:!0,value:!1},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1}}),jQuery(this.audio).on("loadstart.AudioTrack",(function(){return _this._error=!1})).on("error.AudioTrack",(function(){return _this._error=!0})).find("source:last-of-type").on("error.AudioTrack",(function(){return _this._trigger("error")})),function(id,callback){if("function"!=typeof callback)throw new Error("callback parameter must be a function");_subscribers.set(id,callback)}(this,(function(mesg){if(_this.audio)switch(mesg){case"loadwithscreen":if(_this.hasSource()){var lockId=LoadScreen.lock();_this.off(".AudioTrack_loadwithscreen").one("canplaythrough.AudioTrack_loadwithscreen error.AudioTrack_loadwithscreen",(function(){jQuery(this).off(".AudioTrack_loadwithscreen"),LoadScreen.unlock(lockId)})).load()}break;case"load":_this.load();break;case"mute":_this._updateAudioMute();break;case"rate":_this._updateAudioRate();break;case"stop":_this.stop();break;case"volume":_this._updateAudioVolume();break;case"unload":_this.unload()}else unsubscribe(_this)})),this._updateAudioMute(),this._updateAudioRate(),this._updateAudioVolume()}},{key:"_trigger",value:function(eventName){triggerEvent(eventName,this.audio,{bubbles:!1})}},{key:"_destroy",value:function(){unsubscribe(this),this.audio&&(jQuery(this.audio).off(),this.unload(),this._error=!0,delete this.audio)}},{key:"clone",value:function(){return new AudioTrack(this)}},{key:"load",value:function(){var _this2=this;if(this.fadeStop(),this.audio.pause(),!this.audio.hasChildNodes()){if(0===this.sources.length)return;this.sources.forEach((function(srcUri){var source=document.createElement("source");source.src=srcUri,_this2.audio.appendChild(source)}))}"auto"!==this.audio.preload&&(this.audio.preload="auto"),this.isLoading()||this.audio.load()}},{key:"unload",value:function(){this.fadeStop(),this.stop();var audio=this.audio;for(audio.preload="none";audio.hasChildNodes();)audio.removeChild(audio.firstChild);audio.load()}},{key:"play",value:function(){var _this3=this;if(!this.hasSource())return Promise.reject(new Error("none of the candidate sources were acceptable"));if(this.isUnloaded())return Promise.reject(new Error("no sources are loaded"));if(this.isFailed())return Promise.reject(new Error("failed to load any of the sources"));"auto"!==this.audio.preload&&(this.audio.preload="auto");var namespace=".AudioTrack_play";return _playReturnsPromise()?this.audio.play():new Promise((function(resolve,reject){_this3.isPlaying()?resolve():(jQuery(_this3.audio).off(namespace).one("error".concat(namespace," playing").concat(namespace," timeupdate").concat(namespace),(function(ev){jQuery(_this3.audio).off(namespace),"error"===ev.type?reject(new Error("unknown audio play error")):resolve()})),_this3.audio.play())}))}},{key:"playWhenAllowed",value:function(){var _this4=this;return this.play().catch((function(ex){if("NotAllowedError"!==ex.name)throw ex;onUserActivation(".AudioTrack_playWhenAllowed",(function(){return _this4.audio.play()}))}))}},{key:"pause",value:function(){this.audio.pause()}},{key:"stop",value:function(){this.audio.pause(),this.time(0),this._trigger(":stopped")}},{key:"fade",value:function(duration,toVol,fromVol){var _this5=this;if("number"!=typeof duration)throw new TypeError("duration parameter must be a number");if("number"!=typeof toVol)throw new TypeError("toVolume parameter must be a number");if(null!=fromVol&&"number"!=typeof fromVol)throw new TypeError("fromVolume parameter must be a number");if(!this.hasSource())return Promise.reject(new Error("none of the candidate sources were acceptable"));if(this.isUnloaded())return Promise.reject(new Error("no sources are loaded"));if(this.isFailed())return Promise.reject(new Error("failed to load any of the sources"));this.fadeStop();var from=Math.clamp(null==fromVol?this.volume():fromVol,0,1),to=Math.clamp(toVol,0,1);return from!==to?(this.volume(from),jQuery(this.audio).off("timeupdate.AudioTrack_fade").one("timeupdate.AudioTrack_fade",(function(){var min,max;from<to?(min=from,max=to):(min=to,max=from);var time=Math.max(duration,1),delta=(to-from)/(time/.025);_this5._trigger(":fading"),_this5._faderId=setInterval((function(){_this5.isPlaying()?(_this5.volume(Math.clamp(_this5.volume()+delta,min,max)),Config.audio.pauseOnFadeToZero&&0===_this5.volume()&&_this5.pause(),_this5.volume()===to&&(_this5.fadeStop(),_this5._trigger(":faded"))):_this5.fadeStop()}),25)})),this.play()):void 0}},{key:"fadeIn",value:function(duration,fromVol){return this.fade(duration,1,fromVol)}},{key:"fadeOut",value:function(duration,fromVol){return this.fade(duration,0,fromVol)}},{key:"fadeStop",value:function(){null!==this._faderId&&(clearInterval(this._faderId),this._faderId=null)}},{key:"loop",value:function(_loop2){return null==_loop2?this.audio.loop:(this.audio.loop=!!_loop2,this)}},{key:"mute",value:function(_mute){return null==_mute?this._mute:(this._mute=!!_mute,this._updateAudioMute(),this)}},{key:"_updateAudioMute",value:function(){this.audio.muted=this._mute||_masterMute}},{key:"rate",value:function(_rate){if(null==_rate)return this._rate;if("number"!=typeof _rate)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(_rate,.2,5),this._updateAudioRate(),this}},{key:"_updateAudioRate",value:function(){this.audio.playbackRate=Math.clamp(this._rate*_masterRate,.2,5)}},{key:"time",value:function(_time){var _this6=this;if(null==_time)return this.audio.currentTime;if("number"!=typeof _time)throw new TypeError("time parameter must be a number");return this.hasMetadata()?this.audio.currentTime=_time:jQuery(this.audio).off("loadedmetadata.AudioTrack_time").one("loadedmetadata.AudioTrack_time",(function(){return _this6.audio.currentTime=_time})),this}},{key:"volume",value:function(_volume){if(null==_volume)return this._volume;if("number"!=typeof _volume)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(_volume,0,1),this._updateAudioVolume(),this}},{key:"_updateAudioVolume",value:function(){this.audio.volume=Math.clamp(this._volume*_masterVolume,0,1)}},{key:"duration",value:function(){return this.audio.duration}},{key:"remaining",value:function(){return this.audio.duration-this.audio.currentTime}},{key:"isFailed",value:function(){return this._error}},{key:"isLoading",value:function(){return this.audio.networkState===HTMLMediaElement.NETWORK_LOADING}},{key:"isUnloaded",value:function(){return!this.audio.hasChildNodes()}},{key:"isUnavailable",value:function(){return!this.hasSource()||this.isUnloaded()||this.isFailed()}},{key:"isPlaying",value:function(){return!this.audio.paused&&this.hasSomeData()}},{key:"isPaused",value:function(){return this.audio.paused&&(this.audio.duration===1/0||this.audio.currentTime>0)&&!this.audio.ended}},{key:"isStopped",value:function(){return this.audio.paused&&0===this.audio.currentTime}},{key:"isEnded",value:function(){return this.audio.ended}},{key:"isFading",value:function(){return null!==this._faderId}},{key:"isSeeking",value:function(){return this.audio.seeking}},{key:"hasSource",value:function(){return this.sources.length>0}},{key:"hasNoData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_NOTHING}},{key:"hasMetadata",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_METADATA}},{key:"hasSomeData",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA}},{key:"hasData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_ENOUGH_DATA}},{key:"on",value:function(){for(var _len5=arguments.length,args=new Array(_len5),_key5=0;_key5<_len5;_key5++)args[_key5]=arguments[_key5];return jQuery.fn.on.apply(jQuery(this.audio),args),this}},{key:"one",value:function(){for(var _len6=arguments.length,args=new Array(_len6),_key6=0;_key6<_len6;_key6++)args[_key6]=arguments[_key6];return jQuery.fn.one.apply(jQuery(this.audio),args),this}},{key:"off",value:function(){for(var _len7=arguments.length,args=new Array(_len7),_key7=0;_key7<_len7;_key7++)args[_key7]=arguments[_key7];return jQuery.fn.off.apply(jQuery(this.audio),args),this}}])}();Object.defineProperties(AudioTrack,{formats:{value:function(){var audio=document.createElement("audio"),types=new Map;function canPlay(mimeType){return types.has(mimeType)||types.set(mimeType,""!==audio.canPlayType(mimeType).replace(/^no$/i,"")),types.get(mimeType)}return Object.assign(Object.create(null),{aac:canPlay("audio/aac"),caf:canPlay("audio/x-caf")||canPlay("audio/caf"),flac:canPlay("audio/x-flac")||canPlay("audio/flac"),mp3:canPlay('audio/mpeg; codecs="mp3"')||canPlay("audio/mpeg")||canPlay("audio/mp3")||canPlay("audio/mpa"),mpeg:canPlay("audio/mpeg"),m4a:canPlay("audio/x-m4a")||canPlay("audio/m4a")||canPlay("audio/aac"),mp4:canPlay("audio/x-mp4")||canPlay("audio/mp4")||canPlay("audio/aac"),ogg:canPlay("audio/ogg"),oga:canPlay("audio/ogg"),opus:canPlay('audio/ogg; codecs="opus"')||canPlay("audio/opus"),wav:canPlay('audio/wave; codecs="1"')||canPlay('audio/wav; codecs="1"')||canPlay("audio/wave")||canPlay("audio/wav"),wave:canPlay('audio/wave; codecs="1"')||canPlay('audio/wav; codecs="1"')||canPlay("audio/wave")||canPlay("audio/wav"),weba:canPlay("audio/webm"),webm:canPlay("audio/webm")})}()}});var AudioList=function(){return _createClass((function AudioList(obj){if(_classCallCheck(this,AudioList),obj instanceof Array)this._create(obj);else{if(!(obj instanceof AudioList))throw new Error("tracks parameter must be either an array, of track objects, or an AudioTrack instance");this._copy(obj)}}),[{key:"_create",value:function(trackList){var _this7=this;this._finalize(trackList.map((function(trackObj){if("object"!==_typeof(trackObj))throw new Error("tracks parameter array members must be objects");var own,rate,track,volume;if(trackObj instanceof AudioTrack)own=!0,rate=trackObj.rate(),track=trackObj.clone(),volume=trackObj.volume();else{if(!Object.hasOwn(trackObj,"track"))throw new Error('track object missing required "track" property');if(!(trackObj.track instanceof AudioTrack))throw new Error('track object\'s "track" property must be an AudioTrack object');own=Object.hasOwn(trackObj,"own")&&trackObj.own,rate=Object.hasOwn(trackObj,"rate")?trackObj.rate:trackObj.track.rate(),track=trackObj.track,volume=Object.hasOwn(trackObj,"volume")?trackObj.volume:trackObj.track.volume()}return track.stop(),track.loop(!1),track.mute(!1),track.rate(rate),track.volume(volume),track.on("ended.AudioList",(function(){return _this7._onEnd()})),{own:own,track:track,volume:volume,rate:rate}})))}},{key:"_copy",value:function(obj){this._finalize(clone(obj.tracks))}},{key:"_finalize",value:function(tracks){Object.defineProperties(this,{tracks:{configurable:!0,value:Object.freeze(tracks)},queue:{configurable:!0,value:[]},current:{writable:!0,value:null},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1},_mute:{writable:!0,value:!1},_loop:{writable:!0,value:!1},_shuffle:{writable:!0,value:!1}})}},{key:"_destroy",value:function(){this.stop(),this.tracks.filter((function(trackObj){return trackObj.own})).forEach((function(trackObj){return trackObj.track._destroy()})),delete this.tracks,delete this.queue}},{key:"load",value:function(){this.tracks.forEach((function(trackObj){return trackObj.track.load()}))}},{key:"unload",value:function(){this.stop(),this.tracks.forEach((function(trackObj){return trackObj.track.unload()}))}},{key:"play",value:function(){return null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||(0===this.queue.length&&this._fillQueue(),this._next())?this.current.track.play():Promise.reject(new Error("no tracks were available"))}},{key:"playWhenAllowed",value:function(){var _this8=this;return this.play().catch((function(ex){if("NotAllowedError"!==ex.name)throw ex;onUserActivation(".AudioList_playWhenAllowed",(function(){return _this8.play()}))}))}},{key:"pause",value:function(){null!==this.current&&this.current.track.pause()}},{key:"stop",value:function(){null!==this.current&&(this.current.track.stop(),this.current=null),this._drainQueue()}},{key:"skip",value:function(){this._next()?this.current.track.play():this._loop&&this.play()}},{key:"fade",value:function(duration,toVol,fromVol){if("number"!=typeof duration)throw new TypeError("duration parameter must be a number");if("number"!=typeof toVol)throw new TypeError("toVolume parameter must be a number");if(null!=fromVol&&"number"!=typeof fromVol)throw new TypeError("fromVolume parameter must be a number");if(0===this.queue.length&&this._fillQueue(),null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||this._next()){var adjFromVol,adjToVol=Math.clamp(toVol,0,1)*this.current.volume;return null!=fromVol&&(adjFromVol=Math.clamp(fromVol,0,1)*this.current.volume),this._volume=toVol,this.current.track.fade(duration,adjToVol,adjFromVol)}}},{key:"fadeIn",value:function(duration,fromVol){return this.fade(duration,1,fromVol)}},{key:"fadeOut",value:function(duration,fromVol){return this.fade(duration,0,fromVol)}},{key:"fadeStop",value:function(){null!==this.current&&this.current.track.fadeStop()}},{key:"loop",value:function(_loop3){return null==_loop3?this._loop:(this._loop=!!_loop3,this)}},{key:"mute",value:function(_mute2){return null==_mute2?this._mute:(this._mute=!!_mute2,null!==this.current&&this.current.track.mute(this._mute),this)}},{key:"rate",value:function(_rate2){if(null==_rate2)return this._rate;if("number"!=typeof _rate2)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(_rate2,.2,5),null!==this.current&&this.current.track.rate(this._rate*this.current.rate),this}},{key:"shuffle",value:function(_shuffle){var _this9=this;if(null==_shuffle)return this._shuffle;if(this._shuffle=!!_shuffle,this.queue.length>0&&(this._fillQueue(),!this._shuffle&&null!==this.current&&this.queue.length>1)){var _this$queue,firstIndex=this.queue.findIndex((function(trackObj){return trackObj===_this9.current}));if(-1!==firstIndex)(_this$queue=this.queue).push.apply(_this$queue,_toConsumableArray(this.queue.splice(0,firstIndex+1)))}return this}},{key:"volume",value:function(_volume2){if(null==_volume2)return this._volume;if("number"!=typeof _volume2)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(_volume2,0,1),null!==this.current&&this.current.track.volume(this._volume*this.current.volume),this}},{key:"duration",value:function(){if(arguments.length>0)throw new Error("duration takes no parameters");return this.tracks.map((function(trackObj){return trackObj.track.duration()})).reduce((function(prev,cur){return prev+cur}),0)}},{key:"remaining",value:function(){if(arguments.length>0)throw new Error("remaining takes no parameters");var remainingTime=this.queue.map((function(trackObj){return trackObj.track.duration()})).reduce((function(prev,cur){return prev+cur}),0);return null!==this.current&&(remainingTime+=this.current.track.remaining()),remainingTime}},{key:"time",value:function(){if(arguments.length>0)throw new Error("time takes no parameters");return this.duration()-this.remaining()}},{key:"isPlaying",value:function(){return null!==this.current&&this.current.track.isPlaying()}},{key:"isPaused",value:function(){return null===this.current||this.current.track.isPaused()}},{key:"isStopped",value:function(){return 0===this.queue.length&&null===this.current}},{key:"isEnded",value:function(){return 0===this.queue.length&&(null===this.current||this.current.track.isEnded())}},{key:"isFading",value:function(){return null!==this.current&&this.current.track.isFading()}},{key:"_next",value:function(){var nextTrack;for(null!==this.current&&(this.current.track.stop(),this.current=null);nextTrack=this.queue.shift();)if(!nextTrack.track.isUnavailable()){this.current=nextTrack;break}return null!==this.current&&(this.current.track.mute(this._mute),this.current.track.rate(this._rate*this.current.rate),this.current.track.volume(this._volume*this.current.volume),this.current.track.loop(!1),!0)}},{key:"_onEnd",value:function(){if(0===this.queue.length){if(!this._loop)return;this._fillQueue()}this._next()&&this.current.track.play()}},{key:"_drainQueue",value:function(){this.queue.splice(0)}},{key:"_fillQueue",value:function(){var _this$queue2;this._drainQueue(),(_this$queue2=this.queue).push.apply(_this$queue2,_toConsumableArray(this.tracks.filter((function(trackObj){return!trackObj.track.isUnavailable()})))),0!==this.queue.length&&this._shuffle&&(this.queue.shuffle(),this.queue.length>1&&this.queue[0]===this.current&&this.queue.push(this.queue.shift()))}}])}(),AudioRunner=function(){function AudioRunner(list){if(_classCallCheck(this,AudioRunner),!(list instanceof Set||list instanceof AudioRunner))throw new TypeError("list parameter must be a Set or a AudioRunner instance");Object.defineProperties(this,{trackIds:{value:new Set(list instanceof AudioRunner?list.trackIds:list)}})}return _createClass(AudioRunner,[{key:"load",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.load)}},{key:"unload",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.unload)}},{key:"play",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.play)}},{key:"playWhenAllowed",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.playWhenAllowed)}},{key:"pause",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.pause)}},{key:"stop",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.stop)}},{key:"fade",value:function(duration,toVol,fromVol){if(null==duration||null==toVol)throw new Error("fade requires parameters");AudioRunner._run(this.trackIds,AudioTrack.prototype.fade,duration,toVol,fromVol)}},{key:"fadeIn",value:function(duration,fromVol){if(null==duration)throw new Error("fadeIn requires a parameter");AudioRunner._run(this.trackIds,AudioTrack.prototype.fadeIn,duration,fromVol)}},{key:"fadeOut",value:function(duration,fromVol){if(null==duration)throw new Error("fadeOut requires a parameter");AudioRunner._run(this.trackIds,AudioTrack.prototype.fadeOut,duration,fromVol)}},{key:"fadeStop",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.fadeStop)}},{key:"loop",value:function(_loop4){if(null==_loop4)throw new Error("loop requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.loop,_loop4),this}},{key:"mute",value:function(_mute3){if(null==_mute3)throw new Error("mute requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.mute,_mute3),this}},{key:"rate",value:function(_rate3){if(null==_rate3)throw new Error("rate requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.rate,_rate3),this}},{key:"time",value:function(_time2){if(null==_time2)throw new Error("time requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.time,_time2),this}},{key:"volume",value:function(_volume3){if(null==_volume3)throw new Error("volume requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.volume,_volume3),this}},{key:"on",value:function(){for(var _len8=arguments.length,args=new Array(_len8),_key8=0;_key8<_len8;_key8++)args[_key8]=arguments[_key8];return AudioRunner._run.apply(AudioRunner,[this.trackIds,AudioTrack.prototype.on].concat(args)),this}},{key:"one",value:function(){for(var _len9=arguments.length,args=new Array(_len9),_key9=0;_key9<_len9;_key9++)args[_key9]=arguments[_key9];return AudioRunner._run.apply(AudioRunner,[this.trackIds,AudioTrack.prototype.one].concat(args)),this}},{key:"off",value:function(){for(var _len10=arguments.length,args=new Array(_len10),_key10=0;_key10<_len10;_key10++)args[_key10]=arguments[_key10];return AudioRunner._run.apply(AudioRunner,[this.trackIds,AudioTrack.prototype.off].concat(args)),this}}],[{key:"_run",value:function(ids,fn){for(var _len11=arguments.length,args=new Array(_len11>2?_len11-2:0),_key11=2;_key11<_len11;_key11++)args[_key11-2]=arguments[_key11];ids.forEach((function(id){var track=_tracks.get(id);track&&fn.apply(track,args)}))}}])}();var _runnerParseSelector=function(){var notWsRe=/\S/g,parenRe=/[()]/g;function processNegation(str,startPos){var match;if(notWsRe.lastIndex=startPos,null===(match=notWsRe.exec(str))||"("!==match[0])throw new Error('invalid ":not()" syntax: missing parenthesis');parenRe.lastIndex=notWsRe.lastIndex;for(var start=notWsRe.lastIndex,result={str:"",nextMatch:-1},depth=1;null!==(match=parenRe.exec(str));)if("("===match[0]?++depth:--depth,depth<1){result.nextMatch=parenRe.lastIndex,result.str=str.slice(start,result.nextMatch-1);break}return result}return function parseSelector(idArg){for(var match,ids=[],idRe=/:?[^\s:()]+/g;null!==(match=idRe.exec(idArg));){var id=match[0];if(":not"===id){if(0===ids.length)throw new Error('invalid negation: no group ID preceded ":not()"');var parent=ids[ids.length-1];if(!parent.id.startsWith(":"))throw new Error('invalid negation of track "'.concat(parent.id,'": only groups may be negated with ":not()"'));var negation=processNegation(idArg,idRe.lastIndex);if(-1===negation.nextMatch)throw new Error('unknown error parsing ":not()"');idRe.lastIndex=negation.nextMatch,parent.not=parseSelector(negation.str)}else ids.push({id:id})}return ids}}();function masterMute(mute){if(null==mute)return _masterMute;publish("mute",_masterMute=!!mute)}function unsubscribe(id){_subscribers.delete(id)}function publish(mesg,data){_subscribers.forEach((function(fn){return fn(mesg,data)}))}function _newTrack(sources){return new AudioTrack(sources.map((function(source){if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);if(passage.tags.includes("Twine.audio"))return passage.text.trim()}var match=_formatSpecRe.exec(source);return null===match?source:{format:match[1],src:match[2]}})))}return Object.preventExtensions(Object.create(null,{tracks:{value:Object.preventExtensions(Object.create(null,{add:{value:function(){if(arguments.length<2){var errors=[];throw arguments.length<1&&errors.push("track ID"),arguments.length<2&&errors.push("sources"),new Error("no ".concat(errors.join(" or ")," specified"))}var id=String(arguments[0]).trim(),what='track ID "'.concat(id,'"');if(_badIdRe.test(id))throw new Error("invalid ".concat(what,": track IDs must not contain colons or whitespace"));var track,sources=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1);try{track=_newTrack(sources)}catch(ex){throw new Error("".concat(what,": error during track initialization: ").concat(ex.message))}if(Config.debug&&!track.hasSource())throw new Error("".concat(what,": no supported audio sources found"));_tracks.has(id)&&_tracks.get(id)._destroy(),_tracks.set(id,track)}},delete:{value:function(id){return _tracks.has(id)&&_tracks.get(id)._destroy(),_tracks.delete(id)}},clear:{value:function(){_tracks.forEach((function(track){return track._destroy()})),_tracks.clear()}},has:{value:function(id){return _tracks.has(id)}},get:{value:function(id){return _tracks.get(id)||null}}}))},groups:{value:Object.preventExtensions(Object.create(null,{add:{value:function(){if(arguments.length<2){var errors=[];throw arguments.length<1&&errors.push("group ID"),arguments.length<2&&errors.push("track IDs"),new Error("no ".concat(errors.join(" or ")," specified"))}var id=String(arguments[0]).trim(),what='group ID "'.concat(id,'"');if(!id.startsWith(":")||_badIdRe.test(id.slice(1)))throw new Error("invalid ".concat(what,": group IDs must start with a colon and must not contain colons or whitespace"));if(_specialIds.includes(id))throw new Error("cannot clobber special ".concat(what));var group,trackIds=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1);try{group=new Set(trackIds.map((function(trackId){if(!_tracks.has(trackId))throw new Error('track "'.concat(trackId,'" does not exist'));return trackId})))}catch(ex){throw new Error("".concat(what,": error during group initialization: ").concat(ex.message))}_groups.set(id,Object.freeze(Array.from(group)))}},delete:{value:function(id){return _groups.delete(id)}},clear:{value:function(){_groups.clear()}},has:{value:function(id){return _groups.has(id)}},get:{value:function(id){return _groups.get(id)||null}}}))},lists:{value:Object.preventExtensions(Object.create(null,{add:{value:function(){if(arguments.length<2){var errors=[];throw arguments.length<1&&errors.push("list ID"),arguments.length<2&&errors.push("track IDs"),new Error("no ".concat(errors.join(" or ")," specified"))}var id=String(arguments[0]).trim(),what='list ID "'.concat(id,'"');if(_badIdRe.test(id))return this.error("invalid ".concat(what,": list IDs must not contain colons or whitespace"));var list,descriptors=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1);try{list=new AudioList(descriptors.map((function(desc){if(null===desc)throw new Error("track descriptor must be a string or object (type: null)");switch(_typeof(desc)){case"string":desc={id:desc};break;case"object":if(!Object.hasOwn(desc,"id")&&!Object.hasOwn(desc,"sources"))throw new Error('track descriptor must contain one of either an "id" or a "sources" property');if(Object.hasOwn(desc,"id")&&Object.hasOwn(desc,"sources"))throw new Error('track descriptor must contain either an "id" or a "sources" property, not both');break;default:throw new Error("track descriptor must be a string or object (type: ".concat(_typeof(desc),")"))}var own,track,volume;if(Object.hasOwn(desc,"id")){if("string"!=typeof desc.id)throw new Error('"id" property must be a string');if(!_tracks.has(desc.id))throw new Error('track "'.concat(desc.id,'" does not exist'));track=_tracks.get(desc.id)}else if(Object.hasOwn(desc,"sources")){if(!Array.isArray(desc.sources)||0===desc.sources.length)throw new Error('"sources" property must be a non-empty array');if(Object.hasOwn(desc,"own"))throw new Error('"own" property is not allowed with the "sources" property');try{track=_newTrack(desc.sources),own=!0}catch(ex){throw new Error("error during track initialization: ".concat(ex.message))}if(Config.debug&&!track.hasSource())throw new Error("no supported audio sources found")}if(Object.hasOwn(desc,"own")){if("boolean"!=typeof desc.own)throw new Error('"own" property must be a boolean');(own=desc.own)&&(track=track.clone())}if(Object.hasOwn(desc,"volume")){if("number"!=typeof desc.volume||Number.isNaN(desc.volume)||!Number.isFinite(desc.volume)||desc.volume<0)throw new Error('"volume" property must be a non-negative finite number');volume=desc.volume}return{own:null!=own&&own,track:track,volume:null!=volume?volume:track.volume()}})))}catch(ex){throw new Error("".concat(what,": error during playlist initialization: ").concat(ex.message))}_lists.has(id)&&_lists.get(id)._destroy(),_lists.set(id,list)}},delete:{value:function(id){return _lists.has(id)&&_lists.get(id)._destroy(),_lists.delete(id)}},clear:{value:function(){_lists.forEach((function(list){return list._destroy()})),_lists.clear()}},has:{value:function(id){return _lists.has(id)}},get:{value:function(id){return _lists.get(id)||null}}}))},select:{value:function(){if(0===arguments.length)throw new Error("no track selector specified");var selector=String(arguments[0]).trim(),trackIds=new Set;try{var renderIds=function renderIds(idObj){var ids,id=idObj.id;switch(id){case":all":ids=allIds;break;case":looped":ids=allIds.filter((function(id){return _tracks.get(id).loop()}));break;case":muted":ids=allIds.filter((function(id){return _tracks.get(id).mute()}));break;case":paused":ids=allIds.filter((function(id){return _tracks.get(id).isPaused()}));break;case":playing":ids=allIds.filter((function(id){return _tracks.get(id).isPlaying()}));break;case":stopped":ids=allIds.filter((function(id){return _tracks.get(id).isStopped()}));break;default:if(id.startsWith(":")){var group=_groups.get(id);if(!group)throw new Error('group "'.concat(id,'" does not exist'));ids=group}else ids=[id]}if(Object.hasOwn(idObj,"not")){var negated=idObj.not.map((function(idObj){return renderIds(idObj)})).flat(1/0);ids=ids.filter((function(id){return!negated.includes(id)}))}return ids},allIds=Array.from(_tracks.keys());_runnerParseSelector(selector).forEach((function(idObj){return renderIds(idObj).forEach((function(id){if(!_tracks.has(id))throw new Error('track "'.concat(id,'" does not exist'));trackIds.add(id)}))}))}catch(ex){throw new Error("error during runner initialization: ".concat(ex.message))}return new AudioRunner(trackIds)}},load:{value:function(){publish("load")}},loadWithScreen:{value:function(){publish("loadwithscreen")}},mute:{value:masterMute},muteOnHidden:{value:function(mute){if(!Visibility.isEnabled())return!1;if(null==mute)return _masterMuteOnHidden;var namespace=".SimpleAudio_masterMuteOnHidden";if(_masterMuteOnHidden=!!mute){var visibilityChange="".concat(Visibility.changeEvent).concat(namespace);jQuery(document).off(namespace).on(visibilityChange,(function(){return masterMute(Visibility.isHidden())})),Visibility.isHidden()&&masterMute(!0)}else jQuery(document).off(namespace)}},rate:{value:function(rate){if(null==rate)return _masterRate;if("number"!=typeof rate||Number.isNaN(rate)||!Number.isFinite(rate))throw new Error("rate must be a finite number");publish("rate",_masterRate=Math.clamp(rate,.2,5))}},stop:{value:function(){publish("stop")}},unload:{value:function(){publish("unload")}},volume:{value:function(volume){if(null==volume)return _masterVolume;if("number"!=typeof volume||Number.isNaN(volume)||!Number.isFinite(volume))throw new Error("volume must be a finite number");publish("volume",_masterVolume=Math.clamp(volume,0,1))}}}))}(),State=function(){var _history=[],_active=momentCreate(),_activeIndex=-1,_expired=[],_prng=null,_temporary=Object.create(null);function stateMarshal(noDelta){var state={index:_activeIndex};return noDelta?state.history=clone(_history):state.delta=historyDeltaEncode(_history),_expired.length>0&&(state.expired=Array.from(_expired)),null!==_prng&&(state.seed=_prng.seed),state}function stateUnmarshal(state,noDelta){if(null==state)throw new Error("state object is null or undefined");if(!Object.hasOwn(state,noDelta?"history":"delta")||0===state[noDelta?"history":"delta"].length)throw new Error("state object has no history or history is empty");if(!Object.hasOwn(state,"index"))throw new Error("state object has no index");if(null!==_prng&&!Object.hasOwn(state,"seed"))throw new Error("state object has no seed, but PRNG is enabled");if(null===_prng&&Object.hasOwn(state,"seed"))throw new Error("state object has seed, but PRNG is disabled");_history=noDelta?clone(state.history):historyDeltaDecode(state.delta),_activeIndex=state.index,_expired=Object.hasOwn(state,"expired")?Array.from(state.expired):[],Object.hasOwn(state,"seed")&&(_prng.seed=state.seed),momentActivate(_activeIndex)}function momentCreate(title,variables){return{title:null==title?"":String(title),variables:null==variables?{}:clone(variables)}}function momentActivate(moment){if(null==moment)throw new Error("moment activation attempted with null or undefined");switch(_typeof(moment)){case"object":_active=clone(moment);break;case"number":if(historyIsEmpty())throw new Error("moment activation attempted with index on empty history");if(moment<0||moment>=historySize())throw new RangeError("moment activation attempted with out-of-bounds index; need [0, ".concat(historySize()-1,"], got ").concat(moment));_active=clone(_history[moment]);break;default:throw new TypeError('moment activation attempted with a "'.concat(_typeof(moment),'"; must be an object or valid history stack index'))}return null!==_prng&&(_prng=function(state){for(var prng=prngCreate(state.seed),i=state.pull;i>0;--i)prng.random();return prng}({seed:_prng.seed,pull:_active.pull})),session.set("state",stateMarshal()),triggerEvent(":historyupdate"),_active}function historyLength(){return _activeIndex+1}function historySize(){return _history.length}function historyIsEmpty(){return 0===_history.length}function historyTop(){return _history.length>0?_history[_history.length-1]:null}function historyGoTo(index){return!(null==index||index<0||index>=historySize()||index===_activeIndex)&&(momentActivate(_activeIndex=index),!0)}function historyDeltaEncode(historyArr){if(!Array.isArray(historyArr))return null;if(0===historyArr.length)return[];for(var delta=[historyArr[0]],i=1,iend=historyArr.length;i<iend;++i)delta.push(Diff.diff(historyArr[i-1],historyArr[i]));return delta}function historyDeltaDecode(delta){if(!Array.isArray(delta))return null;if(0===delta.length)return[];for(var historyArr=[clone(delta[0])],i=1,iend=delta.length;i<iend;++i)historyArr.push(Diff.patch(historyArr[i-1],delta[i]));return historyArr}function prngCreate(seedBase,mixEntropy){return new Math.seedrandom(seedBase,{entropy:Boolean(mixEntropy),pass:function(prng,seed){return Object.create(null,{prng:{value:prng},seed:{writable:!0,value:seed},pull:{writable:!0,value:0},random:{value:function(){return++this.pull,this.prng()}}})}})}function tempVariablesClear(){_temporary=Object.create(null)}var _METADATA_STORE="metadata";function metadataDelete(key){if("string"!=typeof key)throw new TypeError("State.metadata.delete key parameter must be a string (received: ".concat(_typeof(key),")"));var store=storage.get(_METADATA_STORE);store&&Object.hasOwn(store,key)&&(1===Object.keys(store).length?storage.delete(_METADATA_STORE):(delete store[key],storage.set(_METADATA_STORE,store)))}return Object.preventExtensions(Object.create(null,{reset:{value:function(){session.delete("state"),_history=[],_active=momentCreate(),_activeIndex=-1,_expired=[],_prng=null===_prng?null:prngCreate(_prng.seed),tempVariablesClear()}},restore:{value:function(){var state=session.get("state");return null!=state&&(stateUnmarshal(state),!0)}},marshalForSave:{value:function(){return stateMarshal(!0)}},unmarshalForSave:{value:function(state){return stateUnmarshal(state,!0)}},expired:{get:function(){return _expired}},turns:{get:function(){return _expired.length+historyLength()}},passages:{get:function(){return _expired.concat(_history.slice(0,historyLength()).map((function(moment){return moment.title})))}},hasPlayed:{value:function(title){return null!=title&&""!==title&&(!!_expired.includes(title)||!!_history.slice(0,historyLength()).some((function(moment){return moment.title===title})))}},active:{get:function(){return _active}},activeIndex:{get:function(){return _activeIndex}},passage:{get:function(){return _active.title}},variables:{get:function(){return _active.variables}},history:{get:function(){return _history}},length:{get:historyLength},size:{get:historySize},isEmpty:{value:historyIsEmpty},current:{get:function(){return _history.length>0?_history[_activeIndex]:null}},top:{get:historyTop},bottom:{get:function(){return _history.length>0?_history[0]:null}},index:{value:function(index){return historyIsEmpty()||index<0||index>_activeIndex?null:_history[index]}},peek:{value:function(offset){if(historyIsEmpty())return null;var lengthOffset=1+(offset?Math.abs(offset):0);return lengthOffset>historyLength()?null:_history[historyLength()-lengthOffset]}},has:{value:function(title){if(historyIsEmpty()||null==title||""===title)return!1;for(var i=_activeIndex;i>=0;--i)if(_history[i].title===title)return!0;return!1}},create:{value:function(title){for(0,historyLength()<historySize()&&_history.splice(historyLength(),historySize()-historyLength()),_history.push(momentCreate(title,_active.variables)),_prng&&(historyTop().pull=_prng.pull);historySize()>Config.history.maxStates;)_expired.push(_history.shift().title);return momentActivate(_activeIndex=historySize()-1),historyLength()}},goTo:{value:historyGoTo},go:{value:function(offset){return null!=offset&&0!==offset&&historyGoTo(_activeIndex+offset)}},deltaEncode:{value:historyDeltaEncode},deltaDecode:{value:historyDeltaDecode},prng:{value:Object.preventExtensions(Object.create(null,{init:{value:function(seedBase,mixEntropy){var what;if(!historyIsEmpty())throw what="the story JavaScript section",new Error("State.prng.init must be called during initialization, within either ".concat(what," or the StoryInit special passage"));_prng=prngCreate(seedBase,Boolean(mixEntropy)),_active.pull=_prng.pull}},isEnabled:{value:function(){return null!==_prng}},pull:{get:function(){return null!==_prng?_prng.pull:NaN}},seed:{get:function(){return null!==_prng?_prng.seed:null}}}))},random:{value:function(){return null!==_prng?_prng.random():Math.random()}},clearTemporary:{value:tempVariablesClear},temporary:{get:function(){return _temporary}},getVar:{value:function(varExpression){try{return Scripting.evalTwineScript(varExpression)}catch(ex){}}},setVar:{value:function(varExpression,value){try{return Scripting.evalTwineScript("".concat(varExpression," = SCRIPT$DATA$"),null,value),!0}catch(ex){}return!1}},metadata:{value:Object.preventExtensions(Object.create(null,{clear:{value:function(){storage.delete(_METADATA_STORE)}},delete:{value:metadataDelete},entries:{value:function(){var store=storage.get(_METADATA_STORE);return store&&Object.entries(store)}},get:{value:function(key){if("string"!=typeof key)throw new TypeError("State.metadata.get key parameter must be a string (received: ".concat(_typeof(key),")"));var store=storage.get(_METADATA_STORE);return store&&Object.hasOwn(store,key)?store[key]:undefined}},has:{value:function(key){if("string"!=typeof key)throw new TypeError("State.metadata.has key parameter must be a string (received: ".concat(_typeof(key),")"));var store=storage.get(_METADATA_STORE);return store&&Object.hasOwn(store,key)}},keys:{value:function(){var store=storage.get(_METADATA_STORE);return store&&Object.keys(store)}},set:{value:function(key,value){if("string"!=typeof key)throw new TypeError("State.metadata.set key parameter must be a string (received: ".concat(_typeof(key),")"));if(void 0===value)metadataDelete(key);else{var store=storage.get(_METADATA_STORE)||{};store[key]=value,storage.set(_METADATA_STORE,store)}}},size:{get:function(){var store=storage.get(_METADATA_STORE);return store?Object.keys(store).length:0}}}))}}))}(),Scripting=function(){function toStringOrDefault(value){return console.warn("[DEPRECATED] toStringOrDefault() is deprecated."),stringFrom(value)}function either(){if(0!==arguments.length)return Array.prototype.concat.apply([],arguments).random()}function forget(key){if("string"!=typeof key)throw new TypeError("forget key parameter must be a string (received: ".concat(getTypeOf(key),")"));State.metadata.delete(key)}function hasVisited(){if(0===arguments.length)throw new Error("hasVisited called with insufficient parameters");if(State.isEmpty())return!1;for(var needles=Array.prototype.concat.apply([],arguments),played=State.passages,i=0;i<needles.length;++i)if(!played.includes(needles[i]))return!1;return!0}function lastVisited(){if(0===arguments.length)throw new Error("lastVisited called with insufficient parameters");if(State.isEmpty())return-1;for(var needles=Array.prototype.concat.apply([],arguments),played=State.passages,uBound=played.length-1,turns=State.turns,i=0;i<needles.length&&turns>-1;++i){var lastIndex=played.lastIndexOf(needles[i]);turns=Math.min(turns,-1===lastIndex?-1:uBound-lastIndex)}return turns}function memorize(key,value){if("string"!=typeof key)throw new TypeError("memorize key parameter must be a string (received: ".concat(getTypeOf(key),")"));State.metadata.set(key,value)}function passage(){return State.passage}function previous(){var passages=State.passages;if(arguments.length>0){var offset=Number(arguments[0]);if(!Number.isSafeInteger(offset)||offset<1)throw new RangeError("previous offset parameter must be a positive integer greater than zero");return passages.length>offset?passages[passages.length-1-offset]:""}for(var i=passages.length-2;i>=0;--i)if(passages[i]!==State.passage)return passages[i];return""}function random(){var min,max;switch(arguments.length){case 0:throw new Error("random called with insufficient parameters");case 1:min=0,max=Math.trunc(arguments[0]);break;default:min=Math.trunc(arguments[0]),max=Math.trunc(arguments[1])}if(!Number.isInteger(min))throw new TypeError("random min parameter must be an integer");if(!Number.isInteger(max))throw new TypeError("random max parameter must be an integer");if(min>max){var _ref7=[max,min];min=_ref7[0],max=_ref7[1]}return Math.floor(State.random()*(max-min+1))+min}function randomFloat(){var min,max;switch(arguments.length){case 0:throw new Error("randomFloat called with insufficient parameters");case 1:min=0,max=Number(arguments[0]);break;default:min=Number(arguments[0]),max=Number(arguments[1])}if(Number.isNaN(min)||!Number.isFinite(min))throw new TypeError("randomFloat min parameter must be a number");if(Number.isNaN(max)||!Number.isFinite(max))throw new TypeError("randomFloat max parameter must be a number");if(min>max){var _ref8=[max,min];min=_ref8[0],max=_ref8[1]}return State.random()*(max-min)+min}function recall(key,defaultValue){if("string"!=typeof key)throw new TypeError("recall key parameter must be a string (received: ".concat(getTypeOf(key),")"));return State.metadata.has(key)?State.metadata.get(key):defaultValue}function tags(){if(0===arguments.length)return Story.get(State.passage).tags;for(var passages=Array.prototype.concat.apply([],arguments),tags=[],i=0;i<passages.length;++i)tags=tags.concat(Story.get(passages[i]).tags);return tags}function temporary(){return State.temporary}function time(){return null===Engine.lastPlay?0:now()-Engine.lastPlay}function turns(){return State.turns}function variables(){return State.variables}function visited(){if(State.isEmpty())return 0;for(var needles=Array.prototype.concat.apply([],0===arguments.length?[State.passage]:arguments),played=State.passages,count=State.turns,i=0;i<needles.length&&count>0;++i)count=Math.min(count,played.count(needles[i]));return count}function visitedTags(){if(0===arguments.length)throw new Error("visitedTags called with insufficient parameters");if(State.isEmpty())return 0;for(var needles=Array.prototype.concat.apply([],arguments),nLength=needles.length,played=State.passages,seen=new Map,count=0,i=0;i<played.length;++i){var title=played[i];if(seen.has(title))seen.get(title)&&++count;else{var _tags2=Story.get(title).tags;if(_tags2.length>0){for(var found=0,j=0;j<nLength;++j)_tags2.includes(needles[j])&&++found;found===nLength?(++count,seen.set(title,!0)):seen.set(title,!1)}}}return count}var _ref9=function(){function slugifyUrl(url){return parseURL(url).path.replace(/^[^\w]+|[^\w]+$/g,"").replace(/[^\w]+/g,"-").toLocaleLowerCase()}function addScript(url){return new Promise((function(resolve,reject){var kind,src;if("string"==typeof url)kind=url.trim().toLowerCase().endsWith(".mjs")?"module":"text/javascript",src=url;else{if("object"!==_typeof(url))throw new Error("importScripts url parameter must be a string or object");kind=url.type,src=url.src}jQuery(document.createElement("script")).one("load abort error",(function(ev){jQuery(ev.target).off(),"load"===ev.type?resolve(ev.target):reject(new Error('importScripts failed to load the script "'.concat(src,'"')))})).appendTo(document.head).attr({id:"script-imported-".concat(slugifyUrl(src)),type:kind,src:src})}))}function addStyle(url){return new Promise((function(resolve,reject){if("string"!=typeof url)throw new Error("importStyles url parameter must be a string");jQuery(document.createElement("link")).one("load abort error",(function(ev){jQuery(ev.target).off(),"load"===ev.type?resolve(ev.target):reject(new Error('importStyles failed to load the stylesheet "'.concat(url,'"')))})).appendTo(document.head).attr({id:"style-imported-".concat(slugifyUrl(url)),rel:"stylesheet",href:url})}))}function sequence(callbacks){return callbacks.reduce((function(seq,fn){return seq.then(fn)}),Promise.resolve())}return{importScripts:function(){for(var _len12=arguments.length,urls=new Array(_len12),_key12=0;_key12<_len12;_key12++)urls[_key12]=arguments[_key12];return Promise.all(urls.map((function(oneOrSeries){return Array.isArray(oneOrSeries)?sequence(oneOrSeries.map((function(url){return function(){return addScript(url)}}))):addScript(oneOrSeries)})))},importStyles:function(){for(var _len13=arguments.length,urls=new Array(_len13),_key13=0;_key13<_len13;_key13++)urls[_key13]=arguments[_key13];return Promise.all(urls.map((function(oneOrSeries){return Array.isArray(oneOrSeries)?sequence(oneOrSeries.map((function(url){return function(){return addStyle(url)}}))):addStyle(oneOrSeries)})))}}}(),importScripts=_ref9.importScripts,importStyles=_ref9.importStyles,desugar=function(){var tokenTable=enumFrom({$:"State.variables.",_:"State.temporary.",to:"=",eq:"==",neq:"!=",is:"===",isnot:"!==",gt:">",gte:">=",lt:"<",lte:"<=",and:"&&",or:"||",not:"!",def:'"undefined" !== typeof',ndef:'"undefined" === typeof'}),desugarRE=new RegExp(["(?:\"\"|''|``)",'(?:"(?:\\\\.|[^"\\\\])+")',"(?:'(?:\\\\.|[^'\\\\])+')","(`(?:\\\\.|[^`\\\\])+`)","(?:[=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}]+)","(?:\\.{3})","([^\"'=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}\\s]+)"].join("|"),"g"),varTest=new RegExp("^".concat(Patterns.variable));function desugar(sugaredCode){desugarRE.lastIndex=0;for(var match,code=sugaredCode;null!==(match=desugarRE.exec(code));)if(match[1]){var sugaredTemplate=match[1],template=desugarTemplate(sugaredTemplate);template!==sugaredTemplate&&(code=code.splice(match.index,sugaredTemplate.length,template),desugarRE.lastIndex+=template.length-sugaredTemplate.length)}else if(match[2]){var token=match[2];if("$"===token||"_"===token)continue;varTest.test(token)&&(token=token[0]),tokenTable[token]&&(code=code.splice(match.index,token.length,tokenTable[token]),desugarRE.lastIndex+=tokenTable[token].length-token.length)}return code}var templateGroupStartRE=/\$\{/g,templateGroupParseRE=new RegExp(["(?:\"\"|'')",'(?:"(?:\\\\.|[^"\\\\])+")',"(?:'(?:\\\\.|[^'\\\\])+')","(\\{)","(\\})"].join("|"),"g");function desugarTemplate(sugaredLiteral){templateGroupStartRE.lastIndex=0;for(var startMatch,template=sugaredLiteral;null!==(startMatch=templateGroupStartRE.exec(template));){var startIndex=startMatch.index+2,endIndex=startIndex,depth=1,endMatch=void 0;for(templateGroupParseRE.lastIndex=startIndex;null!==(endMatch=templateGroupParseRE.exec(template));)if(endMatch[1]?++depth:endMatch[2]&&--depth,0===depth){endIndex=endMatch.index;break}if(endIndex>startIndex){var desugarREIndex=desugarRE.lastIndex,sugaredGroup=template.slice(startIndex,endIndex),group=desugar(sugaredGroup);desugarRE.lastIndex=desugarREIndex,template=template.splice(startIndex,sugaredGroup.length,group),templateGroupStartRE.lastIndex+=group.length-sugaredGroup.length}}return template}return desugar}();function evalJavaScript(code,output,data){return function(code,output,SCRIPT$DATA$){return eval(code)}.call(output?{output:output}:null,String(code),output,data)}function evalTwineScript(code,output,data){return function(code,output,SCRIPT$DATA$){return eval(code)}.call(output?{output:output}:null,desugar(String(code)),output,data)}return Object.preventExtensions(Object.create(null,{desugar:{value:desugar},evalJavaScript:{value:evalJavaScript},evalTwineScript:{value:evalTwineScript},parse:{value:desugar}}))}(),_ref10=function(){var Lexer=function(){return _createClass((function Lexer(source,initialState){if(_classCallCheck(this,Lexer),arguments.length<2)throw new Error("Lexer constructor called with too few parameters (source:string , initialState:function)");Object.defineProperties(this,{source:{value:source},initial:{value:initialState},state:{writable:!0,value:initialState},start:{writable:!0,value:0},pos:{writable:!0,value:0},depth:{writable:!0,value:0},items:{writable:!0,value:[]},data:{writable:!0,value:{}}})}),[{key:"reset",value:function(){this.state=this.initial,this.start=0,this.pos=0,this.depth=0,this.items=[],this.data={}}},{key:"run",value:function(){for(;null!==this.state;)this.state=this.state(this);return this.items}},{key:"nextItem",value:function(){for(;0===this.items.length&&null!==this.state;)this.state=this.state(this);return this.items.shift()}},{key:"next",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos++]}},{key:"peek",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos]}},{key:"backup",value:function(num){this.pos-=num||1}},{key:"forward",value:function(num){this.pos+=num||1}},{key:"ignore",value:function(){this.start=this.pos}},{key:"accept",value:function(valid){var ch=this.next();return-1!==ch&&(!!valid.includes(ch)||(this.backup(),!1))}},{key:"acceptRe",value:function(validRe){var ch=this.next();return-1!==ch&&(!!validRe.test(ch)||(this.backup(),!1))}},{key:"acceptRun",value:function(valid){for(;;){var ch=this.next();if(-1===ch)return;if(!valid.includes(ch))break}this.backup()}},{key:"acceptRunRe",value:function(validRe){for(;;){var ch=this.next();if(-1===ch)return;if(!validRe.test(ch))break}this.backup()}},{key:"emit",value:function(type){this.items.push({type:type,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),this.start=this.pos}},{key:"error",value:function(type,message){if(arguments.length<2)throw new Error("Lexer.prototype.error called with too few parameters (type:number , message:string)");return this.items.push({type:type,message:message,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),null}}],[{key:"enumFromNames",value:function(names){var obj=names.reduce((function(obj,name,i){return obj[name]=i,obj}),{});return Object.freeze(Object.assign(Object.create(null),obj))}}])}();return{EOF:-1,Lexer:Lexer}}(),EOF=_ref10.EOF,Lexer=_ref10.Lexer,Wikifier=function(){var _optionsStack,macroParser,lookaheadRe,idOrClassRe,_callDepth=0,Wikifier=function(){function Wikifier(destination,source,options){_classCallCheck(this,Wikifier),Wikifier.Parser.Profile.isEmpty()&&Wikifier.Parser.Profile.compile(),Object.defineProperties(this,{source:{value:String(source)},options:{writable:!0,value:Object.assign({profile:"all"},options)},nextMatch:{writable:!0,value:0},output:{writable:!0,value:null},_rawArgs:{writable:!0,value:""}}),this.output=null==destination?document.createDocumentFragment():destination instanceof jQuery?destination[0]:destination;try{++_callDepth,this.subWikify(this.output),1===_callDepth&&(Object.hasOwn(this.options,"cleanup")&&null!=this.options.cleanup?this.options.cleanup:Config.cleanupWikifierOutput)&&convertBreaks(this.output)}finally{--_callDepth}}return _createClass(Wikifier,[{key:"subWikify",value:function(output,terminator,options){var newOptions,oldOptions,oldOutput=this.output;this.output=output,Wikifier.Option.length>0&&(newOptions=Object.assign(newOptions||{},Wikifier.Option.options)),null!==options&&"object"===_typeof(options)&&(newOptions=Object.assign(newOptions||{},options)),newOptions&&(oldOptions=this.options,this.options=Object.assign({},this.options,newOptions));var terminatorMatch,parserMatch,parsersProfile=Wikifier.Parser.Profile.get(this.options.profile),terminatorRegExp=terminator?new RegExp("(?:".concat(terminator,")"),this.options.ignoreTerminatorCase?"gim":"gm"):null;do{if(parsersProfile.parserRegExp.lastIndex=this.nextMatch,terminatorRegExp&&(terminatorRegExp.lastIndex=this.nextMatch),parserMatch=parsersProfile.parserRegExp.exec(this.source),(terminatorMatch=terminatorRegExp?terminatorRegExp.exec(this.source):null)&&(!parserMatch||terminatorMatch.index<=parserMatch.index))return terminatorMatch.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,terminatorMatch.index),this.matchStart=terminatorMatch.index,this.matchLength=terminatorMatch[0].length,this.matchText=terminatorMatch[0],this.nextMatch=terminatorRegExp.lastIndex,this.output=oldOutput,void(oldOptions&&(this.options=oldOptions));if(parserMatch){parserMatch.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,parserMatch.index),this.matchStart=parserMatch.index,this.matchLength=parserMatch[0].length,this.matchText=parserMatch[0],this.nextMatch=parsersProfile.parserRegExp.lastIndex;for(var matchingParser=void 0,i=1,iend=parserMatch.length;i<iend;++i)if(parserMatch[i]){matchingParser=i-1;break}if(parsersProfile.parsers[matchingParser].handler(this),null!=TempState.break)break}}while(terminatorMatch||parserMatch);null==TempState.break?this.nextMatch<this.source.length&&(this.outputText(this.output,this.nextMatch,this.source.length),this.nextMatch=this.source.length):this.output.lastChild&&this.output.lastChild.nodeType===Node.ELEMENT_NODE&&"BR"===this.output.lastChild.nodeName.toUpperCase()&&jQuery(this.output.lastChild).remove(),this.output=oldOutput,oldOptions&&(this.options=oldOptions)}},{key:"outputText",value:function(destination,startPos,endPos){jQuery(destination).append(document.createTextNode(this.source.substring(startPos,endPos)))}},{key:"rawArgs",value:function(){return console.warn("[DEPRECATED] Wikifier.rawArgs() is deprecated."),this._rawArgs}},{key:"fullArgs",value:function(){return console.warn("[DEPRECATED] Wikifier.fullArgs() is deprecated."),Scripting.desugar(this._rawArgs)}}],[{key:"wikifyEval",value:function(text){var output=document.createDocumentFragment();new Wikifier(output,text);var errors=output.querySelector(".error");if(null!==errors)throw new Error(errors.textContent.replace(errorPrologRegExp,""));return output}},{key:"createInternalLink",value:function(destination,passage,text,callback){var $link=jQuery(document.createElement("a"));return null!=passage&&($link.attr("data-passage",passage),Story.has(passage)?($link.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&$link.addClass("link-visited")):$link.addClass("link-broken"),$link.ariaClick({one:!0},(function(){"function"==typeof callback&&callback(),Engine.play(passage)}))),text&&$link.append(document.createTextNode(text)),destination&&$link.appendTo(destination),$link[0]}},{key:"createExternalLink",value:function(destination,url,text){var $link=jQuery(document.createElement("a")).attr("target","_blank").addClass("link-external").text(text).appendTo(destination);return null!=url&&$link.attr({href:url,tabindex:0}),$link[0]}}])}();return Object.defineProperty(Wikifier,"Option",{value:(_optionsStack=[],Object.preventExtensions(Object.create(null,{length:{get:function(){return _optionsStack.length}},options:{get:function(){return Object.assign.apply(Object,[{}].concat(_toConsumableArray(_optionsStack)))}},clear:{value:function(){_optionsStack=[]}},get:{value:function(index){return _optionsStack[index]}},pop:{value:function(){return _optionsStack.pop()}},push:{value:function(options){if("object"!==_typeof(options)||null===options)throw new TypeError("Wikifier.Option.push options parameter must be an object (received: ".concat(getTypeOf(options),")"));return _optionsStack.push(options)}}})))}),Object.defineProperty(Wikifier,"Parser",{value:function(){var _profiles,_parsers=[];function parsersHas(name){return!!_parsers.find((function(parser){return parser.name===name}))}return Object.preventExtensions(Object.create(null,{parsers:{get:function(){return _parsers}},add:{value:function(parser){if("object"!==_typeof(parser))throw new Error("Wikifier.Parser.add parser parameter must be an object");if(!Object.hasOwn(parser,"name"))throw new Error('parser object missing required "name" property');if("string"!=typeof parser.name)throw new Error('parser object "name" property must be a string');if(!Object.hasOwn(parser,"match"))throw new Error('parser object missing required "match" property');if("string"!=typeof parser.match)throw new Error('parser object "match" property must be a string');if(!Object.hasOwn(parser,"handler"))throw new Error('parser object missing required "handler" property');if("function"!=typeof parser.handler)throw new Error('parser object "handler" property must be a function');if(Object.hasOwn(parser,"profiles")&&!Array.isArray(parser.profiles))throw new Error('parser object "profiles" property must be an array');if(parsersHas(parser.name))throw new Error('cannot clobber existing parser "'.concat(parser.name,'"'));_parsers.push(parser)}},delete:{value:function(name){var parser=_parsers.find((function(parser){return parser.name===name}));parser&&_parsers.delete(parser)}},isEmpty:{value:function(){return 0===_parsers.length}},has:{value:parsersHas},get:{value:function(name){return _parsers.find((function(parser){return parser.name===name}))||null}},Profile:{value:Object.preventExtensions(Object.create(null,{profiles:{get:function(){return _profiles}},compile:{value:function(){var all=_parsers,core=all.filter((function(parser){return!Array.isArray(parser.profiles)||parser.profiles.includes("core")}));return _profiles=Object.freeze({all:{parsers:all,parserRegExp:new RegExp(all.map((function(parser){return"(".concat(parser.match,")")})).join("|"),"gm")},core:{parsers:core,parserRegExp:new RegExp(core.map((function(parser){return"(".concat(parser.match,")")})).join("|"),"gm")}})}},isEmpty:{value:function(){return"object"!==_typeof(_profiles)||0===Object.keys(_profiles).length}},has:{value:function(profile){return"object"===_typeof(_profiles)&&Object.hasOwn(_profiles,profile)}},get:{value:function(profile){if("object"!==_typeof(_profiles)||!Object.hasOwn(_profiles,profile))throw new Error('nonexistent parser profile "'.concat(profile,'"'));return _profiles[profile]}}}))}}))}()}),Object.defineProperties(Wikifier,{helpers:{value:{}},isExternalLink:{value:isExternalLink},getValue:{value:State.getVar},setValue:{value:State.setVar},parse:{value:Scripting.desugar},evalExpression:{value:Scripting.evalTwineScript},evalStatements:{value:Scripting.evalTwineScript},textPrimitives:{value:Patterns}}),Object.defineProperties(Wikifier.helpers,{inlineCss:{value:(lookaheadRe=new RegExp(Patterns.inlineCss,"gm"),idOrClassRe=new RegExp("(".concat(Patterns.cssIdOrClassSigil,")(").concat(Patterns.anyLetter,"+)"),"g"),function(w){var matched,css={classes:[],id:"",styles:{}};do{lookaheadRe.lastIndex=w.nextMatch;var match=lookaheadRe.exec(w.source);if(matched=match&&match.index===w.nextMatch){if(match[1])css.styles[cssPropToDOMProp(match[1])]=match[2].trim();else if(match[3])css.styles[cssPropToDOMProp(match[3])]=match[4].trim();else if(match[5]){var subMatch=void 0;for(idOrClassRe.lastIndex=0;null!==(subMatch=idOrClassRe.exec(match[5]));)"."===subMatch[1]?css.classes.push(subMatch[2]):css.id=subMatch[2]}w.nextMatch=lookaheadRe.lastIndex}}while(matched);return css})},evalText:{value:function(text){var result;try{switch(_typeof(result=Scripting.evalTwineScript(text))){case"string":""===result.trim()&&(result=text);break;case"number":result=String(result);break;default:result=text}}catch(ex){result=text}return result}},evalPassageId:{value:function(passage){return null==passage||Story.has(passage)?passage:Wikifier.helpers.evalText(passage)}},hasBlockContext:{value:function(nodes){for(var hasGCS="function"==typeof window.getComputedStyle,i=nodes.length-1;i>=0;--i){var node=nodes[i];switch(node.nodeType){case Node.ELEMENT_NODE:var tagName=node.nodeName.toUpperCase();if("BR"===tagName)return!0;var styles=hasGCS?window.getComputedStyle(node,null):node.currentStyle;if(styles&&styles.display){if("none"===styles.display)continue;return"block"===styles.display}switch(tagName){case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":return!0}return!1;case Node.COMMENT_NODE:continue;default:return!1}}return!0}},shadowHandler:{value:(macroParser=null,function(code){var shadowStore=Object.create(null);return macroParser||function(){if(!macroParser&&!(macroParser=Wikifier.Parser.get("macro")))throw new Error('cannot find "macro" parser')}(),macroParser.context&&macroParser.context.shadowView.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey]})),function(){var shadowNames=Object.keys(shadowStore),valueCache=shadowNames.length>0?{}:null;try{return shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;Object.hasOwn(store,varKey)&&(valueCache[varKey]=store[varKey]),store[varKey]=shadowStore[varName]})),Scripting.evalJavaScript(code)}finally{shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey],Object.hasOwn(valueCache,varKey)?store[varKey]=valueCache[varKey]:delete store[varKey]}))}}})},parseSquareBracketedMarkup:{value:function(){var Item=Lexer.enumFromNames(["Error","DelimLTR","DelimRTL","InnerMeta","ImageMeta","LinkMeta","Link","RightMeta","Setter","Source","Text"]),Delim=Lexer.enumFromNames(["None","LTR","RTL"]);function slurpQuote(lexer,endQuote){loop:for(;;)switch(lexer.next()){case"\\":var ch=lexer.next();if(ch!==EOF&&"\n"!==ch)break;case EOF:case"\n":return EOF;case endQuote:break loop}return lexer.pos}function lexLeftMeta(lexer){if(!lexer.accept("["))return lexer.error(Item.Error,"malformed square-bracketed markup");if(lexer.accept("["))lexer.data.isLink=!0,lexer.emit(Item.LinkMeta);else{if(lexer.accept("<>"),!(lexer.accept("Ii")&&lexer.accept("Mm")&&lexer.accept("Gg")&&lexer.accept("[")))return lexer.error(Item.Error,"malformed square-bracketed markup");lexer.data.isLink=!1,lexer.emit(Item.ImageMeta)}return lexer.depth=2,lexCoreComponents}function lexCoreComponents(lexer){for(var what=lexer.data.isLink?"link":"image",delim=Delim.None;;)switch(lexer.next()){case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case'"':if(slurpQuote(lexer,'"')===EOF)return lexer.error(Item.Error,"unterminated double quoted string in ".concat(what," markup"));break;case"|":delim===Delim.None&&(delim=Delim.LTR,lexer.backup(),lexer.emit(Item.Text),lexer.forward(),lexer.emit(Item.DelimLTR));break;case"-":delim===Delim.None&&">"===lexer.peek()&&(delim=Delim.LTR,lexer.backup(),lexer.emit(Item.Text),lexer.forward(2),lexer.emit(Item.DelimLTR));break;case"<":delim===Delim.None&&"-"===lexer.peek()&&(delim=Delim.RTL,lexer.backup(),lexer.emit(lexer.data.isLink?Item.Link:Item.Source),lexer.forward(2),lexer.emit(Item.DelimRTL));break;case"[":++lexer.depth;break;case"]":if(--lexer.depth,1===lexer.depth)switch(lexer.peek()){case"[":return++lexer.depth,lexer.backup(),delim===Delim.RTL?lexer.emit(Item.Text):lexer.emit(lexer.data.isLink?Item.Link:Item.Source),lexer.forward(2),lexer.emit(Item.InnerMeta),lexer.data.isLink?lexSetter:lexImageLink;case"]":return--lexer.depth,lexer.backup(),delim===Delim.RTL?lexer.emit(Item.Text):lexer.emit(lexer.data.isLink?Item.Link:Item.Source),lexer.forward(2),lexer.emit(Item.RightMeta),null;default:return lexer.error(Item.Error,"malformed ".concat(what," markup"))}}}function lexImageLink(lexer){for(var what=lexer.data.isLink?"link":"image";;)switch(lexer.next()){case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case'"':if(slurpQuote(lexer,'"')===EOF)return lexer.error(Item.Error,"unterminated double quoted string in ".concat(what," markup link component"));break;case"[":++lexer.depth;break;case"]":if(--lexer.depth,1===lexer.depth)switch(lexer.peek()){case"[":return++lexer.depth,lexer.backup(),lexer.emit(Item.Link),lexer.forward(2),lexer.emit(Item.InnerMeta),lexSetter;case"]":return--lexer.depth,lexer.backup(),lexer.emit(Item.Link),lexer.forward(2),lexer.emit(Item.RightMeta),null;default:return lexer.error(Item.Error,"malformed ".concat(what," markup"))}}}function lexSetter(lexer){for(var what=lexer.data.isLink?"link":"image";;)switch(lexer.next()){case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case'"':if(slurpQuote(lexer,'"')===EOF)return lexer.error(Item.Error,"unterminated double quoted string in ".concat(what," markup setter component"));break;case"'":if(slurpQuote(lexer,"'")===EOF)return lexer.error(Item.Error,"unterminated single quoted string in ".concat(what," markup setter component"));break;case"[":++lexer.depth;break;case"]":if(--lexer.depth,1===lexer.depth)return"]"!==lexer.peek()?lexer.error(Item.Error,"malformed ".concat(what," markup")):(--lexer.depth,lexer.backup(),lexer.emit(Item.Setter),lexer.forward(2),lexer.emit(Item.RightMeta),null)}}return function(w){var lexer=new Lexer(w.source,lexLeftMeta);lexer.start=lexer.pos=w.matchStart;var markup={},items=lexer.run(),last=items.last();return last&&last.type===Item.Error?markup.error=last.message:items.forEach((function(item){var text=item.text.trim();switch(item.type){case Item.ImageMeta:markup.isImage=!0,"<"===text[1]?markup.align="left":">"===text[1]&&(markup.align="right");break;case Item.LinkMeta:markup.isLink=!0;break;case Item.Link:"~"===text[0]?(markup.forceInternal=!0,markup.link=text.slice(1)):markup.link=text;break;case Item.Setter:markup.setter=text;break;case Item.Source:markup.source=text;break;case Item.Text:markup.text=text}})),markup.pos=lexer.pos,markup}}()}}),Wikifier}();!function(){function _verbatimTagHandler(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);match&&match.index===w.matchStart&&(w.nextMatch=this.lookahead.lastIndex,jQuery(document.createDocumentFragment()).append(match[1]).appendTo(w.output))}Wikifier.Parser.add({name:"quoteByBlock",profiles:["block"],match:"^<<<\\n",terminator:"^<<<\\n",handler:function(w){Wikifier.helpers.hasBlockContext(w.output.childNodes)?w.subWikify(jQuery(document.createElement("blockquote")).appendTo(w.output).get(0),this.terminator):jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"quoteByLine",profiles:["block"],match:"^>+",lookahead:/^>+/gm,terminator:"\\n",handler:function(w){if(Wikifier.helpers.hasBlockContext(w.output.childNodes)){var matched,i,destStack=[w.output],curLevel=0,newLevel=w.matchLength;do{if(newLevel>curLevel)for(i=curLevel;i<newLevel;++i)destStack.push(jQuery(document.createElement("blockquote")).appendTo(destStack[destStack.length-1]).get(0));else if(newLevel<curLevel)for(i=curLevel;i>newLevel;--i)destStack.pop();curLevel=newLevel,w.subWikify(destStack[destStack.length-1],this.terminator),jQuery(document.createElement("br")).appendTo(destStack[destStack.length-1]),this.lookahead.lastIndex=w.nextMatch;var match=this.lookahead.exec(w.source);(matched=match&&match.index===w.nextMatch)&&(newLevel=match[0].length,w.nextMatch+=match[0].length)}while(matched)}else jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"macro",profiles:["core"],match:"<<",lookahead:new RegExp("<<(/?".concat(Patterns.macroName,")(?:\\s*)((?:(?:/\\*[^*]*\\*+(?:[^/*][^*]*\\*+)*/)|(?://.*\\n)|(?:`(?:\\\\.|[^`\\\\])*`)|(?:\"(?:\\\\.|[^\"\\\\])*\")|(?:'(?:\\\\.|[^'\\\\])*')|(?:\\[(?:[<>]?[Ii][Mm][Gg])?\\[[^\\r\\n]*?\\]\\]+)|[^>]|(?:>(?!>)))*)>>"),"gm"),working:{source:"",name:"",arguments:"",index:0},context:null,handler:function(w){var matchStart=this.lookahead.lastIndex=w.matchStart;if(this.parseTag(w)){var macro,nextMatch=w.nextMatch,name=this.working.name,rawArgs=this.working.arguments;try{if(!(macro=Macro.get(name))){if(Macro.tags.has(name)){var tags=Macro.tags.get(name);return appendError(w.output,"child tag <<".concat(name,">> was found outside of a call to its parent macro").concat(1===tags.length?"":"s"," <<").concat(tags.join(">>, <<"),">>"),w.source.slice(matchStart,w.nextMatch))}return appendError(w.output,"macro <<".concat(name,">> does not exist"),w.source.slice(matchStart,w.nextMatch))}var payload=null;if(void 0!==macro.tags&&!(payload=this.parseBody(w,macro)))return w.nextMatch=nextMatch,appendError(w.output,"cannot find a closing tag for macro <<".concat(name,">>"),"".concat(w.source.slice(matchStart,w.nextMatch),"…"));if("function"!=typeof macro.handler)return appendError(w.output,"macro <<".concat(name,">> handler function ").concat(void 0===macro.handler?"does not exist":"is not a function"),w.source.slice(matchStart,w.nextMatch));var args=payload?payload[0].args:this.createArgs(rawArgs,this.skipArgs(macro,macro.name));if(void 0!==macro._MACRO_API){this.context=new MacroContext({macro:macro,name:name,args:args,payload:payload,source:w.source.slice(matchStart,w.nextMatch),parent:this.context,parser:w});try{macro.handler.call(this.context)}finally{this.context=this.context.parent}}else{console.warn("[DEPRECATED] The legacy macro API, used by <<".concat(name,">>, is deprecated."));var prevRawArgs=w._rawArgs;w._rawArgs=rawArgs;try{macro.handler(w.output,name,args,w,payload)}finally{w._rawArgs=prevRawArgs}}}catch(ex){return appendError(w.output,"cannot execute ".concat(macro&&macro.isWidget?"widget":"macro"," <<").concat(name,">>: ").concat(ex.message),w.source.slice(matchStart,w.nextMatch))}finally{this.working.source="",this.working.name="",this.working.arguments="",this.working.index=0}}else w.outputText(w.output,w.matchStart,w.nextMatch)},parseTag:function(w){var match=this.lookahead.exec(w.source);return!(!match||match.index!==w.matchStart||!match[1])&&(w.nextMatch=this.lookahead.lastIndex,this.working.source=w.source.slice(match.index,this.lookahead.lastIndex),this.working.name=match[1],this.working.arguments=match[2],this.working.index=match.index,!0)},parseBody:function(w,macro){for(var openTag=this.working.name,closeTag="/".concat(openTag),closeAlt="end".concat(openTag),bodyTags=!!Array.isArray(macro.tags)&&macro.tags,payload=[],end=-1,opened=1,curSource=this.working.source,curTag=this.working.name,curArgument=this.working.arguments,contentStart=w.nextMatch;-1!==(w.matchStart=w.source.indexOf(this.match,w.nextMatch));)if(this.parseTag(w)){var tagSource=this.working.source,tagName=this.working.name,tagArgs=this.working.arguments,tagBegin=this.working.index,tagEnd=w.nextMatch,hasArgs=""!==tagArgs.trim();switch(tagName){case openTag:++opened;break;case closeAlt:case closeTag:if(hasArgs)throw w.nextMatch=tagBegin+2+tagName.length,new Error('malformed closing tag: "'.concat(tagSource,'"'));--opened;break;default:if(hasArgs&&(tagName.startsWith("/")||tagName.startsWith("end"))){this.lookahead.lastIndex=w.nextMatch=tagBegin+2+tagName.length;continue}if(1===opened&&bodyTags)for(var i=0,iend=bodyTags.length;i<iend;++i)tagName===bodyTags[i]&&(payload.push({source:curSource,name:curTag,arguments:curArgument,args:this.createArgs(curArgument,this.skipArgs(macro,curTag)),contents:w.source.slice(contentStart,tagBegin)}),curSource=tagSource,curTag=tagName,curArgument=tagArgs,contentStart=tagEnd)}if(0===opened){payload.push({source:curSource,name:curTag,arguments:curArgument,args:this.createArgs(curArgument,this.skipArgs(macro,curTag)),contents:w.source.slice(contentStart,tagBegin)}),end=tagEnd;break}}else this.lookahead.lastIndex=w.nextMatch=w.matchStart+this.match.length;return-1!==end?(w.nextMatch=end,payload):null},createArgs:function(rawArgsString,skipArgs){var args=skipArgs?[]:this.parseArgs(rawArgsString);return Object.defineProperties(args,{raw:{value:rawArgsString},full:{value:Scripting.desugar(rawArgsString)}}),args},skipArgs:function(macro,tagName){if(void 0!==macro.skipArgs){var sa=macro.skipArgs;return"boolean"==typeof sa&&sa||Array.isArray(sa)&&sa.includes(tagName)}return void 0!==macro.skipArg0&&(macro.skipArg0&&macro.name===tagName)},parseArgs:function(){var Item=Lexer.enumFromNames(["Error","Bareword","Expression","String","SquareBracket"]),spaceRe=new RegExp(Patterns.space),notSpaceRe=new RegExp(Patterns.notSpace),varTest=new RegExp("^".concat(Patterns.variable));function slurpQuote(lexer,endQuote){loop:for(;;)switch(lexer.next()){case"\\":var ch=lexer.next();if(ch!==EOF&&"\n"!==ch)break;case EOF:case"\n":return EOF;case endQuote:break loop}return lexer.pos}function lexSpace(lexer){var offset=lexer.source.slice(lexer.pos).search(notSpaceRe);if(offset===EOF)return null;switch(0!==offset&&(lexer.pos+=offset,lexer.ignore()),lexer.next()){case"`":return lexExpression;case'"':return lexDoubleQuote;case"'":return lexSingleQuote;case"[":return lexSquareBracket;default:return lexBareword}}function lexExpression(lexer){return slurpQuote(lexer,"`")===EOF?lexer.error(Item.Error,"unterminated backquote expression"):(lexer.emit(Item.Expression),lexSpace)}function lexDoubleQuote(lexer){return slurpQuote(lexer,'"')===EOF?lexer.error(Item.Error,"unterminated double quoted string"):(lexer.emit(Item.String),lexSpace)}function lexSingleQuote(lexer){return slurpQuote(lexer,"'")===EOF?lexer.error(Item.Error,"unterminated single quoted string"):(lexer.emit(Item.String),lexSpace)}function lexSquareBracket(lexer){var what;if(lexer.accept("<>IiMmGg")?(what="image",lexer.acceptRun("<>IiMmGg")):what="link",!lexer.accept("["))return lexer.error(Item.Error,"malformed ".concat(what," markup"));lexer.depth=2;loop:for(;;)switch(lexer.next()){case"\\":var ch=lexer.next();if(ch!==EOF&&"\n"!==ch)break;case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case"[":++lexer.depth;break;case"]":if(--lexer.depth,lexer.depth<0)return lexer.error(Item.Error,"unexpected right square bracket ']'");if(1===lexer.depth){if("]"===lexer.next()){--lexer.depth;break loop}lexer.backup()}}return lexer.emit(Item.SquareBracket),lexSpace}function lexBareword(lexer){var offset=lexer.source.slice(lexer.pos).search(spaceRe);return lexer.pos=offset===EOF?lexer.source.length:lexer.pos+offset,lexer.emit(Item.Bareword),offset===EOF?null:lexSpace}return function(rawArgsString){var lexer=new Lexer(rawArgsString,lexSpace),args=[];return lexer.run().forEach((function(item){var arg=item.text;switch(item.type){case Item.Error:throw new Error('unable to parse macro argument "'.concat(arg,'": ').concat(item.message));case Item.Bareword:if(varTest.test(arg))arg=State.getVar(arg);else if(/^(?:settings|setup)[.[]/.test(arg))try{arg=Scripting.evalTwineScript(arg)}catch(ex){throw new Error('unable to parse macro argument "'.concat(arg,'": ').concat(ex.message))}else if("null"===arg)arg=null;else if("undefined"===arg)arg=undefined;else if("true"===arg)arg=!0;else if("false"===arg)arg=!1;else if("NaN"===arg)arg=NaN;else{var argAsNum=Number(arg);Number.isNaN(argAsNum)||(arg=argAsNum)}break;case Item.Expression:if(""===(arg=arg.slice(1,-1).trim()))arg=undefined;else try{arg=Scripting.evalTwineScript("(".concat(arg,")"))}catch(ex){throw new Error('unable to parse macro argument expression "'.concat(arg,'": ').concat(ex.message))}break;case Item.String:try{arg=Scripting.evalJavaScript(arg)}catch(ex){throw new Error('unable to parse macro argument string "'.concat(arg,'": ').concat(ex.message))}break;case Item.SquareBracket:var markup=Wikifier.helpers.parseSquareBracketedMarkup({source:arg,matchStart:0});if(Object.hasOwn(markup,"error"))throw new Error('unable to parse macro argument "'.concat(arg,'": ').concat(markup.error));if(markup.pos<arg.length)throw new Error('unable to parse macro argument "'.concat(arg,'": unexpected character(s) "').concat(arg.slice(markup.pos),'" (pos: ').concat(markup.pos,")"));markup.isLink?((arg={isLink:!0}).count=Object.hasOwn(markup,"text")?2:1,arg.link=Wikifier.helpers.evalPassageId(markup.link),arg.text=Object.hasOwn(markup,"text")?Wikifier.helpers.evalText(markup.text):arg.link,arg.external=!markup.forceInternal&&Wikifier.isExternalLink(arg.link),arg.setFn=Object.hasOwn(markup,"setter")?Wikifier.helpers.shadowHandler(Scripting.desugar(markup.setter)):null):markup.isImage&&(arg=function(source){var imgObj={source:source,isImage:!0};if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(imgObj.source=passage.text,imgObj.passage=passage.name)}return imgObj}(Wikifier.helpers.evalPassageId(markup.source)),Object.hasOwn(markup,"align")&&(arg.align=markup.align),Object.hasOwn(markup,"text")&&(arg.title=Wikifier.helpers.evalText(markup.text)),Object.hasOwn(markup,"link")&&(arg.link=Wikifier.helpers.evalPassageId(markup.link),arg.external=!markup.forceInternal&&Wikifier.isExternalLink(arg.link)),arg.setFn=Object.hasOwn(markup,"setter")?Wikifier.helpers.shadowHandler(Scripting.desugar(markup.setter)):null)}args.push(arg)})),args}}()}),Wikifier.Parser.add({name:"link",profiles:["core"],match:"\\[\\[[^[]",handler:function(w){var markup=Wikifier.helpers.parseSquareBracketedMarkup(w);if(Object.hasOwn(markup,"error"))w.outputText(w.output,w.matchStart,w.nextMatch);else{w.nextMatch=markup.pos;var link=Wikifier.helpers.evalPassageId(markup.link),text=Object.hasOwn(markup,"text")?Wikifier.helpers.evalText(markup.text):link,setFn=Object.hasOwn(markup,"setter")?Wikifier.helpers.shadowHandler(Scripting.desugar(markup.setter)):null,output=(Config.debug?new DebugView(w.output,"link-markup","[[link]]",w.source.slice(w.matchStart,w.nextMatch)):w).output;markup.forceInternal||!Wikifier.isExternalLink(link)?Wikifier.createInternalLink(output,link,text,setFn):Wikifier.createExternalLink(output,link,text)}}}),Wikifier.Parser.add({name:"urlLink",profiles:["core"],match:Patterns.url,handler:function(w){w.outputText(Wikifier.createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch)}}),Wikifier.Parser.add({name:"image",profiles:["core"],match:"\\[[<>]?[Ii][Mm][Gg]\\[",handler:function(w){var markup=Wikifier.helpers.parseSquareBracketedMarkup(w);if(Object.hasOwn(markup,"error"))w.outputText(w.output,w.matchStart,w.nextMatch);else{var debugView;w.nextMatch=markup.pos,Config.debug&&(debugView=new DebugView(w.output,"image-markup",Object.hasOwn(markup,"link")?"[img[][link]]":"[img[]]",w.source.slice(w.matchStart,w.nextMatch))).modes({block:!0});var source,setFn=Object.hasOwn(markup,"setter")?Wikifier.helpers.shadowHandler(Scripting.desugar(markup.setter)):null,el=(Config.debug?debugView:w).output;if(Object.hasOwn(markup,"link")){var link=Wikifier.helpers.evalPassageId(markup.link);(el=markup.forceInternal||!Wikifier.isExternalLink(link)?Wikifier.createInternalLink(el,link,null,setFn):Wikifier.createExternalLink(el,link)).classList.add("link-image")}if(el=jQuery(document.createElement("img")).appendTo(el).get(0),"data:"!==(source=Wikifier.helpers.evalPassageId(markup.source)).slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(el.setAttribute("data-passage",passage.name),source=passage.text.trim())}el.src=source,Object.hasOwn(markup,"text")&&(el.title=Wikifier.helpers.evalText(markup.text)),Object.hasOwn(markup,"align")&&(el.align=markup.align)}}}),Wikifier.Parser.add({name:"monospacedByBlock",profiles:["block"],match:"^\\{\\{\\{\\n",lookahead:/^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/gm,handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);if(match&&match.index===w.matchStart){var pre=jQuery(document.createElement("pre"));jQuery(document.createElement("code")).text(match[1]).appendTo(pre),pre.appendTo(w.output),w.nextMatch=this.lookahead.lastIndex}}}),Wikifier.Parser.add({name:"formatByChar",profiles:["core"],match:"''|//|__|\\^\\^|~~|==|\\{\\{\\{",handler:function(w){switch(w.matchText){case"''":w.subWikify(jQuery(document.createElement("strong")).appendTo(w.output).get(0),"''");break;case"//":w.subWikify(jQuery(document.createElement("em")).appendTo(w.output).get(0),"//");break;case"__":w.subWikify(jQuery(document.createElement("u")).appendTo(w.output).get(0),"__");break;case"^^":w.subWikify(jQuery(document.createElement("sup")).appendTo(w.output).get(0),"\\^\\^");break;case"~~":w.subWikify(jQuery(document.createElement("sub")).appendTo(w.output).get(0),"~~");break;case"==":w.subWikify(jQuery(document.createElement("s")).appendTo(w.output).get(0),"==");break;case"{{{":var lookahead=/\{\{\{((?:.|\n)*?)\}\}\}/gm;lookahead.lastIndex=w.matchStart;var match=lookahead.exec(w.source);match&&match.index===w.matchStart&&(jQuery(document.createElement("code")).text(match[1]).appendTo(w.output),w.nextMatch=lookahead.lastIndex)}}}),Wikifier.Parser.add({name:"customStyle",profiles:["core"],match:"@@",terminator:"@@",blockRe:/\s*\n/gm,handler:function(w){var css=Wikifier.helpers.inlineCss(w);this.blockRe.lastIndex=w.nextMatch;var blockMatch=this.blockRe.exec(w.source),blockLevel=blockMatch&&blockMatch.index===w.nextMatch,$el=jQuery(document.createElement(blockLevel?"div":"span")).appendTo(w.output);0===css.classes.length&&""===css.id&&0===Object.keys(css.styles).length?$el.addClass("marked"):(css.classes.forEach((function(className){return $el.addClass(className)})),""!==css.id&&$el.attr("id",css.id),$el.css(css.styles)),blockLevel?(w.nextMatch+=blockMatch[0].length,w.subWikify($el[0],"\\n?".concat(this.terminator))):w.subWikify($el[0],this.terminator)}}),Wikifier.Parser.add({name:"verbatimText",profiles:["core"],match:'"{3}|<[Nn][Oo][Ww][Ii][Kk][Ii]>',lookahead:/(?:"{3}((?:.|\n)*?)"{3})|(?:<[Nn][Oo][Ww][Ii][Kk][Ii]>((?:.|\n)*?)<\/[Nn][Oo][Ww][Ii][Kk][Ii]>)/gm,handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);match&&match.index===w.matchStart&&(w.nextMatch=this.lookahead.lastIndex,jQuery(document.createElement("span")).addClass("verbatim").text(match[1]||match[2]).appendTo(w.output))}}),Wikifier.Parser.add({name:"horizontalRule",profiles:["core"],match:"^----+\\s*$",handler:function(w){jQuery(document.createElement("hr")).appendTo(w.output)}}),Wikifier.Parser.add({name:"emdash",profiles:["core"],match:"--",handler:function(w){jQuery(document.createTextNode("—")).appendTo(w.output)}}),Wikifier.Parser.add({name:"doubleDollarSign",profiles:["core"],match:"\\${2}",handler:function(w){jQuery(document.createTextNode("$")).appendTo(w.output)}}),Wikifier.Parser.add({name:"nakedVariable",profiles:["core"],match:"".concat(Patterns.variable,"(?:(?:\\.").concat(Patterns.identifier,")|(?:\\[\\d+\\])|(?:\\[\"(?:\\\\.|[^\"\\\\])+\"\\])|(?:\\['(?:\\\\.|[^'\\\\])+'\\])|(?:\\[").concat(Patterns.variable,"\\]))*"),handler:function(w){var result=State.getVar(w.matchText);null==result?jQuery(document.createTextNode(w.matchText)).appendTo(w.output):new Wikifier((Config.debug?new DebugView(w.output,"variable",w.matchText,w.matchText):w).output,stringFrom(result))}}),Wikifier.Parser.add({name:"template",profiles:["core"],match:"\\?".concat(Patterns.templateName),handler:function(w){var name=w.matchText.slice(1),template=Template.get(name),result=null;switch(template instanceof Array&&(template=template.random()),_typeof(template)){case"function":try{result=stringFrom(template.call({name:name}))}catch(ex){return appendError(w.output,"cannot execute function template ?".concat(name,": ").concat(ex.message),w.source.slice(w.matchStart,w.nextMatch))}break;case"string":result=template}null===result?jQuery(document.createTextNode(w.matchText)).appendTo(w.output):new Wikifier((Config.debug?new DebugView(w.output,"template",w.matchText,w.matchText):w).output,result)}}),Wikifier.Parser.add({name:"heading",profiles:["block"],match:"^!{1,6}",terminator:"\\n",handler:function(w){Wikifier.helpers.hasBlockContext(w.output.childNodes)?w.subWikify(jQuery(document.createElement("h".concat(w.matchLength))).appendTo(w.output).get(0),this.terminator):jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"table",profiles:["block"],match:"^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",lookahead:/^\|([^\n]*)\|([fhck]?)$/gm,rowTerminator:"\\|(?:[cfhk]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[cfhk]?$\\n?)",cellTerminator:"(?:\\u0020*)\\|",rowTypes:{c:"caption",f:"tfoot",h:"thead","":"tbody"},handler:function(w){if(Wikifier.helpers.hasBlockContext(w.output.childNodes)){var matched,table=jQuery(document.createElement("table")).appendTo(w.output).get(0),prevColumns=[],curRowType=null,$rowContainer=null,rowCount=0;w.nextMatch=w.matchStart;do{this.lookahead.lastIndex=w.nextMatch;var match=this.lookahead.exec(w.source);if(matched=match&&match.index===w.nextMatch){var nextRowType=match[2];"k"===nextRowType?(table.className=match[1],w.nextMatch+=match[0].length+1):(nextRowType!==curRowType&&(curRowType=nextRowType,$rowContainer=jQuery(document.createElement(this.rowTypes[nextRowType])).appendTo(table)),"c"===curRowType?($rowContainer.css("caption-side",0===rowCount?"top":"bottom"),w.nextMatch+=1,w.subWikify($rowContainer[0],this.rowTerminator)):this.rowHandler(w,jQuery(document.createElement("tr")).appendTo($rowContainer).get(0),prevColumns),++rowCount)}}while(matched)}else jQuery(w.output).append(document.createTextNode(w.matchText))},rowHandler:function(w,rowEl,prevColumns){var matched,_this10=this,cellRe=new RegExp(this.cellPattern,"gm"),col=0,curColCount=1,_loop5=function(){cellRe.lastIndex=w.nextMatch;var cellMatch=cellRe.exec(w.source);if(matched=cellMatch&&cellMatch.index===w.nextMatch){if("~"===cellMatch[1]){var last=prevColumns[col];last&&(++last.rowCount,last.$element.attr("rowspan",last.rowCount).css("vertical-align","middle")),w.nextMatch=cellMatch.index+cellMatch[0].length-1}else if(">"===cellMatch[1])++curColCount,w.nextMatch=cellMatch.index+cellMatch[0].length-1;else{if(cellMatch[2])return w.nextMatch=cellMatch.index+cellMatch[0].length,1;++w.nextMatch;for(var $cell,css=Wikifier.helpers.inlineCss(w),spaceLeft=!1,spaceRight=!1;" "===w.source.substr(w.nextMatch,1);)spaceLeft=!0,++w.nextMatch;"!"===w.source.substr(w.nextMatch,1)?($cell=jQuery(document.createElement("th")).appendTo(rowEl),++w.nextMatch):$cell=jQuery(document.createElement("td")).appendTo(rowEl),prevColumns[col]={rowCount:1,$element:$cell},curColCount>1&&($cell.attr("colspan",curColCount),curColCount=1),w.subWikify($cell[0],_this10.cellTerminator)," "===w.matchText.substr(w.matchText.length-2,1)&&(spaceRight=!0),css.classes.forEach((function(className){return $cell.addClass(className)})),""!==css.id&&$cell.attr("id",css.id),spaceLeft&&spaceRight?css.styles["text-align"]="center":spaceLeft?css.styles["text-align"]="right":spaceRight&&(css.styles["text-align"]="left"),$cell.css(css.styles),w.nextMatch=w.nextMatch-1}++col}};do{if(_loop5())break}while(matched)}}),Wikifier.Parser.add({name:"list",profiles:["block"],match:"^(?:(?:\\*+)|(?:#+))",lookahead:/^(?:(\*+)|(#+))/gm,terminator:"\\n",handler:function(w){if(Wikifier.helpers.hasBlockContext(w.output.childNodes)){w.nextMatch=w.matchStart;var matched,i,destStack=[w.output],curType=null,curLevel=0;do{this.lookahead.lastIndex=w.nextMatch;var match=this.lookahead.exec(w.source);if(matched=match&&match.index===w.nextMatch){var newType=match[2]?"ol":"ul",newLevel=match[0].length;if(w.nextMatch+=match[0].length,newLevel>curLevel)for(i=curLevel;i<newLevel;++i)destStack.push(jQuery(document.createElement(newType)).appendTo(destStack[destStack.length-1]).get(0));else if(newLevel<curLevel)for(i=curLevel;i>newLevel;--i)destStack.pop();else newLevel===curLevel&&newType!==curType&&(destStack.pop(),destStack.push(jQuery(document.createElement(newType)).appendTo(destStack[destStack.length-1]).get(0)));curLevel=newLevel,curType=newType,w.subWikify(jQuery(document.createElement("li")).appendTo(destStack[destStack.length-1]).get(0),this.terminator)}}while(matched)}else jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"commentByBlock",profiles:["core"],match:"(?:/(?:%|\\*))|(?:\x3c!--)",lookahead:/(?:\/(%|\*)(?:(?:.|\n)*?)\1\/)|(?:<!--(?:(?:.|\n)*?)-->)/gm,handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);match&&match.index===w.matchStart&&(w.nextMatch=this.lookahead.lastIndex)}}),Wikifier.Parser.add({name:"lineContinuation",profiles:["core"],match:"\\\\".concat(Patterns.spaceNoTerminator,"*\\n|\\n").concat(Patterns.spaceNoTerminator,"*\\\\|\\n?\\\\").concat(Patterns.spaceNoTerminator,"*$|^").concat(Patterns.spaceNoTerminator,"*\\\\\\n?"),handler:function(w){w.nextMatch=w.matchStart+w.matchLength}}),Wikifier.Parser.add({name:"lineBreak",profiles:["core"],match:"\\n",handler:function(w){w.options.nobr||jQuery(document.createElement("br")).appendTo(w.output)}}),Wikifier.Parser.add({name:"htmlCharacterReference",profiles:["core"],match:"(?:(?:&#?[0-9A-Za-z]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9A-Fa-f]|1D[C-Fc-f][0-9A-Fa-f]|20[D-Fd-f][0-9A-Fa-f]|FE2[0-9A-Fa-f])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[0-9A-Za-z]{2,8};)",handler:function(w){jQuery(document.createDocumentFragment()).append(w.matchText).appendTo(w.output)}}),Wikifier.Parser.add({name:"xmlProlog",profiles:["core"],match:"<\\?[Xx][Mm][Ll][^>]*\\?>",handler:function(w){w.nextMatch=w.matchStart+w.matchLength}}),Wikifier.Parser.add({name:"verbatimHtml",profiles:["core"],match:"<[Hh][Tt][Mm][Ll]>",lookahead:/<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/gm,handler:_verbatimTagHandler}),Wikifier.Parser.add({name:"verbatimScriptTag",profiles:["core"],match:"<[Ss][Cc][Rr][Ii][Pp][Tt][^>]*>",lookahead:/(<[Ss][Cc][Rr][Ii][Pp][Tt][^>]*>(?:.|\n)*?<\/[Ss][Cc][Rr][Ii][Pp][Tt]>)/gm,handler:_verbatimTagHandler}),Wikifier.Parser.add({name:"styleTag",profiles:["core"],match:"<[Ss][Tt][Yy][Ll][Ee][^>]*>",lookahead:/(<[Ss][Tt][Yy][Ll][Ee][^>]*>)((?:.|\n)*?)(<\/[Ss][Tt][Yy][Ll][Ee]>)/gm,imageMarkup:new RegExp(Patterns.cssImage,"g"),hasImageMarkup:new RegExp(Patterns.cssImage),handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);if(match&&match.index===w.matchStart){w.nextMatch=this.lookahead.lastIndex;var css=match[2];this.hasImageMarkup.test(css)&&(this.imageMarkup.lastIndex=0,css=css.replace(this.imageMarkup,(function(wikiImage){var markup=Wikifier.helpers.parseSquareBracketedMarkup({source:wikiImage,matchStart:0});if(Object.hasOwn(markup,"error")||markup.pos<wikiImage.length)return wikiImage;var source=Wikifier.helpers.evalPassageId(markup.source);if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(source=passage.text)}return'url("'.concat(source.replace(/"/g,"%22"),'")')}))),jQuery(document.createDocumentFragment()).append(match[1]+css+match[3]).appendTo(w.output)}}}),Wikifier.Parser.add({name:"svgTag",profiles:["core"],match:"<[Ss][Vv][Gg][^>]*>",lookahead:/<(\/?)[Ss][Vv][Gg][^>]*>/gm,namespace:"http://www.w3.org/2000/svg",handler:function(w){var _this11=this;this.lookahead.lastIndex=w.nextMatch;for(var match,depth=1;depth>0&&null!==(match=this.lookahead.exec(w.source));)depth+="/"===match[1]?-1:1;if(0===depth){w.nextMatch=this.lookahead.lastIndex;var svgTag=w.source.slice(w.matchStart,this.lookahead.lastIndex),$frag=jQuery(document.createDocumentFragment()).append(svgTag);$frag.find("a[data-passage],image[data-passage]").each((function(_,el){var tagName=el.tagName.toLowerCase();try{_this11.processAttributeDirectives(el)}catch(ex){return appendError(w.output,"svg|<".concat(tagName,">: ").concat(ex.message),"".concat(w.matchText,"…"))}el.hasAttribute("data-passage")&&_this11.processDataAttributes(el,tagName)})),$frag.appendTo(w.output)}},processAttributeDirectives:function(el){Array.from(el.attributes).forEach((function(_ref11){var name=_ref11.name,value=_ref11.value,evalShorthand="@"===name[0];if(evalShorthand||name.startsWith("sc-eval:")){var result,newName=name.slice(evalShorthand?1:8);if("data-setter"===newName)throw new Error('evaluation directive is not allowed on the data-setter attribute: "'.concat(name,'"'));try{result=Scripting.evalTwineScript(value)}catch(ex){throw new Error('bad evaluation from attribute directive "'.concat(name,'": ').concat(ex.message))}try{el.setAttribute(newName,result),el.removeAttribute(name)}catch(ex){throw new Error('cannot transform attribute directive "'.concat(name,'" into attribute "').concat(newName,'"'))}}}))},processDataAttributes:function(el,tagName){var passage=el.getAttribute("data-passage");if(null!=passage){var evaluated=Wikifier.helpers.evalPassageId(passage);if(evaluated!==passage&&(passage=evaluated,el.setAttribute("data-passage",evaluated)),""!==passage)if("image"===tagName)"data:"!==passage.slice(0,5)&&Story.has(passage)&&(passage=Story.get(passage)).tags.includes("Twine.image")&&el.setAttribute("href",passage.text.trim());else{var setFn,setter=el.getAttribute("data-setter");null!=setter&&""!==(setter=String(setter).trim())&&(setFn=Wikifier.helpers.shadowHandler(Scripting.desugar(setter))),Story.has(passage)?(el.classList.add("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&el.classList.add("link-visited")):el.classList.add("link-broken"),jQuery(el).ariaClick({one:!0},(function(){"function"==typeof setFn&&setFn.call(this),Engine.play(passage)}))}}}}),Wikifier.Parser.add({name:"htmlTag",profiles:["core"],match:"<".concat(Patterns.htmlTagName,"(?:\\s+[^\\u0000-\\u001F\\u007F-\\u009F\\s\"'>\\/=]+(?:\\s*=\\s*(?:\"[^\"]*?\"|'[^']*?'|[^\\s\"'=<>`]+))?)*\\s*\\/?>"),tagRe:new RegExp("^<(".concat(Patterns.htmlTagName,")")),mediaTags:["audio","img","source","track","video"],nobrTags:["audio","colgroup","datalist","dl","figure","meter","ol","optgroup","picture","progress","ruby","select","table","tbody","tfoot","thead","tr","ul","video"],voidTags:["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"],handler:function(w){var tagMatch=this.tagRe.exec(w.matchText),tag=tagMatch&&tagMatch[1],tagName=tag&&tag.toLowerCase();if(tagName){var terminator,terminatorMatch,isVoid=this.voidTags.includes(tagName)||w.matchText.endsWith("/>"),isNobr=this.nobrTags.includes(tagName);if(!isVoid){terminator="<\\/".concat(tagName,"\\s*>");var terminatorRe=new RegExp(terminator,"gim");terminatorRe.lastIndex=w.matchStart,terminatorMatch=terminatorRe.exec(w.source)}if(!isVoid&&!terminatorMatch)return appendError(w.output,"cannot find a closing tag for HTML <".concat(tag,">"),"".concat(w.matchText,"…"));var debugView,output=w.output,el=document.createElement(w.output.tagName);for(el.innerHTML=w.matchText;el.firstChild;)el=el.firstChild;try{this.processAttributeDirectives(el)}catch(ex){return appendError(w.output,"<".concat(tagName,">: ").concat(ex.message),"".concat(w.matchText,"…"))}if(el.hasAttribute("data-passage")){if(el.hasAttribute("href"))return appendError(w.output,"<".concat(tagName,'>: elements may not include both "data-passage" and "href" atttributes'),"".concat(w.matchText,"…"));this.processDataAttributes(el,tagName),Config.debug&&((debugView=new DebugView(w.output,"html-".concat(tagName),tagName,w.matchText)).modes({block:"img"===tagName,nonvoid:terminatorMatch}),output=debugView.output)}else el.hasAttribute("href")&&Wikifier.isExternalLink(el.getAttribute("href"))&&el.classList.add("link-external");if(terminatorMatch){try{Wikifier.Option.push({nobr:isNobr}),w.subWikify(el,terminator,{ignoreTerminatorCase:!0})}finally{Wikifier.Option.pop()}debugView&&jQuery(el).find(".debug.block").length>0&&debugView.modes({block:!0})}output.appendChild("track"===tagName?el.cloneNode(!0):el)}},processAttributeDirectives:function(el){Array.from(el.attributes).forEach((function(_ref12){var name=_ref12.name,value=_ref12.value,evalShorthand="@"===name[0];if(evalShorthand||name.startsWith("sc-eval:")){var result,newName=name.slice(evalShorthand?1:8);if("data-setter"===newName)throw new Error('evaluation directive is not allowed on the data-setter attribute: "'.concat(name,'"'));try{result=Scripting.evalTwineScript(value)}catch(ex){throw new Error('bad evaluation from attribute directive "'.concat(name,'": ').concat(ex.message))}try{el.setAttribute(newName,result),el.removeAttribute(name)}catch(ex){throw new Error('cannot transform attribute directive "'.concat(name,'" into attribute "').concat(newName,'"'))}}}))},processDataAttributes:function(el,tagName){var passage=el.getAttribute("data-passage");if(null!=passage){var evaluated=Wikifier.helpers.evalPassageId(passage);if(evaluated!==passage&&(passage=evaluated,el.setAttribute("data-passage",evaluated)),""!==passage)if(this.mediaTags.includes(tagName)){if("data:"!==passage.slice(0,5)&&Story.has(passage)){var parentName,twineTag;switch(passage=Story.get(passage),tagName){case"audio":case"video":twineTag="Twine.".concat(tagName);break;case"img":twineTag="Twine.image";break;case"track":twineTag="Twine.vtt";break;case"source":var $parent=$(el).closest("audio,picture,video");$parent.length>0&&(parentName=$parent.get(0).tagName.toLowerCase(),twineTag="Twine.".concat("picture"===parentName?"image":parentName))}passage.tags.includes(twineTag)&&(el["picture"===parentName?"srcset":"src"]=passage.text.trim())}}else{var setFn,setter=el.getAttribute("data-setter");null!=setter&&""!==(setter=String(setter).trim())&&(setFn=Wikifier.helpers.shadowHandler(Scripting.desugar(setter))),Story.has(passage)?(el.classList.add("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&el.classList.add("link-visited")):el.classList.add("link-broken"),jQuery(el).ariaClick({one:!0},(function(){"function"==typeof setFn&&setFn.call(this),Engine.play(passage)}))}}}})}();var Template=(_templates=new Map,_validNameRe=new RegExp("^(?:".concat(Patterns.templateName,")$")),_validType=function(template){var templateType=_typeof(template);return"function"===templateType||"string"===templateType},Object.preventExtensions(Object.create(null,{add:{value:function(name,template){if(!(_validType(template)||template instanceof Array&&template.length>0&&template.every(_validType)))throw new TypeError("invalid template type (".concat(name,"); templates must be: functions, strings, or an array of either"));(name instanceof Array?name:[name]).forEach((function(name){if(!_validNameRe.test(name))throw new Error('invalid template name "'.concat(name,'"'));if(_templates.has(name))throw new Error("cannot clobber existing template ?".concat(name));_templates.set(name,template)}))}},delete:{value:function(name){(name instanceof Array?name:[name]).forEach((function(name){return _templates.delete(name)}))}},get:{value:function(name){return _templates.has(name)?_templates.get(name):null}},has:{value:function(name){return _templates.has(name)}},size:{get:function(){return _templates.size}}}))),_templates,_validNameRe,_validType,Macro=function(){var _macros={},_tags={},_validNameRe=new RegExp("^(?:".concat(Patterns.macroName,")$"));function macrosHas(name){return Object.hasOwn(_macros,name)}function tagsRegister(parent,bodyTags){if(!parent)throw new Error("no parent specified");for(var endTags=["/".concat(parent),"end".concat(parent)],allTags=[].concat(endTags,Array.isArray(bodyTags)?bodyTags:[]),i=0;i<allTags.length;++i){var tag=allTags[i];if(macrosHas(tag))throw new Error("cannot register tag for an existing macro");tagsHas(tag)?_tags[tag].includes(parent)||(_tags[tag].push(parent),_tags[tag].sort()):_tags[tag]=[parent]}}function tagsUnregister(parent){if(!parent)throw new Error("no parent specified");Object.keys(_tags).forEach((function(tag){var i=_tags[tag].indexOf(parent);-1!==i&&(1===_tags[tag].length?delete _tags[tag]:_tags[tag].splice(i,1))}))}function tagsHas(name){return Object.hasOwn(_tags,name)}return Object.preventExtensions(Object.create(null,{add:{value:function macrosAdd(name,def){if(Array.isArray(name))name.forEach((function(name){return macrosAdd(name,def)}));else{if(!_validNameRe.test(name))throw new Error('invalid macro name "'.concat(name,'"'));if(macrosHas(name))throw new Error("cannot clobber existing macro <<".concat(name,">>"));if(tagsHas(name))throw new Error("cannot clobber child tag <<".concat(name,">> of parent macro").concat(1===_tags[name].length?"":"s"," <<").concat(_tags[name].join(">>, <<"),">>"));try{if("object"===_typeof(def))_macros[name]=Object.assign(Object.create(null),def,{_MACRO_API:!0});else{if(!macrosHas(def))throw new Error("cannot create alias of nonexistent macro <<".concat(def,">>"));_macros[name]=Object.create(_macros[def],{_ALIAS_OF:{enumerable:!0,value:def}})}Object.defineProperty(_macros,name,{writable:!1})}catch(ex){throw"TypeError"===ex.name?new Error("cannot clobber protected macro <<".concat(name,">>")):new Error("unknown error when attempting to add macro <<".concat(name,">>: [").concat(ex.name,"] ").concat(ex.message))}if(void 0!==_macros[name].tags)if(null==_macros[name].tags)tagsRegister(name);else{if(!Array.isArray(_macros[name].tags))throw new Error('bad value for "tags" property of macro <<'.concat(name,">>"));tagsRegister(name,_macros[name].tags)}}}},delete:{value:function macrosDelete(name){if(Array.isArray(name))name.forEach((function(name){return macrosDelete(name)}));else if(macrosHas(name)){void 0!==_macros[name].tags&&tagsUnregister(name);try{Object.defineProperty(_macros,name,{writable:!0}),delete _macros[name]}catch(ex){throw new Error("unknown error removing macro <<".concat(name,">>: ").concat(ex.message))}}else if(tagsHas(name))throw new Error("cannot remove child tag <<".concat(name,">> of parent macro <<").concat(_tags[name],">>"))}},isEmpty:{value:function(){return 0===Object.keys(_macros).length}},has:{value:macrosHas},get:{value:function(name){var macro=null;return macrosHas(name)&&"function"==typeof _macros[name].handler?macro=_macros[name]:Object.hasOwn(macros,name)&&"function"==typeof macros[name].handler&&(macro=macros[name]),macro}},init:{value:function(){var handler=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"init";Object.keys(_macros).forEach((function(name){"function"==typeof _macros[name][handler]&&_macros[name][handler](name)})),Object.keys(macros).forEach((function(name){"function"==typeof macros[name][handler]&&macros[name][handler](name)}))}},tags:{value:Object.preventExtensions(Object.create(null,{register:{value:tagsRegister},unregister:{value:tagsUnregister},has:{value:tagsHas},get:{value:function(name){return tagsHas(name)?_tags[name]:null}}}))},evalStatements:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}}}))}(),MacroContext=function(){var MacroContext=function(){return _createClass((function MacroContext(contextData){_classCallCheck(this,MacroContext);var context=Object.assign({parent:null,macro:null,name:"",displayName:"",args:null,payload:null,parser:null,source:""},contextData);if(null===context.macro||""===context.name||null===context.parser)throw new TypeError("context object missing required properties");Object.defineProperties(this,{self:{value:context.macro},name:{value:void 0===context.macro._ALIAS_OF?context.name:context.macro._ALIAS_OF},displayName:{value:context.name},args:{value:context.args},payload:{value:context.payload},source:{value:context.source},parent:{value:context.parent},parser:{value:context.parser},_output:{value:context.parser.output},_shadows:{writable:!0,value:null},_debugView:{writable:!0,value:null},_debugViewEnabled:{writable:!0,value:Config.debug}})}),[{key:"output",get:function(){return this._debugViewEnabled?this.debugView.output:this._output}},{key:"shadows",get:function(){return Array.from(this._shadows)}},{key:"shadowView",get:function(){for(var view=new Set,context=this;null!==context;context=context.parent)context._shadows&&context._shadows.forEach((function(name){return view.add(name)}));return Array.from(view)}},{key:"debugView",get:function(){return this._debugViewEnabled?null!==this._debugView?this._debugView:this.createDebugView():null}},{key:"contextFilter",value:function(predicate,thisArg){if("function"!=typeof predicate)throw new TypeError("<MacroContext>.contextFilter() predicate parameter must be a function");for(var result=[],context=this.parent;null!==context;context=context.parent)predicate.call(void 0===thisArg?this:thisArg,context)&&result.push(context);return result}},{key:"contextFind",value:function(predicate,thisArg){if("function"!=typeof predicate)throw new TypeError("<MacroContext>.contextFind() predicate parameter must be a function");for(var context=this.parent;null!==context;context=context.parent)if(predicate.call(void 0===thisArg?this:thisArg,context))return context}},{key:"contextSome",value:function(predicate,thisArg){if("function"!=typeof predicate)throw new TypeError("<MacroContext>.contextSome() predicate parameter must be a function");for(var context=this.parent;null!==context;context=context.parent)if(predicate.call(void 0===thisArg?this:thisArg,context))return!0;return!1}},{key:"addShadow",value:function(){var _this12=this;this._shadows||(this._shadows=new Set);for(var varRe=new RegExp("^".concat(Patterns.variable,"$")),_len14=arguments.length,names=new Array(_len14),_key14=0;_key14<_len14;_key14++)names[_key14]=arguments[_key14];names.flat(1/0).forEach((function(name){if("string"!=typeof name)throw new TypeError("variable name must be a string; type: ".concat(_typeof(name)));if(!varRe.test(name))throw new Error('invalid variable name "'.concat(name,'"'));_this12._shadows.add(name)}))}},{key:"shadowHandler",value:function(callback,doneCallback,startCallback){var shadowStore,shadowContext=this;return"function"==typeof callback&&(shadowStore=Object.create(null),this.shadowView.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey]}))),function(){for(var _len15=arguments.length,args=new Array(_len15),_key15=0;_key15<_len15;_key15++)args[_key15]=arguments[_key15];if("function"==typeof startCallback&&startCallback.apply(this,args),"function"==typeof callback){var contextCache,shadowNames=Object.keys(shadowStore),valueCache=shadowNames.length>0?{}:null,macroParser=Wikifier.Parser.get("macro");try{shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;Object.hasOwn(store,varKey)&&(valueCache[varKey]=store[varKey]),store[varKey]=shadowStore[varName]})),contextCache=macroParser.context,macroParser.context=shadowContext,callback.apply(this,args)}finally{contextCache!==undefined&&(macroParser.context=contextCache),shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey],Object.hasOwn(valueCache,varKey)?store[varKey]=valueCache[varKey]:delete store[varKey]}))}}"function"==typeof doneCallback&&doneCallback.apply(this,args)}}},{key:"createDebugView",value:function(name,title){return this._debugView=new DebugView(this._output,"macro",name||this.displayName,title||this.source),null!==this.payload&&this.payload.length>0&&this._debugView.modes({nonvoid:!0}),this._debugViewEnabled=!0,this._debugView}},{key:"removeDebugView",value:function(){null!==this._debugView&&(this._debugView.remove(),this._debugView=null),this._debugViewEnabled=!1}},{key:"error",value:function(message,source){return appendError(this._output,"<<".concat(this.displayName,">>: ").concat(message),source||this.source)}}])}();return Object.defineProperties(MacroContext.prototype,{contextHas:{value:function(){console.warn("[DEPRECATED] <MacroContext>.contextHas() is deprecated.");for(var _len16=arguments.length,args=new Array(_len16),_key16=0;_key16<_len16;_key16++)args[_key16]=arguments[_key16];return MacroContext.prototype.contextSome.apply(this,args)}},contextSelect:{value:function(){console.warn("[DEPRECATED] <MacroContext>.contextSelect() is deprecated.");for(var _len17=arguments.length,args=new Array(_len17),_key17=0;_key17<_len17;_key17++)args[_key17]=arguments[_key17];return MacroContext.prototype.contextFind.apply(this,args)}},contextSelectAll:{value:function(){console.warn("[DEPRECATED] <MacroContext>.contextSelectAll() is deprecated.");for(var _len18=arguments.length,args=new Array(_len18),_key18=0;_key18<_len18;_key18++)args[_key18]=arguments[_key18];return MacroContext.prototype.contextFilter.apply(this,args)}},createShadowWrapper:{value:function(){console.warn("[DEPRECATED] <MacroContext>.createShadowWrapper() is deprecated.");for(var _len19=arguments.length,args=new Array(_len19),_key19=0;_key19<_len19;_key19++)args[_key19]=arguments[_key19];return MacroContext.prototype.shadowHandler.apply(this,args)}}}),MacroContext}();Macro.add(["addclass","toggleclass"],{handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("selector"),this.args.length<2&&errors.push("class names"),this.error("no ".concat(errors.join(" or ")," specified"))}var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));switch(this.name){case"addclass":$targets.addClass(this.args[1].trim());break;case"toggleclass":$targets.toggleClass(this.args[1].trim())}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["append","prepend","replace"],{tags:null,t8nRe:/^(?:transition|t8n)$/,handler:function(){var _this13=this;if(0===this.args.length)return this.error("no selector specified");var $insert,$targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));if(""!==this.payload[0].contents)switch(this.args.length>1&&this.self.t8nRe.test(this.args[1])?(($insert=jQuery(document.createElement("span"))).addClass("macro-".concat(this.name,"-insert macro-").concat(this.name,"-in")),setTimeout((function(){return $insert.removeClass("macro-".concat(_this13.name,"-in"))}),Engine.DOM_DELAY)):$insert=jQuery(document.createDocumentFragment()),$insert.wiki(this.payload[0].contents),this.name){case"replace":$targets.empty();case"append":$targets.append($insert);break;case"prepend":$targets.prepend($insert)}else"replace"===this.name&&$targets.empty();Config.debug&&this.debugView.modes({hidden:!0})}}),function(){if(Has.audio){var errorOnePlaybackAction=function(cur,prev){return'only one playback action allowed per invocation, "'.concat(cur,'" cannot be combined with "').concat(prev,'"')};Macro.add("audio",{handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("track and/or group IDs"),this.args.length<2&&errors.push("actions"),this.error("no ".concat(errors.join(" or ")," specified"))}var selected;try{selected=SimpleAudio.select(this.args[0])}catch(ex){return this.error(ex.message)}for(var action,fadeTo,loop,mute,passage,time,volume,args=this.args.slice(1),fadeOver=5;args.length>0;){var arg=args.shift(),raw=void 0;switch(arg){case"load":case"pause":case"play":case"stop":case"unload":if(action)return this.error(errorOnePlaybackAction(arg,action));action=arg;break;case"fadein":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=1;break;case"fadeout":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=0;break;case"fadeto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(0===args.length)return this.error("fadeto missing required level value");if(action="fade",raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeto: ".concat(raw));break;case"fadeoverto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(args.length<2){var _errors=[];return args.length<1&&_errors.push("seconds"),args.length<2&&_errors.push("level"),this.error("fadeoverto missing required ".concat(_errors.join(" and ")," value").concat(_errors.length>1?"s":""))}if(action="fade",raw=args.shift(),fadeOver=Number.parseFloat(raw),Number.isNaN(fadeOver)||!Number.isFinite(fadeOver))return this.error("cannot parse fadeoverto: ".concat(raw));if(raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeoverto: ".concat(raw));break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),volume=Number.parseFloat(raw),Number.isNaN(volume)||!Number.isFinite(volume))return this.error("cannot parse volume: ".concat(raw));break;case"mute":case"unmute":mute="mute"===arg;break;case"time":if(0===args.length)return this.error("time missing required seconds value");if(raw=args.shift(),time=Number.parseFloat(raw),Number.isNaN(time)||!Number.isFinite(time))return this.error("cannot parse time: ".concat(raw));break;case"loop":case"unloop":loop="loop"===arg;break;case"goto":if(0===args.length)return this.error("goto missing required passage title");if(raw=args.shift(),passage="object"===_typeof(raw)?raw.link:raw,!Story.has(passage))return this.error('passage "'.concat(passage,'" does not exist'));break;default:return this.error("unknown action: ".concat(arg))}}try{if(null!=volume&&selected.volume(volume),null!=time&&selected.time(time),null!=mute&&selected.mute(mute),null!=loop&&selected.loop(loop),null!=passage){var nsEnded="ended.macros.macro-".concat(this.name,"_goto");selected.off(nsEnded).one(nsEnded,(function(){selected.off(nsEnded),Engine.play(passage)}))}switch(action){case"fade":selected.fade(fadeOver,fadeTo);break;case"load":selected.load();break;case"pause":selected.pause();break;case"play":selected.playWhenAllowed();break;case"stop":selected.stop();break;case"unload":selected.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error("error executing action: ".concat(ex.message))}}}),Macro.add("cacheaudio",{handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("track ID"),this.args.length<2&&errors.push("sources"),this.error("no ".concat(errors.join(" or ")," specified"))}var id=String(this.args[0]).trim();try{SimpleAudio.tracks.add(id,this.args.slice(1))}catch(ex){return this.error(ex.message)}if(Config.debug&&!SimpleAudio.tracks.get(id).hasSource())return this.error('track ID "'.concat(id,'": no supported audio sources found'));Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("createaudiogroup",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no group ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var groupId=String(this.args[0]).trim(),trackIds=[],i=1,len=this.payload.length;i<len;++i){if(this.payload[i].args.length<1)return this.error("no track ID specified");trackIds.push(String(this.payload[i].args[0]).trim()),Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.groups.add(groupId,trackIds)}catch(ex){return this.error(ex.message)}Config.debug&&this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!0})}}),Macro.add("createplaylist",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no list ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var listId=String(this.args[0]).trim(),trackObjs=[],i=1,len=this.payload.length;i<len;++i){if(0===this.payload[i].args.length)return this.error("no track ID specified");for(var trackObj={id:String(this.payload[i].args[0]).trim()},args=this.payload[i].args.slice(1);args.length>0;){var arg=args.shift(),raw=void 0,parsed=void 0;switch(arg){case"own":trackObj.own=!0;break;case"rate":args.length>0&&args.shift();break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),parsed=Number.parseFloat(raw),Number.isNaN(parsed)||!Number.isFinite(parsed))return this.error("cannot parse volume: ".concat(raw));trackObj.volume=parsed;break;default:return this.error("unknown action: ".concat(arg))}}trackObjs.push(trackObj),Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.lists.add(listId,trackObjs)}catch(ex){return this.error(ex.message)}Config.debug&&this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!0})}}),Macro.add("masteraudio",{handler:function(){if(0===this.args.length)return this.error("no actions specified");for(var action,mute,muteOnHide,volume,args=this.args.slice(0);args.length>0;){var arg=args.shift(),raw=void 0;switch(arg){case"load":case"stop":case"unload":if(action)return this.error(errorOnePlaybackAction(arg,action));action=arg;break;case"mute":case"unmute":mute="mute"===arg;break;case"muteonhide":case"nomuteonhide":muteOnHide="muteonhide"===arg;break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),volume=Number.parseFloat(raw),Number.isNaN(volume)||!Number.isFinite(volume))return this.error("cannot parse volume: ".concat(raw));break;default:return this.error("unknown action: ".concat(arg))}}try{switch(null!=mute&&SimpleAudio.mute(mute),null!=muteOnHide&&SimpleAudio.muteOnHidden(muteOnHide),null!=volume&&SimpleAudio.volume(volume),action){case"load":SimpleAudio.load();break;case"stop":SimpleAudio.stop();break;case"unload":SimpleAudio.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error("error executing action: ".concat(ex.message))}}}),Macro.add("playlist",{handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("list ID"),this.args.length<2&&errors.push("actions"),this.error("no ".concat(errors.join(" or ")," specified"))}var id=String(this.args[0]).trim();if(!SimpleAudio.lists.has(id))return this.error('playlist "'.concat(id,'" does not exist'));for(var action,fadeTo,loop,mute,shuffle,volume,list=SimpleAudio.lists.get(id),args=this.args.slice(1),fadeOver=5;args.length>0;){var arg=args.shift(),raw=void 0;switch(arg){case"load":case"pause":case"play":case"skip":case"stop":case"unload":if(action)return this.error(errorOnePlaybackAction(arg,action));action=arg;break;case"fadein":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=1;break;case"fadeout":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=0;break;case"fadeto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(0===args.length)return this.error("fadeto missing required level value");if(action="fade",raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeto: ".concat(raw));break;case"fadeoverto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(args.length<2){var _errors2=[];return args.length<1&&_errors2.push("seconds"),args.length<2&&_errors2.push("level"),this.error("fadeoverto missing required ".concat(_errors2.join(" and ")," value").concat(_errors2.length>1?"s":""))}if(action="fade",raw=args.shift(),fadeOver=Number.parseFloat(raw),Number.isNaN(fadeOver)||!Number.isFinite(fadeOver))return this.error("cannot parse fadeoverto: ".concat(raw));if(raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeoverto: ".concat(raw));break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),volume=Number.parseFloat(raw),Number.isNaN(volume)||!Number.isFinite(volume))return this.error("cannot parse volume: ".concat(raw));break;case"mute":case"unmute":mute="mute"===arg;break;case"loop":case"unloop":loop="loop"===arg;break;case"shuffle":case"unshuffle":shuffle="shuffle"===arg;break;default:return this.error("unknown action: ".concat(arg))}}try{switch(null!=volume&&list.volume(volume),null!=mute&&list.mute(mute),null!=loop&&list.loop(loop),null!=shuffle&&list.shuffle(shuffle),action){case"fade":list.fade(fadeOver,fadeTo);break;case"load":list.load();break;case"pause":list.pause();break;case"play":list.playWhenAllowed();break;case"skip":list.skip();break;case"stop":list.stop();break;case"unload":list.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error("error executing action: ".concat(ex.message))}}}),Macro.add("removeaudiogroup",{handler:function(){if(0===this.args.length)return this.error("no group ID specified");var id=String(this.args[0]).trim();if(!SimpleAudio.groups.has(id))return this.error('group "'.concat(id,'" does not exist'));SimpleAudio.groups.delete(id),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeplaylist",{handler:function(){if(0===this.args.length)return this.error("no list ID specified");var id=String(this.args[0]).trim();if(!SimpleAudio.lists.has(id))return this.error('playlist "'.concat(id,'" does not exist'));SimpleAudio.lists.delete(id),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("waitforaudio",{skipArgs:!0,handler:function(){SimpleAudio.loadWithScreen()}})}else Macro.add(["audio","cacheaudio","createaudiogroup","createplaylist","masteraudio","playlist","removeaudiogroup","removeplaylist","waitforaudio"],{skipArgs:!0,handler:function(){Config.debug&&this.debugView.modes({hidden:!0})}})}(),Macro.add(["back","return"],{handler:function(){var passage,content,$link,momentIndex=-1;if(this.args.length>0)if("object"===_typeof(this.args[0]))if(this.args[0].isImage){content=document.createElement("img");var $image=jQuery(content).attr("src",this.args[0].source);Object.hasOwn(this.args[0],"passage")&&$image.attr("data-passage",this.args[0].passage),Object.hasOwn(this.args[0],"title")&&$image.attr("title",this.args[0].title),Object.hasOwn(this.args[0],"align")&&$image.attr("align",this.args[0].align),Object.hasOwn(this.args[0],"link")&&(passage=this.args[0].link)}else content=document.createTextNode(this.args[0].text),passage=this.args[0].link;else{content=document.createDocumentFragment();var forbidden=jQuery(content).wikiWithOptions({cleanup:!1,profile:"core"},this.args[0]).getForbiddenInteractiveContentTagNames();if(forbidden.length>0)throw new Error("text content contains restricted elements: <".concat(forbidden.join(">, <"),">"));passage=this.args.length>1?this.args[1]:undefined}if(null==passage){for(var i=State.length-2;i>=0;--i)if(State.history[i].title!==State.passage){momentIndex=i,passage=State.history[i].title;break}if(null==passage&&"return"===this.name)for(var _i6=State.expired.length-1;_i6>=0;--_i6)if(State.expired[_i6]!==State.passage){passage=State.expired[_i6];break}}else{if(!Story.has(passage))return this.error('passage "'.concat(passage,'" does not exist'));if("back"===this.name){for(var _i7=State.length-2;_i7>=0;--_i7)if(State.history[_i7].title===passage){momentIndex=_i7;break}if(-1===momentIndex)return this.error('cannot find passage "'.concat(passage,'" in the current story history'))}}if(null==passage)return this.error("cannot find passage");"back"!==this.name||-1!==momentIndex?($link=jQuery(document.createElement("a")).addClass("link-internal").ariaClick({one:!0},"return"===this.name?function(){return Engine.play(passage)}:function(){return Engine.goTo(momentIndex)}),content instanceof HTMLImageElement&&$link.addClass("link-image")):$link=jQuery(document.createElement("span")).addClass("link-disabled"),$link.addClass("macro-".concat(this.name)).append(content||document.createTextNode(L10n.get("macro".concat(this.name.toUpperFirst(),"Text")))).appendTo(this.output)}}),Macro.add(["button","link"],{isAsync:!0,tags:null,handler:function(){var _this14=this;if(0===this.args.length)return this.error("no ".concat("button"===this.name?"button":"link"," text specified"));var passage,$link=jQuery(document.createElement("button"===this.name?"button":"a"));if("object"===_typeof(this.args[0]))if(this.args[0].isImage){var $image=jQuery(document.createElement("img")).attr("src",this.args[0].source).appendTo($link);$link.addClass("link-image"),Object.hasOwn(this.args[0],"passage")&&$image.attr("data-passage",this.args[0].passage),Object.hasOwn(this.args[0],"title")&&$image.attr("title",this.args[0].title),Object.hasOwn(this.args[0],"align")&&$image.attr("align",this.args[0].align),passage=this.args[0].link}else $link.append(document.createTextNode(this.args[0].text)),passage=this.args[0].link;else{var $frag=jQuery(document.createDocumentFragment()).wikiWithOptions({cleanup:!1,profile:"core"},this.args[0]),forbidden=$frag.getForbiddenInteractiveContentTagNames();if(forbidden.length>0)throw new Error("text content contains restricted elements: <".concat(forbidden.join(">, <"),">"));$link.append($frag),passage=this.args.length>1?this.args[1]:undefined}null!=passage?($link.attr("data-passage",passage),Story.has(passage)?($link.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&$link.addClass("link-visited")):$link.addClass("link-broken")):$link.addClass("link-internal"),$link.addClass("macro-".concat(this.name)).ariaClick({namespace:".macros",role:null!=passage?"link":"button",one:null!=passage},this.shadowHandler(""!==this.payload[0].contents?function(){return Wikifier.wikifyEval(_this14.payload[0].contents.trim())}:null,null!=passage?function(){return Engine.play(passage)}:null)).appendTo(this.output)}}),Macro.add("capture",{skipArgs:!0,tags:null,tsVarRe:new RegExp("(".concat(Patterns.variable,")"),"g"),handler:function(){if(0===this.args.raw.length)return this.error("no story/temporary variable list specified");var valueCache={};try{for(var match,tsVarRe=this.self.tsVarRe;null!==(match=tsVarRe.exec(this.args.raw));){var varName=match[1],varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;Object.hasOwn(store,varKey)&&(valueCache[varKey]=store[varKey]),this.addShadow(varName)}new Wikifier(this.output,this.payload[0].contents)}finally{this.shadows.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;Object.hasOwn(valueCache,varKey)?store[varKey]=valueCache[varKey]:delete store[varKey]}))}}}),Macro.add("checkbox",{isAsync:!0,handler:function(){if(this.args.length<3){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("unchecked value"),this.args.length<3&&errors.push("checked value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));var varId=createSlug(varName),uncheckValue=this.args[1],checkValue=this.args[2],el=document.createElement("input");switch(jQuery(el).attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),type:"checkbox",tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.shadowHandler((function(){State.setVar(varName,this.checked?checkValue:uncheckValue)}))).appendTo(this.output),this.args[3]){case"autocheck":State.getVar(varName)===checkValue?el.checked=!0:State.setVar(varName,uncheckValue);break;case"checked":el.checked=!0,State.setVar(varName,checkValue);break;default:State.setVar(varName,uncheckValue)}}}),Macro.add("copy",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));jQuery(this.output).append($targets.html()),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["cycle","listbox"],{isAsync:!0,skipArgs:["optionsfrom"],tags:["option","optionsfrom"],handler:function(){var _this15=this;if(0===this.args.length)return this.error("no variable name specified");if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));var varId=createSlug(varName),len=this.payload.length;if(1===len)return this.error("no options specified");for(var config={autoselect:!1,once:!1},i=1;i<this.args.length;++i){var arg=this.args[i];switch(arg){case"once":config.once=!0;break;case"autoselect":config.autoselect=!0;break;default:return this.error("unknown argument: ".concat(arg))}}for(var _ret,options=[],tagCount={option:0,optionsfrom:0},index=-1,_loop6=function(){var payload=_this15.payload[_i8];if("option"===payload.name){if(++tagCount.option,0===payload.args.length)return{v:_this15.error("no arguments specified for <<".concat(payload.name,">> (#").concat(tagCount.option,")"))};var option={label:String(payload.args[0])},isSelected=!1;switch(payload.args.length){case 1:option.value=payload.args[0];break;case 2:"selected"===payload.args[1]?(option.value=payload.args[0],isSelected=!0):option.value=payload.args[1];break;default:option.value=payload.args[1],"selected"===payload.args[2]&&(isSelected=!0)}if(options.push(option),isSelected){if(config.autoselect)return{v:_this15.error("cannot specify both the autoselect and selected keywords")};if(-1!==index)return{v:_this15.error("multiple selected keywords specified for <<".concat(payload.name,">> (#").concat(index+1," & #").concat(tagCount.option,")"))};index=options.length-1}}else{if(++tagCount.optionsfrom,0===payload.args.full.length)return{v:_this15.error("no expression specified for <<".concat(payload.name,">> (#").concat(tagCount.optionsfrom,")"))};var result;try{var exp=payload.args.full;result=Scripting.evalJavaScript("{"===exp[0]?"(".concat(exp,")"):exp)}catch(ex){return{v:_this15.error("bad evaluation: ".concat(getErrorMessage(ex)))}}if("object"!==_typeof(result)||null===result)return{v:_this15.error("expression must yield a supported collection or generic object (type: ".concat(null===result?"null":_typeof(result),")"))};if(result instanceof Array||result instanceof Set)result.forEach((function(val){return options.push({label:String(val),value:val})}));else if(result instanceof Map)result.forEach((function(val,key){return options.push({label:String(key),value:val})}));else{var oType=getToStringTag(result);if("Object"!==oType)return{v:_this15.error("expression must yield a supported collection or generic object (object type: ".concat(oType,")"))};Object.keys(result).forEach((function(key){return options.push({label:key,value:result[key]})}))}}},_i8=1;_i8<len;++_i8)if(_ret=_loop6())return _ret.v;if(-1===index)if(config.autoselect){var curValue=State.getVar(varName),curValueIndex=options.findIndex((function(opt){return sameValueZero(opt.value,curValue)}));index=-1===curValueIndex?0:curValueIndex}else index=0;if("cycle"===this.name){var lastIndex=options.length-1;if(config.once&&index===lastIndex)jQuery(this.output).wikiWithOptions({cleanup:!1,profile:"core"},options[index].label);else{var cycleIndex=index;jQuery(document.createElement("a")).wikiWithOptions({cleanup:!1,profile:"core"},options[index].label).attr("id","".concat(this.name,"-").concat(varId)).addClass("macro-".concat(this.name)).ariaClick({namespace:".macros",role:"button"},this.shadowHandler((function(){var $this=$(this);cycleIndex=(cycleIndex+1)%options.length,State.setVar(varName,options[cycleIndex].value),$this.empty().wikiWithOptions({cleanup:!1,profile:"core"},options[cycleIndex].label),config.once&&cycleIndex===lastIndex&&$this.off().contents().unwrap()}))).appendTo(this.output)}}else{var $select=jQuery(document.createElement("select"));options.forEach((function(opt,i){jQuery(document.createElement("option")).val(i).text(opt.label).appendTo($select)})),$select.attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),tabindex:0}).addClass("macro-".concat(this.name)).val(index).on("change.macros",this.shadowHandler((function(){State.setVar(varName,options[Number(this.value)].value)}))).appendTo(this.output)}State.setVar(varName,options[index].value)}}),jQuery(document).on(":redo",(function(ev){var evTags=ev.detail&&ev.detail.tags||[],selector=0===evTags.length?".".concat("redo-target"):evTags.map((function(tag){return".".concat("redo-target",'[data-do-tags~="').concat(tag,'"]')})).join(", ");triggerEvent(":redo-internal",jQuery(selector),{bubbles:!1,detail:ev.detail})})),Macro.add("do",{tags:null,handler:function(){for(var elTag="span",tags=[],options=this.args.slice();options.length>0;){var option=options.shift();switch(option){case"tag":if(0===options.length)return this.error("tag option missing required tag name(s)");var raw=String(options.shift()).trim();if(""===raw)throw new Error("tag option tag name(s) must be non-empty");tags=String(raw).trim().splitOrEmpty(/\s+/);break;case"element":if(0===options.length)return this.error("element option missing required element tag name");if(""===(elTag=String(options.shift()).trim()))throw new Error("element option tag name must be non-empty");break;default:return this.error("unknown option: ".concat(option))}}var contents=this.payload[0].contents;if(""!==contents.trim()){Config.debug&&this.debugView.modes({block:"span"!==elTag});var $target=jQuery(document.createElement(elTag)).addClass("macro-".concat(this.name," ").concat("redo-target")).attr("data-do-tags",tags.join(" ")).wiki(contents).on(":redo-internal",jQuery.throttle(Engine.DOM_DELAY,this.shadowHandler((function(){var frag=document.createDocumentFragment();new Wikifier(frag,contents),$target.empty().append(frag)})))).appendTo(this.output)}}}),Macro.add("redo",{handler:function(){var failRE=/^(?:do|for)$/,passRE=/^(?:button|link(?:append|prepend|replace)?)$/,closest=this.contextFind((function(ctx){return failRE.test(ctx.name)||passRE.test(ctx.name)}));if(closest&&failRE.test(closest.name))return this.error("must not be used directly within macro <<".concat(closest.name,">>"));var tags=this.args.length>0?String(this.args[0]).trim().splitOrEmpty(/\s+/):[];triggerEvent(":redo",document,{detail:{tags:tags}})}}),Macro.add("done",{skipArgs:!0,tags:null,handler:function(){var contents=this.payload[0].contents.trim();""!==contents&&setTimeout(this.shadowHandler((function(){return $.wiki(contents)})),Engine.DOM_DELAY)}}),Macro.add("for",{skipArgs:!0,tags:null,isRangeRe:new RegExp("^(?:\\S".concat(Patterns.anyChar,"*?\\s+)?range\\s+\\S").concat(Patterns.anyChar,"*?$")),rangeRe:new RegExp("^(?:(?:State\\.(variables|temporary)\\.(".concat(Patterns.identifier,")\\s*,\\s*)?State\\.(variables|temporary)\\.(").concat(Patterns.identifier,")\\s+)?range\\s+(\\S").concat(Patterns.anyChar,"*?)$")),threePartRe:/^([^;]*?)\s*;\s*([^;]*?)\s*;\s*([^;]*?)$/,forInRe:/^\S+\s+in\s+\S+/i,forOfRe:/^\S+\s+of\s+\S+/i,handler:function(){var argsStr=this.args.full.trim(),payload=this.payload[0].contents.replace(/\n$/,"");if(0===argsStr.length)this.self.handleFor.call(this,payload,null,!0,null);else if(this.self.isRangeRe.test(argsStr)){var parts=argsStr.match(this.self.rangeRe);if(null===parts)return this.error("invalid range form syntax, format: [[index ,] value] range collection");this.self.handleForRange.call(this,payload,{type:parts[1],name:parts[2]},{type:parts[3],name:parts[4]},parts[5])}else{var init,condition,post;if(-1===argsStr.indexOf(";")){if(this.self.forInRe.test(argsStr))return this.error("invalid syntax, for…in is not supported; see: for…range");if(this.self.forOfRe.test(argsStr))return this.error("invalid syntax, for…of is not supported; see: for…range");condition=argsStr}else{var _parts=argsStr.match(this.self.threePartRe);if(null===_parts)return this.error("invalid 3-part conditional form syntax, format: [init] ; [condition] ; [post]");init=_parts[1],condition=_parts[2].trim(),post=_parts[3],0===condition.length&&(condition=!0)}this.self.handleFor.call(this,payload,init,condition,post)}},handleFor:function(payload,init,condition,post){var evalJavaScript=Scripting.evalJavaScript,first=!0,safety=Config.macros.maxLoopIterations;Config.debug&&this.debugView.modes({block:!0});try{if(TempState.break=null,init)try{evalJavaScript(init)}catch(ex){return this.error("bad init expression: ".concat(getErrorMessage(ex)))}for(;evalJavaScript(condition);){if(--safety<0)return this.error("exceeded configured maximum loop iterations (".concat(Config.macros.maxLoopIterations,")"));if(new Wikifier(this.output,first?payload.replace(/^\n/,""):payload),first&&(first=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}if(post)try{evalJavaScript(post)}catch(ex){return this.error("bad post expression: ".concat(getErrorMessage(ex)))}}}catch(ex){return this.error("bad conditional expression: ".concat(getErrorMessage(ex)))}finally{TempState.break=null}},handleForRange:function(payload,keyVar,valueVar,rangeExp){var rangeable,first=!0;try{rangeable=this.self.toRangeable(rangeExp)}catch(ex){return this.error(ex.message)}Config.debug&&this.debugView.modes({block:!0});try{for(TempState.break=null;;){var entry=rangeable.next();if(entry.done)break;if(keyVar.name&&(State[keyVar.type][keyVar.name]=entry.key),valueVar.name&&(State[valueVar.type][valueVar.name]=entry.value),new Wikifier(this.output,first?payload.replace(/^\n/,""):payload),first&&(first=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}}}catch(ex){return this.error(getErrorMessage(ex))}finally{TempState.break=null}},toRangeable:function(rangeExp){var collection;try{collection=Scripting.evalJavaScript("{"===rangeExp[0]?"(".concat(rangeExp,")"):rangeExp)}catch(ex){if("object"!==_typeof(ex))throw new Error("bad range expression: ".concat(ex));throw ex.message="bad range expression: ".concat(ex.message),ex}switch(_typeof(collection)){case"number":if(Number.isNaN(collection)||!Number.isFinite(collection))throw new Error("unsupported range expression type: ".concat(stringFrom(collection)));if(!Number.isInteger(collection))throw new Error("unsupported range expression type: floating-point number");if(!Number.isSafeInteger(collection))throw new Error("unsupported range expression type: unsafe integer");return collection<=0?{next:function(){return{done:!0}}}:{end:collection,pos:0,next:function(){if(this.pos<this.end){var key=this.pos++;return{key:key,value:key,done:!1}}return{done:!0}}};case"string":return{list:collection,end:collection.length,pos:0,next:function(){if(this.pos<this.end){var O=charAndPosAt(this.list,this.pos),key=this.pos;return this.pos=O.end+1,{key:key,value:O.char,done:!1}}return{done:!0}}};case"object":if(collection instanceof Array)return{list:collection,end:collection.length,pos:0,next:function(){if(this.pos<this.end){var key=this.pos++;return{key:key,value:this.list[key],done:!1}}return{done:!0}}};if(collection instanceof Set)return{list:collection=Array.from(collection),end:collection.length,pos:0,next:function(){if(this.pos<this.end){var key=this.pos++;return{key:key,value:this.list[key],done:!1}}return{done:!0}}};if(collection instanceof Map){var keys=Array.from(collection.keys());return{keys:keys,list:collection,end:keys.length,pos:0,next:function(){if(this.pos<this.end){var key=this.keys[this.pos++];return{key:key,value:this.list.get(key),done:!1}}return{done:!0}}}}if("Object"===getToStringTag(collection)){var _keys=Object.keys(collection);return{keys:_keys,list:collection,end:_keys.length,pos:0,next:function(){if(this.pos<this.end){var key=this.keys[this.pos++];return{key:key,value:this.list[key],done:!1}}return{done:!0}}}}throw new Error("unsupported range expression type: ".concat(getToStringTag(collection)));default:throw new Error("unsupported range expression type: ".concat(_typeof(collection)))}}}),Macro.add(["break","continue"],{skipArgs:!0,handler:function(){if(!this.contextSome((function(ctx){return"for"===ctx.name})))return this.error("must only be used in conjunction with its parent macro <<for>>");TempState.break="continue"===this.name?1:2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("goto",{handler:function(){return 0===this.args.length?this.error("no passage specified"):(passage="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],Story.has(passage)?void setTimeout((function(){return Engine.play(passage)}),Engine.DOM_DELAY):this.error('passage "'.concat(passage,'" does not exist')));var passage}}),Macro.add("if",{skipArgs:!0,tags:["elseif","else"],isElseifWsRE:/^\s*if\b/i,isAssignRE:/[^!%&*+\-/<=>?^|]=[^=>]/,isLiteralRE:new RegExp(["(?:\"\"|''|``)",'(?:"(?:\\\\.|[^"\\\\])+")',"(?:'(?:\\\\.|[^'\\\\])+')","(?:`(?:\\\\.|[^`\\\\])+`)"].join("|"),"g"),handler:function(){var i;try{var len=this.payload.length,isElseifWsRE=this.self.isElseifWsRE,isAssignRE=this.self.isAssignRE,isLiteralRE=this.self.isLiteralRE;for(i=0;i<len;++i)if("else"===this.payload[i].name){if(this.payload[i].args.raw.length>0)return isElseifWsRE.test(this.payload[i].args.raw)?this.error('whitespace is not allowed between the "else" and "if" in <<elseif>> clause'.concat(i>0?" (#".concat(i,")"):"")):this.error("<<else>> does not accept a conditional expression (perhaps you meant to use <<elseif>>), invalid: ".concat(this.payload[i].args.raw));if(i+1!==len)return this.error("<<else>> must be the final clause")}else{if(0===this.payload[i].args.full.length)return this.error("no conditional expression specified for <<".concat(this.payload[i].name,">> clause").concat(i>0?" (#".concat(i,")"):""));if((Config.debug||Config.enableOptionalDebugging)&&isAssignRE.test(this.payload[i].args.full.replace(isLiteralRE,"")))return this.error("assignment operator found within <<".concat(this.payload[i].name,">> clause").concat(i>0?" (#".concat(i,")"):""," (perhaps you meant to use an equality operator: ==, ===, eq, is), invalid: ").concat(this.payload[i].args.raw))}var evalJavaScript=Scripting.evalJavaScript,success=!1;for(i=0;i<len;++i){if(Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1}),"else"===this.payload[i].name||evalJavaScript(this.payload[i].args.full)){success=!0,new Wikifier(this.output,this.payload[i].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++i;i<len;++i)this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0,invalid:!0});this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!success,invalid:!success})}}catch(ex){return this.error("bad conditional expression in <<".concat(0===i?"if":"elseif",">> clause").concat(i>0?" (#".concat(i,")"):"",": ").concat(getErrorMessage(ex)))}}}),Macro.add("include",{handler:function(){return"display"===this.name&&console.warn("[DEPRECATED] <<".concat(this.name,">> macro is deprecated.")),0===this.args.length?this.error("no passage specified"):(passage="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],Story.has(passage)?(Config.debug&&this.debugView.modes({block:!0}),passage=Story.get(passage),void(this.args[1]?jQuery(document.createElement(this.args[1])).addClass("".concat(passage.id," macro-").concat(this.name)).attr("data-passage",passage.name).appendTo(this.output):jQuery(this.output)).wiki(passage.processText())):this.error('passage "'.concat(passage,'" does not exist')));var passage}}),Macro.add(["linkappend","linkprepend","linkreplace"],{isAsync:!0,tags:null,t8nRe:/^(?:transition|t8n)$/,handler:function(){var _this16=this;if(0===this.args.length)return this.error("no link text specified");var $link=jQuery(document.createElement("a")),$insert=jQuery(document.createElement("span")),transition=this.args.length>1&&this.self.t8nRe.test(this.args[1]);$link.wikiWithOptions({cleanup:!1,profile:"core"},this.args[0]).addClass("link-internal macro-".concat(this.name)).ariaClick({namespace:".macros",one:!0},this.shadowHandler((function(){if("linkreplace"===_this16.name?$link.remove():$link.wrap('<span class="macro-'.concat(_this16.name,'"></span>')).replaceWith((function(){return $link.html()})),""!==_this16.payload[0].contents){var frag=document.createDocumentFragment();new Wikifier(frag,_this16.payload[0].contents,{cleanup:!1}),$insert.append(frag)}transition&&setTimeout((function(){return $insert.removeClass("macro-".concat(_this16.name,"-in"))}),Engine.DOM_DELAY)}))).appendTo(this.output),$insert.addClass("macro-".concat(this.name,"-insert")),transition&&$insert.addClass("macro-".concat(this.name,"-in")),"linkprepend"===this.name?$insert.insertBefore($link):$insert.insertAfter($link)}}),Macro.add("nobr",{skipArgs:!0,tags:null,handler:function(){new Wikifier(this.output,this.payload[0].contents.replace(/^\n+|\n+$/g,"").replace(/\n+/g," "))}}),Macro.add(["numberbox","textbox"],{isAsync:!0,handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("default value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));Config.debug&&this.debugView.modes({block:!0});var asNumber="numberbox"===this.name,defaultValue=asNumber?Number(this.args[1]):this.args[1];if(asNumber&&Number.isNaN(defaultValue))return this.error('default value "'.concat(this.args[1],'" is neither a number nor can it be parsed into a number'));var passage,varId=createSlug(varName),el=document.createElement("input"),autofocus=!1;this.args.length>3?(passage=this.args[2],autofocus="autofocus"===this.args[3]):this.args.length>2&&("autofocus"===this.args[2]?autofocus=!0:passage=this.args[2]),"object"===_typeof(passage)&&(passage=passage.link),jQuery(el).attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),type:asNumber?"number":"text",inputmode:asNumber?"decimal":"text",tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.shadowHandler((function(){State.setVar(varName,asNumber?Number(this.value):this.value)}))).on("keypress.macros",this.shadowHandler((function(ev){13===ev.which&&(ev.preventDefault(),State.setVar(varName,asNumber?Number(this.value):this.value),null!=passage&&Engine.play(passage))}))).appendTo(this.output),asNumber&&(el.step="any"),State.setVar(varName,defaultValue),el.value=defaultValue,autofocus&&(el.setAttribute("autofocus","autofocus"),Engine.isPlaying()?jQuery(document).one(":passageend",(function(){setTimeout((function(){return el.focus()}),Engine.DOM_DELAY)})):setTimeout((function(){return el.focus()}),Engine.DOM_DELAY))}}),Macro.add(["print","=","-"],{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{var result=stringFrom(Scripting.evalJavaScript(this.args.full));null!==result&&new Wikifier(this.output,"-"===this.name?encodeEntities(result):result)}catch(ex){return this.error("bad evaluation: ".concat(getErrorMessage(ex)))}}}),Macro.add("radiobutton",{isAsync:!0,handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("checked value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));var varId=createSlug(varName),checkValue=this.args[1],el=document.createElement("input");switch(Object.hasOwn(TempState,this.name)||(TempState[this.name]={}),Object.hasOwn(TempState[this.name],varId)||(TempState[this.name][varId]=0),jQuery(el).attr({id:"".concat(this.name,"-").concat(varId,"-").concat(TempState[this.name][varId]++),name:"".concat(this.name,"-").concat(varId),type:"radio",tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.shadowHandler((function(){this.checked&&State.setVar(varName,checkValue)}))).appendTo(this.output),this.args[2]){case"autocheck":State.getVar(varName)===checkValue&&(el.checked=!0);break;case"checked":el.checked=!0,State.setVar(varName,checkValue)}}}),Macro.add("remove",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));$targets.remove(),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeclass",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));this.args.length>1?$targets.removeClass(this.args[1].trim()):$targets.removeClass(),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("repeat",{isAsync:!0,tags:null,timers:new Set,t8nRe:/^(?:transition|t8n)$/,handler:function(){var delay,_this17=this;if(0===this.args.length)return this.error("no time value specified");try{delay=Math.max(Engine.DOM_DELAY,cssTimeToMS(this.args[0]))}catch(ex){return this.error(ex.message)}Config.debug&&this.debugView.modes({block:!0});var transition=this.args.length>1&&this.self.t8nRe.test(this.args[1]),$wrapper=jQuery(document.createElement("span")).addClass("macro-".concat(this.name)).appendTo(this.output);this.self.registerInterval(this.shadowHandler((function(){var frag=document.createDocumentFragment();new Wikifier(frag,_this17.payload[0].contents,{cleanup:!1});var $output=$wrapper;transition&&($output=jQuery(document.createElement("span")).addClass("macro-repeat-insert macro-repeat-in").appendTo($output)),$output.append(frag),transition&&setTimeout((function(){return $output.removeClass("macro-repeat-in")}),Engine.DOM_DELAY)})),delay)},registerInterval:function(callback,delay){var _this18=this;if("function"!=typeof callback)throw new TypeError("callback parameter must be a function");var passage=State.passage,turn=State.turns,timers=this.timers,timerId=null;timerId=setInterval((function(){if(State.passage!==passage||State.turns!==turn)return clearInterval(timerId),void timers.delete(timerId);var timerIdCache;try{TempState.break=null,Object.hasOwn(TempState,"repeatTimerId")&&(timerIdCache=TempState.repeatTimerId),TempState.repeatTimerId=timerId,callback.call(_this18)}finally{void 0!==timerIdCache?TempState.repeatTimerId=timerIdCache:delete TempState.repeatTimerId,TempState.break=null}}),delay),timers.add(timerId),1===timers.size&&jQuery(document).one(":passageinit",(function(){timers.forEach((function(timerId){return clearInterval(timerId)})),timers.clear()}))}}),Macro.add("stop",{skipArgs:!0,handler:function(){if(!Object.hasOwn(TempState,"repeatTimerId"))return this.error("must only be used in conjunction with its parent macro <<repeat>>");var timers=Macro.get("repeat").timers,timerId=TempState.repeatTimerId;clearInterval(timerId),timers.delete(timerId),TempState.break=2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("script",{tags:null,handler:function(){var evalScript;switch(this.args.length>0?String(this.args[0]).toLowerCase():"javascript"){case"javascript":evalScript=Scripting.evalJavaScript;break;case"twinescript":evalScript=Scripting.evalTwineScript;break;default:return this.error('unknown language "'.concat(this.args[0],'"'))}var output=document.createDocumentFragment();try{evalScript(this.payload[0].contents,output)}catch(ex){return this.error("bad evaluation: ".concat(getErrorMessage(ex)))}Config.debug&&this.createDebugView(),output.hasChildNodes()&&this.output.appendChild(output)}}),Macro.add("set",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{Scripting.evalJavaScript(this.args.full)}catch(ex){return this.error("bad evaluation: ".concat(getErrorMessage(ex)))}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("run","set"),Macro.add("silent",{skipArgs:!0,tags:null,handler:function(){"silently"===this.name&&console.warn("[DEPRECATED] <<".concat(this.name,">> macro is deprecated."));var frag=document.createDocumentFragment();if(new Wikifier(frag,this.payload[0].contents.trim()),Config.debug)this.debugView.modes({block:!0,hidden:!0}),this.output.appendChild(frag);else{var errList=Array.from(frag.querySelectorAll(".error")).map((function(errEl){return errEl.textContent}));if(errList.length>0)return this.error("error".concat(1===errList.length?"":"s"," within contents (").concat(errList.join("; "),")"))}}}),Macro.add("switch",{skipArgs:["switch"],tags:["case","default"],handler:function(){if(0===this.args.full.length)return this.error("no expression specified");var i,result,len=this.payload.length;if(1===len)return this.error("no cases specified");for(i=1;i<len;++i)if("default"===this.payload[i].name){if(this.payload[i].args.length>0)return this.error("<<default>> does not accept values, invalid: ".concat(this.payload[i].args.raw));if(i+1!==len)return this.error("<<default>> must be the final case")}else if(0===this.payload[i].args.length)return this.error("no value(s) specified for <<".concat(this.payload[i].name,">> (#").concat(i,")"));try{result=Scripting.evalJavaScript(this.args.full)}catch(ex){return this.error("bad evaluation: ".concat(getErrorMessage(ex)))}var debugView=this.debugView,success=!1;for(Config.debug&&debugView.modes({nonvoid:!1,hidden:!0}),i=1;i<len;++i){if(Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1}),"default"===this.payload[i].name||this.payload[i].args.some((function(val){return val===result}))){success=!0,new Wikifier(this.output,this.payload[i].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++i;i<len;++i)this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0,invalid:!0});debugView.modes({nonvoid:!1,hidden:!0,invalid:!success}),this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!0,invalid:!success})}}}),Macro.add("textarea",{isAsync:!0,handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("default value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));Config.debug&&this.debugView.modes({block:!0});var varId=createSlug(varName),defaultValue=this.args[1],autofocus="autofocus"===this.args[2],el=document.createElement("textarea");jQuery(el).attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),rows:4,tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.shadowHandler((function(){State.setVar(varName,this.value)}))).appendTo(this.output),State.setVar(varName,defaultValue),el.textContent=defaultValue,autofocus&&(el.setAttribute("autofocus","autofocus"),Engine.isPlaying()?jQuery(document).one(":passageend",(function(){setTimeout((function(){return el.focus()}),Engine.DOM_DELAY)})):setTimeout((function(){return el.focus()}),Engine.DOM_DELAY))}}),Macro.add("timed",{isAsync:!0,tags:["next"],timers:new Set,t8nRe:/^(?:transition|t8n)$/,handler:function(){if(0===this.args.length)return this.error("no time value specified in <<timed>>");var i,items=[];try{items.push({name:this.name,source:this.source,delay:Math.max(Engine.DOM_DELAY,cssTimeToMS(this.args[0])),content:this.payload[0].contents})}catch(ex){return this.error("".concat(ex.message," in <<timed>>"))}if(this.payload.length>1)try{var len;for(i=1,len=this.payload.length;i<len;++i)items.push({name:this.payload[i].name,source:this.payload[i].source,delay:0===this.payload[i].args.length?items[items.length-1].delay:Math.max(Engine.DOM_DELAY,cssTimeToMS(this.payload[i].args[0])),content:this.payload[i].contents})}catch(ex){return this.error("".concat(ex.message," in <<next>> (#").concat(i,")"))}Config.debug&&this.debugView.modes({block:!0});var transition=this.args.length>1&&this.self.t8nRe.test(this.args[1]),$wrapper=jQuery(document.createElement("span")).addClass("macro-".concat(this.name)).appendTo(this.output);this.self.registerTimeout(this.shadowHandler((function(item){var frag=document.createDocumentFragment();new Wikifier(frag,item.content,{cleanup:!1});var $output=$wrapper;Config.debug&&"next"===item.name&&($output=jQuery(new DebugView($output[0],"macro",item.name,item.source).output)),transition&&($output=jQuery(document.createElement("span")).addClass("macro-timed-insert macro-timed-in").appendTo($output)),$output.append(frag),transition&&setTimeout((function(){return $output.removeClass("macro-timed-in")}),Engine.DOM_DELAY)})),items)},registerTimeout:function(callback,items){if("function"!=typeof callback)throw new TypeError("callback parameter must be a function");var passage=State.passage,turn=State.turns,timers=this.timers,timerId=null,nextItem=items.shift();timerId=setTimeout((function worker(){if(timers.delete(timerId),State.passage===passage&&State.turns===turn){var curItem=nextItem;null!=(nextItem=items.shift())&&(timerId=setTimeout(worker,nextItem.delay),timers.add(timerId)),callback.call(this,curItem)}}),nextItem.delay),timers.add(timerId),1===timers.size&&jQuery(document).one(":passageinit",(function(){timers.forEach((function(timerId){return clearTimeout(timerId)})),timers.clear()}))}}),Macro.add("type",{isAsync:!0,tags:null,typeId:0,handler:function(){if(0===this.args.length)return this.error("no speed specified");var cursor,speed=cssTimeToMS(this.args[0]);if(speed<0)return this.error("speed time value must be non-negative (received: ".concat(this.args[0],")"));for(var elClass="",elId="",elTag="div",skipKey=Config.macros.typeSkipKey,start=400,options=this.args.slice(1);options.length>0;){var option=options.shift();switch(option){case"class":if(0===options.length)return this.error("class option missing required class name(s)");if(""===(elClass=options.shift()))throw new Error('class option class name(s) must be non-empty (received: "")');break;case"element":if(0===options.length)return this.error("element option missing required element tag name");if(""===(elTag=options.shift()))throw new Error('element option tag name must be non-empty (received: "")');break;case"id":if(0===options.length)return this.error("id option missing required ID");if(""===(elId=options.shift()))throw new Error('id option ID must be non-empty (received: "")');break;case"keep":cursor="keep";break;case"none":cursor="none";break;case"skipkey":if(0===options.length)return this.error("skipkey option missing required key value");if(""===(skipKey=options.shift()))throw new Error('skipkey option key value must be non-empty (received: "")');break;case"start":if(0===options.length)return this.error("start option missing required time value");var value=options.shift();if((start=cssTimeToMS(value))<0)throw new Error("start option time value must be non-negative (received: ".concat(value,")"));break;default:return this.error("unknown option: ".concat(option))}}var contents=this.payload[0].contents;if(""!==contents.trim()){Config.debug&&this.debugView.modes({block:!0});var className="macro-".concat(this.name),namespace=".".concat(className),$target=jQuery(document.createElement(elTag)).addClass("".concat(className," ").concat(className,"-target")).appendTo(this.output);TempState.macroTypeQueue||(TempState.macroTypeQueue=[],$(document).off(namespace).one(":passageinit".concat(namespace),(function(){return $(document).off(namespace)})));var startTyping=0===TempState.macroTypeQueue.length,selfId=++this.self.typeId,allowCleanup=this.self.allowCleanup;TempState.macroTypeQueue.push({id:selfId,handler:this.shadowHandler((function(){var $wrapper=jQuery(document.createElement(elTag)).addClass(className);elId&&$wrapper.attr("id",elId),elClass&&$wrapper.addClass(elClass),new Wikifier($wrapper,contents,allowCleanup(elTag)?undefined:{cleanup:!1});var passage=State.passage,turn=State.turns;if(0===speed||!Config.macros.typeVisitedPassages&&State.passages.slice(0,-1).some((function(title){return title===passage}))||$wrapper.find(".error").length>0)return $target.replaceWith($wrapper),TempState.macroTypeQueue.shift(),void(TempState.macroTypeQueue.length>0&&TempState.macroTypeQueue.first().handler());var typer=new NodeTyper({targetNode:$wrapper.get(0),classNames:"none"===cursor?null:"".concat(className,"-cursor")});$target.replaceWith($wrapper);var keydownAndNS="keydown".concat(namespace),typingStopAndNS="".concat(":typingstop").concat(namespace);$(document).off(keydownAndNS).on(keydownAndNS,(function(ev){scrubEventKey(ev.key)!==skipKey||ev.target!==document.body&&ev.target!==document.documentElement||(ev.preventDefault(),$(document).off(keydownAndNS),typer.finish())})).one(typingStopAndNS,(function(){TempState.macroTypeQueue&&(0===TempState.macroTypeQueue.length?triggerEvent(":typingcomplete"):TempState.macroTypeQueue.first().handler())}));var typeNode=function(){var typeNodeMember=function(typeIntervalId){State.passage===passage&&State.turns===turn&&typer.type()||(typeIntervalId&&clearInterval(typeIntervalId),TempState.macroTypeQueue&&TempState.macroTypeQueue.length>0&&TempState.macroTypeQueue.first().id===selfId&&TempState.macroTypeQueue.shift(),triggerEvent(":typingstop",$wrapper),$wrapper.addClass("".concat(className,"-done")),"keep"===cursor&&$wrapper.addClass("".concat(className,"-cursor")))};triggerEvent(":typingstart",$wrapper),typeNodeMember();var typeNodeMemberId=setInterval((function(){return typeNodeMember(typeNodeMemberId)}),speed)};start?setTimeout(typeNode,start):typeNode()}))}),startTyping&&(Engine.isPlaying()?$(document).one(":passageend".concat(namespace),(function(){return TempState.macroTypeQueue.first().handler()})):TempState.macroTypeQueue.first().handler())}},allowCleanup:function(tagName){switch(tagName.toUpperCase()){case"ARTICLE":case"DIV":case"FOOTER":case"FORM":case"HEADER":case"MAIN":case"SECTION":return!0}return!1}}),Macro.add("unset",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no story/temporary variable list specified");try{var unsetExp=this.args.full.replace(/[,;\s]*((?:State\.(?:variables|temporary)|setup)\.)/g,(function(_,p1){return"; delete ".concat(p1)})).replace(/^; /,"");Scripting.evalJavaScript(unsetExp)}catch(ex){return this.error("bad evaluation: ".concat(getErrorMessage(ex)))}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("widget",{tags:null,handler:function(){if(0===this.args.length)return this.error("no widget name specified");var widgetCode,widgetName=this.args[0],isNonVoid=this.args.length>1&&"container"===this.args[1];if(Macro.has(widgetName))return this.error("cannot clobber existing ".concat(Macro.get(widgetName).isWidget?"widget":"macro",' "').concat(widgetName,'"'));try{var widgetDef={isWidget:!0,handler:(widgetCode=this.payload[0].contents,function(){var shadowStore={};Object.hasOwn(State.temporary,"args")&&(shadowStore._args=State.temporary.args),State.temporary.args=Array.from(this.args),State.temporary.args.raw=this.args.raw,State.temporary.args.full=this.args.full,State.temporary.args.name=this.name,this.addShadow("_args"),isNonVoid&&(Object.hasOwn(State.temporary,"contents")&&(shadowStore._contents=State.temporary.contents),State.temporary.contents=this.payload[0].contents,this.addShadow("_contents")),Object.hasOwn(State.variables,"args")&&(shadowStore.$args=State.variables.args),State.variables.args=State.temporary.args,this.addShadow("$args");try{var resFrag=document.createDocumentFragment(),errList=[];if(new Wikifier(resFrag,widgetCode),Array.from(resFrag.querySelectorAll(".error")).forEach((function(errEl){errList.push(errEl.textContent)})),0!==errList.length)return this.error("error".concat(errList.length>1?"s":""," within widget code (").concat(errList.join("; "),")"));this.output.appendChild(resFrag)}catch(ex){return this.error("cannot execute widget: ".concat(ex.message))}finally{Object.hasOwn(shadowStore,"_args")?State.temporary.args=shadowStore._args:delete State.temporary.args,isNonVoid&&(Object.hasOwn(shadowStore,"_contents")?State.temporary.contents=shadowStore._contents:delete State.temporary.contents),Object.hasOwn(shadowStore,"$args")?State.variables.args=shadowStore.$args:delete State.variables.args}})};isNonVoid&&(widgetDef.tags=[]),Macro.add(widgetName,widgetDef),Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error('cannot create widget macro "'.concat(widgetName,'": ').concat(ex.message))}}}),Macro.add("silently","silent"),Macro.add("actions",{handler:function(){console.warn("[DEPRECATED] <<".concat(this.name,">> macro is deprecated."));for(var $list=jQuery(document.createElement("ul")).addClass(this.name).appendTo(this.output),i=0;i<this.args.length;++i){var passage=void 0,text=void 0,$image=void 0,setFn=void 0;if("object"===_typeof(this.args[i])?this.args[i].isImage?($image=jQuery(document.createElement("img")).attr("src",this.args[i].source),Object.hasOwn(this.args[i],"passage")&&$image.attr("data-passage",this.args[i].passage),Object.hasOwn(this.args[i],"title")&&$image.attr("title",this.args[i].title),Object.hasOwn(this.args[i],"align")&&$image.attr("align",this.args[i].align),passage=this.args[i].link,setFn=this.args[i].setFn):(text=this.args[i].text,passage=this.args[i].link,setFn=this.args[i].setFn):text=passage=this.args[i],!(Object.hasOwn(State.variables,"#actions")&&Object.hasOwn(State.variables["#actions"],passage)&&State.variables["#actions"][passage])){var $link=jQuery(Wikifier.createInternalLink(jQuery(document.createElement("li")).appendTo($list),passage,null,function(passage,fn){return function(){Object.hasOwn(State.variables,"#actions")||(State.variables["#actions"]={}),State.variables["#actions"][passage]=!0,"function"==typeof fn&&fn()}}(passage,setFn))).addClass("macro-".concat(this.name)).append($image||document.createTextNode(text));$image&&$link.addClass("link-image")}}}}),Macro.add("choice",{handler:function(){if(console.warn("[DEPRECATED] <<".concat(this.name,">> macro is deprecated.")),0===this.args.length)return this.error("no passage specified");var passage,text,$image,setFn,$link,choiceId=State.passage;if(1===this.args.length?"object"===_typeof(this.args[0])?this.args[0].isImage?($image=jQuery(document.createElement("img")).attr("src",this.args[0].source),Object.hasOwn(this.args[0],"passage")&&$image.attr("data-passage",this.args[0].passage),Object.hasOwn(this.args[0],"title")&&$image.attr("title",this.args[0].title),Object.hasOwn(this.args[0],"align")&&$image.attr("align",this.args[0].align),passage=this.args[0].link,setFn=this.args[0].setFn):(text=this.args[0].text,passage=this.args[0].link,setFn=this.args[0].setFn):text=passage=this.args[0]:(passage=this.args[0],text=this.args[1]),Object.hasOwn(State.variables,"#choice")&&Object.hasOwn(State.variables["#choice"],choiceId)&&State.variables["#choice"][choiceId])return $link=jQuery(document.createElement("span")).addClass("link-disabled macro-".concat(this.name)).attr("tabindex",-1).append($image||document.createTextNode(text)).appendTo(this.output),void($image&&$link.addClass("link-image"));$link=jQuery(Wikifier.createInternalLink(this.output,passage,null,(function(){Object.hasOwn(State.variables,"#choice")||(State.variables["#choice"]={}),State.variables["#choice"][choiceId]=!0,"function"==typeof setFn&&setFn()}))).addClass("macro-".concat(this.name)).append($image||document.createTextNode(text)),$image&&$link.addClass("link-image")}});var Dialog=function(){var DEFAULT_TOP=50,$overlay=null,$dialog=null,$title=null,$body=null,lastActive=null,observer=null,onCloseFn=null,scrollbarWidth=0;function calcInset(top){var $window=jQuery(window),inset={left:"",right:"",top:"",bottom:""};$dialog.css(inset);var horzSpace=$window.width()-$dialog.outerWidth(!0)-1,vertSpace=$window.height()-$dialog.outerHeight(!0)-1;if(horzSpace<=20+scrollbarWidth&&(vertSpace-=scrollbarWidth),vertSpace<=20+scrollbarWidth&&(horzSpace-=scrollbarWidth),inset.left=inset.right=horzSpace<=20?"10px":(horzSpace/2|0)+"px",vertSpace<=20)inset.top=inset.bottom="10px";else{var vertPos=vertSpace/2|0;inset.top=vertPos>top?top+"px":inset.bottom=vertPos+"px"}return inset}function onResize(top){"block"===$dialog.css("display")&&$dialog.css(calcInset(null!=top?top:DEFAULT_TOP))}function close(ev){if(triggerEvent(":dialogclosing",$body),jQuery(document).off(".dialog-close"),observer?(observer.disconnect(),observer=null):$body.off(".dialog-resize"),jQuery(window).off(".dialog-resize"),$dialog.removeClass("open").css({left:"",right:"",top:"",bottom:""}),jQuery("#ui-bar,#story").find("[tabindex=-2]").removeAttr("aria-hidden").attr("tabindex",0),jQuery("body>[tabindex=-3]").removeAttr("aria-hidden").removeAttr("tabindex"),$overlay.removeClass("open"),jQuery(document.documentElement).removeAttr("data-dialog"),$title.empty(),$body.empty().removeClass(),lastActive&&(lastActive.focus(),lastActive=null),onCloseFn)try{onCloseFn(ev)}finally{onCloseFn=null}return triggerEvent(":dialogclose",$body),triggerEvent(":dialogclosed",$body),Dialog}function create(title,classNames){return $title.empty().append((null!=title?String(title):"")||" "),$body.empty().removeClass(),null!=classNames&&$body.addClass(classNames),Dialog}function getBody(){return $body.get(0)}function isOpen(classNames){return $dialog.hasClass("open")&&(!classNames||classNames.splitOrEmpty(/\s+/).every((function(cn){return $body.hasClass(cn)})))}function wiki(){var _$body2;return(_$body2=$body).wiki.apply(_$body2,arguments),Dialog}return Object.preventExtensions(Object.create(null,{append:{value:function(){var _$body;return(_$body=$body).append.apply(_$body,arguments),Dialog}},body:{value:getBody},close:{value:close},create:{value:create},empty:{value:function(){return $body.empty(),Dialog}},init:{value:function(){if(!document.getElementById("ui-dialog")){scrollbarWidth=function(){var calcWidth;try{var inner=document.createElement("p");inner.style.width="100%",inner.style.height="200px";var outer=document.createElement("div");outer.style.position="absolute",outer.style.left="0",outer.style.top="0",outer.style.width="100px",outer.style.height="100px",outer.style.visibility="hidden",outer.style.overflow="hidden",outer.appendChild(inner),document.body.appendChild(outer);var w1=inner.offsetWidth;outer.style.overflow="auto";var w2=inner.offsetWidth;w1===w2&&(w2=outer.clientWidth),document.body.removeChild(outer),calcWidth=w1-w2}catch(ex){}return calcWidth||17}();var $elems=jQuery(document.createDocumentFragment()).append('<div id="ui-overlay" class="ui-close"></div><div id="ui-dialog" tabindex="0" role="dialog" aria-labelledby="ui-dialog-title" aria-modal="true"><div id="ui-dialog-titlebar"><h1 id="ui-dialog-title"></h1>'+'<button id="ui-dialog-close" class="ui-close" tabindex="0" aria-label="'.concat(L10n.get("textClose"),'"></button>')+'</div><div id="ui-dialog-body"></div></div>');$overlay=jQuery($elems.find("#ui-overlay").get(0)),$dialog=jQuery($elems.find("#ui-dialog").get(0)),$title=jQuery($elems.find("#ui-dialog-title").get(0)),$body=jQuery($elems.find("#ui-dialog-body").get(0)),$elems.insertBefore("body>script#script-sugarcube")}}},isOpen:{value:isOpen},open:{value:function(options,onClose){var top=Object.assign({top:DEFAULT_TOP},options).top;if(null!=onClose){var closeType=getTypeOf(onClose);if("function"!==closeType)throw new TypeError("Dialog.open onClose parameter must be a function (received: ".concat(closeType,")"));onCloseFn=onClose}else onCloseFn=null;triggerEvent(":dialogopening",$body),isOpen()||(lastActive=getActiveElement()),jQuery(document.documentElement).attr("data-dialog","open"),$overlay.addClass("open"),jQuery("body>:not(script,#store-area,tw-storydata,#ui-bar,#ui-overlay,#ui-dialog)").attr("tabindex",-3).attr("aria-hidden",!0),jQuery("#ui-bar,#story").find("[tabindex]:not([tabindex^=-])").attr("tabindex",-2).attr("aria-hidden",!0);var resizeHandler=jQuery.throttle(40,(function(){return onResize(top)}));return $body.imagesLoaded().always(resizeHandler),$dialog.css(calcInset(top)).addClass("open").focus(),jQuery(window).off(".dialog-resize").on("resize.dialog-resize",resizeHandler),Has.mutationObserver?(observer=new MutationObserver((function(mutations){for(var i=0;i<mutations.length;++i)if("childList"===mutations[i].type){$body.imagesLoaded().always(resizeHandler),resizeHandler();break}}))).observe(getBody(),{childList:!0,subtree:!0}):$body.off(".dialog-resize").on("DOMNodeInserted.dialog-resize DOMNodeRemoved.dialog-resize",(function(){$body.imagesLoaded().always(resizeHandler),resizeHandler()})),jQuery(document).off(".dialog-close").one("click.dialog-close",".ui-close",(function(ev){close(ev)})).one("keypress.dialog-close",".ui-close",(function(ev){13!==ev.which&&32!==ev.which||triggerEvent("click",this)})),triggerEvent(":dialogopen",$body),triggerEvent(":dialogopened",$body),Dialog}},resize:{value:function(options){return onResize("object"===_typeof(options)?options.top:undefined)}},wiki:{value:wiki},wikiPassage:{value:function(name){return wiki(Story.get(name).processText())}},setup:{value:function(title,classNames){return console.warn("[DEPRECATED] Dialog.setup() is deprecated."),create(title,classNames),getBody()}}}))}(),Engine=function(){var States=enumFrom({Init:"init",Idle:"idle",Playing:"playing",Rendering:"rendering"}),DOM_DELAY=40,_initDebugViews=[],_state=States.Init,_lastPlay=null;function engineGo(offset){var succeeded=State.go(offset);return succeeded&&engineShow(),succeeded}function engineShow(){return enginePlay(State.passage,!0)}function enginePlay(title,noHistory){if(_state===States.Init)return!1;var passageReadyOutput,passageDoneOutput,passageTitle=title;if(_state=States.Playing,TempState={},State.clearTemporary(),"function"==typeof Config.navigation.override)try{var overrideTitle=Config.navigation.override(passageTitle);overrideTitle&&(passageTitle=overrideTitle)}catch(ex){}var passage=Story.get(passageTitle);if(jQuery.event.trigger({passage:passage,type:":passageinit",detail:{passage:passage}}),Object.keys(prehistory).forEach((function(task){"function"==typeof prehistory[task]&&prehistory[task].call(passage,task)})),noHistory||State.create(passage.name),document.body.className&&(document.body.className=""),_lastPlay=now(),Object.keys(predisplay).forEach((function(task){"function"==typeof predisplay[task]&&predisplay[task].call(passage,task)})),Story.has("PassageReady"))try{passageReadyOutput=Wikifier.wikifyEval(Story.get("PassageReady").text)}catch(ex){console.error(ex),Alert.error("PassageReady",ex.message)}_state=States.Rendering;var dataTags=passage.tags.length>0?passage.tags.join(" "):null,passageEl=document.createElement("div");jQuery(passageEl).attr({id:passage.id,"data-passage":passage.name,"data-tags":dataTags}).addClass("passage passage-in ".concat(passage.className)),jQuery(document.body).attr("data-tags",dataTags).addClass(passage.className),jQuery(document.documentElement).attr("data-tags",dataTags),jQuery.event.trigger({content:passageEl,passage:passage,type:":passagestart",detail:{content:passageEl,passage:passage}}),Object.keys(prerender).forEach((function(task){"function"==typeof prerender[task]&&prerender[task].call(passage,passageEl,task)})),Story.has("PassageHeader")&&new Wikifier(passageEl,Story.get("PassageHeader").processText()),passageEl.appendChild(passage.render()),Story.has("PassageFooter")&&new Wikifier(passageEl,Story.get("PassageFooter").processText()),jQuery.event.trigger({content:passageEl,passage:passage,type:":passagerender",detail:{content:passageEl,passage:passage}}),Object.keys(postrender).forEach((function(task){"function"==typeof postrender[task]&&postrender[task].call(passage,passageEl,task)}));var debugView,containerEl=document.getElementById("passages");if(containerEl.hasChildNodes()&&("number"==typeof Config.passages.transitionOut||"string"==typeof Config.passages.transitionOut&&""!==Config.passages.transitionOut&&Has.transitionEndEvent?Array.from(containerEl.childNodes).forEach((function(outgoing){var $outgoing=jQuery(outgoing);if(outgoing.nodeType===Node.ELEMENT_NODE&&$outgoing.hasClass("passage")){if($outgoing.hasClass("passage-out"))return;$outgoing.attr({id:"out-".concat($outgoing.attr("id")),"aria-hidden":"true","aria-live":"off"}).addClass("passage-out"),"string"==typeof Config.passages.transitionOut?$outgoing.on(Has.transitionEndEvent,(function(ev){ev.originalEvent.propertyName===Config.passages.transitionOut&&$outgoing.remove()})):setTimeout((function(){return $outgoing.remove()}),Math.max(DOM_DELAY,Config.passages.transitionOut))}else $outgoing.remove()})):jQuery(containerEl).empty()),jQuery(passageEl).appendTo(containerEl),setTimeout((function(){return jQuery(passageEl).removeClass("passage-in")}),DOM_DELAY/2),window.scroll(0,0),_state=States.Playing,Story.has("PassageDone"))try{passageDoneOutput=Wikifier.wikifyEval(Story.get("PassageDone").text)}catch(ex){console.error(ex),Alert.error("PassageDone",ex.message)}(jQuery.event.trigger({content:passageEl,passage:passage,type:":passagedisplay",detail:{content:passageEl,passage:passage}}),Object.keys(postdisplay).forEach((function(task){"function"==typeof postdisplay[task]&&postdisplay[task].call(passage,task)})),UI.update(),Config.debug)&&(null!=passageReadyOutput&&((debugView=new DebugView(document.createDocumentFragment(),"special","PassageReady","PassageReady")).modes({hidden:!0}),debugView.append(passageReadyOutput),jQuery(passageEl).prepend(debugView.output)),null!=passageDoneOutput&&((debugView=new DebugView(document.createDocumentFragment(),"special","PassageDone","PassageDone")).modes({hidden:!0}),debugView.append(passageDoneOutput),jQuery(passageEl).append(debugView.output)),1===State.turns&&_initDebugViews.length>0&&jQuery(passageEl).prepend(_initDebugViews));return jQuery("#story").find("a,link,button,input,select,textarea").not("[tabindex]").attr("tabindex",0),State.turns>1&&Save.browser.auto.isEnabled()&&Save.browser.auto.save(),jQuery.event.trigger({content:passageEl,passage:passage,type:":passageend",detail:{content:passageEl,passage:passage}}),_state=States.Idle,_lastPlay=now(),passageEl}return Object.preventExtensions(Object.create(null,{States:{value:States},DOM_DELAY:{get:function(){return DOM_DELAY}},init:{value:function(){if(_state===States.Init){jQuery("#init-no-js,#init-lacking").remove();var $main=jQuery('<div id="story" role="main"></div>'),markup=Story.has("StoryInterface")&&Story.get("StoryInterface").text.trim();if(markup){if(Config.ui.updateStoryElements=!1,UIBar.destroy(),jQuery(document.head).find("#style-core-display").remove(),$main.append(markup),$main.find("#story").length>0)throw new Error('element with ID "story" found within "StoryInterface" special passage');var $passages=$main.find("#passages");if(0===$passages.length)throw new Error('no element with ID "passages" found within "StoryInterface" special passage');$passages.empty().not("[aria-live]").attr("aria-live","polite").end();var $dataInitPassages=$main.find("[data-init-passage]"),$dataPassages=$main.find("[data-passage]");$dataInitPassages.each((function(i,el){if("passages"===el.id)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' id="passages"> must not contain a "data-init-passage" content attribute'));var passage=el.getAttribute("data-init-passage").trim();if(el.hasAttribute("data-passage"))throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' data-init-passage="').concat(passage,'"> must not contain a "data-passage" content attribute'));if(null!==el.firstElementChild)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' data-init-passage="').concat(passage,'"> contains child elements'));Story.has(passage)&&jQuery(document).one(":uiupdate".concat(".engine"),(function(){var frag=document.createDocumentFragment();new Wikifier(frag,Story.get(passage).processText().trim()),jQuery(el).empty().append(frag)}))})),$dataPassages.each((function(i,el){if("passages"===el.id)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' id="passages"> must not contain a "data-passage" content attribute'));var passage=el.getAttribute("data-passage").trim();if(null!==el.firstElementChild)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' data-passage="').concat(passage,'"> contains child elements'));Story.has(passage)&&jQuery(document).on(":uiupdate".concat(".engine"),(function(){var frag=document.createDocumentFragment();new Wikifier(frag,Story.get(passage).processText().trim()),jQuery(el).empty().append(frag)}))}))}else $main.append('<div id="passages" aria-live="polite"></div>');$main.insertBefore("body>script#script-sugarcube")}}},runUserScripts:{value:function(){var storyStyle;_state===States.Init&&(storyStyle=document.createElement("style"),new StyleWrapper(storyStyle).add(Story.getStyles().map((function(style){return style.text.trim()})).join("\n")),jQuery(storyStyle).appendTo(document.head).attr({id:"style-story",type:"text/css"}),Story.getScripts().forEach((function(script){try{Scripting.evalJavaScript(script.text)}catch(ex){console.error(ex),Alert.error(script.name,getErrorMessage(ex))}})),Story.getWidgets().forEach((function(widget){try{Wikifier.wikifyEval(widget.processText())}catch(ex){console.error(ex),Alert.error(widget.name,getErrorMessage(ex))}})))}},runUserInit:{value:function(){if(_state===States.Init&&(Story.getInits().forEach((function(passage){try{var debugBuffer=Wikifier.wikifyEval(passage.text);if(Config.debug){var debugView=new DebugView(document.createDocumentFragment(),"special","".concat(passage.name," [init-tagged]"),"".concat(passage.name," [init-tagged]"));debugView.modes({hidden:!0}),debugView.append(debugBuffer),_initDebugViews.push(debugView.output)}}catch(ex){console.error(ex),Alert.error("".concat(passage.name," [init-tagged]"),getErrorMessage(ex))}})),Story.has("StoryInit")))try{var debugBuffer=Wikifier.wikifyEval(Story.get("StoryInit").text);if(Config.debug){var debugView=new DebugView(document.createDocumentFragment(),"special","StoryInit","StoryInit");debugView.modes({hidden:!0}),debugView.append(debugBuffer),_initDebugViews.push(debugView.output)}}catch(ex){console.error(ex),Alert.error("StoryInit",getErrorMessage(ex))}}},start:{value:function(){if(_state===States.Init){if(null==Config.passages.start)throw new Error("starting passage not selected");if(!Story.has(Config.passages.start))throw new Error('starting passage ("'.concat(Config.passages.start,'") not found'));if(_state=States.Idle,document.documentElement.focus(),State.restore())engineShow();else{var autoloadType=_typeof(Config.saves._internal_autoload_);"string"===autoloadType?"prompt"===Config.saves._internal_autoload_&&(UI.buildAutoload(),Dialog.open()):new Promise((function(resolve,reject){if(Save.browser.size>0&&("boolean"===autoloadType&&Config.saves._internal_autoload_||"function"===autoloadType&&Config.saves._internal_autoload_()))return resolve();reject()})).then((function(){Save.browser.continue(),engineShow()})).catch((function(){enginePlay(Config.passages.start)}))}}}},restart:{value:function(){LoadScreen.show(),window.scroll(0,0),State.reset(),triggerEvent(":enginerestart"),window.location.reload()}},state:{get:function(){return _state}},isIdle:{value:function(){return _state===States.Idle}},isPlaying:{value:function(){return _state!==States.Idle}},isRendering:{value:function(){return _state===States.Rendering}},lastPlay:{get:function(){return _lastPlay}},goTo:{value:function(index){var succeeded=State.goTo(index);return succeeded&&engineShow(),succeeded}},go:{value:engineGo},backward:{value:function(){return engineGo(-1)}},forward:{value:function(){return engineGo(1)}},show:{value:engineShow},play:{value:enginePlay},display:{value:function(title,link,option){console.warn("[DEPRECATED] Engine.display() is deprecated.");var noHistory=!1;switch(option){case undefined:break;case"replace":case"back":noHistory=!0;break;default:throw new Error('Engine.display option parameter called with obsolete value "'.concat(option,'"; please notify the developer'))}enginePlay(title,noHistory)}},minDomActionDelay:{get:function(){return DOM_DELAY}}}))}(),Passage=(tagsToSkip=/^(?:debug|nobr|passage|widget|twine\..*)$/i,encodedRE=/\r/g,hasEncodedRE=new RegExp(encodedRE.source),decodePassageText=function(str){if(null==str)return"";var val=String(str);return val&&hasEncodedRE.test(val)?val.replace(encodedRE,""):val},function(){return _createClass((function Passage(name,el){var _this19=this;_classCallCheck(this,Passage),Object.defineProperties(this,{name:{value:decodeEntities(name)},element:{value:el||null},tags:{value:Object.freeze(el&&el.hasAttribute("tags")?Array.from(new Set(el.getAttribute("tags").trim().splitOrEmpty(/\s+/))):[])}}),Object.defineProperties(this,{id:{value:"passage-".concat(createSlug(this.name))},classes:{value:Object.freeze(0===this.tags.length?[]:_this19.tags.filter((function(tag){return!tagsToSkip.test(tag)})).map((function(tag){return createSlug(tag)})))},domId:{get:function(){return this.id}},title:{get:function(){return this.name}}})}),[{key:"className",get:function(){return this.classes.join(" ")}},{key:"text",get:function(){if(null==this.element){var passage=encodeMarkup(this.name),mesg="".concat(L10n.get("errorViewTitle"),": ").concat(L10n.get("errorNonexistentPassage",{passage:passage}));return'<div class="error-view"><span class="error">'.concat(mesg,"</span></div>")}return decodePassageText(this.element.textContent)}},{key:"processText",value:function(){if(null==this.element)return this.text;if(this.tags.includes("Twine.image"))return"[img[".concat(this.text,"]]");var processed=this.text;return Config.passages.onProcess&&(processed=Config.passages.onProcess.call(null,{title:this.name,tags:this.tags,text:processed})),(Config.passages.nobr||this.tags.includes("nobr"))&&(processed=processed.replace(/^\n+|\n+$/g,"").replace(/\n+/g," ")),processed}},{key:"render",value:function(options){var frag=document.createDocumentFragment();return new Wikifier(frag,this.processText(),options),frag}},{key:"description",value:function(){return"".concat(L10n.get("textTurn")," ").concat(State.turns)}}])}()),encodedRE,hasEncodedRE,tagsToSkip,decodePassageText,Save=function(){var Type=enumFrom({Unknown:0,Auto:1,Slot:2,Disk:3,Base64:4,Autosave:1,Serialize:4}),MAX_INDEX=15,INDEX_DELIMITER=":",AUTO_SUBKEY="".concat("save.","auto."),AUTO_DATA_SUBKEY="".concat(AUTO_SUBKEY,"data").concat(INDEX_DELIMITER),AUTO_INFO_SUBKEY="".concat(AUTO_SUBKEY,"info").concat(INDEX_DELIMITER),SLOT_SUBKEY="".concat("save.","slot."),SLOT_DATA_SUBKEY="".concat(SLOT_SUBKEY,"data").concat(INDEX_DELIMITER),SLOT_INFO_SUBKEY="".concat(SLOT_SUBKEY,"info").concat(INDEX_DELIMITER),onLoadHandlers=new Set,onSaveHandlers=new Set;function createDetails(saveType,description,metadata){var metadataType=_typeof(metadata);if("object"!==metadataType&&"undefined"!==metadataType)throw new TypeError("metadata parameter must be an object or null/undefined");var cfgMetadata=Config.saves.metadata?Config.saves.metadata(saveType):undefined,cfgMetadataType=_typeof(cfgMetadata);if("object"!==cfgMetadataType&&"undefined"!==cfgMetadataType)throw new TypeError("Config.saves.metadata function must return an object or null/undefined");var desc,details={type:saveType};null!=description&&(desc=String(description).trim()),desc||"function"!=typeof Config.saves.descriptions||"string"==typeof(desc=Config.saves.descriptions(saveType))&&(desc=desc.trim()),details.desc=desc||"".concat(L10n.get("textTurn")," ").concat(State.turns);var fullMetadata=Object.assign({},cfgMetadata,metadata);return Object.keys(fullMetadata).length>0&&(details.metadata=fullMetadata),details}function findNewest(saveType){var keys;switch(saveType){case Type.Auto:keys=getKeys(isAutoInfoKey);break;case Type.Slot:keys=getKeys(isSlotInfoKey);break;default:keys=getKeys(isInfoKey)}switch(keys.length){case 0:return{index:-1};case 1:return{index:getIndexFromKey(keys[0]),type:getTypeFromKey(keys[0])}}return keys.map((function(key){return{value:{index:getIndexFromKey(key),type:getTypeFromKey(key)},date:storage.get(key).date}})).sort((function(a,b){return b.date-a.date})).first().value}function getIndexFromKey(key){var pos=key.lastIndexOf(INDEX_DELIMITER);if(-1===pos)throw new Error("unable to get index from save key (received: ".concat(key,")"));return Number(key.slice(pos+1))}function getAutoInfoKeyFromIndex(index){return"".concat(AUTO_INFO_SUBKEY).concat(index)}function getAutoDataKeyFromIndex(index){return"".concat(AUTO_DATA_SUBKEY).concat(index)}function getSlotInfoKeyFromIndex(index){return"".concat(SLOT_INFO_SUBKEY).concat(index)}function getSlotDataKeyFromIndex(index){return"".concat(SLOT_DATA_SUBKEY).concat(index)}function getKeys(predicate){return storage.keys().filter(predicate)}function getTypeFromKey(key){return isAutoKey(key)?Type.Auto:Type.Slot}function isInfoKey(key){return key.startsWith(AUTO_INFO_SUBKEY)||key.startsWith(SLOT_INFO_SUBKEY)}function isAutoKey(key){return key.startsWith(AUTO_SUBKEY)}function isAutoInfoKey(key){return key.startsWith(AUTO_INFO_SUBKEY)}function isSlotKey(key){return key.startsWith(SLOT_SUBKEY)}function isSlotInfoKey(key){return key.startsWith(SLOT_INFO_SUBKEY)}function saveBlobToDiskAs(data,filename,extension){if("string"!=typeof filename)throw new Error("filename parameter must be a string");var baseName=createFilename(filename);if(""===baseName)throw new Error("filename parameter must not consist solely of illegal characters");var datestamp=function(date){if(!(date instanceof Date))throw new TypeError("createDatestamp date parameter must be a Date object");var MM=date.getMonth()+1,DD=date.getDate(),hh=date.getHours(),mm=date.getMinutes(),ss=date.getSeconds();return MM<10&&(MM="0".concat(MM)),DD<10&&(DD="0".concat(DD)),hh<10&&(hh="0".concat(hh)),mm<10&&(mm="0".concat(mm)),ss<10&&(ss="0".concat(ss)),"".concat(date.getFullYear()).concat(MM).concat(DD,"-").concat(hh).concat(mm).concat(ss)}(new Date),fileExt=createFilename(extension)||"save";saveAs(new Blob([data],{type:"text/plain;charset=UTF-8"}),"".concat(baseName,"-").concat(datestamp,".").concat(fileExt))}function saveToBrowserStorage(saveData){var data=saveData.data,dataKey=saveData.dataKey,info=saveData.info,infoKey=saveData.infoKey;try{storage.set(dataKey,data)&&(storage.set(infoKey,info)||storage.delete(dataKey))}catch(ex){throw storage.delete(dataKey),storage.delete(infoKey),ex}}function browserClear(){return autoClear(),slotClear(),!0}function browserIsEnabled(){return autoIsEnabled()||slotIsEnabled()}function autoClear(){return getKeys(isAutoKey).forEach((function(key){return storage.delete(key)})),!0}function autoDelete(index){if(!Number.isInteger(index))throw new TypeError("auto save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("auto save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));return storage.delete(getAutoInfoKeyFromIndex(index)),storage.delete(getAutoDataKeyFromIndex(index)),!0}function autoGet(index){if(!Number.isInteger(index))throw new TypeError("auto save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("auto save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));return storage.get(getAutoInfoKeyFromIndex(index))}function autoHas(index){if(!Number.isInteger(index))throw new TypeError("auto save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("auto save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));return storage.has(getAutoInfoKeyFromIndex(index))}function autoIsEnabled(){return"cookie"!==storage.name&&Config.saves.maxAutoSaves>0}function autoLoad(index){return new Promise((function(resolve){if(!Number.isInteger(index))throw new TypeError("auto save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("auto save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));if(Engine.state===Engine.States.Init)throw new Error(L10n.get("saveErrorLoadTooEarly"));var info=storage.get(getAutoInfoKeyFromIndex(index)),data=storage.get(getAutoDataKeyFromIndex(index));if(!info||!data)throw new Error(L10n.get("saveErrorNonexistent"));unmarshal(Object.assign(info,data)),resolve(!0)}))}function autoSave(desc,metadata){if(!autoIsEnabled()||"function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed(Type.Auto))return!1;var index=(findNewest(Type.Auto).index+1)%Config.saves.maxAutoSaves,infoKey=getAutoInfoKeyFromIndex(index),dataKey=getAutoDataKeyFromIndex(index),_splitSave3=splitSave(marshal(createDetails(Type.Auto,desc,metadata))),info=_splitSave3.info;saveToBrowserStorage({data:_splitSave3.data,dataKey:dataKey,info:info,infoKey:infoKey})}function slotClear(){return getKeys(isSlotKey).forEach((function(key){return storage.delete(key)})),!0}function slotDelete(index){if(!Number.isInteger(index))throw new TypeError("slot save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("slot save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));return storage.delete(getSlotInfoKeyFromIndex(index)),storage.delete(getSlotDataKeyFromIndex(index)),!0}function slotGet(index){if(!Number.isInteger(index))throw new TypeError("slot save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("slot save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));return storage.get(getSlotInfoKeyFromIndex(index))}function slotHas(index){if(!Number.isInteger(index))throw new TypeError("slot save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("slot save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));return storage.has(getSlotInfoKeyFromIndex(index))}function slotIsEnabled(){return"cookie"!==storage.name&&Config.saves.maxSlotSaves>0}function slotLoad(index){return new Promise((function(resolve){if(!Number.isInteger(index))throw new TypeError("slot save index must be an integer");if(index<0||index>MAX_INDEX)throw new RangeError("slot save index out of bounds (range: 0–".concat(MAX_INDEX,"; received: ").concat(index,")"));if(Engine.state===Engine.States.Init)throw new Error(L10n.get("saveErrorLoadTooEarly"));var info=storage.get(getSlotInfoKeyFromIndex(index)),data=storage.get(getSlotDataKeyFromIndex(index));if(!info||!data)throw new Error(L10n.get("saveErrorNonexistent"));unmarshal(Object.assign(info,data)),resolve(!0)}))}function slotSave(index,desc,metadata){if(!Number.isInteger(index))throw new TypeError("slot save index must be an integer");if(index<0||index>=Config.saves.maxSlotSaves)throw new RangeError("slot save index out of bounds (range: 0–".concat(Config.saves.maxSlotSaves-1,"; received: ").concat(index,")"));if(!slotIsEnabled()||"function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed(Type.Slot))throw new Error(L10n.get("saveErrorDisallowed"));var infoKey=getSlotInfoKeyFromIndex(index),dataKey=getSlotDataKeyFromIndex(index),_splitSave4=splitSave(marshal(createDetails(Type.Slot,desc,metadata))),info=_splitSave4.info;saveToBrowserStorage({data:_splitSave4.data,dataKey:dataKey,info:info,infoKey:infoKey})}function slotSize(){return getKeys(isSlotInfoKey).length}function diskLoad(event){return new Promise((function(resolve,reject){var reader=new FileReader;jQuery(reader).on("loadend",(function(){try{if(Engine.state===Engine.States.Init)throw new Error(L10n.get("saveErrorLoadTooEarly"));if(reader.error)throw new Error("".concat(L10n.get("saveErrorDiskLoadFail"),": ").concat(reader.error));var save;try{save=Serial.parse(LZString.decompressFromBase64(reader.result))}catch(ex){throw new Error(L10n.get("saveErrorDecodeFail"))}unmarshal(save),resolve(save.metadata)}catch(ex){reject(ex)}})),reader.readAsText(event.target.files[0])}))}function diskSave(filename,metadata){if(null==filename)throw new Error("Save.disk.save filename parameter is required");if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed(Type.Disk))throw new Error(L10n.get("saveErrorDisallowed"));var details=createDetails(Type.Disk,filename,metadata);saveBlobToDiskAs(LZString.compressToBase64(Serial.stringify(marshal(details))),filename,"save")}function base64Load(base64){return new Promise((function(resolve){if(Engine.state===Engine.States.Init)throw new Error(L10n.get("saveErrorLoadTooEarly"));var save;try{save=Serial.parse(LZString.decompressFromBase64(base64))}catch(ex){throw new Error(L10n.get("saveErrorDecodeFail"))}unmarshal(save),resolve(save.metadata)}))}function base64Save(metadata){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed(Type.Base64))throw new Error(L10n.get("saveErrorDisallowed"));var details=createDetails(Type.Base64,null,metadata);return LZString.compressToBase64(Serial.stringify(marshal(details)))}function marshal(details){var save=Object.assign({},details,{date:Date.now(),id:Config.saves.id,state:State.marshalForSave()});return null!=Config.saves.version&&(save.version=Config.saves.version),onSaveHandlers.forEach((function(fn){return fn(save,function(save){switch(save.type){case Type.Auto:return{type:"autosave"};case Type.Slot:return{type:"slot"};case Type.Disk:return{type:"disk"};case Type.Base64:return{type:"serialize"}}throw new Error("save.type must be an integer (received: ".concat(_typeof(save.type),")"))}(save))})),save.state.delta=State.deltaEncode(save.state.history),delete save.state.history,save}function splitSave(save){var state=save.state;return{info:_objectWithoutProperties(save,_excluded3),data:{state:state}}}function unmarshal(save){if(null==save||"object"!==_typeof(save)||!Object.hasOwn(save,"id")||!Object.hasOwn(save,"state")||"object"!==_typeof(save.state)||!Object.hasOwn(save.state,"delta"))throw new Error(L10n.get("saveErrorInvalidData"));if(save.id!==Config.saves.id)throw new Error(L10n.get("saveErrorIdMismatch"));if(save.state.history=State.deltaDecode(save.state.delta),delete save.state.delta,"string"==typeof save.type){switch(save.type){case"auto":case"autosave":save.type=Type.Auto;break;case"slot":save.type=Type.Slot;break;case"disk":save.type=Type.Disk;break;case"base64":case"serialize":save.type=Type.Base64}if("number"!=typeof save.type)throw new Error("save.type is unknown")}onLoadHandlers.forEach((function(fn){return fn(save)})),State.unmarshalForSave(save.state)}return Object.preventExtensions(Object.create(null,{Type:{value:Type},MAX_INDEX:{get:function(){return MAX_INDEX}},init:{value:function(){return function(){var oldSaves=storage.get("saves");if(null===oldSaves)return;if(autoClear(),slotClear(),oldSaves.autosave){var _splitSave=splitSave(oldSaves.autosave),info=_splitSave.info,data=_splitSave.data;info.desc=info.title,delete info.title,info.type=Type.Auto;var infoKey=getAutoInfoKeyFromIndex(0),dataKey=getAutoDataKeyFromIndex(0);storage.set(dataKey,data)&&(storage.set(infoKey,info)||storage.delete(dataKey))}oldSaves.slots.forEach((function(save,index){if(save){var _splitSave2=splitSave(save),info=_splitSave2.info,data=_splitSave2.data;info.desc=info.title,delete info.title,info.type=Type.Slot;var infoKey=getSlotInfoKeyFromIndex(index),dataKey=getSlotDataKeyFromIndex(index);storage.set(dataKey,data)&&(storage.set(infoKey,info)||storage.delete(dataKey))}})),storage.delete("saves")}(),!0}},browser:{value:Object.preventExtensions(Object.create(null,{clear:{value:browserClear},continue:{value:function(){var newest=findNewest();return-1===newest.index?Promise.reject(new Error(L10n.get("saveErrorNonexistent"))):newest.type===Type.Auto?autoLoad(newest.index):slotLoad(newest.index)}},isEnabled:{value:browserIsEnabled},size:{get:function(){return getKeys(isInfoKey).length}},auto:{value:Object.preventExtensions(Object.create(null,{clear:{value:autoClear},delete:{value:autoDelete},entries:{value:function(){return getKeys(isAutoInfoKey).map((function(key){return{index:getIndexFromKey(key),info:storage.get(key)}})).sort((function(a,b){return b.info.date-a.info.date}))}},get:{value:autoGet},has:{value:autoHas},isEnabled:{value:autoIsEnabled},load:{value:autoLoad},save:{value:autoSave},size:{get:function(){return getKeys(isAutoInfoKey).length}}}))},slot:{value:Object.preventExtensions(Object.create(null,{clear:{value:slotClear},delete:{value:slotDelete},entries:{value:function(){return getKeys(isSlotInfoKey).map((function(key){return{index:getIndexFromKey(key),info:storage.get(key)}})).sort((function(a,b){return a.index-b.index}))}},get:{value:slotGet},has:{value:slotHas},isEnabled:{value:slotIsEnabled},load:{value:slotLoad},save:{value:slotSave},size:{get:slotSize}}))}}))},disk:{value:Object.preventExtensions(Object.create(null,{export:{value:function(filename){if(null==filename)throw new Error("Save.browser.export filename parameter is required");var auto=getKeys(isAutoInfoKey).map((function(infoKey){var index=getIndexFromKey(infoKey),info=storage.get(infoKey),data=storage.get(getAutoDataKeyFromIndex(index));if(!info||!data)throw new Error("during saves export auto save info or data nonexistent");return{index:index,info:info,data:data}})),slot=getKeys(isSlotInfoKey).map((function(infoKey){var index=getIndexFromKey(infoKey),info=storage.get(infoKey),data=storage.get(getSlotDataKeyFromIndex(index));if(!info||!data)throw new Error("during saves export slot save info or data nonexistent");return{index:index,info:info,data:data}}));saveBlobToDiskAs(LZString.compressToBase64(Serial.stringify({auto:auto,slot:slot})),filename,"savesbundle")}},import:{value:function(event){return new Promise((function(resolve,reject){var reader=new FileReader;jQuery(reader).on("loadend",(function(){try{if(reader.error)throw new Error("".concat(L10n.get("saveErrorDiskLoadFail"),": ").concat(reader.error));var bundle,badSave=function(O){return!Object.hasOwn(O,"index")||!Object.hasOwn(O,"info")||!Object.hasOwn(O,"data")};try{bundle=Serial.parse(LZString.decompressFromBase64(reader.result))}catch(ex){throw new Error(L10n.get("saveErrorDecodeFail"))}if(null==bundle||"object"!==_typeof(bundle)||!Object.hasOwn(bundle,"auto")||!(bundle.auto instanceof Array)||bundle.auto.some(badSave)||!Object.hasOwn(bundle,"slot")||!(bundle.slot instanceof Array)||bundle.slot.some(badSave))throw new Error(L10n.get("saveErrorInvalidData"));autoClear(),slotClear(),bundle.auto.forEach((function(save){return saveToBrowserStorage({data:save.data,dataKey:getAutoDataKeyFromIndex(save.index),info:save.info,infoKey:getAutoInfoKeyFromIndex(save.index)})})),bundle.slot.forEach((function(save){return saveToBrowserStorage({data:save.data,dataKey:getSlotDataKeyFromIndex(save.index),info:save.info,infoKey:getSlotInfoKeyFromIndex(save.index)})})),resolve(!0)}catch(ex){reject(ex)}})),reader.readAsText(event.target.files[0])}))}},load:{value:diskLoad},save:{value:diskSave}}))},base64:{value:Object.preventExtensions(Object.create(null,{export:{value:function(){var auto=getKeys(isAutoInfoKey).map((function(infoKey){var index=getIndexFromKey(infoKey),info=storage.get(infoKey),data=storage.get(getAutoDataKeyFromIndex(index));if(!info||!data)throw new Error("during saves export auto save info or data nonexistent");return{index:index,info:info,data:data}})),slot=getKeys(isSlotInfoKey).map((function(infoKey){var index=getIndexFromKey(infoKey),info=storage.get(infoKey),data=storage.get(getSlotDataKeyFromIndex(index));if(!info||!data)throw new Error("during saves export slot save info or data nonexistent");return{index:index,info:info,data:data}}));return LZString.compressToBase64(Serial.stringify({auto:auto,slot:slot}))}},import:{value:function(base64){return new Promise((function(resolve){var bundle,badSave=function(O){return!Object.hasOwn(O,"index")||!Object.hasOwn(O,"info")||!Object.hasOwn(O,"data")};try{bundle=Serial.parse(LZString.decompressFromBase64(base64))}catch(ex){throw new Error(L10n.get("saveErrorDecodeFail"))}if(null==bundle||"object"!==_typeof(bundle)||!Object.hasOwn(bundle,"auto")||!(bundle.auto instanceof Array)||bundle.auto.some(badSave)||!Object.hasOwn(bundle,"slot")||!(bundle.slot instanceof Array)||bundle.slot.some(badSave))throw new Error(L10n.get("saveErrorInvalidData"));autoClear(),slotClear(),bundle.auto.forEach((function(save){return saveToBrowserStorage({data:save.data,dataKey:getAutoDataKeyFromIndex(save.index),info:save.info,infoKey:getAutoInfoKeyFromIndex(save.index)})})),bundle.slot.forEach((function(save){return saveToBrowserStorage({data:save.data,dataKey:getSlotDataKeyFromIndex(save.index),info:save.info,infoKey:getSlotInfoKeyFromIndex(save.index)})})),resolve(!0)}))}},load:{value:base64Load},save:{value:base64Save}}))},onLoad:{value:Object.preventExtensions(Object.create(null,{add:{value:function(handler){var valueType=getTypeOf(handler);if("function"!==valueType)throw new TypeError("Save.onLoad.add handler parameter must be a function (received: ".concat(valueType,")"));onLoadHandlers.add(handler)}},clear:{value:function(){onLoadHandlers.clear()}},delete:{value:function(handler){return onLoadHandlers.delete(handler)}},size:{get:function(){return onLoadHandlers.size}}}))},onSave:{value:Object.preventExtensions(Object.create(null,{add:{value:function(handler){var valueType=getTypeOf(handler);if("function"!==valueType)throw new TypeError("Save.onSave.add handler parameter must be a function (received: ".concat(valueType,")"));onSaveHandlers.add(handler)}},clear:{value:function(){onSaveHandlers.clear()}},delete:{value:function(handler){return onSaveHandlers.delete(handler)}},size:{get:function(){return onSaveHandlers.size}}}))},get:{value:function(){throw new Error("[REMOVED] Save.get() has been removed.")}},clear:{value:function(){return console.warn("[DEPRECATED] Save.clear() is deprecated."),browserClear()}},ok:{value:function(){return console.warn("[DEPRECATED] Save.ok() is deprecated."),browserIsEnabled()}},autosave:{value:Object.preventExtensions(Object.create(null,{ok:{value:function(){return console.warn("[DEPRECATED] Save.autosave.ok() is deprecated."),autoIsEnabled()}},has:{value:function(){return console.warn("[DEPRECATED] Save.autosave.has() is deprecated."),autoHas(0)}},get:{value:function(){return console.warn("[DEPRECATED] Save.autosave.get() is deprecated."),autoGet(0)}},load:{value:function(){return console.warn("[DEPRECATED] Save.autosave.load() is deprecated."),autoLoad(0)}},save:{value:function(){return console.warn("[DEPRECATED] Save.autosave.save() is deprecated."),autoSave.apply(void 0,arguments)}},delete:{value:function(){return console.warn("[DEPRECATED] Save.autosave.delete() is deprecated."),autoDelete(0)}}}))},slots:{value:Object.preventExtensions(Object.create(null,{ok:{value:function(){return console.warn("[DEPRECATED] Save.slots.ok() is deprecated."),slotIsEnabled()}},length:{get:function(){return console.warn("[DEPRECATED] Save.slots.length is deprecated."),Config.saves.maxSlotSaves}},isEmpty:{value:function(){return console.warn("[DEPRECATED] Save.slots.isEmpty() is deprecated."),0===slotSize()}},count:{value:function(){return console.warn("[DEPRECATED] Save.slots.count() is deprecated."),slotSize()}},has:{value:function(){return console.warn("[DEPRECATED] Save.slots.has() is deprecated."),slotHas.apply(void 0,arguments)}},get:{value:function(){return console.warn("[DEPRECATED] Save.slots.get() is deprecated."),slotGet.apply(void 0,arguments)}},load:{value:function(){return console.warn("[DEPRECATED] Save.slots.load() is deprecated."),slotLoad.apply(void 0,arguments)}},save:{value:function(){return console.warn("[DEPRECATED] Save.slots.save() is deprecated."),slotSave.apply(void 0,arguments)}},delete:{value:function(){return console.warn("[DEPRECATED] Save.slots.delete() is deprecated."),slotDelete.apply(void 0,arguments)}}}))},export:{value:function(){return console.warn("[DEPRECATED] Save.export() is deprecated."),diskSave.apply(void 0,arguments)}},import:{value:function(){return console.warn("[DEPRECATED] Save.import() is deprecated."),diskLoad.apply(void 0,arguments)}},serialize:{value:function(){return console.warn("[DEPRECATED] Save.serialize() is deprecated."),base64Save.apply(void 0,arguments)}},deserialize:{value:function(){return console.warn("[DEPRECATED] Save.deserialize() is deprecated."),base64Load.apply(void 0,arguments)}}}))}(),Setting=function(){var Types=enumFrom({Header:0,Toggle:1,List:2,Range:3,Value:4}),_definitions=[];function updateSettingsObject(value){window.SugarCube.settings=settings=value}function createResultObject(def){var result={name:def.name,value:settings[def.name],default:def.default};return Object.hasOwn(def,"list")&&(result.list=def.list),Object.hasOwn(def,"min")&&(result.min=def.min),Object.hasOwn(def,"max")&&(result.max=def.max),Object.hasOwn(def,"step")&&(result.step=def.step),result}function clear(){return updateSettingsObject(create()),storage.delete("settings"),!0}function create(){return Object.create(null)}function load(){var defaultSettings=create(),loadedSettings=storage.get("settings")||create();_definitions.filter((function(def){return def.type!==Types.Header})).forEach((function(def){return defaultSettings[def.name]=def.default})),updateSettingsObject(Object.assign(defaultSettings,loadedSettings))}function save(){var savedSettings=create();return Object.keys(settings).length>0&&_definitions.filter((function(def){return def.type!==Types.Header&&settings[def.name]!==def.default})).forEach((function(def){return savedSettings[def.name]=settings[def.name]})),0===Object.keys(savedSettings).length?(storage.delete("settings"),!0):storage.set("settings",savedSettings)}function add(type,name,def){if(arguments.length<2){var errors=[];throw arguments.length<1&&errors.push("type"),arguments.length<2&&errors.push("name"),new Error("missing parameters, no ".concat(errors.join(" or ")," specified"))}if(null==def)def={};else if("object"!==_typeof(def))throw new TypeError("definition parameter must be an object");if(has(name))throw new Error('cannot clobber existing setting "'.concat(name,'"'));var str,pos,definition={type:type,name:name};if(type!==Types.Value&&(definition.label="string"==typeof def.label?def.label.trim():""),"string"==typeof def.desc){var desc=def.desc.trim();""!==desc&&(definition.desc=desc)}switch(type){case Types.Header:break;case Types.List:if(!Object.hasOwn(def,"list"))throw new Error("no list specified");if(!Array.isArray(def.list))throw new TypeError("list must be an array");if(0===def.list.length)throw new Error("list must not be empty");if(definition.list=Object.freeze(def.list),null==def.default)definition.default=def.list[0];else{var defaultIndex=def.list.indexOf(def.default);if(-1===defaultIndex)throw new Error("list does not contain default");definition.default=def.list[defaultIndex]}break;case Types.Range:if(!Object.hasOwn(def,"min"))throw new Error("no min specified");if("number"!=typeof def.min||Number.isNaN(def.min)||!Number.isFinite(def.min))throw new TypeError("min must be a finite number");if(!Object.hasOwn(def,"max"))throw new Error("no max specified");if("number"!=typeof def.max||Number.isNaN(def.max)||!Number.isFinite(def.max))throw new TypeError("max must be a finite number");if(!Object.hasOwn(def,"step"))throw new Error("no step specified");if("number"!=typeof def.step||Number.isNaN(def.step)||!Number.isFinite(def.step)||def.step<=0)throw new TypeError("step must be a finite number greater than zero");var fracDigits=(str=String(def.step),-1===(pos=str.lastIndexOf("."))?0:str.length-pos-1);if(function(value){if(fracDigits>0){var ma=Number("".concat(def.min,"e").concat(fracDigits)),sa=Number("".concat(def.step,"e").concat(fracDigits)),_va=Number("".concat(value,"e").concat(fracDigits))-ma;return Number("".concat(_va-_va%sa+ma,"e-").concat(fracDigits))}var va=value-def.min;return va-va%def.step+def.min}(def.max)!==def.max)throw new RangeError("max (".concat(def.max,") is not a multiple of the step (").concat(def.step,") plus the min (").concat(def.min,")"));if(definition.max=def.max,definition.min=def.min,definition.step=def.step,null==def.default)definition.default=def.max;else{if("number"!=typeof def.default||Number.isNaN(def.default)||!Number.isFinite(def.default))throw new TypeError("default must be a finite number");if(def.default<def.min)throw new RangeError("default (".concat(def.default,") is less than min (").concat(def.min,")"));if(def.default>def.max)throw new RangeError("default (".concat(def.default,") is greater than max (").concat(def.max,")"));definition.default=def.default}break;case Types.Toggle:definition.default=Boolean(def.default);break;case Types.Value:definition.default=def.default;break;default:throw new Error("unknown Setting type: ".concat(type))}"function"==typeof def.onInit&&(definition.onInit=Object.freeze(def.onInit)),"function"==typeof def.onChange&&(definition.onChange=Object.freeze(def.onChange)),_definitions.push(Object.freeze(definition))}function get(name){return _definitions.find((function(definition){return definition.name===name}))}function has(name){return _definitions.some((function(definition){return definition.name===name}))}return Object.preventExtensions(Object.create(null,{Types:{value:Types},init:{value:function(){load(),_definitions.forEach((function(def){if(Object.hasOwn(def,"onInit")){var data=createResultObject(def);def.onInit.call(data,data)}}))}},clear:{value:clear},create:{value:create},load:{value:load},reset:{value:function(name){if(0===arguments.length)clear(),load();else{if(null==name||!has(name))throw new Error('nonexistent setting "'.concat(name,'"'));var def=get(name);def.type!==Types.Header&&(settings[name]=def.default)}return save()}},save:{value:save},add:{value:add},addHeader:{value:function(name,desc){add(Types.Header,name,{desc:desc})}},addList:{value:function(){for(var _len20=arguments.length,args=new Array(_len20),_key20=0;_key20<_len20;_key20++)args[_key20]=arguments[_key20];add.apply(void 0,[Types.List].concat(args))}},addRange:{value:function(){for(var _len21=arguments.length,args=new Array(_len21),_key21=0;_key21<_len21;_key21++)args[_key21]=arguments[_key21];add.apply(void 0,[Types.Range].concat(args))}},addToggle:{value:function(){for(var _len22=arguments.length,args=new Array(_len22),_key22=0;_key22<_len22;_key22++)args[_key22]=arguments[_key22];add.apply(void 0,[Types.Toggle].concat(args))}},addValue:{value:function(){for(var _len23=arguments.length,args=new Array(_len23),_key23=0;_key23<_len23;_key23++)args[_key23]=arguments[_key23];add.apply(void 0,[Types.Value].concat(args))}},delete:{value:function(name){for(var i=0;i<_definitions.length;++i)if(_definitions[i].name===name){_definitions.splice(i,1);break}Object.hasOwn(settings,name)&&delete settings[name]}},forEach:{value:function(callback,thisArg){_definitions.forEach(callback,thisArg)}},get:{value:get},has:{value:has},isEmpty:{value:function(){return 0===_definitions.length}},getValue:{value:function(name){return settings[name]}},setValue:{value:function(name,value){if(!has(name))throw new Error("no such setting");settings[name]=value,save();var def=get(name);if(Object.hasOwn(def,"onChange")){var data=createResultObject(def);def.onChange.call(data,data)}return!0}}}))}(),Story=function(){var _ifId="",_id="",_name="",_passages=createPassageStore(),_inits=[],_scripts=[],_styles=[],_widgets=[],codePassageNames=["PassageDone","PassageFooter","PassageHeader","PassageReady","StoryAuthor","StoryBanner","StoryCaption","StoryDisplayTitle","StoryInit","StoryInterface","StoryMenu","StoryShare","StorySubtitle"],codeTagNames=["init","widget"];function createPassageStore(passages){var store=Object.create(null);return passages?Object.assign(store,passages):store}function generateName(rawName){if(null==rawName)throw new Error("story name must not be null or undefined");var name=decodeEntities(String(rawName)).trim();if(""===name)throw new Error("story name must not be empty or consist solely of whitespace");return name}function getId(){return _id}function getName(){return _name}function filter(predicate,thisArg){if("function"!=typeof predicate)throw new TypeError("Story.filter() predicate parameter must be a function");for(var results=[],i=0,keys=Object.keys(_passages);i<keys.length;++i){var passage=_passages[keys[i]];predicate.call(void 0===thisArg?this:thisArg,passage)&&results.push(passage)}return results}return Object.preventExtensions(Object.create(null,{init:{value:function(){function assertNoCodeTags(passage,desc){if(passage.tags.includesAny(codeTagNames))throw new Error("".concat(desc,' passage "').concat(passage.name,'" includes code tags; invalid: "').concat(passage.tags.filter((function(tag){return codeTagNames.includes(tag)})).sort().join('", "'),'"'))}function assertValidCodeTagUsage(passage){var found=passage.tags.filter((function(tag){return codeTagNames.includes(tag)})).sort();if(found.length>1)throw new Error('passage "'.concat(passage.name,'" includes multiple code tags; invalid: "').concat(found.join('", "'),'"'))}var $storydata=jQuery("tw-storydata"),startNode=$storydata.attr("startnode")||"";Config.passages.start=null,Config.debug=/\bdebug\b/.test($storydata.attr("options")),$storydata.children("style").each((function(i){_styles.push(new Passage("tw-user-style-".concat(i),this))})),$storydata.children("script").each((function(i){_scripts.push(new Passage("tw-user-script-".concat(i),this))})),$storydata.children('tw-passagedata:not([tags~="Twine.private"],[tags~="annotation"])').each((function(){var $this=jQuery(this),pid=$this.attr("pid")||"",passage=new Passage($this.attr("name"),this);pid===startNode&&""!==startNode?(Config.passages.start=passage.name,assertNoCodeTags(passage,"starting"),_passages[passage.name]=passage):codePassageNames.includes(passage.name)?(assertNoCodeTags(passage,"code"),_passages[passage.name]=passage):passage.tags.includes("init")?(assertValidCodeTagUsage(passage),_inits.push(passage)):passage.tags.includes("widget")?(assertValidCodeTagUsage(passage),_widgets.push(passage)):_passages[passage.name]=passage})),_ifId=$storydata.attr("ifid"),_name=generateName("Liff Origins: Jaylie"),_id=function(name){var id=createSlug(name);if(""===id)if(""!==_ifId)id=_ifId;else for(var i=0;i<name.length;++i){var _charAndPosAt2=charAndPosAt(name,i),char=_charAndPosAt2.char,start=_charAndPosAt2.start,end=_charAndPosAt2.end;id+=char.codePointAt(0).toString(16),i+=end-start}return id}(_name),Config.saves.id=_id,document.title=_name}},id:{get:getId},ifId:{get:function(){return _ifId}},name:{get:getName},add:{value:function(descriptor){if("Object"!==getTypeOf(descriptor))throw new TypeError("Story.add() descriptor parameter must be a generic object");if(Object.hasOwn(_passages,descriptor.name))return!1;var elem=document.createElement("div");elem.setAttribute("name",descriptor.name),elem.setAttribute("tags",descriptor.tags),elem.textContent=descriptor.text;var passage=new Passage(descriptor.name,elem);if(codePassageNames.includes(passage.name))throw new Error('Story.add() passage descriptor object "'.concat(passage.name,'" must not be a code passage'));if(passage.tags.includesAny(codeTagNames))throw new Error('Story.add() passage descriptor object "'.concat(passage.name,'" must not include code tags'));return _passages[passage.name]=passage,!0}},delete:{value:function(name){var type=_typeof(name);switch(type){case"number":case"string":var key=String(name);if(!Object.hasOwn(_passages,key))return!1;if(key===Config.passages.start||codePassageNames.includes(key))throw new Error('Story.delete() passage "'.concat(key,'" must not be a code passage'));if(_passages[key].tags.includesAny(codeTagNames))throw new Error('Story.delete() passage "'.concat(key,'" must not include code tags'));return delete _passages[key],!0;case"undefined":break;case"object":type=null===name?"null":"an object";break;default:type="a ".concat(type)}throw new TypeError("Story.delete() name parameter cannot be ".concat(type))}},filter:{value:filter},find:{value:function(predicate,thisArg){if("function"!=typeof predicate)throw new TypeError("Story.find() predicate parameter must be a function");for(var i=0,keys=Object.keys(_passages);i<keys.length;++i){var passage=_passages[keys[i]];if(predicate.call(void 0===thisArg?this:thisArg,passage))return passage}}},get:{value:function(name){var type=_typeof(name);switch(type){case"number":case"string":var key=String(name);return Object.hasOwn(_passages,key)?_passages[key]:new Passage(key||"(unknown)");case"undefined":break;case"object":type=null===name?"null":"an object";break;default:type="a ".concat(type)}throw new TypeError("Story.get() name parameter cannot be ".concat(type))}},getInits:{value:function(){return Object.freeze(Array.from(_inits))}},getNormals:{value:function(){return Object.freeze(createPassageStore(_passages))}},getScripts:{value:function(){return Object.freeze(Array.from(_scripts))}},getStyles:{value:function(){return Object.freeze(Array.from(_styles))}},getWidgets:{value:function(){return Object.freeze(Array.from(_widgets))}},has:{value:function(name){var type=_typeof(name);switch(type){case"number":case"string":return Object.hasOwn(_passages,String(name));case"undefined":break;case"object":type=null===name?"null":"an object";break;default:type="a ".concat(type)}throw new TypeError("Story.has name parameter cannot be ".concat(type))}},domId:{get:function(){return console.warn("[DEPRECATED] Story.domId is deprecated."),getId()}},title:{get:function(){return console.warn("[DEPRECATED] Story.title is deprecated."),getName()}},lookup:{value:function(key,value){var sortKey=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"name";return console.warn("[DEPRECATED] Story.lookup() is deprecated."),filter((function(passage){return"object"===_typeof(passage[key])&&null!==passage[key]?passage[key]instanceof Array&&passage[key].some((function(m){return sameValueZero(m,value)})):sameValueZero(passage[key],value)})).sort((function(a,b){return a[sortKey]==b[sortKey]?0:a[sortKey]<b[sortKey]?-1:1}))}},lookupWith:{value:function(predicate){var sortKey=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"name";if(console.warn("[DEPRECATED] Story.lookupWith() is deprecated."),"function"!=typeof predicate)throw new TypeError("Story.lookupWith() predicate parameter must be a function");return filter(predicate).sort((function(a,b){return a[sortKey]==b[sortKey]?0:a[sortKey]<b[sortKey]?-1:1}))}}}))}(),UI=function(){function assembleLinkList(passage,listEl){var list=listEl,debugState=Config.debug;Config.debug=!1;try{null==list&&(list=document.createElement("ul"));var frag=document.createDocumentFragment();new Wikifier(frag,Story.get(passage).processText().trim(),{cleanup:!1});var errors=Array.from(frag.querySelectorAll(".error")).map((function(errEl){return errEl.textContent.replace(errorPrologRegExp,"")}));if(errors.length>0)throw new Error(errors.join("; "));for(;frag.hasChildNodes();){var node=frag.firstChild;if(node.nodeType===Node.ELEMENT_NODE&&"A"===node.nodeName.toUpperCase()){var li=document.createElement("li");list.appendChild(li),li.appendChild(node)}else frag.removeChild(node)}}finally{Config.debug=debugState}return list}function buildRestart(){return Dialog.create(L10n.get("restartTitle"),"restart").append("<p>".concat(L10n.get("restartMesgPrompt"),'</p><ul class="buttons">')+'<li><button id="restart-ok">'.concat(L10n.get(["restartTextOk","textOk"]),"</button></li>")+'<li><button id="restart-cancel" class="ui-close">'.concat(L10n.get(["restartTextCancel","textCancel"]),"</button></li>")+"</ul>"),jQuery(Dialog.body()).find("#restart-ok").ariaClick({one:!0},(function(){jQuery(document).one(":dialogclosed",(function(){return Engine.restart()})),Dialog.close()})),!0}function buildSaves(){function createFileInput(id,callback){var input=document.createElement("input");return jQuery(input).attr({id:id,type:"file",tabindex:-1,"aria-hidden":!0}).css({display:"block",visibility:"hidden",position:"fixed",left:"-16128px",top:"-16128px",width:"1px",height:"1px"}).on("change",callback),input}function createActionItem(id,classNames,text,label,callback){var $btn=jQuery(document.createElement("button")).attr("id","saves-".concat(id)).text(text);return classNames&&$btn.addClass(classNames),callback?$btn.ariaClick({label:label},callback):$btn.ariaDisabled(!0),jQuery(document.createElement("li")).append($btn)}var browserEnabled=Save.browser.isEnabled();if(!browserEnabled&&!Has.fileAPI)return openAlert(L10n.get("warningNoSaves")),!1;Dialog.create(L10n.get("savesTitle"),"saves");var $dialogBody=jQuery(Dialog.body());if(browserEnabled){jQuery(document.createElement("h2")).text(L10n.get("savesHeaderBrowser")).appendTo($dialogBody),$dialogBody.append(function(){function createButton(id,classNames,kind,index,callback){var text;switch(id){case"delete":text=L10n.get("textDelete");break;case"load":text=L10n.get("textLoad");break;case"save":text=L10n.get("textSave");break;default:throw new Error('buildSaves unknown ID "'.concat(id,'"'))}var $btn=jQuery(document.createElement("button")).attr("id","saves-".concat(id,"-").concat(index)).addClass(id);return classNames&&$btn.addClass(classNames),callback?$btn.ariaClick({label:"".concat(text," ").concat(kind," ").concat(index+1)},(function(){try{callback(index)}catch(ex){openAlert("".concat(ex.message,".</p><p>").concat(L10n.get("textAborting"),"."))}})):$btn.ariaDisabled(!0),$btn}var $tbody=jQuery(document.createElement("tbody"));Save.browser.auto.entries().forEach((function(_ref13){var index=_ref13.index,info=_ref13.info,$tdSlot=jQuery(document.createElement("td")),$tdLoad=jQuery(document.createElement("td")),$tdDesc=jQuery(document.createElement("td")),$tdDele=jQuery(document.createElement("td"));jQuery(document.createElement("div")).text(info.desc).appendTo($tdDesc),jQuery(document.createElement("div")).addClass("details").addClass("datestamp").text("".concat(L10n.get("savesTextBrowserAuto")," ").concat(index+1,"  •  ")).append(info.date?"".concat(new Date(info.date).toLocaleString()):"<em>".concat(L10n.get("savesTextNoDate"),"</em>")).appendTo($tdDesc),$tdLoad.append(createButton("load","ui-close",L10n.get("savesTextBrowserAuto"),index,(function(index){jQuery(document).one(":dialogclosed",(function(){Save.browser.auto.load(index).then(Engine.show,(function(ex){return openAlert("".concat(ex.message.toUpperFirst(),".</p><p>").concat(L10n.get("textAborting"),"."))}))}))}))),$tdDele.append(createButton("delete",null,L10n.get("savesTextBrowserAuto"),index,(function(index){Save.browser.auto.delete(index),buildSaves()}))),jQuery(document.createElement("tr")).append($tdSlot).append($tdLoad).append($tdDesc).append($tdDele).appendTo($tbody)}));var slotAllowed="function"!=typeof Config.saves.isAllowed||Config.saves.isAllowed(Save.Type.Slot);return Save.browser.slot.entries().reduce((function(slots,entry){return slots[entry.index]=entry,slots}),Array.from({length:Config.saves.maxSlotSaves},(function(_,i){return{index:i}}))).forEach((function(_ref14){var index=_ref14.index,info=_ref14.info,$tdSlot=jQuery(document.createElement("td")),$tdLoad=jQuery(document.createElement("td")),$tdDesc=jQuery(document.createElement("td")),$tdDele=jQuery(document.createElement("td"));info?(jQuery(document.createElement("div")).text(info.desc).appendTo($tdDesc),jQuery(document.createElement("div")).addClass("details").addClass("datestamp").text("".concat(L10n.get("savesTextBrowserSlot")," ").concat(index+1,"  •  ")).append(info.date?"".concat(new Date(info.date).toLocaleString()):"<em>".concat(L10n.get("savesTextNoDate"),"</em>")).appendTo($tdDesc),$tdLoad.append(createButton("load","ui-close",L10n.get("savesTextBrowserSlot"),index,(function(index){jQuery(document).one(":dialogclosed",(function(){Save.browser.slot.load(index).then(Engine.show,(function(ex){return openAlert("".concat(ex.message.toUpperFirst(),".</p><p>").concat(L10n.get("textAborting"),"."))}))}))}))),$tdDele.append(createButton("delete",null,L10n.get("savesTextBrowserSlot"),index,(function(index){Save.browser.slot.delete(index),buildSaves()})))):($tdDesc.addClass("empty"),jQuery(document.createElement("div")).text(" ").appendTo($tdDesc),jQuery(document.createElement("div")).addClass("details").addClass("datestamp").text("".concat(L10n.get("savesTextBrowserSlot")," ").concat(index+1)).appendTo($tdDesc),$tdLoad.append(createButton("save",null,L10n.get("savesTextBrowserSlot"),index,index<Config.saves.maxSlotSaves&&slotAllowed?function(index){Save.browser.slot.save(index),buildSaves()}:null)),$tdDele.append(createButton("delete",null,L10n.get("savesTextBrowserSlot"),index))),jQuery(document.createElement("tr")).append($tdSlot).append($tdLoad).append($tdDesc).append($tdDele).appendTo($tbody)})),jQuery(document.createElement("table")).attr("id","saves-list").append($tbody)}());var $slotButtons=jQuery(document.createElement("ul")).addClass("buttons slots").appendTo($dialogBody);if(Has.fileAPI){var slotImportInput=createFileInput("saves-import-handler",(function(ev){Save.disk.import(ev).then(buildSaves,(function(ex){return openAlert("".concat(ex.message.toUpperFirst(),".</p><p>").concat(L10n.get("textAborting"),"."))}))}));$slotButtons.append(createActionItem("export",null,"".concat(L10n.get("textExport"),"…"),L10n.get("savesLabelBrowserExport"),(function(){return Save.disk.export("saves-export-".concat(Story.name))}))).append(createActionItem("import",null,"".concat(L10n.get("textImport"),"…"),L10n.get("savesLabelBrowserImport"),(function(){return slotImportInput.click()}))),jQuery(slotImportInput).appendTo($dialogBody)}$slotButtons.append(createActionItem("clear",null,L10n.get("textClear"),L10n.get("savesLabelBrowserClear"),Save.browser.size>0?function(){Save.browser.clear(),buildSaves()}:null))}if(Has.fileAPI){jQuery(document.createElement("h2")).text(L10n.get("savesHeaderDisk")).appendTo($dialogBody);var $diskButtons=jQuery(document.createElement("ul")).addClass("buttons").appendTo($dialogBody),diskLoadInput=createFileInput("saves-disk-load-handler",(function(ev){jQuery(document).one(":dialogclosed",(function(){Save.disk.load(ev).then(Engine.show,(function(ex){return openAlert("".concat(ex.message.toUpperFirst(),".</p><p>").concat(L10n.get("textAborting"),"."))}))})),Dialog.close()}));$diskButtons.append(createActionItem("disk-save",null,"".concat(L10n.get("textSave"),"…"),L10n.get("savesLabelDiskSave"),"function"!=typeof Config.saves.isAllowed||Config.saves.isAllowed(Save.Type.Disk)?function(){return Save.disk.save(Story.name)}:null)).append(createActionItem("disk-load",null,"".concat(L10n.get("textLoad"),"…"),L10n.get("savesLabelDiskLoad"),(function(){return diskLoadInput.click()}))),jQuery(diskLoadInput).appendTo($dialogBody)}return!0}function buildSettings(){Dialog.create(L10n.get("settingsTitle"),"settings");var $dialogBody=jQuery(Dialog.body());return Setting.forEach((function(control){switch(control.type){case Setting.Types.Header:var _name2=control.name,_id2=createSlug(_name2),$header=jQuery(document.createElement("div")),$heading=jQuery(document.createElement("h2"));return $header.attr("id","header-body-".concat(_id2)).append($heading).appendTo($dialogBody),$heading.attr("id","header-heading-".concat(_id2)).wikiWithOptions({cleanup:!1},_name2),void(control.desc&&jQuery(document.createElement("p")).attr("id","header-desc-".concat(_id2)).wikiWithOptions({cleanup:!1},control.desc).appendTo($header));case Setting.Types.Value:return}var $control,name=control.name,id=createSlug(name),$setting=jQuery(document.createElement("div")),$label=jQuery(document.createElement("label")),$controlBox=jQuery(document.createElement("div"));switch(jQuery(document.createElement("div")).append($label).append($controlBox).appendTo($setting),control.desc&&jQuery(document.createElement("p")).attr("id","setting-desc-".concat(id)).wikiWithOptions({cleanup:!1},control.desc).appendTo($setting),$label.attr({id:"setting-label-".concat(id),for:"setting-control-".concat(id)}).wikiWithOptions({cleanup:!1},control.label),null==Setting.getValue(name)&&Setting.setValue(name,control.default),control.type){case Setting.Types.List:$control=jQuery(document.createElement("select"));for(var i=0,iend=control.list.length;i<iend;++i)jQuery(document.createElement("option")).val(i).text(control.list[i]).appendTo($control);$control.val(control.list.indexOf(Setting.getValue(name))).attr("tabindex",0).on("change",(function(){Setting.setValue(name,control.list[Number(this.value)])}));break;case Setting.Types.Range:($control=jQuery(document.createElement("input"))).attr({type:"range",min:control.min,max:control.max,step:control.step,value:Setting.getValue(name),tabindex:0}).on("change input",(function(){Setting.setValue(name,Number(this.value))})).on("keypress",(function(ev){13===ev.which&&(ev.preventDefault(),triggerEvent("change",$control))}));break;case Setting.Types.Toggle:$control=jQuery(document.createElement("button")),Setting.getValue(name)?$control.addClass("enabled").text(L10n.get("textOn")):$control.text(L10n.get("textOff")),$control.ariaClick((function(){var status=Setting.getValue(name);status?jQuery(this).removeClass("enabled").text(L10n.get("textOff")):jQuery(this).addClass("enabled").text(L10n.get("textOn")),Setting.setValue(name,!status)}))}$control.attr("id","setting-control-".concat(id)).appendTo($controlBox),$setting.attr("id","setting-body-".concat(id)).appendTo($dialogBody)})),$dialogBody.append('<ul class="buttons">'+'<li><button id="settings-ok" class="ui-close">'.concat(L10n.get(["settingsTextOk","textOk"]),"</button></li>")+'<li><button id="settings-reset">'.concat(L10n.get("settingsTextReset"),"</button></li>")+"</ul>").find("#settings-reset").ariaClick({one:!0},(function(){jQuery(document).one(":dialogclosed",(function(){Setting.reset(),window.location.reload()})),Dialog.close()})),!0}function openAlert(message){for(var _Dialog$create$append,_len24=arguments.length,args=new Array(_len24>1?_len24-1:0),_key24=1;_key24<_len24;_key24++)args[_key24-1]=arguments[_key24];(_Dialog$create$append=Dialog.create(L10n.get("alertTitle"),"alert").append("<p>".concat(message,'</p><ul class="buttons">')+'<li><button id="alert-ok" class="ui-close">'.concat(L10n.get(["alertTextOk","textOk"]),"</button></li>")+"</ul>")).open.apply(_Dialog$create$append,args)}function buildJumpto(){console.warn("[DEPRECATED] UI.buildJumpto() is deprecated.");var list=document.createElement("ul");Dialog.create(L10n.get("jumptoTitle"),"jumpto list").append(list);for(var expired=State.expired.length,i=State.size-1;i>=0;--i)if(i!==State.activeIndex){var passage=Story.get(State.history[i].title);passage&&passage.tags.includes("bookmark")&&jQuery(document.createElement("li")).append(jQuery(document.createElement("a")).ariaClick({one:!0},function(index){return function(){return jQuery(document).one(":dialogclosed",(function(){return Engine.goTo(index)}))}}(i)).addClass("ui-close").text("".concat(L10n.get("textTurn")," ").concat(expired+i+1))).appendTo(list)}list.hasChildNodes()||jQuery(list).append("<li><a><em>".concat(L10n.get("jumptoMesgUnavailable"),"</em></a></li>"))}function buildShare(){console.warn("[DEPRECATED] UI.buildShare() is deprecated.");try{Dialog.create(L10n.get("shareTitle"),"share list").append(assembleLinkList("StoryShare"))}catch(ex){return console.error(ex),Alert.error("StoryShare",ex.message),!1}return!0}return Object.preventExtensions(Object.create(null,{assembleLinkList:{value:assembleLinkList},buildRestart:{value:buildRestart},buildSaves:{value:buildSaves},buildSettings:{value:buildSettings},update:{value:function(){triggerEvent(":uiupdate")}},alert:{value:openAlert},restart:{value:function(){buildRestart(),Dialog.open.apply(Dialog,arguments)}},saves:{value:function(){buildSaves(),Dialog.open.apply(Dialog,arguments)}},settings:{value:function(){buildSettings(),Dialog.open.apply(Dialog,arguments)}},buildAutoload:{value:function(){return console.warn("[DEPRECATED] UI.buildAutoload() is deprecated."),Dialog.create(L10n.get("autoloadTitle"),"autoload").append("<p>".concat(L10n.get("autoloadMesgPrompt"),'</p><ul class="buttons">')+'<li><button id="autoload-ok" class="ui-close">'.concat(L10n.get(["autoloadTextOk","textOk"]),"</button></li>")+'<li><button id="autoload-cancel" class="ui-close">'.concat(L10n.get(["autoloadTextCancel","textCancel"]),"</button></li>")+"</ul>"),jQuery(document).one("click.autoload",".ui-close",(function(ev){var isAutoloadOk="autoload-ok"===ev.target.id;jQuery(document).one(":dialogclosed",(function(){new Promise((function(resolve,reject){isAutoloadOk&&resolve(),reject()})).then((function(){return Save.browser.continue()})).catch((function(){Engine.play(Config.passages.start)}))}))})),!0}},buildJumpto:{value:buildJumpto},buildShare:{value:buildShare},jumpto:{value:function(){buildJumpto(),Dialog.open.apply(Dialog,arguments)}},share:{value:function(){buildShare(),Dialog.open.apply(Dialog,arguments)}}}))}(),UIBar=function(){var _$uiBar=null;function stow(noAnimation){var $story;_$uiBar&&!_$uiBar.hasClass("stowed")&&(noAnimation&&(($story=jQuery("#story")).addClass("no-transition"),_$uiBar.addClass("no-transition")),_$uiBar.addClass("stowed"),noAnimation&&setTimeout((function(){$story.removeClass("no-transition"),_$uiBar.removeClass("no-transition")}),Engine.DOM_DELAY));return UIBar}function update(){if(console.warn("[DEPRECATED] UIBar.update() is deprecated."),_$uiBar)return UI.update(),UIBar}return Object.preventExtensions(Object.create(null,{init:{value:function(){if(!document.getElementById("ui-bar")){var toggleLabel,backwardLabel,jumptoLabel,forwardLabel,$backward,$forward,$elems=(toggleLabel=L10n.get("uiBarLabelToggle"),backwardLabel=L10n.get("uiBarLabelBackward"),jumptoLabel=L10n.get("uiBarLabelJumpto"),forwardLabel=L10n.get("uiBarLabelForward"),jQuery(document.createDocumentFragment()).append('<div id="ui-bar" aria-live="polite"><div id="ui-bar-tray">'+'<button id="ui-bar-toggle" tabindex="0" title="'.concat(toggleLabel,'" aria-label="').concat(toggleLabel,'"></button>')+'<div id="ui-bar-history">'+'<button id="history-backward" tabindex="0" title="'.concat(backwardLabel,'" aria-label="').concat(backwardLabel,'"></button>')+'<button id="history-jumpto" tabindex="0" title="'.concat(jumptoLabel,'" aria-label="').concat(jumptoLabel,'"></button>')+'<button id="history-forward" tabindex="0" title="'.concat(forwardLabel,'" aria-label="').concat(forwardLabel,'"></button>')+'</div></div><div id="ui-bar-body"><header id="title" role="banner"><div id="story-banner"></div><h1 id="story-title"></h1><div id="story-subtitle"></div><div id="story-title-separator"></div><p id="story-author"></p></header><div id="story-caption"></div><nav id="menu" role="navigation"><ul id="menu-story"></ul><ul id="menu-core">'+'<li id="menu-item-continue"><a tabindex="0">'.concat(L10n.get("continueTitle"),"</a></li>")+'<li id="menu-item-saves"><a tabindex="0">'.concat(L10n.get("savesTitle"),"</a></li>")+'<li id="menu-item-settings"><a tabindex="0">'.concat(L10n.get("settingsTitle"),"</a></li>")+'<li id="menu-item-restart"><a tabindex="0">'.concat(L10n.get("restartTitle"),"</a></li>")+'<li id="menu-item-share"><a tabindex="0">'.concat(L10n.get("shareTitle"),"</a></li>")+"</ul></nav></div></div>"));_$uiBar=jQuery($elems.find("#ui-bar").get(0)),$elems.insertBefore("body>script#script-sugarcube"),jQuery(document).on(":historyupdate".concat(".ui-bar"),($backward=jQuery("#history-backward"),$forward=jQuery("#history-forward"),function(){$backward.ariaDisabled(State.length<2),$forward.ariaDisabled(State.length===State.size)}))}}},destroy:{value:function(){_$uiBar&&(_$uiBar.hide(),jQuery(document).off(".ui-bar"),jQuery(document.head).find("#style-ui-bar").remove(),_$uiBar.remove(),_$uiBar=null)}},hide:{value:function(){return _$uiBar&&_$uiBar.hide(),UIBar}},isHidden:{value:function(){return _$uiBar&&"none"===_$uiBar.css("display")}},isStowed:{value:function(){return _$uiBar&&_$uiBar.hasClass("stowed")}},show:{value:function(){return _$uiBar&&_$uiBar.show(),UIBar}},start:{value:function(){if(_$uiBar){("boolean"==typeof Config.ui.stowBarInitially?Config.ui.stowBarInitially:jQuery(window).width()<=Config.ui.stowBarInitially)&&stow(!0),jQuery("#ui-bar-toggle").ariaClick({label:L10n.get("uiBarLabelToggle")},(function(){return _$uiBar.toggleClass("stowed")})),Config.history.controls?(jQuery("#history-backward").ariaDisabled(State.length<2).ariaClick({label:L10n.get("uiBarLabelBackward")},(function(){return Engine.backward()})),Story.filter((function(passage){return passage.tags.includes("bookmark")})).length>0?jQuery("#history-jumpto").ariaClick({label:L10n.get("uiBarLabelJumpto")},(function(){return UI.jumpto()})):jQuery("#history-jumpto").remove(),jQuery("#history-forward").ariaDisabled(State.length===State.size).ariaClick({label:L10n.get("uiBarLabelForward")},(function(){return Engine.forward()}))):jQuery("#ui-bar-history").remove();var storyTitleHandler,addUiUpdateHandler=function(handler){return jQuery(document)[Config.ui.updateStoryElements?"on":"one"](":uiupdate".concat(".ui-bar"),handler)},addUpdaterOrRemove=function(selector,passageName){var $el=jQuery(selector);Story.has(passageName)?addUiUpdateHandler((function(){var frag=document.createDocumentFragment();new Wikifier(frag,Story.get(passageName).processText().trim()),$el.empty().append(frag)})):$el.remove()};if(storyTitleHandler=Story.has("StoryDisplayTitle")?function(){return setDisplayTitle(Story.get("StoryDisplayTitle").processText())}:function(){return setDisplayTitle(Story.name,!0)},addUiUpdateHandler(storyTitleHandler),addUpdaterOrRemove("#story-banner","StoryBanner"),addUpdaterOrRemove("#story-subtitle","StorySubtitle"),addUpdaterOrRemove("#story-author","StoryAuthor"),addUpdaterOrRemove("#story-caption","StoryCaption"),Story.has("StoryMenu")){var $menuStory=jQuery("#menu-story");jQuery(document).on(":uiupdate".concat(".ui-bar"),(function(){try{var frag=UI.assembleLinkList("StoryMenu",document.createDocumentFragment());$menuStory.empty().append(frag)}catch(ex){console.error(ex),Alert.error("StoryMenu",ex.message)}}))}else jQuery("#menu-story").remove();Save.browser.size>0?(jQuery("#menu-item-continue a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),Save.browser.continue().then((function(){jQuery(document).off(".menu-item-continue"),jQuery("#menu-item-continue").remove(),Engine.show()}),(function(ex){return UI.alert("".concat(ex.message.toUpperFirst(),".</p><p>").concat(L10n.get("textAborting"),"."))}))})).text(L10n.get("continueTitle")),jQuery(document).on(":passagestart.menu-item-continue",(function(){State.turns>1&&(jQuery(document).off(".menu-item-continue"),jQuery("#menu-item-continue").remove())}))):jQuery("#menu-item-continue").remove(),jQuery("#menu-item-saves a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildSaves(),Dialog.open()})).text(L10n.get("savesTitle")),Setting.isEmpty()?jQuery("#menu-item-settings").remove():jQuery("#menu-item-settings a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildSettings(),Dialog.open()})).text(L10n.get("settingsTitle")),jQuery("#menu-item-restart a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildRestart(),Dialog.open()})).text(L10n.get("restartTitle")),Story.has("StoryShare")?jQuery("#menu-item-share a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildShare(),Dialog.open()})).text(L10n.get("shareTitle")):jQuery("#menu-item-share").remove()}}},stow:{value:stow},unstow:{value:function(noAnimation){var $story;return _$uiBar&&_$uiBar.hasClass("stowed")&&(noAnimation&&(($story=jQuery("#story")).addClass("no-transition"),_$uiBar.addClass("no-transition")),_$uiBar.removeClass("stowed"),noAnimation&&setTimeout((function(){$story.removeClass("no-transition"),_$uiBar.removeClass("no-transition")}),Engine.DOM_DELAY)),UIBar}},setStoryElements:{value:update},update:{value:update}}))}(),DebugBar=function(){var STORAGE_KEY="debug.state",WATCH_LIST_DELAY=200,VAR_LIST_DELAY=500,variableRE=new RegExp("^".concat(Patterns.variable,"$")),numericKeyRE=/^\d+$/,watchList=[],varList=[],watchTimerId=null,listTimerId=null,stowed=!0,$debugBar=null,$watchBody=null,$varDataList=null,$turnSelect=null,$passageDataList=null;function debugBarStow(){disableWatchUpdates(),disableVarListUpdates(),$debugBar.css("right","-".concat($debugBar.outerWidth(),"px")),stowed=!0,updateSession()}function debugBarUnstow(){debugBarWatchIsEnabled()&&enableWatchUpdates(),enableVarListUpdates(),$debugBar.css("right",0),stowed=!1,updateSession()}function debugBarToggle(){stowed?debugBarUnstow():debugBarStow()}function debugBarWatchAdd(varName){variableRE.test(varName)&&(watchList.pushUnique(varName),watchList.sort(),updateWatchBody(),updateVarList(),updateSession())}function debugBarWatchAddAll(){Object.keys(State.variables).map((function(name){return watchList.pushUnique("$".concat(name))})),Object.keys(State.temporary).map((function(name){return watchList.pushUnique("_".concat(name))})),watchList.sort(),updateWatchBody(),updateVarList(),updateSession()}function debugBarWatchClear(){watchList.length=0,$watchBody.empty().append("<div>— ".concat(L10n.get("debugBarMesgNoWatches")," —</div>")),updateWatchBody(),updateVarList(),updateSession()}function debugBarWatchDelete(varName){watchList.deleteFirst(varName),$watchBody.find('tr[data-name="'.concat(varName,'"]')).remove(),updateWatchBody(),updateVarList(),updateSession()}function debugBarWatchDisable(){disableWatchUpdates(),disableWatch(),updateSession()}function debugBarWatchEnable(){enableWatchUpdates(),enableWatch(),updateSession()}function debugBarWatchIsEnabled(){return!$watchBody.attr("hidden")}function debugBarWatchToggle(){$watchBody.attr("hidden")?debugBarWatchEnable():debugBarWatchDisable()}function disableWatch(){$watchBody.attr({"aria-hidden":!0,hidden:"hidden"})}function disableWatchUpdates(){null!==watchTimerId&&(clearInterval(watchTimerId),watchTimerId=null)}function enableWatch(){$watchBody.removeAttr("aria-hidden hidden")}function enableWatchUpdates(){null===watchTimerId&&(watchTimerId=setInterval((function(){return updateWatchBody()}),WATCH_LIST_DELAY))}function disableVarListUpdates(){null!==listTimerId&&(clearInterval(listTimerId),listTimerId=null)}function enableVarListUpdates(){null===listTimerId&&(listTimerId=setInterval((function(){return updateVarList()}),VAR_LIST_DELAY))}function clearSession(){session.delete(STORAGE_KEY)}function updateSession(){session.set(STORAGE_KEY,{stowed:stowed,watchList:watchList,watchEnabled:debugBarWatchIsEnabled(),viewsEnabled:DebugView.isEnabled()})}function updateWatchBody(){if(0!==watchList.length){var $tbody,$rowMap=new Map,$table=jQuery($watchBody.children("table"));$table.length>0?($tbody=jQuery($table.children("tbody"))).children("tr").each((function(_,el){return $rowMap.set(el.getAttribute("data-name"),jQuery(el))})):($table=jQuery(document.createElement("table")),$tbody=jQuery(document.createElement("tbody")),$table.append($tbody),$watchBody.empty().append($table));var delLabel=L10n.get("debugBarLabelWatchDelete"),cursor=$rowMap.size>0?$tbody.children("tr").get(0):null;watchList.forEach((function(varName){var varKey=varName.slice(1),value=toWatchString(("$"===varName[0]?State.variables:State.temporary)[varKey]),$row=$rowMap.get(varName);if($row){var $code=$row.children().children("code");value!==$code.text()&&$code.text(value)}else $row=function(varName,value){var $row=jQuery(document.createElement("tr")),$delBtn=jQuery(document.createElement("button")),$code=jQuery(document.createElement("code"));return $row.attr("data-name",varName),$delBtn.addClass("watch-delete").ariaClick({one:!0,label:delLabel},(function(){return debugBarWatchDelete(varName)})),$code.text(value),jQuery(document.createElement("td")).append($delBtn).appendTo($row),jQuery(document.createElement("td")).text(varName).appendTo($row),jQuery(document.createElement("td")).append($code).appendTo($row),$row}(varName,value),cursor?$row.insertAfter(cursor):$row.appendTo($tbody);cursor=$row.get(0)}))}}function updateVarList(){var names=[].concat(Object.keys(State.variables).map((function(name){return"$".concat(name)})),Object.keys(State.temporary).map((function(name){return"_".concat(name)})));if(0===names.length)return varList.length=0,void $varDataList.empty();if(names.sort().deleteAll(watchList),names.length!==varList.length||!names.every((function(m,i){return m===varList[i]}))){varList=names;var options=document.createDocumentFragment();varList.forEach((function(name){jQuery(document.createElement("option")).val(name).appendTo(options)})),$varDataList.empty().append(options)}}function updateTurnSelect(){for(var histLen=State.size,expLen=State.expired.length,options=document.createDocumentFragment(),i=0;i<histLen;++i)jQuery(document.createElement("option")).val(i).text("".concat(expLen+i+1,". ").concat(State.history[i].title)).appendTo(options);$turnSelect.empty().ariaDisabled(histLen<2).append(options).val(State.activeIndex)}function updatePassageList(){var passages=Object.keys(Story.getNormals()).sort(),options=document.createDocumentFragment();passages.forEach((function(name){jQuery(document.createElement("option")).val(name).appendTo(options)})),$passageDataList.empty().append(options)}function toWatchString(O){if(null===O)return"null";switch(_typeof(O)){case"bigint":case"boolean":case"number":case"symbol":case"undefined":return String(O);case"string":return JSON.stringify(O);case"function":return"Function"}var objType=getToStringTag(O);if("Date"===objType)return"Date {".concat(O.toLocaleString(),"}");if("RegExp"===objType)return"RegExp ".concat(O.toString());var result=[];if(O instanceof Array||O instanceof Set){for(var list=O instanceof Array?O:Array.from(O),i=0,len=list.length;i<len;++i)result.push(Object.hasOwn(list,i)?toWatchString(list[i]):"<empty>");return Object.keys(list).filter((function(key){return!numericKeyRE.test(key)})).forEach((function(key){return result.push("".concat(toWatchString(key),": ").concat(toWatchString(list[key])))})),"".concat(objType,"(").concat(list.length,") [").concat(result.join(", "),"]")}return O instanceof Map?(O.forEach((function(val,key){return result.push("".concat(toWatchString(key)," → ").concat(toWatchString(val)))})),"".concat(objType,"(").concat(O.size,") {").concat(result.join(", "),"}")):(Object.keys(O).forEach((function(key){return result.push("".concat(toWatchString(key),": ").concat(toWatchString(O[key])))})),"".concat(objType," {").concat(result.join(", "),"}"))}return Object.preventExtensions(Object.create(null,{init:{value:function(){if(Config.debug){var barToggleLabel=L10n.get("debugBarLabelToggle"),watchAddLabel=L10n.get("debugBarLabelWatchAdd"),watchAllLabel=L10n.get("debugBarLabelWatchAll"),watchClearLabel=L10n.get("debugBarLabelWatchClear"),watchToggleLabel=L10n.get("debugBarLabelWatchToggle"),viewsToggleLabel=L10n.get("debugBarLabelViewsToggle"),passagePlayLabel=L10n.get("debugBarLabelPassagePlay");jQuery(document.createDocumentFragment()).append('<div id="debug-bar"><div id="debug-bar-watch">'+"<div>— ".concat(L10n.get("debugBarMesgNoWatches")," —</div>")+"</div><div>"+'<label id="debug-bar-watch-label" for="debug-bar-watch-input">'.concat(L10n.get("debugBarTextWatch"),"</label>")+'<input id="debug-bar-watch-input" name="debug-bar-watch-input" type="text" placeholder="'.concat(L10n.get("debugBarLabelWatchPlaceholder"),'" list="debug-bar-var-list" tabindex="0">')+'<datalist id="debug-bar-var-list" aria-hidden="true" hidden="hidden"></datalist>'+'<button id="debug-bar-watch-add" tabindex="0" title="'.concat(watchAddLabel,'" aria-label="').concat(watchAddLabel,'"></button>')+'<button id="debug-bar-watch-all" tabindex="0" title="'.concat(watchAllLabel,'" aria-label="').concat(watchAllLabel,'"></button>')+'<button id="debug-bar-watch-clear" tabindex="0" title="'.concat(watchClearLabel,'" aria-label="').concat(watchClearLabel,'"></button>')+"</div><div>"+'<label id="debug-bar-turn-label" for="debug-bar-turn-select">'.concat(L10n.get("textTurn"),"</label>")+'<select id="debug-bar-turn-select" tabindex="0"></select></div><div>'+'<label id="debug-bar-passage-label" for="debug-bar-passage-input">'.concat(L10n.get("debugBarTextPassage"),"</label>")+'<input id="debug-bar-passage-input" name="debug-bar-passage-input" type="text" placeholder="'.concat(L10n.get("debugBarLabelPassagePlaceholder"),'" list="debug-bar-passage-list" tabindex="0">')+'<datalist id="debug-bar-passage-list" aria-hidden="true" hidden="hidden"></datalist>'+'<button id="debug-bar-passage-play" tabindex="0" title="'.concat(passagePlayLabel,'" aria-label="').concat(passagePlayLabel,'"></button>')+"</div><div>"+'<button id="debug-bar-views-toggle" tabindex="0" title="'.concat(viewsToggleLabel,'" aria-label="').concat(viewsToggleLabel,'">').concat(L10n.get("debugBarTextViews"),"</button>")+'<button id="debug-bar-watch-toggle" tabindex="0" title="'.concat(watchToggleLabel,'" aria-label="').concat(watchToggleLabel,'">').concat(L10n.get("debugBarTextWatch"),"</button>")+"</div>"+'<button id="debug-bar-toggle" tabindex="0" title="'.concat(barToggleLabel,'" aria-label="').concat(barToggleLabel,'"></button>')+'</div><div id="debug-bar-hint"></div>').appendTo("body"),$debugBar=jQuery("#debug-bar"),$watchBody=jQuery($debugBar.find("#debug-bar-watch").get(0)),$varDataList=jQuery($debugBar.find("#debug-bar-var-list").get(0)),$turnSelect=jQuery($debugBar.find("#debug-bar-turn-select").get(0)),$passageDataList=jQuery($debugBar.find("#debug-bar-passage-list").get(0));var $watchInput=jQuery($debugBar.find("#debug-bar-watch-input").get(0)),$watchAdd=jQuery($debugBar.find("#debug-bar-watch-add").get(0)),$watchAll=jQuery($debugBar.find("#debug-bar-watch-all").get(0)),$watchClear=jQuery($debugBar.find("#debug-bar-watch-clear").get(0)),$passageInput=jQuery($debugBar.find("#debug-bar-passage-input").get(0)),$passagePlay=jQuery($debugBar.find("#debug-bar-passage-play").get(0)),$viewsToggle=jQuery($debugBar.find("#debug-bar-views-toggle").get(0)),$watchToggle=jQuery($debugBar.find("#debug-bar-watch-toggle").get(0)),$barToggle=jQuery($debugBar.find("#debug-bar-toggle").get(0));$watchInput.on("sc:debug-watch-add",(function(){debugBarWatchAdd(this.value.trim()),this.value=""})).on("keypress",(function(ev){13===ev.which&&(ev.preventDefault(),triggerEvent("sc:debug-watch-add",$watchInput))})),$watchAdd.ariaClick((function(){return triggerEvent("sc:debug-watch-add",$watchInput)})),$watchAll.ariaClick(debugBarWatchAddAll),$watchClear.ariaClick(debugBarWatchClear),$turnSelect.on("change",(function(){Engine.goTo(Number(this.value))})),$passageInput.on("sc:debug-passage-play",(function(){Engine.play(this.value.trim()),this.value=""})).on("keypress",(function(ev){13===ev.which&&(ev.preventDefault(),triggerEvent("sc:debug-passage-play",$passageInput))})).on("focus",updatePassageList),$passagePlay.ariaClick((function(){return triggerEvent("sc:debug-passage-play",$passageInput)})),$viewsToggle.ariaClick((function(){DebugView.toggle(),updateSession()})),$watchToggle.ariaClick(debugBarWatchToggle),$barToggle.ariaClick(debugBarToggle),jQuery(document).on(":passageend.debug-bar",(function(){updateWatchBody(),updateVarList()})).on(":historyupdate.debug-bar",updateTurnSelect).on(":enginerestart.debug-bar",clearSession)}else jQuery(document.head).find('[id|="style-ui-debug"]').remove()}},isStowed:{value:function(){return stowed}},start:{value:function(){Config.debug&&(function(){if(!session.has(STORAGE_KEY))return!1;var debugState=session.get(STORAGE_KEY);watchList.push.apply(watchList,_toConsumableArray(debugState.watchList)),debugState.watchEnabled?(stowed?disableWatchUpdates():enableWatchUpdates(),enableWatch()):(disableWatchUpdates(),disableWatch());debugState.viewsEnabled?DebugView.enable():DebugView.disable();(stowed=debugState.stowed)?(disableVarListUpdates(),debugBarStow()):(enableVarListUpdates(),debugBarUnstow());return!0}()||(debugBarStow(),DebugView.enable(),enableWatchUpdates(),enableWatch()),updateVarList(),updateTurnSelect())}},stow:{value:debugBarStow},toggle:{value:debugBarToggle},unstow:{value:debugBarUnstow},watch:{value:Object.preventExtensions(Object.create(null,{add:{value:debugBarWatchAdd},all:{value:debugBarWatchAddAll},clear:{value:debugBarWatchClear},delete:{value:debugBarWatchDelete},disable:{value:debugBarWatchDisable},enable:{value:debugBarWatchEnable},isEnabled:{value:debugBarWatchIsEnabled},toggle:{value:debugBarWatchToggle}}))}}))}(),LoadScreen=function(){var _locks=new Set,_autoId=0;function loadScreenHide(){jQuery(document.documentElement).removeAttr("data-init")}function loadScreenShow(){jQuery(document.documentElement).attr("data-init","loading")}return Object.preventExtensions(Object.create(null,{init:{value:function(){jQuery(document).on("readystatechange.SugarCube",(function(){_locks.size>0||("complete"===document.readyState?"loading"===jQuery(document.documentElement).attr("data-init")&&(Config.loadDelay>0?setTimeout((function(){0===_locks.size&&loadScreenHide()}),Math.max(Engine.DOM_DELAY,Config.loadDelay)):loadScreenHide()):loadScreenShow())}))}},clear:{value:function(){jQuery(document).off("readystatechange.SugarCube"),_locks.clear(),loadScreenHide()}},hide:{value:loadScreenHide},show:{value:loadScreenShow},lock:{value:function(){return++_autoId,_locks.add(_autoId),loadScreenShow(),_autoId}},unlock:{value:function(id){if(null==id)throw new Error("LoadScreen.unlock called with a null or undefined ID");_locks.has(id)&&_locks.delete(id),0===_locks.size&&triggerEvent("readystatechange")}},size:{get:function(){return _locks.size}}}))}(),Util=Object.preventExtensions(Object.create(null,{charAndPosAt:{value:function(){return console.warn("[DEPRECATED] Util.charAndPosAt() is deprecated."),charAndPosAt.apply(void 0,arguments)}},escape:{value:function(){return console.warn("[DEPRECATED] Util.escape() is deprecated."),encodeEntities.apply(void 0,arguments)}},escapeMarkup:{value:function(){return console.warn("[DEPRECATED] Util.escapeMarkup() is deprecated."),encodeMarkup.apply(void 0,arguments)}},fromCssProperty:{value:function(){return console.warn("[DEPRECATED] Util.fromCssProperty() is deprecated."),cssPropToDOMProp.apply(void 0,arguments)}},fromCssTime:{value:function(){return console.warn("[DEPRECATED] Util.fromCssTime() is deprecated."),cssTimeToMS.apply(void 0,arguments)}},getType:{value:function(){return console.warn("[DEPRECATED] Util.getType() is deprecated."),getTypeOf.apply(void 0,arguments)}},hasMediaQuery:{value:function(){return console.warn("[DEPRECATED] Util.hasMediaQuery() is deprecated."),hasMediaQuery.apply(void 0,arguments)}},newExceptionFrom:{value:function(){return console.warn("[DEPRECATED] Util.newExceptionFrom() is deprecated."),exceptionFrom.apply(void 0,arguments)}},now:{value:function(){return console.warn("[DEPRECATED] Util.now() is deprecated."),now.apply(void 0,arguments)}},parseUrl:{value:function(){return console.warn("[DEPRECATED] Util.parseUrl() is deprecated."),parseURL.apply(void 0,arguments)}},sameValueZero:{value:function(){return console.warn("[DEPRECATED] Util.sameValueZero() is deprecated."),sameValueZero.apply(void 0,arguments)}},sanitizeFilename:{value:function(){return console.warn("[DEPRECATED] Util.sanitizeFilename() is deprecated."),createFilename.apply(void 0,arguments)}},scrubEventKey:{value:function(){return console.warn("[DEPRECATED] Util.scrubEventKey() is deprecated."),scrubEventKey.apply(void 0,arguments)}},slugify:{value:function(){return console.warn("[DEPRECATED] Util.slugify() is deprecated."),createSlug.apply(void 0,arguments)}},toCssTime:{value:function(){return console.warn("[DEPRECATED] Util.toCssTime() is deprecated."),msToCSSTime.apply(void 0,arguments)}},toEnum:{value:function(){return console.warn("[DEPRECATED] Util.toEnum() is deprecated."),enumFrom.apply(void 0,arguments)}},toStringTag:{value:function(){return console.warn("[DEPRECATED] Util.toStringTag() is deprecated."),getToStringTag.apply(void 0,arguments)}},unescape:{value:function(){return console.warn("[DEPRECATED] Util.unescape() is deprecated."),decodeEntities.apply(void 0,arguments)}}})),version=(semVerRE=/^[Vv]?(\d+)(?:\.(\d+)(?:\.(\d+)(?:-[0-9A-Za-z.-]+)?(?:\+[0-9A-Za-z.-]+)?)?)?$/,Object.preventExtensions(Object.create(null,{name:{value:"SugarCube"},major:{value:2},minor:{value:37},patch:{value:3},prerelease:{value:""},build:{value:10338},date:{value:new Date("2024-07-27T00:45:20.724Z")},isOk:{value:function(semver){if("string"!=typeof semver)throw new Error("version.isOk semver parameter must be a string (received: ".concat(_typeof(semver),")"));var trimmed=semver.trim();if(""===trimmed)throw new Error("version.isOk semver parameter must not be empty");var match=semVerRE.exec(trimmed);if(!match)throw new Error("version.isOk semver parameter is invalid (format: [v]MAJOR[.MINOR[.PATCH[-PRERELEASE][+BUILD]]]; received: ".concat(trimmed));var major=Number(match[1]),minor=Number(match[2])||0,patch=Number(match[3])||0;return major===this.major&&(minor<this.minor||minor===this.minor&&patch<=this.patch)}},long:{value:function(){return"".concat(this.name," v").concat(this.toString()," (").concat(this.date.toUTCString(),")")}},short:{value:function(){var prerelease=this.prerelease?"-".concat(this.prerelease):"";return"".concat(this.name," (v").concat(this.major,".").concat(this.minor,".").concat(this.patch).concat(prerelease,")")}},toString:{value:function(){var prerelease=this.prerelease?"-".concat(this.prerelease):"";return"".concat(this.major,".").concat(this.minor,".").concat(this.patch).concat(prerelease,"+").concat(this.build)}},title:{value:"SugarCube"}}))),semVerRE,TempState={},session=null,settings=Setting.create(),setup={},storage=null,macros={},postdisplay={},postrender={},predisplay={},prehistory={},prerender={};Object.defineProperty(window,"SugarCube",{value:Object.seal(Object.assign(Object.create(null),{Browser:Browser,Config:Config,Dialog:Dialog,Engine:Engine,Fullscreen:Fullscreen,Has:Has,L10n:L10n,Macro:Macro,Passage:Passage,Save:Save,Scripting:Scripting,Setting:Setting,SimpleAudio:SimpleAudio,State:State,Story:Story,UI:UI,UIBar:UIBar,DebugBar:DebugBar,Util:Util,Visibility:Visibility,Wikifier:Wikifier,session:session,settings:settings,setup:setup,storage:storage,version:version}))}),jQuery((function(){var lockId=LoadScreen.lock();LoadScreen.init(),document.normalize&&document.normalize(),new Promise((function(resolve){Story.init();try{SugarCube.storage=storage=SimpleStore.create(Story.id,!0),SugarCube.session=session=SimpleStore.create(Story.id,!1)}catch(ex){throw new Error(L10n.get("warningNoStorage"))}Dialog.init(),UIBar.init(),Engine.init(),Outliner.init(),Engine.runUserScripts(),L10n.init(),session.has("rcWarn")||"cookie"!==storage.name||(session.set("rcWarn",1),window.alert(L10n.get("warningNoWebStorage"))),Save.init(),Setting.init(),Macro.init(),DebugBar.init();var $window=jQuery(window),vpReadyId=setInterval((function(){$window.width()&&LoadScreen.size<=1&&(clearInterval(vpReadyId),resolve())}),Engine.DOM_DELAY)})).then((function(){Engine.runUserInit(),UIBar.start(),Engine.start(),DebugBar.start(),triggerEvent(":storyready"),setTimeout((function(){return LoadScreen.unlock(lockId)}),2*Engine.DOM_DELAY)})).catch((function(ex){return console.error(ex),LoadScreen.clear(),Alert.fatal(null,ex.message,ex)}))}))})(window,window.document,jQuery);}
	</script>
</body>
</html>
