<!DOCTYPE html>
<html data-init="no-js">
<head>
<meta charset="UTF-8" />
<title>Liff Origins: Jaylie</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!--

SugarCube (v2.30.0): A free (gratis and libre) story format.

Copyright © 2013–2019 Thomas Michael Edwards <thomasmedwards@gmail.com>.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->
<script id="script-libraries" type="text/javascript">
if(document.head&&document.addEventListener&&document.querySelector&&Object.create&&Object.freeze&&JSON){document.documentElement.setAttribute("data-init", "loading");
/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js */
if("document" in self){if(!("classList" in document.createElement("_"))){(function(j){"use strict";if(!("Element" in j)){return}var a="classList",f="prototype",m=j.Element[f],b=Object,k=String[f].trim||function(){return this.replace(/^\s+|\s+$/g,"")},c=Array[f].indexOf||function(q){var p=0,o=this.length;for(;p<o;p++){if(p in this&&this[p]===q){return p}}return -1},n=function(o,p){this.name=o;this.code=DOMException[o];this.message=p},g=function(p,o){if(o===""){throw new n("SYNTAX_ERR","An invalid or illegal string was specified")}if(/\s/.test(o)){throw new n("INVALID_CHARACTER_ERR","String contains an invalid character")}return c.call(p,o)},d=function(s){var r=k.call(s.getAttribute("class")||""),q=r?r.split(/\s+/):[],p=0,o=q.length;for(;p<o;p++){this.push(q[p])}this._updateClassName=function(){s.setAttribute("class",this.toString())}},e=d[f]=[],i=function(){return new d(this)};n[f]=Error[f];e.item=function(o){return this[o]||null};e.contains=function(o){o+="";return g(this,o)!==-1};e.add=function(){var s=arguments,r=0,p=s.length,q,o=false;do{q=s[r]+"";if(g(this,q)===-1){this.push(q);o=true}}while(++r<p);if(o){this._updateClassName()}};e.remove=function(){var t=arguments,s=0,p=t.length,r,o=false,q;do{r=t[s]+"";q=g(this,r);while(q!==-1){this.splice(q,1);o=true;q=g(this,r)}}while(++s<p);if(o){this._updateClassName()}};e.toggle=function(p,q){p+="";var o=this.contains(p),r=o?q!==true&&"remove":q!==false&&"add";if(r){this[r](p)}if(q===true||q===false){return q}else{return !o}};e.toString=function(){return this.join(" ")};if(b.defineProperty){var l={get:i,enumerable:true,configurable:true};try{b.defineProperty(m,a,l)}catch(h){if(h.number===-2146823252){l.enumerable=false;b.defineProperty(m,a,l)}}}else{if(b[f].__defineGetter__){m.__defineGetter__(a,i)}}}(self))}else{(function(){var b=document.createElement("_");b.classList.add("c1","c2");if(!b.classList.contains("c2")){var c=function(e){var d=DOMTokenList.prototype[e];DOMTokenList.prototype[e]=function(h){var g,f=arguments.length;for(g=0;g<f;g++){h=arguments[g];d.call(this,h)}}};c("add");c("remove")}b.classList.toggle("c3",false);if(b.classList.contains("c3")){var a=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(d,e){if(1 in arguments&&!this.contains(d)===!e){return e}else{return a.call(this,d)}}}b=null}())}};
/*!
 * https://github.com/es-shims/es5-shim
 * @license es5-shim Copyright 2009-2015 by contributors, MIT License
 * see https://github.com/es-shims/es5-shim/blob/v4.5.13/LICENSE
 */
(function(t,r){"use strict";if(typeof define==="function"&&define.amd){define(r)}else if(typeof exports==="object"){module.exports=r()}else{t.returnExports=r()}})(this,function(){var t=Array;var r=t.prototype;var e=Object;var n=e.prototype;var i=Function;var a=i.prototype;var o=String;var f=o.prototype;var u=Number;var l=u.prototype;var s=r.slice;var c=r.splice;var v=r.push;var h=r.unshift;var p=r.concat;var y=r.join;var d=a.call;var g=a.apply;var w=Math.max;var b=Math.min;var T=n.toString;var m=typeof Symbol==="function"&&typeof Symbol.toStringTag==="symbol";var D;var S=Function.prototype.toString,x=/^\s*class /,O=function isES6ClassFn(t){try{var r=S.call(t);var e=r.replace(/\/\/.*\n/g,"");var n=e.replace(/\/\*[.\s\S]*\*\//g,"");var i=n.replace(/\n/gm," ").replace(/ {2}/g," ");return x.test(i)}catch(a){return false}},E=function tryFunctionObject(t){try{if(O(t)){return false}S.call(t);return true}catch(r){return false}},j="[object Function]",I="[object GeneratorFunction]",D=function isCallable(t){if(!t){return false}if(typeof t!=="function"&&typeof t!=="object"){return false}if(m){return E(t)}if(O(t)){return false}var r=T.call(t);return r===j||r===I};var M;var U=RegExp.prototype.exec,$=function tryRegexExec(t){try{U.call(t);return true}catch(r){return false}},F="[object RegExp]";M=function isRegex(t){if(typeof t!=="object"){return false}return m?$(t):T.call(t)===F};var N;var C=String.prototype.valueOf,k=function tryStringObject(t){try{C.call(t);return true}catch(r){return false}},A="[object String]";N=function isString(t){if(typeof t==="string"){return true}if(typeof t!=="object"){return false}return m?k(t):T.call(t)===A};var R=e.defineProperty&&function(){try{var t={};e.defineProperty(t,"x",{enumerable:false,value:t});for(var r in t){return false}return t.x===t}catch(n){return false}}();var P=function(t){var r;if(R){r=function(t,r,n,i){if(!i&&r in t){return}e.defineProperty(t,r,{configurable:true,enumerable:false,writable:true,value:n})}}else{r=function(t,r,e,n){if(!n&&r in t){return}t[r]=e}}return function defineProperties(e,n,i){for(var a in n){if(t.call(n,a)){r(e,a,n[a],i)}}}}(n.hasOwnProperty);var J=function isPrimitive(t){var r=typeof t;return t===null||r!=="object"&&r!=="function"};var Y=u.isNaN||function isActualNaN(t){return t!==t};var z={ToInteger:function ToInteger(t){var r=+t;if(Y(r)){r=0}else if(r!==0&&r!==1/0&&r!==-(1/0)){r=(r>0||-1)*Math.floor(Math.abs(r))}return r},ToPrimitive:function ToPrimitive(t){var r,e,n;if(J(t)){return t}e=t.valueOf;if(D(e)){r=e.call(t);if(J(r)){return r}}n=t.toString;if(D(n)){r=n.call(t);if(J(r)){return r}}throw new TypeError},ToObject:function(t){if(t==null){throw new TypeError("can't convert "+t+" to object")}return e(t)},ToUint32:function ToUint32(t){return t>>>0}};var Z=function Empty(){};P(a,{bind:function bind(t){var r=this;if(!D(r)){throw new TypeError("Function.prototype.bind called on incompatible "+r)}var n=s.call(arguments,1);var a;var o=function(){if(this instanceof a){var i=g.call(r,this,p.call(n,s.call(arguments)));if(e(i)===i){return i}return this}else{return g.call(r,t,p.call(n,s.call(arguments)))}};var f=w(0,r.length-n.length);var u=[];for(var l=0;l<f;l++){v.call(u,"$"+l)}a=i("binder","return function ("+y.call(u,",")+"){ return binder.apply(this, arguments); }")(o);if(r.prototype){Z.prototype=r.prototype;a.prototype=new Z;Z.prototype=null}return a}});var G=d.bind(n.hasOwnProperty);var H=d.bind(n.toString);var W=d.bind(s);var B=g.bind(s);if(typeof document==="object"&&document&&document.documentElement){try{W(document.documentElement.childNodes)}catch(X){var L=W;var q=B;W=function arraySliceIE(t){var r=[];var e=t.length;while(e-- >0){r[e]=t[e]}return q(r,L(arguments,1))};B=function arraySliceApplyIE(t,r){return q(W(t),r)}}}var K=d.bind(f.slice);var Q=d.bind(f.split);var V=d.bind(f.indexOf);var _=d.bind(v);var tt=d.bind(n.propertyIsEnumerable);var rt=d.bind(r.sort);var et=t.isArray||function isArray(t){return H(t)==="[object Array]"};var nt=[].unshift(0)!==1;P(r,{unshift:function(){h.apply(this,arguments);return this.length}},nt);P(t,{isArray:et});var it=e("a");var at=it[0]!=="a"||!(0 in it);var ot=function properlyBoxed(t){var r=true;var e=true;var n=false;if(t){try{t.call("foo",function(t,e,n){if(typeof n!=="object"){r=false}});t.call([1],function(){"use strict";e=typeof this==="string"},"x")}catch(i){n=true}}return!!t&&!n&&r&&e};P(r,{forEach:function forEach(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=-1;var i=z.ToUint32(e.length);var a;if(arguments.length>1){a=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.forEach callback must be a function")}while(++n<i){if(n in e){if(typeof a==="undefined"){t(e[n],n,r)}else{t.call(a,e[n],n,r)}}}}},!ot(r.forEach));P(r,{map:function map(r){var e=z.ToObject(this);var n=at&&N(this)?Q(this,""):e;var i=z.ToUint32(n.length);var a=t(i);var o;if(arguments.length>1){o=arguments[1]}if(!D(r)){throw new TypeError("Array.prototype.map callback must be a function")}for(var f=0;f<i;f++){if(f in n){if(typeof o==="undefined"){a[f]=r(n[f],f,e)}else{a[f]=r.call(o,n[f],f,e)}}}return a}},!ot(r.map));P(r,{filter:function filter(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i=[];var a;var o;if(arguments.length>1){o=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.filter callback must be a function")}for(var f=0;f<n;f++){if(f in e){a=e[f];if(typeof o==="undefined"?t(a,f,r):t.call(o,a,f,r)){_(i,a)}}}return i}},!ot(r.filter));P(r,{every:function every(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.every callback must be a function")}for(var a=0;a<n;a++){if(a in e&&!(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return false}}return true}},!ot(r.every));P(r,{some:function some(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.some callback must be a function")}for(var a=0;a<n;a++){if(a in e&&(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return true}}return false}},!ot(r.some));var ft=false;if(r.reduce){ft=typeof r.reduce.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduce:function reduce(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduce callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduce of empty array with no initial value")}var i=0;var a;if(arguments.length>=2){a=arguments[1]}else{do{if(i in e){a=e[i++];break}if(++i>=n){throw new TypeError("reduce of empty array with no initial value")}}while(true)}for(;i<n;i++){if(i in e){a=t(a,e[i],i,r)}}return a}},!ft);var ut=false;if(r.reduceRight){ut=typeof r.reduceRight.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduceRight:function reduceRight(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduceRight callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduceRight of empty array with no initial value")}var i;var a=n-1;if(arguments.length>=2){i=arguments[1]}else{do{if(a in e){i=e[a--];break}if(--a<0){throw new TypeError("reduceRight of empty array with no initial value")}}while(true)}if(a<0){return i}do{if(a in e){i=t(i,e[a],a,r)}}while(a--);return i}},!ut);var lt=r.indexOf&&[0,1].indexOf(1,2)!==-1;P(r,{indexOf:function indexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=0;if(arguments.length>1){n=z.ToInteger(arguments[1])}n=n>=0?n:w(0,e+n);for(;n<e;n++){if(n in r&&r[n]===t){return n}}return-1}},lt);var st=r.lastIndexOf&&[0,1].lastIndexOf(0,-3)!==-1;P(r,{lastIndexOf:function lastIndexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=e-1;if(arguments.length>1){n=b(n,z.ToInteger(arguments[1]))}n=n>=0?n:e-Math.abs(n);for(;n>=0;n--){if(n in r&&t===r[n]){return n}}return-1}},st);var ct=function(){var t=[1,2];var r=t.splice();return t.length===2&&et(r)&&r.length===0}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}else{return c.apply(this,arguments)}}},!ct);var vt=function(){var t={};r.splice.call(t,0,0,1);return t.length===1}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}var e=arguments;this.length=w(z.ToInteger(this.length),0);if(arguments.length>0&&typeof r!=="number"){e=W(arguments);if(e.length<2){_(e,this.length-t)}else{e[1]=z.ToInteger(r)}}return c.apply(this,e)}},!vt);var ht=function(){var r=new t(1e5);r[8]="x";r.splice(1,1);return r.indexOf("x")===7}();var pt=function(){var t=256;var r=[];r[t]="a";r.splice(t+1,0,"b");return r[t]==="a"}();P(r,{splice:function splice(t,r){var e=z.ToObject(this);var n=[];var i=z.ToUint32(e.length);var a=z.ToInteger(t);var f=a<0?w(i+a,0):b(a,i);var u=b(w(z.ToInteger(r),0),i-f);var l=0;var s;while(l<u){s=o(f+l);if(G(e,s)){n[l]=e[s]}l+=1}var c=W(arguments,2);var v=c.length;var h;if(v<u){l=f;var p=i-u;while(l<p){s=o(l+u);h=o(l+v);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l+=1}l=i;var y=i-u+v;while(l>y){delete e[l-1];l-=1}}else if(v>u){l=i-u;while(l>f){s=o(l+u-1);h=o(l+v-1);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l-=1}}l=f;for(var d=0;d<c.length;++d){e[l]=c[d];l+=1}e.length=i-u+v;return n}},!ht||!pt);var yt=r.join;var dt;try{dt=Array.prototype.join.call("123",",")!=="1,2,3"}catch(X){dt=true}if(dt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(N(this)?Q(this,""):this,r)}},dt)}var gt=[1,2].join(undefined)!=="1,2";if(gt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(this,r)}},gt)}var wt=function push(t){var r=z.ToObject(this);var e=z.ToUint32(r.length);var n=0;while(n<arguments.length){r[e+n]=arguments[n];n+=1}r.length=e+n;return e+n};var bt=function(){var t={};var r=Array.prototype.push.call(t,undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:function push(t){if(et(this)){return v.apply(this,arguments)}return wt.apply(this,arguments)}},bt);var Tt=function(){var t=[];var r=t.push(undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:wt},Tt);P(r,{slice:function(t,r){var e=N(this)?Q(this,""):this;return B(e,arguments)}},at);var mt=function(){try{[1,2].sort(null)}catch(t){try{[1,2].sort({})}catch(r){return false}}return true}();var Dt=function(){try{[1,2].sort(/a/);return false}catch(t){}return true}();var St=function(){try{[1,2].sort(undefined);return true}catch(t){}return false}();P(r,{sort:function sort(t){if(typeof t==="undefined"){return rt(this)}if(!D(t)){throw new TypeError("Array.prototype.sort callback must be a function")}return rt(this,t)}},mt||!St||!Dt);var xt=!tt({toString:null},"toString");var Ot=tt(function(){},"prototype");var Et=!G("x","0");var jt=function(t){var r=t.constructor;return r&&r.prototype===t};var It={$applicationCache:true,$console:true,$external:true,$frame:true,$frameElement:true,$frames:true,$innerHeight:true,$innerWidth:true,$onmozfullscreenchange:true,$onmozfullscreenerror:true,$outerHeight:true,$outerWidth:true,$pageXOffset:true,$pageYOffset:true,$parent:true,$scrollLeft:true,$scrollTop:true,$scrollX:true,$scrollY:true,$self:true,$webkitIndexedDB:true,$webkitStorageInfo:true,$window:true,$width:true,$height:true,$top:true,$localStorage:true};var Mt=function(){if(typeof window==="undefined"){return false}for(var t in window){try{if(!It["$"+t]&&G(window,t)&&window[t]!==null&&typeof window[t]==="object"){jt(window[t])}}catch(r){return true}}return false}();var Ut=function(t){if(typeof window==="undefined"||!Mt){return jt(t)}try{return jt(t)}catch(r){return false}};var $t=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var Ft=$t.length;var Nt=function isArguments(t){return H(t)==="[object Arguments]"};var Ct=function isArguments(t){return t!==null&&typeof t==="object"&&typeof t.length==="number"&&t.length>=0&&!et(t)&&D(t.callee)};var kt=Nt(arguments)?Nt:Ct;P(e,{keys:function keys(t){var r=D(t);var e=kt(t);var n=t!==null&&typeof t==="object";var i=n&&N(t);if(!n&&!r&&!e){throw new TypeError("Object.keys called on a non-object")}var a=[];var f=Ot&&r;if(i&&Et||e){for(var u=0;u<t.length;++u){_(a,o(u))}}if(!e){for(var l in t){if(!(f&&l==="prototype")&&G(t,l)){_(a,o(l))}}}if(xt){var s=Ut(t);for(var c=0;c<Ft;c++){var v=$t[c];if(!(s&&v==="constructor")&&G(t,v)){_(a,v)}}}return a}});var At=e.keys&&function(){return e.keys(arguments).length===2}(1,2);var Rt=e.keys&&function(){var t=e.keys(arguments);return arguments.length!==1||t.length!==1||t[0]!==1}(1);var Pt=e.keys;P(e,{keys:function keys(t){if(kt(t)){return Pt(W(t))}else{return Pt(t)}}},!At||Rt);var Jt=new Date(-0xc782b5b342b24).getUTCMonth()!==0;var Yt=new Date(-0x55d318d56a724);var zt=new Date(14496624e5);var Zt=Yt.toUTCString()!=="Mon, 01 Jan -45875 11:59:59 GMT";var Gt;var Ht;var Wt=Yt.getTimezoneOffset();if(Wt<-720){Gt=Yt.toDateString()!=="Tue Jan 02 -45875";Ht=!/^Thu Dec 10 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}else{Gt=Yt.toDateString()!=="Mon Jan 01 -45875";Ht=!/^Wed Dec 09 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}var Bt=d.bind(Date.prototype.getFullYear);var Xt=d.bind(Date.prototype.getMonth);var Lt=d.bind(Date.prototype.getDate);var qt=d.bind(Date.prototype.getUTCFullYear);var Kt=d.bind(Date.prototype.getUTCMonth);var Qt=d.bind(Date.prototype.getUTCDate);var Vt=d.bind(Date.prototype.getUTCDay);var _t=d.bind(Date.prototype.getUTCHours);var tr=d.bind(Date.prototype.getUTCMinutes);var rr=d.bind(Date.prototype.getUTCSeconds);var er=d.bind(Date.prototype.getUTCMilliseconds);var nr=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var ir=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var ar=function daysInMonth(t,r){return Lt(new Date(r,t,0))};P(Date.prototype,{getFullYear:function getFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);if(t<0&&Xt(this)>11){return t+1}return t},getMonth:function getMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);if(t<0&&r>11){return 0}return r},getDate:function getDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);var e=Lt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e},getUTCFullYear:function getUTCFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);if(t<0&&Kt(this)>11){return t+1}return t},getUTCMonth:function getUTCMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);if(t<0&&r>11){return 0}return r},getUTCDate:function getUTCDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);var e=Qt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e}},Jt);P(Date.prototype,{toUTCString:function toUTCString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Vt(this);var r=Qt(this);var e=Kt(this);var n=qt(this);var i=_t(this);var a=tr(this);var o=rr(this);return nr[t]+", "+(r<10?"0"+r:r)+" "+ir[e]+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"}},Jt||Zt);P(Date.prototype,{toDateString:function toDateString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n}},Jt||Gt);if(Jt||Ht){Date.prototype.toString=function toString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();var i=this.getHours();var a=this.getMinutes();var o=this.getSeconds();var f=this.getTimezoneOffset();var u=Math.floor(Math.abs(f)/60);var l=Math.floor(Math.abs(f)%60);return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"+(f>0?"-":"+")+(u<10?"0"+u:u)+(l<10?"0"+l:l)};if(R){e.defineProperty(Date.prototype,"toString",{configurable:true,enumerable:false,writable:true})}}var or=-621987552e5;var fr="-000001";var ur=Date.prototype.toISOString&&new Date(or).toISOString().indexOf(fr)===-1;var lr=Date.prototype.toISOString&&new Date(-1).toISOString()!=="1969-12-31T23:59:59.999Z";var sr=d.bind(Date.prototype.getTime);P(Date.prototype,{toISOString:function toISOString(){if(!isFinite(this)||!isFinite(sr(this))){throw new RangeError("Date.prototype.toISOString called on non-finite value.")}var t=qt(this);var r=Kt(this);t+=Math.floor(r/12);r=(r%12+12)%12;var e=[r+1,Qt(this),_t(this),tr(this),rr(this)];t=(t<0?"-":t>9999?"+":"")+K("00000"+Math.abs(t),0<=t&&t<=9999?-4:-6);for(var n=0;n<e.length;++n){e[n]=K("00"+e[n],-2)}return t+"-"+W(e,0,2).join("-")+"T"+W(e,2).join(":")+"."+K("000"+er(this),-3)+"Z"}},ur||lr);var cr=function(){try{return Date.prototype.toJSON&&new Date(NaN).toJSON()===null&&new Date(or).toJSON().indexOf(fr)!==-1&&Date.prototype.toJSON.call({toISOString:function(){return true}})}catch(t){return false}}();if(!cr){Date.prototype.toJSON=function toJSON(t){var r=e(this);var n=z.ToPrimitive(r);if(typeof n==="number"&&!isFinite(n)){return null}var i=r.toISOString;if(!D(i)){throw new TypeError("toISOString property is not callable")}return i.call(r)}}var vr=Date.parse("+033658-09-27T01:46:40.000Z")===1e15;var hr=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z"))||!isNaN(Date.parse("2012-12-31T23:59:60.000Z"));var pr=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));if(pr||hr||!vr){var yr=Math.pow(2,31)-1;var dr=Y(new Date(1970,0,1,0,0,0,yr+1).getTime());Date=function(t){var r=function Date(e,n,i,a,f,u,l){var s=arguments.length;var c;if(this instanceof t){var v=u;var h=l;if(dr&&s>=7&&l>yr){var p=Math.floor(l/yr)*yr;var y=Math.floor(p/1e3);v+=y;h-=y*1e3}c=s===1&&o(e)===e?new t(r.parse(e)):s>=7?new t(e,n,i,a,f,v,h):s>=6?new t(e,n,i,a,f,v):s>=5?new t(e,n,i,a,f):s>=4?new t(e,n,i,a):s>=3?new t(e,n,i):s>=2?new t(e,n):s>=1?new t(e instanceof t?+e:e):new t}else{c=t.apply(this,arguments)}if(!J(c)){P(c,{constructor:r},true)}return c};var e=new RegExp("^"+"(\\d{4}|[+-]\\d{6})"+"(?:-(\\d{2})"+"(?:-(\\d{2})"+"(?:"+"T(\\d{2})"+":(\\d{2})"+"(?:"+":(\\d{2})"+"(?:(\\.\\d{1,}))?"+")?"+"("+"Z|"+"(?:"+"([-+])"+"(\\d{2})"+":(\\d{2})"+")"+")?)?)?)?"+"$");var n=[0,31,59,90,120,151,181,212,243,273,304,334,365];var i=function dayFromMonth(t,r){var e=r>1?1:0;return n[r]+Math.floor((t-1969+e)/4)-Math.floor((t-1901+e)/100)+Math.floor((t-1601+e)/400)+365*(t-1970)};var a=function toUTC(r){var e=0;var n=r;if(dr&&n>yr){var i=Math.floor(n/yr)*yr;var a=Math.floor(i/1e3);e+=a;n-=a*1e3}return u(new t(1970,0,1,0,0,e,n))};for(var f in t){if(G(t,f)){r[f]=t[f]}}P(r,{now:t.now,UTC:t.UTC},true);r.prototype=t.prototype;P(r.prototype,{constructor:r},true);var l=function parse(r){var n=e.exec(r);if(n){var o=u(n[1]),f=u(n[2]||1)-1,l=u(n[3]||1)-1,s=u(n[4]||0),c=u(n[5]||0),v=u(n[6]||0),h=Math.floor(u(n[7]||0)*1e3),p=Boolean(n[4]&&!n[8]),y=n[9]==="-"?1:-1,d=u(n[10]||0),g=u(n[11]||0),w;var b=c>0||v>0||h>0;if(s<(b?24:25)&&c<60&&v<60&&h<1e3&&f>-1&&f<12&&d<24&&g<60&&l>-1&&l<i(o,f+1)-i(o,f)){w=((i(o,f)+l)*24+s+d*y)*60;w=((w+c+g*y)*60+v)*1e3+h;if(p){w=a(w)}if(-864e13<=w&&w<=864e13){return w}}return NaN}return t.parse.apply(this,arguments)};P(r,{parse:l});return r}(Date)}if(!Date.now){Date.now=function now(){return(new Date).getTime()}}var gr=l.toFixed&&(8e-5.toFixed(3)!=="0.000"||.9.toFixed(0)!=="1"||1.255.toFixed(2)!=="1.25"||(1000000000000000128).toFixed(0)!=="1000000000000000128");var wr={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function multiply(t,r){var e=-1;var n=r;while(++e<wr.size){n+=t*wr.data[e];wr.data[e]=n%wr.base;n=Math.floor(n/wr.base)}},divide:function divide(t){var r=wr.size;var e=0;while(--r>=0){e+=wr.data[r];wr.data[r]=Math.floor(e/t);e=e%t*wr.base}},numToString:function numToString(){var t=wr.size;var r="";while(--t>=0){if(r!==""||t===0||wr.data[t]!==0){var e=o(wr.data[t]);if(r===""){r=e}else{r+=K("0000000",0,7-e.length)+e}}}return r},pow:function pow(t,r,e){return r===0?e:r%2===1?pow(t,r-1,e*t):pow(t*t,r/2,e)},log:function log(t){var r=0;var e=t;while(e>=4096){r+=12;e/=4096}while(e>=2){r+=1;e/=2}return r}};var br=function toFixed(t){var r,e,n,i,a,f,l,s;r=u(t);r=Y(r)?0:Math.floor(r);if(r<0||r>20){throw new RangeError("Number.toFixed called with invalid number of decimals")}e=u(this);if(Y(e)){return"NaN"}if(e<=-1e21||e>=1e21){return o(e)}n="";if(e<0){n="-";e=-e}i="0";if(e>1e-21){a=wr.log(e*wr.pow(2,69,1))-69;f=a<0?e*wr.pow(2,-a,1):e/wr.pow(2,a,1);f*=4503599627370496;a=52-a;if(a>0){wr.multiply(0,f);l=r;while(l>=7){wr.multiply(1e7,0);l-=7}wr.multiply(wr.pow(10,l,1),0);l=a-1;while(l>=23){wr.divide(1<<23);l-=23}wr.divide(1<<l);wr.multiply(1,1);wr.divide(2);i=wr.numToString()}else{wr.multiply(0,f);wr.multiply(1<<-a,0);i=wr.numToString()+K("0.00000000000000000000",2,2+r)}}if(r>0){s=i.length;if(s<=r){i=n+K("0.0000000000000000000",0,r-s+2)+i}else{i=n+K(i,0,s-r)+"."+K(i,s-r)}}else{i=n+i}return i};P(l,{toFixed:br},gr);var Tr=function(){try{return 1..toPrecision(undefined)==="1"}catch(t){return true}}();var mr=l.toPrecision;P(l,{toPrecision:function toPrecision(t){return typeof t==="undefined"?mr.call(this):mr.call(this,t)}},Tr);if("ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1){(function(){var t=typeof/()??/.exec("")[1]==="undefined";var r=Math.pow(2,32)-1;f.split=function(e,n){var i=String(this);if(typeof e==="undefined"&&n===0){return[]}if(!M(e)){return Q(this,e,n)}var a=[];var o=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),f=0,u,l,s,c;var h=new RegExp(e.source,o+"g");if(!t){u=new RegExp("^"+h.source+"$(?!\\s)",o)}var p=typeof n==="undefined"?r:z.ToUint32(n);l=h.exec(i);while(l){s=l.index+l[0].length;if(s>f){_(a,K(i,f,l.index));if(!t&&l.length>1){l[0].replace(u,function(){for(var t=1;t<arguments.length-2;t++){if(typeof arguments[t]==="undefined"){l[t]=void 0}}})}if(l.length>1&&l.index<i.length){v.apply(a,W(l,1))}c=l[0].length;f=s;if(a.length>=p){break}}if(h.lastIndex===l.index){h.lastIndex++}l=h.exec(i)}if(f===i.length){if(c||!h.test("")){_(a,"")}}else{_(a,K(i,f))}return a.length>p?W(a,0,p):a}})()}else if("0".split(void 0,0).length){f.split=function split(t,r){if(typeof t==="undefined"&&r===0){return[]}return Q(this,t,r)}}var Dr=f.replace;var Sr=function(){var t=[];"x".replace(/x(.)?/g,function(r,e){_(t,e)});return t.length===1&&typeof t[0]==="undefined"}();if(!Sr){f.replace=function replace(t,r){var e=D(r);var n=M(t)&&/\)[*?]/.test(t.source);if(!e||!n){return Dr.call(this,t,r)}else{var i=function(e){var n=arguments.length;var i=t.lastIndex;t.lastIndex=0;var a=t.exec(e)||[];t.lastIndex=i;_(a,arguments[n-2],arguments[n-1]);return r.apply(this,a)};return Dr.call(this,t,i)}}}var xr=f.substr;var Or="".substr&&"0b".substr(-1)!=="b";P(f,{substr:function substr(t,r){var e=t;if(t<0){e=w(this.length+t,0)}return xr.call(this,e,r)}},Or);var Er="\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003"+"\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028"+"\u2029\ufeff";var jr="\u200b";var Ir="["+Er+"]";var Mr=new RegExp("^"+Ir+Ir+"*");var Ur=new RegExp(Ir+Ir+"*$");var $r=f.trim&&(Er.trim()||!jr.trim());P(f,{trim:function trim(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}return o(this).replace(Mr,"").replace(Ur,"")}},$r);var Fr=d.bind(String.prototype.trim);var Nr=f.lastIndexOf&&"abc\u3042\u3044".lastIndexOf("\u3042\u3044",2)!==-1;P(f,{lastIndexOf:function lastIndexOf(t){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var r=o(this);var e=o(t);var n=arguments.length>1?u(arguments[1]):NaN;var i=Y(n)?Infinity:z.ToInteger(n);var a=b(w(i,0),r.length);var f=e.length;var l=a+f;while(l>0){l=w(0,l-f);var s=V(K(r,l,a+f),e);if(s!==-1){return l+s}}return-1}},Nr);var Cr=f.lastIndexOf;P(f,{lastIndexOf:function lastIndexOf(t){return Cr.apply(this,arguments)}},f.lastIndexOf.length!==1);if(parseInt(Er+"08")!==8||parseInt(Er+"0x16")!==22){parseInt=function(t){var r=/^[-+]?0[xX]/;return function parseInt(e,n){if(typeof e==="symbol"){""+e}var i=Fr(String(e));var a=u(n)||(r.test(i)?16:10);return t(i,a)}}(parseInt)}if(1/parseFloat("-0")!==-Infinity){parseFloat=function(t){return function parseFloat(r){var e=Fr(String(r));var n=t(e);return n===0&&K(e,0,1)==="-"?-0:n}}(parseFloat)}if(String(new RangeError("test"))!=="RangeError: test"){var kr=function toString(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var t=this.name;if(typeof t==="undefined"){t="Error"}else if(typeof t!=="string"){t=o(t)}var r=this.message;if(typeof r==="undefined"){r=""}else if(typeof r!=="string"){r=o(r)}if(!t){return r}if(!r){return t}return t+": "+r};Error.prototype.toString=kr}if(R){var Ar=function(t,r){if(tt(t,r)){var e=Object.getOwnPropertyDescriptor(t,r);if(e.configurable){e.enumerable=false;Object.defineProperty(t,r,e)}}};Ar(Error.prototype,"message");if(Error.prototype.message!==""){Error.prototype.message=""}Ar(Error.prototype,"name")}if(String(/a/gim)!=="/a/gim"){var Rr=function toString(){var t="/"+this.source+"/";if(this.global){t+="g"}if(this.ignoreCase){t+="i"}if(this.multiline){t+="m"}return t};RegExp.prototype.toString=Rr}});
//# sourceMappingURL=es5-shim.map
/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.4/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(t)}else if(typeof exports==="object"){module.exports=t()}else{e.returnExports=t()}})(this,function(){"use strict";var e=Function.call.bind(Function.apply);var t=Function.call.bind(Function.call);var r=Array.isArray;var n=Object.keys;var o=function notThunker(t){return function notThunk(){return!e(t,this,arguments)}};var i=function(e){try{e();return false}catch(t){return true}};var a=function valueOrFalseIfThrows(e){try{return e()}catch(t){return false}};var u=o(i);var f=function(){return!i(function(){return Object.defineProperty({},"x",{get:function(){}})})};var s=!!Object.defineProperty&&f();var c=function foo(){}.name==="foo";var l=Function.call.bind(Array.prototype.forEach);var p=Function.call.bind(Array.prototype.reduce);var v=Function.call.bind(Array.prototype.filter);var y=Function.call.bind(Array.prototype.some);var h=function(e,t,r,n){if(!n&&t in e){return}if(s){Object.defineProperty(e,t,{configurable:true,enumerable:false,writable:true,value:r})}else{e[t]=r}};var b=function(e,t,r){l(n(t),function(n){var o=t[n];h(e,n,o,!!r)})};var g=Function.call.bind(Object.prototype.toString);var d=typeof/abc/==="function"?function IsCallableSlow(e){return typeof e==="function"&&g(e)==="[object Function]"}:function IsCallableFast(e){return typeof e==="function"};var m={getter:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}Object.defineProperty(e,t,{configurable:true,enumerable:false,get:r})},proxy:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,{configurable:n.configurable,enumerable:n.enumerable,get:function getKey(){return e[t]},set:function setKey(r){e[t]=r}})},redefine:function(e,t,r){if(s){var n=Object.getOwnPropertyDescriptor(e,t);n.value=r;Object.defineProperty(e,t,n)}else{e[t]=r}},defineByDescriptor:function(e,t,r){if(s){Object.defineProperty(e,t,r)}else if("value"in r){e[t]=r.value}},preserveToString:function(e,t){if(t&&d(t.toString)){h(e,"toString",t.toString.bind(t),true)}}};var O=Object.create||function(e,t){var r=function Prototype(){};r.prototype=e;var o=new r;if(typeof t!=="undefined"){n(t).forEach(function(e){m.defineByDescriptor(o,e,t[e])})}return o};var w=function(e,t){if(!Object.setPrototypeOf){return false}return a(function(){var r=function Subclass(t){var r=new e(t);Object.setPrototypeOf(r,Subclass.prototype);return r};Object.setPrototypeOf(r,e);r.prototype=O(e.prototype,{constructor:{value:r}});return t(r)})};var j=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")};var S=j();var T=S.isFinite;var I=Function.call.bind(String.prototype.indexOf);var E=Function.apply.bind(Array.prototype.indexOf);var P=Function.call.bind(Array.prototype.concat);var C=Function.call.bind(String.prototype.slice);var M=Function.call.bind(Array.prototype.push);var x=Function.apply.bind(Array.prototype.push);var N=Function.call.bind(Array.prototype.shift);var A=Math.max;var R=Math.min;var _=Math.floor;var k=Math.abs;var L=Math.exp;var F=Math.log;var D=Math.sqrt;var z=Function.call.bind(Object.prototype.hasOwnProperty);var q;var W=function(){};var G=S.Map;var H=G&&G.prototype["delete"];var V=G&&G.prototype.get;var B=G&&G.prototype.has;var U=G&&G.prototype.set;var $=S.Symbol||{};var J=$.species||"@@species";var X=Number.isNaN||function isNaN(e){return e!==e};var K=Number.isFinite||function isFinite(e){return typeof e==="number"&&T(e)};var Z=d(Math.sign)?Math.sign:function sign(e){var t=Number(e);if(t===0){return t}if(X(t)){return t}return t<0?-1:1};var Y=function log1p(e){var t=Number(e);if(t<-1||X(t)){return NaN}if(t===0||t===Infinity){return t}if(t===-1){return-Infinity}return 1+t-1===0?t:t*(F(1+t)/(1+t-1))};var Q=function isArguments(e){return g(e)==="[object Arguments]"};var ee=function isArguments(e){return e!==null&&typeof e==="object"&&typeof e.length==="number"&&e.length>=0&&g(e)!=="[object Array]"&&g(e.callee)==="[object Function]"};var te=Q(arguments)?Q:ee;var re={primitive:function(e){return e===null||typeof e!=="function"&&typeof e!=="object"},string:function(e){return g(e)==="[object String]"},regex:function(e){return g(e)==="[object RegExp]"},symbol:function(e){return typeof S.Symbol==="function"&&typeof e==="symbol"}};var ne=function overrideNative(e,t,r){var n=e[t];h(e,t,r,true);m.preserveToString(e[t],n)};var oe=typeof $==="function"&&typeof $["for"]==="function"&&re.symbol($());var ie=re.symbol($.iterator)?$.iterator:"_es6-shim iterator_";if(S.Set&&typeof(new S.Set)["@@iterator"]==="function"){ie="@@iterator"}if(!S.Reflect){h(S,"Reflect",{},true)}var ae=S.Reflect;var ue=String;var fe=typeof document==="undefined"||!document?null:document.all;var se=fe==null?function isNullOrUndefined(e){return e==null}:function isNullOrUndefinedAndNotDocumentAll(e){return e==null&&e!==fe};var ce={Call:function Call(t,r){var n=arguments.length>2?arguments[2]:[];if(!ce.IsCallable(t)){throw new TypeError(t+" is not a function")}return e(t,r,n)},RequireObjectCoercible:function(e,t){if(se(e)){throw new TypeError(t||"Cannot call method on "+e)}return e},TypeIsObject:function(e){if(e===void 0||e===null||e===true||e===false){return false}return typeof e==="function"||typeof e==="object"||e===fe},ToObject:function(e,t){return Object(ce.RequireObjectCoercible(e,t))},IsCallable:d,IsConstructor:function(e){return ce.IsCallable(e)},ToInt32:function(e){return ce.ToNumber(e)>>0},ToUint32:function(e){return ce.ToNumber(e)>>>0},ToNumber:function(e){if(g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return+e},ToInteger:function(e){var t=ce.ToNumber(e);if(X(t)){return 0}if(t===0||!K(t)){return t}return(t>0?1:-1)*_(k(t))},ToLength:function(e){var t=ce.ToInteger(e);if(t<=0){return 0}if(t>Number.MAX_SAFE_INTEGER){return Number.MAX_SAFE_INTEGER}return t},SameValue:function(e,t){if(e===t){if(e===0){return 1/e===1/t}return true}return X(e)&&X(t)},SameValueZero:function(e,t){return e===t||X(e)&&X(t)},IsIterable:function(e){return ce.TypeIsObject(e)&&(typeof e[ie]!=="undefined"||te(e))},GetIterator:function(e){if(te(e)){return new q(e,"value")}var t=ce.GetMethod(e,ie);if(!ce.IsCallable(t)){throw new TypeError("value is not an iterable")}var r=ce.Call(t,e);if(!ce.TypeIsObject(r)){throw new TypeError("bad iterator")}return r},GetMethod:function(e,t){var r=ce.ToObject(e)[t];if(se(r)){return void 0}if(!ce.IsCallable(r)){throw new TypeError("Method not callable: "+t)}return r},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var r=ce.GetMethod(e,"return");if(r===void 0){return}var n,o;try{n=ce.Call(r,e)}catch(i){o=i}if(t){return}if(o){throw o}if(!ce.TypeIsObject(n)){throw new TypeError("Iterator's return method returned a non-object.")}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!ce.TypeIsObject(t)){throw new TypeError("bad iterator")}return t},IteratorStep:function(e){var t=ce.IteratorNext(e);var r=ce.IteratorComplete(t);return r?false:t},Construct:function(e,t,r,n){var o=typeof r==="undefined"?e:r;if(!n&&ae.construct){return ae.construct(e,t,o)}var i=o.prototype;if(!ce.TypeIsObject(i)){i=Object.prototype}var a=O(i);var u=ce.Call(e,a,t);return ce.TypeIsObject(u)?u:a},SpeciesConstructor:function(e,t){var r=e.constructor;if(r===void 0){return t}if(!ce.TypeIsObject(r)){throw new TypeError("Bad constructor")}var n=r[J];if(se(n)){return t}if(!ce.IsConstructor(n)){throw new TypeError("Bad @@species")}return n},CreateHTML:function(e,t,r,n){var o=ce.ToString(e);var i="<"+t;if(r!==""){var a=ce.ToString(n);var u=a.replace(/"/g,"&quot;");i+=" "+r+'="'+u+'"'}var f=i+">";var s=f+o;return s+"</"+t+">"},IsRegExp:function IsRegExp(e){if(!ce.TypeIsObject(e)){return false}var t=e[$.match];if(typeof t!=="undefined"){return!!t}return re.regex(e)},ToString:function ToString(e){return ue(e)}};if(s&&oe){var le=function defineWellKnownSymbol(e){if(re.symbol($[e])){return $[e]}var t=$["for"]("Symbol."+e);Object.defineProperty($,e,{configurable:false,enumerable:false,writable:false,value:t});return t};if(!re.symbol($.search)){var pe=le("search");var ve=String.prototype.search;h(RegExp.prototype,pe,function search(e){return ce.Call(ve,e,[this])});var ye=function search(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,pe);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(ve,t,[ce.ToString(e)])};ne(String.prototype,"search",ye)}if(!re.symbol($.replace)){var he=le("replace");var be=String.prototype.replace;h(RegExp.prototype,he,function replace(e,t){return ce.Call(be,e,[this,t])});var ge=function replace(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,he);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(be,r,[ce.ToString(e),t])};ne(String.prototype,"replace",ge)}if(!re.symbol($.split)){var de=le("split");var me=String.prototype.split;h(RegExp.prototype,de,function split(e,t){return ce.Call(me,e,[this,t])});var Oe=function split(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,de);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(me,r,[ce.ToString(e),t])};ne(String.prototype,"split",Oe)}var we=re.symbol($.match);var je=we&&function(){var e={};e[$.match]=function(){return 42};return"a".match(e)!==42}();if(!we||je){var Se=le("match");var Te=String.prototype.match;h(RegExp.prototype,Se,function match(e){return ce.Call(Te,e,[this])});var Ie=function match(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,Se);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(Te,t,[ce.ToString(e)])};ne(String.prototype,"match",Ie)}}var Ee=function wrapConstructor(e,t,r){m.preserveToString(t,e);if(Object.setPrototypeOf){Object.setPrototypeOf(e,t)}if(s){l(Object.getOwnPropertyNames(e),function(n){if(n in W||r[n]){return}m.proxy(e,n,t)})}else{l(Object.keys(e),function(n){if(n in W||r[n]){return}t[n]=e[n]})}t.prototype=e.prototype;m.redefine(e.prototype,"constructor",t)};var Pe=function(){return this};var Ce=function(e){if(s&&!z(e,J)){m.getter(e,J,Pe)}};var Me=function(e,t){var r=t||function iterator(){return this};h(e,ie,r);if(!e[ie]&&re.symbol(ie)){e[ie]=r}};var xe=function createDataProperty(e,t,r){if(s){Object.defineProperty(e,t,{configurable:true,enumerable:true,writable:true,value:r})}else{e[t]=r}};var Ne=function createDataPropertyOrThrow(e,t,r){xe(e,t,r);if(!ce.SameValue(e[t],r)){throw new TypeError("property is nonconfigurable")}};var Ae=function(e,t,r,n){if(!ce.TypeIsObject(e)){throw new TypeError("Constructor requires `new`: "+t.name)}var o=t.prototype;if(!ce.TypeIsObject(o)){o=r}var i=O(o);for(var a in n){if(z(n,a)){var u=n[a];h(i,a,u,true)}}return i};if(String.fromCodePoint&&String.fromCodePoint.length!==1){var Re=String.fromCodePoint;ne(String,"fromCodePoint",function fromCodePoint(e){return ce.Call(Re,this,arguments)})}var _e={fromCodePoint:function fromCodePoint(e){var t=[];var r;for(var n=0,o=arguments.length;n<o;n++){r=Number(arguments[n]);if(!ce.SameValue(r,ce.ToInteger(r))||r<0||r>1114111){throw new RangeError("Invalid code point "+r)}if(r<65536){M(t,String.fromCharCode(r))}else{r-=65536;M(t,String.fromCharCode((r>>10)+55296));M(t,String.fromCharCode(r%1024+56320))}}return t.join("")},raw:function raw(e){var t=ce.ToObject(e,"bad callSite");var r=ce.ToObject(t.raw,"bad raw value");var n=r.length;var o=ce.ToLength(n);if(o<=0){return""}var i=[];var a=0;var u,f,s,c;while(a<o){u=ce.ToString(a);s=ce.ToString(r[u]);M(i,s);if(a+1>=o){break}f=a+1<arguments.length?arguments[a+1]:"";c=ce.ToString(f);M(i,c);a+=1}return i.join("")}};if(String.raw&&String.raw({raw:{0:"x",1:"y",length:2}})!=="xy"){ne(String,"raw",_e.raw)}b(String,_e);var ke=function repeat(e,t){if(t<1){return""}if(t%2){return repeat(e,t-1)+e}var r=repeat(e,t/2);return r+r};var Le=Infinity;var Fe={repeat:function repeat(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);if(r<0||r>=Le){throw new RangeError("repeat count must be less than infinity and not overflow maximum string size")}return ke(t,r)},startsWith:function startsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "startsWith" with a regex')}var r=ce.ToString(e);var n;if(arguments.length>1){n=arguments[1]}var o=A(ce.ToInteger(n),0);return C(t,o,o+r.length)===r},endsWith:function endsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "endsWith" with a regex')}var r=ce.ToString(e);var n=t.length;var o;if(arguments.length>1){o=arguments[1]}var i=typeof o==="undefined"?n:ce.ToInteger(o);var a=R(A(i,0),n);return C(t,a-r.length,a)===r},includes:function includes(e){if(ce.IsRegExp(e)){throw new TypeError('"includes" does not accept a RegExp')}var t=ce.ToString(e);var r;if(arguments.length>1){r=arguments[1]}return I(this,t,r)!==-1},codePointAt:function codePointAt(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);var n=t.length;if(r>=0&&r<n){var o=t.charCodeAt(r);var i=r+1===n;if(o<55296||o>56319||i){return o}var a=t.charCodeAt(r+1);if(a<56320||a>57343){return o}return(o-55296)*1024+(a-56320)+65536}}};if(String.prototype.includes&&"a".includes("a",Infinity)!==false){ne(String.prototype,"includes",Fe.includes)}if(String.prototype.startsWith&&String.prototype.endsWith){var De=i(function(){return"/a/".startsWith(/a/)});var ze=a(function(){return"abc".startsWith("a",Infinity)===false});if(!De||!ze){ne(String.prototype,"startsWith",Fe.startsWith);ne(String.prototype,"endsWith",Fe.endsWith)}}if(oe){var qe=a(function(){var e=/a/;e[$.match]=false;return"/a/".startsWith(e)});if(!qe){ne(String.prototype,"startsWith",Fe.startsWith)}var We=a(function(){var e=/a/;e[$.match]=false;return"/a/".endsWith(e)});if(!We){ne(String.prototype,"endsWith",Fe.endsWith)}var Ge=a(function(){var e=/a/;e[$.match]=false;return"/a/".includes(e)});if(!Ge){ne(String.prototype,"includes",Fe.includes)}}b(String.prototype,Fe);var He=["\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join("");var Ve=new RegExp("(^["+He+"]+)|(["+He+"]+$)","g");var Be=function trim(){return ce.ToString(ce.RequireObjectCoercible(this)).replace(Ve,"")};var Ue=["\x85","\u200b","\ufffe"].join("");var $e=new RegExp("["+Ue+"]","g");var Je=/^[-+]0x[0-9a-f]+$/i;var Xe=Ue.trim().length!==Ue.length;h(String.prototype,"trim",Be,Xe);var Ke=function(e){return{value:e,done:arguments.length===0}};var Ze=function(e){ce.RequireObjectCoercible(e);this._s=ce.ToString(e);this._i=0};Ze.prototype.next=function(){var e=this._s;var t=this._i;if(typeof e==="undefined"||t>=e.length){this._s=void 0;return Ke()}var r=e.charCodeAt(t);var n,o;if(r<55296||r>56319||t+1===e.length){o=1}else{n=e.charCodeAt(t+1);o=n<56320||n>57343?1:2}this._i=t+o;return Ke(e.substr(t,o))};Me(Ze.prototype);Me(String.prototype,function(){return new Ze(this)});var Ye={from:function from(e){var r=this;var n;if(arguments.length>1){n=arguments[1]}var o,i;if(typeof n==="undefined"){o=false}else{if(!ce.IsCallable(n)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}o=true}var a=typeof(te(e)||ce.GetMethod(e,ie))!=="undefined";var u,f,s;if(a){f=ce.IsConstructor(r)?Object(new r):[];var c=ce.GetIterator(e);var l,p;s=0;while(true){l=ce.IteratorStep(c);if(l===false){break}p=l.value;try{if(o){p=typeof i==="undefined"?n(p,s):t(n,i,p,s)}f[s]=p}catch(v){ce.IteratorClose(c,true);throw v}s+=1}u=s}else{var y=ce.ToObject(e);u=ce.ToLength(y.length);f=ce.IsConstructor(r)?Object(new r(u)):new Array(u);var h;for(s=0;s<u;++s){h=y[s];if(o){h=typeof i==="undefined"?n(h,s):t(n,i,h,s)}Ne(f,s,h)}}f.length=u;return f},of:function of(){var e=arguments.length;var t=this;var n=r(t)||!ce.IsCallable(t)?new Array(e):ce.Construct(t,[e]);for(var o=0;o<e;++o){Ne(n,o,arguments[o])}n.length=e;return n}};b(Array,Ye);Ce(Array);q=function(e,t){this.i=0;this.array=e;this.kind=t};b(q.prototype,{next:function(){var e=this.i;var t=this.array;if(!(this instanceof q)){throw new TypeError("Not an ArrayIterator")}if(typeof t!=="undefined"){var r=ce.ToLength(t.length);for(;e<r;e++){var n=this.kind;var o;if(n==="key"){o=e}else if(n==="value"){o=t[e]}else if(n==="entry"){o=[e,t[e]]}this.i=e+1;return Ke(o)}}this.array=void 0;return Ke()}});Me(q.prototype);var Qe=Array.of===Ye.of||function(){var e=function Foo(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&t.length===2}();if(!Qe){ne(Array,"of",Ye.of)}var et={copyWithin:function copyWithin(e,t){var r=ce.ToObject(this);var n=ce.ToLength(r.length);var o=ce.ToInteger(e);var i=ce.ToInteger(t);var a=o<0?A(n+o,0):R(o,n);var u=i<0?A(n+i,0):R(i,n);var f;if(arguments.length>2){f=arguments[2]}var s=typeof f==="undefined"?n:ce.ToInteger(f);var c=s<0?A(n+s,0):R(s,n);var l=R(c-u,n-a);var p=1;if(u<a&&a<u+l){p=-1;u+=l-1;a+=l-1}while(l>0){if(u in r){r[a]=r[u]}else{delete r[a]}u+=p;a+=p;l-=1}return r},fill:function fill(e){var t;if(arguments.length>1){t=arguments[1]}var r;if(arguments.length>2){r=arguments[2]}var n=ce.ToObject(this);var o=ce.ToLength(n.length);t=ce.ToInteger(typeof t==="undefined"?0:t);r=ce.ToInteger(typeof r==="undefined"?o:r);var i=t<0?A(o+t,0):R(t,o);var a=r<0?o+r:r;for(var u=i;u<o&&u<a;++u){n[u]=e}return n},find:function find(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#find: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0,a;i<n;i++){a=r[i];if(o){if(t(e,o,a,i,r)){return a}}else if(e(a,i,r)){return a}}},findIndex:function findIndex(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#findIndex: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0;i<n;i++){if(o){if(t(e,o,r[i],i,r)){return i}}else if(e(r[i],i,r)){return i}}return-1},keys:function keys(){return new q(this,"key")},values:function values(){return new q(this,"value")},entries:function entries(){return new q(this,"entry")}};if(Array.prototype.keys&&!ce.IsCallable([1].keys().next)){delete Array.prototype.keys}if(Array.prototype.entries&&!ce.IsCallable([1].entries().next)){delete Array.prototype.entries}if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ie]){b(Array.prototype,{values:Array.prototype[ie]});if(re.symbol($.unscopables)){Array.prototype[$.unscopables].values=true}}if(c&&Array.prototype.values&&Array.prototype.values.name!=="values"){var tt=Array.prototype.values;ne(Array.prototype,"values",function values(){return ce.Call(tt,this,arguments)});h(Array.prototype,ie,Array.prototype.values,true)}b(Array.prototype,et);if(1/[true].indexOf(true,-0)<0){h(Array.prototype,"indexOf",function indexOf(e){var t=E(this,arguments);if(t===0&&1/t<0){return 0}return t},true)}Me(Array.prototype,function(){return this.values()});if(Object.getPrototypeOf){Me(Object.getPrototypeOf([].values()))}var rt=function(){return a(function(){return Array.from({length:-1}).length===0})}();var nt=function(){var e=Array.from([0].entries());return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0}();if(!rt||!nt){ne(Array,"from",Ye.from)}var ot=function(){return a(function(){return Array.from([0],void 0)})}();if(!ot){var it=Array.from;ne(Array,"from",function from(e){if(arguments.length>1&&typeof arguments[1]!=="undefined"){return ce.Call(it,this,arguments)}else{return t(it,this,e)}})}var at=-(Math.pow(2,32)-1);var ut=function(e,r){var n={length:at};n[r?(n.length>>>0)-1:0]=true;return a(function(){t(e,n,function(){throw new RangeError("should not reach here")},[]);return true})};if(!ut(Array.prototype.forEach)){var ft=Array.prototype.forEach;ne(Array.prototype,"forEach",function forEach(e){return ce.Call(ft,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.map)){var st=Array.prototype.map;ne(Array.prototype,"map",function map(e){return ce.Call(st,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.filter)){var ct=Array.prototype.filter;ne(Array.prototype,"filter",function filter(e){return ce.Call(ct,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.some)){var lt=Array.prototype.some;ne(Array.prototype,"some",function some(e){return ce.Call(lt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.every)){var pt=Array.prototype.every;ne(Array.prototype,"every",function every(e){return ce.Call(pt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduce)){var vt=Array.prototype.reduce;ne(Array.prototype,"reduce",function reduce(e){return ce.Call(vt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduceRight,true)){var yt=Array.prototype.reduceRight;ne(Array.prototype,"reduceRight",function reduceRight(e){return ce.Call(yt,this.length>=0?this:[],arguments)},true)}var ht=Number("0o10")!==8;var bt=Number("0b10")!==2;var gt=y(Ue,function(e){return Number(e+0+e)===0});if(ht||bt||gt){var dt=Number;var mt=/^0b[01]+$/i;var Ot=/^0o[0-7]+$/i;var wt=mt.test.bind(mt);var jt=Ot.test.bind(Ot);var St=function(e){var t;if(typeof e.valueOf==="function"){t=e.valueOf();if(re.primitive(t)){return t}}if(typeof e.toString==="function"){t=e.toString();if(re.primitive(t)){return t}}throw new TypeError("No default value")};var Tt=$e.test.bind($e);var It=Je.test.bind(Je);var Et=function(){var e=function Number(t){var r;if(arguments.length>0){r=re.primitive(t)?t:St(t,"number")}else{r=0}if(typeof r==="string"){r=ce.Call(Be,r);if(wt(r)){r=parseInt(C(r,2),2)}else if(jt(r)){r=parseInt(C(r,2),8)}else if(Tt(r)||It(r)){r=NaN}}var n=this;var o=a(function(){dt.prototype.valueOf.call(n);return true});if(n instanceof e&&!o){return new dt(r)}return dt(r)};return e}();Ee(dt,Et,{});b(Et,{NaN:dt.NaN,MAX_VALUE:dt.MAX_VALUE,MIN_VALUE:dt.MIN_VALUE,NEGATIVE_INFINITY:dt.NEGATIVE_INFINITY,POSITIVE_INFINITY:dt.POSITIVE_INFINITY});Number=Et;m.redefine(S,"Number",Et)}var Pt=Math.pow(2,53)-1;b(Number,{MAX_SAFE_INTEGER:Pt,MIN_SAFE_INTEGER:-Pt,EPSILON:2.220446049250313e-16,parseInt:S.parseInt,parseFloat:S.parseFloat,isFinite:K,isInteger:function isInteger(e){return K(e)&&ce.ToInteger(e)===e},isSafeInteger:function isSafeInteger(e){return Number.isInteger(e)&&k(e)<=Number.MAX_SAFE_INTEGER},isNaN:X});h(Number,"parseInt",S.parseInt,Number.parseInt!==S.parseInt);if([,1].find(function(){return true})===1){ne(Array.prototype,"find",et.find)}if([,1].findIndex(function(){return true})!==0){ne(Array.prototype,"findIndex",et.findIndex)}var Ct=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);var Mt=function ensureEnumerable(e,t){if(s&&Ct(e,t)){Object.defineProperty(e,t,{enumerable:false})}};var xt=function sliceArgs(){var e=Number(this);var t=arguments.length;var r=t-e;var n=new Array(r<0?0:r);for(var o=e;o<t;++o){n[o-e]=arguments[o]}return n};var Nt=function assignTo(e){return function assignToSource(t,r){t[r]=e[r];return t}};var At=function(e,t){var r=n(Object(t));var o;if(ce.IsCallable(Object.getOwnPropertySymbols)){o=v(Object.getOwnPropertySymbols(Object(t)),Ct(t))}return p(P(r,o||[]),Nt(t),e)};var Rt={assign:function(e,t){var r=ce.ToObject(e,"Cannot convert undefined or null to object");return p(ce.Call(xt,1,arguments),At,r)},is:function is(e,t){return ce.SameValue(e,t)}};var _t=Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return e[1]==="y"}}();if(_t){ne(Object,"assign",Rt.assign)}b(Object,Rt);if(s){var kt={setPrototypeOf:function(e,r){var n;var o=function(e,t){if(!ce.TypeIsObject(e)){throw new TypeError("cannot set prototype on a non-object")}if(!(t===null||ce.TypeIsObject(t))){throw new TypeError("can only set prototype to an object or null"+t)}};var i=function(e,r){o(e,r);t(n,e,r);return e};try{n=e.getOwnPropertyDescriptor(e.prototype,r).set;t(n,{},null)}catch(a){if(e.prototype!=={}[r]){return}n=function(e){this[r]=e};i.polyfill=i(i({},null),e.prototype)instanceof e}return i}(Object,"__proto__")};b(Object,kt)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){(function(){var e=Object.create(null);var t=Object.getPrototypeOf;var r=Object.setPrototypeOf;Object.getPrototypeOf=function(r){var n=t(r);return n===e?null:n};Object.setPrototypeOf=function(t,n){var o=n===null?e:n;return r(t,o)};Object.setPrototypeOf.polyfill=false})()}var Lt=!i(function(){return Object.keys("foo")});if(!Lt){var Ft=Object.keys;ne(Object,"keys",function keys(e){return Ft(ce.ToObject(e))});n=Object.keys}var Dt=i(function(){return Object.keys(/a/g)});if(Dt){var zt=Object.keys;ne(Object,"keys",function keys(e){if(re.regex(e)){var t=[];for(var r in e){if(z(e,r)){M(t,r)}}return t}return zt(e)});n=Object.keys}if(Object.getOwnPropertyNames){var qt=!i(function(){return Object.getOwnPropertyNames("foo")});if(!qt){var Wt=typeof window==="object"?Object.getOwnPropertyNames(window):[];var Gt=Object.getOwnPropertyNames;ne(Object,"getOwnPropertyNames",function getOwnPropertyNames(e){var t=ce.ToObject(e);if(g(t)==="[object Window]"){try{return Gt(t)}catch(r){return P([],Wt)}}return Gt(t)})}}if(Object.getOwnPropertyDescriptor){var Ht=!i(function(){return Object.getOwnPropertyDescriptor("foo","bar")});if(!Ht){var Vt=Object.getOwnPropertyDescriptor;ne(Object,"getOwnPropertyDescriptor",function getOwnPropertyDescriptor(e,t){return Vt(ce.ToObject(e),t)})}}if(Object.seal){var Bt=!i(function(){return Object.seal("foo")});if(!Bt){var Ut=Object.seal;ne(Object,"seal",function seal(e){if(!ce.TypeIsObject(e)){return e}return Ut(e)})}}if(Object.isSealed){var $t=!i(function(){return Object.isSealed("foo")});if(!$t){var Jt=Object.isSealed;ne(Object,"isSealed",function isSealed(e){if(!ce.TypeIsObject(e)){return true}return Jt(e)})}}if(Object.freeze){var Xt=!i(function(){return Object.freeze("foo")});if(!Xt){var Kt=Object.freeze;ne(Object,"freeze",function freeze(e){if(!ce.TypeIsObject(e)){return e}return Kt(e)})}}if(Object.isFrozen){var Zt=!i(function(){return Object.isFrozen("foo")});if(!Zt){var Yt=Object.isFrozen;ne(Object,"isFrozen",function isFrozen(e){if(!ce.TypeIsObject(e)){return true}return Yt(e)})}}if(Object.preventExtensions){var Qt=!i(function(){return Object.preventExtensions("foo")});if(!Qt){var er=Object.preventExtensions;ne(Object,"preventExtensions",function preventExtensions(e){if(!ce.TypeIsObject(e)){return e}return er(e)})}}if(Object.isExtensible){var tr=!i(function(){return Object.isExtensible("foo")});if(!tr){var rr=Object.isExtensible;ne(Object,"isExtensible",function isExtensible(e){if(!ce.TypeIsObject(e)){return false}return rr(e)})}}if(Object.getPrototypeOf){var nr=!i(function(){return Object.getPrototypeOf("foo")});if(!nr){var or=Object.getPrototypeOf;ne(Object,"getPrototypeOf",function getPrototypeOf(e){return or(ce.ToObject(e))})}}var ir=s&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&ce.IsCallable(e.get)}();if(s&&!ir){var ar=function flags(){if(!ce.TypeIsObject(this)){throw new TypeError("Method called on incompatible type: must be an object.")}var e="";if(this.global){e+="g"}if(this.ignoreCase){e+="i"}if(this.multiline){e+="m"}if(this.unicode){e+="u"}if(this.sticky){e+="y"}return e};m.getter(RegExp.prototype,"flags",ar)}var ur=s&&a(function(){return String(new RegExp(/a/g,"i"))==="/a/i"});var fr=oe&&s&&function(){var e=/./;e[$.match]=false;return RegExp(e)===e}();var sr=a(function(){return RegExp.prototype.toString.call({source:"abc"})==="/abc/"});var cr=sr&&a(function(){return RegExp.prototype.toString.call({source:"a",flags:"b"})==="/a/b"});if(!sr||!cr){var lr=RegExp.prototype.toString;h(RegExp.prototype,"toString",function toString(){var e=ce.RequireObjectCoercible(this);if(re.regex(e)){return t(lr,e)}var r=ue(e.source);var n=ue(e.flags);return"/"+r+"/"+n},true);m.preserveToString(RegExp.prototype.toString,lr)}if(s&&(!ur||fr)){var pr=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get;var vr=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{};var yr=function(){return this.source};var hr=ce.IsCallable(vr.get)?vr.get:yr;var br=RegExp;var gr=function(){return function RegExp(e,t){var r=ce.IsRegExp(e);var n=this instanceof RegExp;if(!n&&r&&typeof t==="undefined"&&e.constructor===RegExp){return e}var o=e;var i=t;if(re.regex(e)){o=ce.Call(hr,e);i=typeof t==="undefined"?ce.Call(pr,e):t;return new RegExp(o,i)}else if(r){o=e.source;i=typeof t==="undefined"?e.flags:t}return new br(e,t)}}();Ee(br,gr,{$input:true});RegExp=gr;m.redefine(S,"RegExp",gr)}if(s){var dr={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(n(dr),function(e){if(e in RegExp&&!(dr[e]in RegExp)){m.getter(RegExp,dr[e],function get(){return RegExp[e]})}})}Ce(RegExp);var mr=1/Number.EPSILON;var Or=function roundTiesToEven(e){return e+mr-mr};var wr=Math.pow(2,-23);var jr=Math.pow(2,127)*(2-wr);var Sr=Math.pow(2,-126);var Tr=Math.E;var Ir=Math.LOG2E;var Er=Math.LOG10E;var Pr=Number.prototype.clz;delete Number.prototype.clz;var Cr={acosh:function acosh(e){var t=Number(e);if(X(t)||e<1){return NaN}if(t===1){return 0}if(t===Infinity){return t}var r=1/(t*t);if(t<2){return Y(t-1+D(1-r)*t)}var n=t/2;return Y(n+D(1-r)*n-1)+1/Ir},asinh:function asinh(e){var t=Number(e);if(t===0||!T(t)){return t}var r=k(t);var n=r*r;var o=Z(t);if(r<1){return o*Y(r+n/(D(n+1)+1))}return o*(Y(r/2+D(1+1/n)*r/2-1)+1/Ir)},atanh:function atanh(e){var t=Number(e);if(t===0){return t}if(t===-1){return-Infinity}if(t===1){return Infinity}if(X(t)||t<-1||t>1){return NaN}var r=k(t);return Z(t)*Y(2*r/(1-r))/2},cbrt:function cbrt(e){var t=Number(e);if(t===0){return t}var r=t<0;var n;if(r){t=-t}if(t===Infinity){n=Infinity}else{n=L(F(t)/3);n=(t/(n*n)+2*n)/3}return r?-n:n},clz32:function clz32(e){var t=Number(e);var r=ce.ToUint32(t);if(r===0){return 32}return Pr?ce.Call(Pr,r):31-_(F(r+.5)*Ir)},cosh:function cosh(e){var t=Number(e);if(t===0){return 1}if(X(t)){return NaN}if(!T(t)){return Infinity}var r=L(k(t)-1);return(r+1/(r*Tr*Tr))*(Tr/2)},expm1:function expm1(e){var t=Number(e);if(t===-Infinity){return-1}if(!T(t)||t===0){return t}if(k(t)>.5){return L(t)-1}var r=t;var n=0;var o=1;while(n+r!==n){n+=r;o+=1;r*=t/o}return n},hypot:function hypot(e,t){var r=0;var n=0;for(var o=0;o<arguments.length;++o){var i=k(Number(arguments[o]));if(n<i){r*=n/i*(n/i);r+=1;n=i}else{r+=i>0?i/n*(i/n):i}}return n===Infinity?Infinity:n*D(r)},log2:function log2(e){return F(e)*Ir},log10:function log10(e){return F(e)*Er},log1p:Y,sign:Z,sinh:function sinh(e){var t=Number(e);if(!T(t)||t===0){return t}var r=k(t);if(r<1){var n=Math.expm1(r);return Z(t)*n*(1+1/(n+1))/2}var o=L(r-1);return Z(t)*(o-1/(o*Tr*Tr))*(Tr/2)},tanh:function tanh(e){var t=Number(e);if(X(t)||t===0){return t}if(t>=20){return 1}if(t<=-20){return-1}return(Math.expm1(t)-Math.expm1(-t))/(L(t)+L(-t))},trunc:function trunc(e){var t=Number(e);return t<0?-_(-t):_(t)},imul:function imul(e,t){var r=ce.ToUint32(e);var n=ce.ToUint32(t);var o=r>>>16&65535;var i=r&65535;var a=n>>>16&65535;var u=n&65535;return i*u+(o*u+i*a<<16>>>0)|0},fround:function fround(e){var t=Number(e);if(t===0||t===Infinity||t===-Infinity||X(t)){return t}var r=Z(t);var n=k(t);if(n<Sr){return r*Or(n/Sr/wr)*Sr*wr}var o=(1+wr/Number.EPSILON)*n;var i=o-(o-n);if(i>jr||X(i)){return r*Infinity}return r*i}};var Mr=function withinULPDistance(e,t,r){return k(1-e/t)/Number.EPSILON<(r||8)};b(Math,Cr);h(Math,"sinh",Cr.sinh,Math.sinh(710)===Infinity);h(Math,"cosh",Cr.cosh,Math.cosh(710)===Infinity);h(Math,"log1p",Cr.log1p,Math.log1p(-1e-17)!==-1e-17);h(Math,"asinh",Cr.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7));h(Math,"asinh",Cr.asinh,Math.asinh(1e300)===Infinity);h(Math,"atanh",Cr.atanh,Math.atanh(1e-300)===0);h(Math,"tanh",Cr.tanh,Math.tanh(-2e-17)!==-2e-17);
h(Math,"acosh",Cr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);h(Math,"acosh",Cr.acosh,!Mr(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON)));h(Math,"cbrt",Cr.cbrt,!Mr(Math.cbrt(1e-300),1e-100));h(Math,"sinh",Cr.sinh,Math.sinh(-2e-17)!==-2e-17);var xr=Math.expm1(10);h(Math,"expm1",Cr.expm1,xr>22025.465794806718||xr<22025.465794806718);var Nr=Math.round;var Ar=Math.round(.5-Number.EPSILON/4)===0&&Math.round(-.5+Number.EPSILON/3.99)===1;var Rr=mr+1;var _r=2*mr-1;var kr=[Rr,_r].every(function(e){return Math.round(e)===e});h(Math,"round",function round(e){var t=_(e);var r=t===-1?-0:t+1;return e-t<.5?t:r},!Ar||!kr);m.preserveToString(Math.round,Nr);var Lr=Math.imul;if(Math.imul(4294967295,5)!==-5){Math.imul=Cr.imul;m.preserveToString(Math.imul,Lr)}if(Math.imul.length!==2){ne(Math,"imul",function imul(e,t){return ce.Call(Lr,Math,arguments)})}var Fr=function(){var e=S.setTimeout;if(typeof e!=="function"&&typeof e!=="object"){return}ce.IsPromise=function(e){if(!ce.TypeIsObject(e)){return false}if(typeof e._promise==="undefined"){return false}return true};var r=function(e){if(!ce.IsConstructor(e)){throw new TypeError("Bad promise constructor")}var t=this;var r=function(e,r){if(t.resolve!==void 0||t.reject!==void 0){throw new TypeError("Bad Promise implementation!")}t.resolve=e;t.reject=r};t.resolve=void 0;t.reject=void 0;t.promise=new e(r);if(!(ce.IsCallable(t.resolve)&&ce.IsCallable(t.reject))){throw new TypeError("Bad promise constructor")}};var n;if(typeof window!=="undefined"&&ce.IsCallable(window.postMessage)){n=function(){var e=[];var t="zero-timeout-message";var r=function(r){M(e,r);window.postMessage(t,"*")};var n=function(r){if(r.source===window&&r.data===t){r.stopPropagation();if(e.length===0){return}var n=N(e);n()}};window.addEventListener("message",n,true);return r}}var o=function(){var e=S.Promise;var t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}};var i=ce.IsCallable(S.setImmediate)?S.setImmediate:typeof process==="object"&&process.nextTick?process.nextTick:o()||(ce.IsCallable(n)?n():function(t){e(t,0)});var a=function(e){return e};var u=function(e){throw e};var f=0;var s=1;var c=2;var l=0;var p=1;var v=2;var y={};var h=function(e,t,r){i(function(){g(e,t,r)})};var g=function(e,t,r){var n,o;if(t===y){return e(r)}try{n=e(r);o=t.resolve}catch(i){n=i;o=t.reject}o(n)};var d=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.fulfillReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+l],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=s;r.reactionLength=0};var m=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.rejectReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+p],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=c;r.reactionLength=0};var O=function(e){var t=false;var r=function(r){var n;if(t){return}t=true;if(r===e){return m(e,new TypeError("Self resolution"))}if(!ce.TypeIsObject(r)){return d(e,r)}try{n=r.then}catch(o){return m(e,o)}if(!ce.IsCallable(n)){return d(e,r)}i(function(){j(e,r,n)})};var n=function(r){if(t){return}t=true;return m(e,r)};return{resolve:r,reject:n}};var w=function(e,r,n,o){if(e===I){t(e,r,n,o,y)}else{t(e,r,n,o)}};var j=function(e,t,r){var n=O(e);var o=n.resolve;var i=n.reject;try{w(r,t,o,i)}catch(a){i(a)}};var T,I;var E=function(){var e=function Promise(t){if(!(this instanceof e)){throw new TypeError('Constructor Promise requires "new"')}if(this&&this._promise){throw new TypeError("Bad construction")}if(!ce.IsCallable(t)){throw new TypeError("not a valid resolver")}var r=Ae(this,e,T,{_promise:{result:void 0,state:f,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}});var n=O(r);var o=n.reject;try{t(n.resolve,o)}catch(i){o(i)}return r};return e}();T=E.prototype;var P=function(e,t,r,n){var o=false;return function(i){if(o){return}o=true;t[e]=i;if(--n.count===0){var a=r.resolve;a(t)}}};var C=function(e,t,r){var n=e.iterator;var o=[];var i={count:1};var a,u;var f=0;while(true){try{a=ce.IteratorStep(n);if(a===false){e.done=true;break}u=a.value}catch(s){e.done=true;throw s}o[f]=void 0;var c=t.resolve(u);var l=P(f,o,r,i);i.count+=1;w(c.then,c,l,r.reject);f+=1}if(--i.count===0){var p=r.resolve;p(o)}return r.promise};var x=function(e,t,r){var n=e.iterator;var o,i,a;while(true){try{o=ce.IteratorStep(n);if(o===false){e.done=true;break}i=o.value}catch(u){e.done=true;throw u}a=t.resolve(i);w(a.then,a,r.resolve,r.reject)}return r.promise};b(E,{all:function all(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return C(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},race:function race(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return x(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},reject:function reject(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}var n=new r(t);var o=n.reject;o(e);return n.promise},resolve:function resolve(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}if(ce.IsPromise(e)){var n=e.constructor;if(n===t){return e}}var o=new r(t);var i=o.resolve;i(e);return o.promise}});b(T,{"catch":function(e){return this.then(null,e)},then:function then(e,t){var n=this;if(!ce.IsPromise(n)){throw new TypeError("not a promise")}var o=ce.SpeciesConstructor(n,E);var i;var b=arguments.length>2&&arguments[2]===y;if(b&&o===E){i=y}else{i=new r(o)}var g=ce.IsCallable(e)?e:a;var d=ce.IsCallable(t)?t:u;var m=n._promise;var O;if(m.state===f){if(m.reactionLength===0){m.fulfillReactionHandler0=g;m.rejectReactionHandler0=d;m.reactionCapability0=i}else{var w=3*(m.reactionLength-1);m[w+l]=g;m[w+p]=d;m[w+v]=i}m.reactionLength+=1}else if(m.state===s){O=m.result;h(g,i,O)}else if(m.state===c){O=m.result;h(d,i,O)}else{throw new TypeError("unexpected Promise state")}return i.promise}});y=new r(E);I=T.then;return E}();if(S.Promise){delete S.Promise.accept;delete S.Promise.defer;delete S.Promise.prototype.chain}if(typeof Fr==="function"){b(S,{Promise:Fr});var Dr=w(S.Promise,function(e){return e.resolve(42).then(function(){})instanceof e});var zr=!i(function(){return S.Promise.reject(42).then(null,5).then(null,W)});var qr=i(function(){return S.Promise.call(3,W)});var Wr=function(e){var t=e.resolve(5);t.constructor={};var r=e.resolve(t);try{r.then(null,W).then(null,W)}catch(n){return true}return t===r}(S.Promise);var Gr=s&&function(){var e=0;var t=Object.defineProperty({},"then",{get:function(){e+=1}});Promise.resolve(t);return e===1}();var Hr=function BadResolverPromise(e){var t=new Promise(e);e(3,function(){});this.then=t.then;this.constructor=BadResolverPromise};Hr.prototype=Promise.prototype;Hr.all=Promise.all;var Vr=a(function(){return!!Hr.all([1,2])});if(!Dr||!zr||!qr||Wr||!Gr||Vr){Promise=Fr;ne(S,"Promise",Fr)}if(Promise.all.length!==1){var Br=Promise.all;ne(Promise,"all",function all(e){return ce.Call(Br,this,arguments)})}if(Promise.race.length!==1){var Ur=Promise.race;ne(Promise,"race",function race(e){return ce.Call(Ur,this,arguments)})}if(Promise.resolve.length!==1){var $r=Promise.resolve;ne(Promise,"resolve",function resolve(e){return ce.Call($r,this,arguments)})}if(Promise.reject.length!==1){var Jr=Promise.reject;ne(Promise,"reject",function reject(e){return ce.Call(Jr,this,arguments)})}Mt(Promise,"all");Mt(Promise,"race");Mt(Promise,"resolve");Mt(Promise,"reject");Ce(Promise)}var Xr=function(e){var t=n(p(e,function(e,t){e[t]=true;return e},{}));return e.join(":")===t.join(":")};var Kr=Xr(["z","a","bb"]);var Zr=Xr(["z",1,"a","3",2]);if(s){var Yr=function fastkey(e,t){if(!t&&!Kr){return null}if(se(e)){return"^"+ce.ToString(e)}else if(typeof e==="string"){return"$"+e}else if(typeof e==="number"){if(!Zr){return"n"+e}return e}else if(typeof e==="boolean"){return"b"+e}return null};var Qr=function emptyObject(){return Object.create?Object.create(null):{}};var en=function addIterableToMap(e,n,o){if(r(o)||re.string(o)){l(o,function(e){if(!ce.TypeIsObject(e)){throw new TypeError("Iterator value "+e+" is not an entry object")}n.set(e[0],e[1])})}else if(o instanceof e){t(e.prototype.forEach,o,function(e,t){n.set(t,e)})}else{var i,a;if(!se(o)){a=n.set;if(!ce.IsCallable(a)){throw new TypeError("bad map")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{if(!ce.TypeIsObject(f)){throw new TypeError("Iterator value "+f+" is not an entry object")}t(a,n,f[0],f[1])}catch(s){ce.IteratorClose(i,true);throw s}}}}};var tn=function addIterableToSet(e,n,o){if(r(o)||re.string(o)){l(o,function(e){n.add(e)})}else if(o instanceof e){t(e.prototype.forEach,o,function(e){n.add(e)})}else{var i,a;if(!se(o)){a=n.add;if(!ce.IsCallable(a)){throw new TypeError("bad set")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{t(a,n,f)}catch(s){ce.IteratorClose(i,true);throw s}}}}};var rn={Map:function(){var e={};var r=function MapEntry(e,t){this.key=e;this.value=t;this.next=null;this.prev=null};r.prototype.isRemoved=function isRemoved(){return this.key===e};var n=function isMap(e){return!!e._es6map};var o=function requireMapSlot(e,t){if(!ce.TypeIsObject(e)||!n(e)){throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+ce.ToString(e))}};var i=function MapIterator(e,t){o(e,"[[MapIterator]]");this.head=e._head;this.i=this.head;this.kind=t};i.prototype={isMapIterator:true,next:function next(){if(!this.isMapIterator){throw new TypeError("Not a MapIterator")}var e=this.i;var t=this.kind;var r=this.head;if(typeof this.i==="undefined"){return Ke()}while(e.isRemoved()&&e!==r){e=e.prev}var n;while(e.next!==r){e=e.next;if(!e.isRemoved()){if(t==="key"){n=e.key}else if(t==="value"){n=e.value}else{n=[e.key,e.value]}this.i=e;return Ke(n)}}this.i=void 0;return Ke()}};Me(i.prototype);var a;var u=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}if(this&&this._es6map){throw new TypeError("Bad construction")}var e=Ae(this,Map,a,{_es6map:true,_head:null,_map:G?new G:null,_size:0,_storage:Qr()});var t=new r(null,null);t.next=t.prev=t;e._head=t;if(arguments.length>0){en(Map,e,arguments[0])}return e};a=u.prototype;m.getter(a,"size",function(){if(typeof this._size==="undefined"){throw new TypeError("size method called on incompatible Map")}return this._size});b(a,{get:function get(e){o(this,"get");var t;var r=Yr(e,true);if(r!==null){t=this._storage[r];if(t){return t.value}else{return}}if(this._map){t=V.call(this._map,e);if(t){return t.value}else{return}}var n=this._head;var i=n;while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){return i.value}}},has:function has(e){o(this,"has");var t=Yr(e,true);if(t!==null){return typeof this._storage[t]!=="undefined"}if(this._map){return B.call(this._map,e)}var r=this._head;var n=r;while((n=n.next)!==r){if(ce.SameValueZero(n.key,e)){return true}}return false},set:function set(e,t){o(this,"set");var n=this._head;var i=n;var a;var u=Yr(e,true);if(u!==null){if(typeof this._storage[u]!=="undefined"){this._storage[u].value=t;return this}else{a=this._storage[u]=new r(e,t);i=n.prev}}else if(this._map){if(B.call(this._map,e)){V.call(this._map,e).value=t}else{a=new r(e,t);U.call(this._map,e,a);i=n.prev}}while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){i.value=t;return this}}a=a||new r(e,t);if(ce.SameValue(-0,e)){a.key=+0}a.next=this._head;a.prev=this._head.prev;a.prev.next=a;a.next.prev=a;this._size+=1;return this},"delete":function(t){o(this,"delete");var r=this._head;var n=r;var i=Yr(t,true);if(i!==null){if(typeof this._storage[i]==="undefined"){return false}n=this._storage[i].prev;delete this._storage[i]}else if(this._map){if(!B.call(this._map,t)){return false}n=V.call(this._map,t).prev;H.call(this._map,t)}while((n=n.next)!==r){if(ce.SameValueZero(n.key,t)){n.key=e;n.value=e;n.prev.next=n.next;n.next.prev=n.prev;this._size-=1;return true}}return false},clear:function clear(){o(this,"clear");this._map=G?new G:null;this._size=0;this._storage=Qr();var t=this._head;var r=t;var n=r.next;while((r=n)!==t){r.key=e;r.value=e;n=r.next;r.next=r.prev=t}t.next=t.prev=t},keys:function keys(){o(this,"keys");return new i(this,"key")},values:function values(){o(this,"values");return new i(this,"value")},entries:function entries(){o(this,"entries");return new i(this,"key+value")},forEach:function forEach(e){o(this,"forEach");var r=arguments.length>1?arguments[1]:null;var n=this.entries();for(var i=n.next();!i.done;i=n.next()){if(r){t(e,r,i.value[1],i.value[0],this)}else{e(i.value[1],i.value[0],this)}}}});Me(a,a.entries);return u}(),Set:function(){var e=function isSet(e){return e._es6set&&typeof e._storage!=="undefined"};var r=function requireSetSlot(t,r){if(!ce.TypeIsObject(t)||!e(t)){throw new TypeError("Set.prototype."+r+" called on incompatible receiver "+ce.ToString(t))}};var o;var i=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}if(this&&this._es6set){throw new TypeError("Bad construction")}var e=Ae(this,Set,o,{_es6set:true,"[[SetData]]":null,_storage:Qr()});if(!e._es6set){throw new TypeError("bad set")}if(arguments.length>0){tn(Set,e,arguments[0])}return e};o=i.prototype;var a=function(e){var t=e;if(t==="^null"){return null}else if(t==="^undefined"){return void 0}else{var r=t.charAt(0);if(r==="$"){return C(t,1)}else if(r==="n"){return+C(t,1)}else if(r==="b"){return t==="btrue"}}return+t};var u=function ensureMap(e){if(!e["[[SetData]]"]){var t=new rn.Map;e["[[SetData]]"]=t;l(n(e._storage),function(e){var r=a(e);t.set(r,r)});e["[[SetData]]"]=t}e._storage=null};m.getter(i.prototype,"size",function(){r(this,"size");if(this._storage){return n(this._storage).length}u(this);return this["[[SetData]]"].size});b(i.prototype,{has:function has(e){r(this,"has");var t;if(this._storage&&(t=Yr(e))!==null){return!!this._storage[t]}u(this);return this["[[SetData]]"].has(e)},add:function add(e){r(this,"add");var t;if(this._storage&&(t=Yr(e))!==null){this._storage[t]=true;return this}u(this);this["[[SetData]]"].set(e,e);return this},"delete":function(e){r(this,"delete");var t;if(this._storage&&(t=Yr(e))!==null){var n=z(this._storage,t);return delete this._storage[t]&&n}u(this);return this["[[SetData]]"]["delete"](e)},clear:function clear(){r(this,"clear");if(this._storage){this._storage=Qr()}if(this["[[SetData]]"]){this["[[SetData]]"].clear()}},values:function values(){r(this,"values");u(this);return new f(this["[[SetData]]"].values())},entries:function entries(){r(this,"entries");u(this);return new f(this["[[SetData]]"].entries())},forEach:function forEach(e){r(this,"forEach");var n=arguments.length>1?arguments[1]:null;var o=this;u(o);this["[[SetData]]"].forEach(function(r,i){if(n){t(e,n,i,i,o)}else{e(i,i,o)}})}});h(i.prototype,"keys",i.prototype.values,true);Me(i.prototype,i.prototype.values);var f=function SetIterator(e){this.it=e};f.prototype={isSetIterator:true,next:function next(){if(!this.isSetIterator){throw new TypeError("Not a SetIterator")}return this.it.next()}};Me(f.prototype);return i}()};var nn=S.Set&&!Set.prototype["delete"]&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys);if(nn){S.Set=rn.Set}if(S.Map||S.Set){var on=a(function(){return new Map([[1,2]]).get(1)===2});if(!on){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,S.Map.prototype);return e};S.Map.prototype=O(G.prototype);h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var an=new Map;var un=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);e.set(-0,e);return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}();var fn=an.set(1,2)===an;if(!un||!fn){ne(Map.prototype,"set",function set(e,r){t(U,this,e===0?0:e,r);return this})}if(!un){b(Map.prototype,{get:function get(e){return t(V,this,e===0?0:e)},has:function has(e){return t(B,this,e===0?0:e)}},true);m.preserveToString(Map.prototype.get,V);m.preserveToString(Map.prototype.has,B)}var sn=new Set;var cn=Set.prototype["delete"]&&Set.prototype.add&&Set.prototype.has&&function(e){e["delete"](0);e.add(-0);return!e.has(0)}(sn);var ln=sn.add(1)===sn;if(!cn||!ln){var pn=Set.prototype.add;Set.prototype.add=function add(e){t(pn,this,e===0?0:e);return this};m.preserveToString(Set.prototype.add,pn)}if(!cn){var vn=Set.prototype.has;Set.prototype.has=function has(e){return t(vn,this,e===0?0:e)};m.preserveToString(Set.prototype.has,vn);var yn=Set.prototype["delete"];Set.prototype["delete"]=function SetDelete(e){return t(yn,this,e===0?0:e)};m.preserveToString(Set.prototype["delete"],yn)}var hn=w(S.Map,function(e){var t=new e([]);t.set(42,42);return t instanceof e});var bn=Object.setPrototypeOf&&!hn;var gn=function(){try{return!(S.Map()instanceof S.Map)}catch(e){return e instanceof TypeError}}();if(S.Map.length!==0||bn||!gn){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Map.prototype);return e};S.Map.prototype=G.prototype;h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var dn=w(S.Set,function(e){var t=new e([]);t.add(42,42);return t instanceof e});var mn=Object.setPrototypeOf&&!dn;var On=function(){try{return!(S.Set()instanceof S.Set)}catch(e){return e instanceof TypeError}}();if(S.Set.length!==0||mn||!On){var wn=S.Set;S.Set=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}var e=new wn;if(arguments.length>0){tn(Set,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Set.prototype);return e};S.Set.prototype=wn.prototype;h(S.Set.prototype,"constructor",S.Set,true);m.preserveToString(S.Set,wn)}var jn=new S.Map;var Sn=!a(function(){return jn.keys().next().done});if(typeof S.Map.prototype.clear!=="function"||(new S.Set).size!==0||jn.size!==0||typeof S.Map.prototype.keys!=="function"||typeof S.Set.prototype.keys!=="function"||typeof S.Map.prototype.forEach!=="function"||typeof S.Set.prototype.forEach!=="function"||u(S.Map)||u(S.Set)||typeof jn.keys().next!=="function"||Sn||!hn){b(S,{Map:rn.Map,Set:rn.Set},true)}if(S.Set.prototype.keys!==S.Set.prototype.values){h(S.Set.prototype,"keys",S.Set.prototype.values,true)}Me(Object.getPrototypeOf((new S.Map).keys()));Me(Object.getPrototypeOf((new S.Set).keys()));if(c&&S.Set.prototype.has.name!=="has"){var Tn=S.Set.prototype.has;ne(S.Set.prototype,"has",function has(e){return t(Tn,this,e)})}}b(S,rn);Ce(S.Map);Ce(S.Set)}var In=function throwUnlessTargetIsObject(e){if(!ce.TypeIsObject(e)){throw new TypeError("target must be an object")}};var En={apply:function apply(){return ce.Call(ce.Call,null,arguments)},construct:function construct(e,t){if(!ce.IsConstructor(e)){throw new TypeError("First argument must be a constructor.")}var r=arguments.length>2?arguments[2]:e;if(!ce.IsConstructor(r)){throw new TypeError("new.target must be a constructor.")}return ce.Construct(e,t,r,"internal")},deleteProperty:function deleteProperty(e,t){In(e);if(s){var r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){return false}}return delete e[t]},has:function has(e,t){In(e);return t in e}};if(Object.getOwnPropertyNames){Object.assign(En,{ownKeys:function ownKeys(e){In(e);var t=Object.getOwnPropertyNames(e);if(ce.IsCallable(Object.getOwnPropertySymbols)){x(t,Object.getOwnPropertySymbols(e))}return t}})}var Pn=function ConvertExceptionToBoolean(e){return!i(e)};if(Object.preventExtensions){Object.assign(En,{isExtensible:function isExtensible(e){In(e);return Object.isExtensible(e)},preventExtensions:function preventExtensions(e){In(e);return Pn(function(){return Object.preventExtensions(e)})}})}if(s){var Cn=function get(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(!n){var o=Object.getPrototypeOf(e);if(o===null){return void 0}return Cn(o,t,r)}if("value"in n){return n.value}if(n.get){return ce.Call(n.get,r)}return void 0};var Mn=function set(e,r,n,o){var i=Object.getOwnPropertyDescriptor(e,r);if(!i){var a=Object.getPrototypeOf(e);if(a!==null){return Mn(a,r,n,o)}i={value:void 0,writable:true,enumerable:true,configurable:true}}if("value"in i){if(!i.writable){return false}if(!ce.TypeIsObject(o)){return false}var u=Object.getOwnPropertyDescriptor(o,r);if(u){return ae.defineProperty(o,r,{value:n})}else{return ae.defineProperty(o,r,{value:n,writable:true,enumerable:true,configurable:true})}}if(i.set){t(i.set,o,n);return true}return false};Object.assign(En,{defineProperty:function defineProperty(e,t,r){In(e);return Pn(function(){return Object.defineProperty(e,t,r)})},getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){In(e);return Object.getOwnPropertyDescriptor(e,t)},get:function get(e,t){In(e);var r=arguments.length>2?arguments[2]:e;return Cn(e,t,r)},set:function set(e,t,r){In(e);var n=arguments.length>3?arguments[3]:e;return Mn(e,t,r,n)}})}if(Object.getPrototypeOf){var xn=Object.getPrototypeOf;En.getPrototypeOf=function getPrototypeOf(e){In(e);return xn(e)}}if(Object.setPrototypeOf&&En.getPrototypeOf){var Nn=function(e,t){var r=t;while(r){if(e===r){return true}r=En.getPrototypeOf(r)}return false};Object.assign(En,{setPrototypeOf:function setPrototypeOf(e,t){In(e);if(t!==null&&!ce.TypeIsObject(t)){throw new TypeError("proto must be an object or null")}if(t===ae.getPrototypeOf(e)){return true}if(ae.isExtensible&&!ae.isExtensible(e)){return false}if(Nn(e,t)){return false}Object.setPrototypeOf(e,t);return true}})}var An=function(e,t){if(!ce.IsCallable(S.Reflect[e])){h(S.Reflect,e,t)}else{var r=a(function(){S.Reflect[e](1);S.Reflect[e](NaN);S.Reflect[e](true);return true});if(r){ne(S.Reflect,e,t)}}};Object.keys(En).forEach(function(e){An(e,En[e])});var Rn=S.Reflect.getPrototypeOf;if(c&&Rn&&Rn.name!=="getPrototypeOf"){ne(S.Reflect,"getPrototypeOf",function getPrototypeOf(e){return t(Rn,S.Reflect,e)})}if(S.Reflect.setPrototypeOf){if(a(function(){S.Reflect.setPrototypeOf(1,{});return true})){ne(S.Reflect,"setPrototypeOf",En.setPrototypeOf)}}if(S.Reflect.defineProperty){if(!a(function(){var e=!S.Reflect.defineProperty(1,"test",{value:1});var t=typeof Object.preventExtensions!=="function"||!S.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})){ne(S.Reflect,"defineProperty",En.defineProperty)}}if(S.Reflect.construct){if(!a(function(){var e=function F(){};return S.Reflect.construct(function(){},[],e)instanceof e})){ne(S.Reflect,"construct",En.construct)}}if(String(new Date(NaN))!=="Invalid Date"){var _n=Date.prototype.toString;var kn=function toString(){var e=+this;if(e!==e){return"Invalid Date"}return ce.Call(_n,this)};ne(Date.prototype,"toString",kn)}var Ln={anchor:function anchor(e){return ce.CreateHTML(this,"a","name",e)},big:function big(){return ce.CreateHTML(this,"big","","")},blink:function blink(){return ce.CreateHTML(this,"blink","","")},bold:function bold(){return ce.CreateHTML(this,"b","","")},fixed:function fixed(){return ce.CreateHTML(this,"tt","","")},fontcolor:function fontcolor(e){return ce.CreateHTML(this,"font","color",e)},fontsize:function fontsize(e){return ce.CreateHTML(this,"font","size",e)},italics:function italics(){return ce.CreateHTML(this,"i","","")},link:function link(e){return ce.CreateHTML(this,"a","href",e)},small:function small(){return ce.CreateHTML(this,"small","","")},strike:function strike(){return ce.CreateHTML(this,"strike","","")},sub:function sub(){return ce.CreateHTML(this,"sub","","")},sup:function sub(){return ce.CreateHTML(this,"sup","","")}};l(Object.keys(Ln),function(e){var r=String.prototype[e];var n=false;if(ce.IsCallable(r)){var o=t(r,"",' " ');var i=P([],o.match(/"/g)).length;n=o!==o.toLowerCase()||i>2}else{n=true}if(n){ne(String.prototype,e,Ln[e])}});var Fn=function(){if(!oe){return false}var e=typeof JSON==="object"&&typeof JSON.stringify==="function"?JSON.stringify:null;if(!e){return false}if(typeof e($())!=="undefined"){return true}if(e([$()])!=="[null]"){return true}var t={a:$()};t[$()]=true;if(e(t)!=="{}"){return true}return false}();var Dn=a(function(){if(!oe){return true}return JSON.stringify(Object($()))==="{}"&&JSON.stringify([Object($())])==="[{}]"});if(Fn||!Dn){var zn=JSON.stringify;ne(JSON,"stringify",function stringify(e){if(typeof e==="symbol"){return}var n;if(arguments.length>1){n=arguments[1]}var o=[e];if(!r(n)){var i=ce.IsCallable(n)?n:null;var a=function(e,r){var n=i?t(i,this,e,r):r;if(typeof n!=="symbol"){if(re.symbol(n)){return Nt({})(n)}else{return n}}};o.push(a)}else{o.push(n)}if(arguments.length>2){o.push(arguments[2])}return zn.apply(this,o)})}return S});
//# sourceMappingURL=es6-shim.map
/*! jQuery v3.4.1 | (c) JS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";var t=[],E=C.document,r=Object.getPrototypeOf,s=t.slice,g=t.concat,u=t.push,i=t.indexOf,n={},o=n.toString,v=n.hasOwnProperty,a=v.toString,l=a.call(Object),y={},m=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType},x=function(e){return null!=e&&e===e.window},c={type:!0,src:!0,nonce:!0,noModule:!0};function b(e,t,n){var r,i,o=(n=n||E).createElement("script");if(o.text=e,t)for(r in c)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function w(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[o.call(e)]||"object":typeof e}var f="3.4.1",k=function(e,t){return new k.fn.init(e,t)},p=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;function d(e){var t=!!e&&"length"in e&&e.length,n=w(e);return!m(e)&&!x(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}k.fn=k.prototype={jquery:f,constructor:k,length:0,toArray:function(){return s.call(this)},get:function(e){return null==e?s.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=k.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return k.each(this,e)},map:function(n){return this.pushStack(k.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},k.extend=k.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||m(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(k.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||k.isPlainObject(n)?n:{},i=!1,a[t]=k.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},k.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==o.call(e))&&(!(t=r(e))||"function"==typeof(n=v.call(t,"constructor")&&t.constructor)&&a.call(n)===l)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t){b(e,{nonce:t&&t.nonce})},each:function(e,t){var n,r=0;if(d(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(p,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(d(Object(e))?k.merge(n,"string"==typeof e?[e]:e):u.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:i.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(d(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g.apply([],a)},guid:1,support:y}),"function"==typeof Symbol&&(k.fn[Symbol.iterator]=t[Symbol.iterator]),k.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var h=function(n){var e,d,b,o,i,h,f,g,w,u,l,T,C,a,E,v,s,c,y,k="sizzle"+1*new Date,m=n.document,S=0,r=0,p=ue(),x=ue(),N=ue(),A=ue(),D=function(e,t){return e===t&&(l=!0),0},j={}.hasOwnProperty,t=[],q=t.pop,L=t.push,H=t.push,O=t.slice,P=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},R="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",M="[\\x20\\t\\r\\n\\f]",I="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",W="\\["+M+"*("+I+")(?:"+M+"*([*^$|!~]?=)"+M+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+I+"))|)"+M+"*\\]",$=":("+I+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+W+")*)|.*)\\)|)",F=new RegExp(M+"+","g"),B=new RegExp("^"+M+"+|((?:^|[^\\\\])(?:\\\\.)*)"+M+"+$","g"),_=new RegExp("^"+M+"*,"+M+"*"),z=new RegExp("^"+M+"*([>+~]|"+M+")"+M+"*"),U=new RegExp(M+"|>"),X=new RegExp($),V=new RegExp("^"+I+"$"),G={ID:new RegExp("^#("+I+")"),CLASS:new RegExp("^\\.("+I+")"),TAG:new RegExp("^("+I+"|[*])"),ATTR:new RegExp("^"+W),PSEUDO:new RegExp("^"+$),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+M+"*(even|odd|(([+-]|)(\\d*)n|)"+M+"*(?:([+-]|)"+M+"*(\\d+)|))"+M+"*\\)|)","i"),bool:new RegExp("^(?:"+R+")$","i"),needsContext:new RegExp("^"+M+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+M+"*((?:-\\d)?\\d*)"+M+"*\\)|)(?=[^-]|$)","i")},Y=/HTML$/i,Q=/^(?:input|select|textarea|button)$/i,J=/^h\d$/i,K=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=new RegExp("\\\\([\\da-f]{1,6}"+M+"?|("+M+")|.)","ig"),ne=function(e,t,n){var r="0x"+t-65536;return r!=r||n?t:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ie=function(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},oe=function(){T()},ae=be(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{H.apply(t=O.call(m.childNodes),m.childNodes),t[m.childNodes.length].nodeType}catch(e){H={apply:t.length?function(e,t){L.apply(e,O.call(t))}:function(e,t){var n=e.length,r=0;while(e[n++]=t[r++]);e.length=n-1}}}function se(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&((e?e.ownerDocument||e:m)!==C&&T(e),e=e||C,E)){if(11!==p&&(u=Z.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(f&&(a=f.getElementById(i))&&y(e,a)&&a.id===i)return n.push(a),n}else{if(u[2])return H.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&d.getElementsByClassName&&e.getElementsByClassName)return H.apply(n,e.getElementsByClassName(i)),n}if(d.qsa&&!A[t+" "]&&(!v||!v.test(t))&&(1!==p||"object"!==e.nodeName.toLowerCase())){if(c=t,f=e,1===p&&U.test(t)){(s=e.getAttribute("id"))?s=s.replace(re,ie):e.setAttribute("id",s=k),o=(l=h(t)).length;while(o--)l[o]="#"+s+" "+xe(l[o]);c=l.join(","),f=ee.test(t)&&ye(e.parentNode)||e}try{return H.apply(n,f.querySelectorAll(c)),n}catch(e){A(t,!0)}finally{s===k&&e.removeAttribute("id")}}}return g(t.replace(B,"$1"),e,n,r)}function ue(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function le(e){return e[k]=!0,e}function ce(e){var t=C.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function fe(e,t){var n=e.split("|"),r=n.length;while(r--)b.attrHandle[n[r]]=t}function pe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function de(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function he(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}function ge(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&ae(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function ve(a){return le(function(o){return o=+o,le(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function ye(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}for(e in d=se.support={},i=se.isXML=function(e){var t=e.namespaceURI,n=(e.ownerDocument||e).documentElement;return!Y.test(t||n&&n.nodeName||"HTML")},T=se.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:m;return r!==C&&9===r.nodeType&&r.documentElement&&(a=(C=r).documentElement,E=!i(C),m!==C&&(n=C.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",oe,!1):n.attachEvent&&n.attachEvent("onunload",oe)),d.attributes=ce(function(e){return e.className="i",!e.getAttribute("className")}),d.getElementsByTagName=ce(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),d.getElementsByClassName=K.test(C.getElementsByClassName),d.getById=ce(function(e){return a.appendChild(e).id=k,!C.getElementsByName||!C.getElementsByName(k).length}),d.getById?(b.filter.ID=function(e){var t=e.replace(te,ne);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(te,ne);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=d.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):d.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},b.find.CLASS=d.getElementsByClassName&&function(e,t){if("undefined"!=typeof t.getElementsByClassName&&E)return t.getElementsByClassName(e)},s=[],v=[],(d.qsa=K.test(C.querySelectorAll))&&(ce(function(e){a.appendChild(e).innerHTML="<a id='"+k+"'></a><select id='"+k+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&v.push("[*^$]="+M+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||v.push("\\["+M+"*(?:value|"+R+")"),e.querySelectorAll("[id~="+k+"-]").length||v.push("~="),e.querySelectorAll(":checked").length||v.push(":checked"),e.querySelectorAll("a#"+k+"+*").length||v.push(".#.+[+~]")}),ce(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&v.push("name"+M+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&v.push(":enabled",":disabled"),a.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&v.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),v.push(",.*:")})),(d.matchesSelector=K.test(c=a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector||a.msMatchesSelector))&&ce(function(e){d.disconnectedMatch=c.call(e,"*"),c.call(e,"[s!='']:x"),s.push("!=",$)}),v=v.length&&new RegExp(v.join("|")),s=s.length&&new RegExp(s.join("|")),t=K.test(a.compareDocumentPosition),y=t||K.test(a.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},D=t?function(e,t){if(e===t)return l=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!d.sortDetached&&t.compareDocumentPosition(e)===n?e===C||e.ownerDocument===m&&y(m,e)?-1:t===C||t.ownerDocument===m&&y(m,t)?1:u?P(u,e)-P(u,t):0:4&n?-1:1)}:function(e,t){if(e===t)return l=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e===C?-1:t===C?1:i?-1:o?1:u?P(u,e)-P(u,t):0;if(i===o)return pe(e,t);n=e;while(n=n.parentNode)a.unshift(n);n=t;while(n=n.parentNode)s.unshift(n);while(a[r]===s[r])r++;return r?pe(a[r],s[r]):a[r]===m?-1:s[r]===m?1:0}),C},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if((e.ownerDocument||e)!==C&&T(e),d.matchesSelector&&E&&!A[t+" "]&&(!s||!s.test(t))&&(!v||!v.test(t)))try{var n=c.call(e,t);if(n||d.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){A(t,!0)}return 0<se(t,C,null,[e]).length},se.contains=function(e,t){return(e.ownerDocument||e)!==C&&T(e),y(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!==C&&T(e);var n=b.attrHandle[t.toLowerCase()],r=n&&j.call(b.attrHandle,t.toLowerCase())?n(e,t,!E):void 0;return void 0!==r?r:d.attributes||!E?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},se.escape=function(e){return(e+"").replace(re,ie)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,n=[],r=0,i=0;if(l=!d.detectDuplicates,u=!d.sortStable&&e.slice(0),e.sort(D),l){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)e.splice(n[r],1)}return u=null,e},o=se.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else while(t=e[r++])n+=o(t);return n},(b=se.selectors={cacheLength:50,createPseudo:le,match:G,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(te,ne),e[3]=(e[3]||e[4]||e[5]||"").replace(te,ne),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return G.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&X.test(n)&&(t=h(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(te,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=p[e+" "];return t||(t=new RegExp("(^|"+M+")"+e+"("+M+"|$)"))&&p(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=se.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(F," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(h,e,t,g,v){var y="nth"!==h.slice(0,3),m="last"!==h.slice(-4),x="of-type"===e;return 1===g&&0===v?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u,l=y!==m?"nextSibling":"previousSibling",c=e.parentNode,f=x&&e.nodeName.toLowerCase(),p=!n&&!x,d=!1;if(c){if(y){while(l){a=e;while(a=a[l])if(x?a.nodeName.toLowerCase()===f:1===a.nodeType)return!1;u=l="only"===h&&!u&&"nextSibling"}return!0}if(u=[m?c.firstChild:c.lastChild],m&&p){d=(s=(r=(i=(o=(a=c)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1])&&r[2],a=s&&c.childNodes[s];while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if(1===a.nodeType&&++d&&a===e){i[h]=[S,s,d];break}}else if(p&&(d=s=(r=(i=(o=(a=e)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1]),!1===d)while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if((x?a.nodeName.toLowerCase()===f:1===a.nodeType)&&++d&&(p&&((i=(o=a[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]=[S,d]),a===e))break;return(d-=v)===g||d%g==0&&0<=d/g}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return a[k]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?le(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=P(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:le(function(e){var r=[],i=[],s=f(e.replace(B,"$1"));return s[k]?le(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:le(function(t){return function(e){return 0<se(t,e).length}}),contains:le(function(t){return t=t.replace(te,ne),function(e){return-1<(e.textContent||o(e)).indexOf(t)}}),lang:le(function(n){return V.test(n||"")||se.error("unsupported lang: "+n),n=n.replace(te,ne).toLowerCase(),function(e){var t;do{if(t=E?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===a},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:ge(!1),disabled:ge(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return J.test(e.nodeName)},input:function(e){return Q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:ve(function(){return[0]}),last:ve(function(e,t){return[t-1]}),eq:ve(function(e,t,n){return[n<0?n+t:n]}),even:ve(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:ve(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:ve(function(e,t,n){for(var r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:ve(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=de(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=he(e);function me(){}function xe(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function be(s,e,t){var u=e.dir,l=e.next,c=l||u,f=t&&"parentNode"===c,p=r++;return e.first?function(e,t,n){while(e=e[u])if(1===e.nodeType||f)return s(e,t,n);return!1}:function(e,t,n){var r,i,o,a=[S,p];if(n){while(e=e[u])if((1===e.nodeType||f)&&s(e,t,n))return!0}else while(e=e[u])if(1===e.nodeType||f)if(i=(o=e[k]||(e[k]={}))[e.uniqueID]||(o[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[u]||e;else{if((r=i[c])&&r[0]===S&&r[1]===p)return a[2]=r[2];if((i[c]=a)[2]=s(e,t,n))return!0}return!1}}function we(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Te(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function Ce(d,h,g,v,y,e){return v&&!v[k]&&(v=Ce(v)),y&&!y[k]&&(y=Ce(y,e)),le(function(e,t,n,r){var i,o,a,s=[],u=[],l=t.length,c=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)se(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),f=!d||!e&&h?c:Te(c,s,d,n,r),p=g?y||(e?d:l||v)?[]:t:f;if(g&&g(f,p,n,r),v){i=Te(p,u),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(p[u[o]]=!(f[u[o]]=a))}if(e){if(y||d){if(y){i=[],o=p.length;while(o--)(a=p[o])&&i.push(f[o]=a);y(null,p=[],i,r)}o=p.length;while(o--)(a=p[o])&&-1<(i=y?P(e,a):s[o])&&(e[i]=!(t[i]=a))}}else p=Te(p===t?p.splice(l,p.length):p),y?y(null,t,p,r):H.apply(t,p)})}function Ee(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=be(function(e){return e===i},a,!0),l=be(function(e){return-1<P(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!==w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[be(we(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[k]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return Ce(1<s&&we(c),1<s&&xe(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(B,"$1"),t,s<n&&Ee(e.slice(s,n)),n<r&&Ee(e=e.slice(n)),n<r&&xe(e))}c.push(t)}return we(c)}return me.prototype=b.filters=b.pseudos,b.setFilters=new me,h=se.tokenize=function(e,t){var n,r,i,o,a,s,u,l=x[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=_.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=z.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(B," ")}),a=a.slice(n.length)),b.filter)!(r=G[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?se.error(e):x(e,s).slice(0)},f=se.compile=function(e,t){var n,v,y,m,x,r,i=[],o=[],a=N[e+" "];if(!a){t||(t=h(e)),n=t.length;while(n--)(a=Ee(t[n]))[k]?i.push(a):o.push(a);(a=N(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=S+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t===C||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument===C||(T(o),n=!E);while(s=v[a++])if(s(o,t||C,n)){r.push(o);break}i&&(S=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=q.call(r));f=Te(f)}H.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&se.uniqueSort(r)}return i&&(S=h,w=p),c},m?le(r):r))).selector=e}return a},g=se.select=function(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&h(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&E&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(te,ne),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=G.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(te,ne),ee.test(o[0].type)&&ye(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&xe(o)))return H.apply(n,r),n;break}}}return(l||f(e,c))(r,t,!E,n,!t||ee.test(e)&&ye(t.parentNode)||t),n},d.sortStable=k.split("").sort(D).join("")===k,d.detectDuplicates=!!l,T(),d.sortDetached=ce(function(e){return 1&e.compareDocumentPosition(C.createElement("fieldset"))}),ce(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||fe("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),d.attributes&&ce(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||fe("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),ce(function(e){return null==e.getAttribute("disabled")})||fe(R,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),se}(C);k.find=h,k.expr=h.selectors,k.expr[":"]=k.expr.pseudos,k.uniqueSort=k.unique=h.uniqueSort,k.text=h.getText,k.isXMLDoc=h.isXML,k.contains=h.contains,k.escapeSelector=h.escape;var T=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&k(e).is(n))break;r.push(e)}return r},S=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},N=k.expr.match.needsContext;function A(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var D=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function j(e,n,r){return m(n)?k.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?k.grep(e,function(e){return e===n!==r}):"string"!=typeof n?k.grep(e,function(e){return-1<i.call(n,e)!==r}):k.filter(n,e,r)}k.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?k.find.matchesSelector(r,e)?[r]:[]:k.find.matches(e,k.grep(t,function(e){return 1===e.nodeType}))},k.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(k(e).filter(function(){for(t=0;t<r;t++)if(k.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)k.find(e,i[t],n);return 1<r?k.uniqueSort(n):n},filter:function(e){return this.pushStack(j(this,e||[],!1))},not:function(e){return this.pushStack(j(this,e||[],!0))},is:function(e){return!!j(this,"string"==typeof e&&N.test(e)?k(e):e||[],!1).length}});var q,L=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(k.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||q,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:L.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof k?t[0]:t,k.merge(this,k.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:E,!0)),D.test(r[1])&&k.isPlainObject(t))for(r in t)m(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=E.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):m(e)?void 0!==n.ready?n.ready(e):e(k):k.makeArray(e,this)}).prototype=k.fn,q=k(E);var H=/^(?:parents|prev(?:Until|All))/,O={children:!0,contents:!0,next:!0,prev:!0};function P(e,t){while((e=e[t])&&1!==e.nodeType);return e}k.fn.extend({has:function(e){var t=k(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(k.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&k(e);if(!N.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&k.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?k.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?i.call(k(e),this[0]):i.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(k.uniqueSort(k.merge(this.get(),k(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),k.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return T(e,"parentNode")},parentsUntil:function(e,t,n){return T(e,"parentNode",n)},next:function(e){return P(e,"nextSibling")},prev:function(e){return P(e,"previousSibling")},nextAll:function(e){return T(e,"nextSibling")},prevAll:function(e){return T(e,"previousSibling")},nextUntil:function(e,t,n){return T(e,"nextSibling",n)},prevUntil:function(e,t,n){return T(e,"previousSibling",n)},siblings:function(e){return S((e.parentNode||{}).firstChild,e)},children:function(e){return S(e.firstChild)},contents:function(e){return"undefined"!=typeof e.contentDocument?e.contentDocument:(A(e,"template")&&(e=e.content||e),k.merge([],e.childNodes))}},function(r,i){k.fn[r]=function(e,t){var n=k.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=k.filter(t,n)),1<this.length&&(O[r]||k.uniqueSort(n),H.test(r)&&n.reverse()),this.pushStack(n)}});var R=/[^\x20\t\r\n\f]+/g;function M(e){return e}function I(e){throw e}function W(e,t,n,r){var i;try{e&&m(i=e.promise)?i.call(e).done(t).fail(n):e&&m(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}k.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},k.each(e.match(R)||[],function(e,t){n[t]=!0}),n):k.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){k.each(e,function(e,t){m(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==w(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return k.each(arguments,function(e,t){var n;while(-1<(n=k.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<k.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},k.extend({Deferred:function(e){var o=[["notify","progress",k.Callbacks("memory"),k.Callbacks("memory"),2],["resolve","done",k.Callbacks("once memory"),k.Callbacks("once memory"),0,"resolved"],["reject","fail",k.Callbacks("once memory"),k.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return k.Deferred(function(r){k.each(o,function(e,t){var n=m(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&m(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,m(t)?s?t.call(e,l(u,o,M,s),l(u,o,I,s)):(u++,t.call(e,l(u,o,M,s),l(u,o,I,s),l(u,o,M,o.notifyWith))):(a!==M&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){k.Deferred.exceptionHook&&k.Deferred.exceptionHook(e,t.stackTrace),u<=i+1&&(a!==I&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(k.Deferred.getStackHook&&(t.stackTrace=k.Deferred.getStackHook()),C.setTimeout(t))}}return k.Deferred(function(e){o[0][3].add(l(0,e,m(r)?r:M,e.notifyWith)),o[1][3].add(l(0,e,m(t)?t:M)),o[2][3].add(l(0,e,m(n)?n:I))}).promise()},promise:function(e){return null!=e?k.extend(e,a):a}},s={};return k.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=s.call(arguments),o=k.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?s.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(W(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||m(i[t]&&i[t].then)))return o.then();while(t--)W(i[t],a(t),o.reject);return o.promise()}});var $=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;k.Deferred.exceptionHook=function(e,t){C.console&&C.console.warn&&e&&$.test(e.name)&&C.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},k.readyException=function(e){C.setTimeout(function(){throw e})};var F=k.Deferred();function B(){E.removeEventListener("DOMContentLoaded",B),C.removeEventListener("load",B),k.ready()}k.fn.ready=function(e){return F.then(e)["catch"](function(e){k.readyException(e)}),this},k.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--k.readyWait:k.isReady)||(k.isReady=!0)!==e&&0<--k.readyWait||F.resolveWith(E,[k])}}),k.ready.then=F.then,"complete"===E.readyState||"loading"!==E.readyState&&!E.documentElement.doScroll?C.setTimeout(k.ready):(E.addEventListener("DOMContentLoaded",B),C.addEventListener("load",B));var _=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===w(n))for(s in i=!0,n)_(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,m(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(k(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},z=/^-ms-/,U=/-([a-z])/g;function X(e,t){return t.toUpperCase()}function V(e){return e.replace(z,"ms-").replace(U,X)}var G=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function Y(){this.expando=k.expando+Y.uid++}Y.uid=1,Y.prototype={cache:function(e){var t=e[this.expando];return t||(t={},G(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[V(t)]=n;else for(r in t)i[V(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][V(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(V):(t=V(t))in r?[t]:t.match(R)||[]).length;while(n--)delete r[t[n]]}(void 0===t||k.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!k.isEmptyObject(t)}};var Q=new Y,J=new Y,K=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Z=/[A-Z]/g;function ee(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(Z,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:K.test(i)?JSON.parse(i):i)}catch(e){}J.set(e,t,n)}else n=void 0;return n}k.extend({hasData:function(e){return J.hasData(e)||Q.hasData(e)},data:function(e,t,n){return J.access(e,t,n)},removeData:function(e,t){J.remove(e,t)},_data:function(e,t,n){return Q.access(e,t,n)},_removeData:function(e,t){Q.remove(e,t)}}),k.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=J.get(o),1===o.nodeType&&!Q.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=V(r.slice(5)),ee(o,r,i[r]));Q.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){J.set(this,n)}):_(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=J.get(o,n))?t:void 0!==(t=ee(o,n))?t:void 0;this.each(function(){J.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){J.remove(this,e)})}}),k.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Q.get(e,t),n&&(!r||Array.isArray(n)?r=Q.access(e,t,k.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=k.queue(e,t),r=n.length,i=n.shift(),o=k._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){k.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Q.get(e,n)||Q.access(e,n,{empty:k.Callbacks("once memory").add(function(){Q.remove(e,[t+"queue",n])})})}}),k.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?k.queue(this[0],t):void 0===n?this:this.each(function(){var e=k.queue(this,t,n);k._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&k.dequeue(this,t)})},dequeue:function(e){return this.each(function(){k.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=k.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=Q.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var te=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ne=new RegExp("^(?:([+-])=|)("+te+")([a-z%]*)$","i"),re=["Top","Right","Bottom","Left"],ie=E.documentElement,oe=function(e){return k.contains(e.ownerDocument,e)},ae={composed:!0};ie.getRootNode&&(oe=function(e){return k.contains(e.ownerDocument,e)||e.getRootNode(ae)===e.ownerDocument});var se=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&oe(e)&&"none"===k.css(e,"display")},ue=function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in i=n.apply(e,r||[]),t)e.style[o]=a[o];return i};function le(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return k.css(e,t,"")},u=s(),l=n&&n[3]||(k.cssNumber[t]?"":"px"),c=e.nodeType&&(k.cssNumber[t]||"px"!==l&&+u)&&ne.exec(k.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)k.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,k.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ce={};function fe(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=Q.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&se(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ce[s])||(o=a.body.appendChild(a.createElement(s)),u=k.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ce[s]=u)))):"none"!==n&&(l[c]="none",Q.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}k.fn.extend({show:function(){return fe(this,!0)},hide:function(){return fe(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){se(this)?k(this).show():k(this).hide()})}});var pe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,he=/^$|^module$|\/(?:java|ecma)script/i,ge={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ve(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&A(e,t)?k.merge([e],n):n}function ye(e,t){for(var n=0,r=e.length;n<r;n++)Q.set(e[n],"globalEval",!t||Q.get(t[n],"globalEval"))}ge.optgroup=ge.option,ge.tbody=ge.tfoot=ge.colgroup=ge.caption=ge.thead,ge.th=ge.td;var me,xe,be=/<|&#?\w+;/;function we(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===w(o))k.merge(p,o.nodeType?[o]:o);else if(be.test(o)){a=a||f.appendChild(t.createElement("div")),s=(de.exec(o)||["",""])[1].toLowerCase(),u=ge[s]||ge._default,a.innerHTML=u[1]+k.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;k.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<k.inArray(o,r))i&&i.push(o);else if(l=oe(o),a=ve(f.appendChild(o),"script"),l&&ye(a),n){c=0;while(o=a[c++])he.test(o.type||"")&&n.push(o)}return f}me=E.createDocumentFragment().appendChild(E.createElement("div")),(xe=E.createElement("input")).setAttribute("type","radio"),xe.setAttribute("checked","checked"),xe.setAttribute("name","t"),me.appendChild(xe),y.checkClone=me.cloneNode(!0).cloneNode(!0).lastChild.checked,me.innerHTML="<textarea>x</textarea>",y.noCloneChecked=!!me.cloneNode(!0).lastChild.defaultValue;var Te=/^key/,Ce=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Ee=/^([^.]*)(?:\.(.+)|)/;function ke(){return!0}function Se(){return!1}function Ne(e,t){return e===function(){try{return E.activeElement}catch(e){}}()==("focus"===t)}function Ae(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Ae(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=Se;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return k().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=k.guid++)),e.each(function(){k.event.add(this,t,i,r,n)})}function De(e,i,o){o?(Q.set(e,i,!1),k.event.add(e,i,{namespace:!1,handler:function(e){var t,n,r=Q.get(this,i);if(1&e.isTrigger&&this[i]){if(r.length)(k.event.special[i]||{}).delegateType&&e.stopPropagation();else if(r=s.call(arguments),Q.set(this,i,r),t=o(this,i),this[i](),r!==(n=Q.get(this,i))||t?Q.set(this,i,!1):n={},r!==n)return e.stopImmediatePropagation(),e.preventDefault(),n.value}else r.length&&(Q.set(this,i,{value:k.event.trigger(k.extend(r[0],k.Event.prototype),r.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===Q.get(e,i)&&k.event.add(e,i,ke)}k.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.get(t);if(v){n.handler&&(n=(o=n).handler,i=o.selector),i&&k.find.matchesSelector(ie,i),n.guid||(n.guid=k.guid++),(u=v.events)||(u=v.events={}),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof k&&k.event.triggered!==e.type?k.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(R)||[""]).length;while(l--)d=g=(s=Ee.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=k.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=k.event.special[d]||{},c=k.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&k.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),k.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.hasData(e)&&Q.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(R)||[""]).length;while(l--)if(d=g=(s=Ee.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=k.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||k.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)k.event.remove(e,d+t[l],n,r,!0);k.isEmptyObject(u)&&Q.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=k.event.fix(e),u=new Array(arguments.length),l=(Q.get(this,"events")||{})[s.type]||[],c=k.event.special[s.type]||{};for(u[0]=s,t=1;t<arguments.length;t++)u[t]=arguments[t];if(s.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,s)){a=k.event.handlers.call(this,s,l),t=0;while((i=a[t++])&&!s.isPropagationStopped()){s.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!s.isImmediatePropagationStopped())s.rnamespace&&!1!==o.namespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(r=((k.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,u))&&!1===(s.result=r)&&(s.preventDefault(),s.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,s),s.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<k(i,this).index(l):k.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(k.Event.prototype,t,{enumerable:!0,configurable:!0,get:m(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[k.expando]?e:new k.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click",ke),!1},trigger:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click"),!0},_default:function(e){var t=e.target;return pe.test(t.type)&&t.click&&A(t,"input")&&Q.get(t,"click")||A(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},k.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},k.Event=function(e,t){if(!(this instanceof k.Event))return new k.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?ke:Se,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&k.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[k.expando]=!0},k.Event.prototype={constructor:k.Event,isDefaultPrevented:Se,isPropagationStopped:Se,isImmediatePropagationStopped:Se,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=ke,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=ke,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=ke,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},k.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&Te.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&Ce.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},k.event.addProp),k.each({focus:"focusin",blur:"focusout"},function(e,t){k.event.special[e]={setup:function(){return De(this,e,Ne),!1},trigger:function(){return De(this,e),!0},delegateType:t}}),k.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){k.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||k.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),k.fn.extend({on:function(e,t,n,r){return Ae(this,e,t,n,r)},one:function(e,t,n,r){return Ae(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,k(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=Se),this.each(function(){k.event.remove(this,e,n,t)})}});var je=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,qe=/<script|<style|<link/i,Le=/checked\s*(?:[^=]|=\s*.checked.)/i,He=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function Oe(e,t){return A(e,"table")&&A(11!==t.nodeType?t:t.firstChild,"tr")&&k(e).children("tbody")[0]||e}function Pe(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function Re(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Me(e,t){var n,r,i,o,a,s,u,l;if(1===t.nodeType){if(Q.hasData(e)&&(o=Q.access(e),a=Q.set(t,o),l=o.events))for(i in delete a.handle,a.events={},l)for(n=0,r=l[i].length;n<r;n++)k.event.add(t,i,l[i][n]);J.hasData(e)&&(s=J.access(e),u=k.extend({},s),J.set(t,u))}}function Ie(n,r,i,o){r=g.apply([],r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=m(d);if(h||1<f&&"string"==typeof d&&!y.checkClone&&Le.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),Ie(t,r,i,o)});if(f&&(t=(e=we(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=k.map(ve(e,"script"),Pe)).length;c<f;c++)u=e,c!==p&&(u=k.clone(u,!0,!0),s&&k.merge(a,ve(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,k.map(a,Re),c=0;c<s;c++)u=a[c],he.test(u.type||"")&&!Q.access(u,"globalEval")&&k.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?k._evalUrl&&!u.noModule&&k._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")}):b(u.textContent.replace(He,""),u,l))}return n}function We(e,t,n){for(var r,i=t?k.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||k.cleanData(ve(r)),r.parentNode&&(n&&oe(r)&&ye(ve(r,"script")),r.parentNode.removeChild(r));return e}k.extend({htmlPrefilter:function(e){return e.replace(je,"<$1></$2>")},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=oe(e);if(!(y.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||k.isXMLDoc(e)))for(a=ve(c),r=0,i=(o=ve(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&pe.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||ve(e),a=a||ve(c),r=0,i=o.length;r<i;r++)Me(o[r],a[r]);else Me(e,c);return 0<(a=ve(c,"script")).length&&ye(a,!f&&ve(e,"script")),c},cleanData:function(e){for(var t,n,r,i=k.event.special,o=0;void 0!==(n=e[o]);o++)if(G(n)){if(t=n[Q.expando]){if(t.events)for(r in t.events)i[r]?k.event.remove(n,r):k.removeEvent(n,r,t.handle);n[Q.expando]=void 0}n[J.expando]&&(n[J.expando]=void 0)}}}),k.fn.extend({detach:function(e){return We(this,e,!0)},remove:function(e){return We(this,e)},text:function(e){return _(this,function(e){return void 0===e?k.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return Ie(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Oe(this,e).appendChild(e)})},prepend:function(){return Ie(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Oe(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(k.cleanData(ve(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return k.clone(this,e,t)})},html:function(e){return _(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!qe.test(e)&&!ge[(de.exec(e)||["",""])[1].toLowerCase()]){e=k.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(k.cleanData(ve(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return Ie(this,arguments,function(e){var t=this.parentNode;k.inArray(this,n)<0&&(k.cleanData(ve(this)),t&&t.replaceChild(e,this))},n)}}),k.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){k.fn[e]=function(e){for(var t,n=[],r=k(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),k(r[o])[a](t),u.apply(n,t.get());return this.pushStack(n)}});var $e=new RegExp("^("+te+")(?!px)[a-z%]+$","i"),Fe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=C),t.getComputedStyle(e)},Be=new RegExp(re.join("|"),"i");function _e(e,t,n){var r,i,o,a,s=e.style;return(n=n||Fe(e))&&(""!==(a=n.getPropertyValue(t)||n[t])||oe(e)||(a=k.style(e,t)),!y.pixelBoxStyles()&&$e.test(a)&&Be.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function ze(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(u){s.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",u.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",ie.appendChild(s).appendChild(u);var e=C.getComputedStyle(u);n="1%"!==e.top,a=12===t(e.marginLeft),u.style.right="60%",o=36===t(e.right),r=36===t(e.width),u.style.position="absolute",i=12===t(u.offsetWidth/3),ie.removeChild(s),u=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s=E.createElement("div"),u=E.createElement("div");u.style&&(u.style.backgroundClip="content-box",u.cloneNode(!0).style.backgroundClip="",y.clearCloneStyle="content-box"===u.style.backgroundClip,k.extend(y,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),a},scrollboxSize:function(){return e(),i}}))}();var Ue=["Webkit","Moz","ms"],Xe=E.createElement("div").style,Ve={};function Ge(e){var t=k.cssProps[e]||Ve[e];return t||(e in Xe?e:Ve[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Ue.length;while(n--)if((e=Ue[n]+t)in Xe)return e}(e)||e)}var Ye=/^(none|table(?!-c[ea]).+)/,Qe=/^--/,Je={position:"absolute",visibility:"hidden",display:"block"},Ke={letterSpacing:"0",fontWeight:"400"};function Ze(e,t,n){var r=ne.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function et(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(u+=k.css(e,n+re[a],!0,i)),r?("content"===n&&(u-=k.css(e,"padding"+re[a],!0,i)),"margin"!==n&&(u-=k.css(e,"border"+re[a]+"Width",!0,i))):(u+=k.css(e,"padding"+re[a],!0,i),"padding"!==n?u+=k.css(e,"border"+re[a]+"Width",!0,i):s+=k.css(e,"border"+re[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u}function tt(e,t,n){var r=Fe(e),i=(!y.boxSizingReliable()||n)&&"border-box"===k.css(e,"boxSizing",!1,r),o=i,a=_e(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if($e.test(a)){if(!n)return a;a="auto"}return(!y.boxSizingReliable()&&i||"auto"===a||!parseFloat(a)&&"inline"===k.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===k.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+et(e,t,n||(i?"border":"content"),o,r,a)+"px"}function nt(e,t,n,r,i){return new nt.prototype.init(e,t,n,r,i)}k.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=_e(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=V(t),u=Qe.test(t),l=e.style;if(u||(t=Ge(s)),a=k.cssHooks[t]||k.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=ne.exec(n))&&i[1]&&(n=le(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(k.cssNumber[s]?"":"px")),y.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=V(t);return Qe.test(t)||(t=Ge(s)),(a=k.cssHooks[t]||k.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=_e(e,t,r)),"normal"===i&&t in Ke&&(i=Ke[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),k.each(["height","width"],function(e,u){k.cssHooks[u]={get:function(e,t,n){if(t)return!Ye.test(k.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?tt(e,u,n):ue(e,Je,function(){return tt(e,u,n)})},set:function(e,t,n){var r,i=Fe(e),o=!y.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===k.css(e,"boxSizing",!1,i),s=n?et(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-et(e,u,"border",!1,i)-.5)),s&&(r=ne.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=k.css(e,u)),Ze(0,t,s)}}}),k.cssHooks.marginLeft=ze(y.reliableMarginLeft,function(e,t){if(t)return(parseFloat(_e(e,"marginLeft"))||e.getBoundingClientRect().left-ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),k.each({margin:"",padding:"",border:"Width"},function(i,o){k.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+re[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(k.cssHooks[i+o].set=Ze)}),k.fn.extend({css:function(e,t){return _(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Fe(e),i=t.length;a<i;a++)o[t[a]]=k.css(e,t[a],!1,r);return o}return void 0!==n?k.style(e,t,n):k.css(e,t)},e,t,1<arguments.length)}}),((k.Tween=nt).prototype={constructor:nt,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||k.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(k.cssNumber[n]?"":"px")},cur:function(){var e=nt.propHooks[this.prop];return e&&e.get?e.get(this):nt.propHooks._default.get(this)},run:function(e){var t,n=nt.propHooks[this.prop];return this.options.duration?this.pos=t=k.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):nt.propHooks._default.set(this),this}}).init.prototype=nt.prototype,(nt.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=k.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){k.fx.step[e.prop]?k.fx.step[e.prop](e):1!==e.elem.nodeType||!k.cssHooks[e.prop]&&null==e.elem.style[Ge(e.prop)]?e.elem[e.prop]=e.now:k.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=nt.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},k.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},k.fx=nt.prototype.init,k.fx.step={};var rt,it,ot,at,st=/^(?:toggle|show|hide)$/,ut=/queueHooks$/;function lt(){it&&(!1===E.hidden&&C.requestAnimationFrame?C.requestAnimationFrame(lt):C.setTimeout(lt,k.fx.interval),k.fx.tick())}function ct(){return C.setTimeout(function(){rt=void 0}),rt=Date.now()}function ft(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=re[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function pt(e,t,n){for(var r,i=(dt.tweeners[t]||[]).concat(dt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function dt(o,e,t){var n,a,r=0,i=dt.prefilters.length,s=k.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=rt||ct(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:k.extend({},e),opts:k.extend(!0,{specialEasing:{},easing:k.easing._default},t),originalProperties:e,originalOptions:t,startTime:rt||ct(),duration:t.duration,tweens:[],createTween:function(e,t){var n=k.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=V(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=k.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=dt.prefilters[r].call(l,o,c,l.opts))return m(n.stop)&&(k._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return k.map(c,pt,l),m(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),k.fx.timer(k.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}k.Animation=k.extend(dt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return le(n.elem,e,ne.exec(t),n),n}]},tweener:function(e,t){m(e)?(t=e,e=["*"]):e=e.match(R);for(var n,r=0,i=e.length;r<i;r++)n=e[r],dt.tweeners[n]=dt.tweeners[n]||[],dt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&se(e),v=Q.get(e,"fxshow");for(r in n.queue||(null==(a=k._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,k.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],st.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||k.style(e,r)}if((u=!k.isEmptyObject(t))||!k.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=Q.get(e,"display")),"none"===(c=k.css(e,"display"))&&(l?c=l:(fe([e],!0),l=e.style.display||l,c=k.css(e,"display"),fe([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===k.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=Q.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&fe([e],!0),p.done(function(){for(r in g||fe([e]),Q.remove(e,"fxshow"),d)k.style(e,r,d[r])})),u=pt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?dt.prefilters.unshift(e):dt.prefilters.push(e)}}),k.speed=function(e,t,n){var r=e&&"object"==typeof e?k.extend({},e):{complete:n||!n&&t||m(e)&&e,duration:e,easing:n&&t||t&&!m(t)&&t};return k.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in k.fx.speeds?r.duration=k.fx.speeds[r.duration]:r.duration=k.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){m(r.old)&&r.old.call(this),r.queue&&k.dequeue(this,r.queue)},r},k.fn.extend({fadeTo:function(e,t,n,r){return this.filter(se).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=k.isEmptyObject(t),o=k.speed(e,n,r),a=function(){var e=dt(this,k.extend({},t),o);(i||Q.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&!1!==i&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=k.timers,r=Q.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&ut.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||k.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=Q.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=k.timers,o=n?n.length:0;for(t.finish=!0,k.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),k.each(["toggle","show","hide"],function(e,r){var i=k.fn[r];k.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(ft(r,!0),e,t,n)}}),k.each({slideDown:ft("show"),slideUp:ft("hide"),slideToggle:ft("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){k.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),k.timers=[],k.fx.tick=function(){var e,t=0,n=k.timers;for(rt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||k.fx.stop(),rt=void 0},k.fx.timer=function(e){k.timers.push(e),k.fx.start()},k.fx.interval=13,k.fx.start=function(){it||(it=!0,lt())},k.fx.stop=function(){it=null},k.fx.speeds={slow:600,fast:200,_default:400},k.fn.delay=function(r,e){return r=k.fx&&k.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=C.setTimeout(e,r);t.stop=function(){C.clearTimeout(n)}})},ot=E.createElement("input"),at=E.createElement("select").appendChild(E.createElement("option")),ot.type="checkbox",y.checkOn=""!==ot.value,y.optSelected=at.selected,(ot=E.createElement("input")).value="t",ot.type="radio",y.radioValue="t"===ot.value;var ht,gt=k.expr.attrHandle;k.fn.extend({attr:function(e,t){return _(this,k.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){k.removeAttr(this,e)})}}),k.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?k.prop(e,t,n):(1===o&&k.isXMLDoc(e)||(i=k.attrHooks[t.toLowerCase()]||(k.expr.match.bool.test(t)?ht:void 0)),void 0!==n?null===n?void k.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=k.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!y.radioValue&&"radio"===t&&A(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(R);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),ht={set:function(e,t,n){return!1===t?k.removeAttr(e,n):e.setAttribute(n,n),n}},k.each(k.expr.match.bool.source.match(/\w+/g),function(e,t){var a=gt[t]||k.find.attr;gt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=gt[o],gt[o]=r,r=null!=a(e,t,n)?o:null,gt[o]=i),r}});var vt=/^(?:input|select|textarea|button)$/i,yt=/^(?:a|area)$/i;function mt(e){return(e.match(R)||[]).join(" ")}function xt(e){return e.getAttribute&&e.getAttribute("class")||""}function bt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(R)||[]}k.fn.extend({prop:function(e,t){return _(this,k.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[k.propFix[e]||e]})}}),k.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&k.isXMLDoc(e)||(t=k.propFix[t]||t,i=k.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=k.find.attr(e,"tabindex");return t?parseInt(t,10):vt.test(e.nodeName)||yt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),y.optSelected||(k.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),k.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){k.propFix[this.toLowerCase()]=this}),k.fn.extend({addClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){k(this).addClass(t.call(this,e,xt(this)))});if((e=bt(t)).length)while(n=this[u++])if(i=xt(n),r=1===n.nodeType&&" "+mt(i)+" "){a=0;while(o=e[a++])r.indexOf(" "+o+" ")<0&&(r+=o+" ");i!==(s=mt(r))&&n.setAttribute("class",s)}return this},removeClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){k(this).removeClass(t.call(this,e,xt(this)))});if(!arguments.length)return this.attr("class","");if((e=bt(t)).length)while(n=this[u++])if(i=xt(n),r=1===n.nodeType&&" "+mt(i)+" "){a=0;while(o=e[a++])while(-1<r.indexOf(" "+o+" "))r=r.replace(" "+o+" "," ");i!==(s=mt(r))&&n.setAttribute("class",s)}return this},toggleClass:function(i,t){var o=typeof i,a="string"===o||Array.isArray(i);return"boolean"==typeof t&&a?t?this.addClass(i):this.removeClass(i):m(i)?this.each(function(e){k(this).toggleClass(i.call(this,e,xt(this),t),t)}):this.each(function(){var e,t,n,r;if(a){t=0,n=k(this),r=bt(i);while(e=r[t++])n.hasClass(e)?n.removeClass(e):n.addClass(e)}else void 0!==i&&"boolean"!==o||((e=xt(this))&&Q.set(this,"__className__",e),this.setAttribute&&this.setAttribute("class",e||!1===i?"":Q.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+mt(xt(n))+" ").indexOf(t))return!0;return!1}});var wt=/\r/g;k.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=m(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,k(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=k.map(t,function(e){return null==e?"":e+""})),(r=k.valHooks[this.type]||k.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=k.valHooks[t.type]||k.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(wt,""):null==e?"":e:void 0}}),k.extend({valHooks:{option:{get:function(e){var t=k.find.attr(e,"value");return null!=t?t:mt(k.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!A(n.parentNode,"optgroup"))){if(t=k(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=k.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<k.inArray(k.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),k.each(["radio","checkbox"],function(){k.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<k.inArray(k(e).val(),t)}},y.checkOn||(k.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),y.focusin="onfocusin"in C;var Tt=/^(?:focusinfocus|focusoutblur)$/,Ct=function(e){e.stopPropagation()};k.extend(k.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||E],d=v.call(e,"type")?e.type:e,h=v.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||E,3!==n.nodeType&&8!==n.nodeType&&!Tt.test(d+k.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[k.expando]?e:new k.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:k.makeArray(t,[e]),c=k.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!x(n)){for(s=c.delegateType||d,Tt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||E)&&p.push(a.defaultView||a.parentWindow||C)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(Q.get(o,"events")||{})[e.type]&&Q.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&G(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!G(n)||u&&m(n[d])&&!x(n)&&((a=n[u])&&(n[u]=null),k.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Ct),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Ct),k.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=k.extend(new k.Event,n,{type:e,isSimulated:!0});k.event.trigger(r,null,t)}}),k.fn.extend({trigger:function(e,t){return this.each(function(){k.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return k.event.trigger(e,t,n,!0)}}),y.focusin||k.each({focus:"focusin",blur:"focusout"},function(n,r){var i=function(e){k.event.simulate(r,e.target,k.event.fix(e))};k.event.special[r]={setup:function(){var e=this.ownerDocument||this,t=Q.access(e,r);t||e.addEventListener(n,i,!0),Q.access(e,r,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this,t=Q.access(e,r)-1;t?Q.access(e,r,t):(e.removeEventListener(n,i,!0),Q.remove(e,r))}}});var Et=C.location,kt=Date.now(),St=/\?/;k.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new C.DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return t&&!t.getElementsByTagName("parsererror").length||k.error("Invalid XML: "+e),t};var Nt=/\[\]$/,At=/\r?\n/g,Dt=/^(?:submit|button|image|reset|file)$/i,jt=/^(?:input|select|textarea|keygen)/i;function qt(n,e,r,i){var t;if(Array.isArray(e))k.each(e,function(e,t){r||Nt.test(n)?i(n,t):qt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==w(e))i(n,e);else for(t in e)qt(n+"["+t+"]",e[t],r,i)}k.param=function(e,t){var n,r=[],i=function(e,t){var n=m(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!k.isPlainObject(e))k.each(e,function(){i(this.name,this.value)});else for(n in e)qt(n,e[n],t,i);return r.join("&")},k.fn.extend({serialize:function(){return k.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=k.prop(this,"elements");return e?k.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!k(this).is(":disabled")&&jt.test(this.nodeName)&&!Dt.test(e)&&(this.checked||!pe.test(e))}).map(function(e,t){var n=k(this).val();return null==n?null:Array.isArray(n)?k.map(n,function(e){return{name:t.name,value:e.replace(At,"\r\n")}}):{name:t.name,value:n.replace(At,"\r\n")}}).get()}});var Lt=/%20/g,Ht=/#.*$/,Ot=/([?&])_=[^&]*/,Pt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Rt=/^(?:GET|HEAD)$/,Mt=/^\/\//,It={},Wt={},$t="*/".concat("*"),Ft=E.createElement("a");function Bt(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(R)||[];if(m(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function _t(t,i,o,a){var s={},u=t===Wt;function l(e){var r;return s[e]=!0,k.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function zt(e,t){var n,r,i=k.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&k.extend(!0,e,r),e}Ft.href=Et.href,k.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":$t,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":k.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?zt(zt(e,k.ajaxSettings),t):zt(k.ajaxSettings,e)},ajaxPrefilter:Bt(It),ajaxTransport:Bt(Wt),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=k.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?k(y):k.event,x=k.Deferred(),b=k.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Pt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace(Mt,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(R)||[""],null==v.crossDomain){r=E.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Ft.protocol+"//"+Ft.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=k.param(v.data,v.traditional)),_t(It,v,t,T),h)return T;for(i in(g=k.event&&v.global)&&0==k.active++&&k.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Rt.test(v.type),f=v.url.replace(Ht,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Lt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(St.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(Ot,"$1"),o=(St.test(f)?"&":"?")+"_="+kt+++o),v.url=f+o),v.ifModified&&(k.lastModified[f]&&T.setRequestHeader("If-Modified-Since",k.lastModified[f]),k.etag[f]&&T.setRequestHeader("If-None-Match",k.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+$t+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=_t(Wt,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=C.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&C.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(k.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(k.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--k.active||k.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return k.get(e,t,n,"json")},getScript:function(e,t){return k.get(e,void 0,t,"script")}}),k.each(["get","post"],function(e,i){k[i]=function(e,t,n,r){return m(t)&&(r=r||n,n=t,t=void 0),k.ajax(k.extend({url:e,type:i,dataType:r,data:t,success:n},k.isPlainObject(e)&&e))}}),k._evalUrl=function(e,t){return k.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){k.globalEval(e,t)}})},k.fn.extend({wrapAll:function(e){var t;return this[0]&&(m(e)&&(e=e.call(this[0])),t=k(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return m(n)?this.each(function(e){k(this).wrapInner(n.call(this,e))}):this.each(function(){var e=k(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=m(t);return this.each(function(e){k(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){k(this).replaceWith(this.childNodes)}),this}}),k.expr.pseudos.hidden=function(e){return!k.expr.pseudos.visible(e)},k.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},k.ajaxSettings.xhr=function(){try{return new C.XMLHttpRequest}catch(e){}};var Ut={0:200,1223:204},Xt=k.ajaxSettings.xhr();y.cors=!!Xt&&"withCredentials"in Xt,y.ajax=Xt=!!Xt,k.ajaxTransport(function(i){var o,a;if(y.cors||Xt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Ut[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&C.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),k.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),k.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return k.globalEval(e),e}}}),k.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),k.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=k("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),E.head.appendChild(r[0])},abort:function(){i&&i()}}});var Vt,Gt=[],Yt=/(=)\?(?=&|$)|\?\?/;k.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Gt.pop()||k.expando+"_"+kt++;return this[e]=!0,e}}),k.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Yt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Yt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=m(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Yt,"$1"+r):!1!==e.jsonp&&(e.url+=(St.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||k.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=C[r],C[r]=function(){o=arguments},n.always(function(){void 0===i?k(C).removeProp(r):C[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Gt.push(r)),o&&m(i)&&i(o[0]),o=i=void 0}),"script"}),y.createHTMLDocument=((Vt=E.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Vt.childNodes.length),k.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(y.createHTMLDocument?((r=(t=E.implementation.createHTMLDocument("")).createElement("base")).href=E.location.href,t.head.appendChild(r)):t=E),o=!n&&[],(i=D.exec(e))?[t.createElement(i[1])]:(i=we([e],t,o),o&&o.length&&k(o).remove(),k.merge([],i.childNodes)));var r,i,o},k.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=mt(e.slice(s)),e=e.slice(0,s)),m(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&k.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?k("<div>").append(k.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},k.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){k.fn[t]=function(e){return this.on(t,e)}}),k.expr.pseudos.animated=function(t){return k.grep(k.timers,function(e){return t===e.elem}).length},k.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=k.css(e,"position"),c=k(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=k.css(e,"top"),u=k.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),m(t)&&(t=t.call(e,n,k.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},k.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){k.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===k.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===k.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=k(e).offset()).top+=k.css(e,"borderTopWidth",!0),i.left+=k.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-k.css(r,"marginTop",!0),left:t.left-i.left-k.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===k.css(e,"position"))e=e.offsetParent;return e||ie})}}),k.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;k.fn[t]=function(e){return _(this,function(e,t,n){var r;if(x(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),k.each(["top","left"],function(e,n){k.cssHooks[n]=ze(y.pixelPosition,function(e,t){if(t)return t=_e(e,n),$e.test(t)?k(e).position()[n]+"px":t})}),k.each({Height:"height",Width:"width"},function(a,s){k.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){k.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return _(this,function(e,t,n){var r;return x(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?k.css(e,t,i):k.style(e,t,n,i)},s,n?e:void 0,n)}})}),k.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){k.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}}),k.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),k.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),k.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),m(e))return r=s.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(s.call(arguments)))}).guid=e.guid=e.guid||k.guid++,i},k.holdReady=function(e){e?k.readyWait++:k.ready(!0)},k.isArray=Array.isArray,k.parseJSON=JSON.parse,k.nodeName=A,k.isFunction=m,k.isWindow=x,k.camelCase=V,k.type=w,k.now=Date.now,k.isNumeric=function(e){var t=k.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},"function"==typeof define&&define.amd&&define("jquery",[],function(){return k});var Qt=C.jQuery,Jt=C.$;return k.noConflict=function(e){return C.$===k&&(C.$=Jt),e&&C.jQuery===k&&(C.jQuery=Qt),k},e||(C.jQuery=C.$=k),k});
/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);
/*!
 * imagesLoaded PACKAGED v4.1.0
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */
!function(t,e){"function"==typeof define&&define.amd?define("ev-emitter/ev-emitter",e):"object"==typeof module&&module.exports?module.exports=e():t.EvEmitter=e()}(this,function(){function t(){}var e=t.prototype;return e.on=function(t,e){if(t&&e){var i=this._events=this._events||{},n=i[t]=i[t]||[];return-1==n.indexOf(e)&&n.push(e),this}},e.once=function(t,e){if(t&&e){this.on(t,e);var i=this._onceEvents=this._onceEvents||{},n=i[t]=i[t]||[];return n[e]=!0,this}},e.off=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){var n=i.indexOf(e);return-1!=n&&i.splice(n,1),this}},e.emitEvent=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){var n=0,o=i[n];e=e||[];for(var r=this._onceEvents&&this._onceEvents[t];o;){var s=r&&r[o];s&&(this.off(t,o),delete r[o]),o.apply(this,e),n+=s?0:1,o=i[n]}return this}},t}),function(t,e){"use strict";"function"==typeof define&&define.amd?define(["ev-emitter/ev-emitter"],function(i){return e(t,i)}):"object"==typeof module&&module.exports?module.exports=e(t,require("ev-emitter")):t.imagesLoaded=e(t,t.EvEmitter)}(window,function(t,e){function i(t,e){for(var i in e)t[i]=e[i];return t}function n(t){var e=[];if(Array.isArray(t))e=t;else if("number"==typeof t.length)for(var i=0;i<t.length;i++)e.push(t[i]);else e.push(t);return e}function o(t,e,r){return this instanceof o?("string"==typeof t&&(t=document.querySelectorAll(t)),this.elements=n(t),this.options=i({},this.options),"function"==typeof e?r=e:i(this.options,e),r&&this.on("always",r),this.getImages(),h&&(this.jqDeferred=new h.Deferred),void setTimeout(function(){this.check()}.bind(this))):new o(t,e,r)}function r(t){this.img=t}function s(t,e){this.url=t,this.element=e,this.img=new Image}var h=t.jQuery,a=t.console;o.prototype=Object.create(e.prototype),o.prototype.options={},o.prototype.getImages=function(){this.images=[],this.elements.forEach(this.addElementImages,this)},o.prototype.addElementImages=function(t){"IMG"==t.nodeName&&this.addImage(t),this.options.background===!0&&this.addElementBackgroundImages(t);var e=t.nodeType;if(e&&d[e]){for(var i=t.querySelectorAll("img"),n=0;n<i.length;n++){var o=i[n];this.addImage(o)}if("string"==typeof this.options.background){var r=t.querySelectorAll(this.options.background);for(n=0;n<r.length;n++){var s=r[n];this.addElementBackgroundImages(s)}}}};var d={1:!0,9:!0,11:!0};return o.prototype.addElementBackgroundImages=function(t){var e=getComputedStyle(t);if(e)for(var i=/url\((['"])?(.*?)\1\)/gi,n=i.exec(e.backgroundImage);null!==n;){var o=n&&n[2];o&&this.addBackground(o,t),n=i.exec(e.backgroundImage)}},o.prototype.addImage=function(t){var e=new r(t);this.images.push(e)},o.prototype.addBackground=function(t,e){var i=new s(t,e);this.images.push(i)},o.prototype.check=function(){function t(t,i,n){setTimeout(function(){e.progress(t,i,n)})}var e=this;return this.progressedCount=0,this.hasAnyBroken=!1,this.images.length?void this.images.forEach(function(e){e.once("progress",t),e.check()}):void this.complete()},o.prototype.progress=function(t,e,i){this.progressedCount++,this.hasAnyBroken=this.hasAnyBroken||!t.isLoaded,this.emitEvent("progress",[this,t,e]),this.jqDeferred&&this.jqDeferred.notify&&this.jqDeferred.notify(this,t),this.progressedCount==this.images.length&&this.complete(),this.options.debug&&a&&a.log("progress: "+i,t,e)},o.prototype.complete=function(){var t=this.hasAnyBroken?"fail":"done";if(this.isComplete=!0,this.emitEvent(t,[this]),this.emitEvent("always",[this]),this.jqDeferred){var e=this.hasAnyBroken?"reject":"resolve";this.jqDeferred[e](this)}},r.prototype=Object.create(e.prototype),r.prototype.check=function(){var t=this.getIsImageComplete();return t?void this.confirm(0!==this.img.naturalWidth,"naturalWidth"):(this.proxyImage=new Image,this.proxyImage.addEventListener("load",this),this.proxyImage.addEventListener("error",this),this.img.addEventListener("load",this),this.img.addEventListener("error",this),void(this.proxyImage.src=this.img.src))},r.prototype.getIsImageComplete=function(){return this.img.complete&&void 0!==this.img.naturalWidth},r.prototype.confirm=function(t,e){this.isLoaded=t,this.emitEvent("progress",[this,this.img,e])},r.prototype.handleEvent=function(t){var e="on"+t.type;this[e]&&this[e](t)},r.prototype.onload=function(){this.confirm(!0,"onload"),this.unbindEvents()},r.prototype.onerror=function(){this.confirm(!1,"onerror"),this.unbindEvents()},r.prototype.unbindEvents=function(){this.proxyImage.removeEventListener("load",this),this.proxyImage.removeEventListener("error",this),this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype=Object.create(r.prototype),s.prototype.check=function(){this.img.addEventListener("load",this),this.img.addEventListener("error",this),this.img.src=this.url;var t=this.getIsImageComplete();t&&(this.confirm(0!==this.img.naturalWidth,"naturalWidth"),this.unbindEvents())},s.prototype.unbindEvents=function(){this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype.confirm=function(t,e){this.isLoaded=t,this.emitEvent("progress",[this,this.element,e])},o.makeJQueryPlugin=function(e){e=e||t.jQuery,e&&(h=e,h.fn.imagesLoaded=function(t,e){var i=new o(this,t,e);return i.jqDeferred.promise(h(this))})},o.makeJQueryPlugin(),o});
/*! lz-string-1.3.3-min.js | (c) 2013 Pieroxy | Licensed under a WTFPL license */
var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(e){if(e==null)return"";var t="";var n,r,i,s,o,u,a;var f=0;e=LZString.compress(e);while(f<e.length*2){if(f%2==0){n=e.charCodeAt(f/2)>>8;r=e.charCodeAt(f/2)&255;if(f/2+1<e.length)i=e.charCodeAt(f/2+1)>>8;else i=NaN}else{n=e.charCodeAt((f-1)/2)&255;if((f+1)/2<e.length){r=e.charCodeAt((f+1)/2)>>8;i=e.charCodeAt((f+1)/2)&255}else r=i=NaN}f+=3;s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+LZString._keyStr.charAt(s)+LZString._keyStr.charAt(o)+LZString._keyStr.charAt(u)+LZString._keyStr.charAt(a)}return t},decompressFromBase64:function(e){if(e==null)return"";var t="",n=0,r,i,s,o,u,a,f,l,c=0,h=LZString._f;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(c<e.length){u=LZString._keyStr.indexOf(e.charAt(c++));a=LZString._keyStr.indexOf(e.charAt(c++));f=LZString._keyStr.indexOf(e.charAt(c++));l=LZString._keyStr.indexOf(e.charAt(c++));i=u<<2|a>>4;s=(a&15)<<4|f>>2;o=(f&3)<<6|l;if(n%2==0){r=i<<8;if(f!=64){t+=h(r|s)}if(l!=64){r=o<<8}}else{t=t+h(r|i);if(f!=64){r=s<<8}if(l!=64){t+=h(r|o)}}n+=3}return LZString.decompress(t)},compressToUTF16:function(e){if(e==null)return"";var t="",n,r,i,s=0,o=LZString._f;e=LZString.compress(e);for(n=0;n<e.length;n++){r=e.charCodeAt(n);switch(s++){case 0:t+=o((r>>1)+32);i=(r&1)<<14;break;case 1:t+=o(i+(r>>2)+32);i=(r&3)<<13;break;case 2:t+=o(i+(r>>3)+32);i=(r&7)<<12;break;case 3:t+=o(i+(r>>4)+32);i=(r&15)<<11;break;case 4:t+=o(i+(r>>5)+32);i=(r&31)<<10;break;case 5:t+=o(i+(r>>6)+32);i=(r&63)<<9;break;case 6:t+=o(i+(r>>7)+32);i=(r&127)<<8;break;case 7:t+=o(i+(r>>8)+32);i=(r&255)<<7;break;case 8:t+=o(i+(r>>9)+32);i=(r&511)<<6;break;case 9:t+=o(i+(r>>10)+32);i=(r&1023)<<5;break;case 10:t+=o(i+(r>>11)+32);i=(r&2047)<<4;break;case 11:t+=o(i+(r>>12)+32);i=(r&4095)<<3;break;case 12:t+=o(i+(r>>13)+32);i=(r&8191)<<2;break;case 13:t+=o(i+(r>>14)+32);i=(r&16383)<<1;break;case 14:t+=o(i+(r>>15)+32,(r&32767)+32);s=0;break}}return t+o(i+32)},decompressFromUTF16:function(e){if(e==null)return"";var t="",n,r,i=0,s=0,o=LZString._f;while(s<e.length){r=e.charCodeAt(s)-32;switch(i++){case 0:n=r<<1;break;case 1:t+=o(n|r>>14);n=(r&16383)<<2;break;case 2:t+=o(n|r>>13);n=(r&8191)<<3;break;case 3:t+=o(n|r>>12);n=(r&4095)<<4;break;case 4:t+=o(n|r>>11);n=(r&2047)<<5;break;case 5:t+=o(n|r>>10);n=(r&1023)<<6;break;case 6:t+=o(n|r>>9);n=(r&511)<<7;break;case 7:t+=o(n|r>>8);n=(r&255)<<8;break;case 8:t+=o(n|r>>7);n=(r&127)<<9;break;case 9:t+=o(n|r>>6);n=(r&63)<<10;break;case 10:t+=o(n|r>>5);n=(r&31)<<11;break;case 11:t+=o(n|r>>4);n=(r&15)<<12;break;case 12:t+=o(n|r>>3);n=(r&7)<<13;break;case 13:t+=o(n|r>>2);n=(r&3)<<14;break;case 14:t+=o(n|r>>1);n=(r&1)<<15;break;case 15:t+=o(n|r);i=0;break}s++}return LZString.decompress(t)},compress:function(e){if(e==null)return"";var t,n,r={},i={},s="",o="",u="",a=2,f=3,l=2,c="",h=0,p=0,d,v=LZString._f;for(d=0;d<e.length;d+=1){s=e.charAt(d);if(!Object.prototype.hasOwnProperty.call(r,s)){r[s]=f++;i[s]=true}o=u+s;if(Object.prototype.hasOwnProperty.call(r,o)){u=o}else{if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}r[o]=f++;u=String(s)}}if(u!==""){if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}}n=2;for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}while(true){h=h<<1;if(p==15){c+=v(h);break}else p++}return c},decompress:function(e){if(e==null)return"";if(e=="")return null;var t=[],n,r=4,i=4,s=3,o="",u="",a,f,l,c,h,p,d,v=LZString._f,m={string:e,val:e.charCodeAt(0),position:32768,index:1};for(a=0;a<3;a+=1){t[a]=a}l=0;h=Math.pow(2,2);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(n=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 2:return""}t[3]=d;f=u=d;while(true){if(m.index>m.string.length){return""}l=0;h=Math.pow(2,s);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(d=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 2:return u}if(r==0){r=Math.pow(2,s);s++}if(t[d]){o=t[d]}else{if(d===i){o=f+f.charAt(0)}else{return null}}u+=o;t[i++]=f+o.charAt(0);r--;f=o;if(r==0){r=Math.pow(2,s);s++}}}};if(typeof module!=="undefined"&&module!=null){module.exports=LZString}
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(e){"use strict";var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s="download"in i,o=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",true,false,e,0,0,0,0,0,false,false,false,false,0,null);n.dispatchEvent(r)},u=e.webkitRequestFileSystem,a=e.requestFileSystem||u||e.mozRequestFileSystem,f=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",c=0,h=[],p=function(){var e=h.length;while(e--){var t=h[e];if(typeof t==="string"){r.revokeObjectURL(t)}else{t.remove()}}h.length=0},d=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i==="function"){try{i.call(e,n||e)}catch(s){f(s)}}}},v=function(t,r){var f=this,p=t.type,v=false,m,g,y=function(){var e=n().createObjectURL(t);h.push(e);return e},b=function(){d(f,"writestart progress write writeend".split(" "))},w=function(){if(v||!m){m=y(t)}if(g){g.location.href=m}else{window.open(m,"_blank")}f.readyState=f.DONE;b()},E=function(e){return function(){if(f.readyState!==f.DONE){return e.apply(this,arguments)}}},S={create:true,exclusive:false},x;f.readyState=f.INIT;if(!r){r="download"}if(s){m=y(t);i.href=m;i.download=r;o(i);f.readyState=f.DONE;b();return}if(e.chrome&&p&&p!==l){x=t.slice||t.webkitSlice;t=x.call(t,0,t.size,l);v=true}if(u&&r!=="download"){r+=".download"}if(p===l||u){g=e}if(!a){w();return}c+=t.size;a(e.TEMPORARY,c,E(function(e){e.root.getDirectory("saved",S,E(function(e){var n=function(){e.getFile(r,S,E(function(e){e.createWriter(E(function(n){n.onwriteend=function(t){g.location.href=e.toURL();h.push(e);f.readyState=f.DONE;d(f,"writeend",t)};n.onerror=function(){var e=n.error;if(e.code!==e.ABORT_ERR){w()}};"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=f["on"+e]});n.write(t);f.abort=function(){n.abort();f.readyState=f.DONE};f.readyState=f.WRITING}),w)}),w)};e.getFile(r,{create:false},E(function(e){e.remove();n()}),E(function(e){if(e.code===e.NOT_FOUND_ERR){n()}else{w()}}))}),w)}),w)},m=v.prototype,g=function(e,t){return new v(e,t)};m.abort=function(){var e=this;e.readyState=e.DONE;d(e,"abort")};m.readyState=m.INIT=0;m.WRITING=1;m.DONE=2;m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null;e.addEventListener("unload",p,false);return g}(self)
/*! seedrandom.js v2.3.3 | (c) 2013 David Bau, all rights reserved. | Licensed under a BSD-style license */
!function(a,b,c,d,e,f,g,h,i){function j(a){var b,c=a.length,e=this,f=0,g=e.i=e.j=0,h=e.S=[];for(c||(a=[c++]);d>f;)h[f]=f++;for(f=0;d>f;f++)h[f]=h[g=r&g+a[f%c]+(b=h[f])],h[g]=b;(e.g=function(a){for(var b,c=0,f=e.i,g=e.j,h=e.S;a--;)b=h[f=r&f+1],c=c*d+h[r&(h[f]=h[g=r&g+b])+(h[g]=b)];return e.i=f,e.j=g,c})(d)}function k(a,b){var c,d=[],e=typeof a;if(b&&"object"==e)for(c in a)try{d.push(k(a[c],b-1))}catch(f){}return d.length?d:"string"==e?a:a+"\0"}function l(a,b){for(var c,d=a+"",e=0;e<d.length;)b[r&e]=r&(c^=19*b[r&e])+d.charCodeAt(e++);return n(b)}function m(c){try{return a.crypto.getRandomValues(c=new Uint8Array(d)),n(c)}catch(e){return[+new Date,a,(c=a.navigator)&&c.plugins,a.screen,n(b)]}}function n(a){return String.fromCharCode.apply(0,a)}var o=c.pow(d,e),p=c.pow(2,f),q=2*p,r=d-1,s=c["seed"+i]=function(a,f,g){var h=[],r=l(k(f?[a,n(b)]:null==a?m():a,3),h),s=new j(h);return l(n(s.S),b),(g||function(a,b,d){return d?(c[i]=a,b):a})(function(){for(var a=s.g(e),b=o,c=0;p>a;)a=(a+c)*d,b*=d,c=s.g(1);for(;a>=q;)a/=2,b/=2,c>>>=1;return(a+c)/b},r,this==c)};l(c[i](),b),g&&g.exports?g.exports=s:h&&h.amd&&h(function(){return s})}(this,[],Math,256,6,52,"object"==typeof module&&module,"function"==typeof define&&define,"random");
/*! console_hack.js | (c) 2015 Thomas Michael Edwards | Licensed under SugarCube's Simple BSD license */
!function(){for(var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"],length=methods.length,noop=function(){},console=window.console=window.console||{};length--;){var method=methods[length];console[method]||(console[method]=noop)}}();
}else{document.documentElement.setAttribute("data-init", "lacking");}
</script>
<style id="style-normalize" type="text/css">/*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}</style>
<style id="style-init-screen" type="text/css">@-webkit-keyframes init-loading-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes init-loading-spin{0%{-o-transform:rotate(0);transform:rotate(0)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes init-loading-spin{0%{-webkit-transform:rotate(0);-o-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}#init-screen{display:none;z-index:100000;position:fixed;top:0;left:0;height:100%;width:100%;font:28px/1 Helmet,Freesans,sans-serif;font-weight:700;color:#eee;background-color:#111;text-align:center}#init-screen>div{display:none;position:relative;margin:0 auto;max-width:1136px;top:25%}html[data-init=lacking] #init-screen,html[data-init=loading] #init-screen,html[data-init=no-js] #init-screen{display:block}html[data-init=lacking] #init-lacking,html[data-init=no-js] #init-no-js{display:block;padding:0 1em}html[data-init=no-js] #init-no-js{color:red}html[data-init=loading] #init-loading{display:block;border:24px solid transparent;border-radius:50%;border-top-color:#7f7f7f;border-bottom-color:#7f7f7f;width:100px;height:100px;-webkit-animation:init-loading-spin 2s linear infinite;-o-animation:init-loading-spin 2s linear infinite;animation:init-loading-spin 2s linear infinite}html[data-init=loading] #init-loading>div{text-indent:9999em;overflow:hidden;white-space:nowrap}html[data-init=loading] #passages,html[data-init=loading] #ui-bar{display:none}</style>
<style id="style-font" type="text/css">@font-face{font-family:tme-fa-icons;src:url(data:application/octet-stream;base64,d09GRgABAAAAACWoAA4AAAAAQhQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAABRAAAAEQAAABWPihI/2NtYXAAAAGIAAAAOgAAAUrQXRm3Y3Z0IAAAAcQAAAAKAAAACgAAAABmcGdtAAAB0AAABZQAAAtwiJCQWWdhc3AAAAdkAAAACAAAAAgAAAAQZ2x5ZgAAB2wAABjCAAAq+uJ4WNtoZWFkAAAgMAAAADQAAAA2BZlJs2hoZWEAACBkAAAAIAAAACQIJwQZaG10eAAAIIQAAABuAAABOPTeAABsb2NhAAAg9AAAAJ4AAACeojKW6m1heHAAACGUAAAAIAAAACAA6gvwbmFtZQAAIbQAAAGPAAAC/eLsyKlwb3N0AAAjRAAAAfwAAAM0412SIHByZXAAACVAAAAAZQAAAHvdawOFeJxjYGRWYZzAwMrAwVTFtIeBgaEHQjM+YDBkZGJgYGJgZWbACgLSXFMYHF4wvPBhDvqfxRDFHMQwDSjMCJIDANLeC6V4nGNgYGBmgGAZBkYGEHAB8hjBfBYGDSDNBqQZGZgYGF74/P8PUvCCAURLMELVAwEjG8OIBwC4Ywb6AAAAAAAAAAAAAAAAAAB4nK1WaXMTRxCd1WHLNj6CDxI2gVnGcox2VpjLCBDG7EoW4BzylexCjl1Ldu6LT/wG/ZpekVSRb/y0vB4d2GAnVVQoSv2m9+1M9+ueXpPQksReWI+k3HwpprY2aWTnSUg3bFqO4kPZ2QspU0z+LoiCaLXUvu04JCISgap1hSWC2PfI0iTjQ48yWrYlvWpSbulJd9kaD+qt+vbT0FGO3QklNZuhQ+uRLanCqBJFMu2RkjYtw9VfSVrh5yvMfNUMJYLoJJLGm2EMj+Rn44xWGa3GdhxFkU2WG0WKRDM8iCKPslpin1wxQUD5oBlSXvk0onyEH5EVe5TTCnHJdprf9yU/6R3OvyTieouyJQf+QHZkB3unK/ki0toK46adbEehivB0fSfEI5uT6p/sUV7TaOB2RaYnzQiWyleQWPkJZfYPyWrhfMqXPBrVkoOcCFovc2Jf8g60HkdMiWsmyILujk6IoO6XnKHYY/q4+OO9XSwXIQTIOJb1jkq4EEYpYbOaJG0EOYiSskWV1HpHTJzyOi3iLWG/Tu3oS2e0Sag7MZ6th46tnKjkeDSp00ymTu2k5tGUBlFKOhM85tcBlB/RJK+2sZrEyqNpbDNjJJFQoIVzaSqIZSeWNAXRPJrRm7thmmvXokWaPFDPPXpPb26Fmzs9p+3AP2v8Z3UqpoO9MJ2eDshKfJp2uUnRun56hn8m8UPWAiqRLTbDlMVDtn4H5eVjS47CawNs957zK+h99kTIpIH4G/AeL9UpBUyFmFVQC9201rUsy9RqVotUZOq7IU0rX9ZpAk05Dn1jX8Y4/q+ZGUtMCd/vxOnZEZeeufYlyDSH3GZdj+Z1arFdgM5sz+k0y/Z9nebYfqDTPNvzOh1ha+t0lO2HOi2w/UinY2wvaEGT7jsEchGBXMAGEoGwdRAI20sIhK1CIGwXEQjbIgJhu4RA2H6MQNguIxC2l7Wsmn4qaRw7E8sARYgDoznuyGVuKldTyaUSrotGpzbkKXKrpKJ4Vv0rA/3ikTesgbVAukTW/IpJrnxUleOPrmh508S5Ao5Vf3tzXJ8TD2W/WPhT8L/amqqkV6x5ZHIVeSPQk+NE1yYVj67p8rmqR9f/i4oOa4F+A6UQC0VZlg2+mZDwUafTUA1c5RAzGzMP1/W6Zc3P4fybGCEL6H78NxQaC9yDTllJWe1gr9XXj2W5twflsCdYkmK+zOtb4YuMzEr7RWYpez7yecAVMCqVYasNXK3gzXsS85DpTfJMELcVZYOkjceZILGBYx4wb76TICRMXbWB2imcsIG8YMwp2O+EQ1RvlOVwe6F9Ho2Uf2tX7MgZFU0Q+G32Rtjrs1DyW6yBhCe/1NdAVSFNxbipgEsj5YZq8GFcrdtGMk6gr6jYDcuyig8fR9x3So5lIPlIEatHRz+tvUKd1Ln9yihu3zv9CIJBaWL+9r6Z4qCUd7WSZVZtA1O3GpVT15rDxasO3c2j7nvH2Sdy1jTddE/c9L6mVbeDg7lZEO3bHJSlTC6o68MOG6jLzaXQ6mVckt52DzAsMKDfoRUb/1f3cfg8V6oKo+NIvZ2oH6PPYgzyDzh/R/UF6OcxTLmGlOd7lxOfbtzD2TJdxV2sn+LfwKy15mbpGnBD0w2Yh6xaHbrKDXynBjo90tyO9BDwse4K8QBgE8Bi8InuWsbzKYDxfMYcH+Bz5jBoMofBFnMYbDNnDWCHOQx2mcNgjzkMvmDOOsCXzGEQModBxBwGT5gTADxlDoOvmMPga+Yw+IY59wG+ZQ6DmDkMEuYw2Nd0ayhzixd0F6htUBXowPQTFvewONRUGbK/44Vhf28Qs38wiKk/aro9pP7EC0P92SCm/mIQU3/VdGdI/Y0Xhvq7QUz9wyCmPtMvxnKZwV9GvkuFA8ouNp/z98T7B8IaQLYAAQAB//8AD3icrToNcBzVefe9/b3dvd29u909/dyd7ke6k86yLEunOyHJsrCxJWyJGmEcLMDYxBhHNsZQBzOAkjQmFDrGIq5gHEIcCILOAGZq3IQO04RkIGkgaUMKMbQznSlJW0wgJtOQHxRr1e+93TvJwq7JTD3y2/f//bzvfX/vAhAIzL3KPcYNBFIB8UR9EJYuAcuAqGNbOiwDSczkuorlaJ6WTeVSRwMIDveY8aN20GztjzMhW4P2H+kNUPM5NaVNQE0K3tWM77vv8rJqgnT33VJE4WWIfd/QbKHZjcXcZiFAqjCDgUJA/mZTWOIIwi0vAwNiUjkW9THIZs6DAbnj6ffGP/P+0y2vv+5SXGLKuXHJPJH92c+yT7x3883wnI9W/DxI4T9+bm7uOL+MUwNywAg0BJYFQgNKa2NDzFBEjqeM0SFXLHU4YKe7yjFoSmdEKWw5nemOUj5czMXCliilM7lyuFgqp3HaDf1j/fhH+s6cfm4MEpA8c0BSQBO5CUkD5fJi05kDjSUoNnETTUUSXtpPVm0aGHDdmV0nNkPiMUWeHZMVRSZPSlp0dqypCKVG8iT9IK5AEeamyZGAjecW5tm5SSBm8ojiSqBsYoXDTRtuymw13V8axjB+p2EPlsMGcRzTTRkGOLRpmk/AzSZ+A97ecx+QN8g9gUbc26F7N+GJiN5pLGMA8hUo7EQcHI455A0PwrS3I37N+bZhTE8bex1aeeIJ4+MTjTY6gcH+iIvgGWQRdh2TR9sS81kspCzytguLfBcyuBOLXuhwYnZnh8NFUs6plLPLScGpWBKwkYztwsop7Hie9r7rYK/9brWXTg9U+RiBX+GJiyc0rgIv7UNJe3vPjrFdyZOV/byNUkyW/0AuIi/h+h6U5a64SmW5ieGcya2AYimG+EUtnZN08ImgveV+KOYykiiJVMrbkI+dHUkC9+nyPUFdD94j639r1uTq7FiSNrR1hXS8uLbGapYUSbpaJvzmp5aODbU9iJNBU1gJa5LFTCqihNpDigmWWtc2GjUy7Y2m3hHk14qmPJXp2cTInZudO85dhzw2AuXAJQHl+Yt7l0RVjkO8u4q5JZARE2A5yNxStNgGWcQSj7izA1HucCgJOsRsb7xYWgn9XAwvRqaN4HAS4ENF3kXFFovJ/muW3zsYDK3jxaCQbOouOPXZPmBDNZG4krS0N2/9wakf7hHv+IcPX/jcaGWZAp9fvrFtv66UeSlXn4zYdZo5kLNwIJJRTbEu3jz62Zf37Xv5l7RAeugZfAQ7kJ5koA3PoJB1eP8MpHRVWqpygyITpiKz4DCoHMENlun+wrDA0bNZ9jmJZdZwhhx9UnewMKztg2yAlie9j6O7Lzrks7tYdRdOO4u/FJ9e5G93RyFTJ1f5G17IZDs7z25uEfuFBYwlvYpUUuTnKJO6umg5IymD88yGGxbycjN2JOkIVk6wUoEzm/0O5T/Owb92Jg8NyL/6qFrl30IZ5nSgMp3nch7DkvOMCaMeoQ1U4JZxQncenmAMmcAei/S7V9CvAccW8mczwtMCceSQ8nwhXWuKAeQPJbRCc9RnhoSyhvBL+WgxTzsk0Y567IFj+35wa4Xq7ykS5YIm7UIdq4iCfKcsiIoSvFFWONUnFovZoXHKhXE69R9hTOIEgZPcJ0VZRrx+i3j9hhtFPqQDnYjX8uaEpS2+F4twiVkOylSJAwfvBZO3XBnoTaEHtltSWAGKIEl3SJIQ1CRESIRnLFtJRc88GckEbQuOBTO5zBXziL0JIPKiyMtzggwiMc+czmbDEbDMbJaLhC3LPzPuFOKaD6zEM+tt15gNxTPLIg5dvglCfGmbmakYmqmKsEfRVOWWAXjqvEzVeamT6botq9321Vu2rIb7KOrufmZ24LWmoiI3yspJJ65e704JprBSFGH3pxXLhAQe9fBzbM1rq7YAm1dsctvZSiqu8G94rxwS/LQ7JYorRR0XXq/GmSh4dJADKAsSk70ajQ8gHdE0MhzVjOCbVDSvKINd1PhKVN+fgMTG2zYCvIaq+V2mmsNTP36IRLD6xO7ejWTDisfc7zCVD6tQW+/eMTW1Y3fSt20foe+hBZpQ3zfGfH3vyzmCZNvHFoJFVPrRjj7m6I26M3r7KHQxgD5c2H/4tQdIeJLJ+yQDvTsZOwv4jYfJQxVaxxmtKtNTTVaQnRmS6kkWvfBoNvCeIT55jt41PJZwpg3YYeJYGK+dppgK/sF+R/8ggZIOBlnyNoK/qpwokLZ6uCFRKCTKV8HeGaYksPg2Xj/3fyQZb6dhGWv2QLLQU4DW7lZwf77Hw+vb3AjzexKIVywkEXoGlB1JUqr4FW3A7BZlDzgzhZ5W0tyfI1da7mmn13JvsZOFxLuJIRsmLXJVskByA41iu/uvSds9bWOnPZQ4lSgANm+xqQ6gMPlGH2YR79rSDIXLXQBujHZSxkCpSIeynwCdNxEFJ2HVmSDaFPxQYoIN2BfCM8E6zTCu66VDSQ97KkPfIa8i7nGUITNAZagDhYFJjeg5rXh+bcBuYamT/JWmRVE8Iopeb/3ud1ZdSIs4TkQLcaogJ63Z5dGUxEfefz8qSKko+Qm2PB/ZgyEEMngmjkjovYB0GBog+n9COzD7MiQ73pfOA5S8NLseIst+QWbPC9y/J8dRv7QFliCNWcnzAYlI3fE8hdNVbBPY1WEeZxm8m5mKOdypQRG1qhiRgQBnZbr7N20qT1ipoPsLVYWEGq8hE3BoLPn2tV8PhWVe0WTB4nIN3WMD7cmIiDZEhaSSROulWMbk2+sX4LIs0Iq4NNdUfV3mDeqCbaEOligmbYSFCaU0VRVULrhTKoKlIMubNvV3ZyyOByWMilXkBpNjcIjihTjBrwzF/bmKF1iMJNsHxrobcnxElDVF0C3u69fevP5txIsEcUrVZyR96DPqiI/C+zGTp0uZGkXVP6PG1RncET7Ey/eKjnX885QeWw83krsCIVyvMp8TD9P3rEvMFUkFZxS6Rw25ytWQJ/52/tqLyQSDrc7Dpiq/H2XDgYsVBgjnK7BF95EwLKLNKLh0bg5x74VXPNwJO1fq7raB588j7pbhat78pDKjPE1td1Jl6Hhn8Q73LdISsCrrgwuijljQ28Tinnavx+Xu9ap6jYqn2QzNaly7RoVJ99MoBl/DvmtU1X0Lu3FCnO37XXKEW832Nai8BYnDKKvIF92W3F9dotK94ahCNyJPuW+5b2L1WrQ2X6fSc1TBejLg77uvsm8FX2b1ghWk6cbjuB1FUIVm9y0f6aMKfMbdhjshNGihFKgIgE7044ZvkbXz+zbh3chXN/f35Z6mOyF2b/m7H6V7HVV3XYOYtiDOig/J25bh+xPuAPMdxRPRc8V1YU8Z2mEv9OIO2O6DTg8Wtt2C3+lCcjBRmEaNVbDhi0nLnUK1ttvqdVpsexruQ93WGnf3T9s47N+te7nN5FeohRGeChUfIvZx5htAPYTNjQl/ea/tTlkW7LZ7nIK3dyNsGUwWpq0+a4k/ALvozB5nurkCqwthUdrq5mnzBD/tu5rpfPVYuC6L0VZwnMfd/YnGxgTc97jjFNjGFvRQ6iyrYPfZjyPVyQJM233YRF5YVb1xgLzjwVMX3NOwZ/K7wtJZx4W8pGRNNzf4ZOBeCKgPCxuKcUYmxQNycbjP5wGlEJGk8OZc369tR3gtaZ+X6CbmVkIONRVJcugpluk1TQL1Fqmfy1ELVi4hYy1zJhYNj4zu7RkfbuebN17fv+q2Fj4sDgtE7Hv2uk89uneIH7j9yNWjR1YMmUvJSzO6s9QcGWkbHt83PtzW0yWCMMLr4roNcMm+o88e3XdJ/0VDkWiFDxSv5YhXq8d3nVAryjjtoDXp7Ojn2gg6ijGHIUxDpQZ0Y2lQym2+5NZHN219to8XhsUw33Lb6p6dG9DVGN598/bmkXA0NoPeR2t4qO/h0U8d3bcKtmB5yeilos6PCCB29fgINjeNmEsdfaYmGhm6qB9RrPhEx7mrEbfGwCDauZXNJo09wLJ1oAhSe1NxWkUDKKJofMqeE+szt8S4K9JYmjbLXRRtylOU1vWN//mVy4/0DVGNqM9QJT7SvL287ot5MSZoGC/oyHTWO7p3vdd5s6RB439/5fKH6aIaEDh46AVkpMqWo1YdaWpe1690hzT4e79jxGuLvD+R0iUwuiJ+TLUM4+yrA8aAdsVAsX1JFgMsTkCF4ceBdtgLZ8oXaENnPpfPipLA6A57nn4+XI1hUbCoYmig1KP5pH44Kybnq4cUyatKivvTmXpeOC7y8J4il3yHncWVz+SDrc5zTqucPyYro3Af7XP30/I8ddJxsQAgXIFbz37QdsmqNhJl0K6145C0rkWzExAX8aM3sDpwYyA8oF83PNBXWu7xRPQMIT1E6syw7M4F2tFwOmyhVKQ7+uH/lz9DribLBF4jsuze94lYBc+7LzLOXMw4c+66u52EZz/QLEWxyA0XZFuA9+OVUfSTwyzWCw0o3a0Jx9BYTrKp2AZiEi9qGSs6OFhZkPboRDXesZKpbcd3UOjV8dMgNNQhr1pJh0Qy5petVIQ48Zq1KefMj7zIhluf3pQeBs5JfUuJMGcgHFRik16gP1mzHX2EmroaYhmVysETLOo54aSGU/gHzbEwdRvCMXuGhUczHj3HkZ42Rk9LYIDS07c8YRuqSBg91Pmnwo8VghFR2Y9oKTmxziSwi0HTN2I1cMvT3E7Fezk/Pae1UnYyUwqdRnqCNZPoXSJSk6hxGWmRBKqBSMqyTP97/wmaJcQCGpqbG5Iw6vhEtHpEVWihepULpFG3rqG0rOha2qTxJIC0YOSYFjrxEtP8nlSlIxvu7PLcRKmS76mk04Sq0HoTqJ04CcfcK+DDIU34mhCX/dByaAiDy58ibicVeRdNJrNyezI2G/ESlUKsZDxiOtLJk/ChXCc9Imp+1nO2xL6QZIkkWiizM7SHIF9q9K8ZpQDx8zOjgWaMzORvdrSGPJ2sEzRYZer9O2gmWD4zSTr6sSuH8Uc/IGjmyLIMOHUV0G48840967ixy2v6zIhcU+pr3bDj9u0bc1xfqUbO9sUuH3O/iqEbFPqaPbOBZuFTO57rx7mxvnDL7avRFLah/ei55LZCpKddjqz4OxhyH6YRLuzA0rcfY5yC8rQTcb08JdLYleZW8TZ0lGgSCyVfQoQtRDiPV6BqKLryzL7kqRmkuoGdE5UzlKWy39mJQlU1OChf1KrEHOYcsdMhvaO3j5JN+zZBXJZ2Kmq0WRSMDSFJGqmtC0q8eZesmfWxPxNNca3DC3KzYsg7MBBXhJ2yHmvy5sojNXVBmQvfhUdoxJ0NgiENWTzfqwd3SOjC927ceNvGjbfTUTNp13eIumhvAKEvJA/HTUW6Maj1CeJAUtBFrcOI1xugSWxubV1qqaRJ1gZvqiHLbKqwOo5TR9hELw7/iBsjL/t6WXl+SWN9VOO5RfnTtJcwreTFY35bWthGB+bMB+yOcGEDg4bztxbkUR0wh1h2kJWgV0awMR+Hjvn5mlrmu9BMCMpYsZynmQC8KR2xco4maZIg5jN5CU86ViJ/s27nzqlxgFc6167fuXP92s5XYOdDO8j4pYNYw16IjR8eH79U0ra3Y6V9uyat20l2P7AbsKpjJ81Tzs39nt9PXgqYeL9LNB+Yi9uMN1BEZ0knnvijDiZLEDg6dJ30NuA9oQEVh9U0uk/kgO8A+R94pvWy8YveWn0ZWbfmLepJXdqz5Z5B94qhu7d2k75r7l0Lx2gVtvTMr6FXgDY7p56d6qSNS+/e0ke6r//CQ1/YXiTdW++u+FK/529HfC3klvzNhK3Te4txIUFlkuQ8tIjguXrUG6WAPWgMsIcDF664d3v3DHXwhQ07YMul2I9QDvtQXz+bokoej3uUo5mt1Qi7f/m58pGoIAyavsnnFiUl8cbhKTpRmI+CKw9Y1oKc5GvZZJCT6kWJcCHNzzDS3KTQKEocr/6Fe1GoUf+1rq/QG/W/hs9goz8E649Xc5M6HxXjAnDV9OT9spBFuwOC26Prv2bzQ3RhCHfwaYpW8+LxqOzlYOZR7/Kf/RbmXMktCzAr3jWP/Kqt5KUqZDq4uTqyBbYGfL17HcuL19KcjykyePSoAP2bNgILH1qOXXFwA9l471P3bOIvOwRXL8j+k0OjB6cPjrLCfe2sXP/824QcsAMZlOmGWiMo0rwb4K1qo+mH/LkBVlXdA+cFXFFWvz0//AXvbZ6+ac3GoyzHHvXfzCqvNILfLi9qV7KBJ/03OPbql/A+XlcDa3g9C1/rnPPU/XzkR4E3q/4p6kHES6V3vVx1M7x3EG4RnpwfhuT9B8mTF4BG6w/vZp7SbtoL4oJBkCuYe2+LL3GT6CtdzGKjNas6FGaHETyqOIeljCSdy4azYTwkLxFIL08OHSKaM+7sonl9vERpGguhHaS5bUgz24xu3ETTPsVKqntkIZfpqR1MdBfQKd6hmiFHviU1QZ260MQ2FSOcbfDmVoyFeHkb9rq/db9KFWsP6uutqz6LgZW6R+JrIjp86Gp6jSXL+7RoUv38yjEracH0NiVpKdu2ISBl27QDRdTKAT9WHoc/IL/p7w4sptcdmtpFR6IcZRnNXDnaT909x7Ykjj6PwmlFdP9FMuWgQvb8nAiKpHB7iS4/r+pk678LRCWOGpq9QwfOlOGlbpDkEPwThngKL7puibAY5LvMl+ZQQ8Yx4mxF/wZjkGJ7a3NjKl5jyjiJ/hAhLzVVExN+9qMpZsAyWImhu/eF2NlfcmS6bxq6lNlO9CZvxpjon/G7R5k1SqVwuFwOv3HTTZn0TTelSQs2wtjpPkNH8D/RH++b3mkosx0KLkzSlfi92qSrzPKX2arMTe692ChjJ7T5I75t3I487EIe5jXKQ6pg6Q83qs/lEn3noSFynmb4aOrBF9sEoBuHhKFYcL11up41emofLCQGE60wVdeDClSvn5qqM41Go7t+iuWUHqzrNrOGWTsFst5TtwLXXPk0Syc9fSX2rsBFmzadY6C/Fge8d+e5uXHkfyiQRc6vwTu2Ylkhz95Fq2/8+YVv/CxSqb7xxyqhDjDBRxFBxcQnSYzeBfrYNqGJjej4TLDfWEywII42hqZ+/BB/6I2DkCn0WS9uv3PD4Z0DpG/3oemDe7u5NS/aMOWtol60t2qCusYTSi19uHn1iHiQOpz2i2v6xx/4xqE9PfyqHQ+N3Ln9RftsmoxADcYAyvMt9Y73lr7wdwTUmb8g/u53GOaw6pPizJC9MJrEj7noG9sG1CNhmWN2BcF2dpRzGBfz5XrojEWZRxuj6aCYY0tiLJOTMmK2uJJQjxj/8hjKEB1iGHCj4JTpxczQzEtehAevG+5pUO12twtCjfG4I979yJB4a7RlZbDdVGV1OMgDQPZQY+ERm1wqiVyYJwJHMrGaP+o9YKbUlE2ApL6YEiyylNT9ESff74qtvCgqNSZcBVOa+2Hr9q9E70rVikGTcxRJ4BSQa6ImzpQIEXk+OFbqhvQRQ4souDWotqAiL2Xqm+AZ/Yz0kXcCOnvfqg1779vzOXtqtvPMii9Ig5+dwj87Kf4bQ6EJfdRt4PyQZYFY0/NXERbE5vPzi+As2njhToFqfp7h6ufXYTFiZ6MCryyG/xQX5qIBFddLfr6b+SYsHc3P1ocikRD5rxCMuNslxeBKuiZjzQpUY6kFvwNgPtyioHRxkEr9fv+HE5AwHFc9q0neOXOa/kiAi9ByQX3et1fZb2+q7yCL914QN5y1GVt/DOVaR29JPCECXV9iGaI84A7sQ9W3Y4dLZe4vVR1Mxd3Hc7rq7lNVOKjqHM9xqmiceVWXNTgoiO6fswpN0R/EfnefyHtnMvcsdw1nzMOJiSzGpQ+SPmclxmVRqlVM0HG5wNFSQYAIRhjE3ZDTsobwJbifVegTxj7sx7mCRwvp5XSWh6/QYs/TwjyMahKsVCYZVaeECMTR56MplPyzCfrSPO/dL0m8RwvpQ1oS56aF7i/58Mpn0eOHaKxcTNGd84cLd4oCvXPu3B+4a8kPUA7rmSzJ7E3Zy7OzuJEm/Mt+7Eh/pyDPMx7xF7luuh/CY9hDe4WZYLqvW+YhFlJiWX1PO0aOB6L0t3AVOUK7V/XSqP8Dx/CavHCY8erwC3jhyKHZR2nu9wXvpz4vKN4dwOIA22sZ/S1RTbhyBxbvF/XeXzEQpfEUTa0hLTTE+RigN9vzQhBp0RzT5OUaKazwlhEU8u0fx8D9XmGdwVmmZmpavDGuichhJJUz1nn5pp9yj5H3GG7DgZtovmnn5YNFiiT/JyIZqw6Uvd+i0TRIFwumFw7SVEg/TYvQDM/8hE9O4uTWEVlECuyU2tLW1oKK3jIk+bItDxy6TZKw36mttdZgKDxo1fIRzrFMSbrt0J/Cl8KVh1OcozuqGUyO7RxLBk3UrA6XfmDTF97qwAErpOl655GnjnTqOidyIQsHO08G/hcLt/j/AAB4nGNgZGBgAOLaW41M8fw2Xxm4mV8ARRguss1QhNC5H/9//Z/FUsEcBORyMDCBRAFTFwxveJxjYGRgYA76n8UQxVLGwPD/FUsFA1AEBfgBAHyYBUh4nGN+wcDAvACCWfSBNIgviMBM1kA6koGBMRWVBqsDYqYmiF4wHQkxg+kUBMPVWEP0gTDYvBdoahZAzYxEY0ciuWUBFjkoZimDYLC8IKpehmsQccYvSGYgYZB7YBhFL5o8cxTQjDUI/wIArpclrwAAAAAAAAA6AIYA3AEKAUgBgAGgAfoCYgKqAwIDOgOGA9wEQAR4BLYFAgU8BZoFzAYMBlIGmga6BtgG+AcYB0QHcAecB8gIAAg2CG4IpgjyCUAJrAo0CtALOAueDAoMYA0ADVANjg3mDiQOjg7GDvgPOA+ED84QPBB2EN4RNhGgEfISchKoEsgS6BMGEz4TXhOSE8QT+BQsFGIUiBTWFX0AAAABAAAATgBuAAYAAAAAAAIAAAAQAHMAAAAiC3AAAAAAeJx1kctOGzEUhn9DoIKgLloJdcdZIRDK5CKhSqyoogJrhLJDwgyeSzpjRx4HlGfgLcoz8Dp9j+76Z2KhqFJmZM93Ph/bxx4AX/AHCqvnnG3FCgeMVryFT/gReZv+JnKHfBd5B108RN6l/xV5H2d4idzFV/zmCqqzx2iK98gK39RR5C18Vt8jb9P/jNwh30fewaGaR96lf428j4l6i9zFsfo7drOFL/MiyMn4VEaD4bk8LsRRlVZXouehcL6RS8mcDaaqXJK6OtSml+lemTrb3Jp8Xmm/rtZ5YnxTOivDZLCur401XgfztNytec5HIWSSeVfLVdxHZt5NTRqSIoTZRb+/vj/GcJhhAY8SOQoECE5oT/kdYYAhf4zgkRnCzFVWCQuNikZjzhlFO9IwvmTLGFlaw4yKnCBlX9PUdD2Oa/Zlay1n3dLmXKei9xuzNvkJ7XLvso2F9SaselP2Na1tZ+i2wqePszV4ZhUj2sBZy1P4tmrB1X/nEd7XcmxKk9In7a0F2gv0+W44/z/KQo7lAHicbZLnlpswEIW5Bgy4bLLpvfeE9N57z76DLARWEJKOEEucpw8CO/kTncOdT6PhnlHxRt4wJt7/x47nYQQfAUKMESFGggmmmGGOLezBXmxjH/bjAA7iEA7jCI7iGI7jBE7iFE7jDM7iHM7jAi7iEi7jCq7iGq7jBlLcxC3cxh3cxT3cxwM8xCM8xhM8xTM8xwu8xCu8xhu8xTu8xwd8xCd8xhd8xTd8xw/sBLUlZuIkZZW2q0hzahvDRqocUyIpE4EWTR1WXDZ1sGRCz5yklBsqWBZwmauZk01mTqxl0nIlUyLs9r/Zej35m4kFl2XKftlAKFomTlKlmfQ1l74lRdB9dbxQqqyIKbc2MPQZGqbFKsqVaYnJ4ky1Ms24iQXLrYPE8GLZ07jRfaIvcf5JX+NoMhQ5jLoqFwenBS8Gpw7WTh05py6MaOtT2ibEGNXWKW1Da0i9nPY6dNe7CEWy7pc+5EJpvfJVnvtUFUHFZBPWS2LYxKqiECztVpINypAuGS2nvQ6Gs+H0hsk0U3ZznDETguua1/MNpLvMWH/RFGEuuobCihScxqS2zPC6jH4rVaVcxn1UjQ1yJW1QK2MTJ6nrPOqp0d3Vk1WoSVOz7p0oHeWdTbpoh5i3sVWpezp23AGTWch+Mmonu0o0Vb+l6RqdabLmRnveH9ru7j54nGPw3sFwIihiIyNjX+QGxp0cDBwMyQUbGVidNjIwaEFoDhR6JwMDAycyi5nBZaMKY0dgxAaHjoiNzCkuG9VAvF0cDQyMLA4dySERICWRQLCRgUdrB+P/1g0svRuZGFwAB9MiuAAAAA==) format('woff')}</style>
<style id="style-core" type="text/css">html{font:16px/1 Helmet,Freesans,sans-serif}#store-area,tw-storydata{display:none!important;z-index:0}.no-transition{-o-transition:none!important;transition:none!important}:focus{outline:thin dotted}:disabled{cursor:not-allowed!important}body{color:#eee;background-color:#111}a{cursor:pointer;color:#68d;text-decoration:none;-o-transition-duration:.2s;transition-duration:.2s}a:hover{color:#8af;text-decoration:underline}a.link-broken{color:#c22}a.link-broken:hover{color:#e44}a[disabled],span.link-disabled{color:#aaa;cursor:not-allowed!important;text-decoration:none}area{cursor:pointer}button{cursor:pointer;color:#eee;background-color:#35a;border:1px solid #57c;line-height:normal;padding:.4em;-o-transition-duration:.2s;transition-duration:.2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}button:hover{background-color:#57c;border-color:#79e}button:disabled{background-color:#444;border:1px solid #666}input,select,textarea{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}select{padding:.34em .4em}input[type=text]{min-width:18em}textarea{min-width:30em;resize:vertical}input[type=checkbox],input[type=file],input[type=radio],select{cursor:pointer}input[type=range]{-webkit-appearance:none;min-height:1.2em}input[type=range]:focus{outline:0}input[type=range]::-webkit-slider-runnable-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;margin-top:-5px;width:33px}input[type=range]:focus::-webkit-slider-runnable-track{background:#222}input[type=range]::-moz-range-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-moz-range-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;width:33px}input[type=range]::-ms-track{background:0 0;border-color:transparent;color:transparent;cursor:pointer;height:10px;width:calc(100% - 1px)}input[type=range]::-ms-fill-lower{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-fill-upper{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:16px;width:33px}input:not(:disabled):focus,input:not(:disabled):hover,select:not(:disabled):focus,select:not(:disabled):hover,textarea:not(:disabled):focus,textarea:not(:disabled):hover{background-color:#333;border-color:#eee}hr{display:block;height:1px;border:none;border-top:1px solid #eee;margin:1em 0;padding:0}audio,canvas,progress,video{max-width:100%;vertical-align:middle}.error-view{background-color:#511;border-left:.5em solid #c22;display:inline-block;margin:.1em;max-width:100%;padding:0 .25em;position:relative}.error-view>.error-toggle{background-color:transparent;border:none;line-height:inherit;left:0;padding:0;position:absolute;top:0;width:1.75em}.error-view>.error{display:inline-block;margin-left:.25em}.error-view>.error-toggle+.error{margin-left:1.5em}.error-view>.error-source[hidden]{display:none}.error-view>.error-source:not([hidden]){background-color:rgba(0,0,0,.2);display:block;margin:0 0 .25em;overflow-x:auto;padding:.25em}.highlight,.marked{color:#ff0;font-weight:700;font-style:italic}.nobr{white-space:nowrap}.error-view>.error-toggle:before,.error-view>.error:before,[data-icon-after]:after,[data-icon-before]:before,[data-icon]:before,a.link-external:after{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}[data-icon]:before{content:attr(data-icon)}[data-icon-before]:before{content:attr(data-icon-before) "\00a0"}[data-icon-after]:after{content:"\00a0" attr(data-icon-after)}.error-view>.error-toggle:before{content:"\e81a"}.error-view>.error-toggle.enabled:before{content:"\e818"}.error-view>.error:before{content:"\e80d\00a0\00a0"}a.link-external:after{content:"\00a0\e80e"}</style>
<style id="style-core-display" type="text/css">#story{z-index:10;margin:2.5em}@media screen and (max-width:1136px){#story{margin-right:1.5em}}#passages{max-width:54em;margin:0 auto}</style>
<style id="style-core-passage" type="text/css">.passage{line-height:1.75;text-align:left;-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.passage-in{opacity:0}.passage ol,.passage ul{margin-left:.5em;padding-left:1.5em}.passage table{margin:1em 0;border-collapse:collapse;font-size:100%}.passage caption,.passage td,.passage th,.passage tr{padding:3px}</style>
<style id="style-core-macro" type="text/css">.macro-append-insert,.macro-linkappend-insert,.macro-linkprepend-insert,.macro-linkreplace-insert,.macro-prepend-insert,.macro-repeat-insert,.macro-replace-insert,.macro-timed-insert{-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.macro-append-in,.macro-linkappend-in,.macro-linkprepend-in,.macro-linkreplace-in,.macro-prepend-in,.macro-repeat-in,.macro-replace-in,.macro-timed-in{opacity:0}</style>
<style id="style-ui-dialog" type="text/css">html[data-dialog] body{overflow:hidden}#ui-overlay.open{visibility:visible;-o-transition:opacity .2s ease-in;transition:opacity .2s ease-in}#ui-overlay:not(.open){-o-transition:visibility .2s step-end,opacity .2s ease-in;transition:visibility .2s step-end,opacity .2s ease-in}#ui-overlay{visibility:hidden;opacity:0;z-index:100000;position:fixed;top:-50%;left:-50%;height:200%;width:200%}#ui-dialog.open{display:block;-o-transition:opacity .2s ease-in;transition:opacity .2s ease-in}#ui-dialog{display:none;opacity:0;z-index:100100;position:fixed;top:50px;margin:0;padding:0}#ui-dialog>*{box-sizing:border-box}#ui-dialog-titlebar{position:relative}#ui-dialog-close{display:block;position:absolute;right:0;top:0;white-space:nowrap}#ui-dialog-body{overflow:auto;min-width:280px;height:92%;height:calc(100% - 2.1em)}#ui-overlay{background-color:#000}#ui-overlay.open{opacity:.8}#ui-dialog{max-width:66em}#ui-dialog.open{opacity:1}#ui-dialog-titlebar{background-color:#444;min-height:24px}#ui-dialog-title{margin:0;padding:.2em 3.5em .2em .5em;font-size:1.5em;text-align:center;text-transform:uppercase}#ui-dialog-close{cursor:pointer;font-size:120%;margin:0;padding:0;width:3.6em;height:92%;background-color:transparent;border:1px solid transparent;-o-transition-duration:.2s;transition-duration:.2s}#ui-dialog-close:hover{background-color:#b44;border-color:#d66}#ui-dialog-body{background-color:#111;border:1px solid #444;text-align:left;line-height:1.5;padding:1em}#ui-dialog-body>:first-child{margin-top:0}#ui-dialog-body hr{background-color:#444}#ui-dialog-body ul.buttons{margin:0;padding:0;list-style:none}#ui-dialog-body ul.buttons li{display:inline-block;margin:0;padding:.4em .4em 0 0}#ui-dialog-body ul.buttons>li+li>button{margin-left:1em}#ui-dialog-close{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-close{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}</style>
<style id="style-ui" type="text/css">#ui-dialog-body.settings [id|=setting-body]>div:first-child{display:table;width:100%}#ui-dialog-body.settings [id|=setting-label]{display:table-cell;padding:.4em 2em .4em 0}#ui-dialog-body.settings [id|=setting-label]+div{display:table-cell;min-width:8em;text-align:right;vertical-align:middle;white-space:nowrap}#ui-dialog-body.list{padding:0}#ui-dialog-body.list ul{margin:0;padding:0;list-style:none;border:1px solid transparent}#ui-dialog-body.list li{margin:0}#ui-dialog-body.list li:not(:first-child){border-top:1px solid #444}#ui-dialog-body.list li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-decoration:none}#ui-dialog-body.list li a:hover{background-color:#333;border-color:#eee}#ui-dialog-body.saves{padding:0 0 1px}#ui-dialog-body.saves>:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves table{border-spacing:0;width:100%}#ui-dialog-body.saves tr:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves td{padding:.33em .33em}#ui-dialog-body.saves td:first-child{min-width:1.5em;text-align:center}#ui-dialog-body.saves td:nth-child(3){line-height:1.2}#ui-dialog-body.saves td:last-child{text-align:right}#ui-dialog-body.saves .empty{color:#999;speak:none;text-align:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.saves .datestamp{font-size:75%;margin-left:1em}#ui-dialog-body.saves ul.buttons li{padding:.4em}#ui-dialog-body.saves ul.buttons>li+li>button{margin-left:.2em}#ui-dialog-body.saves ul.buttons li:last-child{float:right}#ui-dialog-body.settings div[id|=header-body]{margin:1em 0}#ui-dialog-body.settings div[id|=header-body]:first-child{margin-top:0}#ui-dialog-body.settings div[id|=header-body]:not(:first-child){border-top:1px solid #444;padding-top:1em}#ui-dialog-body.settings div[id|=header-body]>*{margin:0}#ui-dialog-body.settings h2[id|=header-heading]{font-size:1.375em}#ui-dialog-body.settings p[id|=header-desc],#ui-dialog-body.settings p[id|=setting-desc]{font-size:87.5%;margin:0 0 0 .5em}#ui-dialog-body.settings div[id|=setting-body]+div[id|=setting-body]{margin:1em 0}#ui-dialog-body.settings [id|=setting-control]{white-space:nowrap}#ui-dialog-body.settings button[id|=setting-control]{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}#ui-dialog-body.settings button[id|=setting-control]:hover{background-color:#333;border-color:#eee}#ui-dialog-body.settings button[id|=setting-control].enabled{background-color:#282;border-color:#4a4}#ui-dialog-body.settings button[id|=setting-control].enabled:hover{background-color:#4a4;border-color:#6c6}#ui-dialog-body.settings input[type=range][id|=setting-control]{max-width:35vw}#ui-dialog-body.list a,#ui-dialog-body.settings span[id|=setting-input]{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.saves button[id=saves-clear]:before,#ui-dialog-body.saves button[id=saves-export]:before,#ui-dialog-body.saves button[id=saves-import]:before,#ui-dialog-body.settings button[id|=setting-control].enabled:after,#ui-dialog-body.settings button[id|=setting-control]:after{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}#ui-dialog-body.saves button[id=saves-export]:before{content:"\e829\00a0"}#ui-dialog-body.saves button[id=saves-import]:before{content:"\e82a\00a0"}#ui-dialog-body.saves button[id=saves-clear]:before{content:"\e827\00a0"}#ui-dialog-body.settings button[id|=setting-control]:after{content:"\00a0\00a0\e830"}#ui-dialog-body.settings button[id|=setting-control].enabled:after{content:"\00a0\00a0\e831"}</style>
<style id="style-ui-bar" type="text/css">#story{margin-left:20em;-o-transition:margin-left .2s ease-in;transition:margin-left .2s ease-in}#ui-bar.stowed~#story{margin-left:4.5em}@media screen and (max-width:1136px){#story{margin-left:19em}#ui-bar.stowed~#story{margin-left:3.5em}}@media screen and (max-width:768px){#story{margin-left:3.5em}}#ui-bar{position:fixed;z-index:50;top:0;left:0;width:17.5em;height:100%;margin:0;padding:0;-o-transition:left .2s ease-in;transition:left .2s ease-in}#ui-bar.stowed{left:-15.5em}#ui-bar-body{height:90%;height:calc(100% - 2.5em);margin:2.5em 0;padding:0 1.5em}#ui-bar.stowed #ui-bar-body,#ui-bar.stowed #ui-bar-history{visibility:hidden;-o-transition:visibility .2s step-end;transition:visibility .2s step-end}#ui-bar{background-color:#222;border-right:1px solid #444;text-align:center}#ui-bar-tray{position:absolute;top:.2em;left:0;right:0}#ui-bar a{text-decoration:none}#ui-bar hr{border-color:#444}#ui-bar-history [id|=history],#ui-bar-toggle{font-size:1.2em;line-height:inherit;color:#eee;background-color:transparent;border:1px solid #444}#ui-bar-toggle{display:block;position:absolute;top:0;right:0;border-right:none;padding:.3em .45em .25em}#ui-bar.stowed #ui-bar-toggle{padding:.3em .35em .25em .55em}#ui-bar-toggle:hover{background-color:#444;border-color:#eee}#ui-bar-history{margin:0 auto}#ui-bar-history [id|=history]{padding:.2em .45em .35em}#ui-bar-history #history-jumpto{padding:.2em .665em .35em}#ui-bar-history [id|=history]:not(:first-child){margin-left:1.2em}#ui-bar-history [id|=history]:hover{background-color:#444;border-color:#eee}#ui-bar-history [id|=history]:disabled{color:#444;background-color:transparent;border-color:#444}#ui-bar-body{line-height:1.5;overflow:auto}#ui-bar-body>:not(:first-child){margin-top:2em}#story-title{margin:0;font-size:162.5%}#story-author{margin-top:2em;font-weight:700}#menu ul{margin:1em 0 0;padding:0;list-style:none;border:1px solid #444}#menu ul:empty{display:none}#menu li{margin:0}#menu li:not(:first-child){border-top:1px solid #444}#menu li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-transform:uppercase}#menu li a:hover{background-color:#444;border-color:#eee}#menu a,#ui-bar-history [id|=history],#ui-bar-toggle{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#menu-core li[id|=menu-item] a:before,#ui-bar-history [id|=history],#ui-bar-toggle:before{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}#ui-bar-toggle:before{content:"\e81d"}#ui-bar.stowed #ui-bar-toggle:before{content:"\e81e"}#menu-item-saves a:before{content:"\e82b\00a0"}#menu-item-settings a:before{content:"\e82d\00a0"}#menu-item-restart a:before{content:"\e82c\00a0"}#menu-item-share a:before{content:"\e82f\00a0"}</style>
<style id="style-ui-debug" type="text/css">#debug-bar{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:0;margin:0;max-height:75%;padding:.5em;position:fixed;right:0;z-index:99900}#debug-bar>div:not([id])+div{margin-top:.5em}#debug-bar>div>label{margin-right:.5em}#debug-bar>div>input[type=text]{min-width:0;width:8em}#debug-bar>div>select{width:15em}#debug-bar-toggle{color:#eee;background-color:#222;border:1px solid #444;height:101%;height:calc(100% + 1px);left:-2em;left:calc(-2em - 1px);position:absolute;top:-1px;width:2em}#debug-bar-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-hint{bottom:.175em;font-size:4.5em;opacity:.33;pointer-events:none;position:fixed;right:.6em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap}#debug-bar-watch{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:102%;bottom:calc(100% + 1px);font-size:.9em;left:-1px;max-height:650%;max-height:65vh;position:absolute;overflow-x:hidden;overflow-y:scroll;right:0;z-index:99800}#debug-bar-watch[hidden]{display:none}#debug-bar-watch div{color:#999;font-style:italic;margin:1em auto;text-align:center}#debug-bar-watch table{width:100%}#debug-bar-watch tr:nth-child(2n){background-color:rgba(127,127,127,.15)}#debug-bar-watch td{padding:.2em 0}#debug-bar-watch td:first-child+td{padding:.2em .3em .2em .1em}#debug-bar-watch .watch-delete{background-color:transparent;border:none;color:#c00}#debug-bar-watch-all,#debug-bar-watch-none{margin-left:.5em}#debug-bar-views-toggle,#debug-bar-watch-toggle{color:#eee;background-color:transparent;border:1px solid #444;margin-right:1em;padding:.4em}#debug-bar-views-toggle:hover,#debug-bar-watch-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle,html[data-debug-view] #debug-bar-views-toggle{background-color:#282;border-color:#4a4}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle:hover,html[data-debug-view] #debug-bar-views-toggle:hover{background-color:#4a4;border-color:#6c6}#debug-bar-hint:after,#debug-bar-toggle:before,#debug-bar-views-toggle:after,#debug-bar-watch .watch-delete:before,#debug-bar-watch-add:before,#debug-bar-watch-all:before,#debug-bar-watch-none:before,#debug-bar-watch-toggle:after{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}#debug-bar-toggle:before{content:"\e838"}#debug-bar-hint:after{content:"\e838\202f\e822"}#debug-bar-watch .watch-delete:before{content:"\e804"}#debug-bar-watch-add:before{content:"\e805"}#debug-bar-watch-all:before{content:"\e83a"}#debug-bar-watch-none:before{content:"\e827"}#debug-bar-views-toggle:after,#debug-bar-watch-toggle:after{content:"\00a0\00a0\e830"}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle:after,html[data-debug-view] #debug-bar-views-toggle:after{content:"\00a0\00a0\e831"}html[data-debug-view] .debug{padding:.25em;background-color:#234}html[data-debug-view] .debug[title]{cursor:help}html[data-debug-view] .debug.block{display:inline-block;vertical-align:middle}html[data-debug-view] .debug.invalid{text-decoration:line-through}html[data-debug-view] .debug.hidden,html[data-debug-view] .debug.hidden .debug{background-color:#555}html:not([data-debug-view]) .debug.hidden{display:none}html[data-debug-view] .debug[data-name][data-type].nonvoid:after,html[data-debug-view] .debug[data-name][data-type]:before{background-color:rgba(0,0,0,.25);font-family:monospace,monospace;white-space:pre}html[data-debug-view] .debug[data-name][data-type]:before{content:attr(data-name)}html[data-debug-view] .debug[data-name][data-type|=macro]:before{content:"<<" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=macro].nonvoid:after{content:"<</" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=html]:before{content:"<" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type|=html].nonvoid:after{content:"</" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type]:not(:empty):before{margin-right:.25em}html[data-debug-view] .debug[data-name][data-type].nonvoid:not(:empty):after{margin-left:.25em}html[data-debug-view] .debug[data-name][data-type|=special],html[data-debug-view] .debug[data-name][data-type|=special]:before{display:block}</style>
</head>
<body>
	<div id="init-screen">
		<div id="init-no-js"><noscript>JavaScript is required. Please enable it to continue.</noscript></div>
		<div id="init-lacking">Your browser lacks required capabilities. Please upgrade it or switch to another to continue.</div>
		<div id="init-loading"><div>Loading&hellip;</div></div>
	</div>
	<!-- UUID://FDA8DE99-1A57-4FDA-BC8F-CD9A1987CDA0// --><tw-storydata name="Liff Origins: Jaylie" startnode="150" creator="Tweego" creator-version="2.1.1+81d1d71" ifid="FDA8DE99-1A57-4FDA-BC8F-CD9A1987CDA0" zoom="1" format="SugarCube" format-version="2.30.0" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">/* twine-user-stylesheet #1: "Base.css" */
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
/* twine-user-stylesheet #2: "CharacterSheetStyles.css" */
/* Character Sheet Overlay Base */
#character-sheet-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.75);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: Cinzel, serif;
}

.overlay-hidden {
  display: none !important;
}

#character-sheet-container {
  background-image: url("images/overlaybg_charactersheet.png");
  background-size: cover;
  background-position: center;
  padding: 20px;
  width: 90vw;
  height: 90vh;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
}

.charactersheet-close-btn {
  position: absolute;
  top: 3%;
  right: 5%;
  background: transparent;
  border: none;
  font-size: 24px;
  color: #421e14;
  cursor: pointer;
}

/* Layout Rows */
.charsheet-top,
.charsheet-center,
.charsheet-bottom {
  display: flex;
  justify-content: space-between;
  gap: 20px;
}

/* Top Sections */
.charsheet-top-left,
.charsheet-top-right {
  flex: 1;
  font-size: 1.1em;
}

/* Center Sections */
.charsheet-center-left {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

.char-portrait img {
  width: 150px;
  height: 150px;
  object-fit: contain;
  border: 2px solid #3b2a1e;
  background-color: rgba(255, 255, 255, 0.1);
}

.charsheet-center-right {
  flex: 3;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.attributes-panel,
.skills-panel {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.attributes-panel ul,
.skills-panel ul {
  list-style-type: none;
  padding-left: 0;
}

.skills-panel .primary-skills,
.skills-panel .secondary-skills {
  background-color: rgba(255, 255, 255, 0.05);
  padding: 10px;
  border: 1px solid #c4b998;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.skills-panel .secondary-skills ul {
  padding-left: 15px;
}

.skills-panel span {
  font-weight: bold;
  cursor: help;
}

/* Bottom Sections */
.charsheet-bottom-left {
  flex: 2;
}

.charsheet-bottom-left img {
  width: 100%;
  max-width: 300px;
}

.charsheet-bottom-right {
  flex: 3;
  display: flex;
  gap: 10px;
}

.traits-panel,
.status-panel {
  flex: 1;
  padding: 10px;
  border: 1px solid #9c8b65;
  background-color: rgba(255, 255, 255, 0.04);
}

.scrollable-list {
  max-height: 200px;
  overflow-y: auto;
}

/* Status Colors */
.status-health {
  color: #d34848;
}
.status-fatigue {
  color: #a6743c;
}
.status-composure {
  color: #4a8eab;
}
.status-excitement {
  color: #ab49a3;
  animation: pulse-status 2s infinite;
}

@keyframes pulse-status {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}

/* Status conditional list styles */
#char-status-conditional li {
  font-style: italic;
  color: #c98233;
}

/* Tooltip style */
[title]:hover::after {
  content: attr(title);
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  padding: 5px 8px;
  border-radius: 4px;
  position: absolute;
  white-space: pre-line;
  font-size: 0.9em;
  max-width: 300px;
  transform: translateY(-1.5em);
  z-index: 10001;
}
/* twine-user-stylesheet #3: "background.css" */
/* =============================
=       Background Layer       =
============================= */
#background-image {
    background-image: url('images/background_default.png');
    background-size: cover;
    background-position: center center;
    background-attachment: fixed;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0;
    pointer-events: none;
    transition: background-image 0.4s ease-in-out;
    filter: blur(3px)
  }
  
/* twine-user-stylesheet #4: "bug-report-styles.css" */
#bug-report-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.8);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

#bug-report-overlay .overlay-window {
  background: #1e1e1e;
  padding: 2rem;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  color: #eee;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
}

#bug-report-overlay label {
  display: block;
  margin-top: 1em;
  font-weight: bold;
}

#bug-report-overlay input,
#bug-report-overlay textarea {
  width: 100%;
  padding: 0.6em;
  margin-top: 0.4em;
  border-radius: 6px;
  border: none;
  background: #2c2c2c;
  color: #fff;
  resize: vertical;
}

#bug-report-overlay .overlay-submit-btn {
  margin-top: 1.5em;
  padding: 0.75em 1.25em;
  border: none;
  border-radius: 6px;
  background-color: #3a8edb;
  color: white;
  cursor: pointer;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 0.5em;
}

.overlay-close-btn {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  color: #fff;
  font-size: 1.5em;
  cursor: pointer;
}
/* twine-user-stylesheet #5: "convo-minigame-styles.css" */
/* ======================================================
   Conversation Minigame Overlay Styles (Updated Layout)
========================================================= */

#conversation-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  font-family: var(--main-font);
  color: #eee;
}

.overlay-hidden, .hidden {
  display: none !important;
}

.convo-window {
  display: flex;
  position: relative;
  flex-direction: row;
  flex-wrap: nowrap;
  width: 90vw;
  max-width: 1000px;
  height: 90vh; /* 🔥 Lock height to viewport, not auto */
  background: #1c1c1c;
  border: 2px solid #888;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  padding: 1em;
}
/* ======================================================
   HAWT™ Escalation Visual System (Backgrounds)
========================================================= */

/* Tier 1: Calm */
.heat-1 {
  background: linear-gradient(135deg, #1c1c1c, #222);
  box-shadow: 0 0 8px #000 inset;
}

/* Tier 2: Slight Warmth */
.heat-2 {
  background: linear-gradient(135deg, #1c1c1c, #3a1c1c);
  animation: simmerPulse 12s infinite;
  box-shadow: 0 0 12px #400000 inset;
}

/* Tier 3: Growing Heat */
.heat-3 {
  background: linear-gradient(135deg, #2c1c1c, #4a1c1c);
  animation: simmerPulse 8s infinite;
  box-shadow: 0 0 16px #600000 inset;
}

/* Tier 4: Bubbling Start */
.heat-4 {
  background: linear-gradient(135deg, #3c1c1c, #6a1c1c, #3c1c3c);
  animation: simmerPulse 5s infinite, brewBubble 20s infinite;
  box-shadow: 0 0 20px #800020 inset, 0 0 10px #800020;
}

/* Tier 5: Full Alchemical Brew */
.heat-5 {
  background: linear-gradient(270deg, #800020, #a00040, #800020);
  background-size: 400% 400%;
  animation: simmerPulse 3s infinite, brewBubble 15s infinite, backgroundRipple 30s infinite;
  box-shadow: 0 0 40px #ff0060, 0 0 20px #ff0060, 0 0 10px #ff0060;
}


#convo-body {
  display: flex;
  flex: 1;
  overflow: auto;
  height: 100%;
}

/* LEFT PANEL */
.convo-left-bar {
  width: 25%;
  min-width: 180px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  padding: 1em;
  border-right: 2px solid #444;
  overflow: hidden;
}

.npc-portrait img,
.player-portrait img {
  width: 100%;
  height: auto;
  max-height: 30vh;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid #999;
}

.convo-stats {
  margin-top: 1em;
  margin-bottom: 1em;
  text-align: center;
  font-size: 0.95em;
  border: 1px solid #666;
  border-radius: 6px;
  padding: 0.5em;
  width: 100%;
  background: #222;
}

.convo-stats div {
  margin: 0.25em 0;
}

/* RIGHT PANEL */
.convo-right {
  width: 75%;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 1em;
  overflow: hidden;
  min-height: 0; /* 🔥 allow shrink flex */
}

/* Header Area */
.convo-header-box {
  flex-shrink: 1; /* 🔥 allow header to shrink */
  flex-grow: 0;
  flex-basis: auto;
  border-bottom: 1px solid #666;
  padding-bottom: 0.5em;
  margin-bottom: 0.5em;
}

.npc-name {
  font-size: 1.5em;
  font-style: italic;
}

.npc-prompt {
  font-size: 1.3em;
  font-style: italic;
  color: #e44;
  margin-top: 0.5em;
}

/* Choices Area */
.convo-main-box {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 0; /* 🔥 allow flex children to shrink */
}

.convo-choices {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 0.5em;
  padding: 1em;
  max-height: 50vh;
  overflow-y: auto;
  scrollbar-width: thin;
  padding: 0.5em;
}

@keyframes slideFadeIn {
  from { opacity: 0; transform: translateY(15px); }
  to   { opacity: 1; transform: translateY(0); }
}

.convo-choices button {
  background: #222;
  border: 1px solid #999;
  border-radius: 4px;
  color: #aef;
  font-size: 1em;
  padding: 0.6em;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  opacity: 0;
}

.convo-choices button.animate-choice {
  animation: slideFadeIn 0.6s ease forwards;
}

.convo-choices button:hover {
  background: #333;
}

/* Action Buttons */
.convo-buttons {
  display: flex;
  justify-content: space-between;
  padding: 1em;
  border-top: 1px solid #666;
}

.convo-buttons button {
  padding: 0.8em 1.5em;
  font-weight: bold;
  border-radius: 6px;
  border: 1px solid #888;
  background: #202020;
  color: #eee;
  transition: background 0.2s ease;
  cursor: pointer;
}

.convo-buttons button:hover {
  background: #2a2a2a;
}

/* convo-results popup */
.convo-results {
  position: fixed; /* 🔥 fixed instead of absolute */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #222;
  border: 2px solid #555;
  border-radius: 12px;
  padding: 2em;
  text-align: center;
  z-index: 2000; /* higher layer to stay above convo-window */
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  width: 90%;
  max-width: 400px;
}


.convo-results.hidden {
  display: none;
}

/* ======================================================
   Turn Progress Bar Styles
========================================================= */

.turn-progress-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  margin-bottom: 0.8em;
  padding: 0.5em 0;
  flex-wrap: nowrap;
  width: 100%;
}

.turn-segment {
  width: 60px;
  height: 18px;
  border-radius: 999px;
  background: #555;
  transition: all 0.3s ease;
  position: relative;
}

.turn-segment::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-size: 1em;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

/* Status Colors */
.turn-segment.success { background: #3fbf65; }
.turn-segment.fail { background: #e44; }

.turn-segment.success::after { content: "✔"; color: #fff; opacity: 1; transform: translate(-50%, -50%) scale(1); }
.turn-segment.fail::after { content: "✖"; color: #fff; opacity: 1; transform: translate(-50%, -50%) scale(1); }
.turn-segment.pending { background: #555; }

.turn-number {
  font-size: 1.2em;
  font-weight: bold;
  color: #aaa;
  margin-left: 0.8em;
}

/* ======================================================
   HAWT™ Animations
========================================================= */

@keyframes simmerPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

@keyframes brewBubble {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes backgroundRipple {
  0%, 100% { background-size: 400% 400%; }
  50% { background-size: 450% 450%; }
}

/* ======================================================
   Particle Effects Styles
========================================================= */

.particle {
  position: absolute;
  font-size: 1.5em;
  pointer-events: none;
  user-select: none;
  z-index: 2000;
}

.trust-particle {
  color: #ffe066;
  text-shadow: 0 0 4px #fff8dc;
}

.affection-particle {
  color: #ff6699;
  text-shadow: 0 0 4px #ffd1dc;
}

.fail-particle {
  color: #aaa;
  opacity: 0.8;
}

/* Shake Animation for Failed Choice */
@keyframes buttonShake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-6px); }
  40%, 80% { transform: translateX(6px); }
}

.shake {
  animation: buttonShake 0.4s ease;
}

.grey-out {
  background: #333 !important;
  border-color: #666 !important;
  color: #aaa !important;
}

/* ======================================================
   Tutorial Button and Overlay (Updated)
========================================================= */

/* Floating Tutorial Button Wrapper */
#tutorial-button-wrapper {
  position: fixed; /* 🔥 not absolute */
  top: 16px;
  right: 16px;
  z-index: 1500;
}

/* Button Itself */
#tutorial-button {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #444;
  color: #fff;
  border: 1px solid #888;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
  z-index: 1501;
}

#tutorial-button:hover {
  background: #666;
  transform: scale(1.1);
}

/* Custom Hover Tooltip */
#tutorial-tooltip {
  position: absolute;
  top: -36px;
  right: 0;
  background: #222;
  border: 1px solid #888;
  padding: 0.3em 0.6em;
  border-radius: 8px;
  font-size: 0.85em;
  white-space: nowrap;
  color: #eee;
  box-shadow: 0 0 6px rgba(0,0,0,0.5);
  opacity: 0;
  pointer-events: none;
  transform: translateY(5px);
  transition: opacity 0.3s ease, transform 0.3s ease;
  z-index: 1501;
}

/* Tooltip Visible on Hover */
#tutorial-button-wrapper:hover #tutorial-tooltip {
  opacity: 1;
  transform: translateY(0);
}

/* Fullscreen Tutorial Overlay */
#tutorial-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}

/* When overlay is active (remove .hidden) */
#tutorial-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* Tutorial Content Box */
.tutorial-content {
  background: #222;
  border: 2px solid #555;
  border-radius: 12px;
  padding: 2em;
  max-width: 400px;
  width: 90%;
  text-align: center;
  color: #eee;
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  animation: fadeInScale 0.4s ease;
}

/* Fade-In Animation */
@keyframes fadeInScale {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.tutorial-content h2 {
  margin-bottom: 1em;
  font-size: 1.5em;
}

.tutorial-content ul {
  text-align: left;
  margin-bottom: 1.5em;
  padding-left: 1.2em;
}

.tutorial-content ul li {
  margin-bottom: 0.5em;
}

.tutorial-content button {
  background: #444;
  color: #fff;
  border: 1px solid #888;
  padding: 0.5em 1.2em;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s;
}

.tutorial-content button:hover {
  background: #666;
}

body.tutorial-active {
  overflow: hidden;
}


/* KEEP THIS AT THE END */
/* ======================================================
   Responsive Scaling (MOBILE FRIENDLY)
========================================================= */

@media (max-width: 768px) {
  .convo-window {
    flex-direction: column;
    height: auto;
    max-height: none;
  }

  .convo-left-bar, .convo-right {
    width: 100%;
    flex-direction: column;
    border-right: none;
    border-bottom: 2px solid #444;
  }

  .convo-choices {
    padding: 0.5em;
  }
}
/* twine-user-stylesheet #6: "crown-and-caste-styles.css" */
/* ========================================
   ORIENTATION WARNING OVERLAY
======================================== */
#orientation-warning {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.95);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Garamond', serif;
  color: #f0e6d2;
}

.orientation-warning-content {
  text-align: center;
  padding: 2rem;
  max-width: 300px;
}

.orientation-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  transform: rotate(90deg);
  animation: phoneRotate 2s ease-in-out infinite;
}

.orientation-warning-content h3 {
  color: #ffe98a;
  font-size: 1.5rem;
  margin-bottom: 1rem;
  font-weight: bold;
}

.orientation-warning-content p {
  font-size: 1rem;
  line-height: 1.4;
  margin-bottom: 1.5rem;
  color: #f0e6d2;
}

.rotation-animation {
  font-size: 2rem;
  color: #d4b26e;
  animation: rotate 2s linear infinite;
}

@keyframes phoneRotate {
  0%, 100% { transform: rotate(90deg); }
  50% { transform: rotate(0deg); }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ========================================
   CROWN & CASTE MAIN FRAME + BACKGROUND
======================================== */
#overlay-body > #crown-caste-frame {
  position: relative;
  width: min(48rem, 90vw, 85vh);
  aspect-ratio: 1 / 1;
  margin: auto;
  background: radial-gradient(circle at center, #3b2a26 30%, #211513 100%);
  overflow: hidden;
  font-family: 'Garamond', serif;
  color: #f0e6d2;
  font-size: clamp(0.75rem, 1.8vw, 1rem);
  min-height: 400px;
  max-width: 700px;
}

#overlay-panel {
  background-color: #2b1a17 !important;
  background-image: none !important;
}

#crown-caste-frame::before,
#crown-caste-frame::after {
  content: "";
  position: absolute;
  top: -50%;
  left: 50%;
  width: 3px;
  height: 200%;
  background-color: #4d2d2d;
  transform-origin: center;
  z-index: 1;
}
#crown-caste-frame::before { transform: rotate(45deg); }
#crown-caste-frame::after  { transform: rotate(-45deg); }

/* ========================================
   CENTER CROWN DICE AREA
======================================== */
#center-circle {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: clamp(120px, 20vw, 220px);
  height: clamp(120px, 20vw, 220px);
  padding: clamp(6px, 1vw, 12px);
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  gap: clamp(2px, 0.5vw, 8px);
  z-index: 2;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

#center-circle:hover {
  background: rgba(0, 0, 0, 0.9);
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}

#center-circle.chip-mode {
  box-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
  background: rgba(40, 0, 0, 0.9);
}

#crown-pot {
  font-size: clamp(0.8em, 1.5vw, 1em);
  color: #d4b26e;
  margin-bottom: 4px;
}

.crown-die-group {
  display: flex;
  justify-content: center;
  gap: clamp(4px, 1vw, 8px);
  margin-top: 15%;
  margin-bottom: 37%;
}

.crown-die {
  width: clamp(35px, 6vw, 50px);
  height: clamp(35px, 6vw, 50px);
  background-color: #2e1e1c;
  border: 2px solid #c2a96b;
  border-radius: 6px;
  color: #f0e6d2;
  font-size: clamp(1em, 2vw, 1.5em);
  text-align: center;
  line-height: clamp(35px, 6vw, 50px);
  cursor: pointer;
  transition: all 0.2s ease;
}

.crown-die:hover {
  background-color: #3e2e2c;
  transform: scale(1.05);
}

.crown-die.locked {
  background-color: #1a1a1a;
  border-color: #666;
  color: #888;
  box-shadow: 0 0 8px rgba(255, 215, 0, 0.3) inset;
}

.crown-protected-indicator {
  font-size: clamp(0.7em, 1.2vw, 0.8em);
  color: #ffd700;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* ========================================
   PLAYER ZONE POSITIONS (RESPONSIVE)
======================================== */
.player-zone {
  position: absolute;
  z-index: 2;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.zone-north { 
  top: clamp(15px, 4vw, 25px); 
  left: 50%; 
  transform: translateX(-50%); 
}
.zone-south { 
  bottom: clamp(15px, 4vw, 25px); 
  left: 50%; 
  transform: translateX(-50%); 
}
.zone-west  { 
  top: 50%; 
  left: clamp(15px, 4vw, 25px); 
  transform: translateY(-50%); 
  align-items: flex-start; 
}
.zone-east  { 
  top: 50%; 
  right: clamp(15px, 4vw, 25px); 
  transform: translateY(-50%); 
  align-items: flex-end; 
}

.player-zone.active-player {
  filter: brightness(1.2);
}

.player-zone.current-turn {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ========================================
   PLAYER UI ELEMENTS (RESPONSIVE)
======================================== */
.player-name {
  font-weight: bold;
  font-size: clamp(0.8em, 1.5vw, 1em);
  color: #f8eacb;
  text-align: center;
  white-space: nowrap;
  margin-bottom: clamp(4px, 1vw, 8px);
}

.player-stats {
  display: flex;
  gap: clamp(8px, 1.5vw, 12px);
  margin-bottom: clamp(4px, 1vw, 8px);
}

.stat-display {
  display: flex;
  align-items: center;
  gap: clamp(2px, 0.5vw, 4px);
  font-size: clamp(0.7em, 1.2vw, 0.85em);
  color: #f8eacb;
  padding: clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px);
  background: rgba(0, 0, 0, 0.3);
  border-radius: 4px;
}

.stat-display i {
  color: #ffe98a;
  font-size: clamp(0.8em, 1.2vw, 1em);
}

.chip-display {
  cursor: pointer;
  transition: all 0.2s ease;
}

.chip-display:hover {
  background: rgba(0, 0, 0, 0.5);
  transform: scale(1.05);
}

.chip-display.active {
  background: rgba(255, 100, 100, 0.3);
  border: 1px solid #ff6464;
  box-shadow: 0 0 10px rgba(255, 100, 100, 0.5);
}

/* Zone-specific positioning */
.zone-south .player-stats {
  flex-direction: row;
  justify-content: center;
}

.zone-north .player-stats {
  flex-direction: row;
  justify-content: center;
}

.zone-west .player-stats,
.zone-east .player-stats {
  flex-direction: column;
  align-items: center;
}

/* ========================================
   DICE TRIANGLE POSITIONS (RESPONSIVE)
======================================== */
.dice-triangle {
  position: relative;
  width: clamp(60px, 10vw, 80px);
  height: clamp(60px, 10vw, 80px);
}

.zone-die {
  width: clamp(30px, 5vw, 40px);
  height: clamp(30px, 5vw, 40px);
  background-color: #382423;
  border: 1px solid #a9864c;
  border-radius: 4px;
  color: #f0e6d2;
  text-align: center;
  line-height: clamp(30px, 5vw, 40px);
  font-size: clamp(0.9em, 1.5vw, 1.2em);
  transition: all 0.2s ease;
  cursor: pointer;
  position: absolute;
}

.zone-die:hover {
  background-color: #483433;
  transform: scale(1.1);
  z-index: 10;
}

.zone-die.locked {
  background-color: #1e1413;
  color: #999;
  border-color: #664f2d;
  box-shadow: 0 0 6px 1px rgba(255, 215, 0, 0.2) inset;
}

.zone-die.rollable {
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

.zone-die.chip-target {
  box-shadow: 0 0 15px rgba(255, 100, 100, 0.7);
  border-color: #ff6464;
}

/* Triangle positioning (responsive) - Improved centering */
.zone-south .zone-die:nth-child(1) { top: -20%; left: 50%; transform: translateX(-50%); }
.zone-south .zone-die:nth-child(2) { bottom: 10%; left: 15%; }
.zone-south .zone-die:nth-child(3) { bottom: 10%; right: 15%; }

.zone-north .zone-die:nth-child(1) { bottom: -20%; left: 50%; transform: translateX(-50%); }
.zone-north .zone-die:nth-child(2) { top: 10%; left: 15%; }
.zone-north .zone-die:nth-child(3) { top: 10%; right: 15%; }

.zone-west .zone-die:nth-child(1) { right: -20%; top: 50%; transform: translateY(-50%); }
.zone-west .zone-die:nth-child(2) { left: 10%; top: 15%; }
.zone-west .zone-die:nth-child(3) { left: 10%; bottom: 15%; }

.zone-east .zone-die:nth-child(1) { left: -20%; top: 50%; transform: translateY(-50%); }
.zone-east .zone-die:nth-child(2) { right: 10%; top: 15%; }
.zone-east .zone-die:nth-child(3) { right: 10%; bottom: 15%; }

/* ========================================
   GAME STATUS & CONTROLS
======================================== */
#game-status {
  position: absolute;
  top: clamp(8px, 2vw, 12px);
  right: clamp(8px, 2vw, 12px);
  background: rgba(0, 0, 0, 0.7);
  padding: clamp(6px, 1vw, 8px) clamp(8px, 1.5vw, 12px);
  border-radius: 6px;
  font-size: clamp(0.7em, 1.2vw, 0.8em);
  z-index: 5;
}

#game-status div {
  margin-bottom: 2px;
}

#current-turn {
  color: #ffd700;
  font-weight: bold;
}

#betting-panel {
  position: absolute;
  bottom: clamp(8px, 2vw, 12px);
  left: 50%;
  transform: translateX(-50%);
  background: #3b2a26;
  border: 2px solid #997c54;
  padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 20px);
  border-radius: 8px;
  z-index: 5;
  text-align: center;
}

.betting-title {
  font-weight: bold;
  font-size: clamp(0.9em, 1.5vw, 1.1em);
  color: #ffe98a;
  margin-bottom: clamp(6px, 1vw, 8px);
}

.betting-controls {
  display: flex;
  gap: clamp(4px, 1vw, 8px);
  flex-wrap: wrap;
  justify-content: center;
}

.bet-btn {
  background: #705234;
  color: #f0e6d2;
  font-family: inherit;
  border: 1px solid #c2a96b;
  padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
  border-radius: 4px;
  cursor: pointer;
  font-size: clamp(0.8em, 1.2vw, 0.9em);
  transition: all 0.2s ease;
  min-width: clamp(35px, 6vw, 45px);
}

.bet-btn:hover {
  background: #8b6c45;
  transform: scale(1.05);
}

.bet-btn:disabled {
  opacity: 0.4;
  cursor: default;
  transform: none;
}

#action-feedback {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.9);
  color: #fff;
  padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 16px);
  border-radius: 6px;
  font-size: clamp(0.8em, 1.3vw, 1em);
  z-index: 100;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#action-feedback.show {
  opacity: 1;
}

.feedback-info {
  background: rgba(0, 0, 0, 0.9);
  color: #fff;
}

.feedback-round {
  background: rgba(212, 178, 110, 0.95);
  color: #2b1a17;
  font-weight: bold;
}

.feedback-phase {
  background: rgba(255, 233, 138, 0.95);
  color: #2b1a17;
  font-weight: bold;
}

.feedback-success {
  background: rgba(76, 175, 80, 0.95);
  color: #fff;
}

.feedback-warning {
  background: rgba(255, 152, 0, 0.95);
  color: #fff;
}

.feedback-error {
  background: rgba(244, 67, 54, 0.95);
  color: #fff;
}

.disabled-during-betting {
  pointer-events: none;
  opacity: 0.5;
  filter: grayscale(0.4);
  cursor: not-allowed;
}

#player-actions {
  margin-top: 6px;
  text-align: center;
}

.end-turn-button {
  background: #8b6c45;
  color: #f0e6d2;
  border: 2px solid #c2a96b;
  border-radius: 6px;
  padding: 6px 12px;
  font-family: inherit;
  font-size: 0.9em;
  cursor: pointer;
  transition: background 0.2s ease;
}
.end-turn-button:hover {
  background: #a07d56;
}

.crown-icon {
  font-size: 1em;
  color: #ffd700;
  vertical-align: middle;
  margin-right: 4px;
}


/* ========================================
   DESKTOP OPTIMIZATIONS
======================================== */
@media (min-width: 1024px) {
  #crown-caste-frame {
    width: min(45rem, 75vw);
    max-width: 650px;
  }
  
  #center-circle {
    width: clamp(160px, 22vw, 200px);
    height: clamp(160px, 22vw, 200px);
  }
  
  .zone-north { 
    top: clamp(25px, 3.5vw, 35px); 
  }
  .zone-south { 
    bottom: clamp(25px, 3.5vw, 35px); 
  }
  .zone-west  { 
    left: clamp(25px, 3.5vw, 35px); 
  }
  .zone-east  { 
    right: clamp(25px, 3.5vw, 35px); 
  }
  
  .dice-triangle {
    width: clamp(70px, 9vw, 85px);
    height: clamp(70px, 9vw, 85px);
  }
  
  .zone-die {
    width: clamp(35px, 4.5vw, 42px);
    height: clamp(35px, 4.5vw, 42px);
    line-height: clamp(35px, 4.5vw, 42px);
    font-size: clamp(1em, 1.4vw, 1.2em);
  }
  
  .player-name {
    font-size: clamp(0.9em, 1.3vw, 1em);
  }
  
  .stat-display {
    font-size: clamp(0.8em, 1.1vw, 0.9em);
    padding: clamp(4px, 0.7vw, 6px) clamp(6px, 0.9vw, 8px);
  }
  
  #game-status {
    font-size: clamp(0.8em, 1.1vw, 0.9em);
    padding: clamp(7px, 0.9vw, 10px) clamp(10px, 1.2vw, 12px);
  }
  
  #betting-panel {
    padding: clamp(12px, 1.4vw, 16px) clamp(18px, 2vw, 24px);
  }
  
  .betting-title {
    font-size: clamp(1.1em, 1.3vw, 1.2em);
  }
  
  .bet-btn {
    font-size: clamp(0.9em, 1.1vw, 1em);
    padding: clamp(6px, 0.9vw, 8px) clamp(12px, 1.4vw, 16px);
    min-width: clamp(45px, 5.5vw, 55px);
  }
}

/* ========================================
   RESPONSIVE BREAKPOINTS
======================================== */
@media (max-width: 768px) {
  #crown-caste-frame {
    width: 95vw;
    height: 95vw;
    min-height: 350px;
  }
  
  #center-circle {
    width: clamp(100px, 18vw, 160px);
    height: clamp(100px, 18vw, 160px);
  }
  
  .zone-north { 
    top: clamp(20px, 5vw, 35px); 
  }
  .zone-south { 
    bottom: clamp(20px, 5vw, 35px); 
  }
  .zone-west  { 
    left: clamp(20px, 5vw, 35px); 
  }
  .zone-east  { 
    right: clamp(20px, 5vw, 35px); 
  }
  
  .player-stats {
    flex-direction: column !important;
    gap: 3px !important;
  }
  
  .stat-display {
    font-size: clamp(0.6em, 1vw, 0.75em);
    padding: 2px 4px;
  }
  
  .player-name {
    font-size: clamp(0.7em, 1.2vw, 0.9em);
    margin-bottom: 3px;
  }
  
  .dice-triangle {
    width: clamp(50px, 8vw, 70px);
    height: clamp(50px, 8vw, 70px);
  }
  
  .zone-die {
    width: clamp(25px, 4vw, 35px);
    height: clamp(25px, 4vw, 35px);
    line-height: clamp(25px, 4vw, 35px);
    font-size: clamp(0.8em, 1.2vw, 1em);
  }
  
  #game-status {
    font-size: clamp(0.6em, 1vw, 0.7em);
    padding: 4px 6px;
    top: clamp(5px, 1vw, 10px);
    right: clamp(5px, 1vw, 10px);
  }
  
  #betting-panel {
    bottom: clamp(5px, 1vw, 10px);
    padding: clamp(6px, 1vw, 10px) clamp(8px, 1.5vw, 15px);
  }
  
  .betting-title {
    font-size: clamp(0.8em, 1.2vw, 1em);
    margin-bottom: 4px;
  }
  
  .bet-btn {
    font-size: clamp(0.7em, 1vw, 0.8em);
    padding: 3px 6px;
    min-width: clamp(30px, 5vw, 40px);
  }
}

@media (max-width: 480px) {
  #crown-caste-frame {
    width: 98vw;
    height: 98vw;
    min-height: 320px;
  }
  
  #center-circle {
    width: clamp(80px, 16vw, 120px);
    height: clamp(80px, 16vw, 120px);
  }
  
  .crown-die {
    width: clamp(25px, 4.5vw, 35px);
    height: clamp(25px, 4.5vw, 35px);
    line-height: clamp(25px, 4.5vw, 35px);
    font-size: clamp(0.8em, 1.5vw, 1.1em);
  }
  
  .crown-die-group {
    gap: 2px;
    margin-top: 10%;
    margin-bottom: 30%;
  }
  
  .zone-north { 
    top: clamp(25px, 6vw, 40px); 
  }
  .zone-south { 
    bottom: clamp(25px, 6vw, 40px); 
  }
  .zone-west  { 
    left: clamp(25px, 6vw, 40px); 
  }
  .zone-east  { 
    right: clamp(25px, 6vw, 40px); 
  }
  
  .dice-triangle {
    width: clamp(40px, 7vw, 60px);
    height: clamp(40px, 7vw, 60px);
  }
  
  .zone-die {
    width: clamp(20px, 3.5vw, 30px);
    height: clamp(20px, 3.5vw, 30px);
    line-height: clamp(20px, 3.5vw, 30px);
    font-size: clamp(0.7em, 1.1vw, 0.9em);
  }
  
  .player-name {
    font-size: clamp(0.6em, 1.1vw, 0.8em);
    margin-bottom: 2px;
  }
  
  .stat-display {
    font-size: clamp(0.55em, 0.9vw, 0.7em);
    padding: 1px 3px;
    gap: 1px;
  }
  
  .betting-controls {
    flex-direction: column;
    gap: 3px;
  }
  
  .bet-btn {
    font-size: clamp(0.65em, 0.9vw, 0.75em);
    padding: 2px 5px;
  }
  
  #game-status {
    font-size: clamp(0.55em, 0.9vw, 0.65em);
    padding: 3px 5px;
  }
  
  #betting-panel {
    padding: 5px 8px;
  }
  
  .betting-title {
    font-size: clamp(0.7em, 1.1vw, 0.9em);
    margin-bottom: 3px;
  }
}

/* ========================================
   INTERACTION STATES
======================================== */
.clickable-die.can-roll {
  animation: pulse-green 1.5s infinite;
}

@keyframes pulse-green {
  0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.3); }
  50% { box-shadow: 0 0 15px rgba(0, 255, 0, 0.7); }
}

.clickable-die.can-lock {
  animation: pulse-blue 1.5s infinite;
}

@keyframes pulse-blue {
  0%, 100% { box-shadow: 0 0 5px rgba(0, 100, 255, 0.3); }
  50% { box-shadow: 0 0 15px rgba(0, 100, 255, 0.7); }
}

.game-disabled {
  pointer-events: none;
  opacity: 0.6;
}

.game-disabled .clickable-die,
.game-disabled .clickable-chips,
.game-disabled .clickable-crown {
  cursor: default;
}

/* ========================================
   GAME LAUNCH BUTTON STYLES
======================================== */
.start-minigame-button-wrapper {
  margin: clamp(8px, 2vw, 16px) 0;
  padding: clamp(12px, 2vw, 20px);
  background: linear-gradient(135deg, #3b2a26 0%, #2b1a17 100%);
  border: 2px solid #997c54;
  border-radius: 8px;
  font-family: 'Garamond', serif;
}

.crown-caste-game-info {
  margin-bottom: clamp(8px, 1.5vw, 12px);
  text-align: center;
}

.crown-caste-game-info h4 {
  color: #ffe98a;
  font-size: clamp(1.1em, 2vw, 1.3em);
  margin: 0 0 clamp(6px, 1vw, 8px) 0;
  font-weight: bold;
}

.game-details {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: clamp(8px, 1.5vw, 12px);
  margin-bottom: clamp(6px, 1vw, 8px);
}

.game-details span {
  color: #f0e6d2;
  font-size: clamp(0.8em, 1.3vw, 0.9em);
  display: flex;
  align-items: center;
  gap: 4px;
}

.stakes-level {
  font-weight: bold;
  color: #d4b26e;
}

.buy-in {
  color: #ffe98a;
}

.players {
  color: #c2a96b;
}

.house-rules-display {
  font-size: clamp(0.7em, 1.1vw, 0.8em);
  color: #a9864c;
  font-style: italic;
  margin-top: clamp(4px, 0.8vw, 6px);
  padding: clamp(4px, 0.8vw, 6px);
  background: rgba(0, 0, 0, 0.3);
  border-radius: 4px;
}

.start-minigame-button {
  width: 100%;
  background: linear-gradient(135deg, #705234 0%, #5a3f28 100%);
  color: #f0e6d2;
  font-family: inherit;
  border: 2px solid #c2a96b;
  padding: clamp(8px, 1.5vw, 12px) clamp(16px, 3vw, 24px);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.9em, 1.5vw, 1.1em);
  font-weight: bold;
  transition: all 0.3s ease;
}

.start-minigame-button:hover:not(:disabled) {
  background: linear-gradient(135deg, #8b6c45 0%, #6d4f35 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.start-minigame-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #444;
  border-color: #666;
  color: #999;
}

.minigame-warning {
  color: #ff6b6b;
  font-size: clamp(0.7em, 1.1vw, 0.8em);
  text-align: center;
  margin: clamp(6px, 1vw, 8px) 0 0 0;
  font-style: italic;
}

@media (max-width: 768px) {
  .game-details {
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  
  .start-minigame-button-wrapper {
    margin: 12px 0;
    padding: 16px;
  }
}

/* ========================================
   CUSTOM TOOLTIP STYLE (data-tooltip)
   (Scoped to prevent layout collisions)
======================================== */
.tooltip-parent {
  position: relative;
}

.tooltip-parent[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  background: rgba(0, 0, 0, 0.8);
  color: #f0e6d2;
  font-size: 0.75em;
  padding: 4px 6px;
  border-radius: 4px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 10;
  margin-bottom: 6px;
}

.tooltip-parent[data-tooltip]:hover::after {
  opacity: 1;
}

/* ========================================
   DICE ROLLING ANIMATION
======================================== */
.rolling {
  animation: dice-roll 0.1s infinite;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
  background-size: 400% 400%;
  animation: dice-roll 0.1s infinite, rainbow-bg 0.5s infinite;
  color: #fff !important;
  font-weight: bold;
  transform: scale(1.1);
  box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
}

@keyframes dice-roll {
  0%, 100% { transform: scale(1.1) rotate(0deg); }
  25% { transform: scale(1.15) rotate(2deg); }
  50% { transform: scale(1.1) rotate(0deg); }
  75% { transform: scale(1.15) rotate(-2deg); }
}

@keyframes rainbow-bg {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Crown dice rolling animation */
.crown-die.rolling {
  animation: crown-dice-roll 0.1s infinite;
  background: linear-gradient(45deg, #ffd700, #ffed4e, #f39c12, #e67e22);
  background-size: 400% 400%;
  animation: crown-dice-roll 0.1s infinite, gold-bg 0.5s infinite;
  color: #2c3e50 !important;
  font-weight: bold;
  transform: scale(1.1);
  box-shadow: 0 0 25px rgba(255, 215, 0, 0.9);
}

@keyframes crown-dice-roll {
  0%, 100% { transform: scale(1.1) rotate(0deg); }
  25% { transform: scale(1.15) rotate(3deg); }
  50% { transform: scale(1.1) rotate(0deg); }
  75% { transform: scale(1.15) rotate(-3deg); }
}

@keyframes gold-bg {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ========================================
   NEXT GAME PANEL STYLES
======================================== */
#next-game-panel {
  position: absolute;
  bottom: clamp(8px, 2vw, 12px);
  left: 50%;
  transform: translateX(-50%);
  background: #3b2a26;
  border: 2px solid #997c54;
  padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 20px);
  border-radius: 8px;
  z-index: 5;
  text-align: center;
}

.next-game-title {
  font-weight: bold;
  font-size: clamp(0.9em, 1.5vw, 1.1em);
  color: #ffe98a;
  margin-bottom: clamp(6px, 1vw, 8px);
}

.next-game-controls {
  display: flex;
  justify-content: center;
}

.next-game-button {
  background: linear-gradient(135deg, #d4af37, #b8941f);
  color: white;
  font-family: inherit;
  border: 2px solid #ffd700;
  padding: clamp(6px, 1vw, 8px) clamp(12px, 2vw, 16px);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.8em, 1.2vw, 0.9em);
  font-weight: bold;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.next-game-button:hover {
  background: linear-gradient(135deg, #e6c547, #c9a429);
  transform: translateY(-1px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}

.next-game-button:active {
  transform: translateY(0);
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* ========================================
   GAME RESULT MODAL STYLES
======================================== */
.game-result-modal {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  font-family: 'Garamond', serif;
}

.result-content {
  background: linear-gradient(135deg, #3b2a26 0%, #2b1a17 100%);
  border: 3px solid #d4b26e;
  border-radius: 12px;
  padding: clamp(20px, 4vw, 30px);
  text-align: center;
  max-width: clamp(280px, 80vw, 400px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
  animation: modalSlideIn 0.4s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.8) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.result-header {
  font-size: clamp(1.4em, 3vw, 1.8em);
  font-weight: bold;
  color: #ffe98a;
  margin-bottom: clamp(12px, 2vw, 16px);
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.result-message {
  font-size: clamp(1em, 2vw, 1.2em);
  color: #f0e6d2;
  line-height: 1.4;
  margin-bottom: clamp(16px, 3vw, 20px);
  white-space: pre-line;
}

.result-close-btn {
  background: linear-gradient(135deg, #705234 0%, #5a3f28 100%);
  color: #f0e6d2;
  font-family: inherit;
  border: 2px solid #c2a96b;
  padding: clamp(8px, 1.5vw, 12px) clamp(16px, 3vw, 24px);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.9em, 1.5vw, 1.1em);
  font-weight: bold;
  transition: all 0.3s ease;
  min-width: clamp(80px, 20vw, 120px);
}

.result-close-btn:hover {
  background: linear-gradient(135deg, #8b6c45 0%, #6d4f35 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.result-close-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

/* Mobile optimizations for result modal */
@media (max-width: 768px) {
  .result-content {
    padding: 16px 20px;
    margin: 10px;
  }
  
  .result-header {
    font-size: 1.3em;
    margin-bottom: 10px;
  }
  
  .result-message {
    font-size: 0.95em;
    margin-bottom: 14px;
  }
  
  .result-close-btn {
    padding: 8px 16px;
    font-size: 0.9em;
  }
}

@media (max-width: 480px) {
  .result-content {
    padding: 12px 16px;
    margin: 8px;
  }
  
  .result-header {
    font-size: 1.2em;
    margin-bottom: 8px;
  }
  
  .result-message {
    font-size: 0.9em;
    margin-bottom: 12px;
  }
  
  .result-close-btn {
    padding: 6px 12px;
    font-size: 0.85em;
  }
}
/* twine-user-stylesheet #7: "dialoguestyles.css" */
/* =============================
=      Conversation Styles     =
============================= */

#text-backdrop.in-dialogue {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: stretch;
  width: 100%;
  height: 100%;
  box-sizing: border-box;
}

#convoLayoutContainer {
  display: flex;
  flex-direction: row;
  flex: 1;
  gap: 1em;
  width: 100%;
  height: 100%;
  overflow: hidden;
  box-sizing: border-box;
}

#convoChoicesPanel {
  flex: 0 0 30%;
  max-width: 30%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  overflow-y: auto;
  box-sizing: border-box;
}

#convoBoxPanel {
  flex: 1;
  max-width: 70%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  overflow-y: auto;
  overflow-x: hidden;
  box-sizing: border-box;
}

#convoBox {
  padding: 1em;
  margin: 0;
  background: rgba(255, 255, 255, 0.01);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 0.5em;
  color: #eee;
  font-size: 1rem;
  flex-grow: 1;
  overflow-y: auto;
  overflow-x: hidden;
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  scroll-padding-bottom: 2em;
}

#convoChoices {
  padding-left: 1em;
  margin-top: 1em;
}

#convoChoices p {
  margin: 0.5em 0;
}

#convoChoices a.link-internal {
  color: #a0e0ff;
  text-decoration: none;
  cursor: pointer;
  font-weight: bold;
}

#convoChoices a.link-internal:hover {
  text-decoration: underline;
}

/* =============================
=     Dialogue Choice Style    =
============================= */

.dialogue-choice {
  color: #9feaff;
  text-shadow: 1px 1px 2px #000;
  padding: 4px 8px;
  margin: 6px 0;
  transition: color 0.2s ease;
  cursor: pointer;
}

.dialogue-choice:hover {
  color: #ffffff;
  text-shadow: 1px 1px 3px #00c8ff;
}

.dialogue-choice.locked {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

/* =============================
=     Minigame Button Styles   =
============================= */

.start-minigame-button-wrapper {
  text-align: center;
  margin-top: 1.5em;
}

.start-minigame-button {
  background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
  color: #eee;
  font-size: 1.1em;
  font-weight: bold;
  padding: 0.75em 2em;
  border: 2px solid #777;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
  transition: all 0.25s ease;
  cursor: pointer;
  text-shadow: 0 1px 1px rgba(0,0,0,0.5);
  letter-spacing: 0.5px;
}

.start-minigame-button:hover {
  background: linear-gradient(145deg, #4a1f1f, #2e0e0e);
  border-color: #a33;
  color: #ffdcdc;
  box-shadow: 0 0 15px rgba(255, 64, 64, 0.4);
  transform: scale(1.05);
}

.start-minigame-button:active {
  transform: scale(0.98);
  box-shadow: 0 0 5px rgba(255, 64, 64, 0.5);
}

/* =============================
=       Conversation States    =
============================= */

.faded-entry {
  opacity: 0.6;
  transition: opacity 0.3s ease;
}

.active-entry {
  opacity: 1;
}

.dialogue-divider {
  width: 60%;
  height: 1px;
  background: linear-gradient(to right, transparent, #888, transparent);
  margin: 1em auto;
  opacity: 0.4;
}

/* =============================
=      Mobile Device Tweaks    =
============================= */

body.mobile-device #convoBoxPanel {
  padding: 0.5em;
}

body.mobile-device #convoChoicesPanel {
  padding: 0.5em;
}

body.mobile-device #convoBox {
  font-size: 0.95rem;
  padding: 0.75em 1em;
  min-height: 6em;
}

body.mobile-device .dialogue-choice {
  font-size: 1rem;
  padding: 6px 12px;
}

body.mobile-device #convoChoices {
  padding-left: 0.5em;
  margin-top: 0.5em;
}

body.portrait #convoLayoutContainer {
  gap: 14px;
}

body.landscape #convoLayoutContainer {
  gap: 20px;
  height: 100vh;
}

body.reduced-motion * {
  transition: none !important;
  animation: none !important;
}
/* twine-user-stylesheet #8: "inventory.css" */
/* =============================
=         Inventory UI         =
============================= */

/* Fullscreen dark overlay */
.inventory-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(26, 26, 26, 0.95);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Inner window panel */
.inventory-window {
    width: 98vw;
    height: 92vh;
    background-color: #1a1a1a;
    border: 1px solid #a18348;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* Top-level flex layout */
.inventory-flex {
    flex: 1;
    display: flex;
    flex-direction: row;
    gap: 15px;
    overflow: hidden;
}

/* Left / Right panel widths */
.inventory-left-panel {
    flex: 3 1 0%;
    min-width: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.inventory-content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: row;
    gap: 12px;
    overflow-y: auto;
}

/* Scrollbar styling (Chrome, Edge, Safari) */
.inventory-content-wrapper::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
.inventory-content-wrapper::-webkit-scrollbar-thumb {
    background-color: #555;
    border-radius: 4px;
}
.inventory-content-wrapper::-webkit-scrollbar-track {
    background-color: transparent;
}
/* Firefox scrollbar */
.inventory-content-wrapper {
    scrollbar-width: thin;
    scrollbar-color: #555 transparent;
}

.inventory-list-container {
    flex: 1.1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.inventory-right-panel {
    flex: 1 1 100px;
    max-width: 300px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
}

/* Divider */
.inventory-divider {
    width: 2px;
    background-color: #555;
}

/* Close button */
.inventory-close-btn {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 1.4em;
    background: none;
    border: none;
    color: #eee;
    cursor: pointer;
}
.inventory-close-btn:hover {
    color: #f88;
}

/* Tabs */
.inventory-tabs {
    display: flex;
    gap: 6px;
}
.inventory-tabs button {
    background-color: #333;
    color: #eee;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 8px;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.inventory-tabs button:hover {
    background-color: #555;
}
.inventory-tabs .lucide {
    width: 20px;
    height: 20px;
}

/* Inventory table */
.inventory-list {
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 5px;
    overflow-y: auto;
    flex: 1;
}

#inventory-table {
    width: 100%;
    border-collapse: collapse;
}

#inventory-table th,
#inventory-table td {
    text-align: center;
    padding: 6px;
    font-size: 0.85em;
    border-bottom: 1px solid #444;
    color: #ddd;
}

/* Clickable inventory rows */
.inventory-row {
	cursor: pointer;
	position: relative; /* Required for z-index to apply */
	z-index: 10;
	transition: background-color 0.2s ease-in-out;
}

.inventory-row:hover {
	background-color: #3a3a3a;
}

.inventory-row.selected {
	background-color: #555;
}


/* Selected item info */
.inventory-details {
    flex: 1;
    min-width: 250px;
    max-height: 100%;
    background-color: #1f1f1f;
    border: 1px solid #555;
    border-radius: 5px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#inventory-item-image {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    background-color: #333;
    border: 1px solid #666;
}
.inventory-description,
.inventory-flavor,
.inventory-info {
    font-size: 0.85em;
    color: #ccc;
}

/* Button grid */
.inventory-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: space-between;
}
.inventory-buttons button {
    flex: 1 0 calc(33% - 10px);
    font-size: 0.8em;
    padding: 6px;
    border: none;
    border-radius: 5px;
    background-color: #444;
    color: #fff;
    cursor: pointer;
}
.inventory-buttons button:hover {
    background-color: #666;
}

/* =============================
=       Paperdoll Layout       =
============================= */

.paperdoll-layout {
    display: flex;
    flex-direction: row;
    gap: 16px;
    align-items: flex-start;
    justify-content: flex-start;
    flex-wrap: nowrap;
  }
  
  /* Main silhouette */
  .paperdoll {
    position: relative;
    width: 200px;
    min-width: 200px;
    height: 400px;
    background-image: url('images/paperdoll_generic_silhouette.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border: 1px solid #555;
    border-radius: 5px;
    flex-shrink: 0;
  }
  
  /* Slot base */
  .paperdoll-slot {
    width: 48px;
    height: 48px;
    box-sizing: border-box;
    padding: 0;
    margin: 0;
    line-height: 1;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid #888;
    color: #fff;
    font-size: 0.7em;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 5px;
    pointer-events: none;
  }
  
  /* Position silhouette slots absolutely */
  .paperdoll .paperdoll-slot {
    position: absolute;
  }
  
  /* Paperdoll slot positions */
  .paperdoll-slot[data-slot="head"]     { top: 8%;   left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="chest"]    { top: 25%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="gloveL"]   { top: 28%;  left: 8%; }
  .paperdoll-slot[data-slot="gloveR"]   { top: 28%;  right: 8%; }
  .paperdoll-slot[data-slot="main"]     { top: 45%;  left: 4%; }
  .paperdoll-slot[data-slot="sec"]      { top: 45%;  right: 4%; }
  .paperdoll-slot[data-slot="pants"]    { top: 60%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="feet"]     { top: 78%;  left: 50%; transform: translateX(-50%); }
  
  /* Right-hand column */
  .paperdoll-right-column {
    display: flex;
    flex-direction: column;
    gap: 10px;
    justify-content: flex-start;
    flex-shrink: 0;
  }
  
  .paperdoll-right-column .paperdoll-slot {
    position: static;
    width: 48px;
    height: 48px;
    font-size: 0.75em;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid #888;
    color: #fff;
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  /* =============================
  =    Condensed Paperdoll Mode  =
  ============================= */
  
  .paperdoll-condensed {
    display: none;
  }
  
  /* Switch to condensed view earlier */
@media (max-width: 950px) {
    .paperdoll-layout {
      display: none;
    }
  
    .paperdoll-condensed {
        display: block;
        max-height: none;
        overflow-y: visible;
        padding: 1em;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0.5em;
        font-size: 0.9em;
        line-height: 1.5em;
        width: 100%;
    }
  
    .paperdoll-condensed div {
      margin-bottom: 0.5em;
    }
  }
  
/* twine-user-stylesheet #9: "journal-styles.css" */
/* =============================
=      Journal Overlay Styles      
============================= */

/* Journal-specific styles */
.journal-overlay {
  width: 90vw;
  max-width: 1200px;
  height: 85vh;
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  border: 2px solid #4a90e2;
  border-radius: 12px;
  position: relative;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.journal-close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid #666;
  color: #fff;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 13px;
  z-index: 10;
  transition: all 0.2s ease;
}

.journal-close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  color: #4a90e2;
}

.journal-header {
  padding: 20px 30px;
  border-bottom: 1px solid #333;
  background: rgba(0, 0, 0, 0.3);
}

.journal-header h2 {
  margin: 0;
  color: #4a90e2;
  font-size: 1.5em;
  display: flex;
  align-items: center;
  gap: 10px;
}

.journal-tabs {
  display: flex;
  background: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid #333;
  padding: 0 20px;
}

.journal-tab {
  background: none;
  border: none;
  color: #ccc;
  padding: 15px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
  transition: all 0.2s ease;
  border-bottom: 3px solid transparent;
}

.journal-tab:hover {
  color: #4a90e2;
  background: rgba(74, 144, 226, 0.1);
}

.journal-tab.active {
  color: #4a90e2;
  border-bottom-color: #4a90e2;
  background: rgba(74, 144, 226, 0.15);
}

.journal-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.journal-tab-content {
  display: none;
}

.journal-tab-content.active {
  display: block;
}


/* Quest styles */
.quest-section {
  margin-bottom: 30px;
}

.quest-section h3 {
  color: #4a90e2;
  margin-bottom: 15px;
  font-size: 1.1em;
}

.quest-item {
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 10px;
}

.quest-item.completed {
  opacity: 0.7;
  border-color: #4a90e2;
}

.quest-title {
  font-weight: bold;
  color: #fff;
  margin-bottom: 5px;
}

.quest-description {
  color: #ccc;
  font-size: 0.9em;
  margin-bottom: 10px;
}

.quest-objectives {
  font-size: 0.8em;
}

.objective {
  color: #999;
  margin-bottom: 3px;
}

.objective.completed {
  color: #4a90e2;
}

/* Relationship styles */
.relationship-item {
  display: flex;
  gap: 15px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 10px;
}

.character-portrait img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 2px solid #4a90e2;
}

.character-name {
  font-weight: bold;
  color: #fff;
  margin-bottom: 5px;
}

.character-relationship {
  color: #4a90e2;
  font-size: 0.9em;
  margin-bottom: 5px;
}

.character-notes {
  color: #ccc;
  font-size: 0.8em;
}

/* Codex styles */
.codex-category {
  margin-bottom: 25px;
}

.codex-category h4 {
  color: #4a90e2;
  margin-bottom: 10px;
  font-size: 1em;
}

.codex-entry {
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 8px;
}

.entry-title {
  font-weight: bold;
  color: #fff;
  margin-bottom: 5px;
}

.entry-description {
  color: #ccc;
  font-size: 0.9em;
}

/* Responsive design */
@media (max-width: 768px) {
  .journal-overlay {
    width: 95vw;
    height: 90vh;
  }
  
  .journal-tabs {
    overflow-x: auto;
  }
  
  .journal-tab span {
    display: none;
  }
  
  .legend-items {
    grid-template-columns: 1fr;
  }
}
/* twine-user-stylesheet #10: "layout.css" */
/* =============================
=     Custom Sidebar Layout    =
============================= */
#custom-sidebar {
	display: block;
	position: fixed;
	top: 0;
	left: 0;
	width: 260px;
	height: 100%;
	padding: 10px;
	background: url('https://www.transparenttextures.com/patterns/dark-leather.png'), #1a1a1a;
	background-blend-mode: overlay;
	background-size: 200px 200px;
	overflow-y: auto;
	border-right: 2px solid #3a3a3a;
	box-shadow: 2px 0 5px rgba(0,0,0,0.4);
	z-index: 1000;
	transition: transform 0.3s ease;
}

#passages {
	margin-left: 280px;
	padding: 20px;
	max-width: 900px;
}

/* =========================
=   Sidebar Toggle Button  =
========================= */
#sidebar-toggle {
	position: fixed;
	top: 10px;
	left: 260px;
	background: #222;
	color: white;
	border: 1px solid #888;
	padding: 4px 6px;
	cursor: pointer;
	z-index: 1100;
	font-family: 'Cinzel', serif;
	font-size: 1.2em;
	border-radius: 0 4px 4px 0;
	transition: left 0.3s ease;
}

#custom-sidebar.collapsed + #sidebar-toggle {
	left: 40px;
}

#sidebar-toggle svg {
	width: 20px;
	height: 20px;
	stroke: white;
}
/* twine-user-stylesheet #11: "maintext.css" */
/* =============================
=     Main Text Presentation   =
============================= */

/* === Responsive Font + Padding Adjustments === */
@media screen and (max-width: 800px) {
  #text-backdrop {
    padding: 1.5rem;
    font-size: 1rem;
  }
}
@media screen and (max-width: 600px) {
  #text-backdrop {
    padding: 1rem;
    font-size: 0.95rem;
  }
}
@media screen and (max-width: 500px) {
  #text-backdrop {
    padding: 0.75rem;
    font-size: 0.9rem;
  }
}

/* === Base HTML & Body === */
html, body {
  height: 100%;
  overflow: hidden;
  margin: 0;
  padding: 0;
}

/* === Main Text Container === */
#text-container {
  position: fixed;
  top: 0;
  left: 0;
  width: calc(100vw - 300px);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1;
  pointer-events: none;
  padding: 1rem;
  box-sizing: border-box;
  transition: margin-left 0.3s ease;
}

/* === Sidebar Collapsed/Expanded Adjustments === */
body.sidebar-collapsed #text-container {
  margin-left: 60px;
  width: calc(100vw - 60px);
}

body:not(.sidebar-collapsed) #text-container {
  margin-left: 260px;
  width: calc(100vw - 260px);
}

/* === Text Backdrop Main Style === */
#text-backdrop {
  background-color: rgba(240, 240, 240, 0.05);
  padding: 1.1rem;
  width: 100%;
  max-width: 850px;
  min-width: 300px;
  max-height: 90vh;
  overflow-y: auto;
  overflow-x: hidden;
  border-radius: 1.5rem;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
  font-family: 'Georgia', serif;
  font-size: clamp(0.95rem, 1.2vw + 0.5rem, 1.2rem);
  line-height: 1.6;
  color: #f0f0f0;
  pointer-events: auto;
  box-sizing: border-box;
  transition: all 0.3s ease;
}

/* === Dialogue Mode (Expanding Slightly) === */
#text-backdrop.in-dialogue {
  max-width: 1200px;
  min-height: 500px;
  padding-bottom: 2%;
  padding-top: 4%;
}

/* === Text Backdrop Scrollbar Styling === */
#text-backdrop::-webkit-scrollbar {
  width: 10px;
}
#text-backdrop::-webkit-scrollbar-track {
  background: #111;
}
#text-backdrop::-webkit-scrollbar-thumb {
  background: #666;
  border-radius: 5px;
}
#text-backdrop::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* === Hidden SugarCube Passages === */
#passages {
  position: absolute;
  top: -9999px;
  left: -9999px;
  width: 1px;
  height: 1px;
  overflow: hidden;
  opacity: 0;
  pointer-events: none;
}

/* === Current Active Passage === */
.passage-in {
  opacity: 1 !important;
}

/* === Dynamic Content Container === */
#dynamic-content {
  width: 100%;
}
.overlay-close-btn {
	position: absolute;
	top: 3%;
	right: 5%;
	background: none;
	border: 2px solid #ccc;
	color: white;
	font-size: 1.2rem;
	padding: 0.2rem 0.6rem;
	cursor: pointer;
	z-index: 10;
}
/* twine-user-stylesheet #12: "map-styles.css" */
/* =============================
=         Map System Styles      
============================= */

/* =============================
=      Journal Map Section      
============================= */

/* Map-specific styles within journal */
.map-section {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.map-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.map-header h3 {
  margin: 0;
  color: #4a90e2;
}

.map-controls {
  display: flex;
  gap: 8px;
}

.map-control-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid #555;
  color: #ccc;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.map-control-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  color: #4a90e2;
}

.map-container {
  flex: 1;
  background: #0a0a0a;
  border: 1px solid #333;
  border-radius: 6px;
  overflow: auto;
  position: relative;
  min-height: 400px;
}

.map-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #666;
  text-align: center;
}

.map-placeholder i {
  font-size: 3em;
  margin-bottom: 15px;
}

/* =============================
=         Map Legend           
============================= */

.map-legend {
  margin-top: 15px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 15px;
}

.map-legend h4 {
  margin: 0 0 10px 0;
  color: #4a90e2;
  font-size: 0.9em;
}

.legend-items {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 8px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.8em;
  color: #ccc;
}

.legend-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.legend-icon.player {
  color: #4a90e2;
}

.legend-icon.tavern {
  color: #ffa500;
}

.legend-icon.shop {
  color: #32cd32;
}

.legend-icon.brothel {
  color: #ff69b4;
}

.legend-icon.gate {
  color: #8b4513;
}

.legend-transition {
  width: 20px;
  height: 3px;
  background: #4a90e2;
  border-radius: 2px;
  position: relative;
}

.legend-transition.oneway::after {
  content: '';
  position: absolute;
  right: -3px;
  top: -2px;
  width: 0;
  height: 0;
  border-left: 4px solid #4a90e2;
  border-top: 3px solid transparent;
  border-bottom: 3px solid transparent;
}

/* =============================
=         Sidebar Minimap      
============================= */

#sidebar-minimap-container {
  margin: 12px 8px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 8px;
  position: relative;
  height: 250px;
}

.minimap-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: 0.8em;
  font-weight: 600;
  color: #4a90e2;
}

.minimap-header i {
  width: 16px;
  height: 16px;
  stroke: #4a90e2;
}

.minimap-header span {
  flex: 1;
}

.minimap-control-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #555;
  color: #ccc;
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 11px;
  transition: background 0.2s ease;
}

.minimap-control-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
}

.minimap-control-btn i {
  width: 12px;
  height: 12px;
  stroke: currentColor;
}

.minimap-display {
  width: 260px;
  height: 180px;
  border: 1px solid #444;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
  background: #0a0a0a;
  padding: 2px;
}

.minimap-info {
  margin-top: 6px;
  font-size: 0.7em;
  color: #888;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.minimap-location {
  color: #4a90e2;
  font-weight: 600;
}

.minimap-position {
  color: #ccc;
}

/* =============================
=         Mobile Map UI        
============================= */

/* Mobile floating minimap */
#mobile-minimap-overlay {
  position: fixed;
  top: 10px;
  right: 10px;
  width: 180px;
  height: 140px;
  background: rgba(0, 0, 0, 0.9);
  border: 1px solid #333;
  border-radius: 8px;
  z-index: 1000;
  padding: 8px;
  display: none;
}

#mobile-minimap-overlay .minimap-display {
  width: 100%;
  height: 100px;
}

#mobile-minimap-overlay .minimap-info {
  font-size: 0.6em;
  margin-top: 4px;
}

/* Touch movement controls */
#mobile-movement-controls {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 120px;
  height: 120px;
  z-index: 1001;
  display: none;
}

.movement-dpad {
  position: relative;
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: 1fr 1fr 1fr;
  gap: 2px;
}

.movement-btn {
  background: rgba(0, 0, 0, 0.8);
  border: 1px solid #555;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.2s ease;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}

.movement-btn:active {
  background: rgba(74, 144, 226, 0.8);
  transform: scale(0.95);
}

.movement-btn.north {
  grid-column: 2;
  grid-row: 1;
}

.movement-btn.west {
  grid-column: 1;
  grid-row: 2;
}

.movement-btn.east {
  grid-column: 3;
  grid-row: 2;
}

.movement-btn.south {
  grid-column: 2;
  grid-row: 3;
}

/* =============================
=         Tile Grid System     
============================= */

/* Base tile grid - restore grid functionality */
.tile-grid {
  display: grid;
  gap: 2px;
  background: transparent;
  padding: 20px;
  border-radius: 4px;
  min-height: 400px;
  width: 100%;
  height: 100%;
}

/* Minimap grid - supports dynamic sizing */
.minimap-grid {
  display: grid;
  gap: 6px;
  padding: 8px;
  justify-content: center;
  align-content: center;
  grid-auto-flow: row;
  max-width: 100%;
  overflow: auto;
}

/* Full map grid - dynamic based on map size */
.full-map-grid {
  display: grid;
  grid-template-columns: repeat(3, 60px);
  grid-template-rows: repeat(3, 60px);
  gap: 20px;
  padding: 40px;
  justify-content: center;
  align-content: center;
  min-height: 500px;
  width: 100%;
}

/* Enhanced full map grid for larger maps */
.full-map-grid.large {
  grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
  gap: 20px;
  min-height: 700px;
  padding: 60px;
}

/* =============================
=         Tile Styling         
============================= */

/* Base tile styling */
.tile {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  overflow: visible;
}

/* Minimap tiles - compact grid layout */
.minimap-tile {
  width: 100%;
  height: 100%;
  background: #2a2a2a;
  border: 2px solid #4a90e2;
  border-radius: 12px;
  min-width: unset;
  min-height: unset;
}

/* Full map tiles - node-based styling */
.full-map-tile {
  width: 60px;
  height: 60px;
  background: #2a2a2a;
  border: 2px solid #4a90e2;
  border-radius: 16px;
  cursor: default;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Tile states */
.tile-empty {
  visibility: hidden; /* Hide empty tiles but keep grid space */
  opacity: 0;
}

.tile-node {
  background: #2a2a2a;
  border: 2px solid #4a90e2;
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  width: 48px;
  height: 48px;
}

.tile-hidden {
  visibility: hidden; /* Hide hidden tiles but keep grid space */
  opacity: 0;
}

.tile-clickable {
  cursor: pointer;
  border-color: #4a90e2;
}

.tile-clickable:hover {
  background: rgba(74, 144, 226, 0.2);
  border-color: #6bb6ff;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
}

/* =============================
=         Player Indicator     
============================= */

/* Player tile */
.player-tile {
  background: radial-gradient(circle, rgba(74, 144, 226, 0.3) 0%, rgba(74, 144, 226, 0.1) 70%) !important;
  border-color: #4a90e2 !important;
  box-shadow: 0 0 10px rgba(74, 144, 226, 0.6);
  animation: pulse 2s infinite;
}

/* Player indicator */
.player-indicator {
  color: #4a90e2;
  width: 16px;
  height: 16px;
  font-size: 1.2em;
  animation: pulse 2s infinite;
  filter: drop-shadow(0 0 3px rgba(74, 144, 226, 0.8));
}

@keyframes pulse {
  0%, 100% { 
    opacity: 1; 
    transform: scale(1);
    box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
  }
  50% { 
    opacity: 0.7; 
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(74, 144, 226, 0.8);
  }
}

/* =============================
=         Entry Points         
============================= */

.entry-point {
  border-color: #ffd700 !important;
  box-shadow: inset 0 0 5px rgba(255, 215, 0, 0.3);
}

.entry-point::before {
  content: '';
  position: absolute;
  top: 2px;
  right: 2px;
  width: 6px;
  height: 6px;
  background: #ffd700;
  border-radius: 50%;
  box-shadow: 0 0 3px rgba(255, 215, 0, 0.8);
}

/* =============================
=         Node Patterns        
============================= */

.node-pattern-diagonal-stripes {
  background-image: repeating-linear-gradient(
    45deg,
    var(--node-primary-color, #007bff),
    var(--node-primary-color, #007bff) 4px,
    var(--node-secondary-color, #6c757d) 4px,
    var(--node-secondary-color, #6c757d) 8px
  );
}

.node-pattern-vertical-stripes {
  background-image: repeating-linear-gradient(
    90deg,
    var(--node-primary-color, #007bff),
    var(--node-primary-color, #007bff) 4px,
    var(--node-secondary-color, #6c757d) 4px,
    var(--node-secondary-color, #6c757d) 8px
  );
}

.node-pattern-horizontal-stripes {
  background-image: repeating-linear-gradient(
    0deg,
    var(--node-primary-color, #007bff),
    var(--node-primary-color, #007bff) 4px,
    var(--node-secondary-color, #6c757d) 4px,
    var(--node-secondary-color, #6c757d) 8px
  );
}

.node-pattern-dots {
  background-image: radial-gradient(
    circle at 25% 25%,
    var(--node-secondary-color, #6c757d) 2px,
    transparent 2px
  );
  background-size: 8px 8px;
  background-color: var(--node-primary-color, #007bff);
}

.node-pattern-grid {
  background-image: 
    linear-gradient(var(--node-secondary-color, #6c757d) 1px, transparent 1px),
    linear-gradient(90deg, var(--node-secondary-color, #6c757d) 1px, transparent 1px);
  background-size: 8px 8px;
  background-color: var(--node-primary-color, #007bff);
}

.node-pattern-checkerboard {
  background-image: 
    linear-gradient(45deg, var(--node-secondary-color, #6c757d) 25%, transparent 25%),
    linear-gradient(-45deg, var(--node-secondary-color, #6c757d) 25%, transparent 25%),
    linear-gradient(45deg, transparent 75%, var(--node-secondary-color, #6c757d) 75%),
    linear-gradient(-45deg, transparent 75%, var(--node-secondary-color, #6c757d) 75%);
  background-size: 8px 8px;
  background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
  background-color: var(--node-primary-color, #007bff);
}

/* =============================
=         Tag-based Styling    
============================= */

.tag-interior {
  border-left: 3px solid #8b4513;
}

.tag-exterior {
  border-left: 3px solid #32cd32;
}

.tag-bastion {
  border-left: 3px solid #dc143c;
}

.tag-public {
  border-left: 3px solid #4a90e2;
}

.tag-private {
  border-left: 3px solid #ff6347;
}

.tag-restricted {
  border-left: 3px solid #ff0000;
  box-shadow: inset 0 0 5px rgba(255, 0, 0, 0.2);
}

.tag-safe {
  border-left: 3px solid #00ff00;
}

.tag-dangerous {
  border-left: 3px solid #ff4500;
  box-shadow: inset 0 0 5px rgba(255, 69, 0, 0.2);
}

/* =============================
=         Connection Lines      
============================= */

/* Base connection line styling */
.tile::before,
.tile::after {
  content: '';
  position: absolute;
  background: #4a90e2;
  opacity: 0.8;
  z-index: -1;
  border-radius: 1px;
}

/* North/South connections - vertical lines */
.tile.has-north::before {
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 30px;
  background: linear-gradient(to bottom, #4a90e2, rgba(74, 144, 226, 0.8));
}

.tile.has-south::after {
  bottom: -30px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 30px;
  background: linear-gradient(to top, #4a90e2, rgba(74, 144, 226, 0.8));
}

/* East/West connections - horizontal lines */
.tile.has-east {
  position: relative;
}

.tile.has-east::after {
  content: '';
  position: absolute;
  right: -30px;
  top: 50%;
  transform: translateY(-50%);
  width: 30px;
  height: 4px;
  background: linear-gradient(to right, rgba(74, 144, 226, 0.8), #4a90e2);
  z-index: -1;
  border-radius: 1px;
}

.tile.has-west {
  position: relative;
}

.tile.has-west::before {
  content: '';
  position: absolute;
  left: -30px;
  top: 50%;
  transform: translateY(-50%);
  width: 30px;
  height: 4px;
  background: linear-gradient(to left, rgba(74, 144, 226, 0.8), #4a90e2);
  z-index: -1;
  border-radius: 1px;
}

/* Handle nodes with both north and west connections */
.tile.has-north.has-west::before {
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 30px;
  background: linear-gradient(to bottom, #4a90e2, rgba(74, 144, 226, 0.8));
}

.tile.has-north.has-west::after {
  content: '';
  position: absolute;
  left: -30px;
  top: 50%;
  transform: translateY(-50%);
  width: 30px;
  height: 4px;
  background: linear-gradient(to left, rgba(74, 144, 226, 0.8), #4a90e2);
  z-index: -1;
  border-radius: 1px;
}

/* One-way transition styling - different colors */
.tile.oneway-north::before {
  background: linear-gradient(to bottom, #ff6b35, rgba(255, 107, 53, 0.8));
}

.tile.oneway-south::after {
  background: linear-gradient(to top, #ff6b35, rgba(255, 107, 53, 0.8));
}

.tile.oneway-east::after {
  background: linear-gradient(to right, rgba(255, 107, 53, 0.8), #ff6b35);
}

.tile.oneway-west::before {
  background: linear-gradient(to left, rgba(255, 107, 53, 0.8), #ff6b35);
}

/* Dashed lines for restricted transitions */
.tile.restricted-north::before {
  background: repeating-linear-gradient(
    to bottom,
    #ff4444,
    #ff4444 4px,
    transparent 4px,
    transparent 8px
  );
}

.tile.restricted-south::after {
  background: repeating-linear-gradient(
    to top,
    #ff4444,
    #ff4444 4px,
    transparent 4px,
    transparent 8px
  );
}

.tile.restricted-east::after {
  background: repeating-linear-gradient(
    to right,
    #ff4444,
    #ff4444 4px,
    transparent 4px,
    transparent 8px
  );
}

.tile.restricted-west::before {
  background: repeating-linear-gradient(
    to left,
    #ff4444,
    #ff4444 4px,
    transparent 4px,
    transparent 8px
  );
}

/* =============================
=         Tile Icons           
============================= */

.tile-icon {
  width: 24px;
  height: 24px;
  color: #fff;
  font-size: 1.5em;
  transition: color 0.2s ease;
  filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.8));
}

.tile-node:hover .tile-icon {
  color: #6bb6ff;
}

.minimap-tile .tile-icon {
  width: 16px;
  height: 16px;
  font-size: 1em;
}

.full-map-tile .tile-icon {
  width: 24px;
  height: 24px;
  font-size: 1.5em;
}

/* =============================
=         Special Locations    
============================= */

.tile[data-icon="beer"] {
  background: rgba(255, 165, 0, 0.1);
  border-color: #ffa500;
}

.tile[data-icon="flask-conical"] {
  background: rgba(50, 205, 50, 0.1);
  border-color: #32cd32;
}

.tile[data-icon="bed-double"] {
  background: rgba(255, 105, 180, 0.1);
  border-color: #ff69b4;
}

.tile[data-icon="crown"] {
  background: rgba(255, 215, 0, 0.1);
  border-color: #ffd700;
}

.tile[data-icon="door-open"] {
  background: rgba(139, 69, 19, 0.1);
  border-color: #8b4513;
}

.tile[data-icon="lock"] {
  background: rgba(128, 128, 128, 0.1);
  border-color: #808080;
}

/* =============================
=         Grid Overlay         
============================= */

.tile-grid.show-grid {
  background-image: 
    linear-gradient(rgba(74, 144, 226, 0.1) 1px, transparent 1px),
    linear-gradient(90deg, rgba(74, 144, 226, 0.1) 1px, transparent 1px);
  background-size: 42px 42px;
}

/* =============================
=         Minimap Overrides    
============================= */

.minimap-display .tile-grid {
  gap: 12px;
  padding: 12px;
}

.minimap-display .player-indicator {
  width: 16px;
  height: 16px;
  animation: none;
}

.minimap-display .tile-icon {
  width: 16px;
  height: 16px;
  font-size: 1em;
}

.minimap-display .tile::before,
.minimap-display .tile::after {
  opacity: 0.6;
}

.minimap-display .has-north::before,
.minimap-display .has-south::before {
  width: 2px;
  height: 8px;
  top: -8px;
}

.minimap-display .has-south::after {
  bottom: -8px;
}

.minimap-display .has-east::after,
.minimap-display .has-west::after {
  width: 8px;
  height: 2px;
}

.minimap-display .has-east::after {
  right: -8px;
}

.minimap-display .has-west::before {
  left: -8px;
}

/* =============================
=         Responsive Design    
============================= */

@media (max-width: 768px) {
  #sidebar-minimap-container {
    display: none;
  }
  
  #mobile-minimap-overlay {
    display: block;
  }
  
  #mobile-movement-controls {
    display: block;
  }
  
  .full-map-grid {
    grid-template-columns: repeat(9, 30px);
    grid-template-rows: repeat(7, 30px);
    gap: 1px;
    padding: 10px;
  }
  
  .full-map-tile {
    width: 30px;
    height: 30px;
    min-height: 35px;
    min-width: 35px;
  }
  
  .tile-icon {
    width: 12px;
    height: 12px;
    font-size: 1em;
  }
  
  .player-indicator {
    width: 14px;
    height: 14px;
  }
  
  .legend-items {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) and (orientation: portrait) {
  #mobile-minimap-overlay {
    top: 60px;
    right: 10px;
    width: 140px;
    height: 110px;
  }
  
  #mobile-minimap-overlay .minimap-display {
    height: 80px;
  }
  
  #mobile-movement-controls {
    bottom: 80px;
    right: 15px;
    width: 100px;
    height: 100px;
  }
}

@media (max-width: 480px) {
  .full-map-grid {
    grid-template-columns: repeat(9, 25px);
    grid-template-rows: repeat(7, 25px);
  }
  
  .full-map-tile {
    width: 25px;
    height: 25px;
  }
  
  .tile-icon {
    width: 10px;
    height: 10px;
  }
  
  .player-indicator {
    width: 12px;
    height: 12px;
  }
}

/* =============================
=         Collapsed Sidebar    
============================= */

#custom-sidebar.collapsed #sidebar-minimap-container {
  display: none;
}

/* =============================
=         Accessibility        
============================= */

.tile:focus {
  outline: 2px solid #4a90e2;
  outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .tile {
    border-width: 2px;
  }
  
  .tile-node {
    background: #000;
    border-color: #fff;
  }
  
  .tile-empty {
    background: #333;
    border-color: #666;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  .tile {
    transition: none;
  }
  
  .player-tile {
    animation: none;
  }
  
  .tile-clickable:hover {
    transform: none;
  }
  
  .player-indicator {
    animation: none;
  }
}
/* twine-user-stylesheet #13: "overlay.css" */
/* =============================
=         Overlay Base         =
============================= */
#overlay-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    background: url('images/parchment-bg.jpg') no-repeat center center;
    background-size: cover;
    background-color: #f4e8c1;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    border: 2px solid #8b6e47;
    max-height: 80vh;
    overflow-y: auto;
    font-family: 'Cinzel', serif;
}

#overlay-content {
    background: #111;
    color: white;
    padding: 20px;
    width: 80%;
    max-width: 800px;
    max-height: 90%;
    overflow-y: auto;
    border: 2px solid #666;
    border-radius: 8px;
    position: relative;
}

#overlay-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.1);
    color: white;
    border: none;
    font-size: 1.2em;
    cursor: pointer;
    padding: 4px 8px;
}

.overlay-hidden {
    display: none !important;
}
/* Overlay Base - End */
/* twine-user-stylesheet #14: "paperdoll.css" */
/* =============================
=       Paperdoll Layout       =
============================= */
.paperdoll {
    position: relative;
    width: auto;
    height: 90%;
    aspect-ratio: 1 / 2;
    background-image: url('images/paperdoll_generic_silhouette.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border: 1px solid #555;
    border-radius: 5px;
  }
  
  .paperdoll-slot {
    position: absolute;
    width: 48px;
    height: 48px;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid #888;
    color: #fff;
    font-size: 0.7em;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 5px;
    pointer-events: none;
  }
  
  .paperdoll-slot[data-slot="head"]     { top: 8%;   left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="face"]     { top: 8%;   right: -65px; }
  .paperdoll-slot[data-slot="necklace"] { top: 18%;  right: -65px; }
  .paperdoll-slot[data-slot="ring1"]    { top: 30%;  right: -65px; }
  .paperdoll-slot[data-slot="ring2"]    { top: 40%;  right: -65px; }
  .paperdoll-slot[data-slot="ring3"]    { top: 50%;  right: -65px; }
  .paperdoll-slot[data-slot="chest"]    { top: 25%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="gloveL"]   { top: 28%;  left: 8%; }
  .paperdoll-slot[data-slot="gloveR"]   { top: 28%;  right: 8%; }
  .paperdoll-slot[data-slot="main"]     { top: 45%;  left: 4%; }
  .paperdoll-slot[data-slot="sec"]      { top: 45%;  right: 4%; }
  .paperdoll-slot[data-slot="pants"]    { top: 60%;  left: 50%; transform: translateX(-50%); }
  .paperdoll-slot[data-slot="feet"]     { top: 78%;  left: 50%; transform: translateX(-50%); }
  
/* twine-user-stylesheet #15: "people-styles.css" */
.people-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    gap: 1rem;
}

.location-info {
    background: rgba(0, 0, 0, 0.3);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.location-name {
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
}

.location-population {
    font-size: 0.9rem;
    color: #ccc;
    margin-top: 0.25rem;
}

.people-filters {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-group label {
    font-size: 0.9rem;
    color: #ccc;
}

.filter-group select {
    padding: 0.25rem 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    font-size: 0.9rem;
}

.people-list {
    flex: 1;
    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem;
    padding: 0.5rem;
}

.person-card {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.person-card:hover {
    background: rgba(0, 0, 0, 0.6);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-2px);
}

.person-card.selected {
    border-color: #4a9eff;
    background: rgba(74, 158, 255, 0.1);
}

.person-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.person-card-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.person-card-name {
    font-weight: bold;
    color: #fff;
    font-size: 1rem;
}

.person-card-description {
    font-size: 0.85rem;
    color: #ccc;
    line-height: 1.3;
}

.person-card-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    font-size: 0.8rem;
}

.relationship-indicator {
    display: flex;
    gap: 0.25rem;
}

.relationship-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #666;
}

.relationship-dot.positive { background: #4CAF50; }
.relationship-dot.negative { background: #f44336; }
.relationship-dot.neutral { background: #666; }

.archetype-tag {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    color: #ccc;
}

.person-details {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.person-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.person-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.person-name {
    color: #fff;
    margin: 0 0 0.5rem 0;
    font-size: 1.4rem;
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
}

.pronouns {
    font-size: 0.9rem;
    color: #999;
    font-weight: normal;
}

.person-description {
    color: #ccc;
    font-size: 0.95rem;
    line-height: 1.4;
}

.relationship-section h4,
.known-info h4 {
    color: #fff;
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding-bottom: 0.5rem;
}

.relationship-meters {
    display: grid;
    gap: 0.75rem;
}

.meter-row {
    display: grid;
    grid-template-columns: 80px 1fr 40px;
    align-items: center;
    gap: 0.75rem;
}

.meter-label {
    font-size: 0.9rem;
    color: #ccc;
    text-align: right;
}

.meter-bar {
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
}

.meter-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.3s ease;
    position: relative;
}

.trust-meter { background: linear-gradient(90deg, #2196F3, #4CAF50); }
.affection-meter { background: linear-gradient(90deg, #E91E63, #FF5722); }
.rapport-meter { background: linear-gradient(90deg, #9C27B0, #673AB7); }
.tension-meter { background: linear-gradient(90deg, #FF9800, #F44336); }

.meter-value {
    font-size: 0.85rem;
    color: #fff;
    text-align: center;
    font-weight: bold;
}

.info-grid {
    display: grid;
    gap: 0.75rem;
}

.info-item {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    border-left: 3px solid #4a9eff;
}

.info-item strong {
    color: #fff;
}

.person-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.btn-primary, .btn-secondary, .btn-danger {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background: #4a9eff;
    color: white;
}

.btn-primary:hover {
    background: #357abd;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: #ccc;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-danger:hover {
    background: #d32f2f;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #ccc;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    color: #fff;
    margin-bottom: 1rem;
}

.debug-info {
    margin-top: 1.5rem;
    padding: 1rem;
    background: rgba(255, 0, 0, 0.1);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
}

.debug-info h4 {
    color: #ff6b6b;
    margin: 0 0 0.75rem 0;
    font-size: 0.9rem;
}

.debug-details {
    display: grid;
    gap: 0.25rem;
    font-size: 0.8rem;
    font-family: monospace;
}

.debug-details strong {
    color: #ff9999;
}

.empty-state-hint {
    font-size: 0.85rem;
    color: #999;
    font-style: italic;
    margin-top: 0.5rem;
}

/* Hover effects for better interactivity */
.person-card-avatar {
    transition: transform 0.2s ease, border-color 0.2s ease;
}

.person-card:hover .person-card-avatar {
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.5);
}

/* Improved filter styling */
.people-filters select {
    cursor: pointer;
    transition: border-color 0.2s ease, background-color 0.2s ease;
}

.people-filters select:hover {
    border-color: rgba(255, 255, 255, 0.5);
    background-color: rgba(0, 0, 0, 0.7);
}

.people-filters select:focus {
    outline: none;
    border-color: #4a9eff;
    box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.3);
}

/* Refresh button animation */
#refresh-people span {
    display: inline-block;
    transition: transform 0.3s ease;
}

#refresh-people:hover span {
    transform: rotate(180deg);
}

#refresh-people:active span {
    transform: rotate(360deg);
}

/* Improved relationship dots */
.relationship-dot {
    position: relative;
    cursor: help;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.relationship-dot:hover {
    transform: scale(1.3);
    box-shadow: 0 0 8px currentColor;
}

/* Meter animations */
.meter-fill {
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Action button improvements */
.person-actions button {
    position: relative;
    overflow: hidden;
}

.person-actions button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.3s ease, height 0.3s ease;
}

.person-actions button:hover::before {
    width: 100%;
    height: 100%;
}

/* Loading state */
.people-list.loading {
    opacity: 0.5;
    pointer-events: none;
}

.people-list.loading::after {
    content: 'Loading...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.2rem;
    color: #fff;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .people-list {
        grid-template-columns: 1fr;
    }
    
    .person-header {
        flex-direction: column;
        text-align: center;
    }
    
    .person-actions {
        justify-content: center;
    }
    
    .meter-row {
        grid-template-columns: 60px 1fr 30px;
        gap: 0.5rem;
    }
    
    .people-filters {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-group {
        width: 100%;
    }
    
    .filter-group select {
        width: 100%;
    }
}

/* Accessibility improvements */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .person-card {
        border-width: 2px;
    }
    
    .relationship-dot {
        border: 1px solid #fff;
    }
    
    .meter-bar {
        border: 1px solid #fff;
    }
}
/* twine-user-stylesheet #16: "sexscene-styles.css" */
/* ==============================
   🌶️ Sex Scene Layout
============================== */
#text-backdrop.in-sexscene #sexSceneLayoutContainer {
	display: flex;
	flex-direction: column;
	gap: 20px;
	width: 100%;
	height: 100%;
	box-sizing: border-box;
}

#sexSceneFeedbackPanel {
	flex: 0 0 auto;
	max-height: 25vh;
	overflow-y: auto;
	padding: 1em;
	border: 1px solid rgba(255, 255, 255, 0.1);
	border-radius: 8px;
	background: rgba(255, 255, 255, 0.02);
	color: #eee;
	font-size: 1rem;
}

#sexSceneActionsPanel {
	flex: 1 1 auto;
	overflow-y: auto;
	padding: 1em;
	border-radius: 6px;
	background: rgba(0, 0, 0, 0.2);
	color: #ccc;
}

.sexscene-group {
	margin-bottom: 0.5rem; /* reduce group spacing */
	padding-bottom: 0.5rem;
}

.sexscene-group h3 {
	font-size: 1rem; /* was probably 1.25rem+ before */
	margin-bottom: 0.15rem;
	margin-top: 0.5rem;
	line-height: 1.2;
	letter-spacing: 0.5px;
}


#sexSceneActionsBox button {
	margin: 0px;
	padding: 0.2em 0.5em;
	font-size: 0.95rem;
	border: 1px solid #777;
	border-radius: 10px;
	background: #2e2e2e;
	color: #fff;
	cursor: pointer;
	transition: all 0.2s ease;
}

#sexSceneActionsBox button:hover {
	background-color: #444;
}

button.active-sexact {
	color: white;
}

button.active-sexact.pending {
  box-shadow: 0 0 6px #fff;
}

/* 🌈 Smooth animated conic ring for ongoing sex acts */
@property --gradient-angle {
  syntax: "<angle>";
  initial-value: 0deg;
  inherits: false;
}

button.active-sexact.ongoing {
  position: relative;
  color: white;
  background: #2e2e2e; /* Static inner fill */
  border: 2px solid transparent;
  border-radius: 10px;
  z-index: 0;
  overflow: hidden;
}

button.active-sexact.ongoing::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  padding: 2px; /* Border thickness */
  background: conic-gradient(
    from var(--gradient-angle),
    #222222,
    #585858,
    #1b1b1b,
    #dbdbdb,
    #aaaaaa
  );
  animation: rotation 6s linear infinite;
  mask: 
    linear-gradient(#fff 0 0) content-box, 
    linear-gradient(#fff 0 0); 
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  z-index: -1;
}

button.active-sexact.ongoing::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  padding: 2px;
  background: conic-gradient(
    from var(--gradient-angle),
    #222222,
    #585858,
    #1b1b1b,
    #dbdbdb,
    #aaaaaa,
  );
  animation: rotation 6s linear infinite;

  /* Glow settings */
  filter: blur(12px);
  opacity: 0.45;
  z-index: -2;

  /* Ensure it shows outside the button's shape */
  mask: none;
  -webkit-mask: none;
  pointer-events: none;
}

@keyframes rotation {
  0% {
    --gradient-angle: 0deg;
  }
  100% {
    --gradient-angle: 360deg;
  }
}

#sexSceneFooterButtons {
	display: flex;
	justify-content: space-between;
	gap: 1rem;
	margin-top: 2em;
}

@media (min-width: 768px) {
	#sexSceneFooterButtons {
		gap: 2rem;
	}
}

#sexSceneContinueButton,
#sexSceneEndButton {
	flex: 1 1 auto;
}
/* twine-user-stylesheet #17: "shop-styles.css" */
/* =============================
   SHOP OVERLAY LAYOUT
============================= */
.shop-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(26, 26, 26, 0.95);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .shop-window {
    width: 98vw;
    height: 92vh;
    background-color: #1a1a1a;
    border: 1px solid #a18348;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .inventory-dual-panel {
    display: flex;
    gap: 15px;
    flex: 1;
    overflow: hidden;
  }
  
  .inventory-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #1a1a1a;
    border: 1px solid #a18348;
    border-radius: 10px;
    padding: 10px;
    gap: 10px;
  }
  
  .inventory-header {
    font-size: 1.4em;
    font-weight: bold;
    color: #ddd;
    text-align: center;
  }
  
  .inventory-tabs {
    display: flex;
    gap: 6px;
  }
  
  .inventory-tabs button {
    background-color: #333;
    color: #eee;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 8px;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  
  .inventory-tabs button:hover {
    background-color: #555;
  }
  
  .inventory-list {
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 5px;
    overflow-y: auto;
    flex: 1;
  }
  
  .inventory-list table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .inventory-list th,
  .inventory-list td {
    text-align: center;
    padding: 6px;
    font-size: 0.85em;
    border-bottom: 1px solid #444;
    color: #ddd;
  }
  
  .inventory-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1em;
    color: #eee;
  }
  
  .sell-button,
  .buy-button {
    padding: 6px 12px;
    font-size: 0.9em;
    background-color: #444;
    color: white;
    border: 1px solid #888;
    border-radius: 5px;
    cursor: pointer;
  }
  
  .sell-button:hover,
  .buy-button:hover {
    background-color: #666;
  }
  
  .gold-change {
    margin-left: 5px;
    font-weight: bold;
  }
  
  .gold-change.positive {
    color: #0f0;
  }
  
  .gold-change.negative {
    color: #f55;
  }
  
  /* =============================
     CONFIRM BUTTON STYLING
  ============================= */
  .shop-confirm-row {
    display: flex;
    justify-content: flex-end;
    padding-top: 10px;
  }
  
  .confirm-button {
    padding: 10px 18px;
    font-size: 1em;
    font-weight: bold;
    background-color: #4a773c;
    color: white;
    border: 1px solid #6fa45b;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }
  
  .confirm-button:hover {
    background-color: #5d8f4b;
  }
  
/* twine-user-stylesheet #18: "sidebar.css" */
/* =============================
=        Sidebar Main         
============================= */
#custom-sidebar {
	background: #111;
	color: white;
	display: flex;
	flex-direction: column;
	position: relative;
	width: 300px;
	transition: width 0.4s ease;
	overflow: auto;
	border-right: 2px solid #333;
	padding-bottom: 1%;
}

/* =============================
=       Sidebar Topbar        
============================= */
#sidebar-topbar {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 4px 4px;
	background: #222;
	border-bottom: 1px solid #444;
}

#sidebar-nav {
	display: flex;
	gap: 6px;
}

.sidebar-nav-btn {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	color: white;
	padding: 2px 4px;
	border-radius: 4px;
	cursor: pointer;
	transition: background 0.2s ease;
}

.sidebar-nav-btn:hover {
	background: rgba(255,255,255,0.15);
}

#sidebar-toggle {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	cursor: pointer;
	color: white;
	padding: 4px;
	border-radius: 4px;
	display: flex;
	align-items: center;
	justify-content: center;
	width: 36px;
	height: 36px;
	min-width: 36px;
	min-height: 36px;
}

#sidebar-arrow {
	pointer-events: none;
}

/* =============================
=      Sidebar Top Info       
============================= */
#sidebar-top-info {
  display: flex;
  flex-direction: column;
  padding: 4px 8px;
  gap: 4px;
  background: #181818;
  border-bottom: 1px solid #333;
  font-size: 0.8em;
}

#sidebar-top-line1,
#sidebar-top-line2 {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  padding-top: 2px;

}

#sidebar-gold,
#sidebar-weather {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* Dot separator styling */
.dot-separator {
  margin: 0 4px;
  color: #666;
}

/* Smaller icons */
#sidebar-gold i,
#sidebar-weather-icon {
  font-size: 16px;
}


/* =============================
=       Sidebar Buttons       
============================= */
#custom-sidebar-buttons {
	margin-top: 10px;
	display: flex;
	flex-direction: column;
	gap: 8px;
	padding: 8px;
	border-bottom: 1px solid #555;
}

.button-single,
.button-pair {
	display: flex;
	gap: 6px;
}

#btn-saves {
	flex: 1;
	background: rgba(255, 255, 255, 0.05);
	color: white;
	border: 1px solid #888;
	padding: 6px 10px;
	border-radius: 4px;
	font-family: 'Cinzel', serif;
	font-size: 0.85em;
	font-weight: 700;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	text-shadow: 0 0 2px #000;
	transition: background 0.2s, transform 0.2s;
}

#btn-saves:hover {
	background: rgba(255, 255, 255, 0.15);
	transform: scale(1.03);
}

#btn-saves svg {
	width: 16px;
	height: 16px;
	stroke: white;
}

#ui-dialog {
	z-index: 100100; /* High enough to appear above other panels */
}

.sidebar-btn {
	flex: 1;
	background: rgba(255,255,255,0.05);
	color: white;
	border: 1px solid #888;
	padding: 4px 10px;
	border-radius: 4px;
	font-family: 'Cinzel', serif;
	font-size: 0.75em;
	font-weight: 700;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	text-shadow: 0 0 2px #000;
	transition: background 0.2s, transform 0.2s;
}

.macro-button {
	flex: 1;
	background: rgba(255,255,255,0.05);
	color: white;
	border: 1px solid #888;
	padding: 4px 10px;
	border-radius: 4px;
	font-family: 'Cinzel', serif;
	font-size: 0.75em;
	font-weight: 700;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 6px;
	text-shadow: 0 0 2px #000;
	transition: background 0.2s, transform 0.2s;

}

.macro-button svg {
	width: 16px;
	height: 15px;
}

.sidebar-btn:hover {
	background: rgba(255,255,255,0.15);
	transform: scale(1.03);
}

.sidebar-btn svg {
	width: 16px;
	height: 16px;
	stroke: white;
}

/* =============================
=         Status Bars         
============================= */
.status-bar {
	display: flex;
	align-items: center;
	gap: 6px;
	background: rgba(255,255,255,0.05);
	border: 1px solid #666;
	border-radius: 4px;
	height: 14px;
	padding: 2px 6px;
	margin: 6px 10px;
	position: relative;
	overflow: hidden;
	font-size: 0.8em;
}

/* Icon styling */
.status-bar i,
.status-bar svg {
	width: 18px;
	height: 18px;
	min-width: 18px;
	min-height: 18px;
	stroke: white;
	pointer-events: none;
}

/* Label styling */
.status-bar span {
	position: relative;
	z-index: 2; /* Ensure it's above the fill */
	white-space: nowrap;
	color: white;
	text-shadow: 0 0 3px rgba(0, 0, 0, 0.8); /* Adds contrast glow */
	cursor: default;
	padding-top: 2px
}


/* NEW: Fill wrapper for width control */
.status-bar-fill-wrapper {
	position: absolute;
	left: 25px; /* Adjust based on icon + label + spacing */
	right: 6px;
	top: 50%;
	height: 70%;
	transform: translateY(-50%);
	pointer-events: none;
	z-index: 0;
}

/* Fill bar itself (set width dynamically in JS) */
.status-bar-fill {
	width: 0%;
	height: 100%;
	border-radius: 2px;
	transition: width 0.4s ease, background 0.3s ease;
}
/* Health: forest green to neon green */
#health-fill {
	background: linear-gradient(90deg, #375d38, #0b8110);
}

/* Fatigue: sky blue to midnight blue */
#fatigue-fill {
	background: linear-gradient(90deg, #001b40, #a2e9ff );
}

/* Composure: electric yellow to golden amber */
#composure-fill {
	background: linear-gradient(90deg,#c0a800, #fff77a );
}

/* Excitement: magenta pink to deep purple */
#excitement-fill {
	background: linear-gradient(90deg, #ff4fd8, #3b0063);
}

.bar-value {
	position: absolute;
	transform: translateY(-50%);
	color: #d6ffb9;
	font-weight: 700;
	font-size: 0.75em;
	opacity: 0;
	transition: opacity 0.2s ease;
	pointer-events: none;
	text-shadow: 0 0 2px #000;
	top: 20%
}
.status-bar:hover .bar-value {
	opacity: 1;
}
#health-value {

	left: 150px;
}

#fatigue-value {
	left: 150px;
}

#composure-value {
	left: 120px;
}

#excitement-value {
	left: 120px;
}

/* =============================
=      Level and Exp Bars     
============================= */
#sidebar-level-exp {
	padding: 8px 10px;
	font-size: 0.85em;
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.exp-bar {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	height: 10px;
	border-radius: 4px;
	overflow: hidden;
}

.exp-bar-fill {
	background: #42a5f5;
	height: 100%;
	width: 0%;
	transition: width 0.4s ease;
}

/* =============================
=        Summary View         
============================= */

#sidebar-summary {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: flex-start;
	gap: 6px;
	padding: 6px 4px;
	background: #181818;
	border-bottom: 1px solid #333;
	font-size: 0.65em;
	width: 100%;
	box-sizing: border-box;
}

/* Top Line Items */
#summary-time,
#summary-gold,
#summary-level,
#summary-date {
	font-size: 1em;
	text-align: center;
	word-break: break-word;
	line-height: 1.3;
}

/* Mini container for time, date, weather, etc. */
#summary-top {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 2px;
	width: 100%;
}

/* Compact vertical layout for 4 stat icons */
#summary-status-icons {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 4px;
}

/* Icon wrap container */
.summary-icon-wrap {
	position: relative;
	width: 32px;
	height: 32px;
	display: flex;
	align-items: center;
	justify-content: center;
}

/* Lucide icons inside summary view */
.summary-icon-wrap i {
	position: relative;
	z-index: 2;
	width: 18px;
	height: 18px;
	stroke-width: 2;
	color: white;
	transition: filter 0.3s ease;
	pointer-events: none;
}

/* Fill bar that grows behind each icon */
.summary-fill {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%;
	height: 0%;
	z-index: 1;
	border-radius: 4px;
	opacity: 0.5;
	transition: height 0.3s ease;
}

/* Stat-specific gradients (fills animate by JS) */
#summary-health-fill {
	background: linear-gradient(to top, #4caf50, #0b8110);
}
#summary-fatigue-fill {
	background: linear-gradient(to top, #a2e9ff, #001b40);
}
#summary-composure-fill {
	background: linear-gradient(to top, #fff77a, #c0a800);
}
#summary-excitement-fill {
	background: linear-gradient(to top, #ff4fd8, #3b0063);
}

/* Optional glow classes applied by JS */
#summary-status-icons i.low {
	filter: drop-shadow(0 0 2px #f44336cc);
}
#summary-status-icons i.mid {
	filter: drop-shadow(0 0 2px #ffc107cc);
}
#summary-status-icons i.high {
	filter: drop-shadow(0 0 3px #4caf50cc);
}

/* Level + mini-XP display block */
#summary-level-exp {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 4px;
	width: 80%;
}

/* XP progress bar styling */
.exp-bar-mini {
	background: rgba(255, 255, 255, 0.05);
	border: 1px solid #555;
	height: 6px;
	width: 100%;
	border-radius: 3px;
	overflow: hidden;
}

.exp-bar-fill-mini {
	background: #42a5f5;
	height: 100%;
	width: 0%;
	transition: width 0.4s ease;
}

/* Status effect icons (e.g. poisoned) */
#summary-conditions {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	align-items: center;
	gap: 4px;
	width: 100%;
}

/* =============================
=     Collapsed Sidebar       
============================= */
#custom-sidebar.collapsed {
	width: 50px;
}

/* Hide navigation arrows */
#custom-sidebar.collapsed #sidebar-nav {
	display: none;
}

/* Hide menu buttons (Character, Inventory, etc.) */
#custom-sidebar.collapsed #custom-sidebar-buttons {
	display: none !important;
}

/* Shrink status bars text */
#custom-sidebar.collapsed .status-bar span {
	display: none;
}

/* Shrink status bar fill left-right space */
#custom-sidebar.collapsed .status-bar-fill {
	left: 30px;
	right: 4px;
}

/* Sidebar toggle (arrow button) stays clickable */
#sidebar-toggle {
	background: rgba(255,255,255,0.05);
	border: 1px solid #555;
	cursor: pointer;
	color: white;
	padding: 4px;
	border-radius: 4px;
	display: flex;
	align-items: center;
	justify-content: center;
	width: 36px;
	height: 36px;
}

/* Sidebar arrow not separately clickable */
#sidebar-arrow {
	pointer-events: none;
}

/* =============================
=    Disabled Nav Buttons     
============================= */
.sidebar-nav-btn:disabled {
	background: rgba(255, 255, 255, 0.02);
	border: 1px solid #333;
	color: #888;
	cursor: not-allowed;
	pointer-events: none;
}

.sidebar-nav-btn:disabled i {
	stroke: #888;
}

/* =============================
=     Glow Effects Critical    
============================= */
.critical-status {
	animation: glowPulse 1.5s infinite alternate;
}

@keyframes glowPulse {
	from { filter: drop-shadow(0 0 5px #f44336); }
	to { filter: drop-shadow(0 0 15px #f44336); }
}

/* Collapsed Sidebar - Bug Report Icon */
#summary-bug-report {
  margin-top: auto; /* Pushes it to the bottom if using flex-column */
  padding-bottom: 0.5rem;
}

#summary-bug-report .sidebar-icon-only {
  background: none;
  border: none;
  color: #ccc;
  cursor: pointer;
  font-size: 1.2em;
  padding: 0.4rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease, transform 0.2s ease;
}

#summary-bug-report .sidebar-icon-only:hover {
  color: #fff;
  transform: scale(1.1);
}

/* Expanded Sidebar - Bug Report Button */
#bug-report-button {
  position: absolute;
  z-index: 10; /* Make sure it's on top of most layers */
}

#bug-report-button .sidebar-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  background-color: #3a3a3a;
  color: #ddd;
  padding: 1.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-size: 0.9em;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.2s ease;
}

#bug-report-button .sidebar-btn:hover {
  background-color: #505050;
  transform: translateY(-2px);
}

#sidebar-support-links {
	display: flex;
	justify-content: center;
	gap: 12px;
	margin: 12px 0 0;
	padding-bottom: 12px;
}

.sidebar-support-icon {
	width: 24px;
	height: 24px;
	opacity: 0.75;
	transition: opacity 0.2s ease, transform 0.2s ease;
}

.sidebar-support-icon:hover {
	opacity: 1;
	transform: scale(1.1);
}
/* twine-user-stylesheet #19: "speech.css" */
/* =============================
=        Speech Bubbles        =
============================= */
.speech {
    display: flex;
    align-items: flex-start;
    gap: 1em;
    padding: 1em;
    border: 2px solid white;
    border-radius: 8px;
    background-color: rgba(0, 0, 0, 0.8);
    box-shadow: 5px 5px 3px black;
    margin-bottom: 0em;
    color: white;
}

.avatar {
    flex-shrink: 0;
    width: 128px;
    height: 192px;
    border-radius: 6px;
    border: 2px solid white;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.speech-content b {
    font-size: 1.2em;
    padding-bottom: 0.2em;
}

.speech-content hr {
    margin: 0.2em 0 0.5em 0;
    border: none;
    border-top: 1px solid #aaa;
}

.speech-content p {
    margin: 0;
    line-height: 1.5;
}
/* twine-user-stylesheet #20: "text-effects.css" */
/* =============================
=         Text Effects         =
============================= */
.wavy {
    display: inline-block;
    font-style: italic;
    animation: wave 1.4s infinite ease-in-out;
}

@keyframes wave {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-1px); }
    50% { transform: translateY(1px); }
    75% { transform: translateY(-1px); }
}

.fadein {
    animation: fadein 0.4s ease-in;
    display: inline-block;
    margin: 0;
}

@keyframes fadein {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.tightblock {
    display: block;
    margin: 0;
    padding: 0;
}

.whisper {
    font-style: italic;
    opacity: 0.75;
    animation: whisperFade 1.8s ease-in-out infinite alternate;
    display: inline-block;
}

@keyframes whisperFade {
    0%   { opacity: 0.65; transform: translateY(0px); }
    50%  { opacity: 0.85; transform: translateY(-1px); }
    100% { opacity: 0.65; transform: translateY(0px); }
}

.shaky {
    display: inline-block;
    animation: shake 0.3s infinite;
}

@keyframes shake {
    0%   { transform: translate(0px, 0px); }
    25%  { transform: translate(-1px, 1px); }
    50%  { transform: translate(1px, -1px); }
    75%  { transform: translate(-1px, -1px); }
    100% { transform: translate(1px, 1px); }
}

.fade-slow {
	opacity: 0;
	animation: fadeInSlow 2s ease-in-out forwards;
}

@keyframes fadeInSlow {
	from { opacity: 0; }
	to   { opacity: 1; }
}

.montage-fade {
	transition: opacity 0.6s ease-in-out;
	opacity: 1;
}

.montage-fade.fade-out {
	opacity: 0;
}

.montage-fade.fade-start {
	opacity: 0;
}
/* twine-user-stylesheet #21: "themes.css" */
/* =============================
=         Text Effects         =
============================= */
.wavy {
    display: inline-block;
    font-style: italic;
    animation: wave 1.4s infinite ease-in-out;
}

@keyframes wave {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-1px); }
    50% { transform: translateY(1px); }
    75% { transform: translateY(-1px); }
}

.fadein {
    animation: fadein 0.4s ease-in;
    display: inline-block;
    margin: 0;
}

@keyframes fadein {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.tightblock {
    display: block;
    margin: 0;
    padding: 0;
}

.whisper {
    font-style: italic;
    opacity: 0.75;
    animation: whisperFade 1.8s ease-in-out infinite alternate;
    display: inline-block;
}

@keyframes whisperFade {
    0%   { opacity: 0.65; transform: translateY(0px); }
    50%  { opacity: 0.85; transform: translateY(-1px); }
    100% { opacity: 0.65; transform: translateY(0px); }
}

.shaky {
    display: inline-block;
    animation: shake 0.3s infinite;
}

@keyframes shake {
    0%   { transform: translate(0px, 0px); }
    25%  { transform: translate(-1px, 1px); }
    50%  { transform: translate(1px, -1px); }
    75%  { transform: translate(-1px, -1px); }
    100% { transform: translate(1px, 1px); }
}
</style><script role="script" id="twine-user-script" type="text/twine-javascript">/* twine-user-script #1: "00_GlobalDeviceTypeAwareness.js" */
setup.isMobileDevice = function () {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
         (window.innerWidth <= 768 && window.innerHeight <= 1024);
};

// Detect current orientation
setup.isPortrait = function () {
  return window.matchMedia("(orientation: portrait)").matches;
};

setup.isLandscape = function () {
  return window.matchMedia("(orientation: landscape)").matches;
};

// Simple tablet detector (optional)
setup.isTabletDevice = function () {
  return setup.isMobileDevice() && window.devicePixelRatio <= 2 && Math.max(window.innerWidth, window.innerHeight) >= 834;
};

// Desktop check (opposite of mobile)
setup.isDesktop = function () {
  return !setup.isMobileDevice();
};

// Detects if user prefers reduced motion
setup.prefersReducedMotion = function () {
  return window.matchMedia("(prefers-reduced-motion: reduce)").matches;
};

// Detects if user prefers dark mode (can use to match system theme)
setup.prefersDarkMode = function () {
  return window.matchMedia("(prefers-color-scheme: dark)").matches;
};

setup.injectDeviceClasses = function () {
  const body = document.body;
  if (setup.isMobileDevice()) body.classList.add("mobile-device");
  else body.classList.add("desktop-device");

  if (setup.isTabletDevice()) body.classList.add("tablet-device");
  if (setup.isPortrait()) body.classList.add("portrait");
  else body.classList.add("landscape");

  if (setup.prefersDarkMode()) body.classList.add("dark-mode");
  if (setup.prefersReducedMotion()) body.classList.add("reduced-motion");
};

document.addEventListener("DOMContentLoaded", setup.injectDeviceClasses);
/* twine-user-script #2: "01_SnapshotNav.js" */
/* ===============================
   SNAPSHOT SYSTEM
   =============================== */

   setup.Snapshots = [];
   setup.CurrentSnapshotIndex = -1;
   setup.MaxSnapshots = 10;
   setup.suppressNextSnapshot = false;
   
   // Track UI states manually (optional per-feature)
   setup.getUIState = function () {
       return {
           dialogueMode: State.getVar('_dialogueMode') || false,
           shopOpen: State.getVar('_shopOpen') || false,
       };
   };
   
   setup.applyUIState = function (uiState) {
       if (uiState.dialogueMode !== undefined) State.setVar('_dialogueMode', uiState.dialogueMode);
       if (uiState.shopOpen !== undefined) State.setVar('_shopOpen', uiState.shopOpen);
   };
   
   setup.takeSnapshot = function () {
       const snapshot = {
           variables: clone(State.variables),
           temporary: clone(State.temporary),
           uiState: setup.getUIState(),
           passageName: passage(),
       };
   
       if (setup.CurrentSnapshotIndex < setup.Snapshots.length - 1) {
           setup.Snapshots = setup.Snapshots.slice(0, setup.CurrentSnapshotIndex + 1);
       }
   
       setup.Snapshots.push(snapshot);
   
       if (setup.Snapshots.length > setup.MaxSnapshots) {
           setup.Snapshots.shift();
       }
   
       setup.CurrentSnapshotIndex = setup.Snapshots.length - 1;
       setup.saveSnapshotsToStorage();
       setup.updateNavButtons();
   };
   
   setup.saveSnapshotsToStorage = function () {
       try {
           const serialized = JSON.stringify(setup.Snapshots);
           window.localStorage.setItem('game_snapshots', serialized);
       } catch (error) {
           console.error("[Snapshot] Failed to save snapshots:", error);
       }
   };
   
   setup.loadSnapshotsFromStorage = function () {
       try {
           const serialized = window.localStorage.getItem('game_snapshots');
           if (serialized) {
               setup.Snapshots = JSON.parse(serialized);
               setup.CurrentSnapshotIndex = setup.Snapshots.length - 1;
               console.log("[Snapshot] Snapshots restored from storage.");
           }
       } catch (error) {
           console.error("[Snapshot] Failed to load snapshots:", error);
           setup.Snapshots = [];
           setup.CurrentSnapshotIndex = -1;
       }
       setup.updateNavButtons();
   };
   
   setup.loadSnapshot = function (index) {
       if (index < 0 || index >= setup.Snapshots.length) {
           console.warn("[Snapshot] Tried to load invalid index:", index);
           return;
       }
   
       const snapshot = setup.Snapshots[index];
       if (!snapshot) {
           console.warn("[Snapshot] No snapshot at index:", index);
           return;
       }
   
       Object.assign(State.variables, clone(snapshot.variables));
       Object.assign(State.temporary, clone(snapshot.temporary));
       setup.applyUIState(snapshot.uiState);
   
       setup.CurrentSnapshotIndex = index;
       setup.suppressNextSnapshot = true;
   
       // ✅ Trigger UI hydration flag — let :passagerender handle rehydration
       State.variables.needsUIRehydrate = true;
   
       Engine.play(snapshot.passageName, true);
   
       setup.updateNavButtons();
   };
   
   setup.navBack = function () {
       if (setup.CurrentSnapshotIndex > 0) {
           setup.loadSnapshot(setup.CurrentSnapshotIndex - 1);
       } else {
           UI.alert("No earlier snapshots available.");
       }
   };
   
   setup.navForward = function () {
       if (setup.CurrentSnapshotIndex < setup.Snapshots.length - 1) {
           setup.loadSnapshot(setup.CurrentSnapshotIndex + 1);
       } else {
           UI.alert("No newer snapshots available.");
       }
   };
   
   setup.updateNavButtons = function () {
       const backBtn = document.getElementById("sidebar-nav-back");
       const forwardBtn = document.getElementById("sidebar-nav-forward");
   
       if (backBtn) {
           backBtn.disabled = setup.CurrentSnapshotIndex <= 0;
       }
       if (forwardBtn) {
           forwardBtn.disabled = setup.CurrentSnapshotIndex >= setup.Snapshots.length - 1;
       }
   };
   
   $(document).on(':passagedisplay', function () {
       if (setup.suppressNextSnapshot) {
           setup.suppressNextSnapshot = false;
           return;
       }
       setup.takeSnapshot();
   });
   
   setup.clearSnapshots = function () {
       setup.Snapshots = [];
       setup.CurrentSnapshotIndex = -1;
       window.localStorage.removeItem('game_snapshots');
       setup.updateNavButtons();
   };
   
   /* ===============================
      END SNAPSHOT SYSTEM
      =============================== */
   
/* twine-user-script #3: "03_setup_sidebarui.js" */
if (typeof setup === "undefined") {
	setup = {};
}

if (typeof setup.SidebarUI === "undefined") {
	setup.SidebarUI = {};
}
/* twine-user-script #4: "04_widgets.js" */
/* Background Macro */
Macro.add("bg", {
	handler: function () {
		const arg = this.args[0];
		if (typeof arg === "string") {
			const path = "images/background_" + arg + ".png";
			State.variables.bgImage = path;
			State.variables.bgImageSetThisPassage = true;

			// Immediately apply to background
			const el = document.getElementById("background-image");
			if (el) {
				el.style.backgroundImage = `url('${path}')`;
				console.log(`🖼️ Background updated to: ${path}`);
			} else {
				console.warn("⚠️ Could not find #background element.");
			}
		} else {
			return this.error("Invalid argument to <<bg>>. Expected a string like 'tavern'.");
		}
	}
});

Macro.add('loadmap', {
    handler() {
        if (this.args.length === 0) {
            return this.error('No map ID specified.');
        }

        const mapId = this.args[0];
        const startX = this.args[1] ? parseInt(this.args[1], 10) : null;
        const startY = this.args[2] ? parseInt(this.args[2], 10) : null;

        // Validate start positions if provided
        if ((startX !== null && isNaN(startX)) || (startY !== null && isNaN(startY))) {
            return this.error('Invalid starting position coordinates.');
        }

        // Safety check: Make sure MapSystem is loaded
        if (typeof MapSystem === 'undefined' || typeof MapSystem.setCurrentMap !== 'function') {
            return this.error('MapSystem is not available.');
        }

        // Async IIFE to handle the map loading
        (async () => {
            try {
                if (startX !== null && startY !== null) {
                    await MapSystem.setCurrentMap(mapId, { x: startX, y: startY });
                } else {
                    await MapSystem.setCurrentMap(mapId);
                }
                console.log(`[loadmap] Successfully loaded map: ${mapId}`);
            } catch (e) {
                console.error(`[loadmap] Failed to load map: ${mapId}`, e);
                UI.alert(`Failed to load map: ${mapId}`);
            }
        })();
    }
});


Macro.add('unloadmap', {
    handler() {
        if (typeof MapSystem === 'undefined' || typeof MapSystem.clearCurrentMap !== 'function') {
            return this.error('MapSystem is not available.');
        }

        MapSystem.clearCurrentMap();
        console.log('[unloadmap] Map cleared.');
    }
});


Macro.add("know", {
	handler() {
		const charId = this.args[0];
		if (!charId || !State.variables.characters?.[charId]) {
			return this.error(`Unknown character ID: ${charId}`);
		}

		State.variables.characters[charId].known = true;
	}
});


/* Dialogue Choice Button */
Macro.add("dialogueChoice", {
	skipArgs: false,
	handler() {
		const [label, target, flag] = this.args;
		const reusable = flag === "1" || flag === 1;

		if (!label || !target) {
			console.warn("<<dialogueChoice>> missing label or target");
			return;
		}

		const $button = $("<p>")
			.addClass("dialogue-choice")
			.text(label)
			.css("cursor", "pointer")
			.on("click", () => {
				console.groupCollapsed(`📌 [dialogueChoice] "${label}" → ${target}`);
				console.log("Reusable:", reusable);
				console.log("Phase:", State.variables.currentPhase);
				console.log("NPC:", State.variables.currentNPC);

				$button.remove();

				// Track globally if not reusable
				State.variables.usedDialogueOptions ??= {};
				if (!reusable) {
					State.variables.usedDialogueOptions[target] = true;
					console.log("✅ Marked non-reusable as used:", target);
				}

				// Track usage by phase + NPC
				const char = State.variables.currentNPC || "Unknown";
				const phase = State.variables.currentPhase ?? "X";
				const key = `Read_${phase}_${char}_${target}`;
				State.variables[key] ??= 0;
				State.variables[key]++;
				console.log("📊 Incremented:", key, "→", State.variables[key]);

				const $box = $("#convoBox");
				if ($box.length) {
					const preChildren = $box[0].children.length;

					$box.children().removeClass("active-entry").addClass("faded-entry");

					console.log("📥 Injecting widget: <<", target, ">>");
					try {
						Wikifier.wikifyEval(`<<${target}>>`);
					} catch (e) {
						console.error("❌ Error injecting widget:", e);
					}

					if (typeof setup.clearConvoChoices === "function") {
						setup.clearConvoChoices();
					} else {
						console.warn("⚠️ setup.clearConvoChoices not found");
					}

					const funcKey = `${char}_Conversation_Options_${phase}`;
					const phaseFunc = setup?.[funcKey];

					if (typeof phaseFunc === "function") {
						console.log(`🔁 Recalling setup.${funcKey}()`);
						phaseFunc();
					} else {
						console.warn(`⚠️ No phase function found for: ${funcKey}`);
					}

					setTimeout(() => {
						const box = $box[0];
						const entries = box.children;
						const newEntry = entries[preChildren];
						if (!newEntry) {
							console.warn("🕳 No new entry detected.");
							return;
						}

						const divider = document.createElement("div");
						divider.className = "dialogue-divider";
						box.insertBefore(divider, newEntry);

						newEntry.classList.add("active-entry");
						newEntry.classList.remove("faded-entry");

						const boxTop = box.getBoundingClientRect().top;
						const entryTop = newEntry.getBoundingClientRect().top;
						const offset = entryTop - boxTop;

						box.scrollTo({
							top: box.scrollTop + offset,
							behavior: "smooth"
						});
						console.log("🧭 Scrolled to new entry.");
					}, 10);
				} else {
					console.warn("⚠️ convoBox not found.");
				}

				console.groupEnd();
			});

		this.output.append($button[0]);
	}
});





/* Dialogue Tree Macro: Pulls current NPC & Phase and injects options */
Macro.add("DialogueTree", {
	handler() {
		const [characterName, phaseId] = this.args;

		if (!characterName || !phaseId) {
			console.error("DialogueTree: Missing character name or phase identifier.");
			return;
		}

		const v = State.variables;
		v.currentNPC = characterName;
		v.currentPhase = phaseId;

		if (typeof setup.clearConvoChoices === "function") {
			setup.clearConvoChoices();
		}

		// Always use flat naming: setup.char_Conversation_Options_phaseId
		const functionName = `${characterName}_Conversation_Options_${phaseId}`;
		const setupFunc = setup[functionName];

		if (typeof setupFunc !== "function") {
			console.error(`DialogueTree: Missing setup function '${functionName}'`);
			return;
		}

		console.log(`📂 [DialogueTree] Switching to: ${functionName}`);

		setTimeout(() => {
			const choiceEl = document.getElementById("convoChoices");
			if (!choiceEl) {
				console.warn("DialogueTree: #convoChoices not found.");
				return;
			}
			setupFunc();
		}, 0);
	}
});



/* Injects List of Choices into UI */
setup.addChoices = function (list) {
	const $container = $("#convoChoices");
	if (!$container.length) {
		console.warn("[addChoices] convoChoices not found.");
		return;
	}

	State.variables.usedDialogueOptions ??= {};

	list.forEach(([label, target, reusableFlag = 0]) => {
		const reusable = reusableFlag === 1 || reusableFlag === "1";
		const used = State.variables.usedDialogueOptions[target];

		if (used && !reusable) {
			console.log(`[addChoices] Skipping used non-reusable choice: ${target}`);
			return;
		}

		const macroCall = `<<dialogueChoice "${label}" "${target}" "${reusable ? 1 : 0}">>`;
		new Wikifier($container[0], macroCall);
	});
};

/* 📌 Minigame Start Button */
Macro.add("OpenConvoGame", {
	handler() {
		const npcId = this.args[0];
		
		// Debug logging
		console.log("[OpenConvoGame] Called with npcId:", npcId);
		console.log("[OpenConvoGame] State.variables.characters exists:", !!State.variables.characters);
		console.log("[OpenConvoGame] Available character IDs:", State.variables.characters ? Object.keys(State.variables.characters) : "none");
		
		// Check if characters need to be initialized
		if (!State.variables.characters) {
			console.warn("[OpenConvoGame] Characters not initialized, attempting to initialize...");
			if (typeof setup.initializeCharacters === 'function') {
				State.variables.characters = setup.initializeCharacters();
				console.log("[OpenConvoGame] Characters initialized successfully");
			} else {
				console.error("[OpenConvoGame] setup.initializeCharacters function not found!");
				return this.error("Character system not properly initialized.");
			}
		}
		
		const char = State.variables.characters?.[npcId];
		console.log("[OpenConvoGame] Character found:", !!char);
		
		if (!npcId || !char) {
			console.error("[OpenConvoGame] Failed to find character:", npcId);
			console.error("[OpenConvoGame] Available characters:", Object.keys(State.variables.characters || {}));
			return this.error("OpenConvoGame requires a valid NPC ID.");
		}

		const uniqueId = `start-minigame-${npcId}`;
		const btnHTML = `
			<div id="${uniqueId}" class="start-minigame-button-wrapper">
				<button class="start-minigame-button" onclick="
					setup.ConvoUI.renderMinigame('${npcId}');
					const wrapper = document.getElementById('${uniqueId}');
					if (wrapper) {
						wrapper.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
						wrapper.style.opacity = '0';
						wrapper.style.transform = 'translateY(-10px)';
						setTimeout(() => wrapper.remove(), 400);
					}
				">
					Get to know ${char.name}
				</button>
			</div>
		`;

		const target = document.getElementById("convoBox");
		if (target) {
			target.insertAdjacentHTML("beforeend", btnHTML);
		} else {
			console.warn("[OpenConvoGame] #convoBox not found.");
		}
	}
});


Macro.add("CrownAndCaste", {
	handler() {
	  const args = this.args;
	  const buyIn = parseFloat(args[0]);
	  const npcIds = args.slice(1, 4).filter(id => id && id !== "");
  
	  const validStakes = ["low", "standard", "high"];
	  const knownHouseRules = ["golden-tax", "split-line", "blessing-of-sixes", "royal-flush"];
  
	  // Optional arguments after NPCs
	  const remaining = args.slice(4);
	  let stakes = "standard";
	  let houseRules = [];
	  let winPassage = null;
	  let losePassage = null;
	  let playerFavor = null;
  
	  for (const arg of remaining) {
		const lower = String(arg).toLowerCase();
		if (validStakes.includes(lower)) {
		  stakes = lower;
		} else if (knownHouseRules.includes(lower)) {
		  houseRules.push(lower);
		} else if (!isNaN(parseFloat(arg)) && parseFloat(arg) > 1) {
		  playerFavor = parseFloat(arg);
		} else if (!winPassage) {
		  winPassage = arg;
		} else if (!losePassage) {
		  losePassage = arg;
		}
	  }
  
	  if (!losePassage && winPassage) losePassage = winPassage;
  
	  if (isNaN(buyIn)) {
		return this.error("CrownAndCaste requires a numeric buy-in as the first argument.");
	  }
  
	  const characters = State.variables.characters;
	  const sessionPlayers = ["jaylie"];
  
	  npcIds.forEach(id => {
		const cleanId = id.trim();

		if (characters?.[cleanId]) {
			// Matches a real character in the characters object
			sessionPlayers.push(cleanId);
		} else if (cleanId.toLowerCase() === "ghost") {
			sessionPlayers.push("ghost");
		} else {
			// Allow literal name as a fallback
			sessionPlayers.push({ name: cleanId });
		}
		});

  
	  if (sessionPlayers.length < 2) {
		return this.error("Crown & Caste requires at least 2 players (including you).");
	  }
	  if (sessionPlayers.length > 4) {
		sessionPlayers.splice(4);
	  }
  
	  const playerGold = State.variables.inventory_player?.gold_coin || 0;
	  const hasEnoughGold = playerGold >= buyIn;
  
	  const stakesDisplay = stakes === "low" ? "Low Stakes" :
							stakes === "high" ? "High Stakes" :
							"Standard Stakes";
  
	  const sessionKey = `crown-and-caste-${Date.now()}`;
	  const uniqueId = `start-cnc-${sessionKey}`;
	  const buttonId = `btn-${uniqueId}`;
	  const goldIcon = `<i data-lucide='coins'></i>`;
  
	  const houseRulesDisplay = houseRules.length > 0
		? `<div class="house-rules-display">House Rules: ${houseRules.join(", ")}</div>` : "";
  
	  const btnHTML = `
		<div id="${uniqueId}" class="start-minigame-button-wrapper">
		  <div class="crown-caste-game-info">
			<h4>Crown & Caste Table</h4>
			<div class="game-details">
			  <span class="stakes-level">${stakesDisplay}</span>
			  <span class="buy-in">Buy-In: ${buyIn} ${goldIcon}</span>
			  <span class="players">Players: ${sessionPlayers.length}/4</span>
			</div>
			${houseRulesDisplay}
		  </div>
		  <button class="start-minigame-button" id="${buttonId}" ${hasEnoughGold ? "" : "disabled"}>
			${hasEnoughGold ? "Join Game" : "Insufficient Gold"}
		  </button>
		  ${!hasEnoughGold ? `<p class='minigame-warning'>(Need ${buyIn}g to join this table)</p>` : ""}
		</div>
	  `;
  
	  $(this.output).append(btnHTML);
  
	  setTimeout(() => {
		const buttonEl = document.getElementById(buttonId);
		if (buttonEl && hasEnoughGold) {
		  buttonEl.addEventListener("click", () => {
			console.log("[CrownAndCaste] 🟢 Starting game...");
			console.log(`[CrownAndCaste] Stakes: ${stakes}, Rules: ${houseRules}`);
			console.log(`[CrownAndCaste] Routes: Win → ${winPassage}, Lose → ${losePassage}`);
			if (playerFavor) console.log(`[CrownAndCaste] Player Favor Modifier: ${playerFavor}`);
  
			if (State.variables.inventory_player?.gold_coin) {
			  State.variables.inventory_player.gold_coin -= buyIn;
			}
  
			// Store metadata
			State.temporary.ccBuyIn = buyIn;
			State.temporary.ccStakes = stakes;
			State.temporary.ccHouseRules = houseRules;
			State.temporary.ccWinPassage = winPassage;
			State.temporary.ccLosePassage = losePassage;
			State.temporary.ccPlayerFavor = playerFavor ?? null;
  
			setup.CrownAndCaste.initSession(sessionPlayers, stakes, houseRules, playerFavor, buyIn);
			setup.CrownAndCaste.startGame();
			setup.CrownAndCasteUI.renderMinigame();
  
			const wrapper = document.getElementById(uniqueId);
			if (wrapper) {
			  wrapper.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
			  wrapper.style.opacity = '0';
			  wrapper.style.transform = 'translateY(-10px)';
			  setTimeout(() => wrapper.remove(), 400);
			}
  
			if (window.lucide) lucide.createIcons();
		  });
		}
	  }, 50);
	}
  });
  
  



/* Optional Utility: Clears conversation snapshot state */
Macro.add("ClearSnapshots", {
	handler() {
		if (typeof setup.clearSnapshots === 'function') {
			setup.clearSnapshots();
		} else {
			console.warn("[ClearSnapshots] setup.clearSnapshots function not found.");
		}
	}
});


/* Character Relation Changing Macro */
Macro.add("relation", {
	skipArgs: false,
	handler() {
		if (this.args.length < 3) {
			return this.error("Usage: <<relation 'characterId' 'stat' value ['set' or 'add']>>");
		}

		const [charId, stat, rawValue, mode = "add"] = this.args;
		const chars = State.variables.characters;
		const char = chars?.[charId];

		if (!char) return this.error(`Character '${charId}' not found.`);
		if (!["trust", "affection", "rapport", "tension", "cooldown"].includes(stat)) {
			return this.error(`Stat '${stat}' is not a valid relationship field.`);
		}

		const value = parseFloat(rawValue);
		if (isNaN(value)) {
			return this.error("Value must be a number.");
		}

		if (mode === "set") {
			char[stat] = value;
		} else if (mode === "add") {
			char[stat] = (char[stat] ?? 0) + value;
		} else {
			return this.error("Mode must be 'add' or 'set'.");
		}

		// Optionally log or visually confirm
		console.log(`[relation] ${mode} ${value} to ${charId}.${stat} → ${char[stat]}`);
	}
});

Macro.add("SceneFadeInNow", {
	handler() {
		setTimeout(() => {
			const nodes = document.querySelectorAll("#montage .fade-start");
			nodes.forEach(n => n.classList.remove("fade-start"));
			console.log(`[SceneFadeInNow] ${nodes.length} element(s) faded in.`);
		}, 20);
	}
});

Macro.add("StartSexScene", {
	skipArgs: false,
	handler() {
	  const args = this.args;
  
	  console.log("[SexScene] 🔹 Macro Triggered");
	  console.log("[SexScene] Arguments Received:", args);
  
	  if (!args.length) {
		return this.error("<<StartSexScene>> requires at least one NPC ID.");
	  }
  
	  let label = "Have Sex";
	  let npcIdList = "";
	  let positionOverride = null;
  
	  if (args.length === 1) {
		npcIdList = args[0];
		console.log(`[SexScene] Using default label. Target NPCs: ${npcIdList}`);
	  } else if (args.length >= 2) {
		label = args[0];
		npcIdList = args[1];
		if (args[2]) {
		  positionOverride = args[2];
		  console.log(`[SexScene] Position override specified: ${positionOverride}`);
		}
		console.log(`[SexScene] Custom label: ${label} | Target NPCs: ${npcIdList}`);
	  }
  
	  const $link = $("<span>")
		.addClass("macro-link")
		.wiki(label)
		.css("cursor", "pointer")
		.on("click", () => {
		  console.log("[SexScene] 🔸 Link clicked. Beginning setup...");
  
		  // Initialize body states
		  setup.initializeSexSceneStates(npcIdList);
		  console.log("[SexScene] ✅ States initialized via setup.initializeSexSceneStates");
  
		  // Store participants
		  const npcArray = npcIdList.split(",").map(id => id.trim());
		  State.variables.sexSceneParticipants = {
			player: "player",
			npcs: npcArray
		  };
		  console.log("[SexScene] 🧍 Participants set:", State.variables.sexSceneParticipants);
  
		  // Set up environment
		  State.variables.sexSceneEnvironment = {
			location: State.activePassage,
			furniture: ["floor", "wall"],
			positionOverride: positionOverride ?? null
		  };
		  console.log("[SexScene] 🛋️ Environment defined:", State.variables.sexSceneEnvironment);
  
		  // Launch scene
		  console.log("[SexScene] 🚪 Entering ::SexScene passage...");
		  Engine.play("SexScene");
		});
  
	  $(this.output).append($link);
	}
  });
  
Macro.add("EndSexScene", {
	handler() {
		if (this.args.length === 0 || typeof this.args[0] !== "string") {
			return this.error("You must provide a valid passage name as a string.");
		}

		const exitTarget = this.args[0];
		State.variables.sexSceneExitTarget = exitTarget;

		console.log(`[SexSceneInit] 📍 Exit passage set to '${exitTarget}'`);
	}
});


 console.log("✅ widgets.js loaded");
/* twine-user-script #5: "07_lucide.js" */
var lucideScript = document.createElement('script');
lucideScript.src = 'https://unpkg.com/lucide@latest';
lucideScript.onload = function () {
	console.log("✅ Lucide icons loaded.");
	window.lucideReady = true;
};
document.head.appendChild(lucideScript);

function renderLucideIconsSafely() {
	console.log("🔄 Attempting to render Lucide icons...");
	if (window.lucideReady && window.lucide && window.lucide.createIcons) {
		console.log("✅ Lucide is ready — rendering icons now.");
		window.lucide.createIcons();
	} else {
		console.log("⏳ Lucide not ready yet... retrying in 50ms");
		setTimeout(renderLucideIconsSafely, 50);
	}
}
/* twine-user-script #6: "cssPathFix.js" */
if (
	document.location.href.toLowerCase().includes("/twine/scratch/") ||
	document.location.href.toLowerCase().includes("/temp/") ||
	document.location.href.toLowerCase().includes("/private/") ||
	hasOwnProperty.call(window, "storyFormat")
) {
	$(document).one(":passagerender", function () {
		setTimeout(function () {
			$(".avatar").each(function () {
				var url = $(this).css("background-image");
				url = url.replace(/\"/gi, "").replace(')', '');
				url = url.slice(url.lastIndexOf("/") + 1);
				$(this).css("background-image", "url('file:///C:/Games/My%20Game/" + url + "')");
			});
		});
	});
}
/* twine-user-script #7: "01_playerdata.js" */
State.variables.player = {
	// === Identity ===
	name: "Jaylie",
	age: 18,
	dob: "Unknown",
	race: "Human",
	gender: "Female",

	// === Leveling ===
	level: 1,
	experience: 69,
	experienceToNextLevel: 100,

	// === Attributes (Perk-based) ===
	attributes: {
		strength: 5,
		agility: 5,
		toughness: 5,
		charisma: 5,
		intelligence: 5,
		insight: 5
	},

	// === Primary Skills (Earn XP individually) ===
	primarySkills: {
		athletics: { value: 0, xp: 0 },
		acrobatics: { value: 0, xp: 0 },
		sleightOfHand: { value: 0, xp: 0 },
		stealth: { value: 0, xp: 0 },
		fortitude: { value: 0, xp: 0 },
		willpower: { value: 0, xp: 0 },
		deception: { value: 0, xp: 0 },
		intimidation: { value: 0, xp: 0 },
		performance: { value: 0, xp: 0 },
		persuasion: { value: 0, xp: 0 },
		magic: { value: 0, xp: 0 },
		investigation: { value: 0, xp: 0 },
		religion: { value: 0, xp: 0 },
		history: { value: 0, xp: 0 },
		perception: { value: 0, xp: 0 },
		survival: { value: 0, xp: 0 },
		medicine: { value: 0, xp: 0 }
	},

	// === Secondary Skills (Earn XP individually) ===
	secondarySkills: {
		riding: { value: 100, xp: 0 },
		dancing: { value: 100, xp: 0 },
		swimming: { value: 100, xp: 0 },
		cleaning: { value: 100, xp: 0 },
		disguise: { value: 100, xp: 0 },
		hands: { value: 100, xp: 0 },
		mouth: { value: 100, xp: 0 },
		breasts: { value: 100, xp: 0 },
		vagina: { value: 100, xp: 0 },
		anus: { value: 100, xp: 0 }
	},

	// === Equipment ===
	equipment: {
		weaponMain: "Fists",
		weaponOffhand: "None",
		armor: "Simple Clothes"
	},

	// === Body Anatomy ===
	body: {
		height: 64, // inches
		breastSize: 2, // modest
		buttSize: 2, // modest
		bodyType: 3, // average
		lipFullness: 2, // modest
		skinTone: "fair",
		muscleTone: 2, // fit
		hipWidth: 2, // wide
		bodyHair: 1, // light
		voiceTone: "gentle",
		hairColor: "auburn",
		hairStyle: "wavy",
		hairLength: 20, // mid-back
		eyeColor: "hazel green",

		// Functional anatomy
		vagina: true,
		clitoris: true,
	},

	// === Current Status ===
	status: {
		health: 100,
		maxHealth: 100,
		fatigue: 25,
		maxFatigue: 100,
		composure: 100,
		maxComposure: 100,
		excitement: 0,
		maxExcitement: 100,
		isCumming: false,

		// Conditional Status Effects
		poisoned: 0,
		maxPoisoned: 100,
		intoxicated: 0,
		maxIntoxicated: 100,
		charmed: 0,
		maxCharmed: 100,
		burning: false,
		bleeding: 0,
		maxBleeding: 50,
		stunned: false
	},

	/* ==================== */
	/* - Player Inventory - */
	/* ==================== */

		/* === Carry === */
	carryWeight: {
		current: 0,
	},

	startingInventory: {
		gold_coin: 100,
		dagger_silver: 1,
	}
};
/* ==================== */
/* - Starting Inventory - */
/* ==================== */

/* twine-user-script #8: "02_initVars.js" */
State.variables.inventory_player = Object.assign(
	{},
	State.variables.player.startingInventory
);

State.variables.DEBUG = true;

// Tavern state tracking
State.variables.seenTavernSpace = false;
/* twine-user-script #9: "03_worldstate.js" */
State.variables.world = {
    // === Time and Calendar ===
    dayOfYear: 1,     // 1-400
    year: 12219,      // After Impact (AI)
    hour: 6,
    minute: 0,
    is24HourFormat: true,  // toggleable from settings
  
    // === Weather ===
    weather: "Clear", // Clear, Rain, Storm, Snow, Fog
  
    // === Location ===
    locationName: "Unknown",
  
    // === Environmental Flags (future expansion) ===
    specialEvent: null, // e.g., "Harvest Festival"
  };
  console.log("WorldData is loaded.");
/* twine-user-script #10: "04_Generated_NPCData.js" */
/* twine-user-script #11: "04_character.js" */
/* ================================
=  Character Dialogue & Avatars  =
================================ */

setup.initializeCharacters = function () {
	return{
		jaylie: {
			name: "Jaylie",
			defaultName: "Jaylie",
			known: true,
			avatar: "images/portrait_jaylie.png",
			color: "white",
			bgColor: "rgba(110, 43, 54, 0.8)",

			isPlayer: true, // Optional: May be used to prevent this character from appearing in random events

			// Optional fallback portrait info — no runtime body data needed here
			pronouns: {
				subject: "she",
				object: "her",
				possessive: "her",
				reflexive: "herself",
				noun: "woman"
			},

			// Optional static traits used only for fallback conversations
			traits: ["Curious", "Stubborn", "Playful"],
			socialStyle: "Warm"
		},

		
  
		adda: {
			name: "Mistress Adda",
			defaultName: "Brothel Mistress",
			known: false,
			avatar: "images/portrait_mistressadda.png",
			color: "white",
			bgColor: "rgba(32, 32, 32, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Dominant", "Wise", "Seductive"],
			inclinations: ["bondage", "praise", "service"],
			motivations: ["Control", "Guidance"],
			socialStyle: "Regal",
			
			pronouns: {
				subject: "she",         // he / they
				object: "her",          // him / them
				possessive: "her",      // his / their
				reflexive: "herself",   // himself / themself
				noun: "woman"           // man / person
			  },
			  
			body: {
				height: 69, // 5'9"
				breastSize: 4, // "large"
				buttSize: 3, // "round"
				bodyType: 4, // "curvy"
				lipFullness: 3, // "full"
				skinTone: "olive",
				muscleTone: 2, // "fit"
				hipWidth: 3, // "very wide"
				bodyHair: 1, // "light"
				voiceTone: "commanding",
				hairColor: "iron-gray with black undertones",
				hairStyle: "elegantly pinned with loose waves",
				hairLength: 20, // "mid-back"
				eyeColor: "dark hazel"
			},
		
			preferences: {
				sexualActs: {
					likes: [
						"Dominate", "Bondage_Use", "Praise_G",
						"Spank_G", "HairPulling_G", "DirtyTalk_G",
						"Vaginal_P", "Oral_R", "OrgasmControl_G"
					],
					dislikes: ["Submit", "Clit_Rub", "Blindfold_R"]
				},
				bodyTypes: {
					likes: ["SlimWaist", "BigButt", "Curvy", "Fit"],
					dislikes: ["Emaciated", "VeryHairy"]
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "modest",
						breastSize: "medium"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
  
		kallot: {
			name: "Kallot",
			defaultName: "Drunk Man",
			known: false,
			avatar: "images/portrait_kallot.png",
			color: "white",
			bgColor: "rgba(159, 172, 138, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Cynical", "Melancholic", "Awkward"],
			inclinations: ["voyeurism", "vanilla", "submission"],
			motivations: ["Redemption", "Connection"],
			socialStyle: "Humble",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 68, // 5'8"
				breastSize: null,
				buttSize: 3, // "round"
				penisSize: 6.5, // inches
				bodyType: 5, // "thick"
				lipFullness: 2, // "modest"
				skinTone: "brown",
				muscleTone: 3, // "athletic"
				hipWidth: 2, // "modest"
				bodyHair: 3, // "hairy"
				voiceTone: "gentle",
				hairColor: "dark brown",
				hairStyle: "short and messy",
				hairLength: 2, // ~short
				eyeColor: "muddy blue"
			},
		
			preferences: {
				sexualActs: {
					likes: ["Oral_R", "Oral_G", "Vaginal_P", "Voyeurism", "Submit", "Kissing", "Cuddling"],
					dislikes: ["Dominate", "Spank_G", "Degrade_G"]
				},
				bodyTypes: {
					likes: ["Curvy", "Soft", "Average"],
					dislikes: ["Ripped", "Broad", "VeryTall"]
				},
				partners: {
					genderPreference: {
						male: 0.1,
						female: 0.9
					},
					anatomyPreference: {
						breastSize: "large",
						buttSize: "plump"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
  
		marie: {
			name: "Marie",
			defaultName: "Brothel Girl",
			known: false,
			avatar: "images/portrait_marie.png",
			color: "white",
			bgColor: "rgba(197, 126, 65, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Introverted", "Guarded", "Submissive"],
			inclinations: ["praise", "service", "submission"],
			motivations: ["Safety", "Freedom"],
			socialStyle: "Reserved",
			
			pronouns: {
				subject: "she",         // he / they
				object: "her",          // him / them
				possessive: "her",      // his / their
				reflexive: "herself",   // himself / themself
				noun: "woman"           // man / person
			  },
			  
			body: {
				height: 61, // 5'1"
				breastSize: 1, // "small"
				buttSize: 2, // "modest"
				bodyType: 1, // "slender"
				lipFullness: 2, // "modest"
				skinTone: "porcelain",
				muscleTone: 0, // "soft"
				hipWidth: 1, // "modest"
				bodyHair: 0, // "smooth"
				voiceTone: "hushed",
				hairColor: "blonde",
				hairStyle: "loose and natural",
				hairLength: 5, // "mid-back"
				eyeColor: "green"
			},
		
			preferences: {
				sexualActs: {
					likes: ["Praise_G", "Oral_G", "Oral_R", "Cuddling", "Kissing", "Fingering_R", "BreastPlay_R"],
					dislikes: ["Spank_G", "HairPulling_G", "Choke_G", "Anal_P", "Clit_Rub"]
				},
				bodyTypes: {
					likes: ["Curvy", "Soft", "Fit"],
					dislikes: ["Ripped", "VeryTall", "Broad"]
				},
				partners: {
					genderPreference: {
						male: 0.3,
						female: 0.7
					},
					anatomyPreference: {
						breastSize: "large",
						penisSize: "modest"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
  
		eristan: {
			name: "Eristan Velthar",
			defaultName: "Madman",
			known: false,
			avatar: "images/portrait_eristan.png",
			color: "white",
			bgColor: "rgba(53, 18, 4, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Detached", "Curious", "Traumatized"],
			inclinations: ["chastity", "abstinence", "masochism"],
			motivations: ["Prophecy", "Protection"],
			socialStyle: "Unhinged",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 70, // 5'10"
				breastSize: null,
				buttSize: 0, // "flat"
				bodyType: 0, // "emaciated"
				lipFullness: 1, // "narrow"
				skinTone: "fair",
				muscleTone: 0, // "soft"
				hipWidth: 0, // "narrow"
				bodyHair: 2, // "natural"
				voiceTone: "breathy",
				hairColor: "ashen gray",
				hairStyle: "wild and unkempt",
				hairLength: 4, // "shoulder-length"
				eyeColor: "cloudy blue",
				penisSize: 9.5 // destiny's joke
			},
		
			preferences: {
				sexualActs: {
					likes: [],
					dislikes: [
						"Oral_R", "Oral_G", "Vaginal_P", "Anal_P", "Toys_OnSelf",
						"Toys_Use", "Kissing", "Cuddling", "DirtyTalk_R", "Dominate", "Submit"
					]
				},
				bodyTypes: {
					likes: [],
					dislikes: ["Curvy", "Voluptuous", "Fit", "Broad"]
				},
				partners: {
					genderPreference: {
						male: 0.9,
						female: 0.1
					},
					anatomyPreference: {
						penisSize: "irrelevant",
						breastSize: "irrelevant"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		

		harroc: {
			name: "Harroc",
			defaultName: "Barkeep",
			known: true,
			avatar: "images/portrait_harroc.png",
			color: "white",
			bgColor: "rgba(65, 48, 35, 0.8)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Stoic", "Kind", "Guarded"],
			inclinations: ["vanilla", "monogamy", "aftercare"],
			motivations: ["Duty", "Redemption"],
			socialStyle: "Grizzled",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 76, // 6'4"
				breastSize: null,
				buttSize: 2, // "modest"
				bodyType: 6, // "heavyset"
				lipFullness: 2, // "modest"
				skinTone: "brown",
				muscleTone: 5, // "muscular"
				hipWidth: 1, // "modest"
				bodyHair: 3, // "hairy"
				voiceTone: "commanding",
				hairColor: "grizzled black",
				hairStyle: "bald with beard",
				hairLength: 2, // ~"short"
				eyeColor: "dark brown",
				penisSize: 7.5
			},
		
			preferences: {
				sexualActs: {
					likes: ["Vaginal_P", "Cuddling", "Kissing", "BreastPlay_G", "Submit"],
					dislikes: ["Choke_G", "Spank_G", "Toys_Use", "Anal_P"]
				},
				bodyTypes: {
					likes: ["Curvy", "Thick", "Strong"],
					dislikes: ["Slender", "Emaciated"]
				},
				partners: {
					genderPreference: {
						female: 1.0,
						male: 0.0
					},
					anatomyPreference: {
						breastSize: "large",
						penisSize: null
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},

		tesska: {
			name: "Tesska",
			defaultName: "Barmaid",
			known: false,
			avatar: "images/portrait_tesska.png",
			color: "white",
			bgColor: "rgba(189, 108, 99, 0.85)",
		
			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,
		
			traits: ["Flirty", "Crude", "Confident"],
			inclinations: ["exhibitionist", "teasing", "dominant"],
			motivations: ["Freedom", "Excitement"],
			socialStyle: "Feisty",

			pronouns: {
				subject: "she",         // he / they
				object: "her",          // him / them
				possessive: "her",      // his / their
				reflexive: "herself",   // himself / themself
				noun: "woman"           // man / person
			  },
			  
		
			body: {
				height: 64, // 5'4"
				breastSize: 4, // "large"
				buttSize: 3, // "round"
				bodyType: 5, // "thick"
				lipFullness: 3, // "full"
				skinTone: "golden",
				muscleTone: 4, // "defined"
				hipWidth: 2, // "wide"
				bodyHair: 1, // "light"
				voiceTone: "melodic",
				hairColor: "fiery red",
				hairStyle: "braided",
				hairLength: 5, // "mid-back"
				eyeColor: "hazel"
			},
		
			preferences: {
				sexualActs: {
					likes: ["Oral_G", "Oral_R", "Spank_G", "HairPulling_G", "Vaginal_P", "Toys_Use", "Dominate"],
					dislikes: ["Submit", "Choke_R"]
				},
				bodyTypes: {
					likes: ["Muscular", "Broad", "Defined"],
					dislikes: ["Emaciated", "Soft"]
				},
				partners: {
					genderPreference: {
						male: 0.9,
						female: 0.1
					},
					anatomyPreference: {
						penisSize: "large",
						breastSize: "medium"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
		allura: {
			name: "Allura",
			defaultName: "Exotic Hostess",
			known: false,
			avatar: "images/portrait_allura.png",
			color: "white",
			bgColor: "rgba(20, 152, 232, 0.6)",

			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,

			traits: ["Flirty", "Cynical", "Confident"],
			inclinations: ["bondage", "dominant", "sadism", "exhibitionism"],
			motivations: ["Pleasure", "Family"],
			socialStyle: "Seductive",
			
			pronouns: {
				subject: "she",
				object: "her",
				possessive: "her",
				reflexive: "herself",
				noun: "woman"
			},

			body: {
				height: 68, // 5'8"
				breastSize: 5, // "very large"
				buttSize: 4, // "plump"
				bodyType: 4, // "curvy"
				lipFullness: 4, // "plump"
				skinTone: "midnight blue",
				muscleTone: 3, // "athletic"
				hipWidth: 3, // "very wide"
				bodyHair: 0, // "smooth"
				voiceTone: "breathy",
				hairColor: "black",
				hairStyle: "voluminous and wild",
				hairLength: 6, // "waist-length"
				eyeColor: "gold",
				horns: "small curled obsidian",
				ears: "long and pointed",

				// Required anatomy
				vagina: true,
				buttSize: 3,
				anus: true,
				clitoris: true,
				
			},

			preferences: {
				sexualActs: {
					likes: [
						"Dominate", "Bondage_Use", "Choke_G", "Spank_G", "Toys_Use",
						"Oral_G", "Oral_R", "FaceSit", "Praise_G", "DirtyTalk_G", "Vaginal_P"
					],
					dislikes: ["Submit", "Cuddling", "Creampie_Preference"]
				},
				bodyTypes: {
					likes: ["Defined", "Broad", "Fit", "Muscular"],
					dislikes: ["Soft", "Emaciated"]
				},
				partners: {
					genderPreference: {
						male: 0.6,
						female: 0.4
					},
					anatomyPreference: {
						penisSize: "large",
						breastSize: "medium"
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},
	
		darian: {
			name: "Darian",
			defaultName: "Male Host",
			known: false,
			avatar: "images/portrait_darian.png",
			color: "white",
			bgColor: "rgba(126, 66, 0, 0.6)",
		
			trust: 3,
			affection: 0,
			rapport: 1.0,
			tension: 0,
			cooldown: 0,
		
			traits: ["Flirty", "Confident", "Charming"],
			inclinations: ["voyeurism", "exhibitionism", "praise", "gentle"],
			motivations: ["Pleasure", "Connection"],
			socialStyle: "Charming",
			
			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },

			body: {
				height: 70, // 5'10"
				breastSize: null,
				buttSize: 3, // "round"
				bodyType: 3, // "average"
				lipFullness: 3, // "full"
				skinTone: 5, // "deep brown"
				muscleTone: 4, // "defined"
				hipWidth: 2, // "modest"
				bodyHair: 1, // "light"
				voiceTone: "melodic",
				hairColor: "black",
				hairStyle: "short and soft",
				hairLength: "short",
				eyeColor: "warm brown",
				penisSize: 7 // inches – proportional, generous but not absurd
			},
		
			preferences: {
				sexualActs: {
					likes: [
						"Praise_G", "Kissing", "Oral_R", "Oral_G", "Cuddling", 
						"Vaginal_P", "Anal_P", "RomanticPlay", "SensualMassage"
					],
					dislikes: ["Degrade_G", "Choke_G", "Spank_G"]
				},
				bodyTypes: {
					likes: ["Curvy", "Average", "Fit", "Soft"],
					dislikes: ["Broad", "VeryTall"]
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "modest",
						breastSize: "full"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},
		
		bert: {
			name: "Bert",
			defaultName: "Brothel Bartender",
			known: false,
			avatar: "images/portrait_bert.png",
			color: "white",
			bgColor: "rgba(74, 76, 69, 0.6)",
		
			trust: 0,
			affection: 0,
			rapport: 1.0,
			tension: 0,
			cooldown: 0,
		
			traits: ["Stoic", "Cynical", "Guarded"],
			inclinations: ["voyeurism", "abstinence"],
			motivations: ["Loyalty", "Devotion"],
			socialStyle: "Stoic",

			pronouns: {
				subject: "he",         // he / they
				object: "him",          // him / them
				possessive: "his",      // his / their
				reflexive: "himself",   // himself / themself
				noun: "man"           // man / person
			  },
		
			body: {
				height: 70, // 5'10"
				breastSize: null,
				buttSize: 2, // modest
				bodyType: 5, // thick
				lipFullness: 1, // narrow
				skinTone: 2, // golden
				muscleTone: 3, // athletic
				hipWidth: 1, // modest
				bodyHair: 2, // natural
				voiceTone: "raspy",
				hairColor: "black with graying at temples",
				hairStyle: "neatly parted",
				hairLength: "cropped",
				eyeColor: "iron gray",
				penisSize: 5.5 // statistically average, likely unused
			},
		
			preferences: {
				sexualActs: {
					likes: [],
					dislikes: ["Oral_G", "Oral_R", "Vaginal_P", "Anal_P", "Toys_Use", "Submit", "Dominate"]
				},
				bodyTypes: {
					likes: [],
					dislikes: []
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "irrelevant",
						breastSize: "irrelevant"
					}
				}
			},
			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			  },
			  
		},

		redmarrow: {
			name: "Leopold Redmarrow",
			defaultName: "Bounty Hunter",
			known: false,
			avatar: "images/portrait_redmarrow.png", // You can swap in your actual filename
			color: "white",
			bgColor: "rgba(132, 54, 54, 0.75)",

			trust: 0,
			affection: 0,
			rapport: 0.5,
			tension: 0,

			traits: ["Flashy", "Evasive", "Charismatic"],
			inclinations: ["performance", "control", "deception"],
			motivations: ["Reputation", "Comfort"],
			socialStyle: "Charming",

			pronouns: {
				subject: "he",
				object: "him",
				possessive: "his",
				reflexive: "himself",
				noun: "man"
			},

			body: {
				height: 71, // 5'11"
				breastSize: null,
				buttSize: 2, // "modest"
				bodyType: 3, // "average"
				lipFullness: 3, // "full"
				skinTone: "light olive",
				muscleTone: 2, // "fit"
				hipWidth: 2, // "modest"
				bodyHair: 1, // "light"
				voiceTone: "silken",
				hairColor: "rich chestnut brown",
				hairStyle: "slicked back under a wide-brimmed hat",
				hairLength: 3, // "short-medium"
				eyeColor: "hazel",
				penisSize: 6.5 // enough for bravado
			},

			preferences: {
				sexualActs: {
					likes: ["Praise_R", "Teasing", "Oral_R", "RomanticPlay"],
					dislikes: ["Submit", "Cuddling", "Anal_P"]
				},
				bodyTypes: {
					likes: ["Elegant", "Fit", "Mysterious"],
					dislikes: ["Disheveled", "OverlyMuscular"]
				},
				partners: {
					genderPreference: {
						male: 0.4,
						female: 0.6
					},
					anatomyPreference: {
						penisSize: "modest",
						breastSize: "medium"
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},

		brakka: {
			name: "Brakka",
			defaultName: "Half-Orc Fighter",
			known: false,
			avatar: "images/portrait_brakka.png", // Swap with actual path
			color: "white",
			bgColor: "rgba(85, 110, 73, 0.8)",

			trust: 0,
			affection: 0,
			rapport: 0.4,
			tension: 0,

			traits: ["Blunt", "Short-Tempered", "Independent"],
			inclinations: ["dominance", "violence", "solitude"],
			motivations: ["Strength", "Respect"],
			socialStyle: "Rough",

			pronouns: {
				subject: "she",
				object: "her",
				possessive: "her",
				reflexive: "herself",
				noun: "woman"
			},

			body: {
				height: 73, // 6'1"
				breastSize: 2, // "modest"
				buttSize: 2, // "modest"
				bodyType: 5, // "muscular"
				lipFullness: 2, // "modest"
				skinTone: "greenish bronze",
				muscleTone: 6, // "ripped"
				hipWidth: 2, // "modest"
				bodyHair: 2, // "natural"
				voiceTone: "gravelly",
				hairColor: "black",
				hairStyle: "shaved sides, top tied back",
				hairLength: 2, // "short"
				eyeColor: "amber"
			},

			preferences: {
				sexualActs: {
					likes: ["Dominate", "Spank_G", "WrestlePlay", "Teasing"],
					dislikes: ["Cuddling", "Praise_R", "Service"]
				},
				bodyTypes: {
					likes: ["Strong", "Lean", "Fit"],
					dislikes: ["Delicate", "OverlySoft"]
				},
				partners: {
					genderPreference: {
						male: 0.5,
						female: 0.5
					},
					anatomyPreference: {
						penisSize: "large",
						breastSize: "irrelevant"
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},

		sarjan: {
			name: "Sarjan",
			defaultName: "Dice Rat Leader",
			known: false,
			avatar: "images/portrait_sarjan.png", // Placeholder path
			color: "white",
			bgColor: "rgba(80, 40, 20, 0.85)",

			trust: -1,
			affection: 0,
			rapport: 0.3,
			tension: 0.6,

			traits: ["Crass", "Mocking", "Dominant"],
			inclinations: ["gambling", "taunting", "misogyny"],
			motivations: ["Control", "Entertainment"],
			socialStyle: "Brash",

			pronouns: {
				subject: "he",
				object: "him",
				possessive: "his",
				reflexive: "himself",
				noun: "man"
			},

			body: {
				height: 69, // 5'9"
				breastSize: null,
				buttSize: 2, // "modest"
				bodyType: 3, // "average"
				lipFullness: 1, // "narrow"
				skinTone: "sallow tan",
				muscleTone: 3, // "defined"
				hipWidth: 2, // "modest"
				bodyHair: 2, // "natural"
				voiceTone: "grating",
				hairColor: "dirty blonde",
				hairStyle: "greased back",
				hairLength: 2, // "short"
				eyeColor: "murky green",
				penisSize: 5.5
			},

			preferences: {
				sexualActs: {
					likes: ["Dominate", "Oral_R", "FaceSit", "Degrade_G"],
					dislikes: ["Submit", "Praise_G", "RomanticPlay"]
				},
				bodyTypes: {
					likes: ["Petite", "Curvy", "Busty"],
					dislikes: ["Muscular", "Androgynous"]
				},
				partners: {
					genderPreference: {
						male: 0.0,
						female: 1.0
					},
					anatomyPreference: {
						breastSize: "large",
						penisSize: null
					}
				}
			},

			status: {
				excitement: 0,
				maxExcitement: 100,
				fatigue: 0,
				maxFatigue: 100
			}
		},


		/* Minor characters */
		diceratone: {
			name: "Dice Rat 1",
			defaultName: "Skinny Dice-Rat",
			known: false,
			avatar: "images/portrait_diceratone.png", // Placeholder path
			color: "white",
			bgColor: "rgba(182, 89, 2, 0.85)",
		},
		dicerattwo: {
			name: "Dice Rat 2",
			defaultName: "Fat Dice-Rat",
			known: false,
			avatar: "images/portrait_dicerattwo.png", // Placeholder path
			color: "white",
			bgColor: "rgba(182, 89, 2, 0.85)",
		},

	};
};
  
  /* Character Dialogue & Avatars - End */
/* twine-user-script #12: "05_sidebarlogic.js" */
setup.SidebarUI = {
	update() {
		const sidebar = document.getElementById("custom-sidebar");
		const wasCollapsed = State.variables.sidebarCollapsed;

		if (!State.variables.player || !State.variables.world) {
			console.warn("SidebarUI: Player or World data missing.");
			return;
		}

		this.updateStatuses();
		this.updateCarryWeight();
		this.updateLevelAndExp();
		this.updateGold();
		this.updateTime();
		this.updateDate();
		this.updateWeather();
		this.updateSummaryIcons();

		// Reapply collapsed state after rendering
		if (wasCollapsed && sidebar) {
			sidebar.classList.add("collapsed");
			document.body.classList.add("sidebar-collapsed");

			const summary = document.getElementById("sidebar-summary");
			const content = document.getElementById("sidebar-content");
			if (summary) summary.style.display = "flex";
			if (content) content.style.display = "none";

			const toggleButton = document.getElementById("sidebar-toggle");
			if (toggleButton) {
				toggleButton.style.position = "initial";
			}
		}
	},


	updateStatuses() {
		const status = State.variables.player.status;

		const bars = [
			{ id: "health", value: status.health, max: status.maxHealth },
			{ id: "fatigue", value: status.fatigue, max: status.maxFatigue },
			{ id: "composure", value: status.composure, max: status.maxComposure },
			{ id: "excitement", value: status.excitement, max: status.maxExcitement }
		];

		bars.forEach(bar => {
			const fill = document.getElementById(`${bar.id}-fill`);
			if (fill) {
				const percent = (bar.value / bar.max) * 100;
				fill.style.width = `${percent}%`;

				if (percent >= 70) {
					fill.style.background = "linear-gradient(90deg, #4caf50, #81c784)";
				} else if (percent >= 30) {
					fill.style.background = "linear-gradient(90deg, #ff9800, #ffc107)";
				} else {
					fill.style.background = "linear-gradient(90deg, #f44336, #e57373)";
				}
			}
		});
	},

	updateCarryWeight() {
		const weight = State.variables.player.carryWeight;
		const carryContainer = document.getElementById("sidebar-carryweight");
		const carryFill = document.getElementById("carry-fill");
		const carryText = document.getElementById("carryweight-text");

		if (!weight || !carryContainer || !carryFill || !carryText) return;

		const percent = (weight.current / weight.max) * 100;

		if (percent >= 85) {
			carryContainer.style.display = "block";
			carryFill.style.width = `${percent}%`;
			carryText.textContent = `Carryweight: ${weight.current}/${weight.max}`;
		} else {
			carryContainer.style.display = "none";
		}
	},

	updateLevelAndExp() {
		const player = State.variables.player;
		const expPercent = (player.experience / player.experienceToNextLevel) * 100;

		const expFill = document.getElementById("exp-fill");
		const expText = document.getElementById("exp-text");
		const levelText = document.getElementById("sidebar-level");

		if (expFill) expFill.style.width = `${expPercent}%`;
		if (expText) expText.textContent = `${player.experience}/${player.experienceToNextLevel} XP`;
		if (levelText) levelText.textContent = `Lvl ${player.level}`;

		const miniFill = document.getElementById("exp-fill-mini");
		const miniLevel = document.getElementById("summary-level");
		if (miniFill) miniFill.style.width = `${expPercent}%`;
		if (miniLevel) miniLevel.textContent = `Lvl ${player.level}`;
	},

	updateTime() {
		const world = State.variables.world;
		if (!world) return;

		const hours = world.hour;
		const minutes = world.minute.toString().padStart(2, "0");
		let timeString = "";

		if (world.is24HourFormat) {
			timeString = `${hours}:${minutes}`;
		} else {
			const suffix = hours >= 12 ? "PM" : "AM";
			const hour12 = ((hours + 11) % 12 + 1);
			timeString = `${hour12}:${minutes} ${suffix}`;
		}

		const timeDisplay = document.getElementById("sidebar-time");
		const timeSummary = document.getElementById("summary-time");

		if (timeDisplay) timeDisplay.textContent = timeString;
		if (timeSummary) timeSummary.textContent = timeString;
	},

	updateDate() {
		const world = State.variables.world;
		if (!world) return;

		const seasons = ["Rain", "Sun", "Harvest", "Snow"];
		const seasonIndex = Math.floor((world.dayOfYear - 1) / 100);
		const seasonDay = ((world.dayOfYear - 1) % 100) + 1;
		const seasonName = seasons[seasonIndex] || "Unknown";

		const dateString = `${seasonDay} of ${seasonName}, ${world.year} AI`;

		const dateDisplay = document.getElementById("sidebar-date");
		if (dateDisplay) dateDisplay.textContent = dateString;
	},

	updateWeather() {
		const world = State.variables.world;
		const icon = document.getElementById("sidebar-weather-icon");

		if (!icon || !world) return;

		const weatherIcons = {
			"Clear": "sun",
			"Rain": "cloud-rain",
			"Storm": "cloud-lightning",
			"Snow": "snowflake",
			"Fog": "cloud-fog"
		};

		const weatherName = world.weather || "Clear";
		const iconName = weatherIcons[weatherName] || "sun";

		icon.setAttribute("data-lucide", iconName);
		icon.setAttribute("title", weatherName);

		if (window.lucide) {
			lucide.createIcons();
		}
	},

	updateSummaryIcons() {
		const status = State.variables.player.status;

		const icons = [
			{ id: "summary-health", fillId: "summary-health-fill", value: status.health, max: status.maxHealth },
			{ id: "summary-fatigue", fillId: "summary-fatigue-fill", value: status.fatigue, max: status.maxFatigue },
			{ id: "summary-composure", fillId: "summary-composure-fill", value: status.composure, max: status.maxComposure },
			{ id: "summary-excitement", fillId: "summary-excitement-fill", value: status.excitement, max: status.maxExcitement }
		];

		icons.forEach(icon => {
			const iconEl = document.getElementById(icon.id);
			const fillEl = document.getElementById(icon.fillId);
			const percent = Math.max(0, Math.min(100, (icon.value / icon.max) * 100));

			if (fillEl) {
				fillEl.style.height = `${percent}%`;
			}

			if (iconEl) {
				iconEl.classList.remove("low", "mid", "high");

				if (percent >= 70) {
					iconEl.classList.add("high");
					iconEl.style.filter = "drop-shadow(0 0 3px #4caf50cc)";
				} else if (percent >= 30) {
					iconEl.classList.add("mid");
					iconEl.style.filter = "drop-shadow(0 0 2px #ffc107cc)";
				} else {
					iconEl.classList.add("low");
					iconEl.style.filter = "drop-shadow(0 0 2px #f44336cc)";
				}
			}
		});
	},

	getGoldAmount() {
		const inventory = State.variables.inventory_player;
		if (!inventory) return 0;

		return inventory["gold_coin"] || 0;
	},


	updateGold() {
		const gold = this.getGoldAmount();
		const goldDisplay = document.getElementById("sidebar-gold-amount");
		const goldSummary = document.getElementById("summary-gold");

		const formattedGold = gold >= 1000 ? (gold / 1000).toFixed(1) + "K" : gold;

		if (goldDisplay) goldDisplay.textContent = formattedGold;
		if (goldSummary) goldSummary.textContent = formattedGold;
	},

	toggleSidebar() {
		const sidebar = document.getElementById("custom-sidebar");
		const arrow = document.getElementById("sidebar-arrow");
		const toggleButton = document.getElementById("sidebar-toggle");
		const summary = document.getElementById("sidebar-summary");
		const content = document.getElementById("sidebar-content");

		if (!sidebar || !summary || !content) {
			console.warn("[SidebarUI] Sidebar or required elements not found.");
			return;
		}

		sidebar.classList.toggle("collapsed");
		const isCollapsed = sidebar.classList.contains("collapsed");

		// SAVE collapsed state in State.variables
		State.variables.sidebarCollapsed = isCollapsed;

		document.body.classList.toggle("sidebar-collapsed", isCollapsed);

		if (arrow) {
			arrow.style.transform = isCollapsed ? "rotate(180deg)" : "rotate(0deg)";
		}

		if (toggleButton) {
			toggleButton.style.position = isCollapsed ? "initial" : "fixed";
		}

		summary.style.display = isCollapsed ? "flex" : "none";
		content.style.display = isCollapsed ? "none" : "block";

		this.update();
		console.log(`[SidebarUI] Sidebar is now ${isCollapsed ? "collapsed" : "expanded"}.`);
	},


	updateSidebar() {
		const player = State.variables.player;
		const world = State.variables.world;
		const inventory = State.variables.inventory_player || {};

		if (!player || !world) {
			console.warn("[SidebarUI] Player or WorldState missing — cannot update sidebar.");
			return;
		}

		this.updateText("sidebar-time", this.formatWorldTime(world.hour, world.minute, world.is24HourFormat));
		this.updateText("sidebar-date", this.formatWorldDate(world.dayOfYear, world.year));
		this.updateText("sidebar-location", world.locationName || "Unknown Location");

		this.updateWeatherIcon(world.weather);

		const goldAmount = this.getGoldAmount();
		this.updateText("sidebar-gold-amount", this.abbreviateGold(goldAmount));
		this.updateText("summary-gold", this.abbreviateGold(goldAmount));

		this.updateText("summary-level", `Lvl ${player.level}`);
		this.updateExpBars(player);
		this.updateStatusBars(player);

		this.updateStatusIcon("summary-health", player.status.health, player.status.maxHealth);
		this.updateStatusIcon("summary-fatigue", player.status.fatigue, player.status.maxFatigue, true);
		this.updateStatusIcon("summary-composure", player.status.composure, player.status.maxComposure);
		this.updateStatusIcon("summary-excitement", player.status.excitement, player.status.maxExcitement);

		this.updateConditionalStatusIcons(player.status);
	},

	updateText(id, text) {
		const el = document.getElementById(id);
		if (el) el.textContent = text;
	},

	updateWeatherIcon(weatherType) {
		const icon = document.getElementById("sidebar-weather-icon");
		if (!icon) return;

		const weatherIcons = {
			Clear: "sun",
			Rain: "cloud-rain",
			Storm: "cloud-lightning",
			Snow: "cloud-snow",
			Fog: "cloud-fog"
		};

		const iconName = weatherIcons[weatherType] || "sun";
		icon.setAttribute("data-lucide", iconName);

		if (window.lucide) {
			lucide.createIcons();
		}
	},

	abbreviateGold(amount) {
		if (amount >= 1_000_000) return (amount / 1_000_000).toFixed(1) + "M";
		if (amount >= 1_000) return (amount / 1_000).toFixed(1) + "K";
		return amount.toString();
	},

	updateExpBars(player) {
		const percent = Math.min((player.experience / player.experienceToNextLevel) * 100, 100);
		this.setFillWidth("exp-fill", percent);
		this.setFillWidth("exp-fill-mini", percent);
		this.updateText("exp-text", `${player.experience}/${player.experienceToNextLevel} XP`);
	},

	updateStatusBars(player) {
		this.setFillWidth("health-fill", (player.status.health / player.status.maxHealth) * 100);
		this.setFillWidth("fatigue-fill", (player.status.fatigue / player.status.maxFatigue) * 100);
		this.setFillWidth("composure-fill", (player.status.composure / player.status.maxComposure) * 100);
		this.setFillWidth("excitement-fill", (player.status.excitement / player.status.maxExcitement) * 100);
	},

	setFillWidth(id, percent) {
		const fill = document.getElementById(id);
		if (fill) {
			fill.style.width = `${Math.min(Math.max(percent, 0), 100)}%`;
		}
	},

	updateStatusIcon(iconId, current, max, inverse = false) {
		const icon = document.getElementById(iconId);
		if (!icon) return;

		const ratio = current / max;
		let color = "white";

		if (inverse) {
			color = ratio >= 0.75 ? "red" : ratio >= 0.5 ? "orange" : "green";
		} else {
			color = ratio <= 0.25 ? "red" : ratio <= 0.5 ? "orange" : "green";
		}

		icon.style.stroke = color;
	},

	updateConditionalStatusIcons(status) {
		const container = document.getElementById("summary-conditions");
		if (!container) return;

		container.innerHTML = "";

		const effects = [
			{ key: "poisoned", icon: "skull" },
			{ key: "intoxicated", icon: "glass-water" },
			{ key: "charmed", icon: "heart-handshake" },
			{ key: "burning", icon: "flame" },
			{ key: "bleeding", icon: "droplet" },
			{ key: "stunned", icon: "zap-off" }
		];

		effects.forEach(effect => {
			if (status[effect.key]) {
				const newIcon = document.createElement("i");
				newIcon.setAttribute("data-lucide", effect.icon);
				newIcon.style.width = "16px";
				newIcon.style.height = "16px";
				container.appendChild(newIcon);
			}
		});

		if (window.lucide) {
			lucide.createIcons();
		}
	},

	formatWorldTime(hour, minute, is24h) {
		if (is24h) {
			return `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}`;
		} else {
			const ampm = hour >= 12 ? "PM" : "AM";
			const h12 = hour % 12 || 12;
			return `${h12}:${minute.toString().padStart(2, "0")} ${ampm}`;
		}
	},

	formatWorldDate(dayOfYear, year) {
		const seasons = ["Rain", "Sun", "Harvest", "Snow"];
		const seasonLength = 100;
		const seasonIndex = Math.floor((dayOfYear - 1) / seasonLength);
		const seasonDay = ((dayOfYear - 1) % seasonLength) + 1;
		const season = seasons[seasonIndex] || "Unknown";
		return `${seasonDay} of ${season}, ${year} AI`;
	},

	tryLucideIcons() {
		if (typeof lucide !== "undefined") {
			lucide.createIcons();
			console.log("[SidebarUI] Lucide icons rendered successfully!");
		} else {
			console.warn("[SidebarUI] Lucide not ready yet — retrying in 250ms...");
			setTimeout(this.tryLucideIcons, 250);
		}
	}
};


/* Dedicated button handlers */
  
$(document).on("click", "#btn-saves", () => {
	if (typeof UI?.saves === "function") UI.saves();
});


$(document).on("click", "#sidebar-nav-back", () => {
	console.log("[SidebarUI] Back clicked — invoking Engine.backward()");
	Engine.backward();
});

$(document).on("click", "#sidebar-nav-forward", () => {
	console.log("[SidebarUI] Forward clicked — invoking Engine.forward()");
	Engine.forward();
});

$(document).on("click", "#sidebar-toggle", () => {
	if (typeof setup?.SidebarUI?.toggleSidebar === "function") {
		setup.SidebarUI.toggleSidebar();
	} else {
		console.warn("[SidebarUI] toggleSidebar() is not defined.");
	}
});

$(document).on("click", "#sidebar-options", () => {
	const UI = SugarCube?.UI;
	if (typeof UI?.settings === "function") {
		console.log("[SidebarUI] Opening Settings dialog.");
		UI.settings();
	} else {
		console.warn("[SidebarUI] SugarCube.UI.settings() not available.");
	}
});


/* Sidebar Updating with every click and passage change */
// Update sidebar on every passage load
$(document).on(":passagedisplay", () => {
	if (typeof setup?.SidebarUI?.update === "function") {
		setup.SidebarUI.update();
	}

	// Re-render the minimap after the sidebar refresh wipes DOM
	if (MapSystem?.currentMap) {
		MapSystem.updateMinimapDisplay();
	}
});


// Throttled update on every click (avoids spamming)
let sidebarUpdateTimeout;
document.addEventListener("click", () => {
	clearTimeout(sidebarUpdateTimeout);
	sidebarUpdateTimeout = setTimeout(() => {
		if (typeof setup?.SidebarUI?.update === "function") {
			setup.SidebarUI.update();
		}
	}, 50);
});





/* twine-user-script #13: "06_loader.js" */
(() => {
	function getMessage(O) {
		if (O == null) return 'unknown error';
		return typeof O === 'object' && 'message' in O ? O.message : String(O);
	}

	Story.lookup('tags', 'style').forEach((p, i) => {
		try {
			const swrap = new StyleWrapper(document.createElement('style'));
			swrap.add(Scripting.evalJavaScript('`' + p.text.trim() + '`'));
			jQuery(swrap.style).appendTo(document.head).attr({
				id: `style-story-extra-${i}`,
				name: p.title,
				type: 'text/css'
			});
		} catch (ex) {
			console.error(ex);
			Alert.error(p.name, getMessage(ex));
		}
	});

	Story.lookup('tags', 'script').forEach(p => {
		try {
			Scripting.evalJavaScript(p.text);
		} catch (ex) {
			console.error(ex);
			Alert.error(p.name, getMessage(ex));
		}
	});
})();
/* twine-user-script #14: "08_debugTools.js" */
postdisplay["logItemData"] = function () {
	if (setup.ItemData) {
		console.log("📦 Available items:", Object.keys(setup.ItemData));
	} else {
		console.error("❌ setup.ItemData is not defined.");
	}
};
/* twine-user-script #15: "01_InventoryLibrary.js" */
/* =============================
= ITEM METADATA LOADER - START =
============================= */
if (typeof setup === 'undefined') {
	setup = {};
}
if (typeof setup.ItemData === 'undefined') {
	setup.ItemData = {};
}
/* =============================
=     Weapons - Daggers     =
============================= */
setup.ItemData.dagger_silver = {
  id: "dagger_silver",
  name: "Silvered Dagger",
  type: "weapon",
  subtype: "dagger",
  tags: ["piercing", "1H", "anti-undead"],
  material: "Silver",
  rarity: 1,
  damage: { piercing:[3,6]},
  weight: 1.5,
  value: 450,
  img: "weapon_dagger_silver.png",
  description: "A silver-plated longsword favored by monster hunters. Effective against undead."
};

/* =============================
=     Weapons - Longswords     =
============================= */
setup.ItemData.test_longsword = {
  id: "test_longsword",
  name: "TEST_Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "1H", "devOnly"],
  material: "Debugium",
  rarity: 0,
  damage: { slashing: 1 },
  weight: 1.0,
  value: 0,
  img: "default.png",
  description: "Developer test item. Should never appear in gameplay."
};
setup.ItemData.longsword_wood = {
  id: "longsword_wood",
  name: "Wooden Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H"],
  material: "Wood",
  rarity: 1,
  damage: { slashing: 1, blunt: 1 },
  weight: 4.5,
  value: 35,
  img: "longsword_wood.png",
  description: "A crude longsword carved from hardwood. Splinters easily but better than bare fists."
};
setup.ItemData.longsword_iron = {
  id: "longsword_iron",
  name: "Iron Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H"],
  material: "Iron",
  rarity: 1,
  damage: { slashing: 4, piercing: 2 },
  weight: 6.0,
  value: 120,
  img: "longsword_iron.png",
  description: "A basic iron longsword. Cheap, functional, and widely available."
};
setup.ItemData.longsword_steel = {
  id: "longsword_steel",
  name: "Steel Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H"],
  material: "Steel",
  rarity: 1,
  damage: { slashing: 6, piercing: 3 },
  weight: 5.5,
  value: 280,
  img: "longsword_steel.png",
  description: "A dependable steel blade with a good balance of weight and edge."
};
setup.ItemData.longsword_silver = {
  id: "longsword_silver",
  name: "Silvered Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "anti-undead"],
  material: "Silver",
  rarity: 1,
  damage: { slashing: 6, piercing: 4 },
  weight: 5.5,
  value: 750,
  img: "longsword_silver.png",
  description: "A silver-plated longsword favored by monster hunters. Effective against undead."
};
setup.ItemData.longsword_mithril = {
  id: "longsword_mithril",
  name: "Mithril Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "lightweight"],
  material: "Mithril",
  rarity: 1,
  damage: { slashing: 12, piercing: 10 },
  weight: 2.5,
  value: 5555,
  img: "longsword_mithril.png",
  description: "An elegantly forged mithril blade—light as air, sharp as steel."
};
setup.ItemData.longsword_adamantine = {
  id: "longsword_adamantine",
  name: "Adamantine Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "armor-piercing"],
  material: "Adamantine",
  rarity: 1,
  damage: { slashing: 14, piercing: 9 },
  weight: 7.0,
  value: 6000,
  img: "longsword_adamantine.png",
  description: "A heavy, unyielding blade forged from adamantine. Ideal for cleaving through armor."
};
setup.ItemData.longsword_obsidian = {
  id: "longsword_obsidian",
  name: "Obsidian Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "brittle"],
  material: "Obsidian",
  rarity: 1,
  damage: { slashing: 12, piercing: 4 },
  weight: 5.0,
  value: 420,
  img: "longsword_obsidian.png",
  description: "Forged from volcanic glass. Razor sharp but fragile—handle with care."
};
setup.ItemData.longsword_eldwood = {
  id: "longsword_eldwood",
  name: "Eldwood Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "nature-attuned", "lightweight"],
  material: "Eldwood",
  rarity: 1,
  damage: { slashing: 7, piercing: 5 },
  weight: 2.5,
  value: 400,
  img: "longsword_eldwood.png",
  description: "Made from magically reinforced Eldwood. Lighter than steel and flexible."
};
setup.ItemData.longsword_starforged = {
  id: "longsword_starforged",
  name: "Starforged Longsword",
  type: "weapon",
  subtype: "longsword",
  tags: ["slashing", "piercing", "1H", "magic-conductive"],
  material: "Starforged Alloy",
  rarity: 1,
  damage: { slashing: 18, piercing: 12 },
  weight: 4.0,
  value: 11480,
  img: "longsword_starforged.png",
  description: "Forged from metal fallen from the stars. Emits a faint, pulsing energy."
};

/* =============================
=        Weapons - Spears      =
============================= */
setup.ItemData.spear_wood = {
  id: "spear_wood",
  name: "Wooden Spear",
  type: "weapon",
  subtype: "spear",
  tags: ["piercing", "2H", "reach"],
  material: "Wood",
  rarity: 1,
  damage: { piercing: 2 },
  weight: 4.0,
  value: 30,
  img: "spear_wood.png",
  description: "A long wooden shaft sharpened to a point. Basic, but effective at range."
};
setup.ItemData.spear_obsidian = {
	id: "spear_obsidian",
	name: "Obsidian Spear",
	type: "weapon",
	subtype: "spear",
	tags: ["piercing", "2H", "reach", "brittle"],
	material: "Obsidian",
	rarity: 1,
	damage: { piercing: 11, slashing: 1 },
	weight: 4.5,
	value: 390,
	img: "spear_obsidian.png",
	description: "A razor-sharp obsidian tip gives this spear excellent cutting power—if it doesn't shatter."
};
setup.ItemData.spear_eldwood = {
	id: "spear_eldwood",
	name: "Eldwood Spear",
	type: "weapon",
	subtype: "spear",
	tags: ["piercing", "2H", "reach", "nature-attuned", "lightweight"],
	material: "Eldwood",
	rarity: 1,
	damage: { piercing: 9 },
	weight: 2.8,
	value: 390,
	img: "spear_eldwood.png",
	description: "Light, flexible, and magically attuned to natural energies. A favorite of forest guardians."
};
setup.ItemData.spear_starforged = {
	id: "spear_starforged",
	name: "Starforged Spear",
	type: "weapon",
	subtype: "spear",
	tags: ["piercing", "2H", "reach", "magic-conductive"],
	material: "Starforged Alloy",
	rarity: 1,
	damage: { piercing: 16, slashing: 2 },
	weight: 3.8,
	value: 11000,
	img: "spear_starforged.png",
	description: "A sleek weapon of alien alloy, humming faintly with arcane resonance."
};

/* =============================
=          Armor Items         =
============================= */
setup.ItemData.test_helmet = {
	id: "test_helmet",
	name: "TEST_Helmet",
	type: "armor",
	subtype: "helmet",
	tags: ["head", "light", "devOnly"],
	material: "Debugium",
	rarity: 0,
	resist: { slashing: 1, blunt: 1 },
	weight: 0.5,
	value: 0,
	img: "default.png",
	description: "Developer test helmet. Not for actual use."
};

/* =============================
=      Consumable Items        =
============================= */
setup.ItemData.test_snack = {
	id: "test_snack",
	name: "TEST_Snack",
	type: "consumable",
	subtype: "food",
	tags: ["healing", "devOnly"],
	stats: { health: 1, energy: 1 },
	weight: 0.1,
	value: 0,
	img: "default.png",
	description: "Consumable test item. Used for system validation."
};
/* =============================
=      Literature Items        =
============================= */
 setup.ItemData["scroll_firebolt"] = {
	id: "scroll_firebolt",
	name: "Scroll of Firebolt",
	type: "literature",
	subtype: "scroll",
	tags: ["magic", "single-use", "spell"],
	weight: 0.1,
	value: 35,
	img: "scroll_firebolt.png",
	description: "A tightly rolled parchment containing the incantation for Firebolt.",
	effects: "Casts Firebolt when read. Consumed upon use."
};
 
  
/* =============================
=       Quest Items            =
============================= */
setup.ItemData.test_scroll = {
	id: "test_questscroll",
	name: "TEST_QuestScroll",
	type: "quest",
	subtype: "debug",
	tags: ["quest", "devOnly"],
	weight: 0.0,
	value: 0,
	img: "default.png",
	description: "Placeholder scroll for quest system testing."
};

/* =============================
=         Misc Items           =
============================= */
setup.ItemData.test_token = {
	id: "test_token",
	name: "TEST_Token",
	type: "misc",
	subtype: "debug",
	tags: ["trinket", "devOnly"],
	weight: 0.2,
	value: 0,
	img: "default.png",
	description: "Debug token for inventory/UI validation. Not obtainable."
};
setup.ItemData.gold_coin = {
	id: "gold_coin",
	name: "Gold Coin",
	type: "misc",
	subtype: "currency",
	tags: ["currency", "non-negotiable"],
	weight: 0.00,
	value: 1,
	img: "item_currency_gold_coin.png",
	description: "A single gold coin. Stamped and standardized. Its value never fluctuates.",
	fixedValue: true
};
setup.ItemData.lucky_horseshoe = {
	id: "lucky_horseshoe",
	name: "Lucky Horseshoe",
	type: "misc",
	subtype: "curio",
	tags: ["trinket", "buff-lucky"],
	weight: 0.3,
	value: 10,
	img: "default.png",
	description: "A slightly bent iron horseshoe said to bring good fortune to its bearer.",
	effects: "Grants the 'Lucky' buff while in inventory. Increases favorability of dice rolls."
};

/* =============================
=       Crown Dice Items       =
============================= */
setup.ItemData.crown_die_balanced = {
	id: "crown_die_balanced",
	name: "Balanced Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "balanced"],
	weight: 0.1,
	value: 50,
	img: "default.png",
	description: "A perfectly balanced eight-sided die made from polished bone. Standard d8 probabilities.",
	roll() {
		return Math.ceil(Math.random() * 8);
	}
};

setup.ItemData.crown_die_even_weighted = {
	id: "crown_die_even_weighted",
	name: "Even-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "even-weighted"],
	weight: 0.1,
	value: 120,
	img: "default.png",
	description: "A crown die with subtle weight distribution favoring even numbers (2, 4, 6, 8).",
	roll() {
		const rand = Math.random();
		// 60% chance for even numbers (2,4,6,8), 40% for odd (1,3,5,7)
		if (rand < 0.6) {
			return [2, 4, 6, 8][Math.floor(Math.random() * 4)];
		} else {
			return [1, 3, 5, 7][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_odd_weighted = {
	id: "crown_die_odd_weighted",
	name: "Odd-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "odd-weighted"],
	weight: 0.1,
	value: 120,
	img: "default.png",
	description: "A crown die with subtle weight distribution favoring odd numbers (1, 3, 5, 7).",
	roll() {
		const rand = Math.random();
		// 60% chance for odd numbers (1,3,5,7), 40% for even (2,4,6,8)
		if (rand < 0.6) {
			return [1, 3, 5, 7][Math.floor(Math.random() * 4)];
		} else {
			return [2, 4, 6, 8][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_high_weighted = {
	id: "crown_die_high_weighted",
	name: "High-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "high-weighted"],
	weight: 0.1,
	value: 180,
	img: "default.png",
	description: "A crown die weighted to favor higher numbers (5, 6, 7, 8).",
	roll() {
		const rand = Math.random();
		// 65% chance for high numbers (5,6,7,8), 35% for low (1,2,3,4)
		if (rand < 0.65) {
			return [5, 6, 7, 8][Math.floor(Math.random() * 4)];
		} else {
			return [1, 2, 3, 4][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_low_weighted = {
	id: "crown_die_low_weighted",
	name: "Low-Weighted Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "low-weighted"],
	weight: 0.1,
	value: 180,
	img: "default.png",
	description: "A crown die weighted to favor lower numbers (1, 2, 3, 4).",
	roll() {
		const rand = Math.random();
		// 65% chance for low numbers (1,2,3,4), 35% for high (5,6,7,8)
		if (rand < 0.65) {
			return [1, 2, 3, 4][Math.floor(Math.random() * 4)];
		} else {
			return [5, 6, 7, 8][Math.floor(Math.random() * 4)];
		}
	}
};

setup.ItemData.crown_die_lucky = {
	id: "crown_die_lucky",
	name: "Lucky Crown Die",
	type: "misc",
	subtype: "crown-die",
	tags: ["crown-die", "lucky", "rare"],
	weight: 0.1,
	value: 300,
	img: "default.png",
	description: "A rare crown die carved from lucky stone. Slightly favors rolling 7s and 8s.",
	roll() {
		const rand = Math.random();
		// 30% chance for 7 or 8, 70% for normal distribution
		if (rand < 0.15) {
			return 7;
		} else if (rand < 0.30) {
			return 8;
		} else {
			return Math.ceil(Math.random() * 8);
		}
	}
};

console.log("✅ ItemData loaded:", Object.keys(setup.ItemData));
/* =============================
= ITEM METADATA LOADER - END =
============================= */
/* twine-user-script #16: "02_InventorySystem.js" */

/* Utility: Find item metadata from unified pool */
function getItemMetadata(id) {
	debugLog(`📦 getItemMetadata() called with id: '${id}'`);

	if (!setup.ItemData) {
		console.error("❌ setup.ItemData is undefined!");
		return null;
	}

	const item = setup.ItemData[id];
	if (!item) {
		console.warn(`⚠️ Item '${id}' NOT found in setup.ItemData.`);
		return null;
	}

	debugLog(`✅ Item '${id}' found in setup.ItemData:`, item);
	return item;
}
window.getItemMetadata = getItemMetadata;

/* Inventory Column Templates */
setup.inventoryHeaders = {
	all: ["Item Name", "Type", "Weight", "Value", "Amount"],
	weapons: ["Item Name", "Subtype", "Damage", "Weight", "Value", "Amount"],
	armor: ["Item Name", "Slot", "Armor Value", "Armor Class", "Weight", "Value", "Amount"],
	consumable: ["Item Name", "Consumable Type", "Affected Stats", "Stat Amounts", "Weight", "Value", "Amount"],
	quest: ["Item Name", "Subtype", "Weight", "Value", "Amount"],
	misc: ["Item Name", "Subtype", "Weight", "Value", "Amount"]
};

/* Highlight Active Inventory Tab */
setup.selectInventoryTab = function(category) {
	document.querySelectorAll(".inv-tab").forEach(btn => btn.classList.remove("active"));
	const active = document.querySelector(`.inv-tab[data-tab="${category}"]`);
	if (active) active.classList.add("active");

	setup.renderInventory("player", category);
};

/* Format Helpers */
setup.renderDamageIcons = function(damage) {
	if (!damage) return "";
	return Object.entries(damage).map(([type, val]) => `|${type}| ${val}`).join(" ");
};

setup.renderStatEffects = function(effects) {
	if (!effects) return "";
	return Object.entries(effects).map(([stat, val]) => `|${stat}| ${val}`).join(" ");
};

/* Macro: Add or Subtract Items from Inventory */
/* Structure: <<additem "target" "itemId" amount>> */
/* Example usage: <<additem "player" "gold_coin" 100>> */
Macro.add("additem", {
	handler() {
		console.log("🔥 [additem] macro invoked — args:", this.args);

		const [target, itemId, amountRaw] = this.args;
		const amount = parseInt(amountRaw);

		if (!target || !itemId || isNaN(amount)) {
			console.warn("⚠️ [additem] called with invalid or missing arguments:", this.args);
			console.warn("⚠️ Expected usage: additem 'target' 'itemId' amount — skipping execution.");
			return;
		}

		const itemData = getItemMetadata(itemId);
		if (!itemData) {
			console.warn(`⚠️ Item '${itemId}' not found in metadata — cannot add to inventory.`);
			return;
		}

		const varName = `inventory_${target}`;
		if (!State.variables[varName]) {
			debugLog(`📦 No inventory found for '${target}' — creating new one`);
			State.variables[varName] = {};
		}

		const inventory = State.variables[varName];

		if (!inventory[itemId]) {
			inventory[itemId] = 0;
			debugLog(`📦 Initializing '${itemId}' to 0 in '${target}' inventory`);
		}

		inventory[itemId] += amount;
		debugLog(`➕ '${itemId}' in '${target}' inventory is now: ${inventory[itemId]}`);

		if (inventory[itemId] <= 0) {
			debugLog(`🗑️ '${itemId}' count zero or below — removing from inventory`);
			delete inventory[itemId];
		}

		/* === Sidebar update on run === */
		if (setup.SidebarUI?.update && document.getElementById("custom-sidebar")) {
			setup.SidebarUI.update();
		}

	}
});


/* Drop Button Logic - Start */
function dropCustomAmount() {
	const amount = prompt("How many do you want to drop?");
	const parsed = parseInt(amount);
	if (!isNaN(parsed) && parsed > 0) {
		console.log(`🗑️ Would drop ${parsed} item(s) — placeholder logic`);
		// TODO: Hook into additem with negative value
	} else {
		alert("Invalid number.");
	}
}
/* Drop Button Logic - End */

/* Renderer: Inventory Display */
setup.renderInventory = function (target = "player", category = "all") {
	debugLog(`🧾 renderInventory() for '${target}' — Category: '${category}'`);

	const inventory = State.variables[`inventory_${target}`];
	if (!inventory) {
		console.warn(`⚠️ No inventory found for '${target}'`);
		return `<tr><td colspan="6"><em>Inventory is empty.</em></td></tr>`;
	}

	const tableBody = document.getElementById("inventory-list");
	const tableHead = document.querySelector("#inventory-table thead tr");

	if (!tableBody || !tableHead) {
		console.warn("⚠️ Table structure not found.");
		return;
	}

	// Reset table head
	tableHead.innerHTML = "";
	const headers = setup.inventoryHeaders[category] || setup.inventoryHeaders["all"];
	headers.forEach(h => {
		const th = document.createElement("th");
		th.textContent = h;
		tableHead.appendChild(th);
	});

	// Reset body
	tableBody.innerHTML = "";
	let itemsShown = 0;

	for (const itemId in inventory) {
		const quantity = inventory[itemId];
		const item = getItemMetadata(itemId);
		if (!item) continue;

		if (category !== "all" && item.type !== category && item.subtype !== category) {
			continue;
		}

		const tr = document.createElement("tr");
		tr.classList.add("inventory-row");
		tr.dataset.itemId = item.id;

		// Row content per category
		let rowHTML = "";

		switch (category) {
			case "weapons":
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.subtype || ""}</td>`;
				rowHTML += `<td>${setup.renderDamageIcons(item.damage)}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;

			case "armor":
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.slot || "—"}</td>`;
				rowHTML += `<td>${setup.renderDamageIcons(item.armor || {})}</td>`;
				rowHTML += `<td>${item.armorClass || "Unarmored"}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;

			case "consumable":
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.subtype || ""}</td>`;
				rowHTML += `<td>${setup.renderStatEffects(item.effects)}</td>`;
				rowHTML += `<td>${setup.renderStatEffects(item.effects)}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;

			default:
				rowHTML += `<td>${item.name}</td>`;
				rowHTML += `<td>${item.subtype || item.type}</td>`;
				rowHTML += `<td>${item.weight}</td>`;
				rowHTML += `<td>${item.value}</td>`;
				rowHTML += `<td>x${quantity}</td>`;
				break;
		}

		tr.innerHTML = rowHTML;
		tableBody.appendChild(tr);
		itemsShown++;
	}

	if (itemsShown === 0) {
		tableBody.innerHTML = `<tr><td colspan="${headers.length}"><em>No items in this category.</em></td></tr>`;
	}
};

/* Condensed Paperdoll Support */
setup.updateCondensedPaperdoll = function () {
  const equipped = State.variables.equipped || {};

  const slotMap = [
    "head", "face", "neck", "back", "chest", "main", "sec",
    "pants", "feet", "ring1", "ring2", "ring3"
  ];

  // Standard slots
  slotMap.forEach(slot => {
    const el = document.getElementById(`slot-${slot}-text`);
    if (el) {
      const item = equipped[slot];
      el.textContent = item ? item.name || item.id : "Empty";
    }
  });

  // Special case: gloves (shared)
  const glovesEl = document.getElementById(`slot-gloves-text`);
  if (glovesEl) {
    const gloveItem = equipped["gloves"];
    glovesEl.textContent = gloveItem ? gloveItem.name || gloveItem.id : "Empty";
  }
};

document.addEventListener("DOMContentLoaded", () => {
  if (setup.updateCondensedPaperdoll) setup.updateCondensedPaperdoll();
});

setup.showInventoryItemDetails = function (itemId) {
	const item = getItemMetadata(itemId);
	if (!item) {
		console.warn(`[InventoryUI] No metadata for item: ${itemId}`);
		return;
	}

	// Set image
	const image = document.getElementById("inventory-item-image");
	if (image) {
		image.src = item.image ?? "images/items/default.png";
		image.alt = item.name ?? "Unknown Item";
	}

	// Set description
	document.getElementById("inventory-item-description").textContent =
		item.description ?? "[No description available]";

	// Set flavor text
	document.getElementById("inventory-item-flavor").textContent =
		item.flavorText ?? "";

	// Set enhancements or details
	document.getElementById("inventory-item-meta").textContent =
		item.details ?? "[No additional info]";
};

$(document).on("click", ".inventory-row", function () {
	const itemId = this.dataset.itemId;
	if (!itemId) return;

	$(".inventory-row").removeClass("selected");
	$(this).addClass("selected");

	if (typeof setup.showInventoryItemDetails === "function") {
		setup.showInventoryItemDetails(itemId);
	}
});

/* =============================== */
/* Carryweight Logic Implemenation */
/* =============================== */
setup.calculateMaxCarryWeight = function () {
	const strength = State.variables.player?.attributes?.strength || 1;
	return 30 + (strength * 5); // 30 base + 5 per Strength point
};

setup.calculateInventoryWeight = function (target = "player") {
	const inventory = State.variables[`inventory_${target}`];
	if (!inventory) return 0;

	let totalWeight = 0;

	for (const itemId in inventory) {
		const item = getItemMetadata(itemId);
		const amount = inventory[itemId];

		if (item?.weight) {
			totalWeight += item.weight * amount;
		}
	}

	return totalWeight;
};

setup.updatePlayerCarryWeight = function () {
	const player = State.variables.player;
	if (!player) return;

	const currentWeight = setup.calculateInventoryWeight("player");
	const maxWeight = setup.calculateMaxCarryWeight();

	player.carryWeight = {
		current: currentWeight,
		max: maxWeight
	};
};




window.setup = setup;
/* twine-user-script #17: "02_JournalSystem.js" */
/**
 * Journal System for Twine 2 - SugarCube 2
 * Manages journal tabs, quest tracking, relationships, and map integration
 */

window.JournalSystem = {
    // Current active tab
    activeTab: 'quests',
    
    /**
     * Initialize the journal system
     */
    init() {
        console.log("[JournalSystem] Initializing...");
        
        // Set up event listeners for journal opening
        $(document).on(':journalopen', () => {
            this.onJournalOpen();
        });
        
        console.log("[JournalSystem] Initialized successfully");
    },
    
    /**
     * Called when journal is opened
     */
    onJournalOpen() {
        // Re-render Lucide icons
        if (window.lucide) {
            setTimeout(() => lucide.createIcons(), 100);
        }
        
        // Update map display if on map tab
        if (this.activeTab === 'map' && window.MapSystem) {
            setTimeout(() => {
                if (typeof MapSystem.updateFullMapDisplay === 'function') {
                    MapSystem.updateFullMapDisplay();
                }
            }, 100);
        }
    },
    
    /**
     * Switch between journal tabs
     */
    switchTab(tabName) {
        // Validate tab name
        const validTabs = ['quests', 'relationships', 'map', 'codex'];
        if (!validTabs.includes(tabName)) {
            console.warn(`[JournalSystem] Invalid tab name: ${tabName}`);
            return;
        }
        
        // Remove active class from all tabs and content
        document.querySelectorAll('.journal-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.journal-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Add active class to selected tab and content
        const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
        const selectedContent = document.getElementById(`journal-${tabName}`);
        
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        if (selectedContent) {
            selectedContent.classList.add('active');
        }
        
        // Update active tab
        this.activeTab = tabName;
        
        // Special handling for map tab
        if (tabName === 'map') {
            setTimeout(() => {
                if (window.MapSystem && typeof MapSystem.updateFullMapDisplay === 'function') {
                    MapSystem.updateFullMapDisplay();
                }
            }, 100);
        }
        
        console.log(`[JournalSystem] Switched to tab: ${tabName}`);
    },
    
    /**
     * Toggle map grid display
     */
    toggleMapGrid() {
        const mapContainer = document.getElementById('full-map-container');
        if (mapContainer) {
            const grid = mapContainer.querySelector('.tile-grid');
            if (grid) {
                grid.classList.toggle('show-grid');
                console.log('[JournalSystem] Toggled map grid');
            }
        }
    },
    
    /**
     * Update quest display
     */
    updateQuests() {
        // This would be implemented to update quest data from game state
        // For now, it's a placeholder for future implementation
        console.log('[JournalSystem] Quest update requested');
    },
    
    /**
     * Update relationships display
     */
    updateRelationships() {
        // This would be implemented to update relationship data from game state
        // For now, it's a placeholder for future implementation
        console.log('[JournalSystem] Relationship update requested');
    },
    
    /**
     * Update codex entries
     */
    updateCodex() {
        // This would be implemented to update codex data from game state
        // For now, it's a placeholder for future implementation
        console.log('[JournalSystem] Codex update requested');
    }
};

// Global functions for HTML onclick handlers
window.switchJournalTab = function(tabName) {
    if (window.JournalSystem) {
        JournalSystem.switchTab(tabName);
    }
};

window.toggleMapGrid = function() {
    if (window.JournalSystem) {
        JournalSystem.toggleMapGrid();
    }
};

// Initialize when DOM is ready
$(document).ready(() => {
    JournalSystem.init();
});

// Trigger journal open event when overlay opens
$(document).on(':overlayopen', (event, overlayName) => {
    if (overlayName === 'journal-page') {
        $(document).trigger(':journalopen');
    }
});
/* twine-user-script #18: "02_PeoplePageSystem.js" */
// People overlay functionality
window.PeopleOverlay = {
    currentLocation: null,
    selectedPersonId: null,
    filterSettings: {
        relationship: 'all',
        archetype: 'all'
    },
    
    // Initialize the overlay
    initialize() {
        console.log('🎭 Initializing People Overlay...');
        this.setupEventListeners();
        this.loadFilterSettings();
        this.refreshPeopleList();
    },
    
    // Set up event listeners
    setupEventListeners() {
        // Filter controls
        const relationshipFilter = document.getElementById('relationship-filter');
        const archetypeFilter = document.getElementById('archetype-filter');
        const refreshButton = document.getElementById('refresh-people');
        
        if (relationshipFilter) {
            relationshipFilter.addEventListener('change', (e) => {
                this.filterSettings.relationship = e.target.value;
                this.saveFilterSettings();
                this.refreshPeopleList();
            });
        }
        
        if (archetypeFilter) {
            archetypeFilter.addEventListener('change', (e) => {
                this.filterSettings.archetype = e.target.value;
                this.saveFilterSettings();
                this.refreshPeopleList();
            });
        }
        
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                this.refreshPeopleList();
            });
        }
        
        // Listen for RGNPC system events
        $(document).on('rgnpc:relationship_updated', (event, data) => {
            if (this.selectedPersonId === data.rgnpcId) {
                this.showPersonDetails(data.rgnpcId);
            }
            // Update the person card if visible
            this.updatePersonCard(data.rgnpcId);
        });
        
        $(document).on('rgnpc:introduced', (event, data) => {
            this.refreshPeopleList();
            if (this.selectedPersonId === data.rgnpcId) {
                this.showPersonDetails(data.rgnpcId);
            }
        });
        
        $(document).on('rgnpc:trait_revealed', (event, data) => {
            if (this.selectedPersonId === data.rgnpcId) {
                this.showPersonDetails(data.rgnpcId);
            }
        });
        
        $(document).on('rgnpc:died', (event, data) => {
            if (this.selectedPersonId === data.rgnpcId) {
                this.selectedPersonId = null;
                document.getElementById('person-details').style.display = 'none';
            }
            this.refreshPeopleList();
        });
    },
    
    // Load filter settings from localStorage
    loadFilterSettings() {
        try {
            const saved = localStorage.getItem('people_overlay_filters');
            if (saved) {
                this.filterSettings = JSON.parse(saved);
                // Apply to UI
                const relationshipFilter = document.getElementById('relationship-filter');
                const archetypeFilter = document.getElementById('archetype-filter');
                if (relationshipFilter) relationshipFilter.value = this.filterSettings.relationship || 'all';
                if (archetypeFilter) archetypeFilter.value = this.filterSettings.archetype || 'all';
            }
        } catch (error) {
            console.error('Failed to load filter settings:', error);
        }
    },
    
    // Save filter settings to localStorage
    saveFilterSettings() {
        try {
            localStorage.setItem('people_overlay_filters', JSON.stringify(this.filterSettings));
        } catch (error) {
            console.error('Failed to save filter settings:', error);
        }
    },
    
    // Refresh the people list
    refreshPeopleList() {
        this.currentLocation = this.getCurrentLocation();
        this.updateLocationInfo();
        this.loadPeopleInLocation();
    },
    
    // Get current location (integrate with map system)
    getCurrentLocation() {
        // Try to get location from MapSystem
        if (window.MapSystem && typeof MapSystem.getCurrentLocation === 'function') {
            try {
                const location = MapSystem.getCurrentLocation();
                if (location) return location;
            } catch (error) {
                console.warn('Failed to get location from MapSystem:', error);
            }
        }
        
        // Try to get from game state
        if (window.State && State.variables && State.variables.currentLocation) {
            return State.variables.currentLocation;
        }
        
        // Default for testing
        return 'test_location';
    },
    
    // Update location information display
    updateLocationInfo() {
        const locationName = this.getLocationDisplayName(this.currentLocation);
        const population = window.RGNPCSystem ? RGNPCSystem.getLocationPopulation(this.currentLocation).size : 0;
        
        document.getElementById('current-location-name').textContent = locationName;
        document.getElementById('location-population').textContent = `Population: ${population}`;
        document.getElementById('people-title').textContent = `People (${population})`;
    },
    
    // Get display name for location
    getLocationDisplayName(locationId) {
        // Try to get from MapSystem first
        if (window.MapSystem && typeof MapSystem.getLocationName === 'function') {
            try {
                const name = MapSystem.getLocationName(locationId);
                if (name) return name;
            } catch (error) {
                console.warn('Failed to get location name from MapSystem:', error);
            }
        }
        
        // Fallback to predefined names
        const locationNames = {
            'test_location': 'Test Location',
            'tavern': 'The Local Tavern',
            'market': 'Market Square',
            'temple': 'Sacred Temple',
            'palace': 'Royal Palace',
            'slums': 'The Slums',
            'brothel': 'The Velvet Rose',
            'library': 'Grand Library',
            'barracks': 'City Barracks',
            'docks': 'Harbor District',
            'residential': 'Residential Quarter',
            'noble_district': 'Noble District'
        };
        
        return locationNames[locationId] || locationId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    },
    
    // Load people in current location
    loadPeopleInLocation() {
        if (!window.RGNPCSystem) {
            this.showEmptyState();
            return;
        }
        
        const people = RGNPCSystem.getNPCsInLocation(this.currentLocation);
        const filteredPeople = this.applyFilters(people);
        
        if (filteredPeople.length === 0) {
            this.showEmptyState();
        } else {
            this.displayPeople(filteredPeople);
        }
    },
    
    // Apply filters to people list
    applyFilters(people) {
        const relationshipFilter = this.filterSettings.relationship || 'all';
        const archetypeFilter = this.filterSettings.archetype || 'all';
        
        return people.filter(person => {
            // Relationship filter
            if (relationshipFilter !== 'all') {
                switch (relationshipFilter) {
                    case 'known':
                        if (!person.known) return false;
                        break;
                    case 'unknown':
                        if (person.known) return false;
                        break;
                    case 'friendly':
                        if (person.trust <= 0 && person.affection <= 0) return false;
                        break;
                    case 'hostile':
                        if (person.trust >= 0 && person.tension <= 5) return false;
                        break;
                    case 'romantic':
                        if (person.affection < 5) return false;
                        break;
                    case 'trusted':
                        if (person.trust < 5) return false;
                        break;
                }
            }
            
            // Archetype filter
            if (archetypeFilter !== 'all' && person.archetype !== archetypeFilter) {
                return false;
            }
            
            return true;
        });
    },
    
    // Display people in the list
    displayPeople(people) {
        const peopleList = document.getElementById('people-list');
        const emptyState = document.getElementById('empty-state');
        
        emptyState.style.display = 'none';
        peopleList.style.display = 'grid';
        
        peopleList.innerHTML = people.map(person => this.createPersonCard(person)).join('');
        
        // Add click listeners
        peopleList.querySelectorAll('.person-card').forEach(card => {
            card.addEventListener('click', () => {
                this.selectPerson(card.dataset.personId);
            });
        });
    },
    
    // Create a person card HTML
    createPersonCard(person) {
        const displayName = person.known ? person.name : person.defaultName;
        const relationshipDots = this.getRelationshipDots(person);
        
        return `
            <div class="person-card" data-person-id="${person.rgnpcId}">
                <div class="person-card-header">
                    <img class="person-card-avatar" src="${person.avatar}" alt="Portrait">
                    <div class="person-card-name">${displayName}</div>
                </div>
                <div class="person-card-description">
                    ${this.getPersonDescription(person)}
                </div>
                <div class="person-card-status">
                    <div class="relationship-indicator">${relationshipDots}</div>
                    <div class="archetype-tag">${person.archetype}</div>
                </div>
            </div>
        `;
    },
    
    // Get person description based on what player knows
    getPersonDescription(person) {
        if (!person.known) {
            // Use body descriptors if available
            if (setup.BodyDescriptors && typeof setup.BodyDescriptors.describeFullAppearance === 'function') {
                try {
                    return setup.BodyDescriptors.describeFullAppearance(person.body);
                } catch (error) {
                    console.warn('Failed to generate body description:', error);
                }
            }
            // Fallback description
            return `A ${person.race} ${person.pronouns.noun} with ${person.body.hairColor} hair.`;
        } else {
            // Known person - show personality
            let description = '';
            
            // Add known traits
            if (person.knownTraits && person.knownTraits.size > 0) {
                const traits = Array.from(person.knownTraits).slice(0, 2);
                description = `A ${traits.join(', ').toLowerCase()} ${person.pronouns.noun}`;
            } else {
                description = `A ${person.archetype.toLowerCase()}`;
            }
            
            // Add occupation if known
            if (person.occupation && person.occupation.jobTitle) {
                description += ` who works as a ${person.occupation.jobTitle.toLowerCase()}`;
            }
            
            return description + '.';
        }
    },
    
    // Get relationship indicator dots
    getRelationshipDots(person) {
        const getClass = (value, isReverse = false) => {
            if (isReverse) {
                return value > 5 ? 'negative' : value > 2 ? 'neutral' : 'positive';
            }
            return value > 2 ? 'positive' : value < -2 ? 'negative' : 'neutral';
        };
        
        return `
            <div class="relationship-dot ${getClass(person.trust)}" title="Trust: ${person.trust}"></div>
            <div class="relationship-dot ${getClass(person.affection)}" title="Affection: ${person.affection}"></div>
            <div class="relationship-dot ${getClass(person.tension, true)}" title="Tension: ${person.tension}"></div>
        `;
    },
    
    // Select a person to view details
    selectPerson(personId) {
        // Remove previous selection
        document.querySelectorAll('.person-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Add selection to clicked card
        const selectedCard = document.querySelector(`[data-person-id="${personId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        
        this.selectedPersonId = personId;
        this.showPersonDetails(personId);
    },
    
    // Show detailed information about a person
    showPersonDetails(personId) {
        const person = RGNPCSystem.getRGNPC(personId);
        if (!person) {
            console.warn(`Person not found: ${personId}`);
            return;
        }
        
        const detailsPanel = document.getElementById('person-details');
        if (!detailsPanel) {
            console.error('Person details panel not found');
            return;
        }
        
        detailsPanel.style.display = 'block';
        
        // Update basic info
        const displayName = person.known ? person.name : person.defaultName;
        const nameElement = document.getElementById('person-name');
        const avatarElement = document.getElementById('person-avatar');
        const descriptionElement = document.getElementById('person-description');
        
        if (nameElement) nameElement.textContent = displayName;
        if (avatarElement) avatarElement.src = person.avatar || 'images/portrait_default.png';
        if (descriptionElement) descriptionElement.textContent = this.getPersonDescription(person);
        
        // Update pronouns in UI
        this.updatePronounDisplay(person);
        
        // Update relationship meters
        this.updateRelationshipMeters(person);
        
        // Update known information
        this.updateKnownInformation(person);
        
        // Update action buttons
        this.updateActionButtons(person);
        
        // Update debug info if enabled
        if (window.DEBUG_MODE) {
            this.updateDebugInfo(person);
        }
    },
    
    // Update pronoun display
    updatePronounDisplay(person) {
        const pronounElement = document.getElementById('person-pronouns');
        if (pronounElement) {
            pronounElement.textContent = `(${person.pronouns.subject}/${person.pronouns.object})`;
        }
    },
    
    // Update relationship meters
    updateRelationshipMeters(person) {
        const relationships = ['trust', 'affection', 'rapport', 'tension'];
        
        relationships.forEach(rel => {
            const value = person[rel];
            const range = RGNPCSystem.config.relationshipRanges[rel];
            const percentage = ((value - range[0]) / (range[1] - range[0])) * 100;
            
            document.getElementById(`${rel}-meter`).style.width = `${Math.max(0, Math.min(100, percentage))}%`;
            document.getElementById(`${rel}-value`).textContent = value;
        });
    },
    
    // Update known information section
    updateKnownInformation(person) {
        const knownInfo = document.getElementById('known-info');
        if (!knownInfo) return;
        
        // Reset all info items
        knownInfo.querySelectorAll('.info-item').forEach(item => {
            item.style.display = 'none';
        });
        
        if (person.known) {
            // Show occupation
            const occupationInfo = document.getElementById('occupation-info');
            const occupationText = document.getElementById('occupation-text');
            if (occupationInfo && occupationText && person.occupation) {
                occupationInfo.style.display = 'block';
                occupationText.textContent = person.occupation.jobTitle || 'Unknown';
            }
            
            // Show known traits
            if (person.knownTraits && person.knownTraits.size > 0) {
                const traitsInfo = document.getElementById('traits-info');
                const traitsText = document.getElementById('traits-text');
                if (traitsInfo && traitsText) {
                    traitsInfo.style.display = 'block';
                    const traitNames = Array.from(person.knownTraits).map(trait => {
                        // Capitalize trait names
                        return trait.charAt(0).toUpperCase() + trait.slice(1);
                    });
                    traitsText.textContent = traitNames.join(', ');
                }
            } else if (person.traits && person.traits.length > 0) {
                // Show some traits if relationship is decent
                if (person.trust > 2 || person.affection > 2) {
                    const traitsInfo = document.getElementById('traits-info');
                    const traitsText = document.getElementById('traits-text');
                    if (traitsInfo && traitsText) {
                        traitsInfo.style.display = 'block';
                        traitsText.textContent = 'Seems ' + person.traits[0].toLowerCase() + '...';
                    }
                }
            }
            
            // Show motivations if relationship is high enough
            if ((person.trust > 5 || person.affection > 5) && person.motivations && person.motivations.length > 0) {
                const motivationsInfo = document.getElementById('motivations-info');
                const motivationsText = document.getElementById('motivations-text');
                if (motivationsInfo && motivationsText) {
                    motivationsInfo.style.display = 'block';
                    const motivationNames = person.motivations.map(m => {
                        return m.charAt(0).toUpperCase() + m.slice(1);
                    });
                    motivationsText.textContent = motivationNames.join(', ');
                }
            }
            
            // Show inclinations if very close
            if ((person.trust > 7 || person.affection > 7) && person.inclinations && person.inclinations.length > 0) {
                const inclinationsInfo = document.getElementById('inclinations-info');
                if (!inclinationsInfo) {
                    // Create inclinations info if it doesn't exist
                    const infoGrid = document.querySelector('.info-grid');
                    if (infoGrid) {
                        const div = document.createElement('div');
                        div.className = 'info-item';
                        div.id = 'inclinations-info';
                        div.innerHTML = '<strong>Preferences:</strong> <span id="inclinations-text"></span>';
                        infoGrid.appendChild(div);
                    }
                }
                const inclinationsText = document.getElementById('inclinations-text');
                if (inclinationsText) {
                    document.getElementById('inclinations-info').style.display = 'block';
                    inclinationsText.textContent = person.inclinations.join(', ');
                }
            }
            
            // Show current activity
            const activity = RGNPCSystem.getCurrentActivity(person.rgnpcId);
            if (activity) {
                const scheduleInfo = document.getElementById('schedule-info');
                const scheduleText = document.getElementById('schedule-text');
                if (scheduleInfo && scheduleText) {
                    scheduleInfo.style.display = 'block';
                    let activityText = activity.activity.charAt(0).toUpperCase() + activity.activity.slice(1);
                    if (activity.location) {
                        activityText += ` at ${activity.location}`;
                    }
                    scheduleText.textContent = activityText;
                }
            }
        }
    },
    
    // Update action buttons
    updateActionButtons(person) {
        // Show/hide pickpocket button based on ability and relationship
        const pickpocketBtn = document.getElementById('pickpocket-btn');
        pickpocketBtn.style.display = person.canBePickpocketed && person.trust < 5 ? 'inline-block' : 'none';
        
        // Show/hide attack button based on game state
        const attackBtn = document.getElementById('attack-btn');
        attackBtn.style.display = person.canBeAttacked ? 'inline-block' : 'none';
    },
    
    // Update debug information
    updateDebugInfo(person) {
        const debugInfo = document.getElementById('debug-info');
        debugInfo.style.display = 'block';
        
        document.getElementById('debug-id').textContent = person.rgnpcId;
        document.getElementById('debug-race').textContent = person.race;
        document.getElementById('debug-archetype').textContent = person.archetype;
        document.getElementById('debug-age').textContent = person.birthDate.age;
        document.getElementById('debug-created').textContent = new Date(person.createdAt).toLocaleString();
    },
    
    // Show empty state
    showEmptyState() {
        const peopleList = document.getElementById('people-list');
        const emptyState = document.getElementById('empty-state');
        const personDetails = document.getElementById('person-details');
        
        if (peopleList) peopleList.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        if (personDetails) personDetails.style.display = 'none';
    },
    
    // Update a specific person card
    updatePersonCard(personId) {
        const card = document.querySelector(`[data-person-id="${personId}"]`);
        if (!card) return;
        
        const person = RGNPCSystem.getRGNPC(personId);
        if (!person) return;
        
        // Update name
        const nameElement = card.querySelector('.person-card-name');
        if (nameElement) {
            nameElement.textContent = person.known ? person.name : person.defaultName;
        }
        
        // Update description
        const descElement = card.querySelector('.person-card-description');
        if (descElement) {
            descElement.textContent = this.getPersonDescription(person);
        }
        
        // Update relationship dots
        const dotsContainer = card.querySelector('.relationship-indicator');
        if (dotsContainer) {
            dotsContainer.innerHTML = this.getRelationshipDots(person);
        }
    }
};

// Action functions
function talkToPerson() {
    if (!PeopleOverlay.selectedPersonId) {
        console.warn('No person selected');
        return;
    }
    
    const person = RGNPCSystem.getRGNPC(PeopleOverlay.selectedPersonId);
    if (!person) {
        console.error('Selected person not found');
        return;
    }
    
    // Introduce the person if not known
    if (!person.known) {
        RGNPCSystem.introduceNPC(PeopleOverlay.selectedPersonId);
        PeopleOverlay.refreshPeopleList();
        PeopleOverlay.showPersonDetails(PeopleOverlay.selectedPersonId);
    }
    
    // Store the NPC ID for dialogue system
    if (window.State && State.variables) {
        State.variables.currentNPCId = PeopleOverlay.selectedPersonId;
        State.variables.currentNPC = person;
    }
    
    // This would integrate with dialogue system
    console.log(`💬 Initiating conversation with ${person.name || person.defaultName}`);
    
    // If dialogue system exists, use it
    if (window.DialogueSystem && typeof DialogueSystem.startConversation === 'function') {
        DialogueSystem.startConversation(person);
    }
    
    // Close overlay to show dialogue
    if (typeof closeOverlay === 'function') {
        closeOverlay();
    }
}

function observePerson() {
    if (!PeopleOverlay.selectedPersonId) {
        console.warn('No person selected');
        return;
    }
    
    const person = RGNPCSystem.getRGNPC(PeopleOverlay.selectedPersonId);
    if (!person) {
        console.error('Selected person not found');
        return;
    }
    
    // Check if we can reveal more about this person
    const unrevealedTraits = person.traits.filter(trait => !person.knownTraits.has(trait));
    
    if (unrevealedTraits.length > 0) {
        // Reveal a random trait
        const randomTrait = unrevealedTraits[Math.floor(Math.random() * unrevealedTraits.length)];
        RGNPCSystem.revealTrait(PeopleOverlay.selectedPersonId, randomTrait);
        
        // Show notification
        const traitName = randomTrait.charAt(0).toUpperCase() + randomTrait.slice(1);
        console.log(`👁️ You notice that ${person.pronouns.subject} seems ${traitName.toLowerCase()}.`);
        
        // Update UI
        PeopleOverlay.showPersonDetails(PeopleOverlay.selectedPersonId);
        
        // Small relationship boost for observation
        RGNPCSystem.updateRelationship(PeopleOverlay.selectedPersonId, 'rapport', 1);
    } else {
        console.log(`👁️ You've already learned all you can from observing ${person.name || person.defaultName}.`);
    }
}

function attemptPickpocket() {
    if (!PeopleOverlay.selectedPersonId) return;
    
    const person = RGNPCSystem.getRGNPC(PeopleOverlay.selectedPersonId);
    if (!person) return;
    
    // This would integrate with crime/stealth systems
    console.log(`Attempting to pickpocket ${person.name || person.defaultName}`);
}

function attackPerson() {
    if (!PeopleOverlay.selectedPersonId) return;
    
    const person = RGNPCSystem.getRGNPC(PeopleOverlay.selectedPersonId);
    if (!person) return;
    
    // This would integrate with combat systems
    console.log(`Attacking ${person.name || person.defaultName}`);
}

function generateTestPeople() {
    if (!window.RGNPCSystem) {
        console.warn('RGNPC System not available');
        return;
    }
    
    // Generate test NPCs in current location
    const location = PeopleOverlay.getCurrentLocation();
    const locationType = PeopleOverlay.getLocationType(location);
    
    console.log(`🧪 Generating test NPCs for ${location} (${locationType})`);
    
    // Generate appropriate number based on location type
    const count = locationType === 'tavern' ? 8 : 5;
    RGNPCSystem.generateTestNPCs(count, location, locationType);
    
    PeopleOverlay.refreshPeopleList();
}

// Additional helper functions for PeopleOverlay
PeopleOverlay.getLocationType = function(locationId) {
    // Map location IDs to types for proper archetype selection
    const locationTypes = {
        'tavern': 'tavern',
        'market': 'market',
        'temple': 'temple',
        'palace': 'palace',
        'slums': 'slums',
        'brothel': 'tavern', // Similar to tavern
        'library': 'temple', // Similar to temple for scholars
        'barracks': 'palace', // Similar to palace for guards
        'docks': 'market', // Similar to market
        'residential': 'default',
        'noble_district': 'palace'
    };
    
    return locationTypes[locationId] || 'default';
};

// Initialize the overlay when it opens
$(document).on(':overlayopen', function(event, source) {
    if (source === 'people-page' || source === 'people-page.html') {
        if (window.PeopleOverlay) {
            PeopleOverlay.initialize();
        }
    }
});
/* twine-user-script #19: "03_overlayManager.js" */
window.openOverlay = function (source) {
	const body = document.getElementById("overlay-body");
	if (!body) return;

	body.innerHTML = "";

	const normalized = source.toLowerCase();

	// Force file-based overlays for naming conventions like -page or -sheet
	if (normalized.endsWith(".html") || normalized.includes("-page") || normalized.includes("-sheet")) {
		const filename = normalized.endsWith(".html") ? normalized : `${normalized}.html`;
		setup.loadOverlayHTML("overlay-body", filename);
	} else {
		new Wikifier(body, `<<include [[${source}]]>>`);
	}

	document.getElementById("overlay-panel").classList.remove("overlay-hidden");
	
	// Block map movement when overlay is open
	if (window.MapSystem) {
		MapSystem.setMovementBlocked(true);
	}
	
	// Trigger overlay open event
	$(document).trigger(':overlayopen', [source]);
	
	renderLucideIconsSafely?.();
};


window.closeOverlay = function () {
	const panel = document.getElementById("overlay-panel");
	if (!panel) return;
	panel.classList.add("overlay-hidden");
	document.getElementById("overlay-body").innerHTML = "";
	
	// Unblock map movement when overlay is closed
	if (window.MapSystem) {
		MapSystem.setMovementBlocked(false);
	}
};

setup.loadOverlayHTML = async function (overlayId, filename) {
	const container = document.getElementById(overlayId);
	if (!container) {
		console.warn(`❌ Could not find element #${overlayId}`);
		return;
	}

	try {
		const response = await fetch(`overlays/${filename}`);
		const html = await response.text();
		container.innerHTML = html;

		// Re-run Lucide icon rendering if needed
		if (window.lucide) lucide.createIcons();
	} catch (err) {
		console.error(`❌ Error loading overlay file '${filename}':`, err);
	}
};
/* twine-user-script #20: "04_PassageInjector.js" */
// ===============================
//  Move Rendered Passage Content into #text-backdrop (Prose Mode Only)
// ===============================

$(document).on(':passagerender', function () {
	// Optional: Disable transition glitch on initial load
	document.body.classList.add("rendering");

	setTimeout(function () {
		const passage = document.querySelector('#passages > .passage');
		const backdrop = document.getElementById('text-backdrop');

		if (!passage || !backdrop) {
			console.warn("⚠️ Could not move passage content:", {
				passageFound: !!passage,
				backdropFound: !!backdrop
			});
			document.body.classList.remove("rendering");
			return;
		}

		// Skip layout injection if it's handled by the dialogue system
		const isDialogue = passage.innerHTML.includes("StartDialogueLayout");
		if (isDialogue) {
			console.log("[PassageInjector] Skipping injection (dialogue layout will take over)");
			document.body.classList.remove("rendering");
			return;
		}

		backdrop.innerHTML = "";       // Clear old content
		backdrop.appendChild(passage); // Physically move the rendered content
		if (!setup.prefersReducedMotion?.()) {
			backdrop.scrollTo({ top: 0, behavior: "smooth" });
		} else {
			backdrop.scrollTop = 0;
		}


		// Sync sidebar layout class with actual state
		const sidebar = document.getElementById("custom-sidebar");
		if (sidebar) {
			if (sidebar.classList.contains("collapsed")) {
				document.body.classList.add("sidebar-collapsed");
			} else {
				document.body.classList.remove("sidebar-collapsed");
			}
		}

		document.body.classList.remove("rendering");
	}, 0);
});


// ===============================
//  Update Sidebar Summary (Unrelated to Dialogue)
// ===============================
$(document).on(':passagedisplay', function () {
	if (window.setup?.SidebarUI?.updateSummary) {
		setup.SidebarUI.updateSummary();
	}
});
/* twine-user-script #21: "05_BackgroundSystem.js" */
$(document).on(':passagedisplay', function () {
	const bgDiv = document.getElementById("background-image");

	// If no new background was set, fallback to default
	if (!State.variables.bgImageSetThisPassage) {
		State.variables.bgImage = "images/background_default.png";
	}

	const url = State.variables.bgImage;
	if (bgDiv) {
		bgDiv.style.backgroundImage = `url('${url}')`;
	}

	// Reset flag for next passage
	delete State.variables.bgImageSetThisPassage;
});
/* twine-user-script #22: "06_ShopSystem.js" */
setup.ShopSystem = {
  activeCategory: "all",

  renderBothInventories(category = "all") {
    this.activeCategory = category;
    this.renderInventory("player", category);
    this.renderInventory("shop", category);
    this.updateTabHighlight(category);
  },

  renderInventory(source, category) {
    const inventory = State.variables[`inventory_${source}`];
    const tableId = source === "shop" ? "shop-inventory-list" : "player-inventory-list";
    const tableBody = document.getElementById(tableId);

    tableBody.innerHTML = "";
    const filteredItems = this.getFilteredItems(source, category);

    filteredItems.forEach(({ id, quantity }) => {
      const item = getItemMetadata(id);
      const row = document.createElement("tr");
      row.dataset.itemId = id;
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.type}</td>
        <td>${item.weight}</td>
        <td>${item.value}</td>
        <td>x${quantity}</td>
      `;
      row.onclick = () => this.toggleSelection(source, id);
      tableBody.appendChild(row);
    });
  },

  getFilteredItems(source, category) {
    const inventory = State.variables[`inventory_${source}`] || {};
    const results = [];
    for (const id in inventory) {
      const item = getItemMetadata(id);
      if (!item) continue;
      if (category === "all" || item.type === category || item.subtype === category) {
        results.push({ id, quantity: inventory[id] });
      }
    }
    return results;
  },

  toggleSelection(source, itemId) {
    const key = `pending_${source}`;
    const pending = State.temporary[key] || (State.temporary[key] = {});
    pending[itemId] = !pending[itemId];
    this.refreshVisuals();
  },

  refreshVisuals() {
    this.renderInventory("player", this.activeCategory);
    this.renderInventory("shop", this.activeCategory);
  },

  confirmTransaction() {
    const shopInv = State.variables.inventory_shop;
    const playerInv = State.variables.inventory_player;
    const pendingShop = State.temporary.pending_shop || {};
    const pendingPlayer = State.temporary.pending_player || {};

    let playerGold = State.variables.player_gold;
    let shopGold = State.variables.shop_gold;

    // Buying from shop
    for (const id in pendingShop) {
      if (!pendingShop[id]) continue;
      const item = getItemMetadata(id);
      if (!item) continue;
      if (playerGold >= item.value) {
        shopInv[id] = (shopInv[id] || 0) - 1;
        playerInv[id] = (playerInv[id] || 0) + 1;
        playerGold -= item.value;
        shopGold += item.value;
      }
    }

    // Selling to shop
    for (const id in pendingPlayer) {
      if (!pendingPlayer[id]) continue;
      const item = getItemMetadata(id);
      if (!item) continue;
      if ((shopGold >= item.value) && (playerInv[id] > 0)) {
        shopInv[id] = (shopInv[id] || 0) + 1;
        playerInv[id] -= 1;
        playerGold += item.value;
        shopGold -= item.value;
      }
    }

    // Update gold trackers
    State.variables.player_gold = playerGold;
    State.variables.shop_gold = shopGold;
    delete State.temporary.pending_shop;
    delete State.temporary.pending_player;
    this.closeOverlay();
  },

  updateTabHighlight(category) {
    document.querySelectorAll(".inv-tab").forEach(btn => btn.classList.remove("active"));
    const btn = document.querySelector(`.inv-tab[onclick*='${category}']`);
    if (btn) btn.classList.add("active");
  },

  closeOverlay() {
    const panel = document.getElementById("overlay-panel");
    if (panel) panel.classList.add("overlay-hidden");
    // Return to conversation state here if needed
  }
};
/* twine-user-script #23: "08_conversation_minigame.js" */
// 08_conversation_minigame.js

setup.ConvoGame = {
  start(npcId) {
    // Debug logging
    console.log("[ConvoGame] start() called with npcId:", npcId);
    console.log("[ConvoGame] State.variables.characters exists:", !!State.variables.characters);
    console.log("[ConvoGame] Available character IDs:", State.variables.characters ? Object.keys(State.variables.characters) : "none");
    
    // Check if characters need to be initialized
    if (!State.variables.characters) {
      console.warn("[ConvoGame] Characters not initialized, attempting to initialize...");
      if (typeof setup.initializeCharacters === 'function') {
        State.variables.characters = setup.initializeCharacters();
        console.log("[ConvoGame] Characters initialized successfully");
      } else {
        console.error("[ConvoGame] setup.initializeCharacters function not found!");
        return;
      }
    }
    
    const npc = State.variables.characters[npcId];
    console.log("[ConvoGame] Character found:", !!npc);
    
    if (!npc) {
      console.error(`[ConvoGame] Invalid NPC ID: ${npcId}`);
      console.error("[ConvoGame] Available characters:", Object.keys(State.variables.characters || {}));
      return;
    }
  
    State.temporary.convo = {
      npcId,
      turn: 1,
      maxTurn: 25,
      tension: 0,
      maxTension: npc.maxTension ?? 3,
      rapport: 0.5, // (make sure initial rapport is 0.5, right?)
      trustGained: 0,
      affectionGained: 0,
      ended: false,
      usedTropes: [],
      giftsGiven: [],
      promptMod: 0,
      heatTier: 1,
      lastCheckpoint: {
        trust: 0,
        affection: 0,
        turn: 0
      },
      luckLog: [], // ✅ Comma placed correctly, and luckLog is OUTSIDE lastCheckpoint
    };
    
  
    this.render();
  },
  openTutorial() {
    document.getElementById("tutorial-overlay").classList.add("active");
  },
  
  closeTutorial() {
    document.getElementById("tutorial-overlay").classList.remove("active");
  },
  
  render() {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];
    
    console.log("[ConvoGame] render() called");
    console.log("[ConvoGame] convo.npcId:", convo.npcId);
    console.log("[ConvoGame] npc object:", npc);
    console.log("[ConvoGame] npc.name:", npc?.name);
    console.log("[ConvoGame] npc.avatar:", npc?.avatar);
    
    if (!npc) {
      console.error("[ConvoGame] No NPC found in render()");
      return;
    }
  
    // Increase difficulty with each checkpoint (every 5 turns)
    convo.promptMod = Math.floor((convo.turn - 1) / 5);
  
    const prompt = setup.getConvoPrompt(npc);
    convo.currentPrompt = prompt;
    
    console.log("[ConvoGame] Generated prompt:", prompt);
  
    const nameEl = document.getElementById("convo-npc-name");
    console.log("[ConvoGame] nameEl found:", !!nameEl);
    console.log("[ConvoGame] nameEl current content:", nameEl?.textContent);
    console.log("[ConvoGame] nameEl element:", nameEl);
    console.log("[ConvoGame] nameEl parent:", nameEl?.parentElement);
    console.log("[ConvoGame] nameEl visibility:", nameEl ? window.getComputedStyle(nameEl).display : "N/A");
    
    // Check if there are multiple elements with this ID
    const allNameEls = document.querySelectorAll("#convo-npc-name");
    console.log("[ConvoGame] Total elements with ID 'convo-npc-name':", allNameEls.length);
    allNameEls.forEach((el, index) => {
      console.log(`[ConvoGame] Element ${index}:`, el, "Content:", el.textContent, "Visible:", window.getComputedStyle(el).display !== 'none');
    });
    
    if (nameEl) {
      console.log("[ConvoGame] Setting name to:", npc.name ?? "???");
      nameEl.textContent = npc.name ?? "???";
      console.log("[ConvoGame] nameEl content after setting:", nameEl.textContent);
      
      // Check again after a delay to see if something overwrites it
      setTimeout(() => {
        console.log("[ConvoGame] nameEl content after 100ms:", nameEl.textContent);
      }, 100);
    }

    const promptEl = document.getElementById("convo-npc-prompt");
    console.log("[ConvoGame] promptEl found:", !!promptEl);
    console.log("[ConvoGame] promptEl current content:", promptEl?.textContent);
    if (promptEl) {
      console.log("[ConvoGame] Setting prompt to:", prompt.text ?? "…");
      promptEl.textContent = prompt.text ?? "…";
      console.log("[ConvoGame] promptEl content after setting:", promptEl.textContent);
      
      // Check again after a delay to see if something overwrites it
      setTimeout(() => {
        console.log("[ConvoGame] promptEl content after 100ms:", promptEl.textContent);
      }, 100);
    }

    const trustEl = document.getElementById("gain-trust");
    if (trustEl) trustEl.textContent = convo.trustGained;

    const affectionEl = document.getElementById("gain-affection");
    if (affectionEl) affectionEl.textContent = convo.affectionGained;

    const rapportEl = document.getElementById("convo-rapport");
    if (rapportEl) rapportEl.textContent = convo.rapport.toFixed(1);

    const tensionEl = document.getElementById("convo-tension");
    if (tensionEl) tensionEl.textContent = convo.tension;

    const maxTensionEl = document.getElementById("convo-max-tension");
    if (maxTensionEl) maxTensionEl.textContent = convo.maxTension;

    const avatarEl = document.getElementById("convo-avatar");
    console.log("[ConvoGame] avatarEl found:", !!avatarEl);
    if (avatarEl) {
      console.log("[ConvoGame] Setting avatar to:", npc.avatar || "images/portrait_default.png");
      avatarEl.src = npc.avatar || "images/portrait_default.png";
    }

    this.injectChoices();
  },
  
  applyHeatEffects() {
    const convoOverlay = document.querySelector(".convo-window");
    if (!convoOverlay) return;
  
    // Remove old heat classes
    convoOverlay.classList.remove("heat-1", "heat-2", "heat-3", "heat-4", "heat-5");
  
    const convo = State.temporary.convo;
    const heatTier = convo.heatTier ?? 1;
  
    // Apply new heat class based on current heat tier
    convoOverlay.classList.add(`heat-${heatTier}`);
  },
  
  injectChoices() {
  const convo = State.temporary.convo;
  const choiceBox = document.getElementById("convo-choices");
  if (!choiceBox) return;

  choiceBox.innerHTML = "";

  const tierList = setup.ConvoTropesByTier?.[convo.heatTier] ?? [];

  if (tierList.length === 0) {
    choiceBox.innerHTML = "<em>No conversation options available.</em>";
    console.warn(`[ConvoUI] No tropes found for HAWT™ tier ${convo.heatTier}`);
    return;
  }

  const unused = tierList.filter(trope => !convo.usedTropes.includes(trope.label));

  // Cryptographically secure shuffle
  function cryptoShuffle(array) {
    const arr = array.slice(); // Clone to avoid mutation
    for (let i = arr.length - 1; i > 0; i--) {
      const rand = window.crypto.getRandomValues(new Uint32Array(1))[0] / 2 ** 32;
      const j = Math.floor(rand * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  const shuffled = cryptoShuffle(unused);
  const finalTropes = shuffled.slice(0, 4);

  if (finalTropes.length === 0) {
    choiceBox.innerHTML = "<em>No conversation options available.</em>";
    return;
  }

  for (const trope of finalTropes) {
    const btn = document.createElement("button");
    btn.textContent = `${trope.label} (${this.getSuccessChance(trope)}%)`;
    btn.onclick = () => this.handleChoice(trope);
    choiceBox.appendChild(btn);
  }

  setup.ConvoUI.animateChoices(choiceBox);
},


  handleChoice(trope) {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];
  
    convo.usedTropes.push(trope.label.toLowerCase().replace(/\s+/g, ""));
  
    const roll = window.crypto.getRandomValues(new Uint32Array(1))[0] / 2**32 * 100;

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log(`[ConvoGame] 🎲 Roll: ${roll.toFixed(2)} vs. Success Chance: ${this.getSuccessChance(trope)}%`);
    }

    const chance = this.getSuccessChance(trope);
    const success = roll <= chance;
    // Log luck tracking
    State.temporary.convo.luckLog.push({
      chance: chance,  // The success chance offered
      result: success ? 1 : 0 // 1 = success, 0 = fail
    });

    const clickedButton = event?.target ?? null; // Get the clicked button for particles
  
    if (success) {
      if (trope.effects.trust) {
        convo.trustGained += trope.effects.trust;
        setup.ConvoGame.spawnParticles("trust", trope.effects.trust, clickedButton);
        for (let i = 0; i < Math.floor(Math.random() * 3) + 2; i++) {
          setup.ConvoGame.spawnParticles("trust-bonus", 1, clickedButton);
        }
      }
      if (trope.effects.affection) {
        convo.affectionGained += trope.effects.affection;
        setup.ConvoGame.spawnParticles("affection", trope.effects.affection, clickedButton);
        for (let i = 0; i < Math.floor(Math.random() * 3) + 2; i++) {
          setup.ConvoGame.spawnParticles("affection-bonus", 1, clickedButton);
        }
      }
      // 🚫 No rapport gain here anymore!
    }
     else {
      convo.tension++;
  
      // Fail particles
      if (trope.effects.trust) {
        setup.ConvoGame.spawnParticles("fail-trust", 1, clickedButton);
      } else if (trope.effects.affection) {
        setup.ConvoGame.spawnParticles("fail-affection", 1, clickedButton);
      }
  
      // Shake and grey out button
      if (clickedButton) {
        clickedButton.classList.add("shake", "grey-out");
        setTimeout(() => {
          clickedButton.classList.remove("shake", "grey-out");
        }, 300);
      }
    }
  
    this.updateTurnProgress(success);
  
    if (convo.turn % 5 === 0) {
      convo.lastCheckpoint = {
        trust: convo.trustGained,
        affection: convo.affectionGained,
        turn: convo.turn
      };
    
      convo.rapport = Math.min(convo.rapport + 0.1, 2.0); // Cap rapport at 2.0 for safety
      console.log(`[ConvoGame] 🧪 Rapport increased to ${convo.rapport.toFixed(2)} at checkpoint.`);
      console.log(`[ConvoGame] ✅ Checkpoint saved at turn ${convo.turn}`, convo.lastCheckpoint);
    }
    
  
    convo.turn++;
  
    // Cap the game manually at turn 26
    if (convo.turn > 25) {
      convo.ended = true;
      console.log(`[ConvoGame] 🛑 Maximum turn cap reached at turn ${convo.turn}. Ending minigame.`);
      this.end();
      return;
    }
  
    if ((convo.turn - 1) % 5 === 0 && convo.turn > 1) {
      convo.heatTier = Math.min(convo.heatTier + 1, 5);
      console.log(`[ConvoGame] 🔥 Heat tier escalated to ${convo.heatTier}`);
    }
  
    this.applyHeatEffects();
  
    if (convo.tension >= convo.maxTension) {
      convo.trustGained = 0;
      convo.affectionGained = 0;
      convo.ended = true;
      console.log(`[ConvoGame] ❌ Max tension reached. Progress wiped.`);
      this.end();
      return;
    }
  
    this.render();
  },

  getSuccessChance(trope) {
    const convo = State.temporary.convo;
    const globalDifficultyModifier = 20; // 🔥 Global difficulty tweak: lowers success by 20%
  
    const base = 100 - trope.baseDifficulty - globalDifficultyModifier;
    const adjusted = base - (convo.promptMod * 5); // Still gets harder every checkpoint
  
    return Math.max(5, adjusted); // ✅ Only a floor at 5%, no ceiling
  },
  

  exitEarly() {
    const convo = State.temporary.convo;
    convo.trustGained = convo.lastCheckpoint.trust;
    convo.affectionGained = convo.lastCheckpoint.affection;
    convo.ended = true;
    console.log(`[ConvoGame] 🛑 Player exited manually. Reverting to last checkpoint.`);
    this.end();
  },

  end() {
    const convo = State.temporary.convo;
  
    const convoBody = document.getElementById("convo-body");
    const resultBox = document.getElementById("convo-results");
  
    if (convoBody) convoBody.classList.add("hidden");
    if (resultBox) resultBox.classList.remove("hidden");
  
    // Calculate final trust/affection based on rapport multiplier
    const finalMultiplier = convo.rapport ?? 1.0;
    const rawTrust = convo.trustGained;
    const rawAffection = convo.affectionGained;
    const finalTrust = +(rawTrust * finalMultiplier).toFixed(2);
    const finalAffection = +(rawAffection * finalMultiplier).toFixed(2);
  
    // Save the final scaled values
    convo.trustGained = finalTrust;
    convo.affectionGained = finalAffection;
  
   // Display results
    document.getElementById("convo-result-status").textContent = convo.tension >= convo.maxTension ? "Failure" : "Success!";

    document.getElementById("convo-result-trust").innerHTML = `
      Base Trust: +${rawTrust} | Base Affection: +${rawAffection}<br>
      Rapport Multiplier: x${finalMultiplier.toFixed(2)}
      <hr style="border: 0; height: 1px; background: #555; margin: 8px 0;">
      <strong>Final Trust: +${finalTrust} | Final Affection: +${finalAffection}</strong>
    `;

    document.getElementById("convo-result-affection").innerHTML = "";

  
    const closeBtn = document.getElementById("convo-result-close");
    if (closeBtn) {
      closeBtn.onclick = () => {
        window.closeOverlay();
      };
    }
    // ✅ After overlay is closed, refresh conversation UI if we're still on that NPC
    const npcId = convo.npcId;
    const phase = State.variables.currentPhase;
    const currentNPC = State.variables.currentNPC;

    if (currentNPC === npcId && typeof setup?.[`${npcId}_Conversation_Options_${phase}`] === "function") {
      setTimeout(() => {
        console.log(`[ConvoGame] 🔁 Refreshing conversation UI for ${npcId} in phase ${phase}`);
        setup[`${npcId}_Conversation_Options_${phase}`]();
      }, 300);
    }

    // Disable all leftover choice buttons
    const buttons = document.querySelectorAll("#convo-choices button");
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.pointerEvents = "none";
      btn.style.opacity = "0.5";
    });
  
    // Save gains back to NPC
    const npc = State.variables.characters[convo.npcId];
    if (npc) {
      npc.trust = (npc.trust || 0) + finalTrust;
      npc.affection = (npc.affection || 0) + finalAffection;
    }
  
    console.log("[ConvoGame] Conversation finished.", convo);
  
    // Luck Tracker Report
    const luckLog = convo.luckLog ?? [];
    if (luckLog.length > 0) {
      const totalExpected = luckLog.reduce((sum, entry) => sum + (entry.chance / 100), 0);
      const totalActual = luckLog.reduce((sum, entry) => sum + entry.result, 0);
      const luckScore = +(totalActual - totalExpected).toFixed(2);
  
      let luckDescriptor = "Average Luck";
      if (luckScore >= 1) luckDescriptor = "Incredibly Lucky!";
      else if (luckScore >= 0.5) luckDescriptor = "Very Lucky!";
      else if (luckScore <= -1) luckDescriptor = "Cursed!";
      else if (luckScore <= -0.5) luckDescriptor = "Unlucky!";
  
      console.log(`[ConvoGame] 🍀 Session Luck Report:`);
      console.log(`Expected Successes: ${totalExpected.toFixed(2)}`);
      console.log(`Actual Successes: ${totalActual}`);
      console.log(`Luck Score: ${luckScore} (${luckDescriptor})`);
    }
  },
  
  

  updateTurnProgress(success) {
    const convo = State.temporary.convo;
    const segmentsContainer = document.querySelector(".turn-progress-bar");
    let segments = segmentsContainer.querySelectorAll(".turn-segment");
    const currentIndex = (convo.turn - 1) % 5;
  
    // If we are starting a new block (Turn 6, 11, 16...), rebuild the segments
    if (currentIndex === 0 && convo.turn > 1) {
      // Clear old segments
      segmentsContainer.querySelectorAll(".turn-segment").forEach(seg => seg.remove());
  
      // Create 5 new pending segments
      for (let i = 0; i < 5; i++) {
        const newSeg = document.createElement("div");
        newSeg.classList.add("turn-segment", "pending");
        segmentsContainer.insertBefore(newSeg, document.getElementById("convo-max-turn"));
      }
  
      // Refresh segment list
      segments = segmentsContainer.querySelectorAll(".turn-segment");
  
      // Also update the block number (5 ➔ 10 ➔ 15 ➔ etc.)
      const blockNumber = Math.ceil(convo.turn / 5) * 5;
      document.getElementById("convo-max-turn").textContent = blockNumber;
    }
  
    // Now safely mark the current turn's segment
    if (segments[currentIndex]) {
      segments[currentIndex].classList.remove("pending");
      segments[currentIndex].classList.add(success ? "success" : "fail");
    }
  },
  
  spawnParticles(type, count, originButton) {
    const container = document.getElementById("conversation-overlay");
    if (!container || !originButton) return;
  
    const originRect = originButton.getBoundingClientRect();
    const overlayRect = container.getBoundingClientRect();
    const originX = originRect.left + (originRect.width / 2) - overlayRect.left;
    const originY = originRect.top + (originRect.height / 2) - overlayRect.top;
  
    for (let i = 0; i < count; i++) {
      const particle = document.createElement("div");
      particle.classList.add("particle");
  
      // Determine what kind of particle
      if (type === "trust") {
        particle.classList.add("trust-particle");
        particle.textContent = "🤝";
      } else if (type === "affection") {
        particle.classList.add("affection-particle");
        particle.textContent = "❤️";
      } else if (type === "trust-bonus") {
        particle.classList.add("trust-particle");
        particle.textContent = "⭐";
      } else if (type === "affection-bonus") {
        particle.classList.add("affection-particle");
        particle.textContent = "🌸";
      } else if (type === "fail-trust") {
        particle.classList.add("fail-particle");
        particle.textContent = "😢";
      } else if (type === "fail-affection") {
        particle.classList.add("fail-particle");
        particle.textContent = "💔";
      }
  
      particle.style.left = `${originX}px`;
      particle.style.top = `${originY}px`;
  
      container.appendChild(particle);
  
      // Animate with random directions if success, straight down if fail
      let targetX = originX;
      let targetY = originY;

      if (type.startsWith("fail")) {
        // FAIL = straight downward
        targetY = originY + (60 + Math.random() * 40);
      } else {
        // SUCCESS = random pop upward (-45 to +45 from UP)
        const angle = (Math.random() * 90) + 225; // 225° to 315°
        const distance = 60 + Math.random() * 40;
        const rad = angle * (Math.PI / 180);
        targetX = originX + Math.cos(rad) * distance;
        targetY = originY + Math.sin(rad) * distance; // +sin, not minus!
      }


      particle.animate([
        { transform: `translate(0px, 0px)`, opacity: 1 },
        { transform: `translate(${targetX - originX}px, ${targetY - originY}px)`, opacity: 0 }
      ], {
        duration: 800 + Math.random() * 400,
        easing: "ease-out",
        fill: "forwards"
      });
  
      // Remove after animation
      setTimeout(() => {
        particle.remove();
      }, 1200);
    }
  },
  
};
/* twine-user-script #24: "09_conversation_ui.js" */
// 09_conversation_ui.js

setup.ConvoUI = {
  renderMinigame(npcId) {
    window.openOverlay("convo-minigame-page");

    const waitForDOM = () => {
      // Check for the specific overlay container AND the elements we need
      const overlayContainer = document.getElementById("conversation-overlay");
      const nameEl = document.getElementById("convo-npc-name");
      const endButton = document.getElementById("end-button");
      
      console.log("[ConvoUI] Waiting for DOM - overlay:", !!overlayContainer, "nameEl:", !!nameEl, "endButton:", !!endButton);
      
      if (overlayContainer && nameEl && endButton) {
        console.log("[ConvoUI] DOM ready, starting ConvoGame");
        
        // Set up button handlers first
        endButton.onclick = () => setup.ConvoGame.exitEarly();

        const giftButton = document.getElementById("gift-button");
        if (giftButton) {
          giftButton.onclick = () => setup.ConvoUI.giveGiftMenu();
        }
        
        // Start the game
        setup.ConvoGame.start(npcId);

      } else {
        requestAnimationFrame(waitForDOM);
      }
    };

    // Add a small delay to ensure the overlay HTML is fully loaded
    setTimeout(waitForDOM, 50);

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log(`[ConvoUI] Minigame started with NPC: ${npcId}`);
    }
  },
  
  
  render() {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];
  
    // Set NPC name
    document.getElementById("convo-npc-name").textContent = npc.known ? npc.name : "???";
  
    // Set NPC prompt
    const promptObj = setup.getConvoPrompt(npc);
    convo.currentPrompt = promptObj;
    document.getElementById("convo-npc-prompt").textContent = promptObj.text;
  
    // Set Avatars
    document.getElementById("convo-avatar").src = npc.avatar || "images/placeholder_npc.png";
    document.getElementById("player-avatar").src = "images/portrait_jaylie.png"; // or player avatar logic later
  
    // Inject choices
    setup.ConvoGame.injectChoices(promptObj);
  
    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[ConvoUI] Minigame UI rendered:", {
        npc: convo.npcId,
        prompt: promptObj,
      });
    }
  },
  openTutorial() {
    const overlay = document.getElementById("tutorial-overlay");
    if (overlay) {
      overlay.classList.add("active");
      overlay.classList.remove("hidden");
    }
  },

  closeTutorial() {
    const overlay = document.getElementById("tutorial-overlay");
    if (overlay) {
      overlay.classList.remove("active");
      overlay.classList.add("hidden");
    }
  },
  
  updateMeta() {
    const convo = State.temporary.convo;
    const npc = State.variables.characters[convo.npcId];

    document.getElementById("convo-turn").textContent = convo.turn;
    document.getElementById("convo-rapport").textContent = convo.rapport.toFixed(1);
    document.getElementById("convo-tension").textContent = `${convo.tension} / ${convo.maxTension}`;
    document.getElementById("gain-trust").textContent = convo.trustGained;
    document.getElementById("gain-affection").textContent = convo.affectionGained;

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log(`[ConvoUI] Meta updated:`, {
        turn: convo.turn,
        rapport: convo.rapport,
        tension: convo.tension,
        trust: convo.trustGained,
        affection: convo.affectionGained,
      });
    }
  },

  closeMinigame() {
    const overlay = document.getElementById("conversation-overlay");
    if (overlay) {
      overlay.classList.add("overlay-hidden");
    }

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[ConvoUI] Minigame overlay hidden.");
    }
  },

  giveGiftMenu() {
    alert("Gift system not yet implemented!");
    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[ConvoUI] Gift system placeholder triggered.");
    }
  }
  
};
setup.ConvoUI.animateChoices = function(container) {
  const buttons = container.querySelectorAll("button");
  buttons.forEach((btn, index) => {
    setTimeout(() => {
      btn.classList.add("animate-choice");
    }, index * 100);
  });
};
/* twine-user-script #25: "10_dialogueSetup.js" */
// ===============================
// 📦 Dialogue Layout Macros
// ===============================

// Injects the side-by-side convo UI and moves passage content to convoBox
Macro.add("StartDialogueLayout", {
	handler() {
		const backdrop = document.getElementById('text-backdrop');
		if (!backdrop) {
			console.warn("<<StartDialogueLayout>> failed: #text-backdrop not found.");
			return;
		}

		backdrop.classList.add("in-dialogue");
		backdrop.innerHTML = `
			<div id="convoLayoutContainer">
				<div id="convoChoicesPanel"><div id="convoChoices"></div></div>
				<div id="convoBoxPanel"><div id="convoBox"></div></div>
			</div>
		`;

		const tryInjectPassage = () => {
			const passage = document.querySelector('#passages > .passage');
			const convoBox = document.getElementById('convoBox');
			if (passage && convoBox) {
				convoBox.appendChild(passage);
			} else {
				requestAnimationFrame(tryInjectPassage);
			}
		};

		tryInjectPassage();

		// Force sidebar layout class sync (compensate margin)
		const sidebar = document.getElementById("custom-sidebar");
		if (sidebar) {
			if (sidebar.classList.contains("collapsed")) {
				document.body.classList.add("sidebar-collapsed");
			} else {
				document.body.classList.remove("sidebar-collapsed");
			}
		}
	}
});

// Removes dialogue layout formatting
Macro.add("EndDialogueLayout", {
	handler() {
		const backdrop = document.getElementById('text-backdrop');
		if (backdrop) {
			backdrop.classList.remove("in-dialogue");
		}
	}
});

// Clears the choices box
setup.clearConvoChoices = function () {
	const choicesPanel = document.getElementById("convoChoices");
	if (choicesPanel) {
		choicesPanel.innerHTML = "";
	}
};

// Core choice injector
setup.addChoices = function (list) {
	const $container = $("#convoChoices");
	if (!$container.length) {
		console.warn("[addChoices] convoChoices not found.");
		return;
	}

	$container.empty();
	State.variables.usedDialogueOptions ??= {};

	list.forEach(([label, target, reuseFlag = 0, status = "normal"]) => {
		const reusable = reuseFlag === 1 || reuseFlag === "1";
		const used = State.variables.usedDialogueOptions[target];

		// Locked choice (unmet requirements)
		if (status === "locked") {
			const $button = $("<p>")
				.addClass("dialogue-choice locked")
				.text(label);
			$container.append($button);
			return;
		}

		// Skip used non-reusable
		if (used && !reusable) {
			console.log(`[addChoices] Skipping used non-reusable choice: ${target}`);
			return;
		}

		const macroCall = `<<dialogueChoice "${label}" "${target}" "${reusable ? 1 : 0}">>`;
		console.log(`[addChoices] Injecting: ${macroCall}`);
		new Wikifier($container[0], macroCall);
	});
};

// Internal helper to add a single choice (just wraps in a list)
setup.addChoice = function (label, passage, reuseFlag = 0) {
	setup.addChoices([[label, passage, reuseFlag]]);
};

// ✅ New: Universal smartChoice function
setup.smartChoice = function (label, target, {
	aff = null,
	trust = null,
	rapport = null,
	tension = null,
	cooldown = null,
	variable = null,
	notVariable = null,
	item = null,
	quest = null,
	compare = null,
	conditions = null,
	usedMin = null,
	hideIf = null,
	logic = "and",
	hide = false,
	reuse = 0,
	logUnlock = null,
	tags = []
} = {}) {
	const v = State.variables;
	const t = State.temporary;
	const chars = v.characters;
	const npc = v.currentNPC;
	const phase = v.currentPhase;

	const debug = true;
	let checks = [];

	if (debug) {
		console.groupCollapsed(`[smartChoice] ${label}`);
		console.log("Target:", target);
		console.log("Character:", npc, "| Phase:", phase);
	}

	// Early hide check
	if (hideIf) {
		let shouldHide = false;

		const resolve = (val) =>
			typeof val === "string" && val.startsWith("!") ? !setup._resolvePath(val.slice(1), v) : !!setup._resolvePath(val, v);

		if (hideIf.variable !== undefined) {
			shouldHide = resolve(hideIf.variable);
			if (debug) console.log(`hideIf.variable →`, shouldHide);
		}
		if (!shouldHide && hideIf.item) {
			const [id, count] = hideIf.item;
			const result = (v.inventory?.[id] ?? 0) < count;
			shouldHide = result;
			if (debug) console.log(`hideIf.item →`, result);
		}
		if (!shouldHide && hideIf.quest) {
			const [path, min] = hideIf.quest;
			const val = path.split(".").reduce((o, k) => o?.[k], v.quests ?? {});
			const result = (val ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.quest →`, result);
		}
		if (!shouldHide && hideIf.aff) {
			const [id, min] = hideIf.aff;
			const result = (chars?.[id]?.affection ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.aff →`, result);
		}
		if (!shouldHide && hideIf.trust) {
			const [id, min] = hideIf.trust;
			const result = (chars?.[id]?.trust ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.trust →`, result);
		}
		if (!shouldHide && hideIf.rapport) {
			const [id, min] = hideIf.rapport;
			const result = (chars?.[id]?.rapport ?? 0) < min;
			shouldHide = result;
			if (debug) console.log(`hideIf.rapport →`, result);
		}
		if (!shouldHide && hideIf.tension) {
			const [id, max] = hideIf.tension;
			const result = (chars?.[id]?.tension ?? 0) > max;
			shouldHide = result;
			if (debug) console.log(`hideIf.tension →`, result);
		}
		if (!shouldHide && hideIf.cooldown) {
			const [id, max] = hideIf.cooldown;
			const result = (chars?.[id]?.cooldown ?? 0) > max;
			shouldHide = result;
			if (debug) console.log(`hideIf.cooldown →`, result);
		}
		if (!shouldHide && typeof hideIf.conditions === "function") {
			const result = !!hideIf.conditions(v);
			shouldHide = result;
			if (debug) console.log(`hideIf.conditions →`, result);
		}
		if (shouldHide) {
			if (debug) console.log("→ Choice hidden due to hideIf.");
			console.groupEnd();
			return null;
		}
	}

	// Relationship stats
	if (aff) {
		const [id, min] = aff;
		const result = (chars?.[id]?.affection ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`affection[${id}] >= ${min}? →`, result);
	}
	if (trust) {
		const [id, min] = trust;
		const result = (chars?.[id]?.trust ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`trust[${id}] >= ${min}? →`, result);
	}
	if (rapport) {
		const [id, min] = rapport;
		const result = (chars?.[id]?.rapport ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`rapport[${id}] >= ${min}? →`, result);
	}
	if (tension) {
		const [id, max] = tension;
		const result = (chars?.[id]?.tension ?? 0) <= max;
		checks.push(result);
		if (debug) console.log(`tension[${id}] <= ${max}? →`, result);
	}
	if (cooldown) {
		const [id, max] = cooldown;
		const result = (chars?.[id]?.cooldown ?? 0) <= max;
		checks.push(result);
		if (debug) console.log(`cooldown[${id}] <= ${max}? →`, result);
	}

	// Variable checks
	if (variable) {
		const result = !!v[variable];
		checks.push(result);
		if (debug) console.log(`variable[${variable}] →`, result);
	}
	if (notVariable) {
		const result = !v[notVariable];
		checks.push(result);
		if (debug) console.log(`notVariable[${notVariable}] →`, result);
	}

	// Inventory
	if (item) {
		const [id, count] = item;
		const result = (v.inventory?.[id] ?? 0) >= count;
		checks.push(result);
		if (debug) console.log(`item[${id}] x${count} →`, result);
	}

	// Quest
	if (quest) {
		const [path, min] = quest;
		const val = path.split(".").reduce((o, k) => o?.[k], v.quests ?? {});
		const result = (val ?? 0) >= min;
		checks.push(result);
		if (debug) console.log(`quest[${path}] >= ${min}? →`, result);
	}

	// Custom condition
	if (typeof conditions === "function") {
		const result = !!conditions(v);
		checks.push(result);
		if (debug) console.log(`custom condition →`, result);
	}

	// UsedMin
	if (usedMin !== null && npc && phase !== undefined) {
		const readVars = Object.entries(v)
			.filter(([key]) => key.startsWith(`Read_${phase}_${npc}_`))
			.map(([, value]) => value);
		const count = readVars.filter(val => val >= 1).length;
		const result = count >= usedMin;
		checks.push(result);
		if (debug) console.log(`usedMin[${usedMin}] →`, result, `(found: ${count})`);
	}

	// Compare logic
	if (compare) {
		const value = typeof compare.value === "string" ? setup._resolvePath(compare.value, v) : compare.value;
		const against = typeof compare.against === "string" ? setup._resolvePath(compare.against, v) : compare.against;
		const opMap = {
			"==": value == against,
			"===": value === against,
			"!=": value != against,
			"!==": value !== against,
			"<": value < against,
			"<=": value <= against,
			">": value > against,
			">=": value >= against
		};
		const result = opMap[compare.op];
		checks.push(result);
		if (debug) console.log(`compare ${compare.value} ${compare.op} ${compare.against} →`, result);
	}

	const passed = logic === "or" ? checks.some(Boolean) : checks.every(Boolean);
	if (debug) console.log("PASS LOGIC:", logic, "→", passed);
	if (debug) console.groupEnd();

	// Log tags
	if (passed && tags?.length > 0) {
		v.choiceTags ??= [];
		tags.forEach(tag => {
			if (!v.choiceTags.includes(tag)) v.choiceTags.push(tag);
		});
	}

	// Log unlock variable
	if (passed && logUnlock) {
		v[logUnlock] = true;
	}

	if (passed) return [label, target, reuse];
	if (!hide) return [label, null, reuse, "locked"];
	return null;
};



// Path resolver (supports nested vars like "$characters.marie.affection")
setup._resolvePath = function (path, source = State.variables) {
	return path.split(".").reduce((acc, key) => acc?.[key], source);
};



// ✅ Batch version: Array of smartChoice calls
setup.smartChoices = function (list) {
	const final = [];
	for (const opt of list) {
		const entry = setup.smartChoice(opt.label, opt.target, {
			aff: opt.aff,
			trust: opt.trust,
			rapport: opt.rapport,
			tension: opt.tension,
			cooldown: opt.cooldown,
			variable: opt.variable,
			notVariable: opt.notVariable,
			item: opt.item,
			quest: opt.quest,
			compare: opt.compare,
			conditions: opt.conditions,
			usedMin: opt.usedMin,
			hideIf: opt.hideIf, // ✅ pass through hideIf
			logic: opt.logic ?? "and",
			hide: opt.hide ?? false,
			reuse: opt.reuse ?? 0,
			logUnlock: opt.logUnlock,
			tags: opt.tags ?? []
		});
		if (entry) final.push(entry);
	}
	setup.addChoices(final);
};



/* twine-user-script #26: "11_BodyDescriptorsDB.js" */
// dev/js/02_systems/11_BodyDescriptorsDB.js
// Centralized enum and descriptor logic for body-related features

const BodyDescriptors = {
  breastSize: ["flat", "small", "modest", "full", "large", "very large", "massive"],
  buttSize: ["flat", "tight", "modest", "round", "plump", "large", "voluptuous"],
  bodyType: ["emaciated", "slender", "lean", "average", "curvy", "thick", "heavyset", "broad"],
  lipFullness: ["thin", "narrow", "modest", "full", "plump", "voluptuous"],
  muscleTone: ["soft", "slightly toned", "fit", "athletic", "defined", "muscular", "ripped"],
  hipWidth: ["narrow", "modest", "wide", "very wide"],
  bodyHair: ["smooth", "light", "natural", "hairy", "very hairy"],

  hairLengthMap: [
    { label: "bald", max: 0 },
    { label: "buzzed", max: 1 },
    { label: "cropped", max: 3 },
    { label: "short", max: 6 },
    { label: "ear-length", max: 8 },
    { label: "jaw-length", max: 10 },
    { label: "shoulder-length", max: 14 },
    { label: "mid-back", max: 20 },
    { label: "waist-length", max: 26 },
    { label: "butt-length", max: 34 },
    { label: "floor-length", max: Infinity }
  ],

  heightDescriptor(heightInInches) {
    if (heightInInches <= 48) return "extremely short";
    if (heightInInches <= 54) return "short";
    if (heightInInches <= 60) return "below average height";
    if (heightInInches <= 66) return "average height";
    if (heightInInches <= 72) return "tall";
    if (heightInInches <= 78) return "very tall";
    return "towering";
  },

  penisSizeDesc(sizeInInches) {
    if (sizeInInches < 3.5) return "small";
    if (sizeInInches < 5.5) return "modest";
    if (sizeInInches < 7) return "average";
    if (sizeInInches < 8.5) return "large";
    return "very large";
  },

  getHairLengthLabel(inches) {
    for (const entry of this.hairLengthMap) {
      if (inches <= entry.max) return entry.label;
    }
    return "unknown length";
  },

  describeHair(profile) {
    const lengthLabel = this.getHairLengthLabel(profile.hairLength || 0);
    return `${lengthLabel} ${profile.hairStyle || "unstyled"} ${profile.hairColor || "hair"}`;
  },

  describeEyes(profile) {
    return `${profile.eyeColor || "unknown"} eyes`;
  },

  describeBody(profile) {
    let height = this.heightDescriptor(profile.height);
    let build = this.bodyType[profile.bodyType];
    let breasts = profile.breastSize != null ? this.breastSize[profile.breastSize] + " breasts" : null;
    let butt = profile.buttSize != null ? this.buttSize[profile.buttSize] + " butt" : null;

    return `A ${height}, ${build} build${breasts ? ", with " + breasts : ""}${butt ? ", and a " + butt : ""}.`;
  },

  describeFullAppearance(profile) {
    return `${this.describeBody(profile)} ${profile.skinTone} skin, ${this.describeHair(profile)}, and ${this.describeEyes(profile)}.`;
  }
};

setup.BodyDescriptors = BodyDescriptors;
/* twine-user-script #27: "12_GlobalTextResolver.js" */
setup.resolveCharacterText = function (text, npc) {
    if (!npc || typeof npc !== "object") return text;
  
    const p = npc.pronouns || {};
    const b = npc.body || {};
  
    // Descriptive helpers
    const bd = setup.BodyDescriptors || {};
    const getBody = (index, arr) => arr?.[index] || "unknown";
    const getHairLength = (inches) => {
      if (!bd.getHairLengthLabel) return `${inches} inches`;
      return bd.getHairLengthLabel(inches);
    };
  
    // Resolution map
    const replacements = {
      "<<npc.name>>": npc.name || "they",
      "<<npc.they>>": p.subject || "they",
      "<<npc.them>>": p.object || "them",
      "<<npc.their>>": p.possessive || "their",
      "<<npc.theirs>>": p.possessive + "s" || "theirs",
      "<<npc.themself>>": p.reflexive || "themself",
      "<<npc.noun>>": p.noun || "person",
      "<<npc.eyecolor>>": b.eyeColor || "unknown",
      "<<npc.hairColor>>": b.hairColor || "unknown",
      "<<npc.hairStyle>>": b.hairStyle || "unstyled",
      "<<npc.hairLength>>": getHairLength(b.hairLength || 0),
      "<<npc.skinTone>>": b.skinTone || "skin",
      "<<npc.voiceTone>>": b.voiceTone || "neutral",
      "<<npc.bodyType>>": getBody(b.bodyType, bd.bodyType),
      "<<npc.buttSize>>": getBody(b.buttSize, bd.buttSize),
      "<<npc.breastSize>>": b.breastSize != null ? getBody(b.breastSize, bd.breastSize) : "",
      "<<npc.penisSize>>": b.penisSize != null ? `${b.penisSize.toFixed(1)} inch` : ""
    };
  
    // Apply all replacements
    for (const [key, value] of Object.entries(replacements)) {
      const safeVal = (value || "").toString();
      text = text.replaceAll(key, safeVal);
    }
  
    return text;
  };
  
/* twine-user-script #28: "12_SexScene_Logic.js" */
// ===============================
// 🍑 Initialize Sex Scene State
// ===============================
setup.initializeSexSceneStates = function (npcIdListString) {
	console.log("[SexSceneInit] Initializing sex scene states...");

	const defaultPartState = () => ({
		occupiedBy: null,
		bound: false,
		gagged: false,
		disabled: false
	});

	const detectBodyParts = (char) => {
		const body = char.body || {};
		const parts = {};
		const summary = [];

		// Core anatomy
		parts.mouth = defaultPartState();
		summary.push("Mouth");

		parts.leftHand = defaultPartState();
		parts.rightHand = defaultPartState();
		summary.push("Left Hand", "Right Hand");

		parts.feet = defaultPartState();
		summary.push("Feet");

		parts.anus = defaultPartState();
		summary.push("Anus");

		if (body.penisSize != null) {
			parts.penis = defaultPartState();
			summary.push(`Penis (${body.penisSize}in)`);
		}

		if (body.vagina) {
			parts.vagina = defaultPartState();
			parts.clitoris = defaultPartState();
			summary.push("Vagina", "Clitoris");
		}

		if (body.breastSize > 0) {
			parts.breasts = defaultPartState();
			summary.push(`Breasts (size ${body.breastSize})`);
		}

		return { parts, summary };
	};

	// === PLAYER INIT ===
	const playerChar = State.variables.player;
	const playerPartsData = detectBodyParts(playerChar);

	State.variables.sexScenePlayerState = {
		id: "player",
		name: "You",
		parts: playerPartsData.parts,
		orgasmCount: 0
	};

	// These should always reset during scene init
	State.variables.sexScenePendingActions = [];
	State.variables.sexSceneOngoingActions = [];

	console.log(`[SexSceneInit] 🧍 Player Anatomy Parts: ${playerPartsData.summary.join(", ")}`);

	// === PARTNERS INIT ===
	const partnerIds = npcIdListString.split(",").map(id => id.trim());
	State.variables.sexScenePartnerStates = {};

	for (const id of partnerIds) {
		const npc = State.variables.characters[id];
		if (!npc) {
			console.warn(`[SexSceneInit] ❌ Character '${id}' not found.`);
			continue;
		}

		const npcPartsData = detectBodyParts(npc);

		State.variables.sexScenePartnerStates[id] = {
			id,
			name: npc.name ?? id,
			parts: npcPartsData.parts,
			orgasmCount: 0,
			lastReceivedAction: null
		};

		console.log(`[SexSceneInit] 👤 ${npc.name}'s Anatomy Parts: ${npcPartsData.summary.join(", ")}`);
	}

	console.log("[SexSceneInit] ✅ Sex scene state initialized.");

	// === Have NPC(s) decide initial action before first turn
	const npcIds = Object.keys(State.variables.sexScenePartnerStates ?? {});
	for (const npcId of npcIds) {
		setup.npcDecideActions(npcId);
	}


};


// ===============================
// 💄 Layout Macros
// ===============================
Macro.add("StartSexSceneLayout", {
	handler() {
		const backdrop = document.getElementById("text-backdrop");
		if (!backdrop) {
			console.warn("[SexSceneLayout] ⚠️ Could not find #text-backdrop.");
			return;
		}

		console.log("[SexSceneLayout] 🔹 Initializing layout...");

		backdrop.classList.add("in-sexscene");
		backdrop.innerHTML = `
			<div id="sexSceneLayoutContainer">
				<div id="sexSceneFeedbackPanel"><div id="sexSceneFeedbackBox"></div></div>
				<div id="sexSceneStatusPanel"></div>
				<div id="sexSceneActionsPanel"><div id="sexSceneActionsBox"></div></div>
			</div>
		`;

		console.log("[SexSceneLayout] ✅ HTML structure injected.");

		const tryInjectPassage = () => {
			const passage = document.querySelector('#passages > .passage');
			const feedbackBox = document.getElementById("sexSceneFeedbackBox");

			if (passage && feedbackBox) {
				feedbackBox.appendChild(passage);
				console.log("[SexSceneLayout] ✅ Passage content moved to feedback panel.");

				// ✅ Once layout is stable, render the actions
				setup.renderSexSceneActions();
			} else {
				console.log("[SexSceneLayout] ⏳ Waiting for passage render...");
				requestAnimationFrame(tryInjectPassage);
			}
		};

		tryInjectPassage();
	}
});


Macro.add("EndSexSceneLayout", {
	handler() {
		const backdrop = document.getElementById("text-backdrop");
		if (backdrop?.classList.contains("in-sexscene")) {
			backdrop.classList.remove("in-sexscene");
			console.log("[SexSceneLayout] 🔸 Layout class removed.");
		} else {
			console.warn("[SexSceneLayout] ⚠️ Tried to end layout, but class wasn't present.");
		}
	}
});



/* Body Part Detector */
setup.detectBodyParts = function (body) {
	const parts = {};

	if (!body || typeof body !== "object") return parts;

	// Core anatomy defaults (included unless explicitly false)
	if (body.mouth !== false) parts.mouth = {};
	if (body.hands !== false) parts.hand = {}; // normalized to single "hand"
	if (body.feet !== false) parts.feet = {};

	// Anus present unless explicitly excluded
	if (body.anus !== false || body.buttSize >= 0) parts.anus = {};

	// Sexual anatomy
	if (body.vagina) parts.vagina = {};
	if (body.clitoris) parts.clitoris = {};
	if (body.penisSize != null) parts.penis = {};
	if (body.breastSize > 0) parts.breasts = {};

	return parts;
};


// ===============================
// 🎛️ Render Action Buttons
// ===============================
setup.renderSexSceneActions = function () {
	console.log("[SexSceneRender] 🔄 Rendering available sex actions...");

	const $wrapper = document.getElementById("sexSceneActionsBox");
	if (!$wrapper) {
		console.warn("[SexSceneRender] ❌ #sexSceneActionsBox not found.");
		return;
	}
	$wrapper.innerHTML = "";

	const playerState = State.variables.sexScenePlayerState;
	const playerChar = State.variables.player;
	// Fix: Properly access skills from primarySkills and secondarySkills
	const playerSkills = {};
	
	// Merge primary skills
	if (playerChar.primarySkills) {
		Object.entries(playerChar.primarySkills).forEach(([skill, data]) => {
			playerSkills[skill] = data.value || 0;
		});
	}
	
	// Merge secondary skills  
	if (playerChar.secondarySkills) {
		Object.entries(playerChar.secondarySkills).forEach(([skill, data]) => {
			playerSkills[skill] = data.value || 0;
		});
	}
	const partnerId = Object.keys(State.variables.sexScenePartnerStates ?? {})[0];
	const partnerState = State.variables.sexScenePartnerStates?.[partnerId];
	const partnerChar = State.variables.characters?.[partnerId];

	if (!playerState || !partnerState || !partnerChar) {
		console.error("[SexSceneRender] ❌ Missing player or NPC state.");
		return;
	}

	const pending = State.variables.sexScenePendingActions ?? [];
	const ongoing = State.variables.sexSceneOngoingActions ?? [];
	const isCumming = playerChar.status?.isCumming === true;
	const allowedClimax = State.variables.sexSceneFilteredOrgasmOptions ?? [];

	const groupedActions = {};
	const hands = ["leftHand", "rightHand"];
	const bodyParts = ["mouth", "feet", "anus", "penis", "vagina", "breasts"];
	[...hands, ...bodyParts].forEach(part => groupedActions[part] = []);

	// Track stage levels by group + hand
	const activeStageMap = {};
	for (const entry of ongoing) {
		const act = setup.SexualActsDB[entry.label];
		if (act?.stageGroup) {
			const key = act.stageGroup + (entry.assignedHand ?? "");
			const current = activeStageMap[key] ?? -1;
			activeStageMap[key] = Math.max(current, act.stageLevel);
		}
	}

	// === Filter and group valid actions
	for (const [label, act] of Object.entries(setup.SexualActsDB)) {
		if (act.giver !== "player" || !Array.isArray(act.subjectParts)) continue;

		const isActClimax = !!act.isCumming;
		if (isCumming !== isActClimax) {
			console.log(`[OrgasmFilter] ❌ Skipping '${label}' — isCumming mismatch.`);
			continue;
		}

		// === Orgasm-specific debug filtering
		if (isCumming && isActClimax) {
			const missingSubject = act.subjectParts.filter(p => !playerState.parts?.[p]);
			const missingObject = act.objectParts?.filter(p => !partnerState.parts?.[p]) ?? [];

			if (missingSubject.length > 0) {
				console.log(`[OrgasmFilter] ❌ '${label}' skipped — player missing: ${missingSubject.join(", ")}`);
				continue;
			}
			if (missingObject.length > 0) {
				console.log(`[OrgasmFilter] ❌ '${label}' skipped — partner missing: ${missingObject.join(", ")}`);
				continue;
			}
			if (typeof allowedClimax !== "undefined" && allowedClimax.length > 0 && !allowedClimax.includes(label)) {
				console.log(`[OrgasmFilter] ❌ '${label}' skipped — not in allowedClimax list.`);
				continue;
			}

			console.log(`[OrgasmFilter] ✅ '${label}' PASSED — valid climax option.`);
		}

		// === Skill check
		if (act.skillsRequired && !Object.entries(act.skillsRequired).every(
			([skill, min]) => (playerSkills[skill] ?? 0) >= min
		)) continue;

		// === Hand actions - improved logic
		const isHandAction = act.subjectParts.includes("hand");
		if (isHandAction) {
			hands.forEach(hand => {
				const handState = playerState.parts?.[hand];
				if (!handState || handState.bound || handState.disabled) return;

				// Check if partner has required parts
				if (act.objectParts && !act.objectParts.every(part => partnerState.parts?.[part])) return;

				let visible = true;
				if (act.stageGroup) {
					const key = act.stageGroup + hand;
					const level = activeStageMap[key] ?? -1;
					visible = [0, level, level + 1].includes(act.stageLevel);
				}
				if (!visible) return;

				groupedActions[hand].push({ label, act, assignedHand: hand });
			});
			continue;
		}

		// === Non-hand actions - improved validation
		const allPartsValid = act.subjectParts.every(part => {
			const state = playerState.parts?.[part];
			return state && !state.bound && !state.disabled;
		});
		if (!allPartsValid) continue;

		// Check if partner has required parts
		if (act.objectParts && !act.objectParts.every(part => partnerState.parts?.[part])) continue;

		let visible = true;
		if (act.stageGroup) {
			const key = act.stageGroup;
			const level = activeStageMap[key] ?? -1;
			visible = [0, level, level + 1].includes(act.stageLevel);
		}
		if (!visible) continue;

		const primary = act.subjectParts[0];
		groupedActions[primary].push({ label, act });
	}



	// Render UI groups (only show groups that have the body part or have actions)
	for (const [part, actions] of Object.entries(groupedActions)) {
		// Skip empty groups for body parts the player doesn't have
		const hasBodyPart = playerState.parts?.[part];
		if (!hasBodyPart && actions.length === 0) continue;

		const $group = document.createElement("div");
		$group.classList.add("sexscene-group");
		$group.innerHTML = `<h3>${part.toUpperCase()}</h3>`;

		// Only show REST button if the player has this body part
		if (hasBodyPart) {
			const restLabel = `__REST_${part}`;
			const isRestPending = pending.some(p => p.label === restLabel);
			const isRestOngoing = ongoing.every(p =>
				(p.assignedHand ?? null) !== part &&
				!setup.SexualActsDB[p.label]?.subjectParts?.includes(part)
			);

			const $rest = document.createElement("button");
			$rest.textContent = "Rest";
			$rest.classList.add("rest-button");
			if (isRestPending) {
				$rest.classList.add("active-sexact", "pending");
			} else if (isRestOngoing) {
				$rest.classList.add("active-sexact", "ongoing");
			}
			$rest.onclick = () => setup.toggleRestAction(part);
			$group.appendChild($rest);
		}

		actions.forEach(entry => {
			const $btn = document.createElement("button");
			$btn.textContent = entry.act.label;

			const isPending = pending.some(p =>
				p.label === entry.label &&
				(p.assignedHand ?? null) === (entry.assignedHand ?? null)
			);
			const isOngoing = ongoing.some(p =>
				p.label === entry.label &&
				(p.assignedHand ?? null) === (entry.assignedHand ?? null)
			);

			if (isPending) $btn.classList.add("active-sexact", "pending");
			else if (isOngoing) $btn.classList.add("active-sexact", "ongoing");

			$btn.onclick = () => setup.toggleSexAction(entry.label, entry.assignedHand);
			$group.appendChild($btn);
		});

		$wrapper.appendChild($group);
	}

	setup.renderSexSceneContinueButton();
};



// ===============================
// 🔘 Track & Toggle Pending Actions
// ===============================
setup.toggleSexAction = function (label, assignedHand = null) {
	const act = setup.SexualActsDB[label];
	if (!act) {
		console.warn(`[SexSceneAction] ❌ Unknown label: '${label}'`);
		return;
	}

	let queue = State.variables.sexScenePendingActions ?? [];
	queue = [...queue]; // Defensive copy to avoid mutation bugs

	if (assignedHand) {
		// Remove any action currently using this hand
		const existingIndex = queue.findIndex(entry => entry.assignedHand === assignedHand);
		if (existingIndex >= 0) {
			console.log(`[SexSceneAction] 🔄 Removed existing '${queue[existingIndex].label}' on '${assignedHand}'.`);
			queue.splice(existingIndex, 1);
		}

		queue.push({ label, assignedHand });
		console.log(`[SexSceneAction] ✅ Assigned '${label}' to '${assignedHand}'.`);
	} else {
		// Radio group logic — clear any conflicting non-hand actions
		const subjectParts = act.subjectParts || [];

		queue = queue.filter(entry => {
			const existing = setup.SexualActsDB[entry.label];
			if (!existing || entry.assignedHand) return true;

			const conflict = existing.subjectParts?.some(part => subjectParts.includes(part));
			if (conflict) {
				console.log(`[SexSceneAction] 🔁 '${entry.label}' removed (conflict with '${label}').`);
				return false;
			}
			return true;
		});

		queue.push({ label });
		console.log(`[SexSceneAction] ✅ Queued '${label}' (non-hand).`);
	}

	State.variables.sexScenePendingActions = queue;
	setup.renderSexSceneActions();
};


/* Continue Button and logic handler */
setup.renderSexSceneContinueButton = function () {
	const $wrapper = document.getElementById("sexSceneActionsBox");
	if (!$wrapper) {
		console.warn("[SexSceneRender] ❌ Cannot render Continue button: #sexSceneActionsBox missing.");
		return;
	}

	// Remove existing footer buttons if present
	const existing = document.getElementById("sexSceneFooterButtons");
	if (existing) existing.remove();

	// Create a new footer container with flex layout
	const $footer = document.createElement("div");
	$footer.id = "sexSceneFooterButtons";
	

	// --- Continue Button (left side)
	const $continue = document.createElement("button");
	$continue.id = "sexSceneContinueButton";
	$continue.textContent = "Continue";
	$continue.style.flex = "1";

	const pending = State.variables.sexScenePendingActions ?? [];
	const ongoing = State.variables.sexSceneOngoingActions ?? [];
	const isCumming = State.variables.player?.status?.isCumming === true;

	let isEnabled = false;
	if (isCumming) {
		isEnabled = pending.some(p => setup.SexualActsDB[p.label]?.isCumming);
	} else {
		isEnabled = pending.length > 0 || ongoing.length > 0;
	}

	$continue.disabled = !isEnabled;
	$continue.classList.toggle("disabled", !isEnabled);
	$continue.onclick = setup.handleSexSceneContinue;

	// --- End Scene Button (right side)
	const $end = document.createElement("button");
	$end.id = "sexSceneEndButton";
	$end.textContent = "End Scene";
	$end.style.flex = "1";
	$end.onclick = () => {
		const exitTarget = State.variables.sexSceneExitTarget || "AfterSexFallback";
		console.log(`[SexSceneExit] 🚪 Exiting to: ${exitTarget}`);
		Engine.play(exitTarget);
	};

	// Append in new order: Continue (left), End (right)
	$footer.appendChild($continue);
	$footer.appendChild($end);
	$wrapper.appendChild($footer);
};



setup.toggleRestAction = function (part) {
	let queue = State.variables.sexScenePendingActions ?? [];
	const cleanedQueue = [];

	for (const entry of queue) {
		const label = entry.label;

		// Always remove other rest actions (you only get one per part)
		if (label.startsWith("__REST_")) continue;

		const act = setup.SexualActsDB[label];
		if (!act) continue;

		// Remove actions assigned to this hand or involving this part
		const isHandMatch = entry.assignedHand === part;
		const isPartMatch = act.subjectParts?.includes(part);

		if (isHandMatch || isPartMatch) continue;

		cleanedQueue.push(entry);
	}

	// Add the new rest action
	cleanedQueue.push({ label: `__REST_${part}` });

	State.variables.sexScenePendingActions = cleanedQueue;

	console.log(`[RestAction] 🧘 Queued rest for '${part}'.`);
	setup.renderSexSceneActions();
};



setup.handleSexSceneContinue = function () {
	console.log("[SexScene] ▶️ CONTINUE TURN");

	let pending = State.variables.sexScenePendingActions ?? [];
	const ongoing = State.variables.sexSceneOngoingActions ?? [];

	// Use ongoing if nothing new is selected
	if (pending.length === 0 && ongoing.length > 0) {
		console.log("[SexScene] 🔁 No new actions selected — reusing ongoing actions.");
		pending = [...ongoing];
		State.variables.sexScenePendingActions = pending;
	}

	if (pending.length === 0) {
		console.log("[SexScene] ⚠️ No actions selected this turn, and no fallback found.");
		return;
	}

	const feedbackBox = document.getElementById("sexSceneFeedbackBox");
	if (feedbackBox) feedbackBox.innerHTML = "";

	const playerStatus = State.variables.player.status;
	const partnerId = Object.keys(State.variables.sexScenePartnerStates ?? {})[0];
	const partnerChar = State.variables.characters[partnerId];
	const partnerState = State.variables.sexScenePartnerStates[partnerId];
	const playerState = State.variables.sexScenePlayerState;
	const partnerStatus = partnerChar.status;

	const isCumming = playerStatus.isCumming ?? false;
	let playerClimaxResolved = false;

	let newOngoing = [...ongoing];
	const npcFeedback = [];
	const playerFeedback = [];

	for (const entry of pending) {
		const label = entry.label;

		// === REST HANDLING
		if (label.startsWith("__REST_")) {
			const restedPart = label.replace("__REST_", "");
			console.log(`[SexScene] 💤 Resting '${restedPart}' — clearing associated actions.`);
			newOngoing = newOngoing.filter(p => {
				const act = setup.SexualActsDB[p.label];
				if (!act) return true;
				const handMatch = p.assignedHand === restedPart;
				const partMatch = act.subjectParts?.includes(restedPart);
				return !(handMatch || partMatch);
			});
			continue;
		}

		const act = setup.SexualActsDB[label];
		if (!act) {
			console.warn(`[SexScene] ❌ Unknown action '${label}'.`);
			continue;
		}

		console.log(`[SexScene] ➤ Applying action '${label}'...`);

		// === Orgasm Resolution
		if (isCumming && act.isCumming) {
			const climaxLines = setup.SexSceneResponses[label]?.climax ?? [];
			const line = climaxLines.length
				? climaxLines[Math.floor(Math.random() * climaxLines.length)]
				: "You groan and release with a shudder.";
			playerFeedback.push(line);

			playerStatus.excitement = 0;
			playerStatus.fatigue = Math.min(playerStatus.fatigue + 40, playerStatus.maxFatigue);
			playerStatus.isCumming = false;
			playerClimaxResolved = true;

			// Clear filtered orgasm options
			State.variables.sexSceneFilteredOrgasmOptions = [];

			// ✅ Force delayed render refresh after orgasm resolution
			setTimeout(() => {
				if (document.getElementById("sexSceneActionsBox")) {
					console.log("[SexSceneFix] 🔁 Post-orgasm refresh triggered.");
					setup.renderSexSceneActions();
				}
			}, 50); // Delay ensures DOM is ready


			console.log(`[SexScene] ✅ Orgasm resolved with '${label}'.`);
			console.log("   ➕ Excitement reset, fatigue increased.");
			continue; // Do not persist
		}

		// === Arousal Gain
		playerStatus.excitement += act.baseExcitement?.subject ?? 0;
		partnerStatus.excitement += act.baseExcitement?.object ?? 0;

		console.log(`   ➕ Player excitement: ${playerStatus.excitement}`);
		console.log(`   ➕ ${partnerChar.name} excitement: ${partnerStatus.excitement}`);

		partnerState.lastReceivedAction = label;

		// === Ongoing Action Update
		const hand = entry.assignedHand ?? null;
		newOngoing = newOngoing.filter(p => {
			const other = setup.SexualActsDB[p.label];
			if (!other) return true;
			const sameGroup = act.stageGroup && other.stageGroup === act.stageGroup;
			const sameHand = hand ? p.assignedHand === hand : true;
			return !(sameGroup && sameHand);
		});

		if (act.togglable) {
			newOngoing.push({ label, assignedHand: hand });
		} else {
			// Default back to Rest for non-togglable actions
			const restPart = hand ?? act.subjectParts?.[0];
			if (restPart) {
				const restLabel = `__REST_${restPart}`;
				if (!pending.some(p => p.label === restLabel)) {
					pending.push({ label: restLabel });
					console.log(`[SexScene] 🔁 Defaulting '${restPart}' to Rest after non-togglable '${label}'.`);
				}
			}
		}

		// === Feedback Text
		let flavor = "Neutral";
		if (partnerChar.preferences?.sexualActs?.likes?.includes(label)) flavor = "Liked";
		if (partnerChar.preferences?.sexualActs?.dislikes?.includes(label)) flavor = "Disliked";

		const responseList = setup.SexSceneResponses[label]?.[flavor] ?? [];
		const response = responseList.length
			? responseList[Math.floor(Math.random() * responseList.length)]
			: `${partnerChar.name} reacts passively.`;

		(act.receiver === "player" ? playerFeedback : npcFeedback).push(response);

		// === Orgasm Triggers (Post-action)
		if (!isCumming && partnerStatus.excitement >= partnerStatus.maxExcitement) {
			console.log(`[SexScene] 🚨 ${partnerChar.name} orgasm triggered.`);
			setup.triggerOrgasm(partnerId);
		}

		if (!isCumming && playerStatus.excitement >= playerStatus.maxExcitement) {
			console.log("[SexScene] 🚨 Player orgasm triggered.");
			setup.triggerOrgasm("player");
		}
	}

	// === Cleanup & Rerender
	if (!playerClimaxResolved) {
		const validOngoing = newOngoing.filter(entry => {
			const act = setup.SexualActsDB[entry.label];
			if (!act || act.isCumming || act.togglable === false) return false;

			const partOk = act.subjectParts.every(part => {
				const resolved = part === "hand" ? entry.assignedHand : part;
				const state = playerState.parts?.[resolved];
				return state && !state.bound && !state.disabled;
			});
			if (!partOk) return false;

			if (act.objectParts?.some(p => !partnerState.parts?.[p])) return false;

			if (act.skillsRequired) {
				// Fix: Use the same skill merging logic as in renderSexSceneActions
				const playerSkills = {};
				
				// Merge primary skills
				if (State.variables.player.primarySkills) {
					Object.entries(State.variables.player.primarySkills).forEach(([skill, data]) => {
						playerSkills[skill] = data.value || 0;
					});
				}
				
				// Merge secondary skills  
				if (State.variables.player.secondarySkills) {
					Object.entries(State.variables.player.secondarySkills).forEach(([skill, data]) => {
						playerSkills[skill] = data.value || 0;
					});
				}
				
				for (const [skill, min] of Object.entries(act.skillsRequired)) {
					if ((playerSkills[skill] ?? 0) < min) return false;
				}
			}

			return true;
		});

		State.variables.sexSceneOngoingActions = validOngoing;
		State.variables.sexScenePendingActions = [];
		setup.renderSexSceneActions();

		// === Run NPC Turn
		const npcIds = Object.keys(State.variables.sexScenePartnerStates ?? {});
		for (const npcId of npcIds) {
			setup.npcDecideActions(npcId);
		}

	}

	// === Render Feedback
	if (feedbackBox) {
		if (npcFeedback.length > 0) {
			const npcPara = document.createElement("p");
			npcPara.innerHTML = npcFeedback.map(l => `<span>${l}</span>`).join(" ");
			feedbackBox.appendChild(npcPara);
		}
		if (playerFeedback.length > 0) {
			const playerPara = document.createElement("p");
			playerPara.innerHTML = playerFeedback.map(l => `<span>${l}</span>`).join(" ");
			feedbackBox.appendChild(playerPara);
		}
	}

	console.groupCollapsed("[SexScene] 🧷 Final Ongoing Actions");
	console.dir(State.variables.sexSceneOngoingActions);
	console.groupEnd();
	console.log("[SexScene] 🔁 Turn complete.");
};


/* ======================================================
   ORGASM TRIGGER & FEEDBACK SYSTEM
 ===================================================== */

setup.triggerOrgasm = function (charId) {
	const isPlayer = charId === "player";
	const char = isPlayer ? State.variables.player : State.variables.characters?.[charId];
	const state = isPlayer ? State.variables.sexScenePlayerState : State.variables.sexScenePartnerStates?.[charId];

	if (!char || !state) {
		console.warn(`[Orgasm] ❌ Could not resolve character or state for '${charId}'.`);
		return;
	}

	// Clamp excitement and apply fatigue
	char.status.excitement = 0;
	char.status.fatigue = Math.min(char.status.fatigue + 40, char.status.maxFatigue);

	console.log(`[Orgasm] 💦 ${isPlayer ? "Player" : char.name} orgasmed.`);
	console.log(`   ➡️ Fatigue now: ${char.status.fatigue}/${char.status.maxFatigue}`);

	if (!isPlayer) {
		setup.displayNPCOrgasmFeedback?.(charId);
		return;
	}

	const hasPenis = !!state.parts?.penis;
	const hasVagina = !!state.parts?.vagina;

	// === Auto-orgasm for vagina-only players
	if (!hasPenis && hasVagina) {
		console.log("[Orgasm] ✅ Auto-resolving climax for vagina-only player.");

		const feedbackBox = document.getElementById("sexSceneFeedbackBox");
		if (feedbackBox) {
			const p = document.createElement("p");
			p.innerHTML = "A wave of pleasure crashes over you as your body trembles in release.";
			feedbackBox.appendChild(p);
		}

		char.status.isCumming = false;
		State.variables.sexScenePendingActions = [];
		State.variables.sexSceneOngoingActions = [];

		setup.renderSexSceneActions();
		return;
	}

	// === Manual orgasm resolution (requires orgasm choice action)
	char.status.isCumming = true;
	console.log("[Orgasm] 🚩 Player is now in 'isCumming' resolution phase.");

	// ✅ Clear ongoing, and force every body part to rest
	State.variables.sexSceneOngoingActions = [];
	State.variables.sexScenePendingActions = [];

	const parts = Object.keys(state.parts ?? {});
	for (const part of parts) {
		State.variables.sexScenePendingActions.push({ label: `__REST_${part}` });
		console.log(`[Orgasm] 🔄 Forcing '${part}' to REST (pending) during orgasm resolution.`);
	}

	// ✅ Display prompt
	const feedbackBox = document.getElementById("sexSceneFeedbackBox");
	if (feedbackBox) {
		const p = document.createElement("p");
		p.innerHTML = "You're right at the edge. How do you want to finish?";
		feedbackBox.appendChild(p);
		console.log("[OrgasmUI] 💬 Prompt rendered in feedback box.");
	}

	// ✅ Trigger rerender to reflect forced REST state
	setup.renderSexSceneActions();
};


setup.autoResolveVaginalOrgasm = function () {
	const feedbackBox = document.getElementById("sexSceneFeedbackBox");
	if (!feedbackBox) {
		console.warn("[Orgasm] ❌ Feedback box not found for auto-orgasm.");
		return;
	}

	const p = document.createElement("p");
	p.innerHTML = "A wave of pleasure crashes over you as your body trembles in release.";
	feedbackBox.appendChild(p);

	// Reset orgasm state and clear queued actions
	State.variables.player.status.isCumming = false;
	State.variables.player.status.excitement = 0;
	State.variables.sexScenePendingActions = [];
	State.variables.sexSceneOngoingActions = [];

	setup.renderSexSceneActions();
	console.log("[Orgasm] ✅ Auto-orgasm complete.");
};


setup.displayNPCOrgasmFeedback = function (npcId) {
	const state = State.variables.sexScenePartnerStates?.[npcId];
	const lastAct = state?.lastReceivedAction ?? null;
	const npc = State.variables.characters?.[npcId];
	const feedbackBox = document.getElementById("sexSceneFeedbackBox");

	if (!npc || !feedbackBox) {
		console.warn(`[OrgasmFeedback] ❌ Missing NPC or feedbackBox for '${npcId}'.`);
		return;
	}

	let climaxText = `${npc.name} orgasms, body trembling with release.`; // Default fallback

	if (lastAct) {
		const response = setup.SexSceneResponses[lastAct];
		const climaxLines = response?.climax ?? [];

		if (Array.isArray(climaxLines) && climaxLines.length > 0) {
			climaxText = climaxLines[Math.floor(Math.random() * climaxLines.length)];
			console.log(`[OrgasmFeedback] 💬 '${npc.name}' climax response sourced from '${lastAct}'.`);
		} else {
			console.log(`[OrgasmFeedback] ⚠️ No climax lines found for '${lastAct}'. Using fallback.`);
		}
	} else {
		console.log(`[OrgasmFeedback] ⚠️ No lastReceivedAction for '${npc.name}'. Using fallback.`);
	}

	const p = document.createElement("p");
	try {
		const span = document.createElement("span");
		new Wikifier(span, climaxText);
		p.innerHTML = span.innerHTML;
	} catch (err) {
		console.warn(`[OrgasmFeedback] ❌ Error parsing climax text: ${err.message}`);
		p.textContent = climaxText;
	}

	feedbackBox.appendChild(p);
};

setup.scheduleSexSceneRefresh = function () {
	console.log("[SexSceneFix] ⏳ Scheduling post-passage render refresh...");

	requestAnimationFrame(() => {
		setTimeout(() => {
			if (document.getElementById("sexSceneActionsBox")) {
				console.log("[SexSceneFix] 🔁 Forcing UI refresh after passage load.");
				setup.renderSexSceneActions();
			} else {
				console.warn("[SexSceneFix] ⚠️ Action box not found. Skipping refresh.");
			}
		}, 50); // tweak if needed
	});
};


setup.offerPlayerOrgasmChoices = function () {
	const box = document.getElementById("sexSceneFeedbackBox");
	if (!box) {
		console.warn("[OrgasmUI] ❌ Feedback box not found — cannot render prompt.");
		return;
	}

	// ✅ Insert the prompt at the bottom of feedback
	const p = document.createElement("p");
	p.innerHTML = "You're right at the edge. How do you want to finish?";
	box.appendChild(p);
	console.log("[OrgasmUI] 💬 Prompt inserted. Context-aware orgasm filtering in progress...");

	const playerState = State.variables.sexScenePlayerState;
	const ongoing = State.variables.sexSceneOngoingActions ?? [];

	// 🧠 Derive orgasm context based on ongoing stimulation
	const contextTags = new Set();

	for (const entry of ongoing) {
		const act = setup.SexualActsDB[entry.label];
		if (!act || act.isCumming) continue;

		// Include object parts to derive physical context
		act.objectParts?.forEach(part => {
			if (part === "vagina") contextTags.add("vaginal_internal");
			if (part === "anus") contextTags.add("anal_internal");
			if (part === "face") contextTags.add("facial");
			if (["breasts", "feet", "mouth", "clitoris"].includes(part)) contextTags.add("external");
		});

		// Add inclination context
		act.inclinationTags?.forEach(tag => {
			if (["penetration", "control", "release", "dominance"].includes(tag)) {
				contextTags.add(tag);
			}
		});
	}

	// 🔍 Find valid orgasm actions for the current context
	const playerParts = playerState?.parts ?? {};
	const partnerId = Object.keys(State.variables.sexScenePartnerStates ?? {})[0];
	const partnerParts = State.variables.sexScenePartnerStates?.[partnerId]?.parts ?? {};

	const validOptions = [];

	for (const [label, act] of Object.entries(setup.SexualActsDB)) {
		if (!act.isCumming) continue;

		const hasPlayerParts = act.subjectParts.every(part => playerParts[part]);
		const hasPartnerParts = act.objectParts.every(part => partnerParts[part]);
		if (!hasPlayerParts || !hasPartnerParts) continue;

		const match = act.orgasmTags?.some(tag => contextTags.has(tag));
		if (match) {
			validOptions.push({ label, act });
		}
	}

	// 🛑 Fallback: if no context matches, show all options
	if (validOptions.length === 0) {
		console.warn("[OrgasmUI] ⚠️ No orgasm actions matched context — showing all by default.");
		for (const [label, act] of Object.entries(setup.SexualActsDB)) {
			if (act.isCumming) {
				const hasPlayerParts = act.subjectParts.every(part => playerParts[part]);
				const hasPartnerParts = act.objectParts.every(part => partnerParts[part]);
				if (hasPlayerParts && hasPartnerParts) {
					validOptions.push({ label, act });
				}
			}
		}
	}

	// 👻 Inject filtered orgasm options directly into UI groups on next render
	State.variables.sexSceneFilteredOrgasmOptions = validOptions.map(opt => opt.label);
	console.log(`[OrgasmUI] ✅ ${validOptions.length} orgasm options queued for button render.`);
	setup.renderSexSceneActions(); // Re-render buttons now that options are filtered
};



/*=========================================================================================
================= NPC DECISION MAKING =====================================================
======================================================================================== */
setup.partExists = function (part, partsObj) {
	switch (part) {
		case "hand":
			return !!(partsObj.leftHand || partsObj.rightHand);
		case "genital":
			return !!(partsObj.penis || partsObj.vagina);
		default:
			return !!partsObj[part];
	}
};


setup.npcDecideActions = function (npcId) {
	const npc = State.variables.characters?.[npcId];
	const npcState = State.variables.sexScenePartnerStates?.[npcId];
	const playerState = State.variables.sexScenePlayerState;

	if (!npc || !npcState || !playerState) {
		console.warn(`[NPC AI] ❌ Could not resolve required data for '${npcId}'.`);
		return;
	}

	const availableActs = [];

	for (const [label, act] of Object.entries(setup.SexualActsDB)) {
		if (act.giver !== "npc" || act.receiver !== "player") continue;
		if (act.isCumming) continue;

		// Use partExists to validate anatomy
		const npcHasParts = act.subjectParts.every(p => setup.partExists(p, npcState.parts));
		const playerHasParts = act.objectParts.every(p => setup.partExists(p, playerState.parts));
		if (!npcHasParts || !playerHasParts) continue;

		const score = setup.npcEvaluateAction(npc, act);
		availableActs.push({ label, score });
	}

	if (availableActs.length === 0) {
		console.warn(`[NPC AI] ⚠ No valid acts found for '${npc?.name ?? npcId}'.`);
		return;
	}

	const topActs = availableActs.sort((a, b) => b.score - a.score).slice(0, 3);
	const chosen = topActs[Math.floor(Math.random() * topActs.length)];

	if (State.variables.sexScenePendingActions.some(p => p.label === chosen.label)) {
		console.log(`[NPC AI] ⚠ '${npc.name}' attempted to reuse '${chosen.label}'. Skipping.`);
		return;
	}

	console.log(`[NPC AI] 🤔 '${npc.name}' selects '${chosen.label}' (score: ${chosen.score})`);

	npcState.recentActs = npcState.recentActs ?? [];
	npcState.recentActs.push(chosen.label);

	State.variables.sexScenePendingActions.push({
		label: chosen.label,
		data: setup.SexualActsDB[chosen.label]
	});
};



setup.npcEvaluateAction = function (npc, act) {
	let score = 10;

	const npcPrefs = npc.preferences?.sexualActs;
	const npcInclinations = npc.inclinations ?? [];
	const npcStatus = npc.status ?? {};
	const playerStatus = State.variables.player?.status ?? {};
	const mood = State.variables.sexScenePartnerStates?.[npc.id]?.mood ?? null;

	// === Preferences
	if (npcPrefs?.likes?.includes(act.label)) score += 20;
	if (npcPrefs?.dislikes?.includes(act.label)) score -= 20;

	// === Fatigue / Excitement
	if (npcStatus.excitement >= 70 && act.stageLevel >= 1) score += 15;
	if (npcStatus.fatigue >= 70 && act.stageLevel <= 0) score += 10;

	if (playerStatus.excitement >= 80 && act.baseExcitement?.object >= 10) score += 10;

	// === Inclinations
	if (act.inclinationTags) {
		for (const tag of act.inclinationTags) {
			if (npcInclinations.includes(tag)) score += 5;
		}
	}

	// === Mood Biasing
	if (mood === "aggressive" && act.stageLevel >= 1) score += 8;
	if (mood === "gentle" && act.stageLevel === 0) score += 8;
	if (mood === "teasing" && act.stageLevel === 0 && act.inclinationTags?.includes("tease")) {
		score += 10;
	}

	// === Small randomness for variation
	score += Math.random() * 5;

	return score;
};


setup.npcMoodInit = function (npcId) {
	const state = State.variables.sexScenePartnerStates?.[npcId];
	if (!state) {
		console.warn(`[NPC AI] ❌ Cannot assign mood — no partner state for '${npcId}'.`);
		return;
	}

	const moods = ["aggressive", "teasing", "gentle"];
	const index = Math.floor(Math.random() * moods.length);
	const mood = moods[index];

	state.mood = mood;

	console.log(`[NPC AI] 🎭 '${npcId}' mood initialized as '${mood}'.`);
};


setup.npcInclinationShift = function (npcId) {
	const npc = State.variables.characters?.[npcId];
	const npcState = State.variables.sexScenePartnerStates?.[npcId];
	if (!npc || !npcState?.recentActs?.length) return;

	const seen = new Set();

	for (const actLabel of npcState.recentActs) {
		if (seen.has(actLabel)) continue;
		seen.add(actLabel);

		if (Math.random() > 0.1) continue; // 10% chance to learn

		const act = setup.SexualActsDB[actLabel];
		if (!act?.inclinationTags) continue;

		for (const tag of act.inclinationTags) {
			if (!npc.inclinations?.includes(tag)) {
				npc.inclinations = npc.inclinations ?? [];
				npc.inclinations.push(tag);
				console.log(`[NPC AI] 🌱 '${npc.name}' developed inclination toward '${tag}' from '${actLabel}'.`);
			}
		}
	}

	npcState.recentActs = []; // Clear tracking
};
/* twine-user-script #29: "13_MapSystem.js" */
/**
 * Map System for Twine 2 - SugarCube 2
 * Provides grid-based navigation with keyboard/mouse controls
 * Integrates with sidebar minimap and journal full map view
 */

window.MapSystem = {
    // Core state
    currentMap: null,
    currentPosition: { x: 0, y: 0 },
    loadedMaps: new Map(),
    movementBlocked: false,
    
    // Fog of war state
    revealedTiles: new Map(), // mapId -> Set of "x,y" coordinates
    
    // Event handlers
    keyboardHandler: null,
    
    /**
     * Initialize the map system
     */
    async init() {
        console.log("[MapSystem] Initializing...");
        
        // Initialize player map state if not exists
        if (!State.variables.player.mapState) {
            State.variables.player.mapState = {
                currentMapId: null,
                position: { x: 0, y: 0 },
                revealedTiles: {}
            };
        }
        
        // Set up keyboard controls
        this.setupKeyboardControls();
        
        // Set up minimap fullscreen button
        this.setupMinimapControls();
        
        console.log("[MapSystem] Initialized successfully");
    },
    
    /**
     * Load a map from JSON file
     */
    async loadMap(mapId) {
        if (this.loadedMaps.has(mapId)) {
            return this.loadedMaps.get(mapId);
        }
        
        try {
            const response = await fetch(`dev/js/data/maps/${mapId}.json`);
            if (!response.ok) {
                throw new Error(`Failed to load map: ${response.status}`);
            }
            
            const mapData = await response.json();
            this.loadedMaps.set(mapId, mapData);
            
            console.log(`[MapSystem] Loaded map: ${mapData.name}`);
            return mapData;
        } catch (error) {
            console.error(`[MapSystem] Error loading map ${mapId}:`, error);
            return null;
        }
    },
    
    /**
     * Set the current map and player position
     */
    async setCurrentMap(mapId, position = null) {
        const mapData = await this.loadMap(mapId);
        if (!mapData) {
            console.error(`[MapSystem] Failed to set current map: ${mapId}`);
            return false;
        }
        
        this.currentMap = mapData;
        
        // Set position
        if (position) {
            this.currentPosition = { ...position };
        } else if (mapData.defaultStart) {
            this.currentPosition = { ...mapData.defaultStart };
        } else if (mapData.playerStartPosition) {
            this.currentPosition = { ...mapData.playerStartPosition };
        } else {
            this.currentPosition = { x: 1, y: 1 };
        }
        
        // Update player state
        State.variables.player.mapState.currentMapId = mapId;
        State.variables.player.mapState.position = { ...this.currentPosition };
        
        // Initialize fog of war if enabled
        if (mapData.fogOfWar) {
            this.initializeFogOfWar(mapId);
        }
        
        // Update displays
        this.updateMinimapDisplay();
        this.updateLocationInfo();
        
        console.log(`[MapSystem] Set current map to ${mapData.name} at position (${this.currentPosition.x}, ${this.currentPosition.y})`);
        return true;
    },
    
    /**
     * Initialize fog of war for a map
     */
    initializeFogOfWar(mapId) {
        const key = `${mapId}`;
        if (!this.revealedTiles.has(key)) {
            this.revealedTiles.set(key, new Set());
        }
        
        // Load from player state
        if (State.variables.player.mapState.revealedTiles[mapId]) {
            const revealed = new Set(State.variables.player.mapState.revealedTiles[mapId]);
            this.revealedTiles.set(key, revealed);
        }
        
        // Always reveal current position
        this.revealTile(mapId, this.currentPosition.x, this.currentPosition.y);
    },
    
    /**
     * Reveal a tile in fog of war
     */
    revealTile(mapId, x, y) {
        const key = `${mapId}`;
        if (!this.revealedTiles.has(key)) {
            this.revealedTiles.set(key, new Set());
        }
        
        const tileKey = `${x},${y}`;
        this.revealedTiles.get(key).add(tileKey);
        
        // Save to player state
        if (!State.variables.player.mapState.revealedTiles[mapId]) {
            State.variables.player.mapState.revealedTiles[mapId] = [];
        }
        
        const revealedArray = Array.from(this.revealedTiles.get(key));
        State.variables.player.mapState.revealedTiles[mapId] = revealedArray;
    },
    
    /**
     * Check if a tile is revealed
     */
    isTileRevealed(mapId, x, y) {
        if (!this.currentMap || !this.currentMap.fogOfWar) {
            return true; // No fog of war
        }
        
        const key = `${mapId}`;
        if (!this.revealedTiles.has(key)) {
            return false;
        }
        
        const tileKey = `${x},${y}`;
        return this.revealedTiles.get(key).has(tileKey);
    },
    
    /**
     * Get node at specific coordinates
     */
    getNodeAt(x, y) {
        if (!this.currentMap) return null;
        
        // Handle both x,y and column,row formats
        return this.currentMap.nodes.find(node => {
            const nodeX = node.x !== undefined ? node.x : node.column;
            const nodeY = node.y !== undefined ? node.y : node.row;
            return nodeX === x && nodeY === y;
        });
    },
    
    /**
     * Check if movement is allowed from current position to target
     */
    canMoveTo(direction) {
        if (!this.currentMap || this.movementBlocked) {
            return false;
        }

        const currentNode = this.getNodeAt(this.currentPosition.x, this.currentPosition.y);
        if (!currentNode) {
            return false;
        }

        const transition = currentNode.transitions[direction];
        if (!transition) {
            return false;
        }

        // ✅ Dynamically evaluate transition type
        const effectiveType = this.getEffectiveTransitionType(transition);

        // 🔒 None or locked transitions are blocked
        if (effectiveType === "none" || effectiveType === "locked") {
            return false;
        }

        // 🕵️ Secret transitions only work if revealed
        if (effectiveType === "secret" && !this.isTransitionRevealed(currentNode, direction)) {
            return false;
        }

        // 🔁 One-way transitions only work if direction matches
        if (effectiveType === "one-way" && transition.direction !== direction) {
            return false;
        }

        // ✅ Finally, check if any conditions are unmet
        return this.checkTransitionConditions(transition.conditions);
    },

    
    /**
     * Check if a transition is currently locked by its conditions
     */
    isTransitionLocked(transition) {
        if (!transition.conditions || transition.conditions.length === 0) {
            return transition.type === "locked"; // Default locked state
        }
        
        // Check for lockIf conditions
        for (const condition of transition.conditions) {
            if (condition.action === "lockIf" && this.evaluateCondition(condition)) {
                return true;
            }
            if (condition.action === "unlockIf" && this.evaluateCondition(condition)) {
                return false;
            }
        }
        
        // If no unlock conditions are met and it's a locked transition, remain locked
        return transition.type === "locked";
    },
    
    /**
     * Check if a secret transition has been revealed
     */
    isTransitionRevealed(node, direction) {
        const transition = node.transitions[direction];
        if (transition.type !== "secret") {
            return true;
        }
        
        // Check for unlockIf conditions that would reveal the secret
        if (transition.conditions) {
            for (const condition of transition.conditions) {
                if (condition.action === "unlockIf" && this.evaluateCondition(condition)) {
                    return true;
                }
            }
        }
        
        return false;
    },
    
    /**
     * Get the effective transition type after applying conditions
     */
    getEffectiveTransitionType(transition) {
        if (!transition.conditions || transition.conditions.length === 0) {
            return transition.type;
        }
        
        // Check for changeIf conditions
        for (const condition of transition.conditions) {
            if (condition.action === "changeIf" && this.evaluateCondition(condition)) {
                return condition.changeTarget || transition.type;
            }
        }
        
        return transition.type;
    },
    
    /**
     * Check if transition conditions are met
     */
    checkTransitionConditions(conditions) {
        if (!conditions || conditions.length === 0) {
            return true;
        }
        
        for (const condition of conditions) {
            if (!this.evaluateCondition(condition)) {
                return false;
            }
        }
        
        return true;
    },

    parseConditionValue(rawValue) {
        if (rawValue === true || rawValue === false) return rawValue;
        if (typeof rawValue === 'number') return rawValue;
        if (typeof rawValue !== 'string') return rawValue;

        const trimmed = rawValue.trim();
        if (trimmed === "true") return true;
        if (trimmed === "false") return false;
        if (!isNaN(trimmed)) return Number(trimmed);

        return trimmed;
    },

    
    /**
     * Evaluate a single condition
     */
    evaluateCondition(condition) {
        const player = State.variables.player;
        const inventory = State.variables.inventory_player || {};

        const conditionType = condition.type;
        const operator = condition.operator || "==";
        let targetValue, actualValue;

        switch (conditionType) {
            case "variable": {
                const variablePath = condition.name || condition.variable;
                actualValue = this.getNestedValue(State.variables, variablePath);
                targetValue = this.parseConditionValue(condition.value);
                break;
            }

            case "item": {
                const itemName = condition.name || condition.item;
                actualValue = inventory[itemName] || 0;
                targetValue = this.parseConditionValue(condition.value || true);
                break;
            }

            case "quest": {
                const questName = condition.name || condition.quest;
                const quests = State.variables.quests || {};
                actualValue = quests[questName] || false;
                targetValue = this.parseConditionValue(condition.value || true);
                break;
            }

            default:
                console.warn(`[MapSystem] Unknown condition type: ${conditionType}`);
                return true;
        }

        return this.compareValues(actualValue, operator, targetValue);
    },

    
    /**
     * Get nested object value by dot notation
     */
    getNestedValue(obj, path) {
        return path.split('.').reduce((current, key) => {
            return current && current[key] !== undefined ? current[key] : undefined;
        }, obj);
    },
    
    /**
     * Compare values with operator
     */
    compareValues(a, operator, b) {
        switch (operator) {
            case "==": return a == b;
            case "!=": return a != b;
            case ">=": return a >= b;
            case "<=": return a <= b;
            case ">": return a > b;
            case "<": return a < b;
            default: return false;
        }
    },
    
    /**
     * Calculate target position for movement
     */
    getTargetPosition(direction) {
        const { x, y } = this.currentPosition;
        
        switch (direction) {
            case "north": return { x, y: y - 1 };
            case "south": return { x, y: y + 1 };
            case "east": return { x: x + 1, y };
            case "west": return { x: x - 1, y };
            default: return null;
        }
    },
    
    /**
     * Move player in specified direction
     */
    async movePlayer(direction) {
        if (!this.canMoveTo(direction)) {
            console.log(`[MapSystem] Movement blocked: ${direction}`);
            return false;
        }

        const targetPos = this.getTargetPosition(direction);
        if (!targetPos) {
            return false;
        }

        // Check if target position has a node
        const targetNode = this.getNodeAt(targetPos.x, targetPos.y);
        if (!targetNode) {
            console.log(`[MapSystem] No node at target position (${targetPos.x}, ${targetPos.y})`);
            return false;
        }

        // Update position
        this.currentPosition = targetPos;
        State.variables.player.mapState.position = { ...targetPos };

        // Reveal tiles for fog of war
        if (this.currentMap.fogOfWar) {
            this.revealTile(this.currentMap.mapId, targetPos.x, targetPos.y);
            this.revealAdjacentTiles(this.currentMap.mapId, targetPos.x, targetPos.y);
        }

        // Update displays (may be overwritten by passage change)
        this.updateMinimapDisplay();
        this.updateLocationInfo();

        // Get the effective node data (applying conditions)
        const effectiveNode = this.getEffectiveNodeData(targetNode);

        // Navigate to the target passage
        if (effectiveNode.passage) {
            console.log(`[MapSystem] Moving to passage: ${effectiveNode.passage}`);
            Engine.play(effectiveNode.passage);

            // 🧠 DEFERRED redraw of minimap after sidebar DOM is fully rebuilt
            setTimeout(() => {
                const container = document.getElementById("tile-map-container");
                if (container) {
                    this.updateMinimapDisplay();
                    console.log("🧭 Forced minimap redraw after move (delayed)");
                } else {
                    console.warn("⚠️ Could not redraw minimap: container missing");
                }
            }, 0);
        }

        return true;
    },
    
    /**
     * Reveal adjacent tiles for fog of war
     */
    revealAdjacentTiles(mapId, centerX, centerY) {
        const directions = [
            { x: 0, y: -1 }, // north
            { x: 0, y: 1 },  // south
            { x: 1, y: 0 },  // east
            { x: -1, y: 0 }  // west
        ];
        
        directions.forEach(dir => {
            const adjX = centerX + dir.x;
            const adjY = centerY + dir.y;
            
            // Check if adjacent position is within bounds and has a node
            if (this.getNodeAt(adjX, adjY)) {
                this.revealTile(mapId, adjX, adjY);
            }
        });
    },
    
    /**
     * Set up keyboard controls
     */
    setupKeyboardControls() {
        // Remove existing handler if any
        if (this.keyboardHandler) {
            document.removeEventListener('keydown', this.keyboardHandler);
        }
        
        this.keyboardHandler = (event) => {
            // Don't handle if movement is blocked or if typing in input
            if (this.movementBlocked || event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            let direction = null;
            
            // WASD keys
            switch (event.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    direction = 'north';
                    break;
                case 's':
                case 'arrowdown':
                    direction = 'south';
                    break;
                case 'a':
                case 'arrowleft':
                    direction = 'west';
                    break;
                case 'd':
                case 'arrowright':
                    direction = 'east';
                    break;
            }
            
            if (direction) {
                event.preventDefault();
                this.movePlayer(direction);
            }
        };
        
        document.addEventListener('keydown', this.keyboardHandler);
    },
    
    /**
     * Set up minimap controls
     */
    setupMinimapControls() {
        // Fullscreen button
        $(document).on('click', '#minimap-fullscreen-btn', () => {
            this.openFullMap();
        });
    },
    
    /**
     * Open full map in journal
     */
    openFullMap() {
        // Open journal overlay
        if (typeof openOverlay === 'function') {
            openOverlay('journal-page');
            
            // Switch to map tab after a brief delay
            setTimeout(() => {
                const mapTab = document.querySelector('[data-tab="map"]');
                if (mapTab) {
                    mapTab.click();
                }
            }, 100);
        }
    },
    
    /**
     * Block/unblock movement
     */
    setMovementBlocked(blocked) {
        this.movementBlocked = blocked;
        console.log(`[MapSystem] Movement ${blocked ? 'blocked' : 'unblocked'}`);
    },
    
    /**
     * Update minimap display
     */
    updateMinimapDisplay() {
        const container = document.getElementById('tile-map-container');

        if (!container) {
            console.warn("[MapSystem] updateMinimapDisplay aborted — #tile-map-container not found.");
            return;
        }

        if (!this.currentMap) {
            console.warn("[MapSystem] updateMinimapDisplay aborted — no current map.");
            return;
        }

        // Generate minimap HTML
        const minimapHtml = this.generateMinimapHTML();

        if (!minimapHtml || minimapHtml.trim() === '') {
            console.warn("[MapSystem] Minimap rendering failed — HTML output was blank. Skipping DOM injection.");
            return;
        }

        container.innerHTML = minimapHtml;
        console.log("🔍 Minimap container after HTML injection:", container.innerHTML);

        // Update minimap info
        this.updateMinimapInfo();

        // Re-render Lucide icons
        if (window.lucide) {
            lucide.createIcons();
        }

        // 🧭 Center the player tile in the minimap view
        const playerTile = container.querySelector('.player-tile');
        if (playerTile) {
            const scrollLeft = playerTile.offsetLeft - (container.clientWidth / 2) + (playerTile.clientWidth / 2);
            const scrollTop = playerTile.offsetTop - (container.clientHeight / 2) + (playerTile.clientHeight / 2);

            container.scrollLeft = scrollLeft;
            container.scrollTop = scrollTop;


            console.log("[MapSystem] Minimap auto-scrolled to center on player.");
        } else {
            console.warn("[MapSystem] Player tile not found in minimap.");
        }

        console.log("[MapSystem] Minimap updated successfully.");
    },
    
    /**
     * Generate minimap HTML with enhanced styling support
     */
    generateMinimapHTML() {
        try {
            if (!this.currentMap) {
                console.warn("[MapSystem] No current map loaded in generateMinimapHTML.");
                return '';
            }

            const gridSize = this.currentMap.gridSize || { width: 5, height: 5 };
            const width = typeof gridSize.width === 'number' ? gridSize.width : 5;
            const height = typeof gridSize.height === 'number' ? gridSize.height : 5;
            const { x: playerX, y: playerY } = this.currentPosition;

            console.log(`[MapSystem] Rendering full minimap: ${width}x${height} on map "${this.currentMap.mapId || '[no id]'}"`);

            let html = `<div class="tile-grid minimap-grid" style="grid-template-columns: repeat(${width}, 1fr);">`;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const node = this.getNodeAt(x, y);
                    const isPlayer = (x === playerX && y === playerY);
                    const isRevealed = this.isTileRevealed(this.currentMap.mapId, x, y);

                    let tileClass = 'tile minimap-tile';
                    let tileContent = '';
                    let tileStyle = '';

                    if (!isRevealed && this.currentMap.fogOfWar) {
                        tileClass += ' tile-hidden';
                    } else if (node) {
                        tileClass += ' tile-node';

                        if (node.style) {
                            try {
                                tileStyle = this.generateNodeStyle(node.style);
                                if (node.style.pattern && node.style.pattern !== 'none') {
                                    tileClass += ` node-pattern-${node.style.pattern}`;
                                }
                            } catch (styleError) {
                                console.warn(`[MapSystem] Style error on node (${x},${y}):`, styleError);
                            }
                        }

                        if (node.tags) {
                            try {
                                if (node.tags.some(tag => tag.startsWith('entry-'))) {
                                    tileClass += ' entry-point';
                                }
                                node.tags.forEach(tag => {
                                    tileClass += ` tag-${tag.replace(/[^a-zA-Z0-9-]/g, '-')}`;
                                });
                            } catch (tagError) {
                                console.warn(`[MapSystem] Tag error on node (${x},${y}):`, tagError);
                            }
                        }

                        if (isPlayer) {
                            tileClass += ' player-tile';
                            tileContent = '<i data-lucide="user" class="player-indicator"></i>';
                        } else {
                            try {
                                const effectiveNode = this.getEffectiveNodeData(node);
                                if (effectiveNode.icon) {
                                    tileContent = `<i data-lucide="${effectiveNode.icon}" class="tile-icon"></i>`;
                                }
                            } catch (iconError) {
                                console.warn(`[MapSystem] Icon error on node (${x},${y}):`, iconError);
                            }
                        }

                        if (node.transitions) {
                            try {
                                Object.keys(node.transitions).forEach(dir => {
                                    const transition = node.transitions[dir];
                                    tileClass += ` has-${dir}`;
                                    if (transition.type === 'one-way') {
                                        tileClass += ` oneway-${dir}`;
                                    }
                                });
                            } catch (transitionError) {
                                console.warn(`[MapSystem] Transition error on node (${x},${y}):`, transitionError);
                            }
                        }
                    } else {
                        tileClass += ' tile-empty';
                    }

                    html += `<div class="${tileClass}" data-x="${x}" data-y="${y}" style="${tileStyle}">${tileContent}</div>`;
                }
            }

            html += '</div>';
            return html;

        } catch (e) {
            console.error("[MapSystem] Error generating minimap HTML:", e);
            return '<div class="tile-grid minimap-grid"><div class="tile minimap-tile tile-error">❌</div></div>';
        }
    },


    
    /**
     * Update minimap info display
     */
    updateMinimapInfo() {
        const mapNameEl = document.getElementById('minimap-current-map');
        const coordsEl = document.getElementById('minimap-player-coords');
        
        if (mapNameEl && this.currentMap) {
            mapNameEl.textContent = this.currentMap.name;
        }
        
        if (coordsEl) {
            coordsEl.textContent = `(${this.currentPosition.x}, ${this.currentPosition.y})`;
        }
    },
    
    /**
     * Get the effective node data after applying conditions
     */
    getEffectiveNodeData(node) {
        if (!node || !node.conditions || node.conditions.length === 0) {
            return node;
        }
        
        // Create a copy of the node data
        const effectiveNode = { ...node };
        
        // Check conditions in priority order (first condition that matches wins)
        for (const condition of node.conditions) {
            if (this.evaluateCondition(condition)) {
                // Apply the condition's changes
                if (condition.passage) {
                    effectiveNode.passage = condition.passage;
                }
                if (condition.icon) {
                    effectiveNode.icon = condition.icon;
                }
                // First matching condition takes precedence
                break;
            }
        }
        
        return effectiveNode;
    },
    
    /**
     * Update location info in sidebar
     */
    updateLocationInfo() {
        if (!this.currentMap) return;
        
        const currentNode = this.getNodeAt(this.currentPosition.x, this.currentPosition.y);
        const effectiveNode = this.getEffectiveNodeData(currentNode);
        const locationName = effectiveNode ? effectiveNode.name : 'Unknown Location';
        
        // Update world state
        if (State.variables.world) {
            State.variables.world.locationName = locationName;
        }
        
        // Update sidebar display
        const locationEl = document.getElementById('sidebar-location');
        if (locationEl) {
            locationEl.textContent = locationName;
        }
    },
    
    /**
     * Generate full map HTML for journal with enhanced styling
     */
    generateFullMapHTML() {
        if (!this.currentMap) {
            return '<div class="map-placeholder">No map loaded</div>';
        }
        
        const { width, height } = this.currentMap.gridSize;
        const { x: playerX, y: playerY } = this.currentPosition;
        
        let html = `<div class="tile-grid full-map-grid" style="grid-template-columns: repeat(${width}, 40px); grid-template-rows: repeat(${height}, 40px);">`;
        
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                const node = this.getNodeAt(x, y);
                const isPlayer = (x === playerX && y === playerY);
                const isRevealed = this.isTileRevealed(this.currentMap.mapId, x, y);
                
                let tileClass = 'tile full-map-tile';
                let tileContent = '';
                let tileStyle = '';
                
                if (!isRevealed && this.currentMap.fogOfWar) {
                    tileClass += ' tile-hidden';
                } else if (node) {
                    tileClass += ' tile-node';
                    
                    // Apply node styling
                    if (node.style) {
                        tileStyle = this.generateNodeStyle(node.style);
                        if (node.style.pattern && node.style.pattern !== 'none') {
                            tileClass += ` node-pattern-${node.style.pattern}`;
                        }
                    }
                    
                    // Add entry point indicator
                    if (node.tags && node.tags.some(tag => tag.startsWith('entry-'))) {
                        tileClass += ' entry-point';
                    }
                    
                    // Add region/tag classes for styling
                    if (node.tags) {
                        node.tags.forEach(tag => {
                            tileClass += ` tag-${tag.replace(/[^a-zA-Z0-9-]/g, '-')}`;
                        });
                    }
                    
                    if (isPlayer) {
                        tileClass += ' player-tile';
                        tileContent = '<i data-lucide="user" class="player-indicator"></i>';
                    } else {
                        const effectiveNode = this.getEffectiveNodeData(node);
                        if (effectiveNode.icon) {
                            tileContent = `<i data-lucide="${effectiveNode.icon}" class="tile-icon"></i>`;
                        }
                    }
                    
                    // Add click handler for movement
                    if (this.isAdjacentToPlayer(x, y)) {
                        tileClass += ' tile-clickable';
                    }
                    
                    // Add transitions
                    if (node.transitions) {
                        Object.keys(node.transitions).forEach(dir => {
                            const transition = node.transitions[dir];
                            tileClass += ` has-${dir}`;
                            
                            if (transition.type === 'one-way') {
                                tileClass += ` oneway-${dir}`;
                            }
                        });
                    }
                } else {
                    tileClass += ' tile-empty';
                }
                
                html += `<div class="${tileClass}" data-x="${x}" data-y="${y}" onclick="MapSystem.handleTileClick(${x}, ${y})" style="${tileStyle}">${tileContent}</div>`;
            }
        }
        
        html += '</div>';
        return html;
    },
    
    /**
     * Check if coordinates are adjacent to player
     */
    isAdjacentToPlayer(x, y) {
        const { x: px, y: py } = this.currentPosition;
        const dx = Math.abs(x - px);
        const dy = Math.abs(y - py);
        
        return (dx === 1 && dy === 0) || (dx === 0 && dy === 1);
    },
    
    /**
     * Handle tile click in full map
     */
    handleTileClick(x, y) {
        if (!this.isAdjacentToPlayer(x, y)) {
            return;
        }
        
        const { x: px, y: py } = this.currentPosition;
        let direction = null;
        
        if (x > px) direction = 'east';
        else if (x < px) direction = 'west';
        else if (y > py) direction = 'south';
        else if (y < py) direction = 'north';
        
        if (direction) {
            this.movePlayer(direction);
        }
    },
    
    /**
     * Update full map display in journal
     */
    updateFullMapDisplay() {
        const container = document.getElementById('full-map-container');
        const mapTitle = document.getElementById('map-title');
        
        if (!container) {
            return;
        }
        
        if (!this.currentMap) {
            container.innerHTML = `
                <div class="map-placeholder">
                    <i data-lucide="map"></i>
                    <p>No map loaded</p>
                    <p>Use <code>MapSystem.setCurrentMap('example-map')</code> to load a map</p>
                </div>
            `;
            if (mapTitle) {
                mapTitle.textContent = 'No Map Loaded';
            }
            return;
        }
        
        // Update map title
        if (mapTitle) {
            mapTitle.textContent = this.currentMap.name;
        }
        
        // Generate full map HTML
        const mapHtml = this.generateFullMapHTML();
        container.innerHTML = mapHtml;
        
        // Re-render Lucide icons
        if (window.lucide) {
            lucide.createIcons();
        }
    },
    
    // ===== ENHANCED GAMEPLAY UTILITY FUNCTIONS =====
    
    /**
     * Generate CSS style string for node styling
     */
    generateNodeStyle(style) {
        let styleString = '';
        
        if (style.primaryColor && style.primaryColor !== '#007bff') {
            styleString += `background-color: ${style.primaryColor}; `;
            styleString += `--node-primary-color: ${style.primaryColor}; `;
        }
        
        if (style.secondaryColor && style.secondaryColor !== '#6c757d') {
            styleString += `--node-secondary-color: ${style.secondaryColor}; `;
        }
        
        return styleString;
    },
    
    /**
     * Get all nodes with specific tags
     */
    getNodesByTag(tag) {
        if (!this.currentMap) return [];
        
        return this.currentMap.nodes.filter(node => 
            node.tags && node.tags.includes(tag)
        );
    },
    
    /**
     * Get all nodes in a specific region
     */
    getNodesByRegion(region) {
        return this.getNodesByTag(region);
    },
    
    /**
     * Get current node's tags
     */
    getCurrentNodeTags() {
        const currentNode = this.getNodeAt(this.currentPosition.x, this.currentPosition.y);
        return currentNode ? (currentNode.tags || []) : [];
    },
    
    /**
     * Check if current location has specific tag
     */
    currentLocationHasTag(tag) {
        return this.getCurrentNodeTags().includes(tag);
    },
    
    /**
     * Get entry point position by type
     */
    getEntryPointPosition(entryType) {
        if (!this.entryPointRegistry.has(entryType)) {
            return null;
        }
        
        const nodeKey = this.entryPointRegistry.get(entryType);
        const [x, y] = nodeKey.split(',').map(Number);
        return { x, y };
    },
    
    /**
     * Teleport player to entry point
     */
    teleportToEntryPoint(entryType) {
        const position = this.getEntryPointPosition(entryType);
        if (!position) {
            console.warn(`[MapSystem] Entry point not found: ${entryType}`);
            return false;
        }
        
        const targetNode = this.getNodeAt(position.x, position.y);
        if (!targetNode) {
            console.warn(`[MapSystem] No node at entry point position: ${entryType}`);
            return false;
        }
        
        // Update position
        this.currentPosition = position;
        State.variables.player.mapState.position = { ...position };
        
        // Reveal tiles for fog of war
        if (this.currentMap.fogOfWar) {
            this.revealTile(this.currentMap.mapId, position.x, position.y);
            this.revealAdjacentTiles(this.currentMap.mapId, position.x, position.y);
        }
        
        // Update displays
        this.updateMinimapDisplay();
        this.updateLocationInfo();
        
        // Navigate to the target passage
        const effectiveNode = this.getEffectiveNodeData(targetNode);
        if (effectiveNode.passage) {
            console.log(`[MapSystem] Teleporting to passage: ${effectiveNode.passage}`);
            Engine.play(effectiveNode.passage);
        }
        
        return true;
    },
    
    /**
     * Get passage text for current or specified node
     */
    getPassageText(nodeKey = null) {
        if (!nodeKey) {
            nodeKey = `${this.currentPosition.x},${this.currentPosition.y}`;
        }
        
        return this.passageTexts.get(nodeKey) || null;
    },
    
    /**
     * Get map metadata
     */
    getMapMetadata() {
        if (!this.currentMap) return null;
        
        return {
            mapId: this.currentMap.mapId,
            name: this.currentMap.name,
            region: this.currentMap.region || null,
            width: this.currentMap.gridSize.width,
            height: this.currentMap.gridSize.height,
            entryPoints: Object.fromEntries(this.entryPointRegistry),
            tagLibrary: Array.from(this.projectTagLibrary)
        };
    },
    
    /**
     * Check if player can access a specific region/area
     */
    canAccessRegion(regionTag) {
        const currentTags = this.getCurrentNodeTags();
        
        // Example: "public" areas allow access to most regions
        if (currentTags.includes('public')) {
            return true;
        }
        
        // Example: "restricted" areas might block access
        if (currentTags.includes('restricted')) {
            return false;
        }
        
        // Default: allow access
        return true;
    },
    
    /**
     * Get all available entry points from current location
     */
    getAvailableEntryPoints() {
        const availableEntries = [];
        
        for (const [entryType, nodeKey] of this.entryPointRegistry) {
            const [x, y] = nodeKey.split(',').map(Number);
            const node = this.getNodeAt(x, y);
            
            if (node) {
                availableEntries.push({
                    type: entryType,
                    position: { x, y },
                    name: node.name,
                    tags: node.tags || []
                });
            }
        }
        
        return availableEntries;
    }

};

// Initialize when DOM is ready
$(document).ready(() => {
    MapSystem.init();
});

// Update map display on passage changes
$(document).on(':passagedisplay', () => {
    if (MapSystem.currentMap) {
        MapSystem.updateMinimapDisplay();
        MapSystem.updateLocationInfo();
    }
});

// Update full map when journal map tab is opened
$(document).on('click', '[data-tab="map"]', () => {
    setTimeout(() => {
        if (MapSystem.currentMap) {
            MapSystem.updateFullMapDisplay();
        }
    }, 100);
});
/* twine-user-script #30: "16_RGNPCSystem.js" */
/* ======================================================
   RGNPC (Randomly Generated NPC) System
   ------------------------------------------------------
   A comprehensive system for creating, managing, and 
   persisting randomly generated NPCs with full depth:
   - Identity, relationships, personality, body, status
   - Schedules, occupations, quests, social ties
   - Dynamic discovery and relationship building
   - Cultural/racial naming variations
   - Population management per region
========================================================= */

// Global RGNPC storage and management
window.RGNPCSystem = {
    // Core data storage
    npcs: new Map(), // rgnpcId -> RGNPC object
    locationPopulations: new Map(), // locationId -> Set of rgnpcIds
    scheduleCache: new Map(), // rgnpcId -> current schedule data
    
    // Configuration
    config: {
        maxPopulationPerLocation: {
            'small_village': 15,
            'large_village': 30,
            'small_town': 50,
            'large_town': 100,
            'small_city': 200,
            'large_city': 500,
            'capital': 1000,
            'tavern': 25,
            'market': 40,
            'temple': 15,
            'palace': 30,
            'slums': 50,
            'default': 25
        },
        relationshipRanges: {
            trust: [-10, 10],
            affection: [-10, 10], 
            rapport: [0, 10],
            tension: [0, 10]
        },
        scheduleSlots: [
            { name: 'earlyMorning', start: 6.5, end: 9.5 },    // 6:30-9:29 AM
            { name: 'lateMorning', start: 9.5, end: 12 },      // 9:30-11:59 AM
            { name: 'afternoon', start: 12, end: 17.5 },       // 12:00-5:29 PM
            { name: 'evening', start: 17.5, end: 20 },         // 5:30-7:59 PM
            { name: 'night', start: 20, end: 24 },             // 8:00-11:59 PM
            { name: 'lateNight', start: 0, end: 6.5 }          // 12:00-6:29 AM
        ]
    },

    // Initialize the system
    initialize() {
        console.log("🧩 Initializing RGNPC System...");
        
        // Load persisted data if available
        this.loadPersistedData();
        
        // Set up event listeners
        this.setupEventListeners();
        
        // Validate data files
        this.validateDataFiles();
        
        console.log("✅ RGNPC System initialized");
    },

    // Validate that all required data files are loaded
    validateDataFiles() {
        const requiredData = [
            'setup.Archetypes',
            'setup.NamePools',
            'setup.PersonalityTraits',
            'setup.Inclinations',
            'setup.Motivations',
            'setup.SocialStyles',
            'setup.BodyDescriptors'
        ];
        
        const missing = [];
        for (const dataPath of requiredData) {
            const parts = dataPath.split('.');
            let obj = window;
            for (const part of parts) {
                if (!obj[part]) {
                    missing.push(dataPath);
                    break;
                }
                obj = obj[part];
            }
        }
        
        if (missing.length > 0) {
            console.warn('⚠️ Missing required data files:', missing);
        }
    },

    // Generate a new RGNPC
    generateRGNPC(options = {}) {
        const rng = new Math.seedrandom(options.seed || Math.random());
        
        // Generate unique ID
        const rgnpcId = this.generateUniqueId();
        
        // Determine basic identity
        const race = options.race || this.selectRace(rng);
        const genderIdentity = options.gender || this.selectGender(rng);
        const locationType = options.locationType || 'default';
        const archetype = options.archetype || this.selectArchetype(rng, race, locationType);
        
        // Generate core RGNPC structure
        const rgnpc = {
            // Core Identity
            rgnpcId: rgnpcId,
            race: race,
            genderIdentity: genderIdentity,
            archetype: archetype,
            
            // Names (initially unknown to player)
            name: this.generateName(race, genderIdentity, rng),
            defaultName: null, // Will be generated from body description
            known: false,
            knownTraits: new Set(), // Gradually revealed traits
            
            // Avatar
            avatar: this.selectAvatar(race, genderIdentity, archetype, rng),
            
            // Pronouns
            pronouns: this.generatePronouns(genderIdentity, rng),
            
            // Relationships (initialized randomly within ranges)
            trust: this.randomInRange(this.config.relationshipRanges.trust, rng),
            affection: this.randomInRange(this.config.relationshipRanges.affection, rng),
            rapport: this.randomInRange(this.config.relationshipRanges.rapport, rng),
            tension: this.randomInRange(this.config.relationshipRanges.tension, rng),
            
            // Personality
            traits: this.selectTraits(archetype, rng),
            inclinations: this.selectInclinations(archetype, rng),
            motivations: this.selectMotivations(archetype, rng),
            socialStyle: this.selectSocialStyle(archetype, rng),
            
            // Body (full physical description)
            body: this.generateBody(race, genderIdentity, archetype, rng),
            
            // Status
            health: 100,
            maxHealth: 100,
            fatigue: this.randomInRange([0, 30], rng),
            maxFatigue: 100,
            
            // Inventory
            inventory: this.generateInventory(archetype, rng),
            
            // Occupation
            occupation: this.generateOccupation(archetype, rng),
            
            // Quests (generated from templates)
            availableQuests: this.generateQuests(archetype, rng),
            completedQuests: [],
            
            // Social Ties
            socialTies: this.generateSocialTies(rng),
            
            // Schedule (weekly repeating)
            schedule: this.generateSchedule(archetype, locationType, rng),
            currentLocation: options.location || null,
            
            // World Interaction Flags
            canBePickpocketed: true,
            canBeAttacked: true,
            crimeWitnessLevel: this.selectCrimeWitnessLevel(archetype, rng),
            
            // Metadata
            createdAt: Date.now(),
            lastInteraction: null,
            birthDate: this.generateBirthDate(rng),
            
            // Hidden stats (not shown to player)
            hiddenStats: {
                fear: this.randomInRange([0, 10], rng),
                respect: this.randomInRange([0, 10], rng),
                lust: this.randomInRange([0, 10], rng),
                loyalty: this.randomInRange([0, 10], rng)
            }
        };
        
        // Generate default name from body description
        rgnpc.defaultName = this.generateDefaultName(rgnpc);
        
        // Store the RGNPC
        this.npcs.set(rgnpcId, rgnpc);
        
        console.log(`🧩 Generated RGNPC: ${rgnpc.defaultName} (${rgnpcId})`);
        return rgnpc;
    },

    // Generate unique ID for RGNPC
    generateUniqueId() {
        let id;
        do {
            id = `rgnpc_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
        } while (this.npcs.has(id));
        return id;
    },

    // Select race based on world demographics
    selectRace(rng) {
        const raceWeights = {
            'human': 0.45,
            'elf': 0.20,
            'half_orc': 0.15,
            'halfling': 0.10,
            'half_demon': 0.08,
            'dwarf': 0.02  // Extremely rare as noted
        };
        
        return this.weightedRandom(raceWeights, rng);
    },

    // Select gender identity
    selectGender(rng) {
        const genderWeights = {
            'male': 0.48,
            'female': 0.48,
            'non_binary': 0.04
        };
        
        return this.weightedRandom(genderWeights, rng);
    },

    // Select archetype based on race preferences and location
    selectArchetype(rng, race, locationType = 'default') {
        // Use location-based weights if available
        if (setup.ArchetypeUtils && setup.ArchetypeUtils.getArchetypeForLocation) {
            return setup.ArchetypeUtils.getArchetypeForLocation(locationType, rng);
        }
        
        // Fallback to random selection
        const archetypeKeys = Object.keys(setup.Archetypes || {});
        if (archetypeKeys.length === 0) {
            console.warn('⚠️ No archetypes available');
            return 'Laborer'; // Default fallback
        }
        return archetypeKeys[Math.floor(rng() * archetypeKeys.length)];
    },

    // Generate culturally appropriate name
    generateName(race, gender, rng) {
        // Use the improved name generation utilities if available
        if (setup.NameUtils && setup.NameUtils.generateCulturalName) {
            return setup.NameUtils.generateCulturalName(race, gender, null, rng);
        }
        
        // Fallback to basic generation
        const namePool = setup.NamePools?.[race];
        if (!namePool) {
            console.warn(`⚠️ No name pool for ${race}, using human names`);
            return this.generateName('human', gender, rng);
        }
        
        // Handle non-binary names by randomly choosing from male/female pools
        let genderPool = gender;
        if (gender === 'non_binary') {
            genderPool = rng() > 0.5 ? 'male' : 'female';
        }
        
        if (!namePool[genderPool]) {
            console.warn(`⚠️ No name pool for ${race}/${gender}, using first available`);
            genderPool = Object.keys(namePool).find(key => key !== 'surnames') || 'male';
        }
        
        const firstNames = namePool[genderPool];
        if (!firstNames || firstNames.length === 0) {
            return 'Unknown';
        }
        
        const firstName = firstNames[Math.floor(rng() * firstNames.length)];
        
        // Generate surname if available
        let fullName = firstName;
        if (namePool.surnames && namePool.surnames.length > 0) {
            const surname = namePool.surnames[Math.floor(rng() * namePool.surnames.length)];
            fullName = `${firstName} ${surname}`;
        }
        
        return fullName;
    },

    // Generate pronouns based on gender identity
    generatePronouns(genderIdentity, rng) {
        const pronounSets = {
            'male': {
                subject: 'he',
                object: 'him', 
                possessive: 'his',
                reflexive: 'himself',
                noun: 'man'
            },
            'female': {
                subject: 'she',
                object: 'her',
                possessive: 'her', 
                reflexive: 'herself',
                noun: 'woman'
            },
            'non_binary': {
                subject: 'they',
                object: 'them',
                possessive: 'their',
                reflexive: 'themself',
                noun: 'person'
            }
        };
        
        return pronounSets[genderIdentity] || pronounSets['non_binary'];
    },

    // Select personality traits
    selectTraits(archetype, rng) {
        const archetypeData = setup.Archetypes?.[archetype];
        const allTraits = Object.keys(setup.PersonalityTraits || {});
        
        if (allTraits.length === 0) {
            console.warn('⚠️ No personality traits available');
            return ['curious', 'practical'];
        }
        
        const numTraits = 3 + Math.floor(rng() * 3); // 3-5 traits
        
        const selectedTraits = [];
        const usedTraits = new Set();
        
        // Prefer archetype-aligned traits
        if (archetypeData && archetypeData.preferredTraits) {
            for (const trait of archetypeData.preferredTraits) {
                if (selectedTraits.length < numTraits && !usedTraits.has(trait) && setup.PersonalityTraits[trait]) {
                    selectedTraits.push(trait);
                    usedTraits.add(trait);
                    
                    // Add conflicting traits to used set
                    const traitData = setup.PersonalityTraits[trait];
                    if (traitData && traitData.conflicts) {
                        traitData.conflicts.forEach(conflict => usedTraits.add(conflict));
                    }
                }
            }
        }
        
        // Fill remaining slots with random traits
        let attempts = 0;
        while (selectedTraits.length < numTraits && attempts < 100) {
            attempts++;
            const trait = allTraits[Math.floor(rng() * allTraits.length)];
            if (!usedTraits.has(trait)) {
                selectedTraits.push(trait);
                usedTraits.add(trait);
                
                // Add conflicting traits to used set
                const traitData = setup.PersonalityTraits[trait];
                if (traitData && traitData.conflicts) {
                    traitData.conflicts.forEach(conflict => usedTraits.add(conflict));
                }
            }
        }
        
        return selectedTraits;
    },

    // Select inclinations
    selectInclinations(archetype, rng) {
        const archetypeData = setup.Archetypes?.[archetype];
        const allInclinations = Object.keys(setup.Inclinations || {});
        
        if (allInclinations.length === 0) {
            console.warn('⚠️ No inclinations available');
            return ['vanilla'];
        }
        
        const numInclinations = 1 + Math.floor(rng() * 3); // 1-3 inclinations
        
        const selected = [];
        
        // Prefer archetype-aligned inclinations
        if (archetypeData && archetypeData.preferredInclinations) {
            for (const inclination of archetypeData.preferredInclinations) {
                if (selected.length < numInclinations && setup.Inclinations[inclination]) {
                    selected.push(inclination);
                }
            }
        }
        
        // Fill remaining slots
        let attempts = 0;
        while (selected.length < numInclinations && attempts < 50) {
            attempts++;
            const inclination = allInclinations[Math.floor(rng() * allInclinations.length)];
            if (!selected.includes(inclination)) {
                selected.push(inclination);
            }
        }
        
        return selected;
    },

    // Select motivations
    selectMotivations(archetype, rng) {
        const archetypeData = setup.Archetypes?.[archetype];
        const allMotivations = Object.keys(setup.Motivations || {});
        
        if (allMotivations.length === 0) {
            console.warn('⚠️ No motivations available');
            return ['survival'];
        }
        
        const numMotivations = 1 + Math.floor(rng() * 2); // 1-2 motivations
        
        const selected = [];
        
        // Prefer archetype-aligned motivations
        if (archetypeData && archetypeData.preferredMotivations) {
            for (const motivation of archetypeData.preferredMotivations) {
                if (selected.length < numMotivations && setup.Motivations[motivation]) {
                    selected.push(motivation);
                }
            }
        }
        
        // Fill remaining slots
        let attempts = 0;
        while (selected.length < numMotivations && attempts < 50) {
            attempts++;
            const motivation = allMotivations[Math.floor(rng() * allMotivations.length)];
            if (!selected.includes(motivation)) {
                selected.push(motivation);
            }
        }
        
        return selected;
    },

    // Select social style
    selectSocialStyle(archetype, rng) {
        const archetypeData = setup.Archetypes?.[archetype];
        
        // Prefer archetype-aligned styles
        if (archetypeData && archetypeData.styles && archetypeData.styles.length > 0) {
            return archetypeData.styles[Math.floor(rng() * archetypeData.styles.length)];
        }
        
        // Fallback to random style
        const allStyles = Object.keys(setup.SocialStyles || {});
        if (allStyles.length === 0) {
            console.warn('⚠️ No social styles available');
            return 'polite';
        }
        
        return allStyles[Math.floor(rng() * allStyles.length)];
    },

    // Generate full body description
    generateBody(race, genderIdentity, archetype, rng) {
        const body = {
            // Basic measurements
            height: this.generateHeight(race, genderIdentity, rng),
            weight: null, // Will be calculated from other factors
            
            // Body composition
            bodyType: Math.floor(rng() * (setup.BodyDescriptors?.bodyType?.length || 8)),
            muscleTone: Math.floor(rng() * (setup.BodyDescriptors?.muscleTone?.length || 7)),
            
            // Physical features
            skinTone: this.generateSkinTone(race, rng),
            hairColor: this.generateHairColor(race, rng),
            hairStyle: this.generateHairStyle(genderIdentity, rng),
            hairLength: this.generateHairLength(genderIdentity, rng),
            eyeColor: this.generateEyeColor(race, rng),
            
            // Facial features
            lipFullness: Math.floor(rng() * (setup.BodyDescriptors?.lipFullness?.length || 6)),
            
            // Body details
            bodyHair: Math.floor(rng() * (setup.BodyDescriptors?.bodyHair?.length || 5)),
            voiceTone: this.generateVoiceTone(genderIdentity, rng),
            
            // Gender-specific features
            ...(genderIdentity === 'female' || genderIdentity === 'non_binary' ? {
                breastSize: Math.floor(rng() * (setup.BodyDescriptors?.breastSize?.length || 7)),
                hipWidth: Math.floor(rng() * (setup.BodyDescriptors?.hipWidth?.length || 4))
            } : {}),
            
            buttSize: Math.floor(rng() * (setup.BodyDescriptors?.buttSize?.length || 7)),
            
            // Sexual characteristics (for adult content)
            ...(genderIdentity === 'male' || genderIdentity === 'non_binary' ? {
                penisSize: this.generatePenisSize(rng)
            } : {}),
            
            // Special racial features
            ...this.generateRacialFeatures(race, rng)
        };
        
        // Calculate weight based on height and body type
        body.weight = this.calculateWeight(body.height, body.bodyType, body.muscleTone);
        
        return body;
    },

    // Generate height based on race and gender
    generateHeight(race, genderIdentity, rng) {
        const baseHeights = {
            'human': { male: 70, female: 65, non_binary: 67.5 },
            'elf': { male: 68, female: 63, non_binary: 65.5 },
            'half_orc': { male: 74, female: 69, non_binary: 71.5 },
            'dwarf': { male: 52, female: 48, non_binary: 50 },
            'halfling': { male: 42, female: 40, non_binary: 41 },
            'half_demon': { male: 71, female: 66, non_binary: 68.5 }
        };
        
        const base = baseHeights[race]?.[genderIdentity] || baseHeights['human'][genderIdentity] || 67.5;
        const variation = (rng() - 0.5) * 8; // ±4 inches variation
        
        return Math.round(base + variation);
    },

    // Generate other body features...
    generateSkinTone(race, rng) {
        const skinTones = {
            'human': ['pale', 'fair', 'light', 'olive', 'tan', 'brown', 'dark brown', 'deep brown'],
            'elf': ['porcelain', 'pale', 'fair', 'light olive', 'golden'],
            'half_orc': ['green-tinged', 'olive-green', 'bronze', 'dark olive'],
            'dwarf': ['ruddy', 'tan', 'bronze', 'weathered brown'],
            'halfling': ['rosy', 'fair', 'tan', 'warm brown'],
            'half_demon': ['pale', 'ashen', 'red-tinged', 'midnight blue', 'deep purple']
        };
        
        const tones = skinTones[race] || skinTones['human'];
        return tones[Math.floor(rng() * tones.length)];
    },

    generateHairColor(race, rng) {
        const hairColors = {
            'human': ['black', 'dark brown', 'brown', 'light brown', 'blonde', 'red', 'auburn', 'gray'],
            'elf': ['silver', 'platinum blonde', 'golden blonde', 'auburn', 'copper', 'white'],
            'half_orc': ['black', 'dark brown', 'brown', 'gray'],
            'dwarf': ['black', 'dark brown', 'brown', 'red', 'gray', 'white'],
            'halfling': ['brown', 'light brown', 'blonde', 'red', 'curly brown'],
            'half_demon': ['black', 'deep red', 'purple-black', 'silver', 'white']
        };
        
        const colors = hairColors[race] || hairColors['human'];
        return colors[Math.floor(rng() * colors.length)];
    },

    generateHairStyle(genderIdentity, rng) {
        const styles = {
            'male': ['short and neat', 'messy', 'slicked back', 'tousled', 'cropped', 'shaved sides'],
            'female': ['long and flowing', 'braided', 'in a bun', 'loose waves', 'straight', 'curly'],
            'non_binary': ['shoulder-length', 'asymmetrical', 'layered', 'textured', 'natural', 'undercut']
        };
        
        const genderStyles = styles[genderIdentity] || styles['non_binary'];
        return genderStyles[Math.floor(rng() * genderStyles.length)];
    },

    generateHairLength(genderIdentity, rng) {
        const ranges = {
            'male': [1, 6],      // buzzed to short
            'female': [4, 26],   // short to waist-length  
            'non_binary': [2, 14] // cropped to shoulder-length
        };
        
        const [min, max] = ranges[genderIdentity] || ranges['non_binary'];
        return min + Math.floor(rng() * (max - min + 1));
    },

    generateEyeColor(race, rng) {
        const eyeColors = {
            'human': ['brown', 'blue', 'green', 'hazel', 'gray'],
            'elf': ['blue', 'green', 'silver', 'violet', 'gold'],
            'half_orc': ['brown', 'amber', 'red', 'yellow'],
            'dwarf': ['brown', 'blue', 'gray', 'green'],
            'halfling': ['brown', 'blue', 'green', 'hazel'],
            'half_demon': ['red', 'yellow', 'purple', 'black', 'silver']
        };
        
        const colors = eyeColors[race] || eyeColors['human'];
        return colors[Math.floor(rng() * colors.length)];
    },

    generateVoiceTone(genderIdentity, rng) {
        const tones = {
            'male': ['deep', 'gravelly', 'smooth', 'commanding', 'gentle', 'raspy'],
            'female': ['melodic', 'breathy', 'clear', 'warm', 'sultry', 'crisp'],
            'non_binary': ['soft', 'neutral', 'pleasant', 'calm', 'measured', 'androgynous']
        };
        
        const genderTones = tones[genderIdentity] || tones['non_binary'];
        return genderTones[Math.floor(rng() * genderTones.length)];
    },

    generatePenisSize(rng) {
        // Realistic distribution (inches)
        const mean = 5.5;
        const stdDev = 0.8;
        let size = this.normalRandom(mean, stdDev, rng);
        return Math.max(3, Math.min(10, Math.round(size * 2) / 2)); // Round to nearest 0.5, clamp 3-10
    },

    generateRacialFeatures(race, rng) {
        const features = {};
        
        switch (race) {
            case 'elf':
                features.ears = 'pointed';
                break;
            case 'half_orc':
                features.tusks = rng() > 0.5 ? 'small tusks' : 'pronounced canines';
                break;
            case 'dwarf':
                if (rng() > 0.3) features.beard = 'thick beard';
                break;
            case 'half_demon':
                if (rng() > 0.6) features.horns = 'small horns';
                if (rng() > 0.7) features.tail = 'thin tail';
                break;
        }
        
        return features;
    },

    // Calculate weight from other body factors
    calculateWeight(height, bodyType, muscleTone) {
        const baseWeight = (height - 60) * 2.3 + 110; // Rough BMI calculation
        const typeMultiplier = [0.7, 0.8, 0.9, 1.0, 1.2, 1.4, 1.6, 1.8][bodyType] || 1.0;
        const muscleMultiplier = [0.9, 0.95, 1.0, 1.05, 1.1, 1.2, 1.3][muscleTone] || 1.0;
        
        return Math.round(baseWeight * typeMultiplier * muscleMultiplier);
    },

    // Generate default name from physical description
    generateDefaultName(rgnpc) {
        const body = rgnpc.body;
        const descriptors = [];
        
        // Height descriptor
        if (setup.BodyDescriptors?.heightDescriptor) {
            descriptors.push(setup.BodyDescriptors.heightDescriptor(body.height));
        } else {
            // Fallback height description
            if (body.height <= 54) descriptors.push('short');
            else if (body.height <= 66) descriptors.push('average height');
            else descriptors.push('tall');
        }
        
        // Build descriptor
        if (body.bodyType !== undefined && setup.BodyDescriptors?.bodyType) {
            descriptors.push(setup.BodyDescriptors.bodyType[body.bodyType]);
        }
        
        // Hair color if notable
        if (body.hairColor && !['brown', 'black'].includes(body.hairColor.toLowerCase())) {
            descriptors.push(body.hairColor + '-haired');
        }
        
        // Gender noun
        descriptors.push(rgnpc.pronouns.noun);
        
        // Combine descriptors intelligently
        if (descriptors.length > 3) {
            return `${descriptors[0]} ${descriptors[descriptors.length - 1]} with ${descriptors[descriptors.length - 2]} hair`;
        } else {
            return descriptors.join(' ');
        }
    },

    // Generate inventory based on archetype
    generateInventory(archetype, rng) {
        // This would integrate with existing inventory system
        // For now, return basic structure
        const inventoryTemplates = {
            'Warden': {
                visible: ['sword', 'shield', 'armor'],
                hidden: ['coin_pouch', 'keys'],
                equipped: ['sword', 'shield', 'armor']
            },
            'Merchant': {
                visible: ['ledger', 'coin_pouch'],
                hidden: ['valuable_goods', 'contracts'],
                equipped: ['fine_clothes']
            },
            'Thief': {
                visible: ['dagger'],
                hidden: ['lockpicks', 'stolen_goods'],
                equipped: ['dagger', 'dark_cloak']
            }
        };
        
        const template = inventoryTemplates[archetype] || {
            visible: [],
            hidden: ['coin_pouch'],
            equipped: []
        };
        
        return {
            visible: [...template.visible],
            hidden: [...template.hidden],
            equipped: [...template.equipped]
        };
    },

    // Generate occupation
    generateOccupation(archetype, rng) {
        const occupations = {
            'Warden': ['City Guard', 'Gate Guard', 'Prison Guard', 'Patrol Officer'],
            'Courtesan': ['Entertainer', 'Dancer', 'Musician', 'Hostess'],
            'Witchling': ['Herbalist', 'Fortune Teller', 'Scribe', 'Researcher'],
            'Scholar': ['Librarian', 'Teacher', 'Researcher', 'Archivist'],
            'Merchant': ['Trader', 'Shop Owner', 'Caravan Master', 'Appraiser'],
            'Artisan': ['Blacksmith', 'Carpenter', 'Jeweler', 'Tailor'],
            'Laborer': ['Dock Worker', 'Miner', 'Construction Worker', 'Porter'],
            'Farmer': ['Crop Farmer', 'Livestock Keeper', 'Orchard Tender', 'Beekeeper'],
            'Thief': ['Pickpocket', 'Burglar', 'Fence', 'Con Artist'],
            'Bard': ['Minstrel', 'Storyteller', 'Court Jester', 'Traveling Performer'],
            'Healer': ['Physician', 'Herbalist', 'Midwife', 'Surgeon'],
            'Priest': ['Cleric', 'Monk', 'Temple Keeper', 'Spiritual Advisor'],
            'Noble': ['Lord/Lady', 'Courtier', 'Diplomat', 'Estate Manager'],
            'Innkeeper': ['Tavern Owner', 'Innkeeper', 'Brewmaster', 'Host'],
            'Hunter': ['Tracker', 'Trapper', 'Guide', 'Beast Slayer']
        };
        
        const archetypeJobs = occupations[archetype] || ['Laborer', 'Merchant', 'Artisan', 'Farmer'];
        const jobTitle = archetypeJobs[Math.floor(rng() * archetypeJobs.length)];
        
        return {
            jobTitle: jobTitle,
            skills: this.generateSkills(jobTitle, rng),
            shopId: null // Could link to shop system
        };
    },

    generateSkills(jobTitle, rng) {
        // Generate relevant skills based on job
        const skillSets = {
            'City Guard': ['Combat', 'Investigation', 'Intimidation'],
            'Entertainer': ['Performance', 'Persuasion', 'Insight'],
            'Herbalist': ['Nature', 'Medicine', 'Alchemy'],
            'Merchant': ['Persuasion', 'Insight', 'Deception'],
            'Blacksmith': ['Crafting', 'Strength', 'Metallurgy'],
            'Physician': ['Medicine', 'Investigation', 'Herbalism'],
            'Pickpocket': ['Sleight of Hand', 'Stealth', 'Perception'],
            'Tracker': ['Survival', 'Nature', 'Perception']
        };
        
        return skillSets[jobTitle] || ['General Labor'];
    },

    // Generate quests from templates
    generateQuests(archetype, rng) {
        // This would use Madlib-style templates based on motivation/personality
        // For now, return empty array - to be expanded
        return [];
    },

    // Generate social ties
    generateSocialTies(rng) {
        return {
            family: [],
            friends: [],
            enemies: [],
            guilds: [],
            factions: []
        };
    },

    // Generate weekly schedule
    generateSchedule(archetype, locationType, rng) {
        const schedule = {};
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
        // Get archetype-specific activities
        const archetypeActivities = this.getArchetypeActivities(archetype);
        
        for (const day of days) {
            schedule[day] = {};
            for (const slot of this.config.scheduleSlots) {
                schedule[day][slot.name] = this.generateScheduleActivity(archetype, slot, archetypeActivities, rng);
            }
        }
        
        return schedule;
    },

    getArchetypeActivities(archetype) {
        const activities = {
            'Warden': {
                earlyMorning: ['patrol duty', 'morning drills', 'guard post'],
                lateMorning: ['patrol duty', 'training', 'paperwork'],
                afternoon: ['patrol duty', 'guard post', 'prisoner duty'],
                evening: ['patrol duty', 'shift change', 'tavern visit'],
                night: ['night watch', 'tavern visit', 'off duty'],
                lateNight: ['night watch', 'sleeping']
            },
            'Merchant': {
                earlyMorning: ['opening shop', 'inventory check', 'breakfast'],
                lateMorning: ['selling goods', 'negotiating deals', 'managing shop'],
                afternoon: ['selling goods', 'meeting suppliers', 'counting coins'],
                evening: ['closing shop', 'dinner', 'social networking'],
                night: ['bookkeeping', 'relaxing', 'planning'],
                lateNight: ['sleeping']
            },
            'Courtesan': {
                earlyMorning: ['sleeping', 'beauty routine'],
                lateMorning: ['sleeping', 'preparing for work'],
                afternoon: ['socializing', 'entertaining clients', 'rehearsing'],
                evening: ['entertaining clients', 'performing', 'socializing'],
                night: ['entertaining clients', 'performing', 'private sessions'],
                lateNight: ['winding down', 'counting earnings', 'sleeping']
            }
        };
        
        return activities[archetype] || {
            earlyMorning: ['sleeping', 'waking up', 'morning routine'],
            lateMorning: ['working', 'breakfast', 'morning chores'],
            afternoon: ['working', 'socializing', 'errands'],
            evening: ['dinner', 'socializing', 'relaxing'],
            night: ['socializing', 'entertainment', 'personal time'],
            lateNight: ['sleeping', 'night shift', 'personal time']
        };
    },

    generateScheduleActivity(archetype, timeSlot, archetypeActivities, rng) {
        const slotActivities = archetypeActivities[timeSlot.name] || ['free time'];
        const activity = slotActivities[Math.floor(rng() * slotActivities.length)];
        
        // Determine location based on activity
        const activityLocations = {
            'patrol duty': ['streets', 'gates', 'market'],
            'guard post': ['gates', 'palace', 'prison'],
            'selling goods': ['market', 'shop'],
            'entertaining clients': ['brothel', 'tavern', 'private quarters'],
            'sleeping': ['home', 'barracks', 'inn'],
            'tavern visit': ['tavern'],
            'working': ['workplace', 'market', 'fields']
        };
        
        const possibleLocations = activityLocations[activity] || [null];
        const location = possibleLocations[Math.floor(rng() * possibleLocations.length)];
        
        return {
            activity: activity,
            location: location,
            priority: Math.floor(rng() * 10)
        };
    },

    // Select avatar based on characteristics
    selectAvatar(race, genderIdentity, archetype, rng) {
        // For now, return placeholder - would integrate with avatar system
        return 'images/portrait_default.png';
    },

    // Generate birth date
    generateBirthDate(rng) {
        // Generate age between 18-60
        const age = 18 + Math.floor(rng() * 42);
        const currentYear = 12219; // AI (After Impact)
        const birthYear = currentYear - age;
        
        // Random season and day
        const seasons = ['Snow', 'Rain', 'Sun', 'Harvest'];
        const season = seasons[Math.floor(rng() * seasons.length)];
        const day = 1 + Math.floor(rng() * 100); // 1-100 days per season
        
        return {
            day: day,
            season: season,
            year: birthYear,
            age: age
        };
    },

    // Select crime witness behavior
    selectCrimeWitnessLevel(archetype, rng) {
        const levels = ['ignore', 'report', 'intervene'];
        const weights = {
            'Warden': { ignore: 0.1, report: 0.3, intervene: 0.6 },
            'Courtesan': { ignore: 0.6, report: 0.3, intervene: 0.1 },
            'Witchling': { ignore: 0.4, report: 0.5, intervene: 0.1 },
            'Merchant': { ignore: 0.3, report: 0.6, intervene: 0.1 },
            'Thief': { ignore: 0.8, report: 0.1, intervene: 0.1 },
            'Noble': { ignore: 0.2, report: 0.7, intervene: 0.1 },
            'Priest': { ignore: 0.2, report: 0.6, intervene: 0.2 }
        };
        
        const archetypeWeights = weights[archetype] || { ignore: 0.4, report: 0.4, intervene: 0.2 };
        return this.weightedRandom(archetypeWeights, rng);
    },

    // Utility functions
    randomInRange(range, rng) {
        const [min, max] = range;
        return min + Math.floor(rng() * (max - min + 1));
    },

    weightedRandom(weights, rng) {
        const totalWeight = Object.values(weights).reduce((sum, weight) => sum + weight, 0);
        let random = rng() * totalWeight;
        
        for (const [key, weight] of Object.entries(weights)) {
            random -= weight;
            if (random <= 0) return key;
        }
        
        return Object.keys(weights)[0]; // Fallback
    },

    normalRandom(mean, stdDev, rng) {
        // Box-Muller transform for normal distribution
        const u1 = rng();
        const u2 = rng();
        const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        return mean + z0 * stdDev;
    },

    // Population management
    getLocationPopulation(locationId) {
        return this.locationPopulations.get(locationId) || new Set();
    },

    addNPCToLocation(rgnpcId, locationId) {
        if (!this.locationPopulations.has(locationId)) {
            this.locationPopulations.set(locationId, new Set());
        }
        this.locationPopulations.get(locationId).add(rgnpcId);
        
        // Update NPC's current location
        const npc = this.npcs.get(rgnpcId);
        if (npc) {
            npc.currentLocation = locationId;
        }
    },

    removeNPCFromLocation(rgnpcId, locationId) {
        const population = this.locationPopulations.get(locationId);
        if (population) {
            population.delete(rgnpcId);
        }
    },

    // Check if location can accommodate more NPCs
    canAddNPCToLocation(locationId, locationType = 'default') {
        const currentPopulation = this.getLocationPopulation(locationId).size;
        const maxPopulation = this.config.maxPopulationPerLocation[locationType] || this.config.maxPopulationPerLocation.default;
        return currentPopulation < maxPopulation;
    },

    // Get NPCs in a specific location
    getNPCsInLocation(locationId) {
        const population = this.getLocationPopulation(locationId);
        return Array.from(population).map(id => this.npcs.get(id)).filter(npc => npc);
    },

    // Get RGNPC by ID
    getRGNPC(rgnpcId) {
        return this.npcs.get(rgnpcId);
    },

    // Update RGNPC relationship values
    updateRelationship(rgnpcId, relationshipType, change) {
        const npc = this.npcs.get(rgnpcId);
        if (!npc) return false;

        const range = this.config.relationshipRanges[relationshipType];
        if (!range) return false;

        const [min, max] = range;
        npc[relationshipType] = Math.max(min, Math.min(max, npc[relationshipType] + change));
        
        // Trigger event for UI updates
        $(document).trigger('rgnpc:relationship_updated', {
            rgnpcId: rgnpcId,
            type: relationshipType,
            newValue: npc[relationshipType]
        });
        
        return true;
    },

    // Mark NPC as known to player
    introduceNPC(rgnpcId) {
        const npc = this.npcs.get(rgnpcId);
        if (npc) {
            npc.known = true;
            npc.lastInteraction = Date.now();
            
            // Trigger event for UI updates
            $(document).trigger('rgnpc:introduced', { rgnpcId: rgnpcId });
            
            return true;
        }
        return false;
    },

    // Add known trait to NPC (gradual discovery)
    revealTrait(rgnpcId, trait) {
        const npc = this.npcs.get(rgnpcId);
        if (npc && npc.traits.includes(trait)) {
            npc.knownTraits.add(trait);
            
            // Trigger event for UI updates
            $(document).trigger('rgnpc:trait_revealed', {
                rgnpcId: rgnpcId,
                trait: trait
            });
            
            return true;
        }
        return false;
    },

    // Get current schedule activity for NPC
    getCurrentActivity(rgnpcId, currentTime = new Date()) {
        const npc = this.npcs.get(rgnpcId);
        if (!npc) return null;

        const dayOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][currentTime.getDay()];
        const hour = currentTime.getHours() + currentTime.getMinutes() / 60;

        // Find current time slot
        const currentSlot = this.config.scheduleSlots.find(slot => {
            if (slot.name === 'lateNight') {
                return hour >= slot.start || hour < slot.end;
            }
            return hour >= slot.start && hour < slot.end;
        });

        if (!currentSlot) return null;

        return npc.schedule[dayOfWeek]?.[currentSlot.name] || null;
    },

    // Kill an RGNPC (for consequences system)
    killRGNPC(rgnpcId, replacement = true) {
        const npc = this.npcs.get(rgnpcId);
        if (!npc) return false;

        const location = npc.currentLocation;
        
        // Remove from location
        if (location) {
            this.removeNPCFromLocation(rgnpcId, location);
        }

        // Remove from main storage
        this.npcs.delete(rgnpcId);

        console.log(`💀 RGNPC ${npc.name || npc.defaultName} (${rgnpcId}) has died`);

        // Trigger death event
        $(document).trigger('rgnpc:died', {
            rgnpcId: rgnpcId,
            name: npc.name || npc.defaultName,
            location: location
        });

        // Optionally generate replacement
        if (replacement && location) {
            setTimeout(() => {
                this.generateReplacementNPC(location);
            }, Math.random() * 86400000); // Random delay up to 24 hours
        }

        return true;
    },

    // Generate replacement NPC for location
    generateReplacementNPC(locationId, locationType = 'default') {
        if (!this.canAddNPCToLocation(locationId, locationType)) {
            return null;
        }

        const newNPC = this.generateRGNPC({ 
            location: locationId,
            locationType: locationType
        });
        this.addNPCToLocation(newNPC.rgnpcId, locationId);
        
        console.log(`🔄 Generated replacement RGNPC: ${newNPC.defaultName} in ${locationId}`);
        return newNPC;
    },

    // Populate a location with NPCs
    populateLocation(locationId, locationType = 'default', targetPopulation = null) {
        const maxPop = targetPopulation || this.config.maxPopulationPerLocation[locationType] || this.config.maxPopulationPerLocation.default;
        const currentPop = this.getLocationPopulation(locationId).size;
        const needed = Math.max(0, maxPop - currentPop);

        const generated = [];
        for (let i = 0; i < needed; i++) {
            const npc = this.generateRGNPC({ 
                location: locationId,
                locationType: locationType
            });
            this.addNPCToLocation(npc.rgnpcId, locationId);
            generated.push(npc);
        }

        console.log(`🏘️ Populated ${locationId} with ${generated.length} new RGNPCs (${currentPop + generated.length}/${maxPop})`);
        return generated;
    },

    // Persistence functions
    savePersistedData() {
        try {
            const data = {
                npcs: Array.from(this.npcs.entries()).map(([id, npc]) => {
                    // Convert Set to Array for serialization
                    const serializedNPC = { ...npc };
                    if (npc.knownTraits instanceof Set) {
                        serializedNPC.knownTraits = Array.from(npc.knownTraits);
                    }
                    return [id, serializedNPC];
                }),
                locationPopulations: Array.from(this.locationPopulations.entries()).map(([key, value]) => [key, Array.from(value)]),
                version: '1.1'
            };
            
            localStorage.setItem('rgnpc_data', JSON.stringify(data));
            console.log('💾 RGNPC data saved to localStorage');
        } catch (error) {
            console.error('❌ Failed to save RGNPC data:', error);
        }
    },

    loadPersistedData() {
        try {
            const saved = localStorage.getItem('rgnpc_data');
            if (!saved) return;

            const data = JSON.parse(saved);
            
            // Restore NPCs
            this.npcs.clear();
            for (const [id, npc] of data.npcs) {
                // Convert knownTraits back to Set
                if (Array.isArray(npc.knownTraits)) {
                    npc.knownTraits = new Set(npc.knownTraits);
                } else if (!npc.knownTraits) {
                    npc.knownTraits = new Set();
                }
                this.npcs.set(id, npc);
            }

            // Restore location populations
            this.locationPopulations.clear();
            for (const [locationId, npcIds] of data.locationPopulations) {
                this.locationPopulations.set(locationId, new Set(npcIds));
            }

            console.log(`📂 Loaded ${this.npcs.size} RGNPCs from localStorage`);
        } catch (error) {
            console.error('❌ Failed to load RGNPC data:', error);
        }
    },

    // Event listeners setup
    setupEventListeners() {
        // Save data periodically
        setInterval(() => {
            this.savePersistedData();
        }, 300000); // Every 5 minutes

        // Save on page unload
        window.addEventListener('beforeunload', () => {
            this.savePersistedData();
        });

        // Listen for game events that might affect NPCs
        $(document).on('rgnpc:relationship_change', (event, data) => {
            this.updateRelationship(data.rgnpcId, data.type, data.change);
        });

        $(document).on('rgnpc:introduce', (event, data) => {
            this.introduceNPC(data.rgnpcId);
        });

        $(document).on('rgnpc:reveal_trait', (event, data) => {
            this.revealTrait(data.rgnpcId, data.trait);
        });

        // Listen for location changes
        $(document).on('location:changed', (event, data) => {
            // Could trigger NPC movement based on schedules
            this.updateNPCLocations(data.newLocation);
        });
    },

    // Update NPC locations based on schedules
    updateNPCLocations(currentLocation) {
        const currentTime = new Date();
        
        // Check each NPC's schedule
        for (const [rgnpcId, npc] of this.npcs) {
            const activity = this.getCurrentActivity(rgnpcId, currentTime);
            if (activity && activity.location && activity.location !== npc.currentLocation) {
                // NPC should be somewhere else based on schedule
                // This could trigger movement or just update their location
                console.log(`📍 ${npc.name || npc.defaultName} should be at ${activity.location} for ${activity.activity}`);
            }
        }
    },

    // Debug functions
    debugInfo() {
        console.log('🧩 RGNPC System Debug Info:');
        console.log(`Total NPCs: ${this.npcs.size}`);
        console.log(`Locations with NPCs: ${this.locationPopulations.size}`);
        
        for (const [locationId, population] of this.locationPopulations) {
            console.log(`  ${locationId}: ${population.size} NPCs`);
        }
        
        // Show data file status
        console.log('\n📁 Data File Status:');
        this.validateDataFiles();
    },

    // Generate test NPCs for debugging
    generateTestNPCs(count = 5, locationId = 'test_location', locationType = 'default') {
        const generated = [];
        for (let i = 0; i < count; i++) {
            const npc = this.generateRGNPC({ 
                location: locationId,
                locationType: locationType
            });
            this.addNPCToLocation(npc.rgnpcId, locationId);
            generated.push(npc);
        }
        
        console.log(`🧪 Generated ${count} test RGNPCs in ${locationId}`);
        return generated;
    },

    // Export system state for debugging
    exportSystemState() {
        return {
            npcs: Array.from(this.npcs.entries()),
            locationPopulations: Array.from(this.locationPopulations.entries()).map(([k, v]) => [k, Array.from(v)]),
            config: this.config
        };
    }
};

// Initialize the system when the script loads
$(document).ready(() => {
    if (window.RGNPCSystem) {
        RGNPCSystem.initialize();
    }
});
/* twine-user-script #31: "CrownAndCasteLogic.js" */
setup.CrownAndCaste = {
  // ==========================
  // 1. Core Initialization
  // ==========================

initSession(playerIds, stakes = "standard", houseRules = [], playerFavor = 1.0, buyIn = 15) {
  const maxPlayers = 4;
  const finalIds = playerIds.slice(0, maxPlayers);

  const generatedPlayers = finalIds.map((id, index) => {
    const basePlayer = {
      gold: buyIn,
      chips: 3,
      casteDice: [null, null, null],
      locks: [false, false, false],
      combo: null,
      scoreRank: null,
      isEliminated: false,
      bet: 0,
    };

    // 🧍 Player (always first)
    if (index === 0) {
      return {
        ...basePlayer,
        name: typeof id === "string" ? id : "You",
        isPlayer: true,
        isGhost: false,
      };
    }

    // 👻 Generic Ghost
    if (id === "ghost") {
      return {
        ...basePlayer,
        name: `Ghost ${index}`,
        isPlayer: false,
        isGhost: true,
      };
    }

    // 📝 Custom literal name object (e.g., { name: "Stranger" })
    if (typeof id === "object" && id.name) {
      return {
        ...basePlayer,
        name: id.name,
        isPlayer: false,
        isGhost: false,
        npcId: `custom-${index}`,
      };
    }

    // 🧠 Standard character from character list
    const npc = State.variables.characters?.[id];
    return {
      ...basePlayer,
      name: npc?.name || `Unknown (${id})`,
      isPlayer: false,
      isGhost: false,
      npcId: id,
    };
  });

  State.temporary.ccSession = {
    players: generatedPlayers,
    dealerIndex: Math.floor(Math.random() * generatedPlayers.length),
    currentRound: 1,
    currentPlayerIndex: 0,
    crownDice: [null, null, null],
    crownLocks: [false, false, false],
    crownProtected: false,
    gameNumber: 1,
    totalGamesInSession: 0,
    pot: 0,
    turnPhase: "betting",
    gamesSinceChipRefresh: 0,
    gameComplete: false,
    stakes: stakes,
    chipCost: setup.CrownAndCaste.getChipCost(stakes),
    houseRules: houseRules,
    playerFavor: playerFavor
  };

  console.log(`[CrownAndCaste] Session initialized with ${generatedPlayers.length} players (Buy-In: ${buyIn}g)`);
},  
  
  hasHouseRule(ruleName) {
    const session = State.temporary.ccSession;
    return session.houseRules && session.houseRules.includes(ruleName);
  },

  getStandardBet(stakes) {
    switch (stakes.toLowerCase()) {
      case "low": return 3;
      case "standard": return 5;
      case "high": return 10;
      default: return 5;
    }
  },

  getChipCost(stakes) {
    switch (stakes.toLowerCase()) {
      case "low": return 2;
      case "standard": return 3;
      case "high": return 5;
      default: return 3;
    }
  },
  
startGame() {
  const session = State.temporary.ccSession;

  if (!session || !session.players) {
    console.error("[CrownAndCaste] No session found. Call initSession first.");
    return;
  }

  session.currentRound = 1;
  session.currentPlayerIndex = 0;
  session.pot = 0;
  session.turnPhase = "rolling";
  session.crownDice = [null, null, null];
  session.crownLocks = [false, false, false];
  session.crownProtected = false;
  session.turnsTakenThisRound = 0;
  session.gameComplete = false;

  // 🎯 Determine active (non-eliminated) players
  const activePlayers = session.players.filter(p => !p.isEliminated);
  let standardBet = this.getStandardBet(session.stakes);

  // 💰 Double bet if only 2 players remain
  if (activePlayers.length === 2) {
    standardBet *= 2;
    console.log(`[CrownAndCaste] Only 2 players remain — doubling base bet to ${standardBet}g.`);
  }

  for (const player of session.players) {
    player.casteDice = [null, null, null];
    player.locks = [false, false, false];
    player.combo = null;
    player.scoreRank = null;
    player.usedChipThisTurn = false;

    // 💰 Deduct standard bet or go all-in
    const betAmount = Math.min(player.gold, standardBet);
    player.bet = betAmount;
    player.gold -= betAmount;
    session.pot += betAmount;

    console.log(`[CrownAndCaste] ${player.name} bet ${betAmount}g. Remaining gold: ${player.gold}`);
  }

  // 🎲 Roll Crown Die 1 to start
  this.rollCrownDie(0);

  // 🕹 First active (non-eliminated) player goes first
  for (let i = 0; i < session.players.length; i++) {
    const p = session.players[i];
    if (!p.isEliminated) {
      session.currentPlayerIndex = i;
      this.rollCasteDice(i);
      if (!p.isPlayer) this.processNPCTurn(i);
      break;
    }
  }

  console.log(`[CrownAndCaste] Game ${session.gameNumber} started. Standard bet applied: ${standardBet}g`);
},



  startNextGame() {
    const session = State.temporary.ccSession;

    if (!session || !session.players) {
      console.error("[CrownAndCaste] No session found. Cannot start next game.");
      return;
    }

    if (!session.gameComplete) {
      console.warn("[CrownAndCaste] Current game is not complete. Cannot start next game.");
      return;
    }

    console.log(`[CrownAndCaste] Starting next game (Game ${session.gameNumber}) in session...`);
    
    // Start the next game
    this.startGame();
    
    // Update UI to reflect new game state
    this.updateUI();
  },



  endTurn() {
    const session = State.temporary.ccSession;

    // 🛑 Guard against recursive turn-ending loops
    if (session._currentlyEndingTurn) {
      console.warn("[CrownAndCaste] Prevented recursive endTurn call.");
      return;
    }
    session._currentlyEndingTurn = true;

    const currentPlayer = session.players[session.currentPlayerIndex];
    console.log(`[CrownAndCaste] Ending turn for ${currentPlayer.name}`);

    // 🧮 Track that one player just finished their turn
    session.turnsTakenThisRound++;

    const players = session.players;
    const activePlayers = players.filter(p => !p.isEliminated).length;
    const roundComplete = session.turnsTakenThisRound >= activePlayers;

    console.log(`[CrownAndCaste] Turn ${session.turnsTakenThisRound}/${activePlayers} completed. Round complete: ${roundComplete}`);

    if (roundComplete) {
      if (session.currentRound < 3) {
        // 🔁 Advance to next round
        session.currentRound++;
        session.turnsTakenThisRound = 0;

        console.log(`[CrownAndCaste] Advancing to Round ${session.currentRound}`);

        // 🎲 Roll the next Crown Die
        this.rollCrownDie(session.currentRound - 1);

        // 🔄 Reset chip usage for all players (1 chip per round)
        session.players.forEach(p => {
          p.usedChipThisTurn = false;
        });

        // 👑 Start next round with first player after dealer
        session.currentPlayerIndex = this.getNextPlayerClockwise(session.dealerIndex);
        const starter = session.players[session.currentPlayerIndex];
        console.log(`[CrownAndCaste] Round ${session.currentRound} starts with ${starter.name}`);

        // 🎲 Auto-roll their unlocked Caste Dice
        this.rollCasteDice(session.currentPlayerIndex);

        // ✅ Resume game
        session._currentlyEndingTurn = false;
        this.updateUI();

        if (!starter.isPlayer) {
          this.scheduleNPCTurn(session.currentPlayerIndex);
        }

        return;

      } else {
        // ✅ Final round completed — lock all dice before resolving
        session.players.forEach(p => {
          if (!p.isEliminated) {
            p.locks = [true, true, true];
          }
        });

        session.crownLocks = [true, true, true];
        session.crownProtected = true;

        console.log("[CrownAndCaste] Final round reached — all dice have been locked.");
        console.log("[CrownAndCaste] Final round completed. Resolving game...");

        session._currentlyEndingTurn = false;
        this.resolveGame();
        return;
      }
    }


    // 🔁 Continue to next player in same round
    const nextPlayerIndex = this.getNextPlayerClockwise(session.currentPlayerIndex);
    if (nextPlayerIndex === -1) {
      console.warn("[CrownAndCaste] No next player found!");
      session._currentlyEndingTurn = false;
      return;
    }

    session.currentPlayerIndex = nextPlayerIndex;
    const nextPlayer = session.players[nextPlayerIndex];
    console.log(`[CrownAndCaste] Next turn: ${nextPlayer.name}`);

    if (session.currentRound > 1) {
      this.rollCasteDice(nextPlayerIndex);
    }

    session._currentlyEndingTurn = false;
    this.updateUI();

    if (!nextPlayer.isPlayer) {
      this.scheduleNPCTurn(nextPlayerIndex);
    }
  },


  updateUI() {
    if (setup.CrownAndCasteUI?.updateGameStatus) {
      setup.CrownAndCasteUI.updateGameStatus();
    }
    if (setup.CrownAndCasteUI?.updateInteractionStates) {
      setup.CrownAndCasteUI.updateInteractionStates();
    }
    if (setup.CrownAndCasteUI?.renderPlayerPanels) {
      setup.CrownAndCasteUI.renderPlayerPanels();
    }
    if (setup.CrownAndCasteUI?.renderCrownDice) {
      setup.CrownAndCasteUI.renderCrownDice();
    }
  },

  scheduleNPCTurn(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    console.log(`[CrownAndCaste] Scheduling NPC turn for ${npc.name}`);
    
    // Process NPC actions immediately
    this.processNPCDiceActions(playerIndex);
    this.processNPCChipStrategy(playerIndex);
    
    // Schedule turn end after delay
    setTimeout(() => {
      if (!session._currentlyEndingTurn && session.currentPlayerIndex === playerIndex) {
        console.log(`[CrownAndCaste] Auto-ending turn for NPC ${npc.name}`);
        this.endTurn();
      }
    }, 1500);
  },

  advancePhase() {
    const session = State.temporary.ccSession;
    
    switch (session.turnPhase) {
      case "crown-roll":
        this.rollCrownDie(session.currentRound - 1);
        session.turnPhase = "player-actions";
        session.currentPlayerIndex = this.getNextPlayerClockwise(session.dealerIndex);
        break;
        
      case "player-actions":
        if (this.allPlayersActed()) {
          if (session.currentRound < 3) {
            session.currentRound++;
            session.turnPhase = "crown-roll";
          } else {
            this.resolveGame();
          }
        } else {
          session.currentPlayerIndex = this.getNextPlayerClockwise(session.currentPlayerIndex);
        }
        break;
    }
  },

  endSession() {
    const session = State.temporary.ccSession;
    
    // Reset all chips at session end
    session.players.forEach(p => {
      if (!p.isEliminated) {
        p.chips = 3;
      }
    });
    
    console.log("[CrownAndCaste] Session ended. All Control Chips reset.");
  },
  // ==========================
  // 2. Dice Logic
  // ==========================

  rollCasteDice(playerIndex) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];

    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Cannot roll dice for player index ${playerIndex}`);
      return;
    }

    for (let i = 0; i < 3; i++) {
      if (!player.locks[i]) {
        // Always reroll unlocked dice in Rounds 2 and 3
        if (session.currentRound > 1 || player.casteDice[i] === null) {
          player.casteDice[i] = this.rollDie();
        }
      }
    }

    console.log(`[CrownAndCaste] Rolled Caste Dice for ${player.name}:`, player.casteDice);

    // 🟠 House Rule: Cutthroat Caste
    if (this.hasHouseRule?.("cutthroat-caste")) {
      const hasLockedDie = player.locks.some(lock => lock);
      if (!hasLockedDie) {
        console.warn(`[CrownAndCaste] Cutthroat Caste: ${player.name} must lock at least one die.`);
        // Simple enforcement: auto-lock first die
        player.locks[0] = true;
        console.log(`[CrownAndCaste] Cutthroat Caste enforced: auto-locked die 1 for ${player.name}.`);
      }
    }

    if (setup.CrownAndCasteUI?.updateDiceDisplay) {
      setup.CrownAndCasteUI.updateDiceDisplay(playerIndex);
    }
  },


  lockDie(playerIndex, dieIndex) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];

    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Cannot toggle lock for player index ${playerIndex}`);
      return;
    }

    if (dieIndex < 0 || dieIndex >= 3) {
      console.warn(`[CrownAndCaste] Invalid die index: ${dieIndex}`);
      return;
    }

    const isLocked = player.locks[dieIndex];

    if (!isLocked) {
      // Locking is always allowed
      player.locks[dieIndex] = true;
      console.log(`[CrownAndCaste] ${player.name} locked die ${dieIndex + 1}`);
    } else {
      // Unlocking only allowed in Round 1
      if (session.currentRound === 1) {
        player.locks[dieIndex] = false;
        console.log(`[CrownAndCaste] ${player.name} unlocked die ${dieIndex + 1}`);
      } else {
        console.warn(`[CrownAndCaste] ${player.name} cannot unlock die after Round 1.`);
        setup.CrownAndCasteUI?.showFeedback?.("You can't unlock dice in later rounds!");
        return; // Stop here; don't call UI update
      }
    }

    // Update lock icon
    if (setup.CrownAndCasteUI?.updateLockDisplay) {
      setup.CrownAndCasteUI.updateLockDisplay(playerIndex, dieIndex, player.locks[dieIndex]);
    }
  },


  rollCrownDie(index, { isControlChip = false } = {}) {
    const session = State.temporary.ccSession;

    if (index < 0 || index > 2) {
      console.warn(`[CrownAndCaste] Invalid Crown Die index: ${index}`);
      return;
    }

    if (isControlChip && session.crownProtected) {
      console.warn(`[CrownAndCaste] Crown is protected. Cannot reroll Crown Die ${index + 1} via Control Chip.`);
      return;
    }

    const dealer = session.players[session.dealerIndex];
    const customDie = this.getDealerCrownDie(dealer, index);

    const value = (customDie && typeof customDie.roll === "function")
      ? customDie.roll()
      : this.rollDie();

    session.crownDice[index] = value;

    console.log(`[CrownAndCaste] Crown Die ${index + 1} rolled: ${value}${customDie ? ` (using ${customDie.name})` : ""}`);

    if (setup.CrownAndCasteUI?.updateCrownDisplay) {
      setup.CrownAndCasteUI.updateCrownDisplay(index, value);
    }
  },


  getDealerCrownDie(dealer, index) {
    if (!dealer || dealer.isEliminated) return null;
    
    // Get dealer's inventory
    const dealerInventory = State.variables[`inventory_${dealer.isPlayer ? 'player' : dealer.npcId}`];
    if (!dealerInventory) return null;
    
    // Find Crown dice in inventory
    const crownDiceIds = Object.keys(dealerInventory).filter(itemId => {
      const item = getItemMetadata(itemId);
      return item && item.subtype === "crown-die";
    });
    
    if (crownDiceIds.length === 0) return null;
    
    // Use the crown die at the specified index, or cycle through available ones
    const selectedId = crownDiceIds[index % crownDiceIds.length];
    return getItemMetadata(selectedId);
  },


  lockCrownDice() {
    const session = State.temporary.ccSession;

    session.crownProtected = true;
    session.crownLocks = [true, true, true];

    console.log(`[CrownAndCaste] Crown has been protected. All Crown Dice are now locked.`);

    if (setup.CrownAndCasteUI?.updateCrownLockDisplay) {
      for (let i = 0; i < 3; i++) {
        setup.CrownAndCasteUI.updateCrownLockDisplay(i, true);
      }
    }
  },

  // ==========================
  // 3. Control Chips
  // ==========================

  useControlChip(playerIndex, actionType, targetIndex = null) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];

    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Invalid or eliminated player for chip use.`);
      return;
    }

    if (player.usedChipThisTurn) {
      console.warn(`[CrownAndCaste] ${player.name} already used a Control Chip this turn.`);
      return;
    }

    if (playerIndex === session.dealerIndex) {
      console.warn(`[CrownAndCaste] Dealer cannot use Control Chips.`);
      return;
    }

    if (actionType === "reroll-other" && targetIndex === session.dealerIndex) {
      console.warn("[CrownAndCaste] Cannot target dealer with Control Chips.");
      return;
    }

    if (player.chips <= 0) {
      console.warn(`[CrownAndCaste] Player ${player.name} has no Control Chips left.`);
      return;
    }

    let chipCost = session.chipCost || 2;
    if (this.hasHouseRule("golden-tax")) {
      chipCost += 1;
    }

    const actualCost = Math.min(chipCost, player.gold); // Fortune's Mercy
    player.gold -= actualCost;
    session.pot += actualCost; // Add to pot
    player.chips--;
    player.usedChipThisTurn = true;

    console.log(`[CrownAndCaste] ${player.name} used a Control Chip (${actionType}), paid ${actualCost}g.`);

    switch (actionType) {
      case "reroll-own": {
        if (targetIndex === null || targetIndex < 0 || targetIndex >= 3) {
          console.warn("[CrownAndCaste] Invalid targetIndex for reroll-own.");
          return;
        }

        if (!player.locks[targetIndex]) {
          console.warn(`[CrownAndCaste] Cannot reroll an unlocked die.`);
          return;
        }

        player.casteDice[targetIndex] = this.rollDie();
        console.log(`[CrownAndCaste] ${player.name} rerolled their locked die ${targetIndex + 1}.`);
        break;
      }

      case "reroll-other": {
        const targetInfo = targetIndex; // now expecting { targetPlayerIndex, dieIndex }
        const targetPlayer = session.players[targetInfo.targetPlayerIndex];

        if (!targetPlayer || targetPlayer.isEliminated || targetInfo.targetPlayerIndex === playerIndex) {
          console.warn("[CrownAndCaste] Invalid target for reroll-other.");
          return;
        }

        const dieIndex = targetInfo.dieIndex;

        if (
          dieIndex < 0 || dieIndex >= 3 ||
          !targetPlayer.locks[dieIndex]
        ) {
          console.warn(`[CrownAndCaste] Cannot reroll die ${dieIndex + 1} — not locked or invalid.`);
          return;
        }

        const oldValue = targetPlayer.casteDice[dieIndex];
        const newValue = this.rollDie();
        targetPlayer.casteDice[dieIndex] = newValue;

        console.log(`[CrownAndCaste] ${player.name} rerolled ${targetPlayer.name}'s locked die ${dieIndex + 1} (was ${oldValue}, now ${newValue}).`);

        if (setup.CrownAndCasteUI?.renderPlayerPanels) {
          setup.CrownAndCasteUI.renderPlayerPanels();
        }

        break;
      }



      case "reroll-crown": {
        if (targetIndex === null || targetIndex < 0 || targetIndex >= 3) {
          console.warn("[CrownAndCaste] Invalid crown die index for reroll.");
          return;
        }

        if (session.crownLocks[targetIndex]) {
          console.warn("[CrownAndCaste] That Crown Die is locked. Cannot reroll.");
          return;
        }

        if (session.crownDice[targetIndex] === null) {
          console.warn("[CrownAndCaste] Cannot reroll an unrolled Crown Die.");
          return;
        }

        this.rollCrownDie(targetIndex);
        console.log(`[CrownAndCaste] ${player.name} rerolled Crown Die ${targetIndex + 1}.`);
        break;
      }



      case "lock-crown": {
        this.lockCrownDice();
        console.log(`[CrownAndCaste] ${player.name} used a chip to Protect the Crown.`);
        break;
      }

      default:
        console.warn(`[CrownAndCaste] Unknown actionType: ${actionType}`);
        break;
    }

    if (setup.CrownAndCasteUI?.updateChipDisplay) {
      setup.CrownAndCasteUI.updateChipDisplay(playerIndex, player.chips, player.gold);
    }
  },

  canUseControlChip(playerIndex) {
    const session = State.temporary.ccSession;
    const player = session.players?.[playerIndex];
    
    if (!player || player.isEliminated) {
      console.warn(`[CrownAndCaste] Cannot use chip: invalid or eliminated player at index ${playerIndex}.`);
      return false;
    }

    if (playerIndex === session.dealerIndex) {
      console.log(`[CrownAndCaste] Dealer cannot use Control Chips.`);
      return false;
    }

    if (player.usedChipThisTurn) {
      console.log(`[CrownAndCaste] ${player.name} already used a Control Chip this turn.`);
      return false;
    }
  
    const hasChips = player.chips > 0;
  
    if (!hasChips) {
      console.log(`[CrownAndCaste] ${player.name} has no Control Chips left.`);
    }
  
    return hasChips;
  },
  

  // ==========================
  // 4. Scoring & Results
  // ==========================

  resolveGame() {
    const session = State.temporary.ccSession;

    if (!session || !session.players || session.players.length === 0) {
      console.error("[CrownAndCaste] Cannot resolve game: no session or players found.");
      return;
    }

    // Evaluate each player's combo
    session.players.forEach((p, i) => {
      const hasTripleSix = p.casteDice.filter(d => d === 6).length === 3;
      if (hasTripleSix && this.hasHouseRule?.("blessing-of-sixes")) {
        p.combo = { name: "Blessing of Sixes", usedDice: [0, 1, 2], rank: 999 };
        p.scoreRank = 999;
        console.log(`[CrownAndCaste] ${p.name} triggered Blessing of Sixes!`);
      } else {
        p.combo = this.evaluateCombos(p); // { name, details? }
        p.scoreRank = this.rankCombo(p.combo.name);
        console.log(`[CrownAndCaste] ${p.name}'s combo: ${p.combo.name} (Rank ${p.scoreRank})`);
      }
    });

    // Find highest ranked player(s)
    const ranked = session.players.map((p, i) => ({ index: i, rank: p.scoreRank }));
    ranked.sort((a, b) => b.rank - a.rank); // highest rank first

    const topRank = ranked[0].rank;
    const tied = ranked.filter(r => r.rank === topRank);
    let winnerIndex;

    if (tied.length > 1) {
      winnerIndex = this.breakTie(tied.map(r => r.index));
      console.log(`[CrownAndCaste] Tie-breaker selected winner: ${session.players[winnerIndex].name}`);
    } else {
      winnerIndex = tied[0].index;
      console.log(`[CrownAndCaste] Winner: ${session.players[winnerIndex].name}`);
    }

    // Award pot
    this.adjustGold(winnerIndex, session.pot);
    console.log(`[CrownAndCaste] ${session.players[winnerIndex].name} receives ${session.pot}g.`);

    // Advance session state
    session.totalGamesInSession++;
    session.gameNumber++;
    session.gamesSinceChipRefresh++;
    session.gameComplete = true;
    this.advanceDealer();

    if (session.gamesSinceChipRefresh >= 3) {
      this.refreshControlChips();
      session.gamesSinceChipRefresh = 0;
      console.log("[CrownAndCaste] All control chips have been refreshed after 3 games.");
    }

    this.checkElimination(winnerIndex);

    // Optional UI result trigger
    if (setup.CrownAndCasteUI?.showGameResult) {
      setup.CrownAndCasteUI.showGameResult(winnerIndex);
    }
  },

  
  evaluateCombos(player) {
    const session = State.temporary.ccSession;

    if (!session || !player || player.isEliminated) {
      console.warn("[CrownAndCaste] Cannot evaluate combos: invalid session or player.");
      return { name: "High Dice", usedDice: [], rank: 0, comboValues: [], highCard: 0 };
    }

    const fullDiceSet = player.casteDice.concat(session.crownDice);
    const result = setup.CrownAndCasteCombos.evaluate(fullDiceSet);

    if (!result || !result.name) {
      console.warn("[CrownAndCaste] Invalid combo evaluation result. Defaulting to High Dice.");
      return { name: "High Dice", usedDice: [], rank: 0, comboValues: [], highCard: 0 };
    }

    // 🟣 House Rule: Royal Flush enforcement
    if (
      this.hasHouseRule?.("royal-flush") &&
      (result.name === "Octline" || result.name === "Split Line")
    ) {
      const usesOnlyCrownDice = result.usedDice.every(i => i >= 3);
      if (!usesOnlyCrownDice) {
        console.log("[CrownAndCaste] Royal Flush rule active — straight invalidated.");
        return { name: "High Dice", usedDice: [], rank: 0, comboValues: [], highCard: 0 };
      }
    }

    // Enhanced combo evaluation with detailed values for tie-breaking
    const enhancedResult = this.enhanceComboDetails(result, fullDiceSet);
    return enhancedResult;
  },

  enhanceComboDetails(baseResult, fullDiceSet) {
    const counts = {};
    fullDiceSet.forEach(die => {
      if (die !== null) {
        counts[die] = (counts[die] || 0) + 1;
      }
    });

    let comboValues = [];
    let highCard = 0;
    const sortedDice = fullDiceSet.filter(d => d !== null).sort((a, b) => b - a);

    switch (baseResult.name) {
      case "Imperial Crown":
      case "Fivefold Glory":
        // For 5+ of a kind, the value is the repeated number
        const fiveKindValue = Object.keys(counts).find(k => counts[k] >= 5);
        comboValues = [parseInt(fiveKindValue)];
        break;

      case "Courtly Quad":
      case "Courtesan's Quad":
        // Four of a kind + pair or four of a kind alone
        const fourKind = Object.keys(counts).find(k => counts[k] === 4);
        const pair = Object.keys(counts).find(k => counts[k] === 2);
        comboValues = [parseInt(fourKind)];
        if (pair) comboValues.push(parseInt(pair));
        break;

      case "Royal Spread":
        // Two triplets
        const triplets = Object.keys(counts).filter(k => counts[k] === 3).map(k => parseInt(k)).sort((a, b) => b - a);
        comboValues = triplets;
        break;

      case "Tri-Crown":
        // Triplet + pair
        const triplet = Object.keys(counts).find(k => counts[k] === 3);
        const triPair = Object.keys(counts).find(k => counts[k] === 2);
        comboValues = [parseInt(triplet), parseInt(triPair)];
        break;

      case "Triplet":
        // Three of a kind
        const trip = Object.keys(counts).find(k => counts[k] === 3);
        comboValues = [parseInt(trip)];
        // Add kickers (remaining highest cards)
        const kickers = sortedDice.filter(d => d !== parseInt(trip)).slice(0, 3);
        comboValues = comboValues.concat(kickers);
        break;

      case "Dual Pairs":
        // Two pairs
        const pairs = Object.keys(counts).filter(k => counts[k] === 2).map(k => parseInt(k)).sort((a, b) => b - a);
        comboValues = pairs;
        // Add kicker
        const dualKicker = sortedDice.find(d => !pairs.includes(d));
        if (dualKicker) comboValues.push(dualKicker);
        break;

      case "Single Pair":
        // One pair
        const singlePair = Object.keys(counts).find(k => counts[k] === 2);
        comboValues = [parseInt(singlePair)];
        // Add kickers
        const singleKickers = sortedDice.filter(d => d !== parseInt(singlePair)).slice(0, 4);
        comboValues = comboValues.concat(singleKickers);
        break;

      case "Octline":
      case "Split Line":
      case "Line of Five Paired":
      case "Line of Five Unpaired":
        // Straights - highest card in the straight
        comboValues = [Math.max(...sortedDice)];
        break;

      case "Jester's Court":
        // Three pairs - list all pair values
        const allPairs = Object.keys(counts).filter(k => counts[k] === 2).map(k => parseInt(k)).sort((a, b) => b - a);
        comboValues = allPairs;
        break;

      default:
        // High card
        comboValues = sortedDice.slice(0, 6); // All dice as tiebreakers
        break;
    }

    highCard = sortedDice[0] || 0;

    return {
      ...baseResult,
      comboValues,
      highCard,
      allDice: sortedDice
    };
  },

  rankCombo(name) {
    if (!name || typeof name !== "string") {
      console.warn("[CrownAndCaste] Invalid combo name for ranking.");
      return 0;
    }
  
    const rank = setup.CrownAndCasteCombos?.rankIndex?.(name);
  
    if (typeof rank !== "number") {
      console.warn(`[CrownAndCaste] Unknown combo name: '${name}'. Defaulting to rank 0.`);
      return 0;
    }
  
    return rank;
  },
  

  breakTie(indices) {
    const session = State.temporary.ccSession;
    const candidates = indices.map(i => ({
      index: i,
      player: session.players[i],
    }));

    console.log(`[CrownAndCaste] Breaking tie between ${candidates.length} players with same combo rank`);

    // 1. Compare combo values directly (e.g., pair of 8s beats pair of 7s)
    candidates.sort((a, b) => {
      const aCombo = a.player.combo;
      const bCombo = b.player.combo;
      
      // Compare each combo value in order
      const maxLength = Math.max(aCombo.comboValues?.length || 0, bCombo.comboValues?.length || 0);
      for (let i = 0; i < maxLength; i++) {
        const aVal = aCombo.comboValues?.[i] || 0;
        const bVal = bCombo.comboValues?.[i] || 0;
        if (aVal > bVal) return -1;
        if (aVal < bVal) return 1;
      }
      return 0; // Still tied on combo values
    });

    // Check if first candidate wins on combo values
    const winner = candidates[0];
    const stillTied = candidates.filter(c => {
      const winnerVals = winner.player.combo.comboValues || [];
      const candidateVals = c.player.combo.comboValues || [];
      const maxLen = Math.max(winnerVals.length, candidateVals.length);
      
      for (let i = 0; i < maxLen; i++) {
        if ((winnerVals[i] || 0) !== (candidateVals[i] || 0)) {
          return false;
        }
      }
      return true;
    });

    if (stillTied.length === 1) {
      console.log(`[CrownAndCaste] Tie broken by combo values: ${winner.player.name} wins with ${winner.player.combo.comboValues}`);
      return winner.index;
    }

    console.log(`[CrownAndCaste] Still tied after combo values, ${stillTied.length} players remain`);

    // 2. Most Caste Dice used in the combo (prefer using your own dice)
    const maxCasteUsed = Math.max(...stillTied.map(c =>
      c.player.combo.usedDice?.filter(i => i < 3).length || 0
    ));
    const tiedByCaste = stillTied.filter(c =>
      (c.player.combo.usedDice?.filter(i => i < 3).length || 0) === maxCasteUsed
    );
    
    if (tiedByCaste.length === 1) {
      console.log(`[CrownAndCaste] Tie broken by caste dice usage: ${tiedByCaste[0].player.name} wins (used ${maxCasteUsed} caste dice)`);
      return tiedByCaste[0].index;
    }

    console.log(`[CrownAndCaste] Still tied after caste dice check, ${tiedByCaste.length} players remain`);

    // 3. Highest sum of unused dice (kicker comparison)
    const tiedByUnused = [];
    let highestUnusedSum = -1;
    
    for (const c of tiedByCaste) {
      const fullDice = c.player.casteDice.concat(session.crownDice);
      const usedIndices = c.player.combo.usedDice || [];
      const unused = fullDice.filter((die, i) => !usedIndices.includes(i) && die !== null);
      const total = unused.reduce((sum, val) => sum + val, 0);
      
      console.log(`[CrownAndCaste] ${c.player.name} unused dice sum: ${total} (dice: ${unused})`);
      
      if (total > highestUnusedSum) {
        highestUnusedSum = total;
        tiedByUnused.length = 0;
        tiedByUnused.push(c);
      } else if (total === highestUnusedSum) {
        tiedByUnused.push(c);
      }
    }
    
    if (tiedByUnused.length === 1) {
      console.log(`[CrownAndCaste] Tie broken by unused dice sum: ${tiedByUnused[0].player.name} wins (${highestUnusedSum})`);
      return tiedByUnused[0].index;
    }

    console.log(`[CrownAndCaste] Still tied after unused dice, ${tiedByUnused.length} players remain - using sudden death`);

    // 4. Sudden-death roll
    const rolled = tiedByUnused.map(c => ({
      index: c.index,
      name: c.player.name,
      roll: this.rollDie() + this.rollDie() + this.rollDie()
    }));
    
    rolled.sort((a, b) => b.roll - a.roll);
    console.log(`[CrownAndCaste] Sudden death rolls: ${rolled.map(r => `${r.name}: ${r.roll}`).join(', ')}`);
    console.log(`[CrownAndCaste] Tie broken by sudden-death roll: ${rolled[0].name} wins with ${rolled[0].roll}`);
    
    return rolled[0].index;
  },

  

  // ==========================
  // 5. Betting & Pot
  // ==========================
  initiateBetting() {
    const session = State.temporary.ccSession;
    session.turnPhase = "betting";
    session.betsRevealed = false;
    
    // Reset all bets
    session.players.forEach(p => {
      if (!p.isEliminated) {
        p.bet = 0;
        p.betPlaced = false;
      }
    });
  },

  placeBet(playerIndex, amount) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];
    
    if (session.turnPhase !== "betting") {
      console.warn("[CrownAndCaste] Not in betting phase.");
      return false;
    }
    
    if (amount < 3 || amount > 10) {
      console.warn("[CrownAndCaste] Bet must be between 3g and 10g.");
      return false;
    }
    
    if (amount > player.gold) {
      console.warn("[CrownAndCaste] Insufficient gold for bet.");
      return false;
    }
    
    player.bet = amount;
    player.betPlaced = true;
    
    // Check if all players have bet
    const allBetsPlaced = session.players
      .filter(p => !p.isEliminated)
      .every(p => p.betPlaced);
      
    if (allBetsPlaced) {
      this.revealBets();
    }
    
    return true;
  },

    collectBets() {
      const session = State.temporary.ccSession;
      const minBet = 3;
      const maxBet = 10;
    
      session.pot = 0;
    
      session.players.forEach((p, i) => {
        if (p.isEliminated) {
          console.log(`[CrownAndCaste] Skipping bet for eliminated player: ${p.name}`);
          p.bet = 0;
          return;
        }
    
        // Auto-bet logic (static for now, can expand later with UI)
        const desiredBet = minBet;
    
        // Apply Fortune's Mercy if they can't afford minimum
        const actualBet = Math.min(desiredBet, p.gold);
        p.gold -= actualBet;
        p.bet = actualBet;
        session.pot += actualBet;
    
        console.log(`[CrownAndCaste] ${p.name} bet ${actualBet}g. Remaining: ${p.gold}g`);
      });
    
      console.log(`[CrownAndCaste] Total pot is now ${session.pot}g.`);
    },  

  adjustGold(playerIndex, amount) {
    const session = State.temporary.ccSession;
    const player = session.players?.[playerIndex];
  
    if (!player) {
      console.warn(`[CrownAndCaste] adjustGold failed: invalid player index ${playerIndex}`);
      return;
    }
  
    if (player.isEliminated) {
      console.log(`[CrownAndCaste] adjustGold ignored for eliminated player: ${player.name}`);
      return;
    }
  
    player.gold += amount;
    console.log(`[CrownAndCaste] ${player.name} gold adjusted by ${amount}. New total: ${player.gold}g`);
  },  

  revealBets() {
    const session = State.temporary.ccSession;
    session.betsRevealed = true;
    session.pot = 0;
    
    session.players.forEach(p => {
      if (!p.isEliminated && p.betPlaced) {
        p.gold -= p.bet;
        session.pot += p.bet;
      }
    });
    
    session.turnPhase = "rolling";
    console.log(`[CrownAndCaste] All bets revealed. Total pot: ${session.pot}g`);
    
    // ✅ Automatically roll first Crown die and first player's caste dice
    this.rollCrownDie(0);
    this.rollCasteDice(0); // Roll first player's caste dice immediately
    
    // Set current player to first player for turn management
    session.currentPlayerIndex = 0;
  },

  allPlayersActed() {
    const session = State.temporary.ccSession;
    return session.players
      .filter(p => !p.isEliminated)
      .every(p => p.hasActedThisRound || false);
  },

  processAllNPCBets() {
    const session = State.temporary.ccSession;
    
    // Process bets for all NPCs
    session.players.forEach((player, index) => {
      if (!player.isPlayer && !player.isEliminated && !player.betPlaced) {
        this.processNPCBetting(index);
      }
    });
  },
  // ==========================
  // 6. Session Management
  // ==========================

  advanceDealer() {
    const session = State.temporary.ccSession;
    const totalPlayers = session.players.length;
  
    let nextDealer = session.dealerIndex;
  
    for (let i = 0; i < totalPlayers; i++) {
      nextDealer = (nextDealer - 1 + totalPlayers) % totalPlayers;
      if (!session.players[nextDealer].isEliminated) {
        session.dealerIndex = nextDealer;
        console.log(`[CrownAndCaste] New dealer is ${session.players[nextDealer].name}`);
        return;
      }
    }
  
    console.warn("[CrownAndCaste] Could not assign a new dealer. All players eliminated?");
  },  

  refreshControlChips() {
    const session = State.temporary.ccSession;
  
    session.players.forEach(p => {
      if (!p.isEliminated) {
        p.chips = 3;
        console.log(`[CrownAndCaste] ${p.name}'s Control Chips refreshed to 3.`);
      }
    });
  },
  

  checkElimination(winnerIndex = null) {
    const session = State.temporary.ccSession;

    session.players.forEach((p, i) => {
      const isWinner = i === winnerIndex;
      if (!p.isEliminated && !isWinner && p.gold <= 0) {
        p.isEliminated = true;
        console.log(`[CrownAndCaste] ${p.name} has been eliminated (0g remaining after loss).`);
      }
    });
  },

  
  // ==========================
  // 7. NPC AI System
  // ==========================



  processNPCBetting(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const personality = this.getNPCPersonality(npc);
    
    // Calculate bet based on personality and game state
    let betAmount = 3; // minimum bet
    
    // Aggressive personalities bet higher
    if (personality.aggression > 0.7) {
      betAmount = Math.min(10, npc.gold);
    } else if (personality.aggression > 0.4) {
      betAmount = Math.min(7, npc.gold);
    } else if (personality.confidence > 0.6) {
      betAmount = Math.min(5, npc.gold);
    }
    
    // Risk assessment based on current gold
    if (npc.gold <= 10) {
      betAmount = Math.min(3, npc.gold); // Conservative when low on gold
    }
    
    // Add some randomness
    const variance = Math.random() * 0.3 - 0.15; // ±15%
    betAmount = Math.max(3, Math.min(10, Math.floor(betAmount * (1 + variance))));
    betAmount = Math.min(betAmount, npc.gold);
    
    console.log(`[CrownAndCaste] ${npc.name} bets ${betAmount}g (personality: aggression=${personality.aggression.toFixed(2)}, confidence=${personality.confidence.toFixed(2)})`);
    
    this.placeBet(playerIndex, betAmount);
  },

  processNPCTurn(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];

    if (!npc || npc.isPlayer || npc.isEliminated) {
      console.warn(`[CrownAndCaste] Invalid NPC for turn processing: ${playerIndex}`);
      return;
    }

    console.log(`[CrownAndCaste] Processing NPC turn for ${npc.name}`);

    switch (session.turnPhase) {
      case "betting":
        this.processNPCBetting(playerIndex);
        break;
      case "rolling":
        this.processNPCRolling(playerIndex);
        break;
      default:
        this.processNPCGameplay(playerIndex);
        break;
    }

    // ❌ NO auto-end turn here — that's handled by scheduleNPCAction (UI-controlled)
  },


  processNPCRolling(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // Roll dice if they haven't been rolled yet
    if (npc.casteDice.every(die => die === null)) {
      this.rollCasteDice(playerIndex);
    }
    
    // Decide on locking strategy
    this.processNPCLockingStrategy(playerIndex);
  },

  processNPCGameplay(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // First, handle dice rolling and locking
    this.processNPCDiceActions(playerIndex);
    
    // Then consider using control chips
    this.processNPCChipStrategy(playerIndex);
  },

  processNPCDiceActions(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // Roll dice if any are unrolled
    if (npc.casteDice.some(die => die === null)) {
      this.rollCasteDice(playerIndex);
    }
    
    // Apply locking strategy
    this.processNPCLockingStrategy(playerIndex);
  },

  processNPCLockingStrategy(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const personality = this.getNPCPersonality(npc);
    
    if (npc.casteDice.some(die => die === null)) {
      return; // Wait until all dice are rolled
    }
    
    // Analyze current hand
    const analysis = this.analyzeNPCHand(playerIndex);
    
    // Lock dice based on strategy
    for (let i = 0; i < 3; i++) {
      if (npc.locks[i]) continue; // Already locked
      
      const shouldLock = this.shouldNPCLockDie(playerIndex, i, analysis, personality);
      if (shouldLock) {
        this.lockDie(playerIndex, i);
      }
    }
  },

  shouldNPCLockDie(playerIndex, dieIndex, analysis, personality) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const dieValue = npc.casteDice[dieIndex];
    
    // Always lock high-value dice (7-8) unless going for specific combos
    if (dieValue >= 7 && !analysis.hasSpecialCombo) {
      return true;
    }
    
    // Lock dice that are part of pairs/triplets
    if (analysis.pairs.includes(dieValue) || analysis.triplets.includes(dieValue)) {
      return true;
    }
    
    // Conservative players lock medium-high dice (5-6)
    if (personality.risk < 0.4 && dieValue >= 5) {
      return true;
    }
    
    // Aggressive players might keep rolling for better combos
    if (personality.risk > 0.7 && session.currentRound < 3) {
      return false;
    }
    
    // Lock dice that contribute to straights
    if (analysis.straightPotential && analysis.straightDice.includes(dieIndex)) {
      return true;
    }
    
    return false;
  },

  processNPCChipStrategy(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const personality = this.getNPCPersonality(npc);
    
    if (!this.canUseControlChip(playerIndex)) {
      return;
    }
    
    // Decide whether to use a chip this turn
    const shouldUseChip = this.shouldNPCUseChip(playerIndex, personality);
    
    if (shouldUseChip) {
      const chipAction = this.chooseNPCChipAction(playerIndex, personality);
      this.executeNPCChipAction(playerIndex, chipAction);
    }
  },

  shouldNPCUseChip(playerIndex, personality) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    // Don't use chips if low on them and conservative
    if (npc.chips <= 1 && personality.risk < 0.5) {
      return false;
    }
    
    // More likely to use chips in later rounds
    const roundFactor = session.currentRound / 3;
    
    // More likely to use chips if behind in gold
    const avgGold = session.players.reduce((sum, p) => sum + p.gold, 0) / session.players.length;
    const goldFactor = npc.gold < avgGold ? 1.5 : 1.0;
    
    // Base probability based on personality
    let probability = personality.aggression * 0.3 + personality.risk * 0.2;
    probability *= roundFactor * goldFactor;
    
    return Math.random() < probability;
  },

  chooseNPCChipAction(playerIndex, personality) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const analysis = this.analyzeNPCHand(playerIndex);
    
    const actions = [];
    
    // Consider rerolling own locked dice
    const lockedDice = npc.locks.map((locked, i) => locked ? i : null).filter(i => i !== null);
    if (lockedDice.length > 0) {
      actions.push({
        type: "reroll-own",
        target: lockedDice[Math.floor(Math.random() * lockedDice.length)],
        priority: analysis.hasGoodHand ? 0.2 : 0.8
      });
    }
    
    // Consider rerolling other players' dice (sabotage)
    if (personality.aggression > 0.5) {
      const targets = this.findNPCRerollTargets(playerIndex);
      targets.forEach(target => {
        actions.push({
          type: "reroll-other",
          target: target.playerIndex,
          priority: target.threat * personality.aggression
        });
      });
    }
    
    // Consider protecting the crown
    if (!session.crownProtected && session.currentRound >= 2) {
      actions.push({
        type: "lock-crown",
        target: null,
        priority: 0.3 + (session.currentRound - 1) * 0.3
      });
    }
    
    // Choose action with highest priority
    if (actions.length === 0) return null;
    
    actions.sort((a, b) => b.priority - a.priority);
    return actions[0];
  },

  executeNPCChipAction(playerIndex, action) {
    if (!action) return;
    
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    
    console.log(`[CrownAndCaste] ${npc.name} uses Control Chip for ${action.type}`);
    
    this.useControlChip(playerIndex, action.type, action.target);
  },

  findNPCRerollTargets(playerIndex) {
    const session = State.temporary.ccSession;
    const targets = [];
    
    session.players.forEach((player, i) => {
      if (i === playerIndex || player.isEliminated || i === session.dealerIndex) {
        return;
      }
      
      const analysis = this.analyzeNPCHand(i);
      const threat = this.calculatePlayerThreat(i, analysis);
      
      if (threat > 0.5) {
        targets.push({ playerIndex: i, threat });
      }
    });
    
    return targets.sort((a, b) => b.threat - a.threat);
  },

  calculatePlayerThreat(playerIndex, analysis) {
    const session = State.temporary.ccSession;
    const player = session.players[playerIndex];
    
    let threat = 0;
    
    // High gold = higher threat
    const avgGold = session.players.reduce((sum, p) => sum + p.gold, 0) / session.players.length;
    if (player.gold > avgGold) {
      threat += 0.3;
    }
    
    // Good hand = higher threat
    if (analysis.hasGoodHand) {
      threat += 0.4;
    }
    
    // Many chips = higher threat
    if (player.chips > 2) {
      threat += 0.2;
    }
    
    // High dice values = higher threat
    const avgDieValue = player.casteDice.reduce((sum, die) => sum + (die || 0), 0) / 3;
    if (avgDieValue > 5) {
      threat += 0.3;
    }
    
    return Math.min(1.0, threat);
  },

  analyzeNPCHand(playerIndex) {
    const session = State.temporary.ccSession;
    const npc = session.players[playerIndex];
    const fullDice = npc.casteDice.concat(session.crownDice);
    
    // Count occurrences
    const counts = {};
    fullDice.forEach(die => {
      if (die !== null) {
        counts[die] = (counts[die] || 0) + 1;
      }
    });
    
    const pairs = Object.keys(counts).filter(val => counts[val] === 2).map(Number);
    const triplets = Object.keys(counts).filter(val => counts[val] >= 3).map(Number);
    
    // Check for straight potential
    const sortedDice = fullDice.filter(d => d !== null).sort((a, b) => a - b);
    const straightPotential = this.checkStraightPotential(sortedDice);
    
    // Evaluate hand strength
    const combo = this.evaluateCombos(npc);
    const hasGoodHand = combo && this.rankCombo(combo.name) > 5;
    
    return {
      pairs,
      triplets,
      straightPotential: straightPotential.potential,
      straightDice: straightPotential.dice,
      hasGoodHand,
      hasSpecialCombo: triplets.length > 0 || pairs.length > 1,
      combo
    };
  },

  checkStraightPotential(sortedDice) {
    if (sortedDice.length < 4) {
      return { potential: false, dice: [] };
    }
    
    // Look for sequences of 4+ consecutive numbers
    for (let i = 0; i <= sortedDice.length - 4; i++) {
      let consecutive = 1;
      const sequenceDice = [i];
      
      for (let j = i + 1; j < sortedDice.length; j++) {
        if (sortedDice[j] === sortedDice[j-1] + 1) {
          consecutive++;
          sequenceDice.push(j);
        } else if (sortedDice[j] !== sortedDice[j-1]) {
          break;
        }
      }
      
      if (consecutive >= 4) {
        return { potential: true, dice: sequenceDice };
      }
    }
    
    return { potential: false, dice: [] };
  },

  getNPCPersonality(npc) {
    // Extract personality from character data
    const character = State.variables.characters?.[npc.npcId];
    
    if (!character) {
      // Default personality for ghost players
      return {
        aggression: 0.5,
        risk: 0.5,
        confidence: 0.5,
        cunning: 0.5
      };
    }
    
    // Map character traits to gambling personality
    const traits = character.traits || [];
    const socialStyle = character.socialStyle || "Neutral";
    
    let aggression = 0.5;
    let risk = 0.5;
    let confidence = 0.5;
    let cunning = 0.5;
    
    // Adjust based on traits
    traits.forEach(trait => {
      switch (trait.toLowerCase()) {
        case "confident":
        case "dominant":
        case "flashy":
          confidence += 0.3;
          aggression += 0.2;
          break;
        case "cynical":
        case "cunning":
        case "evasive":
          cunning += 0.3;
          risk -= 0.1;
          break;
        case "stoic":
        case "guarded":
          risk -= 0.2;
          aggression -= 0.1;
          break;
        case "flirty":
        case "charming":
          confidence += 0.2;
          cunning += 0.1;
          break;
        case "crude":
        case "feisty":
          aggression += 0.3;
          risk += 0.2;
          break;
        case "submissive":
        case "introverted":
          aggression -= 0.3;
          confidence -= 0.2;
          break;
        case "traumatized":
        case "detached":
          risk -= 0.3;
          aggression -= 0.2;
          break;
      }
    });
    
    // Adjust based on social style
    switch (socialStyle.toLowerCase()) {
      case "regal":
      case "commanding":
        confidence += 0.2;
        aggression += 0.1;
        break;
      case "seductive":
      case "charming":
        cunning += 0.2;
        confidence += 0.1;
        break;
      case "feisty":
        aggression += 0.3;
        risk += 0.2;
        break;
      case "humble":
      case "reserved":
        aggression -= 0.2;
        confidence -= 0.1;
        break;
      case "unhinged":
        risk += 0.4;
        aggression += 0.2;
        break;
      case "grizzled":
      case "stoic":
        risk -= 0.1;
        cunning += 0.1;
        break;
    }
    
    // Clamp values between 0 and 1
    return {
      aggression: Math.max(0, Math.min(1, aggression)),
      risk: Math.max(0, Math.min(1, risk)),
      confidence: Math.max(0, Math.min(1, confidence)),
      cunning: Math.max(0, Math.min(1, cunning))
    };
  },

  // ==========================
  // 8. Helpers
  // ==========================

    rollDie(playerIndex = null) {
      const buffer = new Uint8Array(1);
      window.crypto.getRandomValues(buffer);
      const raw = buffer[0] / 256;
      const baseValue = Math.floor(raw * 8) + 1;
    
      const session = State.temporary.ccSession;
      let value = baseValue;
    
      // 🎲 Apply bias if playerFavor is active
      if (playerIndex === 0 && session?.playerFavor && session.playerFavor > 1.0) {
        const bias = session.playerFavor;
        const biasedRaw = Math.pow(raw, 1 / bias);
        const biasedValue = Math.floor(biasedRaw * 8) + 1;
        value = Math.min(8, Math.max(1, biasedValue));
    
        console.log(
          `[CrownAndCaste] Rolled (playerFavor=${bias.toFixed(2)}): ` +
          `raw=${raw.toFixed(3)} → base=${baseValue}, biasedRaw=${biasedRaw.toFixed(3)} → biased=${biasedValue}, final=${value}`
        );
      } else {
        console.log(`[CrownAndCaste] Rolled die: raw=${raw.toFixed(3)} → ${value}`);
      }
    
      return value;
    },
  
 

  // ✨ Pseudo-rolling animation for dice (flavor feature)
  async rollDieWithAnimation(elementId, finalValue = null) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.warn(`[CrownAndCaste] Cannot animate die: element ${elementId} not found`);
      return finalValue || this.rollDie();
    }

    const actualValue = finalValue || this.rollDie();
    const animationDuration = 1500 + Math.random() * 1000; // 1.5-2.5 seconds
    const startTime = Date.now();

    // Add animation class for visual effects
    element.classList.add('rolling');

    const animate = () => {
      const elapsed = Date.now() - startTime;
      const progress = elapsed / animationDuration;

      if (progress < 1) {
        // Show random values during animation
        const randomValue = Math.floor(Math.random() * 8) + 1;
        element.textContent = randomValue;
        requestAnimationFrame(animate);
      } else {
        // Animation complete - show final value
        element.textContent = actualValue;
        element.classList.remove('rolling');
        console.log(`[CrownAndCaste] Die animation complete: ${actualValue}`);
      }
    };

    animate();
    
    // Return a promise that resolves when animation completes
    return new Promise(resolve => {
      setTimeout(() => resolve(actualValue), animationDuration);
    });
  },

  logSessionState() {
    console.log("[CrownAndCaste] Current session state:");
    console.log(JSON.stringify(State.temporary.ccSession, null, 2));
  },

  getNextPlayerClockwise(currentIndex) {
    const session = State.temporary.ccSession;
    const totalPlayers = session.players.length;
    
    for (let i = 1; i <= totalPlayers; i++) {
      const nextIndex = (currentIndex + i) % totalPlayers;
      if (!session.players[nextIndex].isEliminated) {
        return nextIndex;
      }
    }
    return -1; // No valid players found
  },
  
  

};



  // ==========================
  // 8. Combos Logic
  // ==========================
setup.CrownAndCasteCombos = {
RANKS: [                        
  "High Dice",           
  "Single Pair",         
  "Dual Pairs",          
  "Triplet",             
  "Tri-Crown",           
  "Line of Five Unpaired",
  "Jester's Court",      
  "Courtesan's Quad",    
  "Line of Five Paired", 
  "Split Line",          
  "Octline",             
  "Courtly Quad",        
  "Royal Spread",        
  "Fivefold Glory",      
  "Imperial Crown"       
  ],

  rankIndex(name) {
    return this.RANKS.indexOf(name);
  },

  evaluate(diceArray) {
    const counts = {};
    for (const die of diceArray) {
      counts[die] = (counts[die] || 0) + 1;
    }

    const values = diceArray.slice().sort((a, b) => a - b);
    const unique = [...new Set(values)];
    const countValues = Object.values(counts).sort((a, b) => b - a);

    const hasNOfKind = n => Object.values(counts).includes(n);
    const getAllOfCount = n => Object.entries(counts).filter(([_, c]) => c === n).map(([v]) => parseInt(v));
    const isStraight = (len = 6) => {
      for (let i = 0; i <= values.length - len; i++) {
        let streak = 1;
        for (let j = i; j < i + len - 1; j++) {
          if (values[j + 1] !== values[j] + 1) break;
          streak++;
        }
        if (streak === len) return true;
      }
      return false;
    };

    const countPairs = () => getAllOfCount(2).length;
    const countTriplets = () => getAllOfCount(3).length;

    const combo = (name) => ({
      name,
      usedDice: [...Array(6).keys()], // placeholder
      rank: this.rankIndex(name)
    });

    if (countValues[0] === 6) return combo("Imperial Crown");
    if (countValues[0] === 5) return combo("Fivefold Glory");
    if (countTriplets() === 2) return combo("Royal Spread");
    if (countValues[0] === 4 && countValues[1] === 2) return combo("Courtly Quad");
    if (isStraight(6)) return combo("Octline");
    if (hasSplitLine(values)) return combo("Split Line");
    if (countValues[0] === 4 && countValues[1] <= 1) return combo("Courtesan's Quad");
    if (countPairs() === 3) return combo("Jester's Court");

    if (hasFiveInARow(values)) {
      const fiveInRow = getFiveInRowValues(values);
      const sixthDie = values.find(v => !fiveInRow.includes(v));
      if (sixthDie !== undefined && fiveInRow.includes(sixthDie)) {
        return combo("Line of Five Paired");
      } else {
        return combo("Line of Five Unpaired");
      }
    }

    if (countValues.includes(3) && countValues.includes(2)) return combo("Tri-Crown");
    if (countValues[0] === 3) return combo("Triplet");
    if (countPairs() === 2) return combo("Dual Pairs");
    if (countPairs() === 1) return combo("Single Pair");

    return combo("High Dice");
  }
};

function hasSplitLine(values) {
  const sorted = values.slice().sort((a, b) => a - b);

  // Try every combination of two 3-length straights that do not reuse dice values
  for (let i = 0; i < sorted.length; i++) {
    for (let j = i + 1; j < sorted.length; j++) {
      for (let k = j + 1; k < sorted.length; k++) {
        const first = [sorted[i], sorted[j], sorted[k]];
        if (!isConsecutive(first)) continue;

        // Remove the dice used in the first straight (by index, not just value)
        const remaining = [...values];
        for (const val of first) {
          const index = remaining.indexOf(val);
          if (index !== -1) remaining.splice(index, 1);
        }

        // Try to find a second non-overlapping 3-straight in the remaining dice
        remaining.sort((a, b) => a - b);
        for (let a = 0; a < remaining.length; a++) {
          for (let b = a + 1; b < remaining.length; b++) {
            for (let c = b + 1; c < remaining.length; c++) {
              const second = [remaining[a], remaining[b], remaining[c]];
              if (isConsecutive(second)) {
                return true;
              }
            }
          }
        }
      }
    }
  }

  return false;
}

function isConsecutive(arr) {
  return arr[1] === arr[0] + 1 && arr[2] === arr[1] + 1;
}


function hasFiveInARow(values) {
  const unique = [...new Set(values)].sort((a, b) => a - b);
  for (let i = 0; i <= unique.length - 5; i++) {
    let isStraight = true;
    for (let j = 0; j < 4; j++) {
      if (unique[i + j + 1] !== unique[i + j] + 1) {
        isStraight = false;
        break;
      }
    }
    if (isStraight) return true;
  }
  return false;
}

function getFiveInRowValues(values) {
  const unique = [...new Set(values)].sort((a, b) => a - b);
  for (let i = 0; i <= unique.length - 5; i++) {
    const segment = unique.slice(i, i + 5);
    let isStraight = true;
    for (let j = 0; j < 4; j++) {
      if (segment[j + 1] !== segment[j] + 1) {
        isStraight = false;
        break;
      }
    }
    if (isStraight) return segment;
  }
  return [];
}
/* twine-user-script #32: "CrownAndCasteUI.js" */
setup.CrownAndCasteUI = {
  chipMode: false,
  
  renderMinigame() {
    window.openOverlay("crown-and-caste-page");

    setTimeout(() => {
      this.initializeEventListeners();
      this.initializeOrientationDetection();
      this.highlightCurrentPlayer();
      this.renderCrownDice();
      this.renderPot();
      this.renderPlayerPanels();
      this.updateGameStatus();
      this.updateInteractionStates();

      if (State.variables.DEBUG || setup.DEBUG) {
        console.log("[CrownAndCasteUI] Game UI initialized.");
      }
    }, 100);
  },

  closeMinigame() {
    const overlay = document.getElementById("crown-and-caste-page");
    if (overlay) {
      overlay.classList.add("overlay-hidden");
    }

    if (State.variables.DEBUG || setup.DEBUG) {
      console.log("[CrownAndCasteUI] Minigame overlay hidden.");
    }
  },

  initializeEventListeners() {
    // Dice click handlers
    document.querySelectorAll('.clickable-die').forEach(die => {
      die.addEventListener('click', (e) => this.handleDieClick(e));
    });

    // Chip click handlers
    document.querySelectorAll('.clickable-chips').forEach(chips => {
      chips.addEventListener('click', (e) => this.handleChipClick(e));
    });

    // Individual Crown Die click handlers (for rerolling via chip)
    document.querySelectorAll('.clickable-crown-die').forEach(el => {
      el.addEventListener('click', (e) => this.handleCrownDieClick(e));
    });

    // ✅ Backup: click on crown circle triggers protect crown (unless a die was clicked)
    const crownCircle = document.getElementById('center-circle');
    if (crownCircle) {
      crownCircle.addEventListener('click', (e) => {
        // Skip if the click originated inside a clickable die
        if (e.target.closest('.clickable-crown-die')) return;

        this.handleCrownClick(e);
      });
    }

    // Betting button handlers
    document.querySelectorAll('.bet-btn').forEach(btn => {
      btn.addEventListener('click', (e) => this.handleBetClick(e));
    });

    // End Turn button
    const endTurn = document.getElementById('end-turn-btn');
    if (endTurn) {
      endTurn.addEventListener('click', () => {
        setup.CrownAndCaste.endTurn();
        setup.CrownAndCasteUI.updateGameStatus();
        setup.CrownAndCasteUI.updateInteractionStates();
      });
    }

    // Next Game button handler
    const nextGameBtn = document.getElementById('next-game-btn');
    if (nextGameBtn) {
      nextGameBtn.addEventListener('click', () => {
        setup.CrownAndCasteUI.hideGameResult(); // ⬅ ensure result panel hides
        setup.CrownAndCaste.startNextGame();     // ⬅ resets state and rolls
        setup.CrownAndCasteUI.updateGameStatus();
        setup.CrownAndCasteUI.updateInteractionStates();
        setup.CrownAndCasteUI.renderPlayerPanels();
        setup.CrownAndCasteUI.renderCrownDice();
        setup.CrownAndCasteUI.renderPot();
      });
    }

    const endGameBtn = document.getElementById("end-game-btn");
    if (endGameBtn) {
      endGameBtn.addEventListener("click", () => {
        try {
          closeOverlay();
        } catch (e) {
          console.warn("closeOverlay() not available:", e);
        }

        const session = State.temporary;
        const game = session.ccSession;

        const player = game?.players?.find(p => p.isPlayer);
        const playerWon = player && player.gold > 0;
        const exitPassage = playerWon ? session.ccWinPassage : session.ccLosePassage;

        // 💰 Distribute winnings if the player won
        if (playerWon && typeof State.variables.inventory_player?.gold_coin === "number") {
          State.variables.inventory_player.gold_coin += game.pot;
          console.log(`[CrownAndCaste] Player awarded ${game.pot}g from the pot.`);
        }

        setup.CrownAndCasteUI.cleanupTable();

        if (exitPassage) {
          Engine.play(exitPassage);
        } else {
          console.warn("[CrownAndCaste] No valid exit passage found, falling back to default.");
          Engine.play("ReturnToFair");
        }
      });
    }
  },


  cleanupTable() {
    const frame = document.getElementById("crown-caste-frame");
    if (frame) frame.remove();

    // Reset session state
    delete State.temporary.ccSession;
    delete State.temporary.ccBuyIn;
    delete State.temporary.ccStakes;
    delete State.temporary.ccHouseRules;

    console.log("[CrownAndCasteUI] Crown & Caste session ended.");
  },


  handleDieClick(event) {
    const die = event.target;
    const playerIndex = parseInt(die.dataset.player);
    const dieIndex = parseInt(die.dataset.die);
    const session = State.temporary.ccSession;
    const currentPlayer = session.players[session.currentPlayerIndex];

    // Don't allow dice interaction during betting phase
    if (session.turnPhase === "betting") {
      this.showFeedback("Cannot interact with dice during betting phase!");
      return;
    }

    // Only allow interaction if it's the player's turn
    if (!currentPlayer.isPlayer) {
      this.showFeedback("Not your turn!");
      return;
    }

    if (this.chipMode) {
      // Control chip mode - reroll locked dice
      this.handleChipDieReroll(playerIndex, dieIndex);
    } else if (playerIndex === 0) {
      // Normal mode - player's own dice
      this.handlePlayerDieAction(dieIndex);
    } else {
      this.showFeedback("You can only interact with your own dice!");
    }
  },

  handlePlayerDieAction(dieIndex) {
    const session = State.temporary.ccSession;
    const player = session.players[0]; // Player is always index 0

    if (player.casteDice[dieIndex] === null) {
      // Roll unlocked die
      setup.CrownAndCaste.rollCasteDice(0);
      this.showFeedback("Dice rolled!");
    } else {
      // Toggle lock
      setup.CrownAndCaste.lockDie(0, dieIndex);
      const isLocked = player.locks[dieIndex];
      this.showFeedback(isLocked ? "Die locked!" : "Die unlocked!");
    }
    
    this.updateInteractionStates();
  },

  handleChipDieReroll(playerIndex, dieIndex) {
    const session = State.temporary.ccSession;
    const targetPlayer = session.players[playerIndex];

    if (!targetPlayer.locks[dieIndex]) {
      this.showFeedback("Can only reroll locked dice!");
      return;
    }

    if (playerIndex === 0) {
      // Reroll own locked die
      setup.CrownAndCaste.useControlChip(0, "reroll-own", dieIndex);
      this.showFeedback("Rerolled your locked die!");
    } else {
      // Reroll specific locked die of another player
      setup.CrownAndCaste.useControlChip(0, "reroll-other", {
        targetPlayerIndex: playerIndex,
        dieIndex: dieIndex
      });
      this.showFeedback(`Rerolled ${targetPlayer.name}'s locked die!`);
    }

    this.chipMode = false;
    this.updateInteractionStates();
  },

  handleChipClick(event) {
    const chipDisplay = event.target.closest('.chip-display');
    const playerIndex = parseInt(chipDisplay.closest('.player-zone').dataset.playerIndex);
    const session = State.temporary.ccSession;

    // Don't allow chip usage during betting phase
    if (session.turnPhase === "betting") {
      this.showFeedback("Cannot use chips during betting phase!");
      return;
    }

    // Only allow player to use their own chips
    if (playerIndex !== 0) {
      this.showFeedback("You can only use your own Control Chips!");
      return;
    }

    if (!setup.CrownAndCaste.canUseControlChip(0)) {
      this.showFeedback("Cannot use Control Chip right now!");
      return;
    }

    // Toggle chip mode
    this.chipMode = !this.chipMode;
    this.updateInteractionStates();
    
    if (this.chipMode) {
      this.showFeedback("Control Chip activated! Click dice to reroll or crown to protect.");
    } else {
      this.showFeedback("Control Chip mode deactivated.");
    }
  },

  handleCrownDieClick(event) {
    const session = State.temporary.ccSession;

    const dieEl = event.currentTarget; // ✅ Always use currentTarget
    const dieIndex = parseInt(dieEl.dataset.index, 10);

    if (isNaN(dieIndex) || dieIndex < 0 || dieIndex > 2) {
      console.warn("[CrownAndCasteUI] Invalid crown die index clicked.");
      return;
    }

    if (!this.chipMode) {
      this.showFeedback("Activate Control Chip mode first!");
      return;
    }

    setup.CrownAndCaste.useControlChip(0, "reroll-crown", dieIndex);
    this.showFeedback(`Rerolled Crown Die ${dieIndex + 1}`);
    this.chipMode = false;
    this.updateInteractionStates();
  },

  handleCrownClick(event) {
    const session = State.temporary.ccSession;

    // Don't allow crown interaction during betting phase
    if (session.turnPhase === "betting") {
      this.showFeedback("Cannot interact with crown during betting phase!");
      return;
    }

    if (!this.chipMode) {
      this.showFeedback("Activate Control Chip mode first!");
      return;
    }

    // Use chip to protect crown
    setup.CrownAndCaste.useControlChip(0, "lock-crown");
    this.showFeedback("Crown protected!");
    this.chipMode = false;
    this.updateInteractionStates();
  },

  handleBetClick(event) {
    const amount = parseInt(event.target.dataset.amount);
    const success = setup.CrownAndCaste.placeBet(0, amount);
    
    if (success) {
      this.showFeedback(`Bet placed: ${amount}g`);
      
      // Process all NPC bets automatically after a short delay
      setTimeout(() => {
        setup.CrownAndCaste.processAllNPCBets();
        this.updateGameStatus();
        this.renderPlayerPanels();
        this.renderPot();
        this.updateInteractionStates();
      }, 500);
    } else {
      this.showFeedback("Cannot place that bet!");
    }
  },

  updateInteractionStates() {
    const session = State.temporary.ccSession;
    const currentPlayer = session.players[session.currentPlayerIndex];
    const isPlayerTurn = currentPlayer.isPlayer;
    const isBettingPhase = session.turnPhase === "betting";

    // Disable specific game interactions during betting, but NOT the betting panel
    const gameElements = document.querySelectorAll('.clickable-die, .chip-button, .crown-die');
    gameElements.forEach(el => {
      el.classList.toggle('disabled-during-betting', isBettingPhase);
    });

    // Update chip mode visual state
    document.querySelectorAll('.chip-display').forEach(display => {
      display.classList.toggle('active', this.chipMode);
    });

    // Update crown circle state
    const crownCircle = document.getElementById('center-circle');
    if (crownCircle) {
      crownCircle.classList.toggle('chip-mode', this.chipMode);
    }

    // Update dice interaction states
    document.querySelectorAll('.clickable-die').forEach(die => {
      const playerIndex = parseInt(die.dataset.player);
      const dieIndex = parseInt(die.dataset.die);
      const player = session.players[playerIndex];

      die.classList.remove('can-roll', 'can-lock', 'chip-target');

      // 🛡 Fix: Guard against undefined players
      if (!player) return;

      if (isBettingPhase || !isPlayerTurn) return;

      if (this.chipMode) {
        if (player.locks[dieIndex]) {
          die.classList.add('chip-target');
        }
      } else if (playerIndex === 0) {
        if (player.casteDice[dieIndex] === null) {
          die.classList.add('can-roll');
        } else {
          die.classList.add('can-lock');
        }
      }
    });


    // Show betting panel only during betting phase and player's turn
    const bettingPanel = document.getElementById('betting-panel');
    if (bettingPanel) {
      const showBetting = isBettingPhase && isPlayerTurn;
      bettingPanel.style.display = showBetting ? 'block' : 'none';
    }

    // Show or hide End Turn button
    const endTurnPanel = document.getElementById('player-actions');
    if (endTurnPanel) {
      const showEndTurn = isPlayerTurn && !isBettingPhase && !session.gameComplete;
      endTurnPanel.style.display = showEndTurn ? 'block' : 'none';
    }

    // Show or hide Next Game button
    const nextGamePanel = document.getElementById('next-game-panel');
    if (nextGamePanel) {
      const showNextGame = session.gameComplete;
      nextGamePanel.style.display = showNextGame ? 'block' : 'none';
    }

    // Update crown protected indicator
    const protectedIndicator = document.getElementById('crown-protected');
    if (protectedIndicator) {
      protectedIndicator.style.display = session.crownProtected ? 'block' : 'none';
    }
  },


  updateGameStatus() {
    const session = State.temporary.ccSession;
    const currentPlayer = session.players[session.currentPlayerIndex];

    const turnEl = document.getElementById('current-turn');
    const roundEl = document.getElementById('current-round');
    const phaseEl = document.getElementById('game-phase');

    if (turnEl) {
      turnEl.textContent = currentPlayer.isPlayer ? "Your Turn" : `${currentPlayer.name}'s Turn`;
    }

    if (roundEl) {
      roundEl.textContent = `Round ${session.currentRound}`;
    }

    if (phaseEl) {
      const phaseText = session.turnPhase === "betting" ? "Betting Phase" : 
                       session.turnPhase === "rolling" ? "Rolling Phase" : 
                       "Game Phase";
      phaseEl.textContent = phaseText;
    }

    // Trigger NPC actions if it's an NPC's turn
    if (!currentPlayer.isPlayer && !currentPlayer.isEliminated) {
      this.scheduleNPCAction(session.currentPlayerIndex);
    }
  },

  scheduleNPCAction(playerIndex) {
    // Add a delay to make NPC actions feel more natural
    setTimeout(() => {
      if (setup.CrownAndCaste.processNPCTurn) {
        setup.CrownAndCaste.processNPCTurn(playerIndex);
        
        // Update UI after NPC action
        setTimeout(() => {
          this.renderPlayerPanels();
          this.renderCrownDice();
          this.renderPot();
          this.highlightCurrentPlayer();
          this.updateInteractionStates();
        }, 500);
      }
    }, 1000 + Math.random() * 1500); // 1-2.5 second delay for realism
  },

  showFeedback(message, duration = 2000, type = 'info') {
    const feedback = document.getElementById('action-feedback');
    if (feedback) {
      feedback.textContent = message;
      feedback.className = `show feedback-${type}`;
      
      setTimeout(() => {
        feedback.classList.remove('show');
        feedback.className = '';
      }, duration);
    }
  },

  showCurrentHandStrength() {
    const session = State.temporary.ccSession;
    const player = session.players[0]; // Player is always index 0
    
    if (!player || player.casteDice.some(d => d === null)) {
      return; // Don't show if dice aren't rolled yet
    }

    const combo = setup.CrownAndCaste.evaluateCombos(player);
    const comboDetails = this.formatComboDetails(combo);
    const strengthMessage = comboDetails ? 
      `Current hand: ${combo.name} (${comboDetails})` : 
      `Current hand: ${combo.name}`;
    
    this.showFeedback(strengthMessage, 3000, 'info');
  },

  announceRoundStart(roundNumber) {
    const roundMessages = {
      1: "Round 1: Roll your Caste Dice!",
      2: "Round 2: Crown Die 2 revealed!",
      3: "Round 3: Final Crown Die revealed!"
    };
    
    this.showFeedback(roundMessages[roundNumber] || `Round ${roundNumber} begins!`, 2500, 'round');
  },

  announcePhaseChange(phase) {
    const phaseMessages = {
      "betting": "Place your bets!",
      "rolling": "Rolling phase begins!",
      "final": "Final round - all dice locked!"
    };
    
    if (phaseMessages[phase]) {
      this.showFeedback(phaseMessages[phase], 2000, 'phase');
    }
  },

  highlightCurrentPlayer() {
    const session = State.temporary.ccSession;
    const currentId = this.getPositionId(session.currentPlayerIndex);
    const panels = document.querySelectorAll(".player-zone");

    panels.forEach(panel => {
      panel.classList.remove("active-player", "current-turn");
      if (panel.id === currentId) {
        panel.classList.add("active-player", "current-turn");
      }
    });
  },

  getPositionId(index) {
    switch (index) {
      case 0: return "bottom-center"; // Player
      case 1: return "middle-left";   // NPC 1
      case 2: return "top-center";    // NPC 2
      case 3: return "middle-right";  // NPC 3
      default: return `unknown-${index}`;
    }
  },

  renderCrownDice() {
    const session = State.temporary.ccSession;
    session.crownDice.forEach((val, i) => {
      const el = document.getElementById(`crown-die-${i + 1}`);
      if (el) {
        el.textContent = val ?? "?";
        el.classList.toggle("locked", session.crownLocks[i]);
      }
    });
  },

  renderPot() {
    const session = State.temporary.ccSession;
    const potDisplay = document.getElementById("crown-pot");
    if (potDisplay) {
      potDisplay.textContent = `Pot: ${session.pot}g`;
    }
  },

  renderPlayerPanels() {
    const session = State.temporary.ccSession;

    session.players.forEach((p, i) => {
      const containerId = this.getPositionId(i);
      const el = document.getElementById(containerId);
      if (!el) return;

      const goldEl = el.querySelector(".gold-amount");
      const chipEl = el.querySelector(".chip-count");
      const nameEl = el.querySelector(".player-name");

      if (goldEl) goldEl.textContent = p.gold;
      if (chipEl) chipEl.textContent = p.chips;
      if (nameEl) {
        const baseName = p.name || `Player ${i + 1}`;
        const isDealer = i === session.dealerIndex;

        nameEl.innerHTML = isDealer
          ? `<i class="lucide crown-icon" data-lucide="crown"></i> ${baseName}`
          : baseName;
      }

      p.casteDice.forEach((val, j) => {
        const dieEl = el.querySelector(`#${containerId}-die-${j + 1}`);
        if (dieEl) {
          dieEl.textContent = val ?? "?";
          dieEl.classList.toggle("locked", p.locks[j]);
        }
      });
    });
    if (window.lucide) lucide.createIcons();
  },

  updateChipDisplay(playerIndex, chipCount, goldCount) {
    const containerId = this.getPositionId(playerIndex);
    const el = document.getElementById(containerId);
    if (el) {
      const chipEl = el.querySelector(".chip-count");
      const goldEl = el.querySelector(".gold-amount");
      if (chipEl) chipEl.textContent = chipCount;
      if (goldEl) goldEl.textContent = goldCount;
    }
    this.updateInteractionStates();
  },

  updateCrownDisplay(index, value) {
    const el = document.getElementById(`crown-die-${index + 1}`);
    if (el) el.textContent = value;
  },

  updateCrownLockDisplay(index, isLocked) {
    const el = document.getElementById(`crown-die-${index + 1}`);
    if (el) {
      el.classList.toggle("locked", isLocked);
    }
  },

  updateLockDisplay(playerIndex, dieIndex, isLocked) {
    const containerId = this.getPositionId(playerIndex);
    const el = document.getElementById(`${containerId}-die-${dieIndex + 1}`);
    if (el) {
      el.classList.toggle("locked", isLocked);
    }
    this.updateInteractionStates();
  },

  updateDiceDisplay(playerIndex) {
    this.renderPlayerPanels();
    this.updateInteractionStates();
  },

  showGameResult(winnerIndex) {
    const session = State.temporary.ccSession;
    const winner = session.players[winnerIndex];

    // Create detailed result message with combo information
    const winnerCombo = winner.combo;
    let resultMessage = `🎉 ${winner.name} wins with ${winnerCombo.name}!`;
    
    // Add combo details if available
    if (winnerCombo.comboValues && winnerCombo.comboValues.length > 0) {
      const comboDetails = this.formatComboDetails(winnerCombo);
      resultMessage += `\n${comboDetails}`;
    }
    
    resultMessage += `\nTakes the pot: ${session.pot}g`;

    // Show all players' final hands for comparison
    console.log("[CrownAndCaste] Final Results:");
    session.players.forEach((p, i) => {
      const combo = p.combo;
      const diceStr = p.casteDice.concat(session.crownDice).join(', ');
      console.log(`${p.name}: ${combo.name} (${diceStr}) - Rank ${p.scoreRank}`);
    });

    // Display the result prominently
    this.showGameResultModal(winner, resultMessage);

    const nextPanel = document.getElementById("next-game-panel");
    const endPanel = document.getElementById("end-game-panel");
    const player = session.players.find(p => p.isPlayer);

    const otherActive = session.players.filter(p => !p.isPlayer && !p.isEliminated && p.gold > 0).length;
    const playerHasGold = player && player.gold > 0;

    const shouldEnd =
      !playerHasGold || // You're broke
      otherActive === 0; // You're alone

    if (shouldEnd && endPanel) {
      endPanel.style.display = "block";
    } else if (!shouldEnd && nextPanel) {
      nextPanel.style.display = "block";
    }

    // 💡 Freeze interaction visuals
    setup.CrownAndCasteUI.disableBoard();
  },

  formatComboDetails(combo) {
    const name = combo.name;
    const values = combo.comboValues || [];
    
    switch (name) {
      case "Single Pair":
        return `Pair of ${values[0]}s`;
      case "Dual Pairs":
        return `Pairs of ${values[0]}s and ${values[1]}s`;
      case "Triplet":
        return `Three ${values[0]}s`;
      case "Tri-Crown":
        return `Three ${values[0]}s with pair of ${values[1]}s`;
      case "Courtesan's Quad":
      case "Courtly Quad":
        return `Four ${values[0]}s` + (values[1] ? ` with pair of ${values[1]}s` : '');
      case "Jester's Court":
        return `Three pairs: ${values.join(', ')}`;
      case "Royal Spread":
        return `Two triplets: ${values[0]}s and ${values[1]}s`;
      case "Fivefold Glory":
        return `Five ${values[0]}s`;
      case "Imperial Crown":
        return `Six ${values[0]}s`;
      case "Octline":
      case "Split Line":
      case "Line of Five Paired":
      case "Line of Five Unpaired":
        return `Straight to ${values[0]}`;
      default:
        return values.length > 0 ? `High: ${values[0]}` : '';
    }
  },

  showGameResultModal(winner, message) {
    // Create or update result modal
    let modal = document.getElementById('game-result-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'game-result-modal';
      modal.className = 'game-result-modal';
      document.getElementById('crown-caste-frame').appendChild(modal);
    }

    modal.innerHTML = `
      <div class="result-content">
        <div class="result-header">Game Complete!</div>
        <div class="result-message">${message.replace(/\n/g, '<br>')}</div>
        <button class="result-close-btn" onclick="this.parentElement.parentElement.style.display='none'">
          Continue
        </button>
      </div>
    `;

    modal.style.display = 'flex';

    // Auto-hide after 5 seconds
    setTimeout(() => {
      if (modal && modal.style.display !== 'none') {
        modal.style.display = 'none';
      }
    }, 5000);
  },


  initializeOrientationDetection() {
    // Only run on mobile devices
    if (!this.isMobileDevice()) return;

    this.checkOrientation();
    
    // Listen for orientation changes
    window.addEventListener('orientationchange', () => {
      setTimeout(() => this.checkOrientation(), 100);
    });
    
    // Also listen for resize events as a fallback
    window.addEventListener('resize', () => {
      setTimeout(() => this.checkOrientation(), 100);
    });
  },

  isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
           (window.innerWidth <= 768 && window.innerHeight <= 1024);
  },

  checkOrientation() {
    if (!this.isMobileDevice()) return;

    const orientationWarning = document.getElementById('orientation-warning');
    if (!orientationWarning) return;

    const isLandscape = window.innerWidth > window.innerHeight;
    
    if (isLandscape) {
      // Show warning in landscape mode
      orientationWarning.style.display = 'flex';
      if (State.variables.DEBUG || setup.DEBUG) {
        console.log("[CrownAndCasteUI] Landscape orientation detected, showing rotation warning");
      }
    } else {
      // Hide warning in portrait mode
      orientationWarning.style.display = 'none';
      if (State.variables.DEBUG || setup.DEBUG) {
        console.log("[CrownAndCasteUI] Portrait orientation detected, hiding rotation warning");
      }
    }
  },

  hideGameResult() {
    const panel = document.getElementById("next-game-panel");
    if (panel) {
      panel.style.display = "none";
    }
  },

  disableBoard() {
    const frame = document.getElementById("crown-caste-frame");
    if (frame) {
      frame.classList.add("board-disabled");
    }
  }

};
/* twine-user-script #33: "01_speechMacro.js" */
Macro.add('speech', {
	tags: null,
	handler: function () {
		const id = this.args[0];
		const text = this.payload[0].contents.trim();
		const char = State.variables.characters?.[id] || {};
		const displayName = (char.known && char.name) ? char.name : char.defaultName || "???";
		const avatar = char.avatar || "images/default.png";
		const color = char.color || "white";
		const bgColor = char.bgColor || "rgba(0, 0, 0, 0.8)";

		const output = `
			<div class="speech" style="color:${color}; background-color:${bgColor};">
				<span class="avatar" style="background-image: url('${avatar}');"></span>
				<div class="speech-content">
					<b>${displayName}</b>
					<hr>
					<p>${text}</p>
				</div>
			</div>
		`;

		$(this.output).wiki(output.trim());
	}
});
/* twine-user-script #34: "02_fogtextMacro.js" */
Macro.add("fogtext", {
	tags: null,
	handler: function () {
		const difficulty = parseInt(this.args[0]);
		const skill = this.args[1].toLowerCase();
		const content = this.payload[0].contents.trim();
		const fogId = "fogtext-" + Math.random().toString(36).substr(2, 9);

		if (isNaN(difficulty) || !skill) {
			return this.error("Invalid parameters: fogtext [difficulty] [skill]");
		}

		const skillValue =
			(State.variables.skills && State.variables.skills[skill]?.value) ??
			(State.variables.attributes && State.variables.attributes[skill]) ?? 0;

		const roll = random(1, 20);
		const total = roll + skillValue;
		const passed = total >= difficulty;

		let html = `<div id="${fogId}" class="fog-container">`;

		if (typeof State.temporary.fogResults === "undefined") {
			State.temporary.fogResults = {};
		}

		const alreadyRolled = State.temporary.fogResults[fogId];

		if (alreadyRolled) {
			if (alreadyRolled.passed) {
				html += `<div class="fogtext" title="Passed ${skill} ${alreadyRolled.roll}+${alreadyRolled.skill} ≥ ${difficulty}">${content}</div>`;
			} else {
				html += `<div class="fog-fail">You rolled a ${alreadyRolled.roll} + ${alreadyRolled.skill} = ${alreadyRolled.total} for ${skill}. You needed ${difficulty}.<br><em>You cannot make out the details.</em></div>`;
			}
		} else {
			html += `<div class="fog-unchecked">???</div>`;
			html += `<button class="fog-roll-button" onclick="
				(function() {
					const roll = random(1, 20);
					const skillValue = (State.variables.skills && State.variables.skills['${skill}']?.value) ??
					                   (State.variables.attributes && State.variables.attributes['${skill}']) ?? 0;
					const total = roll + skillValue;
					const passed = total >= ${difficulty};
					State.temporary.fogResults['${fogId}'] = { roll: roll, skill: skillValue, total: total, passed: passed };
					Engine.play(Engine.active.passages[Engine.active.passages.length - 1].title);
				})()
			">Roll for ${skill.charAt(0).toUpperCase() + skill.slice(1)}</button>`;
		}

		html += `</div>`;
		$(this.output).wiki(html);
	}
});
/* twine-user-script #35: "adda.js" */
setup.adda_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "This place... it's yours?", target: "Adda_ThisPlaceIsYours" },
		{ label: "Your hosts really seem to care about you.", target: "Adda_HostsCare" },
		{ label: "You seem... different from the others.", target: "Adda_Different" },
		{ label: "How'd you end up starting this place?", target: "Adda_OriginStory", variable: "addaMentionedTakeover", hide: true },
		{ label: "You don't seem like someone people say no to.", target: "Adda_CommandPresence" },
		{ label: "Could you help me get a drink?", target: "Adda_OrderDrink" },
		{ label: "Can I get to know you better?", target: "Adda_StartMinigame", reuse: 0 },
		{ label: "Would you ever step away for something a little more private?", target: "Adda_GoPrivate", aff: ["adda", 10], trust: ["adda", 10], hide: true, logic: "or"},
        { label: "We can talk more later.", target: "GoodbyeAddaZero", reuse: 1 }
        
	]);
};

setup.adda_Conversation_Options_NoctailOrigin = function () {
	setup.smartChoices([
		{ label: "What was the brothel like before you took over?", target: "Adda_Origin_WhatWasItLike" },
		{ label: "Who was the previous owner?", target: "Adda_Origin_PreviousOwner" },
		{ label: "How did you get control of the place?", target: "Adda_Origin_HowSheTookIt" },
		{ label: "What changed under your leadership?", target: "Adda_Origin_ChangesMade" },
		{ label: "Any enemies left over from those days?", target: "Adda_Origin_LocalPolitics" },
		{ label: "Let's talk about something else.", target: "Adda_Origin_Exit", reuse: 1 }
	]);
};
/* twine-user-script #36: "allura.js" */
setup.allura_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{label: "Were you watching me?", target: "Allura_Watching" },
		{label: "Don't take this the wrong way, but you feel out of place here a little.",target: "Allura_OutOfPlace"},
		{ label: "Do you actually enjoy doing this?", target: "Allura_Enjoyment" },
		{ label: "Can I do anything to make your night?", 	target: "Allura_WhatCanIDo"},
		{label: "Would you mind ordering a drink for me?", target: "Allura_DrinkOrder"},
		{ label: "Would you want to go somewhere more private?", target: "Allura_GoSomewherePrivate", trust: ["allura", 4], aff: ["allura", 4], logic: "and", reuse: 1, hide: false},
		{ label: "We can talk more later.", target: "Allura_ReturnToParlor", reuse: 1, notVariable: "Read_Phase0_allura_Allura_GoSomewherePrivate", hide: true}
	]);
};

setup.allura_Conversation_Options_Phase1 = function () {
	setup.smartChoices([
		{
		label: "Your room is beautiful. Do they all look like this?",
		target: "AlluraRoom",
		notVariable: "Read_Phase1_allura_Allura_GetComfortable",
		hide: true
		},
		{
		label: "So… what do we do now?",
		target: "Allura_WhatDoNow",
		notVariable: "Read_Phase1_allura_Allura_GetComfortable",
		hide: true
		},
		{ label: "Do you mind if I get comfortable with you?", target: "Allura_GetComfortable" },
		{ label: "I want to get to know you better.", target: "AlluraOpenConvoMinigameOne", variable: "Read_Phase1_allura_Allura_GetComfortable", hide: false },
		{ label: "Can I ask you a little bit about your past?", target: "BackstoryStart", variable: "Read_Phase1_allura_Allura_GetComfortable", hide: false },
		{
			label: "Can I kiss you?",
			target: "KissAllura",
			variable: "Read_Phase1_allura_Allura_GetComfortable",
			notVariable: "Read_Phase1_allura_JustLay",
			aff: ["allura", 9],
			trust: ["allura", 10],
			hide: true
		},
		{
			label: "If it's alright… I'd like to just lay here with you.",
			target: "JustLay",
			variable: "Read_Phase1_allura_Allura_GetComfortable",
			notVariable: "Read_Phase1_allura_KissAllura",
			hide: true
		}
		  
		
	]);
};

setup.allura_Conversation_Options_alluraBackstory = function () {
	setup.smartChoices([
		{ label: "Where did you grow up?", target: "WhereAlluraGrewUp" },
		{ label: "Do you know much about your parents?", target: "Parentage" },
		{ label: "If you could go anywhere in the world, where would it be?", target: "TravelWish" },
		{ label: "What's the worst or strangest client you've ever had?", target: "StrangeClient" },
		{ label: "Let's talk about something else.", target: "BackstoryExit", reuse: 1 }
	]);
};

/* twine-user-script #37: "bert.js" */
setup.bert_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "What's on the menu?", target: "Bert_OpenShop", reuse: 1 },
		{ label: "What kind of drink would you make for me?", target: "Bert_CustomDrink" },
		{ label: "Why so serious?",	target: "Bert_SeriousResponse" },
		{label: "I want to get to know you better.", target: "Bert_DenyMinigame" },
		{ label: "Nevermind.", target: "Bert_ReturnToParlor", reuse: 1 }
	]);
};
/* twine-user-script #38: "brakka.js" */
setup.brakka_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "How are you doing tonight?", target: "Brakka_Howareyoutonight" },
        { label: "Why 'Silks'?", target: "Brakka_WhySilks", compare: {value: "$calledSilks", op: ">=", against: 3 }, hide: true },
		{ label: "You look like you’ve seen some fights.", target: "Brakka_FightComment" },
		{ label: "I just wanted to say hi.", target: "Brakka_HelloAttempt" },
		{ label: "Enjoy your meal.", target: "Brakka_ExitwithTournyInvite", notVariable: "Read_Phase0_brakka_Brakka_ExitwithTournyInvite", hide: true },
        { label: "Enjoy your meal.", target: "Brakka_ExitNormally", variable: "Read_Phase0_brakka_Brakka_ExitwithTournyInvite", reuse: 1, hide: true}
	]);
};
/* twine-user-script #39: "darian.js" */
/**
 * Darian Conversation Setup Functions
 * Phase-based choice logic matching the .tw widget definitions.
 */

/* Adds options for Phase 0: initial conversation */
setup.darian_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{
			label: "How long have you worked here?",
			target: "Darian_HowLongHere"
		},
		{
			label: "Do you actually enjoy this job?",
			target: "Darian_DoYouLikeJob"
		},
		{
			label: "That bracelet you're wearing... where did it come from?",
			target: "Darian_Bracelet"
		},
		{
			label: "Any chance I could convince you to pour me a drink?",
			target: "Darian_GetDrink"
		},
		{
			label: "You hum a lot. Were you a musician once?",
			target: "Darian_Humming"
		},		
		{
			label: "I'd like to get to know you better.",
			target: "Darian_StartMinigame",
			reuse: 0
		},
		{
			label: "Do you think we could go somewhere more private?",
			target: "Darian_GoPrivate",
			trust: ["darian", 6],
			aff: ["darian", 3],
			logic: "and"
		},
		{
			label: "Nevermind.",
			target: "Darian_ReturnToParlor",
			notVariable: "Read_Phase0_darian_Darian_GoPrivate",
			reuse: 1,
			hide: true
		}
	]);
};

setup.darian_Conversation_Options_Phase1 = function () {
	setup.smartChoices([
		{
			label: "I like your room. Are they all like this?",
			target: "Darian_RoomComment"
		},
		{
			label: "So... what do we do now?",
			target: "Darian_WhatNow"
		},
		{
			label: "So how has your night been?",
			target: "Darian_HowsYourNight"
		},
		{
			label: "Do you mind if I ask you some more personal questions?",
			target: "Darian_AskDeeper",
			reuse: 1
		},
		{
			label: "Do you mind if I kiss you?",
			target: "Darian_AskToKiss",
			trust: ["darian", 9],
			aff: ["darian", 6],
			logic: "and",
			notVariable: "Read_Phase1_darian_Darian_MusicRequest"
		},
		{
			label: "Would it be too much trouble to pass the time with some music?",
			target: "Darian_MusicRequest",
			trust: ["darian", 14],
			aff: ["darian", 9],
			logic: "and",
			notVariable: "Read_Phase1_darian_Darian_AskToKiss"
		}
	]);
};

setup.darian_Conversation_Options_DarianDialogueDuet = function () {
	setup.smartChoices([
		{
			label: "Who gave you that bracelet?",
			target: "DarianDuet_Bracelet"
		},
		{
			label: "What was it like to travel around performing?",
			target: "DarianDuet_Performing"
		},
		{
			label: "Why did you start working at the Noctail?",
			target: "DarianDuet_WhyNoctail"
		},
		{
			label: "Did you ever fall in love on stage?",
			target: "DarianDuet_StageLove"
		},
		{
			label: "Do you ever miss the life you had before all this?",
			target: "DarianDuet_MissOldLife"
		},
		{
			label: "What's the most beautiful thing you've ever seen?",
			target: "DarianDuet_MostBeautiful"
		},
		{
			label: "Let's talk about something else.",
			target: "ReturnToDarianPhase1",
			reuse: 1
		}
	]);
};

/* twine-user-script #40: "eristan.js" */
/* twine-user-script #41: "harroc.js" */
 setup.harroc_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "Could I get a drink, please?", target: "Harroc_OrderDrink" },
		{ label: "[Open Shop *placeholder*] Do you have a food menu, or is it just drinks?", target: "Harroc_OpenShop" },
		{ label: "Has it always been this quiet in here?", target: "Harroc_RecentEvents" },
		{ label: "Heard any interesting rumors lately?", target: "Harroc_Rumors" },
		{ label: "I'll let you get back to it.", target: "Harroc_Phase0_Goodbye", reuse: 1 }
	]);
};
/* twine-user-script #42: "kallot.js" */
/* twine-user-script #43: "marie.js" */
setup.marie_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "How are you doing?", target: "Marie_Howareyoudoing" },
		{ label: "Looks like you've had a rough night.", target: "Marie_ToughNight" },
		{ label: "I'm a good listener.", target: "Marie_SilentTreatment" },
		{ label: "I'm sorry, I'll go.", target: "Marie_ImSorryIllGo", variable: "marieCanApologize", hide: true }
	]);
};

setup.marie_Conversation_Options_Phase1 = function () {
	setup.smartChoices([
		{ label: "Why did you choose this kind of work?", target: "Marie_WhyThisWork" },
		{ label: "Are you friends with any of the other hosts?", target: "Marie_HostsOrFriends" },
		{ label: "Do you like it at the Noctail?", target: "DoYouLikeItHere" },
		{ label: "Have you ever lived anywhere else?", target: "Marie_LivedAnywhereElse" },
		{ label: "Are you looking forward to the fair tomorrow?", target: "Marie_TheFairTomorrow" },
		{ label: "I'd like to get to know you better.", target: "Marie_StartMinigameOne", reuse: 0 },
		{ label: "Do you think we could go somewhere more private?", target: "Marie_GoUpstairs", aff: ["marie", 8], trust: ["marie", 8], logic: "or", hide: false}, //The option in question.
		{ label: "We can talk more later.", target: "Marie_Phase1Goodbye", notVariable: "Read_Phase1_marie_Marie_GoUpstairs", hide: true},
		

	]);
};

setup.marie_Conversation_Options_Phase2 = function () {
	setup.smartChoices([
		{
			label: "I really like your room. Do they all look like this?",
			target: "Marie_RoomComment"
		},
		{
			label: "What do you want to do now?",
			target: "Marie_WhatNow"
		},
		{
			label: "Do you want to talk about what happened outside?",
			target: "Marie_TalkAboutIt_Success",
			compare: {
			  value: "characters.marie.trust",
			  op: ">=",
			  against: 10
			},
			hide: true
		},  
		{
			label: "Do you want to talk about what happened outside?",
			target: "Marie_TalkAboutIt_Fail",
			compare: {
				value: "characters.marie.trust",
				op: "<",
				against: 10
			},
			hide: true
		},  
		{
			label: "Can I touch you?",
			target: "Marie_AskToTouch",
			aff: ["marie", 15],
			notVariable: "Read_Phase2_marie_Marie_LayAndTalk",
			hide: true,
		},
		{
			label: "Want to just lay here and talk for a bit?",
			target: "Marie_LayAndTalk",
			notVariable: "Read_Phase2_marie_Marie_AskToTouch",
			hide: true			
		}
	]);
};


setup.marie_Conversation_Options_TheFight = function () {
	setup.smartChoices([
		{
			label: "How long have you and Kallot been... whatever you are?",
			target: "Marie_Fight_HowLong"
		},
		{
			label: "Do you think he meant to hurt you?",
			target: "Marie_Fight_Intent"
		},
		{
			label: "Has he ever scared you before tonight?",
			target: "Marie_Fight_Pattern"
		},
		{
			label: "Do you think you'll talk to him again after this?",
			target: "Marie_Fight_Forgiveness"
		},
		{
			label: "I helped him, you know...",
			target: "Jaylie_Helped_Kallot",
			variable: "helpedkallot",
			variable: "Read_TheFight_marie_Marie_Fight_Forgiveness",
			hide: true
			
		},
		{
			label: "What were you like before all this? Before the Noctail?",
			target: "Marie_Fight_Backstory"
		},
		{
			label: "We can talk about something else.",
			target: "Marie_Fight_Exit",
			reuse: 1
		}
	]);
};
/* twine-user-script #44: "redmarrow.js" */
setup.redmarrow_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "You always dress this sharp?", target: "Redmarrow_ArmorFlattery" },
		{ label: "What do you do for work?", target: "Redmarrow_JobPrompt" },
		{ label: "Redmarrow? That your real name?", target: "Redmarrow_NameOrigin", variable: "Read_Phase0_redmarrow_Redmarrow_JobPrompt", hide: true },
		{ label: "Can anyone take work from the Guild?", target: "Redmarrow_BountyQuest", variable: "Read_Phase0_redmarrow_Redmarrow_JobPrompt", hide: true },
		{ label: "About that job...", target: "Redmarrow_TheJob", variable: "readyForBoutyQuestion", hide: true, reuse:1 },
		{ label: "Enjoy your night.", target: "Redmarrow_Exit", reuse: 1 }
	]);
};

 

setup.redmarrow_Conversation_Options_TheFirstBounty = function () {
	setup.smartChoices([
		{
			label: "[Pay 20 :coin:] I would like to sign up for the guild.",
			target: "Redmarrow_BountySignUp",
			item: ["gold_coin", 20],
			hide: false
		},
        {label: "Can you tell who the target is again?", target: "Redmarrow_WhoIsItAgain", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1},
		{label: "How should I find him?", target: "HowFindTelVaras", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1},
		{label: "How much is this job paying again?", target: "TelVarasHowMuchPay", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1},
		{label: "Is there anything else I should know?", target: "TelVarasAnythingElse", variable: "Read_TheFirstBounty_redmarrow_Redmarrow_BountySignUp", hide: true, reuse: 1 },
       	{ label: "Let's talk about something else.", target: "Redmarrow_ReturnBountytoPhase0", reuse: 1}
	]);

	// 👇 Inject Lucide icons for any :coin: placeholders
	setTimeout(() => {
	// Replace any span or text node that includes :coin: with actual icon injection
	$("#convoChoices p.dialogue-choice").each(function () {
		const $this = $(this);
		const html = $this.html();
		if (html.includes(":coin:")) {
			$this.html(html.replace(/:coin:/g, '<i data-lucide="coins"></i>'));
		}
	});
	if (window.lucide) lucide.createIcons();
}, 0);

};
/* twine-user-script #45: "tesska.js" */
// =======================
// Tesska Phase 0 Trigger Function
// =======================
setup.tesska_Conversation_Options_Phase0 = function () {
	setup.smartChoices([
		{ label: "Can I get a drink?", target: "Tesska_GetDrink" },
		{ label: "It's kind of quiet in here tonight.", target: "Tesska_QuietNight" },
		{ label: "Do you always work nights?", target: "Tesska_WorkNights" },
		{ label: "How long have you and Harroc been running this place?", target: "Tesska_RunningThePlace", logic: "and", variable: "tesskaAskedWorkNights", hide: true },
		{ label: "Do you get many unusual customers?", target: "Tesska_UnusualCustomers" },

		// Exit options with corrected logic
		{ 
			label: "Thanks, I think I'll just sit quietly for a bit.", 
			target: "Tesska_Exit", 
			hideIf: { variable: "Read_Phase0_tesska_Tesska_GetDrink" }, 
			reuse: 1 
		},
		{ 
			label: "Thanks, I think I'm going to nurse this drink for a while.", 
			target: "Tesska_ExitDrink",  
			variable: "Read_Phase0_tesska_Tesska_GetDrink",
			reuse: 1, 
			hide: true
		},
	]);
};
/* twine-user-script #46: "02_DeclarativeDialogueSystem.js" */
// ===============================
// Declarative Dialogue Detection System
// ===============================

$(document).on(':passagerender', function (ev) {
	setTimeout(function () {
		const passageElement = document.querySelector('#passages > .passage');
		const backdrop = document.getElementById('text-backdrop');

		if (!passageElement || !backdrop) {
			console.warn("[DeclarativeSystem] Required elements missing.");
			return;
		}

		const passageHTML = passageElement.innerHTML;
		const isDialogueMode = passageHTML.includes('StartDialogueLayout');

		// 💣 Always wipe previous layout clean
		backdrop.innerHTML = "";
		backdrop.classList.remove("in-dialogue");

		// ☢️ Just in case — double-tap ghosts
		["convoChoices", "convoBox", "convoLayoutContainer", "convoBoxPanel", "convoChoicesPanel"].forEach(id => {
			const el = document.getElementById(id);
			if (el) {
				console.warn(`[DeclarativeSystem] Removing lingering #${id}`);
				el.remove();
			}
		});

		if (isDialogueMode) {
			console.log("[DeclarativeSystem] Rebuilding as DIALOGUE layout.");
			setup.startDialogueLayout();
		} else {
			console.log("[DeclarativeSystem] Normal prose passage — layout handled by injector.");
			// No action needed — prose will be injected by 04_PassageInjector.js
		}
	}, 20);
});

// ===============================
// Dialogue Layout Builder
// ===============================

setup.startDialogueLayout = function () {
	const backdrop = document.getElementById('text-backdrop');

	if (!backdrop) return;

	backdrop.classList.add('in-dialogue');

	backdrop.innerHTML = `
		<div id="convoLayoutContainer">
			<div id="convoChoicesPanel">
				<div id="convoChoices"></div>
			</div>
			<div id="convoBoxPanel">
				<div id="convoBox"></div>
			</div>
		</div>
	`;
};
/* twine-user-script #47: "SaveAPI.js" */
window.SaveAPI = window.SaveAPI || {};

SaveAPI.nativeSaveMenu = function () {
	try {
		if (typeof UI !== "undefined" && typeof UI.save === "function") {
			UI.save();
		} else {
			console.warn("UI.save() not available. Trying SugarCube fallback...");
			if (typeof Dialog !== "undefined" && typeof Dialog.open === "function") {
				Dialog.open("saves");
			} else {
				alert("Save menu still not available. Something deeper is wrong.");
			}
		}
	} catch (err) {
		console.error("Save menu call failed:", err);
		alert("Could not open save menu.");
	}
};
/* twine-user-script #48: "999_main.js" */
console.log("🔥 999_main.js loaded!");
// Basic setup
if (typeof setup === 'undefined') {
	setup = {};
}

// Debug logging
window.debugLog = function (...args) {
	if (State.variables.DEBUG) {
		console.log("📢 DEBUG:", ...args);
	}
};

// TEMP boot check
$(document).on(':passagestart', function () {
	console.log("🛠 StoryInit triggered.");
});
/* twine-user-script #49: "SexScene_Acts.js" */
setup.SexualActsDB = {
	// ===============================
	// 🔸 ORAL ACTIONS
	// ===============================
	
	// Player Giving Oral
	Oral_Penis_G_Tease: {
		label: "Tease Their Cock With Your Mouth",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 8 },
		preferenceTags: ["Oral_R", "Penis"],
		inclinationTags: ["tease", "service"],
		togglable: true
	},

	Oral_Penis_G_Suck: {
		label: "Suck Their Cock",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 15 },
		preferenceTags: ["Oral_R", "Penis"],
		inclinationTags: ["submission", "service"],
		togglable: true
	},

	Oral_Penis_G_Deepthroat: {
		label: "Deepthroat Them",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_penis",
		stageLevel: 2,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: { oral: 3 },
		baseExcitement: { subject: 3, object: 20 },
		preferenceTags: ["Oral_R", "Penis", "Throatplay", "SubPlay"],
		inclinationTags: ["submission", "service", "roughplay"],
		togglable: true
	},

	Oral_Vagina_G_Tease: {
		label: "Tease Their Pussy With Your Tongue",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_vagina",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 10 },
		preferenceTags: ["Oral_R", "Vagina"],
		inclinationTags: ["tease", "service"],
		togglable: true
	},

	Oral_Vagina_G: {
		label: "Eat Them Out",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_vagina",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 16 },
		preferenceTags: ["Oral_R", "Vagina"],
		inclinationTags: ["service", "sensual"],
		togglable: true
	},

	Oral_Anal_G: {
		label: "Rim Their Ass",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_anal",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["anus"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 12 },
		preferenceTags: ["OralAnal_R"],
		inclinationTags: ["service", "submission"],
		togglable: true
	},

	FaceSit_G: {
		label: "Sit on Their Face",
		category: "Oral",
		actionType: "oral",
		stageGroup: "facesit",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["vagina"],
		objectParts: ["mouth"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 12, object: 8 },
		preferenceTags: ["Oral_R"],
		inclinationTags: ["domination", "exhibitionism"],
		togglable: true
	},

	// ===============================
	// 🔸 PENETRATION ACTIONS
	// ===============================

	Anal_G_Tease: {
		label: "Tease Their Asshole With Your Cock",
		category: "Anal",
		actionType: "anal",
		stageGroup: "anal_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["anus"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 6, object: 10 },
		preferenceTags: ["Anal_P", "Dominate"],
		inclinationTags: ["penetration", "dominance"],
		togglable: true
	},

	Anal_G_Penetrate: {
		label: "Penetrate Their Ass",
		category: "Anal",
		actionType: "anal",
		stageGroup: "anal_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["anus"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 12, object: 18 },
		preferenceTags: ["Anal_P", "Rough"],
		inclinationTags: ["penetration", "dominance"],
		togglable: true
	},

	Anal_G_Pound: {
		label: "Pound Their Ass",
		category: "Anal",
		actionType: "anal",
		stageGroup: "anal_penis",
		stageLevel: 2,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["anus"],
		canTakeVirginity: true,
		skillsRequired: { penetration: 2 },
		baseExcitement: { subject: 18, object: 25 },
		preferenceTags: ["Anal_P", "Rough"],
		inclinationTags: ["penetration", "dominance", "roughplay"],
		togglable: true
	},

	Vaginal_G_Tease: {
		label: "Tease Their Pussy With Your Cock",
		category: "Vaginal",
		actionType: "vaginal",
		stageGroup: "vaginal_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["vagina"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 8, object: 12 },
		preferenceTags: ["Vaginal_P"],
		inclinationTags: ["penetration", "tease"],
		togglable: true
	},

	Vaginal_G_Penetrate: {
		label: "Penetrate Their Pussy",
		category: "Vaginal",
		actionType: "vaginal",
		stageGroup: "vaginal_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["vagina"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 15, object: 20 },
		preferenceTags: ["Vaginal_P"],
		inclinationTags: ["penetration", "vanilla"],
		togglable: true
	},

	Vaginal_G_Pound: {
		label: "Pound Their Pussy",
		category: "Vaginal",
		actionType: "vaginal",
		stageGroup: "vaginal_penis",
		stageLevel: 2,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["vagina"],
		canTakeVirginity: true,
		skillsRequired: { penetration: 2 },
		baseExcitement: { subject: 22, object: 28 },
		preferenceTags: ["Vaginal_P", "Rough"],
		inclinationTags: ["penetration", "roughplay"],
		togglable: true
	},

	// ===============================
	// 🔸 MANUAL STIMULATION
	// ===============================

	Handjob_Penis_G_Tease: {
		label: "Tease Their Cock With Your Hand",
		category: "Manual",
		actionType: "handjob",
		stageGroup: "handjob_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 6 },
		preferenceTags: ["Penis", "Handplay"],
		inclinationTags: ["tease", "service"],
		togglable: true
	},

	Handjob_Penis_G: {
		label: "Stroke Their Cock",
		category: "Manual",
		actionType: "handjob",
		stageGroup: "handjob_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 12 },
		preferenceTags: ["Penis", "Handplay"],
		inclinationTags: ["service", "vanilla"],
		togglable: true
	},

	Handjob_Clit_G_Tease: {
		label: "Tease Their Clit With Your Fingers",
		category: "Manual",
		actionType: "clitoral",
		stageGroup: "handjob_clit",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["clitoris"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 10 },
		preferenceTags: ["Clit_Rub", "Tease"],
		inclinationTags: ["gentle", "foreplay"],
		togglable: true
	},

	Handjob_Clit_G: {
		label: "Rub Their Clit",
		category: "Manual",
		actionType: "clitoral",
		stageGroup: "handjob_clit",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["clitoris"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 14 },
		preferenceTags: ["Clit_Rub", "Stimulation"],
		inclinationTags: ["service", "direct"],
		togglable: true
	},

	Fingering_Vagina_G_Tease: {
		label: "Tease Their Pussy With Your Fingers",
		category: "Manual",
		actionType: "fingering",
		stageGroup: "fingering_vagina",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["vagina"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 8 },
		preferenceTags: ["FingeringVag_R"],
		inclinationTags: ["tease", "service"],
		togglable: true
	},

	Fingering_Vagina_G: {
		label: "Finger Their Pussy",
		category: "Manual",
		actionType: "fingering",
		stageGroup: "fingering_vagina",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["vagina"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 14 },
		preferenceTags: ["FingeringVag_R"],
		inclinationTags: ["service", "sensual"],
		togglable: true
	},

	Fingering_Anal_G: {
		label: "Finger Their Ass",
		category: "Manual",
		actionType: "fingering",
		stageGroup: "fingering_anal",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["anus"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 10 },
		preferenceTags: ["FingeringAnal_R"],
		inclinationTags: ["service", "submission"],
		togglable: true
	},

	BreastPlay_G: {
		label: "Touch Their Breasts",
		category: "Manual",
		actionType: "breast",
		stageGroup: "breastplay",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["breasts"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 6 },
		preferenceTags: ["BreastPlay_R"],
		inclinationTags: ["sensual", "vanilla"],
		togglable: true
	},

	NipplePlay_G: {
		label: "Play with Their Nipples",
		category: "Manual",
		actionType: "nipple",
		stageGroup: "nippleplay",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["breasts"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 8 },
		preferenceTags: ["NipplePlay_R"],
		inclinationTags: ["sensual", "tease"],
		togglable: true
	},

	// ===============================
	// 🔸 BREAST ACTIONS
	// ===============================

	Boobjob_G_Tease: {
		label: "Tease Their Cock With Your Breasts",
		category: "Breast",
		actionType: "boobjob",
		stageGroup: "boobjob_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["breasts"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 9 },
		preferenceTags: ["BreastPlay_R", "Oral_G"],
		inclinationTags: ["tease", "visual"],
		togglable: true
	},

	Boobjob_G: {
		label: "Give Them a Boobjob",
		category: "Breast",
		actionType: "boobjob",
		stageGroup: "boobjob_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["breasts"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 16 },
		preferenceTags: ["BreastPlay_R", "Stimulation"],
		inclinationTags: ["visual", "submission"],
		togglable: true
	},

	// ===============================
	// 🔸 FEET ACTIONS
	// ===============================

	Footjob_Penis_G_Tease: {
		label: "Tease Their Cock With Your Feet",
		category: "Feet",
		actionType: "footjob",
		stageGroup: "footjob_penis",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["feet"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 8 },
		preferenceTags: ["Feet", "Penis"],
		inclinationTags: ["fetish", "tease"],
		togglable: true
	},

	Footjob_Penis_G: {
		label: "Give Them a Footjob",
		category: "Feet",
		actionType: "footjob",
		stageGroup: "footjob_penis",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["feet"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 12 },
		preferenceTags: ["Feet", "Penis", "Stimulation"],
		inclinationTags: ["fetish", "playful"],
		togglable: true
	},

	Footjob_Vagina_G_Tease: {
		label: "Tease Their Pussy With Your Foot",
		category: "Feet",
		actionType: "footjob",
		stageGroup: "footjob_vagina",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["feet"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 9 },
		preferenceTags: ["Feet", "Pussy"],
		inclinationTags: ["fetish", "control"],
		togglable: true
	},

	Footjob_Vagina_G: {
		label: "Rub Their Pussy With Your Foot",
		category: "Feet",
		actionType: "footjob",
		stageGroup: "footjob_vagina",
		stageLevel: 1,
		giver: "player",
		receiver: "npc",
		subjectParts: ["feet"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 13 },
		preferenceTags: ["Feet", "Pussy", "Stimulation"],
		inclinationTags: ["fetish", "playful"],
		togglable: true
	},

	// ===============================
	// 🔸 POWER / DOM-SUB ACTIONS
	// ===============================

	Dominate: {
		label: "Take Control",
		category: "Power",
		actionType: "dominance",
		stageGroup: "power_dynamic",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["body"],
		objectParts: ["mind"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 5, object: 8 },
		preferenceTags: ["Submit"],
		inclinationTags: ["domination", "control"],
		togglable: true
	},

	Submit: {
		label: "Submit",
		category: "Power",
		actionType: "submission",
		stageGroup: "power_dynamic",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["body"],
		objectParts: ["mind"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 3, object: 10 },
		preferenceTags: ["Dominate"],
		inclinationTags: ["submission", "service"],
		togglable: true
	},

	Spank_G: {
		label: "Spank Them",
		category: "Power",
		actionType: "impact",
		stageGroup: "spanking",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["anus"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 3, object: 8 },
		preferenceTags: ["Spank_R"],
		inclinationTags: ["domination", "roughplay"],
		togglable: true
	},

	HairPulling_G: {
		label: "Pull Their Hair",
		category: "Power",
		actionType: "control",
		stageGroup: "hairpulling",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["head"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 6 },
		preferenceTags: ["HairPulling_R"],
		inclinationTags: ["domination", "roughplay"],
		togglable: true
	},

	Choke_G: {
		label: "Choke Them",
		category: "Power",
		actionType: "breath",
		stageGroup: "choking",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["neck"],
		canTakeVirginity: false,
		skillsRequired: { domination: 2 },
		baseExcitement: { subject: 4, object: 10 },
		preferenceTags: ["Choke_R"],
		inclinationTags: ["domination", "roughplay"],
		togglable: true
	},

	// ===============================
	// 🔸 BONDAGE & TOYS
	// ===============================

	Bondage_G: {
		label: "Bind Them",
		category: "Bondage",
		actionType: "restraint",
		stageGroup: "bondage",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["wrists"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 3, object: 8 },
		preferenceTags: ["Bondage_R"],
		inclinationTags: ["bondage", "domination"],
		togglable: false
	},

	Gag_G: {
		label: "Gag Them",
		category: "Bondage",
		actionType: "silence",
		stageGroup: "gagging",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["mouth"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 6 },
		preferenceTags: ["Gag_R"],
		inclinationTags: ["bondage", "domination"],
		togglable: true
	},

	Blindfold_G: {
		label: "Blindfold Them",
		category: "Bondage",
		actionType: "sensory",
		stageGroup: "blindfolding",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["eyes"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 8 },
		preferenceTags: ["Blindfold_R"],
		inclinationTags: ["bondage", "sensory"],
		togglable: true
	},

	Toys_Use: {
		label: "Use a Toy on Them",
		category: "Toys",
		actionType: "toy",
		stageGroup: "toys",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 12 },
		preferenceTags: ["Toys_Receive"],
		inclinationTags: ["sensual", "service"],
		togglable: true
	},

	WaxPlay_G: {
		label: "Drip Wax on Them",
		category: "Toys",
		actionType: "sensation",
		stageGroup: "waxplay",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["body"],
		canTakeVirginity: false,
		skillsRequired: { domination: 1 },
		baseExcitement: { subject: 3, object: 8 },
		preferenceTags: ["WaxPlay", "SensoryPlay", "SubPlay"],
		inclinationTags: ["sensory", "domination"],
		togglable: false
	},

	// ===============================
	// 🔸 VERBAL ACTIONS
	// ===============================

	DirtyTalk_G: {
		label: "Talk Dirty",
		category: "Verbal",
		actionType: "verbal",
		stageGroup: "dirtytalk",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["ears"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 2, object: 6 },
		preferenceTags: ["DirtyTalk_R"],
		inclinationTags: ["verbal", "domination"],
		togglable: false
	},

	Praise_G: {
		label: "Praise Them",
		category: "Verbal",
		actionType: "verbal",
		stageGroup: "praise",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["ears"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 8 },
		preferenceTags: ["Praise"],
		inclinationTags: ["praise", "vanilla"],
		togglable: false
	},

	Degrade_G: {
		label: "Degrade Them",
		category: "Verbal",
		actionType: "verbal",
		stageGroup: "degradation",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["ears"],
		canTakeVirginity: false,
		skillsRequired: { domination: 1 },
		baseExcitement: { subject: 3, object: 6 },
		preferenceTags: ["Degrade_R"],
		inclinationTags: ["verbal", "domination", "roughplay"],
		togglable: false
	},

	// ===============================
	// 🔸 EMOTIONAL ACTIONS
	// ===============================

	Kissing: {
		label: "Kiss Them",
		category: "Emotional",
		actionType: "intimate",
		stageGroup: "kissing",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["mouth"],
		objectParts: ["mouth"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 3, object: 5 },
		preferenceTags: ["Kissing"],
		inclinationTags: ["vanilla", "sensual"],
		togglable: false
	},

	Cuddling: {
		label: "Cuddle Them",
		category: "Emotional",
		actionType: "intimate",
		stageGroup: "cuddling",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["body"],
		objectParts: ["body"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 1, object: 3 },
		preferenceTags: ["Cuddling"],
		inclinationTags: ["vanilla", "sensual"],
		togglable: false
	},

	// ===============================
	// 🔸 SCENE CONTROL
	// ===============================

	Edge_G: {
		label: "Edge Them",
		category: "SceneControl",
		actionType: "control",
		stageGroup: "edging",
		stageLevel: 0,
		giver: "player",
		receiver: "npc",
		subjectParts: ["hand"],
		objectParts: ["genitals"],
		canTakeVirginity: false,
		skillsRequired: { control: 2 },
		baseExcitement: { subject: 2, object: 15 },
		preferenceTags: ["Edging_R"],
		inclinationTags: ["domination", "control"],
		togglable: false
	},

	// ===============================
	// 🔸 ORGASM ACTIONS
	// ===============================

	Player_Cum_Anal_Inside: {
		label: "Cum Deep In Their Ass",
		category: "Orgasm",
		actionType: "orgasm",
		stageLevel: 0,
		isCumming: true,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["anus"],
		orgasmTags: ["anal_internal", "penetration"],
		preferenceTags: ["Anal_P", "Orgasm_Inside"],
		inclinationTags: ["dominance", "release"],
		togglable: false
	},

	Player_Cum_Vaginal_Inside: {
		label: "Cum Deep In Their Pussy",
		category: "Orgasm",
		actionType: "orgasm",
		stageLevel: 0,
		isCumming: true,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["vagina"],
		orgasmTags: ["vaginal_internal", "penetration"],
		preferenceTags: ["Vaginal_P", "Orgasm_Inside"],
		inclinationTags: ["intimacy", "release"],
		togglable: false
	},

	Player_Cum_On_Face: {
		label: "Cum On Their Face",
		category: "Orgasm",
		actionType: "orgasm",
		stageLevel: 0,
		isCumming: true,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["face"],
		orgasmTags: ["facial", "external"],
		preferenceTags: ["Oral_G", "Face_Cum"],
		inclinationTags: ["control", "messy"],
		togglable: false
	},

	Player_Cum_On_Body: {
		label: "Cum On Their Body",
		category: "Orgasm",
		actionType: "orgasm",
		stageLevel: 0,
		isCumming: true,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["body"],
		orgasmTags: ["external", "visual"],
		preferenceTags: ["Visual_Cum"],
		inclinationTags: ["control", "visual"],
		togglable: false
	},

	Player_Cum_In_Mouth: {
		label: "Cum In Their Mouth",
		category: "Orgasm",
		actionType: "orgasm",
		stageLevel: 0,
		isCumming: true,
		giver: "player",
		receiver: "npc",
		subjectParts: ["penis"],
		objectParts: ["mouth"],
		orgasmTags: ["oral_internal", "control"],
		preferenceTags: ["Oral_R", "Creampie"],
		inclinationTags: ["dominance", "release"],
		togglable: false
	},

	// ===============================
	// 🔸 NPC ACTIONS
	// ===============================

	// NPC Oral Actions
	Oral_Penis_NPC_Tease: {
		label: "Tease Your Cock With Their Mouth",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_penis_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["mouth"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 5, object: 10 },
		preferenceTags: ["Oral_G", "Penis"],
		inclinationTags: ["tease", "service"],
		togglable: false
	},

	Oral_Penis_NPC_Suck: {
		label: "Suck Your Cock",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_penis_npc",
		stageLevel: 1,
		giver: "npc",
		receiver: "player",
		subjectParts: ["mouth"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 8, object: 15 },
		preferenceTags: ["Oral_G", "Penis"],
		inclinationTags: ["submission", "service"],
		togglable: false
	},

	Oral_Vagina_NPC: {
		label: "Eat You Out",
		category: "Oral",
		actionType: "oral",
		stageGroup: "oral_vagina_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["mouth"],
		objectParts: ["vagina"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 6, object: 16 },
		preferenceTags: ["Oral_G", "Vagina"],
		inclinationTags: ["service", "sensual"],
		togglable: false
	},

	FaceSit_NPC: {
		label: "Sit On Your Face",
		category: "Oral",
		actionType: "oral",
		stageGroup: "facesit_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["vagina"],
		objectParts: ["mouth"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 12, object: 8 },
		preferenceTags: ["Oral_G"],
		inclinationTags: ["domination", "exhibitionism"],
		togglable: false
	},

	// NPC Manual Actions
	Handjob_Penis_NPC_Tease: {
		label: "Stroke Your Cock Teasingly",
		giver: "npc",
		receiver: "player",
		subjectParts: ["hand"],
		objectParts: ["penis"],
		stageGroup: "Handjob_NPC",
		stageLevel: 0,
		baseExcitement: { subject: 5, object: 10 },
		inclinationTags: ["tease"],
		togglable: false
	},

	Handjob_Penis_NPC: {
		label: "Stroke Your Cock",
		category: "Manual",
		actionType: "handjob",
		stageGroup: "handjob_penis_npc",
		stageLevel: 1,
		giver: "npc",
		receiver: "player",
		subjectParts: ["hand"],
		objectParts: ["penis"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 6, object: 12 },
		preferenceTags: ["Penis", "Handplay"],
		inclinationTags: ["service", "vanilla"],
		togglable: false
	},

	Fingering_Vagina_NPC: {
		label: "Finger Your Pussy",
		category: "Manual",
		actionType: "fingering",
		stageGroup: "fingering_vagina_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["hand"],
		objectParts: ["vagina"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 4, object: 14 },
		preferenceTags: ["FingeringVag_G"],
		inclinationTags: ["service", "sensual"],
		togglable: false
	},

	Handjob_Clit_NPC: {
		label: "Rub Your Clit",
		category: "Manual",
		actionType: "clitoral",
		stageGroup: "handjob_clit_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["hand"],
		objectParts: ["clitoris"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 4, object: 14 },
		preferenceTags: ["Clit_Rub"],
		inclinationTags: ["service", "direct"],
		togglable: false
	},

	BreastPlay_NPC: {
		label: "Touch Your Breasts",
		category: "Manual",
		actionType: "breast",
		stageGroup: "breastplay_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["hand"],
		objectParts: ["breasts"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 3, object: 6 },
		preferenceTags: ["BreastPlay_G"],
		inclinationTags: ["sensual", "vanilla"],
		togglable: false
	},

	// NPC Penetration Actions
	Anal_NPC_Penetrate: {
		label: "Penetrate Your Ass",
		category: "Anal",
		actionType: "anal",
		stageGroup: "anal_penis_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["penis"],
		objectParts: ["anus"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 15, object: 18 },
		preferenceTags: ["Anal_G"],
		inclinationTags: ["penetration", "dominance"],
		togglable: false
	},

	Vaginal_NPC_Penetrate: {
		label: "Penetrate Your Pussy",
		category: "Vaginal",
		actionType: "vaginal",
		stageGroup: "vaginal_penis_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["penis"],
		objectParts: ["vagina"],
		canTakeVirginity: true,
		skillsRequired: {},
		baseExcitement: { subject: 18, object: 20 },
		preferenceTags: ["Vaginal_G"],
		inclinationTags: ["penetration", "vanilla"],
		togglable: false
	},

	// NPC Power Actions
	Dominate_NPC: {
		label: "Take Control of You",
		category: "Power",
		actionType: "dominance",
		stageGroup: "power_dynamic_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["body"],
		objectParts: ["mind"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 8, object: 5 },
		preferenceTags: ["Dominate"],
		inclinationTags: ["domination", "control"],
		togglable: false
	},

	Spank_NPC: {
		label: "Spank You",
		category: "Power",
		actionType: "impact",
		stageGroup: "spanking_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["hand"],
		objectParts: ["anus"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 6, object: 8 },
		preferenceTags: ["Spank_G"],
		inclinationTags: ["domination", "roughplay"],
		togglable: false
	},

	HairPulling_NPC: {
		label: "Pull Your Hair",
		category: "Power",
		actionType: "control",
		stageGroup: "hairpulling_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["hand"],
		objectParts: ["head"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 4, object: 6 },
		preferenceTags: ["HairPulling_G"],
		inclinationTags: ["domination", "roughplay"],
		togglable: false
	},

	// NPC Verbal Actions
	DirtyTalk_NPC: {
		label: "Talk Dirty to You",
		category: "Verbal",
		actionType: "verbal",
		stageGroup: "dirtytalk_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["mouth"],
		objectParts: ["ears"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 4, object: 6 },
		preferenceTags: ["DirtyTalk_G"],
		inclinationTags: ["verbal", "domination"],
		togglable: false
	},

	Praise_NPC: {
		label: "Praise You",
		category: "Verbal",
		actionType: "verbal",
		stageGroup: "praise_npc",
		stageLevel: 0,
		giver: "npc",
		receiver: "player",
		subjectParts: ["mouth"],
		objectParts: ["ears"],
		canTakeVirginity: false,
		skillsRequired: {},
		baseExcitement: { subject: 3, object: 8 },
		preferenceTags: ["Praise_G"],
		inclinationTags: ["praise", "vanilla"],
		togglable: false
		},

		// Missing NPC Manual Action
		NipplePlay_NPC: {
				label: "Play With Your Nipples",
				category: "Manual",
				actionType: "nipple",
				stageGroup: "nippleplay_npc",
				stageLevel: 0,
				giver: "npc",
				receiver: "player",
				subjectParts: ["hand"],
				objectParts: ["breasts"],
				canTakeVirginity: false,
				skillsRequired: {},
				baseExcitement: { subject: 4, object: 8 },
				preferenceTags: ["NipplePlay_G"],
				inclinationTags: ["sensual", "vanilla"],
				togglable: false
		},

		// Generic Orgasm Acts
		Orgasm_Penis_Internal: {
			label: "Cum Inside Them",
			category: "Orgasm",
			actionType: "orgasm",
			stageLevel: 0,
			isCumming: true,
			giver: "player",
			receiver: "npc",
			subjectParts: ["penis"],
			objectParts: ["vagina"],
			orgasmTags: ["internal"],
			preferenceTags: ["Orgasm_Inside"],
			inclinationTags: ["release"],
			togglable: false
		},

		Orgasm_Penis_External: {
			label: "Cum On Them",
			category: "Orgasm",
			actionType: "orgasm",
			stageLevel: 0,
			isCumming: true,
			giver: "player",
			receiver: "npc",
			subjectParts: ["penis"],
			objectParts: ["body"],
			orgasmTags: ["external"],
			preferenceTags: ["Visual_Cum"],
			inclinationTags: ["release"],
			togglable: false
		},

		Orgasm_Vagina_Solo: {
			label: "Solo Orgasm",
			category: "Orgasm",
			actionType: "orgasm",
			stageLevel: 0,
			isCumming: true,
			giver: "player",
			receiver: "player",
			subjectParts: ["vagina"],
			objectParts: ["body"],
			orgasmTags: ["solo"],
			preferenceTags: [],
			inclinationTags: ["release"],
			togglable: false
		},

		// Receiving action aliases
		Oral_Vagina_R: {
			label: "Have Your Pussy Licked",
			category: "Oral",
			actionType: "oral",
			stageGroup: "oral_vagina_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["mouth"],
			objectParts: ["vagina"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 6, object: 16 },
			preferenceTags: ["Oral_G", "Vagina"],
			inclinationTags: ["service", "sensual"],
			togglable: false
		},

		Oral_Penis_R: {
			label: "Receive Oral On Your Cock",
			category: "Oral",
			actionType: "oral",
			stageGroup: "oral_penis_npc",
			stageLevel: 1,
			giver: "npc",
			receiver: "player",
			subjectParts: ["mouth"],
			objectParts: ["penis"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 8, object: 15 },
			preferenceTags: ["Oral_G", "Penis"],
			inclinationTags: ["submission", "service"],
			togglable: false
		},

		Deepthroat_R: {
			label: "Get Deepthroated",
			category: "Oral",
			actionType: "oral",
			stageGroup: "oral_penis_npc",
			stageLevel: 2,
			giver: "npc",
			receiver: "player",
			subjectParts: ["mouth"],
			objectParts: ["penis"],
			canTakeVirginity: false,
			skillsRequired: { oral: 3 },
			baseExcitement: { subject: 8, object: 20 },
			preferenceTags: ["Oral_G", "Penis", "Throatplay"],
			inclinationTags: ["submission", "service"],
			togglable: false
		},

		Handjob_Penis_R: {
			label: "Get a Handjob",
			category: "Manual",
			actionType: "handjob",
			stageGroup: "handjob_penis_npc",
			stageLevel: 1,
			giver: "npc",
			receiver: "player",
			subjectParts: ["hand"],
			objectParts: ["penis"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 6, object: 12 },
			preferenceTags: ["Penis", "Handplay"],
			inclinationTags: ["service", "vanilla"],
			togglable: false
		},

		Handjob_Clit_R: {
			label: "Clit Rub",
			category: "Manual",
			actionType: "clitoral",
			stageGroup: "handjob_clit_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["hand"],
			objectParts: ["clitoris"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 4, object: 14 },
			preferenceTags: ["Clit_Rub"],
			inclinationTags: ["service", "direct"],
			togglable: false
		},

		Fingering_Vagina_R: {
			label: "Get Fingered",
			category: "Manual",
			actionType: "fingering",
			stageGroup: "fingering_vagina_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["hand"],
			objectParts: ["vagina"],
			canTakeVirginity: true,
			skillsRequired: {},
			baseExcitement: { subject: 4, object: 14 },
			preferenceTags: ["FingeringVag_G"],
			inclinationTags: ["service", "sensual"],
			togglable: false
		},

		Fingering_Anal_R: {
			label: "Get Fingered In The Ass",
			category: "Manual",
			actionType: "fingering",
			stageGroup: "fingering_anal_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["hand"],
			objectParts: ["anus"],
			canTakeVirginity: true,
			skillsRequired: {},
			baseExcitement: { subject: 4, object: 10 },
			preferenceTags: ["FingeringAnal_R"],
			inclinationTags: ["service", "submission"],
			togglable: false
		},

		BreastPlay_R: {
			label: "Have Your Breasts Touched",
			category: "Manual",
			actionType: "breast",
			stageGroup: "breastplay_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["hand"],
			objectParts: ["breasts"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 3, object: 6 },
			preferenceTags: ["BreastPlay_G"],
			inclinationTags: ["sensual", "vanilla"],
			togglable: false
		},

		NipplePlay_R: {
			label: "Have Your Nipples Played With",
			category: "Manual",
			actionType: "nipple",
			stageGroup: "nippleplay_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["hand"],
			objectParts: ["breasts"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 4, object: 8 },
			preferenceTags: ["NipplePlay_G"],
			inclinationTags: ["sensual", "vanilla"],
			togglable: false
		},

		FaceSit_R: {
			label: "Be Sat On",
			category: "Oral",
			actionType: "oral",
			stageGroup: "facesit_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["vagina"],
			objectParts: ["mouth"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 12, object: 8 },
			preferenceTags: ["Oral_G"],
			inclinationTags: ["domination", "exhibitionism"],
			togglable: false
		},

		Spank_R: {
			label: "Get Spanked",
			category: "Power",
			actionType: "impact",
			stageGroup: "spanking_npc",
			stageLevel: 0,
			giver: "npc",
			receiver: "player",
			subjectParts: ["hand"],
			objectParts: ["anus"],
			canTakeVirginity: false,
			skillsRequired: {},
			baseExcitement: { subject: 6, object: 8 },
			preferenceTags: ["Spank_G"],
			inclinationTags: ["domination", "roughplay"],
			togglable: false
		}

};
/* twine-user-script #50: "SexScene_Responses.js" */
setup.SexSceneResponses = {
	// ===============================
	// 🔸 ORAL RESPONSES
	// ===============================

	Oral_Penis_G_Tease: {
		start: ["You brush your lips over their shaft, teasing with warm breath."],
		Neutral: [
			"You let your lips glide lazily along their length, maintaining just enough contact to keep them aching.",
			"You kiss your way across their inner thighs, then flick your tongue gently across their entrance, just enough to make them gasp.",
			"Your breath brushes over their slick heat as your lips close around their clit in a soft, teasing pull.",
			"You trace slow, experimental lines over their chest, gauging where the sensation hits best.",
			"You let the toy vibrate gently against their skin, its presence alone sending subtle tremors through them.",
			"You hover just close enough to keep them aching, each denied moment sharpening their hunger."
		],
		Liked: [
			"You tease every inch of their cock with slow licks and playful flicks of your tongue, drawing moans from deep in their throat.",
			"They groan and thrust into your hand, clearly desperate for more pressure.",
			"You feel them throb in your grip as they beg for you to stroke them properly.",
			"You ghost your fingers over their clit just how they love it, watching them twitch with need.",
			"You grind your hips forward with just enough pressure to drive them wild, the tease perfectly cruel.",
			"They whimper and try to push back onto you, desperate for penetration."
		],
		Disliked: [
			"You lightly mouth their shaft, but they seem distracted, barely reacting.",
			"They seem frustrated by the light touches, wanting more stimulation.",
			"Their arousal starts to fade from the insufficient contact.",
			"You toy with their clit, but they barely react, their eyes distant.",
			"You nudge at their ass, but they tense up, clearly not enjoying the attention.",
			"They seem impatient, not enjoying the prolonged teasing."
		],
		climax: ["Their cock throbs against your lips, the teasing too much to bear."]
	},

	Oral_Penis_G_Suck: {
		start: ["You take them into your mouth, lips sealing around their length."],
		Neutral: [
			"You work your mouth steadily up and down their shaft, guided by the rhythm of their breath.",
			"You stroke the base of their cock with your hand while your mouth slowly works the top, building rhythm with purpose.",
			"You kiss along the length of their shaft before taking them into your mouth again, letting your breath warm them between motions.",
			"Your tongue explores every inch of their cock, savoring the heat and weight of it against your lips.",
			"You glance up through your lashes as you slowly begin to suck, letting your lips stretch around them with a practiced seal.",
			"You lower your head and run your tongue slowly along the underside of their shaft, teasing the sensitive skin with a gentle lick."
		],
		Liked: [
			"You suck with focused hunger, your tongue swirling and lips tight, earning sharp gasps and helpless thrusts.",
			"They groan deep in their throat, hips twitching as your mouth takes them deeper.",
			"Their hand tangles in your hair, gripping gently as you suck them with growing confidence.",
			"'Fuck,' they gasp, the sound rough and needy as your tongue dances around their shaft.",
			"They moan louder with each bob of your head, unable to stop themselves from thrusting just a little.",
			"Pre-cum beads against your tongue as they pant your name, completely undone by your attention."
		],
		Disliked: [
			"You suck slowly, but their tension suggests it's not quite doing it for them.",
			"They shift awkwardly under you, breath catching not from pleasure but discomfort.",
			"'Wait—' they mutter, voice strained, their hips pulling back.",
			"You sense hesitation in the way they touch your shoulder, not quite pushing but definitely pausing.",
			"They flinch when your teeth scrape unintentionally, and the moment grows tense.",
			"'Can we stop?' they ask, clearly not feeling it anymore."
		],
		climax: ["They twitch and groan in your mouth, spilling warmth across your tongue."]
	},

	Oral_Penis_G_Deepthroat: {
		start: ["You steady your breath before pushing their cock deeper into your throat, relaxing as much as you can."],
		Neutral: [
			"You sink down slowly, feeling your lips meet the base of their shaft with a wet gasp.",
			"A shudder runs through your body as you take all of them into your mouth, your throat stretching to accommodate them.",
			"You press your nose to their pelvis, throat tightening briefly before you adjust to the fullness.",
			"They twitch in your throat as you hold them there, lips stretched wide around the base of their cock.",
			"You swallow around them slowly, teasing the sensitive underside with the pressure of your throat."
		],
		Liked: [
			"They groan with raw hunger, head falling back as you swallow them whole.",
			"Their hand grabs your hair, hips jerking as you take them all the way down again and again.",
			"'Holy fuck,' they gasp, voice strained and hoarse from how good it feels.",
			"They can barely stay still, their thighs trembling as your throat massages their cock.",
			"They pant your name, breath hitched and ragged, as you choke and moan around them.",
			"Their cock pulses hard in your mouth as you push past your gag reflex and bury them deeper with each thrust."
		],
		Disliked: [
			"They tense as you try to take them too fast. 'Easy,' they mutter, concern flickering in their eyes.",
			"They gently place a hand on your cheek and guide you back, clearly not into this.",
			"'You don't have to go that far,' they say softly, sensing your discomfort.",
			"Their expression falters—what started as pleasure turns to hesitation.",
			"They shift their hips away slightly, not resisting, but pulling out of the moment.",
			"'Maybe stay shallow,' they suggest with a strained smile, breath shaky."
		],
		climax: ["They pulse hard in your mouth as you choke and moan around them."]
	},

	Oral_Vagina_G_Tease: {
		start: ["You lower yourself between their thighs, the scent of arousal heavy as you press your mouth close to their folds."],
		Neutral: [
			"Your tongue teases along the edges of their sex, warm and slow, not yet touching their clit directly.",
			"You kiss your way across their inner thighs, then flick your tongue gently across their entrance, just enough to make them gasp.",
			"You part their lips with careful fingers and trace a circle around their clit, savoring the way they shift beneath you.",
			"Your breath brushes over their slick heat as your lips close around their clit in a soft, teasing pull.",
			"You trace along their entrance with one finger, not yet penetrating.",
			"You circle their opening slowly, feeling how wet they're getting from your teasing."
		],
		Liked: [
			"They cry out as your tongue presses harder against their clit, hips bucking into your face.",
			"You feel them pulsing against your tongue, thighs clamped tight around your head as they beg you not to stop.",
			"They push against your finger, desperate for penetration.",
			"You feel them getting wetter with each teasing touch.",
			"You ghost your fingers over their clit just how they love it, watching them twitch with need.",
			"They whimper and try to push back onto you, desperate for penetration."
		],
		Disliked: [
			"They shift beneath you, legs inching closed, breath no longer matched to pleasure.",
			"'Wait, it's not working,' they say, trying to guide your head away.",
			"They seem impatient with the teasing, wanting more direct stimulation.",
			"Their arousal plateaus from the prolonged teasing.",
			"You toy with their clit, but they barely react, their eyes distant.",
			"Their arousal starts to fade as the teasing goes on too long."
		],
		climax: ["They gasp, thighs clamping around your head as they cum hard against your tongue."]
	},

	Oral_Vagina_G: {
		start: ["You part their lips with careful fingers and trace a circle around their clit, savoring the way they shift beneath you."],
		Neutral: [
			"You lap at them slowly, deliberately, learning what makes their muscles twitch and their moans catch.",
			"You explore gently, watching their face for every twitch of response.",
			"You press against their clit and begin to rub firmly.",
			"You rub their clit with practiced rhythm, each motion drawing another breathy moan.",
			"You part their folds carefully and ease a finger inside, coaxing a breath from them.",
			"The heat between their thighs guides you as your fingers work with steady precision."
		],
		Liked: [
			"They are moaning now, steady and uncontrolled, rocking into your rhythm like their life depends on it.",
			"Their body trembles with every stroke, slick and needy as they ride your mouth to the edge.",
			"They moan as your fingers push deeper, their hips rising to meet you.",
			"They whimper through clenched teeth, clearly unable to hold back the pleasure.",
			"You circle and flick their clit with precision, sending shocks of pleasure through their core.",
			"They grind into your hand, gasping as your fingers stroke just the right spot."
		],
		Disliked: [
			"They fidget, clearly distracted, their hips angling away from your tongue.",
			"'Not there,' they say quietly, eyes avoiding yours as their arousal fades.",
			"They tense slightly beneath your hand, discomfort flickering across their features.",
			"They shift their hips away from your touch, a soft murmur escaping. 'Maybe not like that.'",
			"You rub their clit, but they shift away slightly, clearly not enjoying the pressure.",
			"They shift beneath you, trying to find a better angle but not quite succeeding."
		],
		climax: ["They scream your name as their entire body jolts, hands tangled in your hair as they fall apart."]
	},

	Oral_Anal_G: {
		start: ["You lower yourself between their thighs, hands parting their rear with steady care."],
		Neutral: [
			"You press your mouth to their most private place, tongue exploring gently with deliberate precision.",
			"You run your hands along their hips and thighs before leaning in, letting your breath tease their entrance.",
			"You kiss the soft skin just above their opening, then slowly move lower, watching for every reaction.",
			"You begin slowly, circling their entrance with your tongue as your grip steadies their waist.",
			"You explore them with a mix of curiosity and reverence, letting the moment dictate your rhythm."
		],
		Liked: [
			"They gasp sharply, body jolting as your tongue finds just the right pressure.",
			"They moan into the sheets, legs trembling with every flick of your tongue.",
			"Their breath comes ragged and fast, hips bucking slightly toward your mouth.",
			"'Oh gods,' they pant, voice trembling with each wave of sensation.",
			"They grip the bedding tightly, unable to stay still beneath the intensity of your touch.",
			"They let out a helpless moan, clearly overwhelmed by the depth of pleasure you're giving them."
		],
		Disliked: [
			"They tense, the muscles in their back and thighs locking tight.",
			"They flinch slightly, pulling away with a shaken breath. 'Not there…'",
			"You feel them shiver—not with pleasure—and they shift uncomfortably.",
			"'That's not something I like,' they murmur, glancing back with unease.",
			"Their body goes still under your touch, the mood fading as discomfort sets in.",
			"They reach back gently, guiding you away from the area with a soft but firm touch."
		],
		climax: ["They shudder under you, overwhelmed by the slow torment."]
	},

	FaceSit_G: {
		start: ["You straddle their face slowly, watching their expression for any flicker of hesitation—or hunger."],
		Neutral: [
			"You settle your hips atop their mouth, rocking gently as they take in your scent and heat.",
			"You plant your knees on either side of their head, hovering until you're sure they're ready.",
			"You lower yourself carefully, bracing on the headboard while they exhale hot breath against your skin.",
			"You grip the headboard, letting your body sink lower, pressing your thighs gently around their face.",
			"Your breath shudders as you rest your weight on them, waiting for their reaction beneath you."
		],
		Liked: [
			"They groan hungrily, gripping your thighs and pulling you down with urgency.",
			"They moan against you, tongue eager and unrelenting as their hands grip your hips.",
			"'Fuck,' they breathe against your heat, and then there are no more words—just moaning, licking, gasping.",
			"They press themselves up into you, clearly lost in the pleasure of being beneath you.",
			"Their eyes flutter shut and their breath turns ragged—they're loving every second of this.",
			"Their grip tightens, fingers digging into your skin as they devour you with raw, greedy need."
		],
		Disliked: [
			"They try to shift away, muffled sounds of protest lost against your thighs.",
			"They hesitate beneath you, hands tapping lightly on your thighs—trying to ease you off.",
			"You feel them go still, and not in a submissive way—the energy falters instantly.",
			"'Wait, I'm not sure about this,' they mutter breathlessly when you lift just enough to hear.",
			"Their hands slide to your waist, not to pull you closer—but to stop you.",
			"Their body stiffens beneath you—not in pleasure, but in discomfort."
		],
		climax: ["You cry out, grinding down with abandon as they ride your tongue."]
	},

	// ===============================
	// 🔸 MANUAL RESPONSES
	// ===============================

	Handjob_Penis_G_Tease: {
		start: ["You wrap your fingers around their shaft, stroking slowly with feather-light touches."],
		Neutral: [
			"Your fingertips dance along their length, building tension with each teasing caress.",
			"You tease the head with your thumb, circling the tip before gliding back down the shaft.",
			"They exhale softly as your grip tightens slightly, your pace deliberate and smooth.",
			"You pump your hand along their length, letting the slick friction do its work.",
			"Your wrist flexes just right, drawing soft gasps from them with every upstroke."
		],
		Liked: [
			"They groan and thrust into your hand, clearly desperate for more pressure.",
			"You feel them throb in your grip as they beg for you to stroke them properly.",
			"They groan loudly, hips twitching into your grip.",
			"'Just like that,' they pant, voice trembling with arousal.",
			"Their cock pulses in your hand as you stroke faster, their breath coming hard and fast."
		],
		Disliked: [
			"They seem frustrated by the light touches, wanting more stimulation.",
			"Their arousal starts to fade from the insufficient contact.",
			"They shift slightly, your hand not quite finding the rhythm they need.",
			"'Softer,' they say with a strained voice, body tensing under your grip.",
			"Your movements feel off, and they gently pull your hand away."
		],
		climax: ["They pulse in your hand as you finally give them the pressure they need."]
	},

	Handjob_Penis_G: {
		start: ["You wrap your fingers around their shaft, stroking slowly from base to tip with firm pressure."],
		Neutral: [
			"Your hand slides easily along their cock, building a steady rhythm as you watch their reactions.",
			"You tease the head with your thumb, circling the tip before gliding back down the shaft.",
			"They exhale softly as your grip tightens slightly, your pace deliberate and smooth.",
			"You pump your hand along their length, letting the slick friction do its work.",
			"Your wrist flexes just right, drawing soft gasps from them with every upstroke."
		],
		Liked: [
			"They groan loudly, hips twitching into your grip.",
			"'Just like that,' they pant, voice trembling with arousal.",
			"Their cock pulses in your hand as you stroke faster, their breath coming hard and fast.",
			"You feel them throb between your fingers, the heat building with every pass.",
			"They bite their lip, eyes locked on your hand working their length with practiced care."
		],
		Disliked: [
			"They shift slightly, your hand not quite finding the rhythm they need.",
			"'Softer,' they say with a strained voice, body tensing under your grip.",
			"Your movements feel off, and they gently pull your hand away.",
			"'Let me show you,' they offer, trying to guide your pace.",
			"They wince—your grip might be too dry, or the angle too rough."
		],
		climax: ["They cry out as they pulse in your hand, releasing across your fingers."]
	},

	Handjob_Clit_G_Tease: {
		start: ["You trail your fingers over their slit, barely grazing their clit."],
		Neutral: [
			"Your fingertips move in slow, spiraling circles that build delicious tension.",
			"You slide your fingers down between their thighs, gently finding their clit with the tip of your finger.",
			"You rub small, slow circles over their swollen bud, testing their rhythm and watching their breath.",
			"Your thumb brushes over their clit again and again, gentle but insistent.",
			"You tease their entrance with one finger while the other plays lightly across their clit."
		],
		Liked: [
			"You ghost your fingers over their clit just how they love it, watching them twitch with need.",
			"They gasp and arch against your hand, thighs trembling.",
			"They moan sharply, breath catching as your touch sends sparks straight to their core.",
			"'Right there—don't stop!' they cry, hips grinding against your fingers.",
			"They writhe with each stroke, every nerve lighting up as you rub harder."
		],
		Disliked: [
			"You toy with their clit, but they barely react, their eyes distant.",
			"They flinch slightly, and their thighs try to close around your hand.",
			"'Too sensitive,' they mutter, shifting their hips away.",
			"They squirm under your hand, clearly not enjoying the sensation.",
			"You feel their tension—not pleasure but resistance—as they pull back from your touch."
		],
		climax: ["They twitch and moan as waves of pleasure ripple through them."]
	},

	Handjob_Clit_G: {
		start: ["You press against their clit and begin to rub firmly."],
		Neutral: [
			"You rub their clit with practiced rhythm, each motion drawing another breathy moan.",
			"You shift your hand just slightly to hit the right spot, rhythmically stroking the slick nub of flesh.",
			"They circle your clit slowly, testing the pace and watching your every reaction.",
			"Their fingers stroke you with practiced precision, neither too light nor too rough.",
			"They press their thumb over your clit and begin slow, rhythmic motion that sends shivers through your core."
		],
		Liked: [
			"You circle and flick their clit with precision, sending shocks of pleasure through their core.",
			"They moan sharply, hips bucking against their hand.",
			"Their fingers rub you in tight, perfect circles, and your body melts under the pressure.",
			"'There,' you whimper, clinging to the sensation as pleasure builds fast.",
			"They smirk as your thighs twitch with each pass—completely in control of your pleasure."
		],
		Disliked: [
			"You rub their clit, but they shift away slightly, clearly not enjoying the pressure.",
			"You shift your hips, trying to guide them—but their touch feels off.",
			"'Not like that,' you mutter, frustration slipping into your voice.",
			"Their fingers are too rough, and the tension makes it hard to enjoy the moment.",
			"They fumble with their rhythm, and your arousal cools with every awkward stroke."
		],
		climax: ["They cry out, clenching around nothing as they climax hard."]
	},

	Fingering_Vagina_G_Tease: {
		start: ["You trace along their entrance with one finger, not yet penetrating."],
		Neutral: [
			"You circle their opening slowly, feeling how wet they're getting from your teasing.",
			"Your fingers glide down their hips and between their thighs, moving with slow, deliberate strokes.",
			"You part their folds carefully and ease a finger inside, coaxing a breath from them.",
			"Your hand moves lower, tracing the curve of their skin before slipping between their legs.",
			"You explore gently, watching their face for every twitch of response."
		],
		Liked: [
			"They push against your finger, desperate for penetration.",
			"You feel them getting wetter with each teasing touch.",
			"They moan as your fingers push deeper, their hips rising to meet you.",
			"Their breath catches, hands gripping the sheets as your rhythm builds.",
			"They whimper through clenched teeth, clearly unable to hold back the pleasure."
		],
		Disliked: [
			"They seem impatient with the teasing, wanting more direct stimulation.",
			"Their arousal plateaus from the prolonged teasing.",
			"They tense slightly beneath your hand, discomfort flickering across their features.",
			"They shift their hips away from your touch, a soft murmur escaping. 'Maybe not like that.'",
			"Your fingers meet resistance—not physical, but emotional—as they stiffen."
		],
		climax: ["They gasp as you finally slide inside, their body welcoming your finger."]
	},

	Fingering_Vagina_G: {
		start: ["You part their folds carefully and ease a finger inside, coaxing a breath from them."],
		Neutral: [
			"You explore gently, watching their face for every twitch of response.",
			"The heat between their thighs guides you as your fingers work with steady precision.",
			"You tease them slowly, your hand confident but patient—testing their arousal.",
			"Your fingers glide down their hips and between their thighs, moving with slow, deliberate strokes.",
			"You part their folds carefully and ease a finger inside, coaxing a breath from them."
		],
		Liked: [
			"They moan as your fingers push deeper, their hips rising to meet you.",
			"They whimper through clenched teeth, clearly unable to hold back the pleasure.",
			"They grind into your hand, gasping as your fingers stroke just the right spot.",
			"Their voice is ragged, whispering your name between moans.",
			"They grip your wrist—not to stop you, but to hold on as waves of pleasure hit."
		],
		Disliked: [
			"They tense slightly beneath your hand, discomfort flickering across their features.",
			"They shift their hips away from your touch, a soft murmur escaping. 'Maybe not like that.'",
			"Your fingers meet resistance—not physical, but emotional—as they stiffen.",
			"They give a hesitant glance, body still and unresponsive beneath your hand.",
			"'Can we slow down?' they ask, voice guarded."
		],
		climax: ["They cry out, body trembling as your fingers stroke just the right spot."]
	},

	Fingering_Anal_G: {
		start: ["You trail your fingers lower, circling gently before slipping one against the tight ring of muscle."],
		Neutral: [
			"You apply a little more pressure, watching their breath catch as your finger slides deeper.",
			"Their body tenses, then softens as you begin to move with careful rhythm.",
			"You curl your finger slowly inside them, letting them adjust to the intrusion.",
			"Your free hand rests on their hip while your other hand works them open with deliberate care.",
		],
		Liked: [
			"They moan shamelessly, pushing back into your touch.",
			"They whimper as you curl your fingers just right—they loves every second of it.",
			"Their body clenches and releases, begging for more pressure, more depth.",
			"'Don't stop,' they pant, squirming against your hand.",
			"They are clearly loving every stroke.",
			"They tremble, walls fluttering around your fingers as they lose themselves to the pleasure."
		],
		Disliked: [
			"They flinch, jaw tight. 'Not there,' they mutter.",
			"Their breath hitches uncomfortably and their body pulls away.",
			"They tense up hard as you press in, a wince flickering across their face.",
			"'That feels... off,' they say, clearly not enjoying the sensation.",
			"You notice their body resisting instead of yielding—this isn't what they want.",
			"They shake their head softly, voice quiet but firm. 'Please don't.'"
		],
		climax: ["They shudder as waves of unexpected pleasure wash over them."]
	},

	BreastPlay_G: {
		start: ["You cup their breasts gently, brushing your thumbs across their nipples in slow, deliberate circles."],
		Neutral: [
			"Your hands explore their chest with reverent care, gauging their every breath.",
			"You trace your fingers along the curve of their chest, watching for reactions.",
			"You lean in to kiss the top of one breast while your thumb teases the other.",
			"Your hands move confidently across their skin, keeping pressure light and exploratory.",
			"You drag your knuckles gently across their nipples, then cup their breast with your full hand."
		],
		Liked: [
			"They moan softly, arching into your hands as heat blooms beneath your touch.",
			"They whimper when your thumb brushes over their nipple, and their hips squirm in response.",
			"You feel them press into your palms, their breathing ragged and needy.",
			"Their nipples harden under your fingers, and they bite their lip as if to stay quiet.",
			"They tilt their head back, eyes closed, mouth parted—lost in the sensation."
		],
		Disliked: [
			"They squirm in your grip, shoulders drawing slightly inward.",
			"Their posture shifts, pulling their chest away from your hands.",
			"'That's... not really my spot,' they murmur, voice flat.",
			"They offer a tight-lipped smile, but there's no passion in it.",
			"They shift uncomfortably beneath your touch, clearly not engaged."
		],
		climax: ["They gasp as pleasure radiates from their chest through their entire body."]
	},

	NipplePlay_G: {
		start: ["You circle a fingertip around one of their nipples, then give it a gentle pinch, gauging their reaction."],
		Neutral: [
			"You drag your thumb lightly across their chest, watching how their skin responds.",
			"Your fingers tease the peak, twisting it slowly between two fingers while your free hand steadies their waist.",
			"You alternate between firm and featherlight pressure, testing what draws the most breath from them.",
			"You let your tongue swirl slowly over the sensitive nub, watching their eyes for flickers of pleasure.",
			"You drag your thumbs over their chest, teasing slow circles around each nipple."
		],
		Liked: [
			"They moan gently, arching into your hand with need.",
			"They gasp when your tongue flicks just right, body visibly shivering.",
			"They moan sharply as your tongue dances over their nipple, back arching in response.",
			"They gasp, hands gripping your shoulders as pleasure sparks through their chest.",
			"Their nipples harden quickly under your touch, they breathe faster with every motion."
		],
		Disliked: [
			"They wriggle away slightly, discomfort flickering in their expression.",
			"'I don't really feel anything there,' they mutter, eyes a bit distant.",
			"They glance away, their chest unmoving as your fingers graze their nipple.",
			"'I'm not really sensitive there,' they murmur, offering a faint smile.",
			"They reach for your wrist, gently moving your hand away from their chest."
		],
		climax: ["Waves of sensation spread from their nipples through their entire body."]
	},

	// ===============================
	// 🔸 POWER RESPONSES
	// ===============================

	Dominate: {
		start: ["You shift your weight over them, your gaze steady and commanding as you take the lead."],
		Neutral: [
			"You press them down by the shoulders, asserting your intentions without a word.",
			"Your hand slides to their throat—not to squeeze, just to hold—as you pin them in place.",
			"You take firm hold of their hips, guiding the rhythm with absolute control.",
			"Your body cages them, heat radiating off you as you press forward with slow dominance.",
			"You move deliberately, forcing them to follow your pace and your will."
		],
		Liked: [
			"They gasp, clearly turned on as they yields completely to your control.",
			"They whimper beneath you, eyes glassy with submission and need.",
			"Your grip tightens, and they moan as if the power shift alone pushes them closer to release.",
			"They melt into the sheets, a breathy 'yes' escaping their lips as you press them down.",
			"They look up at you with shining eyes—needy, obedient, desperate for more."
		],
		Disliked: [
			"They stiffen, clearly not responding well to the pressure.",
			"They push back against your grip, discomfort flickering across their features.",
			"You feel them tense up, the mood shifting as their eyes narrow.",
			"'That's not how I like it,' they mutter, voice hardening.",
			"They pull away slightly, body defensive rather than inviting."
		],
		climax: ["They surrender completely to your dominance, lost in submission."]
	},

	Submit: {
		start: ["You lower yourself, offering them full access to your body without resistance."],
		Neutral: [
			"You turn your head slightly, exposing your throat, eyes lowered in quiet surrender.",
			"You lie back and let them take the lead, body relaxed and expectant beneath them.",
			"You loosen your grip on control and exhale, letting them see your vulnerability.",
			"Your hands fall to your sides, posture softening as you yield to whatever they want.",
			"You breathe slowly, watching their reaction as you stop directing and start receiving."
		],
		Liked: [
			"They smile darkly, fingers running along your jaw as they take full advantage of your surrender.",
			"They straddle you with confidence, clearly turned on by your obedience.",
			"They lean in close, breath hot against your ear. 'Good. Just like that.'",
			"Their touch grows bolder as they revel in the power you've given up willingly.",
			"They press into you with growing hunger, clearly aroused by the way you submit."
		],
		Disliked: [
			"They frown slightly, confused by your sudden passivity.",
			"'What are you doing?' they ask, tone uncertain.",
			"They hesitate, clearly uncomfortable with the shift in energy.",
			"You feel them hesitate above you, uncertain how to respond to your lack of initiative.",
			"'This isn't really my thing,' they mutter, their voice tense."
		],
		climax: ["You melt into complete submission, giving them everything they want."]
	},

	Spank_G: {
		start: ["You bring your palm down across their backside with a sharp, satisfying smack."],
		Neutral: [
			"The sound of skin-on-skin rings out as your hand connects with their rear.",
			"You deliver a measured swat to their ass, watching the slight ripple of their form.",
			"Your hand meets their skin with a clean crack, just hard enough to leave a glow behind.",
			"You smack them again, savoring the warmth blooming beneath your fingers.",
			"Your palm strikes their backside, each smack echoing softly in the air between you."
		],
		Liked: [
			"They moan loudly, arching back into your hand, clearly craving more.",
			"They shudder with delight, moans escaping as their ass tingles.",
			"'Harder,' they beg, rocking themselves into the next impact.",
			"Their hips wiggle playfully, skin flushing as you keep them on edge.",
			"They laugh breathlessly, their eyes burning with mischief.",
			"They grip the nearest surface, pushing their form into you for the next slap."
		],
		Disliked: [
			"They jolt, a startled noise escaping. 'That's not really my thing…'",
			"They flinch under your hand, body going still with unease.",
			"Their muscles tighten—not in arousal, but restraint. They say nothing, but their posture speaks volumes.",
			"You feel them shift away slightly, tension returning to their spine.",
			"'Let's… skip that,' they mutter, not meeting your gaze.",
			"They breathe out hard, clearly not enjoying the sting."
		],
		climax: ["They cry out in pleasure as you spank them again, harder this time."]
	},

	// ===============================
	// 🔸 EMOTIONAL & VERBAL RESPONSES
	// ===============================

	Praise_G: {
		start: ["You murmur soft compliments into their hair, each word meant only for them."],
		Neutral: [
			"Your fingers brush down their back as you whisper, 'You're beautiful,' with quiet conviction.",
			"You smile against their neck, letting the warmth of your words wrap around them.",
			"Your tone is low and steady, reverent. 'You're perfect like this,' you breathe.",
			"You cradle their face, locking eyes with them as you tell them exactly how much they mean in this moment.",
			"You speak slowly and clearly, every syllable laced with honest admiration."
		],
		Liked: [
			"They blush fiercely, their eyes shimmering as your words sink in.",
			"They shiver at the praise, mouth parting in a breathless sound between a moan and a sigh.",
			"They whimper softly, as if your voice alone is enough to undo them.",
			"They pull you tighter, as if needing your closeness to match your words.",
			"They melt beneath you, whispering, 'Don't stop saying those things,' voice shaking.",
			"Their body responds before they do, hips twitching slightly, breath catching in pure reaction to being adored."
		],
		Disliked: [
			"They shift awkwardly. 'That's... kind of a lot right now,' they mumble.",
			"They smile, but it's distant. 'You don't have to say all that,' they add, glancing away.",
			"They don't quite respond—shoulders stiff, breath shallow. Something's off.",
			"They laugh quietly but it doesn't reach their eyes. 'Let's focus on what we're doing,' they offer.",
			"You feel them recoil slightly at the affection, unsure how to accept the sentiment.",
			"They nod but offer no verbal response—your words may have landed wrong this time."
		],
		climax: ["They melt completely under your praise, overwhelmed by your adoration."]
	},

	DirtyTalk_G: {
		start: ["You lean in close, letting your voice curl against their ear with promises you haven't fulfilled yet."],
		Neutral: [
			"You whisper filth with precision, watching how they react to every syllable.",
			"Your words are deliberate and slow, slipping past your lips like silk soaked in sin.",
			"You murmur into their hair, letting them feel your breath more than the words themselves.",
			"You paint a picture in words—raw, indulgent, vivid enough to fog their eyes.",
			"Your voice dances through threats and praise, drawing heat from suggestion alone."
		],
		Liked: [
			"They bite their lip, a flush spreading across their cheeks as your words hit home.",
			"They let out a moan just from your voice, pupils blown wide with arousal.",
			"'Say that again,' they beg, voice ragged and breath trembling.",
			"They whimper as you speak, their hands fisting the sheets in anticipation.",
			"Every word seems to ripple through them, their form responding to the sound of your desire.",
			"Their breath catches, and you see a spark light behind those eyes—they love every filthy thing you say."
		],
		Disliked: [
			"They blink awkwardly and look away. 'That was a lot... all at once.'",
			"They pull back slightly, a flicker of discomfort across their face.",
			"They hesitate, lips pressed into a line—not quite rejecting you, but clearly unsettled.",
			"'Can we keep it... softer?' they ask, voice low but firm.",
			"Your words trail off as they tense—not with anticipation, but restraint.",
			"Their body stills, and the heat between you falters under the weight of your tone."
		],
		climax: ["Your filthy words push them over the edge, their body responding to your voice alone."]
	},

	HairPulling_G: {
		start: ["You thread your fingers through their hair, gripping just tight enough to command attention."],
		Neutral: [
			"You curl your fist in their locks and pull gently, tilting their head to expose the soft line of their neck.",
			"Your hand tightens in their hair, just enough to make them pause beneath you.",
			"You tug their head back slowly, watching the tension ripple down their spine.",
			"You take a handful of their hair and guide them where you want, pressure teasing but not cruel.",
			"You fist their hair near the base and tug with slow precision, your breath on their ear."
		],
		Liked: [
			"They gasp, hips bucking at the jolt of control.",
			"They groan with satisfaction, a sound that only deepens when you tug again.",
			"'Yes,' they whisper, eyes darkening with arousal as your grip tightens.",
			"They tilt their head willingly into your hand, offering more of themselves to the pull.",
			"They smile wickedly even as you pull harder—they love the pain laced with pleasure.",
			"Their hands clutch at your arms as you pull, breath hitching with every sharp tug."
		],
		Disliked: [
			"They yelp, twisting out of your grip. 'Not like that,' they snap.",
			"They wince under your hand, body recoiling from the sudden pressure.",
			"'Easy!' they say, reaching back to pry your hand from their hair.",
			"You feel them stiffen immediately—whatever thrill you hoped for doesn't land.",
			"They mutter something under their breath and turn their head away.",
			"They shift out of reach, clearly not enjoying the force you're applying."
		],
		climax: ["They cry out as you pull their hair, the pain mixing perfectly with their pleasure."]
	},

	Choke_G: {
		start: ["You wrap your hand firmly around their throat, letting your grip settle without fully tightening."],
		Neutral: [
			"Your fingers close slowly around their neck, watching their breath and body for a reaction.",
			"You press your palm against their throat, your touch dominant but careful.",
			"You tilt their chin up with a firm grip at the jawline, letting dominance bleed into restraint.",
			"You test the tension with your hand at their neck—just enough pressure to make them aware of it.",
			"You slide your hand around their throat, pausing as your thumb brushes the side of their jaw."
		],
		Liked: [
			"They moan low in their throat, eyes fluttering as your grip tightens.",
			"They gasp sharply, hips twitching as your hand closes around their neck.",
			"'Harder,' they breathe, voice breaking with pleasure.",
			"They look up at you, eyes wide and wild with arousal.",
			"Your fingers dig deeper into their neck, and they shudder—utterly hooked on the control.",
			"They writhe beneath you, moaning into your touch, their breath ragged and desperate."
		],
		Disliked: [
			"Their hand flies to your wrist, prying it away. 'No,' they say, breathless—but not in a good way.",
			"Their whole body locks up, and they stare at you, stunned and stiff.",
			"'That's too much,' they mutter quickly, voice thin and guarded.",
			"They push you off with surprising strength, clearly shaken by your grip.",
			"They cough lightly and pull away, turning their face from yours.",
			"You feel them go completely still—not from obedience, but discomfort."
		],
		climax: ["They gasp as your grip tightens, their orgasm intensified by your control."]
	},

	// ===============================
	// 🔸 ORGASM RESPONSES
	// ===============================

	Orgasm_Penis_Internal: {
		start: ["Your rhythm turns frantic as the pressure builds, your release crashing forward uncontrollably."],
		Neutral: [
			"With a guttural groan, you drive deep and spill everything inside.",
			"Your grip tightens as you bury yourself fully, warmth flooding from you in pulsing waves.",
			"Your body tenses hard as you unload inside their core, breath ragged and broken.",
			"You slam into them one last time and let go—filling them completely.",
			"With a gasp and a deep thrust, your climax overtakes you, thick warmth flooding into them."
		],
		Liked: [
			"They cry out as you release inside them, body trembling around you.",
			"'Yes, inside,' they gasp, wrapping their legs around you tighter.",
			"Their breath catches, eyes rolling back as the heat spreads through their core.",
			"They moan wildly, clutching at you as their own climax crashes down in sync with yours.",
			"Their nails dig into your skin, a shuddering moan escaping them as they feel every pulse of your release.",
			"'Fuck, fill me,' they whisper, trembling with satisfaction as you finish deep inside."
		],
		Disliked: [
			"They gasp and try to pull back too late. 'No—pull out!'",
			"They freeze, panic flashing in their eyes as your release fills them.",
			"'What the hell are you doing!?' they yell, shoving at your chest.",
			"Their body stiffens beneath you—there's no pleasure in the tension now.",
			"They push against your hips, clearly trying to escape the contact.",
			"You see hurt and shock in their face, the intimacy breaking instantly."
		],
		climax: ["You explode inside them, your release pulsing deep as they cry out beneath you."]
	},

	Orgasm_Penis_External: {
		start: ["You pull out at the last second, your release spurting across their skin."],
		Neutral: [
			"You stroke yourself rapidly as you finish, painting their body with your climax.",
			"Your cock pulses as you release across their stomach, thick ropes of warmth coating their skin.",
			"You groan as you cum on their chest, your release marking them as yours.",
			"You aim carefully as you finish, your orgasm splashing across their waiting body.",
			"You pull back and stroke yourself to completion, covering them in your release."
		],
		Liked: [
			"They moan as your cum hits their skin, clearly loving being marked by you.",
			"'Yes, cover me,' they gasp, arching to catch more of your release.",
			"They smile wickedly as you paint them with your climax, eyes dark with satisfaction.",
			"They reach down to spread your cum across their skin, clearly enjoying the mess.",
			"'I love feeling you cum on me,' they whisper, body trembling with arousal.",
			"They watch hungrily as you finish, licking their lips at the sight of your release."
		],
		Disliked: [
			"They flinch as your cum hits them, clearly not expecting or wanting it.",
			"'Warn me next time,' they mutter, wiping at their skin with distaste.",
			"They turn their face away as you finish, body tense with discomfort.",
			"'That's... not really my thing,' they say quietly, reaching for something to clean up.",
			"They seem uncomfortable with the mess, their arousal clearly fading.",
			"You see them grimace slightly as your release hits their skin."
		],
		climax: ["You cry out as you finish across their body, marking them with your release."]
	},

	Orgasm_Vagina_Solo: {
		start: ["A wave of pleasure crashes over you as your body trembles in release."],
		Neutral: [
			"Your muscles clench and release in rhythmic waves as the orgasm washes through you.",
			"You cry out as pleasure radiates from your core, your entire body shaking.",
			"Your back arches as the climax hits, waves of sensation flooding through every nerve.",
			"You gasp and moan as your body convulses with pleasure, lost in the intensity.",
			"Your thighs tremble as the orgasm builds and crashes, leaving you breathless."
		],
		Liked: [
			"You scream with pleasure as the orgasm rips through you, your body completely out of control.",
			"'Oh god, yes!' you cry out, your climax more intense than you expected.",
			"You sob with pleasure as wave after wave crashes over you, overwhelming in its intensity.",
			"Your body shakes violently as you cum harder than you have in ages.",
			"You moan their name as you climax, the pleasure almost too much to bear.",
			"You cling to them as your orgasm destroys you, leaving you gasping and spent."
		],
		Disliked: [
			"The orgasm feels muted, not quite hitting the way you hoped it would.",
			"You cum, but it feels mechanical rather than truly satisfying.",
			"The climax is brief and unsatisfying, leaving you wanting more.",
			"You finish, but the pleasure feels distant and disconnected.",
			"The orgasm comes and goes quickly, not quite fulfilling your need.",
			"You climax, but something feels off about the whole experience."
		],
		climax: ["You cry out as your orgasm crashes over you, your body trembling with release."]
	},

	// ===============================
	// 🔸 RECEIVING RESPONSES (NPC ACTIONS ON PLAYER)
	// ===============================

	Oral_Vagina_R: {
		start: ["They lower their head between your legs, their breath hot against your inner thighs."],
		Neutral: [
			"They trail soft kisses up your thighs, pausing just shy of your clit before flicking their tongue tentatively.",
			"You feel their tongue slide along your folds, slow and exploratory, testing what draws a breath from you.",
			"They spread your lips gently with their fingers and place a warm kiss right over your clit.",
			"They start slow, tongue pressing softly against you in careful, deliberate strokes.",
			"Their mouth moves in lazy circles, lips parting to taste every inch of your slick heat."
		],
		Liked: [
			"Your hips jerk as their tongue presses flat and firm against your clit, licking you with hungry precision.",
			"They groan into you, the vibration setting off sparks through your core.",
			"You moan shamelessly, legs trembling as they suck and swirl with practiced ease.",
			"Each stroke of their tongue makes your body jerk—you're already dangerously close.",
			"'Oh fuck,' you pant, clutching at the sheets as they work you over without mercy.",
			"Your fingers twist in their hair as they bury themselves between your legs, relentless and perfect."
		],
		Disliked: [
			"You flinch slightly—they are too rough, too fast, or just… off.",
			"Their tongue flicks aimlessly, missing your clit entirely, and your arousal starts to wane.",
			"They lick you with awkward rhythm, like someone trying to remember instructions, not savor pleasure.",
			"'Stop,' you whisper, breathless—but not in a good way.",
			"They keep going, but the chemistry is gone, and you're left trying to fake your way through it.",
			"You're wet, but not turned on. Their tongue moves, but your mind's already slipping away."
		],
		climax: ["You scream with pleasure as the orgasm rips through you, your body completely out of control."]
	},

	Oral_Penis_R: {
		start: ["They lower their head slowly, lips parting as they take your shaft into their mouth."],
		Neutral: [
			"Their tongue traces along the underside of your cock, drawing a soft shiver from your spine.",
			"They stroke the base with one hand while they suckle at the tip, eyes flicking up to watch your face.",
			"They take you in inch by inch, tongue swirling under the head before pulling back with a slick pop.",
			"You feel their warm breath against your cock just before they begin to suck again, slow and steady.",
			"They wrap their lips around your shaft, bobbing with a rhythm that immediately draws your attention to every twitch and throb."
		],
		Liked: [
			"You groan loudly as they sink down further, throat flexing around your cock.",
			"They hum around your shaft, and the vibration sends a sharp jolt of pleasure through your hips.",
			"They moan softly, clearly enjoying the taste of you, drool glistening at the corners of their mouth.",
			"They work you with abandon now—no teasing, just hungry, wet pleasure around every inch.",
			"You buck your hips as they swallow you again, deep and smooth, tongue tracing every ridge.",
			"They suck harder, messier, eager moans muffled by the fullness of your cock in their mouth."
		],
		Disliked: [
			"They gag softly, pulling back with a cough and wiping their mouth. 'Sorry,' they mutter, clearly flustered.",
			"They hesitate mid-motion, unsure, the rhythm stalling awkwardly.",
			"'Am I doing it right?' they ask, eyes searching your face with quiet uncertainty.",
			"Their movements feel mechanical, like they're following instructions instead of passion.",
			"You feel teeth graze you unexpectedly, and the tension makes it hard to stay in the moment.",
			"They pause and glance up, lips still around you, but the heat in their eyes is gone."
		],
		climax: ["You gasp loudly as they bury you again, throat pulsing around your cock."]
	},

	Deepthroat_R: {
		start: ["They lower their head with control, sliding your cock deep into their throat."],
		Neutral: [
			"You feel the tight squeeze as they push past the head, lips descending until they meet the base.",
			"They moan around your shaft, the vibration sending heat all the way through your core.",
			"They choke briefly, then swallow around you, taking a breath before going again.",
			"Their nose presses against your skin as they take you all the way, throat flexing tightly around your cock.",
			"The heat and slick pressure of their throat makes your knees weak with every movement."
		],
		Liked: [
			"You gasp loudly as they bury you again, throat pulsing around your cock.",
			"They moan greedily around you, spit dripping from their lips as they deepthroat you over and over.",
			"Each thrust of their head sends a jolt of pleasure through your spine—you're barely holding on.",
			"They devour you with unrelenting need, taking your full length like it belongs there.",
			"Their throat tightens around you with every swallow, pulling groans from your chest with ease.",
			"You feel them drool and gasp around your shaft, their breath ragged between thrusts, completely focused on pleasuring you."
		],
		Disliked: [
			"They gag and pull back quickly, coughing softly and wiping their lips.",
			"'Too deep,' they whisper, voice shaky and unsure.",
			"They try again but their eyes water, and they stop almost immediately.",
			"You sense them hesitating, posture stiff and rhythm broken.",
			"'Maybe just the tip for now,' they say awkwardly, clearly not comfortable going deeper.",
			"They shift back and stroke you instead, avoiding eye contact as the mood falters."
		],
		climax: ["They moan greedily around you, spit dripping from their lips as they deepthroat you over and over."]
	},

	Handjob_Penis_R: {
		start: ["They wrap their hand around your cock, stroking slowly from base to tip."],
		Neutral: [
			"They run their thumb across the head, smearing a bead of pre-cum before gliding back down the shaft.",
			"Their grip is firm but smooth, working you with a slow, deliberate rhythm.",
			"You groan softly as they start to pump your cock, watching your face for every reaction.",
			"They stroke you steadily, letting your arousal build under their practiced touch.",
			"Their hand moves with confident ease, coaxing tension from your body with every stroke."
		],
		Liked: [
			"You buck into their fist, moaning as their strokes grow faster and slicker.",
			"'You like that?' they whisper, twisting their wrist just right on the downstroke.",
			"Your cock pulses in their hand, every squeeze making your hips jerk uncontrollably.",
			"They lock eyes with you as their grip tightens, pace quickening to match your breath.",
			"You gasp as they tease the head with their palm before plunging back into a full stroke.",
			"They work you like they know your body better than you do—every motion perfect."
		],
		Disliked: [
			"Their touch is awkward—too slow, too dry—and your arousal dips slightly.",
			"'Too rough,' you mutter, shifting your hips back with a wince.",
			"They hesitate, watching your face for guidance. 'Is this okay?' they ask.",
			"You feel their grip falter, rhythm stuttering as the chemistry fades.",
			"Their stroking is inconsistent, and you find yourself waiting for it to feel good—but it doesn't.",
			"They sigh and pull back gently, clearly sensing it's not working."
		],
		climax: ["You buck into their fist, moaning as their strokes grow faster and slicker."]
	},

	Handjob_Clit_R: {
		start: ["They slide a hand between your legs, fingers gliding directly to your clit."],
		Neutral: [
			"They circle your clit slowly, testing the pace and watching your every reaction.",
			"Their fingers stroke you with practiced precision, neither too light nor too rough.",
			"They press their thumb over your clit and begin slow, rhythmic motion that sends shivers through your core.",
			"You gasp as they find your clit instantly, teasing it with gentle flicks and steady pressure.",
			"Their touch is patient, methodical—every stroke designed to make you ache."
		],
		Liked: [
			"You moan sharply, hips bucking against their hand.",
			"Their fingers rub you in tight, perfect circles, and your body melts under the pressure.",
			"'There,' you whimper, clinging to the sensation as pleasure builds fast.",
			"They smirk as your thighs twitch with each pass—completely in control of your pleasure.",
			"Your body jerks with every stroke, your clit swollen and desperate for more.",
			"You cry out as their fingers speed up, drawing you closer and closer to the edge with every press."
		],
		Disliked: [
			"You shift your hips, trying to guide them—but their touch feels off.",
			"'Not like that,' you mutter, frustration slipping into your voice.",
			"Their fingers are too rough, and the tension makes it hard to enjoy the moment.",
			"They fumble with their rhythm, and your arousal cools with every awkward stroke.",
			"You flinch slightly—your clit too sensitive for the current pressure.",
			"'Slow down,' you breathe, pulling away instinctively."
		],
		climax: ["You cry out as their fingers speed up, drawing you closer and closer to the edge with every press."]
	},

	Fingering_Vagina_R: {
		start: ["They slide their fingers between your thighs, exploring you with slow, focused intent."],
		Neutral: [
			"You inhale sharply as they slip one finger inside, testing your readiness.",
			"Their touch is gentle but deliberate, coaxing your body with practiced rhythm.",
			"You feel their fingertips curl just right, stroking deep inside with purpose.",
			"Their other hand rests firm on your hip as they work you open with steady pressure.",
			"They move slowly at first, watching your breath and body for every subtle reaction."
		],
		Liked: [
			"You cry out as their fingers find your most sensitive spot, hips bucking to meet their rhythm.",
			"Your body pulses around them, pleasure building fast under their steady attention.",
			"'Right there,' you gasp, clinging to them as the sensation floods through you.",
			"They speed up, and your moans become desperate—you're close and they know it.",
			"Your breath hitches again and again, every stroke deeper, hotter, wetter.",
			"You rock against their hand shamelessly, greedy for every curling motion."
		],
		Disliked: [
			"You flinch as their fingers move awkwardly—too dry, too fast, too much.",
			"'Slow down,' you mutter, trying to adjust but feeling disconnected.",
			"Their rhythm never quite lands, and your body resists the motion.",
			"You shift away, discomfort overriding whatever arousal had started to build.",
			"'That doesn't feel good,' you say, voice tight.",
			"They notice your reaction and pause, concern replacing heat."
		],
		climax: ["You cry out as their fingers find your most sensitive spot, hips bucking to meet their rhythm."]
	},

	Fingering_Anal_R: {
		start: ["They slide their hand lower, circling slowly before applying pressure where you're most sensitive."],
		Neutral: [
			"You gasp as their fingers tease at your entrance, then press in with controlled slowness.",
			"They ease a finger inside you, their other hand resting steady on your hip as your body adjusts.",
			"Their touch is firm but careful, each motion sending a ripple of heat up your spine.",
			"You clench slightly around them, feeling the tension rise with every slow curl of their fingers.",
			"They watch you closely, adjusting their rhythm to match your breathing."
		],
		Liked: [
			"You moan loudly, pressing back against their hand, hungry for more.",
			"Their fingers hit just the right spot, and your hips buck without thought.",
			"You cry out, body trembling as their rhythm builds steadily.",
			"Your breath stutters with every push—you're completely undone by their touch.",
			"You feel your muscles flutter around them, desperate for more friction and depth.",
			"'Don't stop,' you whisper, body clinging to every stroke."
		],
		Disliked: [
			"You wince as they push in too quickly, discomfort blooming sharp and sudden.",
			"'Wait—' you mutter, tension making it hard to breathe.",
			"Your body stiffens involuntarily, clearly not welcoming the intrusion.",
			"You flinch, and they pause immediately, sensing your hesitation.",
			"'This doesn't feel good,' you say, shifting away slightly.",
			"You shake your head, voice tight. 'Not that way, please.'"
		],
		climax: ["You moan loudly, pressing back against their hand, hungry for more."]
	},

	BreastPlay_R: {
		start: ["They cup your breasts gently, brushing their thumbs across your nipples in slow, deliberate circles."],
		Neutral: [
			"Their hands explore your chest with reverent care, gauging your every breath.",
			"They trace their fingers along the curve of your chest, watching for reactions.",
			"They lean in to kiss the top of one breast while their thumb teases the other.",
			"Their hands move confidently across your skin, keeping pressure light and exploratory.",
			"They drag their knuckles gently across your nipples, then cup your breast with their full hand."
		],
		Liked: [
			"You moan softly, arching into their hands as heat blooms beneath their touch.",
			"You whimper when their thumb brushes over your nipple, and your hips squirm in response.",
			"You feel yourself press into their palms, your breathing ragged and needy.",
			"Your nipples harden under their fingers, and you bite your lip as if to stay quiet.",
			"You tilt your head back, eyes closed, mouth parted—lost in the sensation."
		],
		Disliked: [
			"You squirm in their grip, shoulders drawing slightly inward.",
			"Your posture shifts, pulling your chest away from their hands.",
			"'That's... not really my spot,' you murmur, voice flat.",
			"You offer a tight-lipped smile, but there's no passion in it.",
			"You shift uncomfortably beneath their touch, clearly not engaged."
		],
		climax: ["You gasp as pleasure radiates from your chest through your entire body."]
	},

	NipplePlay_R: {
		start: ["They circle a fingertip around one of your nipples, then give it a gentle pinch, gauging your reaction."],
		Neutral: [
			"They drag their thumb lightly across your chest, watching how your skin responds.",
			"Their fingers tease the peak, twisting it slowly between two fingers while their free hand steadies your waist.",
			"They alternate between firm and featherlight pressure, testing what draws the most breath from you.",
			"They let their tongue swirl slowly over the sensitive nub, watching your eyes for flickers of pleasure.",
			"They drag their thumbs over your chest, teasing slow circles around each nipple."
		],
		Liked: [
			"You moan gently, arching into their hand with need.",
			"You gasp when their tongue flicks just right, body visibly shivering.",
			"You moan sharply as their tongue dances over your nipple, back arching in response.",
			"You gasp, hands gripping their shoulders as pleasure sparks through your chest.",
			"Your nipples harden quickly under their touch, you breathe faster with every motion."
		],
		Disliked: [
			"You wriggle away slightly, discomfort flickering in your expression.",
			"'I don't really feel anything there,' you mutter, eyes a bit distant.",
			"You glance away, your chest unmoving as their fingers graze your nipple.",
			"'I'm not really sensitive there,' you murmur, offering a faint smile.",
			"You reach for their wrist, gently moving their hand away from your chest."
		],
		climax: ["Waves of sensation spread from your nipples through your entire body."]
	},

	// ===============================
	// 🔸 ADDITIONAL RESPONSES
	// ===============================

	Cuddling: {
		start: ["You draw them into your arms, your fingers brushing through their hair."],
		Neutral: [
			"They settle beside you, their breath syncing with yours in a quiet rhythm.",
			"You cradle them close, feeling the heat of their form pressed against your chest.",
			"Your hand strokes their back gently, your lips near the crown of their head.",
			"The silence between you is full, peaceful, the weight of them grounding you both.",
			"You both exhale at the same time, the moment suspended in warmth and stillness."
		],
		Liked: [
			"They hum contentedly, nuzzling closer and relaxing in your hold.",
			"They whisper something unintelligible against your skin and squeeze your hand softly.",
			"Their breath brushes your collarbone as they shift into a more comfortable position against you.",
			"They intertwine their fingers with yours and press their cheek to your chest.",
			"They smile faintly, eyes closed, a rare vulnerability in the way they rest against you.",
			"They pull the covers around both of you, burrowing into the warmth of your shared space."
		],
		Disliked: [
			"They shift slightly in your arms, posture stiff and guarded.",
			"They lie against you, but the tension in their shoulders never quite fades.",
			"'I'm not really a cuddler,' they mumble, pulling back a little.",
			"They offer a polite smile but don't settle—like their mind is somewhere else.",
			"They remain still, unmoving, as if waiting for the moment to end.",
			"Your hand moves across their side, but they don't respond—not warmly, at least."
		],
		climax: ["They melt completely into your embrace, all tension leaving their body."]
	},

	Kissing: {
		start: ["Your lips brush gently against theirs, soft and exploratory, inviting more."],
		Neutral: [
			"You lean in, pressing your mouth to theirs in a careful rhythm, testing their response.",
			"You kiss them slowly, your hand brushing through their hair.",
			"Your mouths meet in a quiet exchange, the tension between you thinning with each passing breath.",
			"You cradle their jaw as your lips meet, letting the moment hang delicately in the air.",
			"You linger at the edge of their mouth, your kiss slow, seeking, and cautious."
		],
		Liked: [
			"They melt into the kiss, sighing sweetly against your lips as they press closer.",
			"They moan softly, mouth parting to deepen the kiss, clearly savoring every second.",
			"Their hands slide into your hair as they return the kiss with eager hunger.",
			"They pull you closer with a needy sound, mouth hungry and breath trembling.",
			"They kiss you back fiercely, their body flush against yours, losing themselves in the heat.",
			"Their lips move in perfect sync with yours, a low sound escaping with every breath."
		],
		Disliked: [
			"They turn slightly, deflecting the kiss with a polite but tense smile.",
			"They return the kiss briefly, but the passion isn't there—just motion.",
			"Their lips part just enough to be polite, but their eyes never close.",
			"They exhale slowly through their nose, barely engaging before pulling away.",
			"They give a quick peck and glance off to the side, the intimacy broken.",
			"You feel hesitation in their lips—present, but emotionally elsewhere."
		],
		climax: ["They kiss you with desperate passion, pouring everything into the connection."]
	},

	FaceSit_R: {
		start: ["They climb over you, lowering their body with careful control."],
		Neutral: [
			"You feel the heat of their skin as they settle down over your mouth, steady but cautious.",
			"They straddle your face, hips hovering for a moment before lowering onto you.",
			"Their scent fills your senses as they ease into place, letting you feel every inch of pressure.",
			"They press down slowly, hands bracing against the wall or headboard as they guide your mouth to work.",
			"You grip their thighs as they lower themselves, your breath lost beneath their weight."
		],
		Liked: [
			"They groan loudly, grinding down with abandon as they ride your tongue.",
			"'Fuck yes,' they cry, tightening their grip on your hair as they take control of your mouth.",
			"They moan helplessly above you, thighs trembling as they push harder into your face.",
			"You feel them buck against your tongue, clearly loving every second of it.",
			"They lean back, using your face like a throne, their voice breaking with every movement.",
			"They don't hold back—their rhythm wild and desperate as they smother you with need."
		],
		Disliked: [
			"They hesitate halfway down, tension flickering across their body.",
			"'Wait—I'm not sure about this,' they murmur, backing off quickly.",
			"They lower onto your mouth but never settle, clearly unsure or uncomfortable.",
			"They shift awkwardly, then rise again, the moment fading from heat to hesitation.",
			"Their breathing changes—faster, but not in arousal. You feel the discomfort before they say anything.",
			"'Sorry,' they say gently, climbing off, the tension lingering in the air."
		],
		climax: ["They cry out, grinding down with abandon as they ride your tongue."]
	},

	Spank_R: {
		start: ["They bring their hand down against your backside with a firm, measured slap."],
		Neutral: [
			"You feel the sting ripple across your skin as they spank you with casual dominance.",
			"Their palm lands solidly on your rear, the impact more attention-grabbing than painful.",
			"They give your ass a warning smack, watching your body jolt in response.",
			"You brace as their hand connects, the heat blooming across your rear.",
			"They spank you slowly, deliberately, gauging how you respond to each strike."
		],
		Liked: [
			"You cry out in pleasure as they spank you again, harder this time.",
			"They grin wickedly as they land another slap, clearly enjoying the way your body jumps under their touch.",
			"'You like that, don't you?' they growl, hand cracking down against your skin again.",
			"They rain down sharp, rhythmic smacks, your skin tingling and your body aching for more.",
			"Your breath stutters, ass throbbing as they keep spanking you with increasing intensity.",
			"The pain blends with pleasure, each strike sending heat through your core."
		],
		Disliked: [
			"You flinch as their hand lands, the sting unpleasant and jarring.",
			"'That's too rough,' you mutter, twisting away from their next attempt.",
			"Your breath catches—but not in a good way—as they land another slap.",
			"You wince and pull away slightly, body no longer responding with arousal.",
			"'I'm not into that,' you say quietly, hoping they get the message.",
			"Their hand pauses mid-air as they see the discomfort in your face."
		],
		climax: ["You cry out in pleasure as they spank you again, harder this time."]
	},

	// ===============================
	// 🔸 NPC VERBAL ACTIONS
	// ===============================

	DirtyTalk_NPC: {
		start: ["They lean in close, whispering something low and filthy against your ear."],
		Neutral: [
			"Their voice is rough, curling around you with lewd intent and slow heat.",
			"'You like this, don't you?' they breathe, fingers sliding along your body.",
			"You hear the words, soft and rough at once, threading into your thoughts like a command.",
			"They murmur vivid, obscene promises while pressing their body tightly to yours.",
			"Their words linger in the air—raw, suggestive, just enough to make your breath catch."
		],
		Liked: [
			"Their voice alone makes your knees weak—dirty, teasing, full of control and hunger.",
			"'You're so fucking hot like this,' they growl, and your whole body tightens at the sound.",
			"They moan your name between phrases, the filth pouring from their mouth making you ache.",
			"'Look at you. Desperate for it,' they hiss, clearly loving how their words affect you.",
			"Each syllable makes your skin burn hotter, arousal feeding on every filthy compliment.",
			"You whimper as their words sink in—crude, confident, and exactly what you needed to hear."
		],
		Disliked: [
			"'You like being used, don't you?' they say, but it lands wrong—too sharp, too forced.",
			"You flinch slightly at the tone. It doesn't feel seductive—it feels off.",
			"They say something filthy, but the moment freezes instead of deepening.",
			"You avert your gaze, the words missing your rhythm entirely.",
			"'Let's… not talk like that,' you say, tension rising between breaths.",
			"Their dirty talk feels like performance, not connection—and it jars you out of the moment."
		],
		climax: ["Their filthy words push you over the edge, your body responding to their voice alone."]
	},

	Praise_NPC: {
		start: ["They murmur soft compliments into your hair, each word meant only for you."],
		Neutral: [
			"Their fingers brush down your back as they whisper, 'You're beautiful,' with quiet conviction.",
			"They smile against your neck, letting the warmth of their words wrap around you.",
			"Their tone is low and steady, reverent. 'You're perfect like this,' they breathe.",
			"They cradle your face, locking eyes with you as they tell you exactly how much you mean in this moment.",
			"They speak slowly and clearly, every syllable laced with honest admiration."
		],
		Liked: [
			"You blush fiercely, your eyes shimmering as their words sink in.",
			"You shiver at the praise, mouth parting in a breathless sound between a moan and a sigh.",
			"You whimper softly, as if their voice alone is enough to undo you.",
			"You pull them tighter, as if needing their closeness to match their words.",
			"You melt beneath them, whispering, 'Don't stop saying those things,' voice shaking.",
			"Your body responds before you do, hips twitching slightly, breath catching in pure reaction to being adored."
		],
		Disliked: [
			"You shift awkwardly. 'That's... kind of a lot right now,' you mumble.",
			"You smile, but it's distant. 'You don't have to say all that,' you add, glancing away.",
			"You don't quite respond—shoulders stiff, breath shallow. Something's off.",
			"You laugh quietly but it doesn't reach your eyes. 'Let's focus on what we're doing,' you offer.",
			"You feel yourself recoil slightly at the affection, unsure how to accept the sentiment.",
			"You nod but offer no verbal response—their words may have landed wrong this time."
		],
		climax: ["You melt completely under their praise, overwhelmed by their adoration."]
	},

	// ===============================
	// 🔸 NPC POWER ACTIONS
	// ===============================

	Dominate_NPC: {
		start: ["They shift their weight over you, their gaze steady and commanding as they take the lead."],
		Neutral: [
			"They press you down by the shoulders, asserting their intentions without a word.",
			"Their hand slides to your throat—not to squeeze, just to hold—as they pin you in place.",
			"They take firm hold of your hips, guiding the rhythm with absolute control.",
			"Their body cages you, heat radiating off them as they press forward with slow dominance.",
			"They move deliberately, forcing you to follow their pace and their will."
		],
		Liked: [
			"You gasp, clearly turned on as you yield completely to their control.",
			"You whimper beneath them, eyes glassy with submission and need.",
			"Their grip tightens, and you moan as if the power shift alone pushes you closer to release.",
			"You melt into the sheets, a breathy 'yes' escaping your lips as they press you down.",
			"You look up at them with shining eyes—needy, obedient, desperate for more.",
			"Your breathing quickens as their command takes over, and you seem to blossom under their dominance."
		],
		Disliked: [
			"You stiffen, clearly not responding well to the pressure.",
			"You push back against their grip, discomfort flickering across your features.",
			"You feel yourself tense up, the mood shifting as your eyes narrow.",
			"'That's not how I like it,' you mutter, voice hardening.",
			"You pull away slightly, body defensive rather than inviting.",
			"You meet their stare, unflinching—and not in a good way. The heat between you stutters and fades."
		],
		climax: ["You surrender completely to their dominance, lost in submission."]
	},

	Spank_NPC: {
		start: ["They bring their palm down across your backside with a sharp, satisfying smack."],
		Neutral: [
			"The sound of skin-on-skin rings out as their hand connects with your rear.",
			"They deliver a measured swat to your ass, watching the slight ripple of your form.",
			"Their hand meets your skin with a clean crack, just hard enough to leave a glow behind.",
			"They smack you again, savoring the warmth blooming beneath their fingers.",
			"Their palm strikes your backside, each smack echoing softly in the air between you."
		],
		Liked: [
			"You moan loudly, arching back into their hand, clearly craving more.",
			"You shudder with delight, moans escaping as your ass tingles.",
			"'Harder,' you beg, rocking yourself into the next impact.",
			"Your hips wiggle playfully, skin flushing as they keep you on edge.",
			"You laugh breathlessly, your eyes burning with mischief.",
			"You grip the nearest surface, pushing your form into them for the next slap."
		],
		Disliked: [
			"You jolt, a startled noise escaping. 'That's not really my thing…'",
			"You flinch under their hand, body going still with unease.",
			"Your muscles tighten—not in arousal, but restraint. You say nothing, but your posture speaks volumes.",
			"You feel yourself shift away slightly, tension returning to your spine.",
			"'Let's… skip that,' you mutter, not meeting their gaze.",
			"You breathe out hard, clearly not enjoying the sting."
		],
		climax: ["You cry out in pleasure as they spank you again, harder this time."]
	},

	HairPulling_NPC: {
		start: ["They thread their fingers through your hair, gripping just tight enough to command attention."],
		Neutral: [
			"They curl their fist in your locks and pull gently, tilting your head to expose the soft line of your neck.",
			"Their hand tightens in your hair, just enough to make you pause beneath them.",
			"They tug your head back slowly, watching the tension ripple down your spine.",
			"They take a handful of your hair and guide you where they want, pressure teasing but not cruel.",
			"They fist your hair near the base and tug with slow precision, their breath on your ear."
		],
		Liked: [
			"You gasp, hips bucking at the jolt of control.",
			"You groan with satisfaction, a sound that only deepens when they tug again.",
			"'Yes,' you whisper, eyes darkening with arousal as their grip tightens.",
			"You tilt your head willingly into their hand, offering more of yourself to the pull.",
			"You smile wickedly even as they pull harder—you love the pain laced with pleasure.",
			"Your hands clutch at their arms as they pull, breath hitching with every sharp tug."
		],
		Disliked: [
			"You yelp, twisting out of their grip. 'Not like that,' you snap.",
			"You wince under their hand, body recoiling from the sudden pressure.",
			"'Easy!' you say, reaching back to pry their hand from your hair.",
			"You feel yourself stiffen immediately—whatever thrill you hoped for doesn't land.",
			"You mutter something under your breath and turn your head away.",
			"You shift out of reach, clearly not enjoying the force they're applying."
		],
		climax: ["You cry out as they pull your hair, the pain mixing perfectly with your pleasure."]
	},

	// ===============================
	// 🔸 NPC PENETRATION ACTIONS
	// ===============================

	Anal_NPC_Penetrate: {
		start: ["They line themselves up behind you, one hand guiding themselves as they press carefully forward."],
		Neutral: [
			"You feel the pressure begin to mount as they lean in, slow and cautious against your entrance.",
			"Their hands steady your hips as they begin to push in, testing your readiness with each shallow thrust.",
			"They breathe against your back, waiting just a second longer before starting to press inside.",
			"You brace yourself, feeling the tension as they begin to work into you gradually.",
			"They take their time—focused and deliberate—as they begin the first careful push."
		],
		Liked: [
			"You groan as they sink deeper, their rhythm deliberate and maddeningly slow.",
			"They thrust forward slowly, moaning as your body yields to them, inch by inch.",
			"'You take me so well,' they whisper, fingers digging into your sides as they bury themselves deeper.",
			"They move with practiced ease, hips pressing firmly against your backside.",
			"Each inch fills you more, and they grunt with pleasure as they bottom out.",
			"You cry out as they press fully inside you, panting and rocking their hips just enough to tease."
		],
		Disliked: [
			"You tense as they try to enter—something about the pressure makes your breath hitch in discomfort.",
			"'Wait—stop,' you mutter, body instinctively pulling away.",
			"They hesitate mid-motion, clearly noticing your discomfort.",
			"The moment feels wrong—your body too tight, their hands too firm.",
			"'Not like this,' you breathe, trying to steady yourself.",
			"They slow immediately, concern replacing heat as they ease back from your entrance."
		],
		climax: ["You cry out as they pound into you harder, the pressure pushing you deeper into bliss."]
	},

	Vaginal_NPC_Penetrate: {
		start: ["They position themselves at your entrance, hands steady on your hips as they guide themselves forward."],
		Neutral: [
			"You feel them press against you, testing your readiness before slowly pushing inside.",
			"They enter you with careful control, watching your face for every reaction.",
			"Their grip is firm as they begin to move, the friction sending a sharp pulse through your core.",
			"They thrust with measured pressure, breath hot against your neck as your body adapts.",
			"Each motion stretches you further, the fullness building steadily as they find their rhythm.",
			"Your body jolts slightly with every push, tension and anticipation balancing on the edge of pleasure."
		],
		Liked: [
			"You cry out as their pace quickens, the pressure pushing you deeper into bliss.",
			"Your back arches with each thrust, moaning openly as your body clutches around them.",
			"You beg for more, unable to get enough of their heat driving into you.",
			"They pound into you harder, and your breath breaks into helpless gasps.",
			"You meet every thrust eagerly, gripping the sheets as waves of sensation crash through you.",
			"You feel yourself stretching around them, every push drawing another sharp, delicious cry."
		],
		Disliked: [
			"You wince as the motion grows uncomfortable—your breath shallow and uneven.",
			"'Stop,' you whisper, voice unsteady with unease.",
			"Your body tightens involuntarily, fighting against the pressure.",
			"They pause as you flinch, clearly sensing something's wrong.",
			"The sensation burns—not with pleasure—and you press a hand against their hip to slow them.",
			"You shake your head, the tension in your spine overwhelming whatever arousal had built."
		],
		climax: ["You scream with pleasure as they drive deep, your body convulsing around them."]
	},

	// ===============================
	// 🔸 NPC MANUAL ACTIONS
	// ===============================

	Handjob_Penis_NPC_Tease: {
		start: ["They wrap their fingers around your shaft, stroking slowly with feather-light touches."],
		Neutral: [
			"Their fingertips dance along your length, building tension with each teasing caress.",
			"They tease the head with their thumb, circling the tip before gliding back down the shaft.",
			"You exhale softly as their grip tightens slightly, their pace deliberate and smooth.",
			"They pump their hand along your length, letting the slick friction do its work.",
			"Their wrist flexes just right, drawing soft gasps from you with every upstroke."
		],
		Liked: [
			"You groan and thrust into their hand, clearly desperate for more pressure.",
			"You feel yourself throb in their grip as you beg for them to stroke you properly.",
			"You groan loudly, hips twitching into their grip.",
			"'Just like that,' you pant, voice trembling with arousal.",
			"Your cock pulses in their hand as they stroke faster, your breath coming hard and fast."
		],
		Disliked: [
			"You seem frustrated by the light touches, wanting more stimulation.",
			"Your arousal starts to fade from the insufficient contact.",
			"You shift slightly, their hand not quite finding the rhythm you need.",
			"'Softer,' you say with a strained voice, body tensing under their grip.",
			"Their movements feel off, and you gently pull their hand away."
		],
		climax: ["You pulse in their hand as they finally give you the pressure you need."]
	},

	Handjob_Penis_NPC: {
		start: ["They wrap their fingers around your shaft, stroking slowly from base to tip with firm pressure."],
		Neutral: [
			"Their hand slides easily along your cock, building a steady rhythm as they watch your reactions.",
			"They tease the head with their thumb, circling the tip before gliding back down the shaft.",
			"You exhale softly as their grip tightens slightly, their pace deliberate and smooth.",
			"They pump their hand along your length, letting the slick friction do its work.",
			"Their wrist flexes just right, drawing soft gasps from you with every upstroke."
		],
		Liked: [
			"You groan loudly, hips twitching into their grip.",
			"'Just like that,' you pant, voice trembling with arousal.",
			"Your cock pulses in their hand as they stroke faster, your breath coming hard and fast.",
			"You feel yourself throb between their fingers, the heat building with every pass.",
			"You bite your lip, eyes locked on their hand working your length with practiced care."
		],
		Disliked: [
			"You shift slightly, their hand not quite finding the rhythm you need.",
			"'Softer,' you say with a strained voice, body tensing under their grip.",
			"Their movements feel off, and you gently pull their hand away.",
			"'Let me show you,' you offer, trying to guide their pace.",
			"You wince—their grip might be too dry, or the angle too rough."
		],
		climax: ["You cry out as you pulse in their hand, releasing across their fingers."]
	},

	Fingering_Vagina_NPC: {
		start: ["They slide their fingers between your thighs, exploring you with slow, focused intent."],
		Neutral: [
			"You inhale sharply as they slip one finger inside, testing your readiness.",
			"Their touch is gentle but deliberate, coaxing your body with practiced rhythm.",
			"You feel their fingertips curl just right, stroking deep inside with purpose.",
			"Their other hand rests firm on your hip as they work you open with steady pressure.",
			"They move slowly at first, watching your breath and body for every subtle reaction."
		],
		Liked: [
			"You cry out as their fingers find your most sensitive spot, hips bucking to meet their rhythm.",
			"Your body pulses around them, pleasure building fast under their steady attention.",
			"'Right there,' you gasp, clinging to them as the sensation floods through you.",
			"They speed up, and your moans become desperate—you're close and they know it.",
			"Your breath hitches again and again, every stroke deeper, hotter, wetter.",
			"You rock against their hand shamelessly, greedy for every curling motion."
		],
		Disliked: [
			"You flinch as their fingers move awkwardly—too dry, too fast, too much.",
			"'Slow down,' you mutter, trying to adjust but feeling disconnected.",
			"Their rhythm never quite lands, and your body resists the motion.",
			"You shift away, discomfort overriding whatever arousal had started to build.",
			"'That doesn't feel good,' you say, voice tight.",
			"They notice your reaction and pause, concern replacing heat."
		],
		climax: ["You cry out as their fingers find your most sensitive spot, hips bucking to meet their rhythm."]
	},

	Handjob_Clit_NPC: {
		start: ["They slide a hand between your legs, fingers gliding directly to your clit."],
		Neutral: [
			"They circle your clit slowly, testing the pace and watching your every reaction.",
			"Their fingers stroke you with practiced precision, neither too light nor too rough.",
			"They press their thumb over your clit and begin slow, rhythmic motion that sends shivers through your core.",
			"You gasp as they find your clit instantly, teasing it with gentle flicks and steady pressure.",
			"Their touch is patient, methodical—every stroke designed to make you ache."
		],
		Liked: [
			"You moan sharply, hips bucking against their hand.",
			"Their fingers rub you in tight, perfect circles, and your body melts under the pressure.",
			"'There,' you whimper, clinging to the sensation as pleasure builds fast.",
			"They smirk as your thighs twitch with each pass—completely in control of your pleasure.",
			"Your body jerks with every stroke, your clit swollen and desperate for more.",
			"You cry out as their fingers speed up, drawing you closer and closer to the edge with every press."
		],
		Disliked: [
			"You shift your hips, trying to guide them—but their touch feels off.",
			"'Not like that,' you mutter, frustration slipping into your voice.",
			"Their fingers are too rough, and the tension makes it hard to enjoy the moment.",
			"They fumble with their rhythm, and your arousal cools with every awkward stroke.",
			"You flinch slightly—your clit too sensitive for the current pressure.",
			"'Slow down,' you breathe, pulling away instinctively."
		],
		climax: ["You cry out as their fingers speed up, drawing you closer and closer to the edge with every press."]
	},

	BreastPlay_NPC: {
		start: ["They cup your breasts gently, brushing their thumbs across your nipples in slow, deliberate circles."],
		Neutral: [
			"Their hands explore your chest with reverent care, gauging your every breath.",
			"They trace their fingers along the curve of your chest, watching for reactions.",
			"They lean in to kiss the top of one breast while their thumb teases the other.",
			"Their hands move confidently across your skin, keeping pressure light and exploratory.",
			"They drag their knuckles gently across your nipples, then cup your breast with their full hand."
		],
		Liked: [
			"You moan softly, arching into their hands as heat blooms beneath their touch.",
			"You whimper when their thumb brushes over your nipple, and your hips squirm in response.",
			"You feel yourself press into their palms, your breathing ragged and needy.",
			"Your nipples harden under their fingers, and you bite your lip as if to stay quiet.",
			"You tilt your head back, eyes closed, mouth parted—lost in the sensation."
		],
		Disliked: [
			"You squirm in their grip, shoulders drawing slightly inward.",
			"Your posture shifts, pulling your chest away from their hands.",
			"'That's... not really my spot,' you murmur, voice flat.",
			"You offer a tight-lipped smile, but there's no passion in it.",
			"You shift uncomfortably beneath their touch, clearly not engaged."
		],
		climax: ["You gasp as pleasure radiates from your chest through your entire body."]
	},

	// ===============================
	// 🔸 NPC ORAL ACTIONS
	// ===============================

	Oral_Penis_NPC_Tease: {
		start: ["They brush their lips over your shaft, teasing with warm breath."],
		Neutral: [
			"They let their lips glide lazily along your length, maintaining just enough contact to keep you aching.",
			"They kiss their way across your inner thighs, then flick their tongue gently across your entrance, just enough to make you gasp.",
			"Their breath brushes over your slick heat as their lips close around your clit in a soft, teasing pull.",
			"They trace slow, experimental lines over your chest, gauging where the sensation hits best.",
			"They let the toy vibrate gently against your skin, its presence alone sending subtle tremors through you.",
			"They hover just close enough to keep you aching, each denied moment sharpening your hunger."
		],
		Liked: [
			"They tease every inch of your cock with slow licks and playful flicks of their tongue, drawing moans from deep in your throat.",
			"You groan and thrust into their hand, clearly desperate for more pressure.",
			"You feel yourself throb in their grip as you beg for them to stroke you properly.",
			"They ghost their fingers over your clit just how you love it, watching you twitch with need.",
			"They grind their hips forward with just enough pressure to drive you wild, the tease perfectly cruel.",
			"You whimper and try to push back onto them, desperate for penetration."
		],
		Disliked: [
			"They lightly mouth your shaft, but you seem distracted, barely reacting.",
			"You seem frustrated by the light touches, wanting more stimulation.",
			"Your arousal starts to fade from the insufficient contact.",
			"They toy with your clit, but you barely react, your eyes distant.",
			"They nudge at your ass, but you tense up, clearly not enjoying the attention.",
			"You seem impatient, not enjoying the prolonged teasing."
		],
		climax: ["Your cock throbs against their lips, the teasing too much to bear."]
	},

	Oral_Penis_NPC_Suck: {
		start: ["They take you into their mouth, lips sealing around your length."],
		Neutral: [
			"They work their mouth steadily up and down your shaft, guided by the rhythm of your breath.",
			"They stroke the base of your cock with their hand while their mouth slowly works the top, building rhythm with purpose.",
			"They kiss along the length of your shaft before taking you into their mouth again, letting their breath warm you between motions.",
			"Their tongue explores every inch of your cock, savoring the heat and weight of it against their lips.",
			"They glance up through their lashes as they slowly begin to suck, letting their lips stretch around you with a practiced seal.",
			"They lower their head and run their tongue slowly along the underside of your shaft, teasing the sensitive skin with a gentle lick."
		],
		Liked: [
			"They suck with focused hunger, their tongue swirling and lips tight, earning sharp gasps and helpless thrusts.",
			"You groan deep in your throat, hips twitching as their mouth takes you deeper.",
			"Their hand tangles in your hair, gripping gently as they suck you with growing confidence.",
			"'Fuck,' you gasp, the sound rough and needy as their tongue dances around your shaft.",
			"You moan louder with each bob of their head, unable to stop yourself from thrusting just a little.",
			"Pre-cum beads against their tongue as you pant their name, completely undone by their attention."
		],
		Disliked: [
			"They suck slowly, but your tension suggests it's not quite doing it for you.",
			"You shift awkwardly under them, breath catching not from pleasure but discomfort.",
			"'Wait—' you mutter, voice strained, your hips pulling back.",
			"You sense hesitation in the way you touch their shoulder, not quite pushing but definitely pausing.",
			"You flinch when their teeth scrape unintentionally, and the moment grows tense.",
			"'Can we stop?' you ask, clearly not feeling it anymore."
		],
		climax: ["You twitch and groan in their mouth, spilling warmth across their tongue."]
	},

	Oral_Vagina_NPC: {
		start: ["They lower their head between your legs, their breath hot against your inner thighs."],
		Neutral: [
			"They trail soft kisses up your thighs, pausing just shy of your clit before flicking their tongue tentatively.",
			"You feel their tongue slide along your folds, slow and exploratory, testing what draws a breath from you.",
			"They spread your lips gently with their fingers and place a warm kiss right over your clit.",
			"They start slow, tongue pressing softly against you in careful, deliberate strokes.",
			"Their mouth moves in lazy circles, lips parting to taste every inch of your slick heat."
		],
		Liked: [
			"Your hips jerk as their tongue presses flat and firm against your clit, licking you with hungry precision.",
			"They groan into you, the vibration setting off sparks through your core.",
			"You moan shamelessly, legs trembling as they suck and swirl with practiced ease.",
			"Each stroke of their tongue makes your body jerk—you're already dangerously close.",
			"'Oh fuck,' you pant, clutching at the sheets as they work you over without mercy.",
			"Your fingers twist in their hair as they bury themselves between your legs, relentless and perfect."
		],
		Disliked: [
			"You flinch slightly—they are too rough, too fast, or just… off.",
			"Their tongue flicks aimlessly, missing your clit entirely, and your arousal starts to wane.",
			"They lick you with awkward rhythm, like someone trying to remember instructions, not savor pleasure.",
			"'Stop,' you whisper, breathless—but not in a good way.",
			"They keep going, but the chemistry is gone, and you're left trying to fake your way through it.",
			"You're wet, but not turned on. Their tongue moves, but your mind's already slipping away."
		],
		climax: ["You scream with pleasure as the orgasm rips through you, your body completely out of control."]
	},

	NipplePlay_NPC: {
		start: ["They reach towards your chest and begin to twirl their fingers around the sensitive flesh of your nipple."],
		/* Placeholder - Add more stuff here, lazy. */


	},

	FaceSit_NPC: {
		start: ["They climb over you, lowering their body with careful control."],
		Neutral: [
			"You feel the heat of their skin as they settle down over your mouth, steady but cautious.",
			"They straddle your face, hips hovering for a moment before lowering onto you.",
			"Their scent fills your senses as they ease into place, letting you feel every inch of pressure.",
			"They press down slowly, hands bracing against the wall or headboard as they guide your mouth to work.",
			"You grip their thighs as they lower themselves, your breath lost beneath their weight."
		],
		Liked: [
			"They groan loudly, grinding down with abandon as they ride your tongue.",
			"'Fuck yes,' they cry, tightening their grip on your hair as they take control of your mouth.",
			"They moan helplessly above you, thighs trembling as they push harder into your face.",
			"You feel them buck against your tongue, clearly loving every second of it.",
			"They lean back, using your face like a throne, their voice breaking with every movement.",
			"They don't hold back—their rhythm wild and desperate as they smother you with need."
		],
		Disliked: [
			"They hesitate halfway down, tension flickering across their body.",
			"'Wait—I'm not sure about this,' they murmur, backing off quickly.",
			"They lower onto your mouth but never settle, clearly unsure or uncomfortable.",
			"They shift awkwardly, then rise again, the moment fading from heat to hesitation.",
			"Their breathing changes—faster, but not in arousal. You feel the discomfort before they say anything.",
			"'Sorry,' they say gently, climbing off, the tension lingering in the air."
		],
		climax: ["They cry out, grinding down with abandon as they ride your tongue."]
	},

	// ===============================
	// 🔸 ORGASM ACTIONS
	// ===============================

	Player_Cum_Anal_Inside: {
		start: ["Your rhythm turns frantic as the pressure builds, your release crashing forward uncontrollably."],
		Neutral: [
			"You grip their hips hard as you drive in deep, your body shuddering violently as you release.",
			"Your breath hitches as you slam forward one last time, spilling thick warmth deep into their ass.",
			"You bury yourself fully in them, groaning through clenched teeth as your climax erupts.",
			"With a final thrust, your body goes taut and your release surges inside, hot and heavy.",
			"Your grip tightens as your orgasm rips through you, pumping deep into their tight body.",
			"You thrust deep and freeze, gasping as you unload every pulse of pleasure inside them."
		],
		Liked: [
			"They moan helplessly, pressing back against you as they feel every thick pulse fill them.",
			"'Yes—inside,' they groan, clearly overwhelmed by the rawness of it.",
			"Their body twitches around you, clearly relishing the feeling of being filled so intimately.",
			"They let out a breathless cry, completely surrendering to the intensity of your climax.",
			"They gasp as warmth spreads inside, hips rocking instinctively with each pulse.",
			"They clench tightly around you, clearly loving every messy, hot second of it."
		],
		Disliked: [
			"They gasp sharply and try to pull away, panic in their eyes. 'No, not inside!'",
			"They freeze beneath you, breath caught and body stiff. This wasn't what they wanted.",
			"'What the fuck—why didn't you warn me?' they snap, shoving you away.",
			"They go silent, expression closed off as your warmth floods them.",
			"You feel them pull away quickly, trying to escape the sudden intimacy.",
			"'You weren't supposed to… do that,' they mutter, clearly upset."
		],
		climax: ["You explode deep inside them, your release pulsing as they cry out beneath you."]
	},

	Player_Cum_Vaginal_Inside: {
		start: ["Your rhythm turns frantic as the pressure builds, your release crashing forward uncontrollably."],
		Neutral: [
			"With a guttural groan, you drive deep and spill everything inside.",
			"Your grip tightens as you bury yourself fully, warmth flooding from you in pulsing waves.",
			"Your body tenses hard as you unload inside their core, breath ragged and broken.",
			"You slam into them one last time and let go—filling them completely.",
			"With a gasp and a deep thrust, your climax overtakes you, thick warmth flooding into them."
		],
		Liked: [
			"They cry out as you release inside them, body trembling around you.",
			"'Yes, inside,' they gasp, wrapping their legs around you tighter.",
			"Their breath catches, eyes rolling back as the heat spreads through their core.",
			"They moan wildly, clutching at you as their own climax crashes down in sync with yours.",
			"Their nails dig into your skin, a shuddering moan escaping them as they feel every pulse of your release.",
			"'Fuck, fill me,' they whisper, trembling with satisfaction as you finish deep inside."
		],
		Disliked: [
			"They gasp and try to pull back too late. 'No—pull out!'",
			"They freeze, panic flashing in their eyes as your release fills them.",
			"'What the hell are you doing!?' they yell, shoving at your chest.",
			"Their body stiffens beneath you—there's no pleasure in the tension now.",
			"They push against your hips, clearly trying to escape the contact.",
			"You see hurt and shock in their face, the intimacy breaking instantly."
		],
		climax: ["You explode inside them, your release pulsing deep as they cry out beneath you."]
	},

	Player_Cum_On_Face: {
		start: ["You pull out at the last second, aiming for their face as your release spurts forward."],
		Neutral: [
			"You stroke yourself rapidly as you finish, painting their face with your climax.",
			"Your cock pulses as you release across their cheeks, thick ropes of warmth coating their skin.",
			"You groan as you cum on their face, your release marking them in the most intimate way.",
			"You aim carefully as you finish, your orgasm splashing across their waiting features.",
			"You pull back and stroke yourself to completion, covering their face in your release."
		],
		Liked: [
			"They moan as your cum hits their face, clearly loving being marked by you.",
			"'Yes, cover me,' they gasp, opening their mouth to catch more of your release.",
			"They smile wickedly as you paint their face with your climax, eyes dark with satisfaction.",
			"They reach up to spread your cum across their cheeks, clearly enjoying the mess.",
			"'I love feeling you cum on my face,' they whisper, body trembling with arousal.",
			"They watch hungrily as you finish, licking their lips at the taste of your release."
		],
		Disliked: [
			"They flinch as your cum hits their face, clearly not expecting or wanting it.",
			"'Warn me next time,' they mutter, wiping at their face with distaste.",
			"They turn their head away as you finish, body tense with discomfort.",
			"'That's... not really my thing,' they say quietly, reaching for something to clean up.",
			"They seem uncomfortable with the mess, their arousal clearly fading.",
			"You see them grimace slightly as your release hits their skin."
		],
		climax: ["You cry out as you finish across their face, marking them with your release."]
	},

	Player_Cum_On_Body: {
		start: ["You pull out at the last second, your release spurting across their skin."],
		Neutral: [
			"You stroke yourself rapidly as you finish, painting their body with your climax.",
			"Your cock pulses as you release across their stomach, thick ropes of warmth coating their skin.",
			"You groan as you cum on their chest, your release marking them as yours.",
			"You aim carefully as you finish, your orgasm splashing across their waiting body.",
			"You pull back and stroke yourself to completion, covering them in your release."
		],
		Liked: [
			"They moan as your cum hits their skin, clearly loving being marked by you.",
			"'Yes, cover me,' they gasp, arching to catch more of your release.",
			"They smile wickedly as you paint them with your climax, eyes dark with satisfaction.",
			"They reach down to spread your cum across their skin, clearly enjoying the mess.",
			"'I love feeling you cum on me,' they whisper, body trembling with arousal.",
			"They watch hungrily as you finish, licking their lips at the sight of your release."
		],
		Disliked: [
			"They flinch as your cum hits them, clearly not expecting or wanting it.",
			"'Warn me next time,' they mutter, wiping at their skin with distaste.",
			"They turn their face away as you finish, body tense with discomfort.",
			"'That's... not really my thing,' they say quietly, reaching for something to clean up.",
			"They seem uncomfortable with the mess, their arousal clearly fading.",
			"You see them grimace slightly as your release hits their skin."
		],
		climax: ["You cry out as you finish across their body, marking them with your release."]
	},

	Player_Cum_In_Mouth: {
		start: ["You groan and grip their head tightly as the pressure breaks—you release directly into their mouth."],
		Neutral: [
			"Your hips jerk forward instinctively as warmth spills across their tongue.",
			"You cry out as you finish, pulse after pulse flooding their mouth with your release.",
			"With a sharp gasp, you bury yourself in their throat, unloading every last drop.",
			"You hold them in place, panting as you twitch in their mouth, completely spent.",
			"Your body convulses as you climax, your release filling them so fast they nearly gag."
		],
		Liked: [
			"They groan hungrily, swallowing everything without hesitation.",
			"They moan around you, clearly relishing the taste and warmth you're giving them.",
			"They keep sucking even as you twitch, milking every last drop with practiced ease.",
			"They gaze up at you as they swallow—owning the moment completely.",
			"Their tongue flicks along your shaft even mid-release, moaning like they can't get enough.",
			"They draw back slowly when you're done, licking their lips with a satisfied, sinful smile."
		],
		Disliked: [
			"They jerk back, coughing and gasping. 'Warn me next time!'",
			"They pull away with a grimace, wiping their mouth quickly.",
			"'Ugh, are you serious?' they mutter, clearly not amused.",
			"They spit to the side and look up at you, expression flat. 'That's not okay.'",
			"They look shaken, eyes wide—not with arousal, but discomfort.",
			"They gag suddenly, pushing you back with both hands, trying to recover."
		],
		climax: ["You explode in their mouth, your release pulsing as they swallow every drop."]
	},

	// ===============================
	// 🔸 BREAST ACTIONS
	// ===============================

	Boobjob_G_Tease: {
		start: ["You position yourself between their breasts, letting your shaft rest against their soft skin without moving."],
		Neutral: [
			"You slide your cock slowly between their breasts, barely applying pressure as you tease them both.",
			"Your shaft glides against their chest with featherlight touches, building anticipation with each gentle thrust.",
			"You let the head of your cock brush against their nipples as you move, watching their reaction.",
			"You press their breasts together lightly around your shaft, moving with deliberate slowness.",
			"You trace your length along their cleavage, teasing without giving them the full pressure they might crave."
		],
		Liked: [
			"They moan softly, arching their back to press their breasts more firmly around you.",
			"'Don't tease me like that,' they whisper, clearly wanting more pressure and friction.",
			"They reach up to squeeze their breasts tighter around your cock, encouraging you to thrust harder.",
			"Their nipples harden as you brush against them, and they bite their lip with need.",
			"They look up at you with hungry eyes, clearly loving the slow torment.",
			"'Please, more,' they breathe, pressing their chest up to meet your teasing thrusts."
		],
		Disliked: [
			"They shift uncomfortably beneath you, not quite engaging with the sensation.",
			"'This isn't really doing it for me,' they mutter, glancing away.",
			"They seem distracted, their hands resting limply at their sides.",
			"You feel them tense slightly, the mood cooling as they pull back.",
			"'Maybe we could try something else?' they suggest, voice flat.",
			"Their expression grows distant, clearly not feeling the connection."
		],
		climax: ["They gasp as you finally give them the pressure they've been craving."]
	},

	Boobjob_G: {
		start: ["You thrust between their breasts with firm, steady pressure, your shaft sliding through their cleavage."],
		Neutral: [
			"You grip their breasts and press them around your cock, building a rhythm as you thrust.",
			"Your shaft slides smoothly between their soft flesh, the friction building with each movement.",
			"You watch their face as you fuck their breasts, gauging their reaction to every thrust.",
			"They hold their breasts together for you, creating the perfect channel for your cock.",
			"You thrust steadily, the warmth and softness of their chest driving you closer to the edge."
		],
		Liked: [
			"They moan as you thrust harder, clearly loving the feeling of your cock between their breasts.",
			"'You feel so good,' they gasp, squeezing their breasts tighter around you.",
			"They arch their back, offering more of their chest as you pound between their breasts.",
			"Their eyes are locked on your cock as it appears and disappears in their cleavage.",
			"'Cum on my tits,' they whisper, voice thick with arousal.",
			"They lick their lips as the head of your cock brushes against their mouth with each thrust."
		],
		Disliked: [
			"They wince slightly as you thrust, the pressure uncomfortable rather than pleasurable.",
			"'That's too rough,' they say, trying to adjust the angle.",
			"They seem disconnected from the act, going through the motions without passion.",
			"'I'm not really feeling this,' they admit, voice strained.",
			"You notice their breathing is shallow, tension rather than arousal in their posture.",
			"They gently push your hips back, clearly wanting to stop."
		],
		climax: ["You explode between their breasts, covering their chest with your release."]
	},

	// ===============================
	// 🔸 FEET ACTIONS
	// ===============================

	Footjob_Penis_G_Tease: {
		start: ["You trail your foot along their shaft, barely applying pressure as you explore their length."],
		Neutral: [
			"Your toes brush against the head of their cock, teasing with featherlight touches.",
			"You slide your foot slowly along their length, building tension with each gentle caress.",
			"You use both feet to bracket their shaft, applying just enough pressure to make them ache.",
			"Your arch curves around their cock as you move with deliberate slowness.",
			"You tease the sensitive underside with your toes, watching their hips twitch with need."
		],
		Liked: [
			"They groan and thrust against your feet, clearly desperate for more pressure.",
			"'Don't stop,' they pant, hips bucking as you tease them with your toes.",
			"They grip the sheets as your feet work their shaft, building them up slowly.",
			"'You're driving me crazy,' they whisper, voice thick with arousal.",
			"They watch your feet with hungry eyes, completely captivated by the sensation.",
			"Their cock throbs against your arch as you continue the slow torment."
		],
		Disliked: [
			"They shift awkwardly, clearly not comfortable with the sensation.",
			"'This feels weird,' they mutter, pulling back slightly.",
			"They seem distracted, not really engaging with what you're doing.",
			"'I'm not really into this,' they say, voice apologetic but firm.",
			"You feel them tense up, the mood shifting as they lose interest.",
			"They gently move your feet away, clearly wanting to try something else."
		],
		climax: ["They pulse against your feet as you finally give them the pressure they need."]
	},

	Footjob_Penis_G: {
		start: ["You wrap your feet around their shaft, stroking with firm, steady pressure."],
		Neutral: [
			"You use your arches to create friction as you stroke their cock with your feet.",
			"Your toes curl around the head while your other foot works the shaft.",
			"You build a steady rhythm, your feet sliding along their length with practiced ease.",
			"You press your soles together around their cock, creating the perfect channel.",
			"You alternate between firm strokes and gentle teasing, keeping them on edge."
		],
		Liked: [
			"They moan loudly as your feet work their shaft, hips thrusting to meet your rhythm.",
			"'That feels incredible,' they gasp, completely lost in the sensation.",
			"They watch your feet with fascination, clearly loving every stroke.",
			"'I never knew this could feel so good,' they pant, voice breaking with pleasure.",
			"Their cock pulses between your feet as you stroke faster.",
			"They grip your ankles, guiding your feet to stroke them just right."
		],
		Disliked: [
			"They wince as your feet move awkwardly, the sensation uncomfortable.",
			"'This isn't working for me,' they say, trying to guide your movements.",
			"They seem frustrated, unable to find the right rhythm or pressure.",
			"'Maybe we should try something else,' they suggest, voice strained.",
			"You feel them losing their arousal as the motion becomes mechanical.",
			"They gently stop your feet, clearly not enjoying the experience."
		],
		climax: ["They cry out as they release between your feet, their cum coating your soles."]
	},

	Footjob_Vagina_G_Tease: {
		start: ["You trail your toes along their inner thighs, slowly approaching their most sensitive areas."],
		Neutral: [
			"Your foot brushes against their outer lips, teasing without penetrating.",
			"You use your toes to trace circles around their clit, applying gentle pressure.",
			"Your arch curves against their mound as you tease with slow, deliberate movements.",
			"You slide your foot between their legs, letting them feel your warmth without direct contact.",
			"You tease their entrance with your big toe, circling but not entering."
		],
		Liked: [
			"They moan as your toes find their clit, hips bucking against your foot.",
			"'That's so different,' they gasp, clearly intrigued by the new sensation.",
			"They spread their legs wider, inviting more contact from your exploring foot.",
			"'Don't stop,' they whisper, grinding against your toes.",
			"Their wetness coats your foot as you continue the teasing touches.",
			"They look down at your foot with fascination, aroused by the taboo nature of it."
		],
		Disliked: [
			"They tense up as your foot approaches, clearly uncomfortable with the idea.",
			"'I'm not sure about this,' they mutter, closing their legs slightly.",
			"They seem distracted, unable to relax into the sensation.",
			"'This feels too weird,' they say, gently pushing your foot away.",
			"You feel them withdraw emotionally, the intimacy broken.",
			"They shake their head, clearly not interested in continuing."
		],
		climax: ["They shudder as your toes finally give them the direct pressure they crave."]
	},

	Footjob_Vagina_G: {
		start: ["You press your toes firmly against their clit, beginning to rub with steady pressure."],
		Neutral: [
			"You use your big toe to stroke their clit while your other toes tease their entrance.",
			"Your foot moves with purpose, applying firm pressure to all their sensitive spots.",
			"You build a rhythm with your toes, alternating between their clit and entrance.",
			"Your arch presses against their mound while your toes work their most sensitive areas.",
			"You use your whole foot to stimulate them, exploring every inch of their sex."
		],
		Liked: [
			"They cry out as your toes hit just the right spot, hips grinding against your foot.",
			"'Oh god, that's amazing,' they moan, completely lost in the unique sensation.",
			"They grab your ankle, guiding your foot to stroke them exactly how they like.",
			"'I can't believe how good this feels,' they pant, voice thick with arousal.",
			"Their juices coat your foot as you work them closer to climax.",
			"They watch your foot with hungry eyes, fascinated by their own arousal."
		],
		Disliked: [
			"They wince as your toes press too hard, the sensation uncomfortable.",
			"'That's not quite right,' they say, trying to adjust your position.",
			"They seem unable to relax, tension overriding any potential pleasure.",
			"'I can't get into this,' they admit, voice apologetic.",
			"You feel them pulling away, clearly not enjoying the experience.",
			"They gently move your foot away, preferring more traditional stimulation."
		],
		climax: ["They scream with pleasure as your toes drive them over the edge."]
	},

	Anal_G_Tease: {
			start: ["You rub the tip of your cock against their entrance, teasing them."],
			Neutral: [
					"You circle their hole slowly, making them squirm for more.",
					"Your teasing strokes keep them on edge, eager for penetration."
			],
			Liked: [
					"They push back against you with a needy whine.",
					"The light touches make them beg for you to go deeper."
			],
			Disliked: [
					"They tense up nervously, clearly unsure about anal.",
					"Your teasing doesn't seem to excite them much."
			],
			climax: ["They shiver with anticipation, desperate for you to enter."]
	},

	Anal_G_Penetrate: {
			start: ["You press forward slowly until you're buried in their ass."],
			Neutral: [
					"You thrust carefully, letting them adjust to your size.",
					"Your steady rhythm draws soft moans from them."
			],
			Liked: [
					"They groan as you sink deeper with each thrust.",
					"They meet your hips eagerly, loving the fullness."
			],
			Disliked: [
					"They flinch in discomfort, asking you to slow down.",
					"You feel their body resisting the penetration." 
			],
			climax: ["You drive deep as they cry out, shaking with pleasure."]
	},

	Anal_G_Pound: {
			start: ["You slam into their ass with powerful thrusts."],
			Neutral: [
					"Your hips smack loudly against them with each motion.",
					"You keep a relentless pace that leaves them gasping."
			],
			Liked: [
					"They moan shamelessly as you pound them harder.",
					"They clutch the sheets, overwhelmed by the rough pace."
			],
			Disliked: [
					"They cry out in pain, trying to pull away from you.",
					"The intensity seems too much for them to handle." 
			],
			climax: ["You push them over the edge as you hammer deep inside."]
	},

	Vaginal_G_Tease: {
			start: ["You rub your cock along their slick folds without entering."],
			Neutral: [
					"You slide just the tip in before pulling back teasingly.",
					"Your slow strokes keep them aching for more." 
			],
			Liked: [
					"They whimper for you to hurry up and fuck them.",
					"Their hips chase after you with desperate need." 
			],
			Disliked: [
					"They sigh in frustration at the continued teasing.",
					"Your hesitation seems to dampen their mood." 
			],
			climax: ["Their body trembles, craving the penetration you deny."]
	},

	Vaginal_G_Penetrate: {
			start: ["You ease your cock inside their waiting pussy."],
			Neutral: [
					"You build a smooth rhythm, feeling them grow wetter around you.",
					"Their breath comes faster as you fill them completely." 
			],
			Liked: [
					"They moan your name and rock against your thrusts.",
					"Their legs wrap around you, urging you deeper." 
			],
			Disliked: [
					"They seem tense, the penetration not quite comfortable.",
					"You sense hesitation in their movements." 
			],
			climax: ["They gasp as you thrust deep, pleasure cresting quickly."]
	},

	Vaginal_G_Pound: {
			start: ["You drive into their pussy with hard, fast strokes."],
			Neutral: [
					"Your relentless pace makes wet slaps echo in the room.",
					"You grip their hips to pound them without mercy." 
			],
			Liked: [
					"They scream in ecstasy as you fuck them brutally hard.",
					"Their whole body shakes from the force of your thrusts." 
			],
			Disliked: [
					"They wince with each rough thrust, trying to pull away.",
					"The pace overwhelms them and pleasure quickly fades." 
			],
			climax: ["You keep pounding until they come undone beneath you."]
	},

	Bondage_G: {
			start: ["You bind their wrists securely."],
			Neutral: [
					"The restraints dig in just enough to remind them who's in control.",
					"You tug on the bindings to test their hold." 
			],
			Liked: [
					"They shiver in excitement at being helpless for you.",
					"A moan escapes them as the restraints tighten." 
			],
			Disliked: [
					"They struggle anxiously against the bonds.",
					"The restraints seem to make them uneasy." 
			],
			climax: ["They breathe raggedly, submitting completely to your control."]
	},

	Gag_G: {
			start: ["You slip a gag between their lips."],
			Neutral: [
					"Their muffled noises grow softer as you secure it.",
					"You watch them test the gag with hesitant sounds." 
			],
			Liked: [
					"They moan around the gag, eyes shining with arousal.",
					"Their struggles only seem to turn them on more." 
			],
			Disliked: [
					"They shake their head, clearly not enjoying the gag.",
					"Tears form as they attempt to speak around it." 
			],
			climax: ["Their muffled cries grow frantic as pleasure overtakes them."]
	},

	Blindfold_G: {
			start: ["You cover their eyes with a soft blindfold."],
			Neutral: [
					"They breathe faster, unsure of what you'll do next.",
					"You brush your fingers over their skin to heighten their anticipation." 
			],
			Liked: [
					"They tremble with excitement at the loss of sight.",
					"Every touch makes them gasp, the blindfold amplifying each sensation." 
			],
			Disliked: [
					"They frown uneasily, clearly disliking the darkness.",
					"Their body stays tense, not relaxing into it." 
			],
			climax: ["They shudder, overwhelmed by the sensations they can't predict."]
	},

	Toys_Use: {
			start: ["You press the toy against their body, switching it on."],
			Neutral: [
					"You move the toy slowly, letting them get used to the sensation.",
					"Their breath hitches as you explore sensitive spots." 
			],
			Liked: [
					"They moan loudly, pushing toward the buzzing toy.",
					"The toy has them writhing in moments." 
			],
			Disliked: [
					"They squirm away, clearly not enjoying the toy's feel.",
					"The vibration seems too intense for them." 
			],
			climax: ["The toy drives them quickly toward a shuddering release."]
	},

	WaxPlay_G: {
			start: ["You drip hot wax onto their skin."],
			Neutral: [
					"Small droplets leave red marks that cool quickly.",
					"They gasp softly with each drop of wax." 
			],
			Liked: [
					"They moan at the sting and arch toward the next drop.",
					"The sharp sensation clearly excites them." 
			],
			Disliked: [
					"They hiss in pain and try to pull away from the wax.",
					"Their expression shows they're not enjoying this." 
			],
			climax: ["The mixture of heat and pain leaves them shuddering with desire."]
	},

	Degrade_G: {
			start: ["You let cruel words spill from your lips."],
			Neutral: [
					"You insult them in a low voice, gauging their reaction.",
					"Your degrading comments cut into the moment." 
			],
			Liked: [
					"They whimper at every harsh word, clearly aroused.",
					"Being called names only seems to turn them on." 
			],
			Disliked: [
					"They flinch as your insults hit too close to home.",
					"The degradation wipes the arousal from their eyes." 
			],
			climax: ["Your filthy words push them over the edge."]
	},

	Edge_G: {
			start: ["You slow your movements just as they're about to climax."],
			Neutral: [
					"You keep them hovering on the brink of orgasm.",
					"Your careful control leaves them panting for release." 
			],
			Liked: [
					"They whine desperately as you deny them again and again.",
					"The constant edging has them trembling uncontrollably." 
			],
			Disliked: [
					"Frustration overtakes their pleasure as you keep stopping.",
					"They beg you to finish them, unable to handle the tease." 
			],
			climax: ["When you finally allow it, they explode with overwhelming relief."]
	}
};
/* twine-user-script #51: "convo_prompts.js" */
/* ======================================================
   Conversation Prompt Library
   ------------------------------------------------------
   Random prompt selector for the minigame. Each prompt:
   - Has a theme
   - Adjusts base difficulty
   - Unlocks at a trust+affection threshold
========================================================= */

setup.ConvoPrompts = [

  // Tier 1 - Small Talk, Light Curiosity
  { text: "What's your drink of choice?", theme: "light", baseDifficultyMod: 0, heatTier: 1 },
  { text: "What kind of weather puts you in a good mood?", theme: "light", baseDifficultyMod: 0, heatTier: 1 },
  { text: "If you could have any animal as a companion, what would it be?", theme: "whimsy", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Is there a food you just can't stand?", theme: "quirky", baseDifficultyMod: 0, heatTier: 1 },
  { text: "What's the strangest dream you've ever had?", theme: "weird", baseDifficultyMod: 2, heatTier: 1 },
  { text: "What do you think people misunderstand about you?", theme: "personal", baseDifficultyMod: 2, heatTier: 1 },
  { text: "What's your idea of comfort food?", theme: "quirky", baseDifficultyMod: 0, heatTier: 1 },
  { text: "Tell me a sound that makes you feel calm.", theme: "soft", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What's something small that always makes you smile?", theme: "light", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Are you more of a sunrise or sunset person?", theme: "whimsy", baseDifficultyMod: 0, heatTier: 1 },
  { text: "What's the most unusual habit you have?", theme: "quirky", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Do you talk to yourself? Out loud?", theme: "oddball", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Do you find silence peaceful or uncomfortable?", theme: "introspective", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What do you notice first when you walk into a room?", theme: "perception", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What's your favorite way to waste time?", theme: "quirky", baseDifficultyMod: 0, heatTier: 1 },
  { text: "If money wasn't an issue, what would you do every day?", theme: "dreamy", baseDifficultyMod: 1, heatTier: 1 },
  { text: "What kind of music makes you feel alive?", theme: "personal", baseDifficultyMod: 1, heatTier: 1 },
  { text: "How do you normally spend your nights?", theme: "smalltalk", baseDifficultyMod: 1, heatTier: 1 },
  { text: "Do you believe in fate, or is everything just random?", theme: "philosophy", baseDifficultyMod: 2, heatTier: 1 },
  { text: "What's the last thing that made you laugh really hard?", theme: "joy", baseDifficultyMod: 1, heatTier: 1 },

  // Tier 2 – Flirty, Teasing, Growing Interest
  { text: "Do you think I'm attractive?", theme: "flirty", baseDifficultyMod: 2, heatTier: 2 },
  { text: "What part of your body do you secretly like the most?", theme: "personal", baseDifficultyMod: 2, heatTier: 2 },
  { text: "How would you react if I told you I had a crush on you?", theme: "flirty", baseDifficultyMod: 2, heatTier: 2 },
  { text: "What's the most flattering thing someone's said to you?", theme: "vanity", baseDifficultyMod: 2, heatTier: 2 },
  { text: "What's something subtle that turns you on?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Would you let someone kiss you without asking?", theme: "boundaries", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What does your ideal first kiss look like?", theme: "romantic", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Do you like it when someone takes the lead?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What's your idea of a perfect flirtation?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Have you ever been caught checking someone out?", theme: "tease", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Where would you want someone to touch you during a slow dance?", theme: "suggestive", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What compliment would melt you every time?", theme: "vanity", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Do you like when someone teases you?", theme: "playful", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What's your favorite place to be kissed?", theme: "flirty", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Would you let someone feed you something sweet?", theme: "intimate", baseDifficultyMod: 2, heatTier: 2 },
  { text: "Would you be the one to make the first move?", theme: "challenge", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What kind of looks make your heart skip?", theme: "romantic", baseDifficultyMod: 2, heatTier: 2 },
  { text: "If I leaned in just a little… what would you do?", theme: "intimate", baseDifficultyMod: 3, heatTier: 2 },
  { text: "Would you let someone touch your face?", theme: "boundaries", baseDifficultyMod: 3, heatTier: 2 },
  { text: "What's something someone could say that would fluster you?", theme: "tease", baseDifficultyMod: 3, heatTier: 2 },

  // Tier 3 – Confessional, Vulnerability, Connection
  { text: "What scares you most about getting close to someone?", theme: "vulnerable", baseDifficultyMod: 3, heatTier: 3 },
  { text: "Have you ever fallen for someone you shouldn't have?", theme: "romantic", baseDifficultyMod: 2, heatTier: 3 },
  { text: "Is there a secret you've never told anyone?", theme: "confessional", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What part of yourself do you hide from most people?", theme: "shadow", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What would you do if we were alone right now?", theme: "intimate", baseDifficultyMod: 4, heatTier: 3 },
  { text: "Have you ever been hurt so badly it changed you?", theme: "emotional", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What do you crave more—intimacy or understanding?", theme: "introspective", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What's something that always makes you feel safe?", theme: "comfort", baseDifficultyMod: 3, heatTier: 3 },
  { text: "How do you act when you're falling in love?", theme: "romantic", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What does your ideal night look like—no limits?", theme: "dreamy", baseDifficultyMod: 3, heatTier: 3 },
  { text: "Is there something you've never forgiven yourself for?", theme: "emotional", baseDifficultyMod: 4, heatTier: 3 },
  { text: "Do you trust easily? Or does it take time?", theme: "guarded", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What would hurt you more—being forgotten or being betrayed?", theme: "trust", baseDifficultyMod: 4, heatTier: 3 },
  { text: "What do you miss most about being a child?", theme: "nostalgia", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What kind of touch calms you down the most?", theme: "sensual", baseDifficultyMod: 3, heatTier: 3 },
  { text: "If you could erase one regret, would you do it?", theme: "contemplative", baseDifficultyMod: 2, heatTier: 3 },
  { text: "What would you do if you weren't afraid of failing?", theme: "aspiration", baseDifficultyMod: 3, heatTier: 3 },
  { text: "Do you believe people can really change?", theme: "philosophy", baseDifficultyMod: 3, heatTier: 3 },
  { text: "How do you know when someone truly cares?", theme: "introspective", baseDifficultyMod: 3, heatTier: 3 },
  { text: "What's something beautiful that makes you sad?", theme: "melancholy", baseDifficultyMod: 3, heatTier: 3 },

  // Tier 4 – Romantic, Physical, Sensual
  { text: "Would you let someone undress you with their eyes?", theme: "bold", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you like the sound of your own name on someone else's lips?", theme: "flirty", baseDifficultyMod: 3, heatTier: 4 },
  { text: "What would you do if I leaned in closer right now?", theme: "intimate", baseDifficultyMod: 3, heatTier: 4 },
  { text: "Where do you like being kissed the most?", theme: "sensual", baseDifficultyMod: 4, heatTier: 4 },
  { text: "If I kissed you without warning, would you stop me?", theme: "challenge", baseDifficultyMod: 4, heatTier: 4 },
  { text: "What would you whisper in someone's ear to make them shiver?", theme: "tease", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you like it rough, or slow and teasing?", theme: "sensual", baseDifficultyMod: 4, heatTier: 4 },
  { text: "What's the most intimate moment you've ever shared with someone?", theme: "romantic", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Where would your hands wander first?", theme: "suggestive", baseDifficultyMod: 5, heatTier: 4 },
  { text: "Would you like to be touched like a secret?", theme: "poetic", baseDifficultyMod: 5, heatTier: 4 },
  { text: "Have you ever fantasized about someone in this room?", theme: "fantasy", baseDifficultyMod: 4, heatTier: 4 },
  { text: "If I traced your skin, would you shiver or smirk?", theme: "intimate", baseDifficultyMod: 5, heatTier: 4 },
  { text: "What part of your body do you wish someone adored more?", theme: "vulnerable", baseDifficultyMod: 4, heatTier: 4 },
  { text: "What's the most seductive thing someone's said to you?", theme: "memory", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you want someone who obeys… or someone who leads?", theme: "dominance", baseDifficultyMod: 4, heatTier: 4 },
  { text: "If I said 'touch me,' where would your hands go first?", theme: "command", baseDifficultyMod: 5, heatTier: 4 },
  { text: "If you were told to beg, would you?", theme: "powerplay", baseDifficultyMod: 5, heatTier: 4 },
  { text: "Would you prefer devotion or desire?", theme: "endearment", baseDifficultyMod: 4, heatTier: 4 },
  { text: "Do you like being worshipped?", theme: "worship", baseDifficultyMod: 5, heatTier: 4 },
  { text: "If I pulled you into my lap, what would you do?", theme: "assertive", baseDifficultyMod: 5, heatTier: 4 },

  // Tier 5 – Erotic, Emotional Endgame
  { text: "Do you love me? Be honest.", theme: "serious", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Could you ever see us having a future together?", theme: "endgame", baseDifficultyMod: 5, heatTier: 5 },
  { text: "If I needed you to run away with me, would you?", theme: "commitment", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What would it take for you to give up everything for someone?", theme: "sacrifice", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you still care for me if I lost everything?", theme: "devotion", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If you woke up and I was gone forever, what would you miss most?", theme: "melancholy", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I asked you to disappear with me, would you say yes?", theme: "devotion", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Do you think soulmates are real… and are we?", theme: "endgame", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Could you be happy with just me, and no one else?", theme: "commitment", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you wait a lifetime if it meant we'd be together in the end?", theme: "patience", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I forgot who you were tomorrow, how would you remind me?", theme: "devastation", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Could you walk away from me if it meant I'd be safer?", theme: "sacrifice", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you rather die in my arms, or live not knowing if I loved you?", theme: "tragedy", baseDifficultyMod: 7, heatTier: 5 },
  { text: "If this world burned down tomorrow, would you still choose me?", theme: "rideordie", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What scares you more—losing me or never having me at all?", theme: "attachment", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you still love me if I lost my mind?", theme: "devotion", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What's more important—freedom or loyalty?", theme: "conflict", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I gave you everything, would it be enough?", theme: "yearning", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I whispered 'stay', would you?", theme: "poetic", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Are you mine?", theme: "claiming", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you kneel for someone like me?", theme: "submission", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I pushed you against the wall, would you resist?", theme: "dominance", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Do you want to be ruined slowly… or all at once?", theme: "control", baseDifficultyMod: 7, heatTier: 5 },
  { text: "What would you do if I told you not to make a sound?", theme: "tease", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Where would you want me to bite first?", theme: "nsfw", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you let me use you, if I promised to worship you after?", theme: "powerplay", baseDifficultyMod: 7, heatTier: 5 },
  { text: "If I said 'hands behind your back,' what would you do?", theme: "command", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Do you ache for the kind of touch that leaves bruises or poetry?", theme: "poetic", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you obey if I told you not to move?", theme: "control", baseDifficultyMod: 6, heatTier: 5 },
  { text: "Would you rather moan my name or beg for forgiveness?", theme: "blasphemy", baseDifficultyMod: 8, heatTier: 5 },
  { text: "What would you whisper in my ear if I were on my knees?", theme: "reversal", baseDifficultyMod: 7, heatTier: 5 },
  { text: "What part of your body begs for attention but never asks?", theme: "vulnerable", baseDifficultyMod: 6, heatTier: 5 },
  { text: "If I told you I dreamed of tying you up, would you sleep better or worse tonight?", theme: "fantasy", baseDifficultyMod: 7, heatTier: 5 },
  { text: "Would you still want me if I said you'd have to earn every touch?", theme: "challenge", baseDifficultyMod: 6, heatTier: 5 },
  { text: "What would you let me do… if I said please?", theme: "restraint", baseDifficultyMod: 6, heatTier: 5 }

];

  
  // ================================
  // Select a valid prompt based on relationship
  // ================================
  
  setup.getConvoPrompt = function (npc) {
    const turn = State.temporary.convo?.turn ?? 1;
    const currentHeatTier = Math.min(5, Math.ceil(turn / 5)); // One tier per 5 turns
  
    const valid = setup.ConvoPrompts.filter(p => p.heatTier === currentHeatTier);
    const unseen = setup.ConvoPromptTracker.filterUnseen(valid);
  
    const chosen = unseen.length > 0 ? randomFrom(unseen) : randomFrom(valid);
  
    setup.ConvoPromptTracker.markShown(chosen.text);
    return chosen;
  };
  
  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  
// ================================
// Prompt Tracker (optional enhancement)
// ================================

setup.ConvoPromptTracker = {
    shownThisSession: [],
  
    reset() {
      this.shownThisSession = [];
      console.log("[ConvoPrompt] Tracker reset");
    },
  
    markShown(promptText) {
      this.shownThisSession.push(promptText);
    },
  
    filterUnseen(validPrompts) {
      return validPrompts.filter(p => !this.shownThisSession.includes(p.text));
    }
  };
  
/* twine-user-script #52: "convo_tropes.js" */
/* ======================================================
   Relationship Conversation Minigame Core System
   ------------------------------------------------------
   This system powers the turn-based interaction minigame
   between the player and NPCs, using: 
   - Traits to affect success chances
   - Rapport, Affection, Trust, and Tension stats
   - Motivations to influence prompt theming
   - Gifts to affect rapport/tension
   - Results screen on exit
   - Skill XP gain based on trope usage (1–3 XP)
========================================================= */

// ================================
// Conversation Tropes Definition
// ================================

setup.ConvoTropesByTier = {
  1: [ // Icebreakers, low risk
    {
      key: "joke",
      label: "Tell a Joke",
      skill: "performance",
      baseDifficulty: 8,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "ask_hobby",
      label: "Ask about their hobbies",
      skill: "insight",
      baseDifficulty: 7,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "relate",
      label: "Relate to them",
      skill: "insight",
      baseDifficulty: 8,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "compliment_clothes",
      label: "Compliment their outfit",
      skill: "persuasion",
      baseDifficulty: 9,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "tease_light",
      label: "Tease playfully",
      skill: "performance",
      baseDifficulty: 10,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "stay_silent",
      label: "Stay silent and observe",
      skill: "willpower",
      baseDifficulty: 6,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "make_fun_of_self",
      label: "Poke fun at yourself",
      skill: "wit",
      baseDifficulty: 9,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "ask_question",
      label: "Ask a personal question",
      skill: "insight",
      baseDifficulty: 10,
      effects: { trust: 2 },
      heatTier: 1
    },
    {
      key: "flirt_subtle",
      label: "Flirt (subtle)",
      skill: "persuasion",
      baseDifficulty: 10,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "observe_room",
      label: "Comment on the room",
      skill: "wit",
      baseDifficulty: 7,
      effects: { trust: 1 },
      heatTier: 1
    },
    {
      key: "compliment_eyes",
      label: "Compliment their eyes",
      skill: "persuasion",
      baseDifficulty: 11,
      effects: { affection: 1 },
      heatTier: 1
    },
    {
      key: "open_up_small",
      label: "Share a small truth",
      skill: "insight",
      baseDifficulty: 9,
      effects: { trust: 1 },
      heatTier: 1
    }
  ],
  2: [ // Flirty, bolder
    {
      key: "compliment_scent",
      label: "Compliment their scent",
      skill: "persuasion",
      baseDifficulty: 12,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "eye_contact",
      label: "Hold eye contact",
      skill: "willpower",
      baseDifficulty: 11,
      effects: { trust: 1, affection: 1 },
      heatTier: 2
    },
    {
      key: "comment_smile",
      label: "Compliment their smile",
      skill: "persuasion",
      baseDifficulty: 10,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "ask_romantic_prefs",
      label: "Ask what they're into",
      skill: "insight",
      baseDifficulty: 13,
      effects: { trust: 1 },
      heatTier: 2
    },
    {
      key: "tease_back",
      label: "Tease them right back",
      skill: "performance",
      baseDifficulty: 13,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "flirt_open",
      label: "Openly flirt",
      skill: "persuasion",
      baseDifficulty: 14,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "drop_innuendo",
      label: "Drop a suggestive line",
      skill: "wit",
      baseDifficulty: 15,
      effects: { affection: 2 },
      heatTier: 2
    },
    {
      key: "mention_touch",
      label: "Mention how close they are",
      skill: "observation",
      baseDifficulty: 13,
      effects: { affection: 1 },
      heatTier: 2
    },
    {
      key: "mirror_posture",
      label: "Match their posture",
      skill: "hands",
      baseDifficulty: 10,
      effects: { trust: 1 },
      heatTier: 2
    },
    {
      key: "ask_dating",
      label: "Ask about past relationships",
      skill: "insight",
      baseDifficulty: 14,
      effects: { trust: 2 },
      heatTier: 2
    },
    {
      key: "touch_hand",
      label: "Gently touch their hand",
      skill: "hands",
      baseDifficulty: 16,
      effects: { affection: 3 },
      heatTier: 2
    },
    {
      key: "smile_genuine",
      label: "Smile genuinely",
      skill: "performance",
      baseDifficulty: 10,
      effects: { affection: 1 },
      heatTier: 2
    }
  ],
  3: [ // Emotional, bold, physical
    {
      key: "touch_face",
      label: "Brush a strand of hair aside",
      skill: "hands",
      baseDifficulty: 17,
      effects: { affection: 3 },
      heatTier: 3
    },
    {
      key: "share_secret",
      label: "Share a vulnerable secret",
      skill: "insight",
      baseDifficulty: 16,
      effects: { trust: 3 },
      heatTier: 3
    },
    {
      key: "compliment_body",
      label: "Compliment their body",
      skill: "persuasion",
      baseDifficulty: 17,
      effects: { affection: 2 },
      heatTier: 3
    },
    {
      key: "ask_fantasy",
      label: "Ask about a fantasy",
      skill: "insight",
      baseDifficulty: 18,
      effects: { trust: 2 },
      heatTier: 3
    },
    {
      key: "trace_finger",
      label: "Trace a finger on their arm",
      skill: "hands",
      baseDifficulty: 19,
      effects: { affection: 3 },
      heatTier: 3
    },
    {
      key: "confess_feelings",
      label: "Confess attraction",
      skill: "persuasion",
      baseDifficulty: 17,
      effects: { affection: 3, trust: 1 },
      heatTier: 3
    },
    {
      key: "talk_about_touch",
      label: "Ask how they feel about being touched",
      skill: "insight",
      baseDifficulty: 16,
      effects: { trust: 2 },
      heatTier: 3
    },
    {
      key: "suggest_alone",
      label: "Suggest going somewhere private",
      skill: "persuasion",
      baseDifficulty: 18,
      effects: { affection: 2 },
      heatTier: 3
    },
    {
      key: "touch_back",
      label: "Place a hand on their lower back",
      skill: "hands",
      baseDifficulty: 18,
      effects: { affection: 3 },
      heatTier: 3
    },
    {
      key: "make_promise",
      label: "Promise not to hurt them",
      skill: "willpower",
      baseDifficulty: 17,
      effects: { trust: 2 },
      heatTier: 3
    }
  ],
  4: [ // Intimate, romantic, dominant
    {
      key: "kiss",
      label: "Kiss them",
      skill: "mouth",
      baseDifficulty: 20,
      effects: { affection: 5 },
      heatTier: 4
    },
    {
      key: "bite_lip",
      label: "Bite your lip",
      skill: "performance",
      baseDifficulty: 19,
      effects: { affection: 3 },
      heatTier: 4
    },
    {
      key: "pull_closer",
      label: "Pull them closer",
      skill: "hands",
      baseDifficulty: 20,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "whisper",
      label: "Whisper into their ear",
      skill: "mouth",
      baseDifficulty: 19,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "ask_to_trust",
      label: "Ask them to trust you",
      skill: "persuasion",
      baseDifficulty: 21,
      effects: { trust: 3 },
      heatTier: 4
    },
    {
      key: "confess_lust",
      label: "Confess your desire",
      skill: "persuasion",
      baseDifficulty: 22,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "hand_on_hip",
      label: "Place a hand on their hip",
      skill: "hands",
      baseDifficulty: 21,
      effects: { affection: 4 },
      heatTier: 4
    },
    {
      key: "slide_fingers",
      label: "Slide your fingers over theirs",
      skill: "hands",
      baseDifficulty: 20,
      effects: { affection: 3 },
      heatTier: 4
    },
    {
      key: "let_guard_down",
      label: "Let your guard down",
      skill: "willpower",
      baseDifficulty: 19,
      effects: { trust: 3 },
      heatTier: 4
    }
  ],
  5: [ // 🔞 Explicit, devotional, dominant/submissive
    {
      key: "submit",
      label: "Submit to their touch",
      skill: "willpower",
      baseDifficulty: 23,
      effects: { affection: 4 },
      heatTier: 5
    },
    {
      key: "bite_neck",
      label: "Bite their neck",
      skill: "mouth",
      baseDifficulty: 24,
      effects: { affection: 5 },
      heatTier: 5
    },
    {
      key: "worship",
      label: "Worship them softly",
      skill: "persuasion",
      baseDifficulty: 25,
      effects: { affection: 5, trust: 2 },
      heatTier: 5
    },
    {
      key: "dominant_command",
      label: "Command them to obey",
      skill: "intimidation",
      baseDifficulty: 26,
      effects: { trust: 2, affection: 3 },
      heatTier: 5
    },
    {
      key: "confess_fantasy",
      label: "Confess a fantasy",
      skill: "insight",
      baseDifficulty: 25,
      effects: { affection: 5 },
      heatTier: 5
    },
    {
      key: "pull_into_lap",
      label: "Pull them into your lap",
      skill: "hands",
      baseDifficulty: 26,
      effects: { affection: 5 },
      heatTier: 5
    },
    {
      key: "touch_thigh",
      label: "Touch their thigh",
      skill: "hands",
      baseDifficulty: 24,
      effects: { affection: 4 },
      heatTier: 5
    },
    {
      key: "look_down",
      label: "Look them over slowly",
      skill: "observation",
      baseDifficulty: 22,
      effects: { affection: 4 },
      heatTier: 5
    }
  ]
};
/* twine-user-script #53: "inclinations.js" */
/* ======================================================
   Inclination Library (Sexual Preferences / Kinks)
   ------------------------------------------------------
   These values are used to influence NSFW interactions,
   seduction-based fight actions, scene branching, and
   character compatibility. Future systems will allow 
   toggling content categories per player preference.
========================================================= */

// dev/js/data/inclinations.js
// Refactored to integrate sexual act tags directly for compatibility with NSFW preference logic

setup.Inclinations = {

  vanilla: {
    tags: ["safe", "basic"],
    acts: ["Kissing", "Cuddling", "EyeContact", "Oral_G", "Oral_R", "Vaginal_P"],
    soft: true,
    optional: true
  },

  praise: {
    tags: ["affirmation", "emotional"],
    acts: ["Praise_G", "DirtyTalk_G", "Dominate", "Kissing"],
    likes: ["being adored", "gentle domination"],
    optional: true
  },

  domination: {
    tags: ["dominant"],
    acts: ["Dominate", "Spank_G", "Choke_G", "Bondage_G", "HairPulling_G", "DirtyTalk_G", "OrgasmControl_G"],
    optional: true
  },

  submission: {
    tags: ["submissive"],
    acts: ["Submit", "Bondage_R", "Choke_R", "Spank_R", "HairPulling_R", "OrgasmControl_R"],
    optional: true
  },

  service: {
    tags: ["giving", "obedient"],
    acts: ["Oral_G", "Handjob_G", "Praise_G", "Cuddling", "Toys_Use", "Blindfold_G"],
    optional: true
  },

  exhibitionism: {
    tags: ["exposed", "thrill"],
    acts: ["Exhibition_Solo", "Exhibition_Sex", "Kissing", "FaceSit"],
    optional: true
  },

  voyeurism: {
    tags: ["watching", "observation"],
    acts: ["Voyeurism"],
    optional: true
  },

  roughplay: {
    tags: ["aggressive", "intense"],
    acts: ["Spank_G", "Choke_G", "HairPulling_G", "Bite_G", "Degrade_G"],
    optional: true
  },

  bondage: {
    tags: ["restraint", "control"],
    acts: ["Bondage_G", "Bondage_R", "Gag_Use", "Blindfold_R", "Blindfold_G"],
    optional: true
  },

  sensual: {
    tags: ["tender", "stimulating"],
    acts: ["Lick_Body", "NipplePlay_G", "NipplePlay_R", "Fingering_G", "Fingering_R", "BreastPlay_G", "BreastPlay_R"],
    optional: true
  },

  breeding: {
    tags: ["reproductive", "climax"],
    acts: ["Creampie", "Breeding_Kink", "Creampie_Preference"],
    optional: true
  },

  verbal: {
    tags: ["dirty talk", "expression"],
    acts: ["DirtyTalk_G", "DirtyTalk_R", "Praise_G", "Degrade_G", "Degrade_G"],
    optional: true
  },

  sensory: {
    tags: ["stimulus", "touch"],
    acts: ["Blindfold_R", "Blindfold_G", "WaxPlay"],
    optional: true
  },

  roleplay: {
    tags: ["imaginative", "character-based"],
    acts: ["Roleplay_Master", "Roleplay_Servant", "Roleplay_Teacher", "Roleplay_Stranger"],
    optional: true
  },

  riskplay: {
    tags: ["danger", "excitement"],
    acts: ["Risk_BeingCaught", "PowerImbalance"],
    optional: true
  }

};
/* twine-user-script #54: "motivations.js" */
/* ======================================================
   Motivation Library (Internal Drives / Narrative Goals)
   ------------------------------------------------------
   These define what makes an NPC "tick" and shape:
   - Personal quests
   - Loyalty and betrayal conditions
   - Behavioral patterns in and out of scenes
========================================================= */

setup.Motivations = {
    // Core Motivations
    justice: {
      tags: ["moral", "lawful"],
      notes: "Seeks fairness, hates corruption. May trigger vigilante behavior or formal quests."
    },
    revenge: {
      tags: ["vengeful", "emotional"],
      notes: "Drives actions based on past wrongs. Likely to spark intense personal quests."
    },
    power: {
      tags: ["ambition", "dominance"],
      notes: "Desires authority or superiority. Often manipulative or assertive."
    },
    knowledge: {
      tags: ["intellectual", "curious"],
      notes: "Seeks truth, secrets, arcane lore. May align with Scholar or Witchling archetypes."
    },
    survival: {
      tags: ["primal", "realist"],
      notes: "Wants to live above all. Can make pragmatic or cold decisions."
    },
    family: {
      tags: ["emotional", "relational"],
      notes: "Protective of kin or those they consider family. Likely to abandon duty to save them."
    },
    loyalty: {
      tags: ["duty", "bonded"],
      notes: "Values allegiances and service. Driven by oath, honor, or gratitude."
    },
    legacy: {
      tags: ["ambition", "mortal"],
      notes: "Wants to be remembered. Motivated by creation, influence, or children."
    },
  
    // Romantic / Intimate Motivations
    love: {
      tags: ["romantic", "emotional"],
      notes: "Seeks intimacy, connection. Will follow heart even at great cost."
    },
    lust: {
      tags: ["pleasure", "impulse"],
      notes: "Prioritizes desire, beauty, sex. May interfere with duty or logic."
    },
    thrill: {
      tags: ["risk", "chaotic"],
      notes: "Lives for danger, excitement. Motivated by unpredictability and adrenaline."
    },
  
    // Status-Based / Material
    wealth: {
      tags: ["greed", "material"],
      notes: "Motivated by money, luxuries, or gain. Can bribe, steal, or manipulate."
    },
    fame: {
      tags: ["recognition", "external"],
      notes: "Wants to be admired, known, or praised. May exaggerate deeds."
    },
    freedom: {
      tags: ["independence", "liberty"],
      notes: "Hates constraints. Resists authority and avoids entrapment."
    },
  
    // Kink-Aligned / Subtle Drives
    control: {
      tags: ["dominance", "power"],
      notes: "Wants to control others emotionally, socially, or sexually."
    },
    devotion: {
      tags: ["service", "loyalty"],
      notes: "Finds fulfillment in pleasing others. Can become obsessive."
    },
    shame: {
      tags: ["taboo", "emotional"],
      notes: "Defines self by guilt or desire for punishment. May seek degradation scenes."
    }
  };
  
/* twine-user-script #55: "npc_archetypes.js" */
setup.Archetypes = {
    // Military & Law Enforcement
    "Warden": {
        tags: ["Guard", "Loyal", "Stoic"],
        statRanges: {
            strength: [6, 10],
            charisma: [1, 5],
            insight: [4, 7]
        },
        styles: ["stern", "stoic", "polite"],
        preferredTraits: ["stoic", "loyal", "serious", "confident"],
        preferredMotivations: ["justice", "duty", "loyalty"],
        preferredInclinations: ["vanilla", "domination"],
        description: "Professional guards, soldiers, and law enforcement officers who maintain order."
    },
    
    "Soldier": {
        tags: ["Military", "Disciplined", "Tough"],
        statRanges: {
            strength: [7, 10],
            toughness: [6, 9],
            charisma: [2, 6]
        },
        styles: ["stern", "crude", "stoic"],
        preferredTraits: ["disciplined", "bold", "loyal", "serious"],
        preferredMotivations: ["duty", "survival", "loyalty"],
        preferredInclinations: ["roughplay", "domination", "vanilla"],
        description: "Battle-hardened warriors and military personnel."
    },

    // Entertainment & Social
    "Courtesan": {
        tags: ["Charmer", "Temptress", "Tactician"],
        statRanges: {
            charisma: [7, 10],
            agility: [4, 7],
            intelligence: [5, 8]
        },
        styles: ["seductive", "warm", "theatrical"],
        preferredTraits: ["flirty", "charismatic", "confident", "empathic"],
        preferredMotivations: ["pleasure", "wealth", "power"],
        preferredInclinations: ["seductive", "praise", "exhibitionism"],
        description: "Skilled entertainers who use charm and allure professionally."
    },

    "Bard": {
        tags: ["Artistic", "Charismatic", "Storyteller"],
        statRanges: {
            charisma: [6, 9],
            intelligence: [5, 8],
            agility: [4, 7]
        },
        styles: ["theatrical", "warm", "bubbly"],
        preferredTraits: ["charismatic", "expressive", "curious", "flirty"],
        preferredMotivations: ["fame", "knowledge", "thrill"],
        preferredInclinations: ["exhibitionism", "roleplay", "praise"],
        description: "Musicians, storytellers, and performers who entertain crowds."
    },

    "Merchant": {
        tags: ["Trader", "Persuasive", "Opportunistic"],
        statRanges: {
            charisma: [5, 8],
            intelligence: [6, 9],
            insight: [5, 8]
        },
        styles: ["cunning", "polite", "arrogant"],
        preferredTraits: ["charismatic", "cunning", "confident", "greedy"],
        preferredMotivations: ["wealth", "power", "legacy"],
        preferredInclinations: ["vanilla", "domination", "luxury"],
        description: "Traders and business people focused on profit and deals."
    },

    // Scholarly & Mystical
    "Witchling": {
        tags: ["Arcane", "Unsettling", "Reclusive"],
        statRanges: {
            intelligence: [8, 10],
            insight: [7, 10],
            toughness: [2, 5]
        },
        styles: ["aloof", "scholarly", "cold"],
        preferredTraits: ["curious", "secretive", "detached", "scholarly"],
        preferredMotivations: ["knowledge", "power", "mystery"],
        preferredInclinations: ["sensory", "bondage", "roleplay"],
        description: "Practitioners of arcane arts and mysterious knowledge."
    },

    "Scholar": {
        tags: ["Intellectual", "Bookish", "Analytical"],
        statRanges: {
            intelligence: [7, 10],
            insight: [6, 9],
            strength: [1, 4]
        },
        styles: ["scholarly", "polite", "aloof"],
        preferredTraits: ["curious", "scholarly", "serious", "introverted"],
        preferredMotivations: ["knowledge", "legacy", "truth"],
        preferredInclinations: ["vanilla", "sensual", "intellectual"],
        description: "Researchers, librarians, and academics devoted to learning."
    },

    "Healer": {
        tags: ["Compassionate", "Wise", "Nurturing"],
        statRanges: {
            insight: [7, 10],
            intelligence: [6, 9],
            charisma: [5, 8]
        },
        styles: ["warm", "humble", "scholarly"],
        preferredTraits: ["empathic", "kind", "wise", "nurturing"],
        preferredMotivations: ["healing", "service", "compassion"],
        preferredInclinations: ["vanilla", "sensual", "aftercare"],
        description: "Medical practitioners and healers who tend to the sick and wounded."
    },

    // Working Class
    "Artisan": {
        tags: ["Skilled", "Creative", "Practical"],
        statRanges: {
            agility: [6, 9],
            intelligence: [5, 8],
            strength: [4, 7]
        },
        styles: ["humble", "warm", "crude"],
        preferredTraits: ["creative", "practical", "proud", "hardworking"],
        preferredMotivations: ["craft", "legacy", "pride"],
        preferredInclinations: ["vanilla", "sensual", "praise"],
        description: "Skilled craftspeople who create goods with their hands."
    },

    "Laborer": {
        tags: ["Hardworking", "Strong", "Simple"],
        statRanges: {
            strength: [6, 9],
            toughness: [5, 8],
            intelligence: [2, 6]
        },
        styles: ["crude", "humble", "warm"],
        preferredTraits: ["hardworking", "simple", "loyal", "honest"],
        preferredMotivations: ["survival", "family", "security"],
        preferredInclinations: ["vanilla", "roughplay", "simple"],
        description: "Manual workers who perform physical labor for a living."
    },

    "Farmer": {
        tags: ["Rural", "Practical", "Traditional"],
        statRanges: {
            strength: [5, 8],
            toughness: [6, 9],
            insight: [4, 7]
        },
        styles: ["humble", "warm", "simple"],
        preferredTraits: ["practical", "traditional", "hardworking", "simple"],
        preferredMotivations: ["family", "tradition", "security"],
        preferredInclinations: ["vanilla", "breeding", "traditional"],
        description: "Agricultural workers who tend crops and livestock."
    },

    // Criminal & Underground
    "Thief": {
        tags: ["Sneaky", "Quick", "Opportunistic"],
        statRanges: {
            agility: [7, 10],
            intelligence: [5, 8],
            charisma: [4, 7]
        },
        styles: ["cunning", "aloof", "crude"],
        preferredTraits: ["sneaky", "quick", "opportunistic", "independent"],
        preferredMotivations: ["survival", "freedom", "wealth"],
        preferredInclinations: ["riskplay", "exhibitionism", "roughplay"],
        description: "Pickpockets, burglars, and other petty criminals."
    },

    "Smuggler": {
        tags: ["Secretive", "Daring", "Connected"],
        statRanges: {
            agility: [6, 9],
            charisma: [5, 8],
            intelligence: [6, 9]
        },
        styles: ["cunning", "charming", "secretive"],
        preferredTraits: ["daring", "secretive", "charming", "independent"],
        preferredMotivations: ["wealth", "freedom", "thrill"],
        preferredInclinations: ["riskplay", "domination", "secretive"],
        description: "Those who move illegal goods and information."
    },

    // Religious & Spiritual
    "Priest": {
        tags: ["Holy", "Devoted", "Moral"],
        statRanges: {
            insight: [7, 10],
            charisma: [6, 9],
            intelligence: [5, 8]
        },
        styles: ["humble", "warm", "scholarly"],
        preferredTraits: ["pious", "devoted", "moral", "compassionate"],
        preferredMotivations: ["faith", "service", "salvation"],
        preferredInclinations: ["vanilla", "chastity", "spiritual"],
        description: "Religious clergy devoted to serving their deity and congregation."
    },

    "Cultist": {
        tags: ["Fanatical", "Secretive", "Devoted"],
        statRanges: {
            insight: [5, 8],
            charisma: [4, 7],
            intelligence: [3, 6]
        },
        styles: ["secretive", "intense", "humble"],
        preferredTraits: ["fanatical", "secretive", "devoted", "obsessive"],
        preferredMotivations: ["faith", "power", "transformation"],
        preferredInclinations: ["submission", "ritual", "taboo"],
        description: "Members of fringe religious or mystical groups."
    },

    // Nobility & Upper Class
    "Noble": {
        tags: ["Aristocratic", "Privileged", "Refined"],
        statRanges: {
            charisma: [6, 9],
            intelligence: [5, 8],
            insight: [4, 7]
        },
        styles: ["arrogant", "polite", "theatrical"],
        preferredTraits: ["entitled", "refined", "proud", "charismatic"],
        preferredMotivations: ["power", "legacy", "status"],
        preferredInclinations: ["luxury", "domination", "exhibitionism"],
        description: "Members of the aristocracy with inherited wealth and status."
    },

    "Bureaucrat": {
        tags: ["Administrative", "Methodical", "Political"],
        statRanges: {
            intelligence: [6, 9],
            charisma: [5, 8],
            insight: [5, 8]
        },
        styles: ["polite", "cunning", "scholarly"],
        preferredTraits: ["methodical", "political", "cunning", "ambitious"],
        preferredMotivations: ["power", "order", "advancement"],
        preferredInclinations: ["control", "vanilla", "intellectual"],
        description: "Government officials and administrators who manage bureaucracy."
    },

    // Outcasts & Wanderers
    "Outcast": {
        tags: ["Rejected", "Independent", "Bitter"],
        statRanges: {
            toughness: [6, 9],
            insight: [5, 8],
            charisma: [1, 4]
        },
        styles: ["bitter", "aloof", "crude"],
        preferredTraits: ["bitter", "independent", "guarded", "cynical"],
        preferredMotivations: ["survival", "revenge", "acceptance"],
        preferredInclinations: ["roughplay", "submission", "pain"],
        description: "Those rejected by society who live on the margins."
    },

    "Wanderer": {
        tags: ["Nomadic", "Free", "Experienced"],
        statRanges: {
            agility: [6, 9],
            toughness: [5, 8],
            insight: [6, 9]
        },
        styles: ["free", "warm", "mysterious"],
        preferredTraits: ["free", "experienced", "wise", "independent"],
        preferredMotivations: ["freedom", "adventure", "knowledge"],
        preferredInclinations: ["exhibitionism", "variety", "adventure"],
        description: "Travelers and nomads who roam from place to place."
    },

    // Specialized Roles
    "Innkeeper": {
        tags: ["Hospitable", "Social", "Practical"],
        statRanges: {
            charisma: [5, 8],
            intelligence: [4, 7],
            insight: [5, 8]
        },
        styles: ["warm", "polite", "practical"],
        preferredTraits: ["hospitable", "social", "practical", "observant"],
        preferredMotivations: ["service", "community", "prosperity"],
        preferredInclinations: ["vanilla", "social", "variety"],
        description: "Those who run inns, taverns, and other hospitality businesses."
    },

    "Hunter": {
        tags: ["Tracker", "Patient", "Skilled"],
        statRanges: {
            agility: [7, 10],
            insight: [6, 9],
            strength: [5, 8]
        },
        styles: ["quiet", "practical", "intense"],
        preferredTraits: ["patient", "skilled", "observant", "independent"],
        preferredMotivations: ["survival", "mastery", "nature"],
        preferredInclinations: ["primal", "domination", "natural"],
        description: "Skilled trackers and hunters who live off the land."
    }
};

// Archetype utilities
setup.ArchetypeUtils = {
    // Get random archetype
    getRandomArchetype() {
        const archetypes = Object.keys(setup.Archetypes);
        return archetypes[Math.floor(Math.random() * archetypes.length)];
    },
    
    // Get archetypes by tag
    getArchetypesByTag(tag) {
        return Object.entries(setup.Archetypes)
            .filter(([name, data]) => data.tags.includes(tag))
            .map(([name, data]) => name);
    },
    
    // Get weighted random archetype based on location type
    getArchetypeForLocation(locationType, rng = Math.random) {
        const locationWeights = {
            'tavern': {
                'Innkeeper': 0.3,
                'Bard': 0.2,
                'Merchant': 0.15,
                'Laborer': 0.15,
                'Thief': 0.1,
                'Wanderer': 0.1
            },
            'market': {
                'Merchant': 0.4,
                'Artisan': 0.25,
                'Farmer': 0.15,
                'Thief': 0.1,
                'Laborer': 0.1
            },
            'temple': {
                'Priest': 0.5,
                'Scholar': 0.2,
                'Healer': 0.15,
                'Cultist': 0.1,
                'Noble': 0.05
            },
            'palace': {
                'Noble': 0.4,
                'Bureaucrat': 0.25,
                'Warden': 0.15,
                'Courtesan': 0.1,
                'Scholar': 0.1
            },
            'slums': {
                'Thief': 0.3,
                'Outcast': 0.25,
                'Laborer': 0.2,
                'Smuggler': 0.15,
                'Cultist': 0.1
            },
            'default': {
                'Laborer': 0.2,
                'Merchant': 0.15,
                'Artisan': 0.15,
                'Farmer': 0.1,
                'Warden': 0.1,
                'Thief': 0.1,
                'Innkeeper': 0.05,
                'Scholar': 0.05,
                'Priest': 0.05,
                'Wanderer': 0.05
            }
        };
        
        const weights = locationWeights[locationType] || locationWeights.default;
        return this.weightedRandomArchetype(weights, rng);
    },
    
    // Weighted random selection
    weightedRandomArchetype(weights, rng) {
        const totalWeight = Object.values(weights).reduce((sum, weight) => sum + weight, 0);
        let random = rng() * totalWeight;
        
        for (const [archetype, weight] of Object.entries(weights)) {
            random -= weight;
            if (random <= 0) return archetype;
        }
        
        return Object.keys(weights)[0]; // Fallback
    }
};
/* twine-user-script #56: "npc_names.js" */
setup.NamePools = {
    human: {
        male: [
            "Joren", "Thalen", "Bryce", "Damas", "Garrett", "Marcus", "Aldric", "Roderick", 
            "Willem", "Cassius", "Dorian", "Lucian", "Tristan", "Adrian", "Cedric", "Magnus",
            "Kieran", "Bastian", "Evander", "Lysander", "Orion", "Caspian", "Leander", "Darius"
        ],
        female: [
            "Lira", "Vaelyn", "Mira", "Seris", "Elara", "Lyanna", "Cordelia", "Isadora",
            "Vivienne", "Celeste", "Aurelia", "Seraphina", "Evangeline", "Rosalind", "Ophelia", "Beatrice",
            "Genevieve", "Arabella", "Penelope", "Anastasia", "Valentina", "Cassandra", "Octavia", "Persephone"
        ],
        surnames: [
            "Blackwood", "Ashford", "Thornfield", "Ravencrest", "Goldmane", "Ironhold", "Stormwind", "Brightblade",
            "Shadowmere", "Roseheart", "Silverton", "Darkwater", "Moonwhisper", "Sunforge", "Nightfall", "Dawnbreaker",
            "Frostborn", "Emberstone", "Starweaver", "Bloodraven", "Whitehawk", "Greycloak", "Redmane", "Bluestone"
        ]
    },
    
    elf: {
        male: [
            "Thalor", "Caelith", "Aerendel", "Silvyr", "Aelar", "Aramil", "Aerdyl", "Ahvak",
            "Berrian", "Carric", "Dayereth", "Enna", "Galinndan", "Hadarai", "Halimath", "Heian",
            "Himo", "Immeral", "Ivellios", "Korfel", "Lamlis", "Laucian", "Mindartis", "Naal"
        ],
        female: [
            "Sylria", "Nimaris", "Vaelra", "Adrie", "Althaea", "Anastrianna", "Andraste", "Antinua",
            "Bethrynna", "Birel", "Caelynn", "Dara", "Enna", "Galinndan", "Hadarai", "Halimath",
            "Heian", "Himo", "Immeral", "Ivellios", "Jelenneth", "Keyleth", "Laucian", "Mialee"
        ],
        surnames: [
            "Amakir", "Amakyr", "Galanodel", "Holimion", "Liadon", "Meliamne", "Nailo", "Siannodel",
            "Xiloscient", "Alderleaf", "Brushgather", "Goodbarrel", "Greenbottle", "High-hill", "Hilltopple", "Leagallow",
            "Tealeaf", "Thorngage", "Tosscobble", "Underbough", "Moonwhisper", "Stargazer", "Dawnstrider", "Nightbreeze"
        ]
    },
    
    half_orc: {
        male: [
            "Khazar", "Velmuth", "Zereth", "Dench", "Feng", "Gell", "Henk", "Holg",
            "Imsh", "Keth", "Krusk", "Mhurren", "Ront", "Shump", "Thokk", "Trag",
            "Ugarth", "Vrok", "Yurk", "Zorgh", "Grosh", "Morg", "Thrak", "Grok"
        ],
        female: [
            "Lilitha", "Zaria", "Nyx", "Baggi", "Emen", "Engong", "Kansif", "Myev",
            "Neega", "Ovak", "Ownka", "Shautha", "Sutha", "Vola", "Volen", "Yevelda",
            "Zorga", "Grenda", "Murga", "Thessa", "Ursa", "Vasha", "Yeska", "Zula"
        ],
        surnames: [
            "Ironjaw", "Bloodfist", "Skullcrusher", "Bonegnawer", "Fleshrender", "Goretusk", "Grimaxe", "Hardknuckle",
            "Ironhide", "Jawtooth", "Knuckledragger", "Meatripper", "Necksnapper", "Orcbane", "Painbringer", "Quickfist",
            "Rageclaw", "Skullsplitter", "Toothbreaker", "Warcry", "Battleborn", "Stormfury", "Ironwill", "Strongarm"
        ]
    },
    
    dwarf: {
        male: [
            "Adrik", "Alberich", "Baern", "Barendd", "Brottor", "Bruenor", "Dain", "Darrak",
            "Delg", "Eberk", "Einkil", "Fargrim", "Flint", "Gardain", "Harbek", "Kildrak",
            "Morgran", "Orsik", "Oskar", "Rangrim", "Rurik", "Taklinn", "Thoradin", "Thorek",
            "Tordek", "Traubon", "Travok", "Ulfgar", "Veit", "Vondal"
        ],
        female: [
            "Amber", "Bardryn", "Diesa", "Eldeth", "Gunnloda", "Gyre", "Helja", "Hlin",
            "Kathra", "Kristryd", "Ilde", "Liftrasa", "Mardred", "Riswynn", "Sannl", "Torbera",
            "Torgga", "Vistra", "Welma", "Werydd", "Whurbin", "Yurgunn", "Zulma", "Zurga"
        ],
        surnames: [
            "Battlehammer", "Brawnanvil", "Dankil", "Fireforge", "Frostbeard", "Gorunn", "Holderhek", "Ironfist",
            "Loderr", "Lutgehr", "Rumnaheim", "Strakeln", "Torunn", "Ungart", "Axebreaker", "Battleborn",
            "Coppershield", "Deepdelver", "Goldbeard", "Ironforge", "Stonebreaker", "Thunderstrike", "Warforge", "Gemcutter"
        ]
    },
    
    halfling: {
        male: [
            "Alton", "Ander", "Cade", "Corrin", "Eldon", "Errich", "Finnan", "Garret",
            "Lindal", "Lyle", "Merric", "Milo", "Osborn", "Perrin", "Reed", "Roscoe",
            "Wellby", "Wendel", "Wilbur", "Wren", "Bingo", "Bungo", "Drogo", "Frodo"
        ],
        female: [
            "Andry", "Bree", "Callie", "Cora", "Euphemia", "Jillian", "Kithri", "Lavinia",
            "Lidda", "Merla", "Nedda", "Paela", "Portia", "Seraphina", "Shaena", "Trym",
            "Vani", "Verna", "Belladonna", "Camellia", "Daisy", "Lily", "Poppy", "Rose"
        ],
        surnames: [
            "Brushgather", "Goodbarrel", "Greenbottle", "High-hill", "Hilltopple", "Leagallow", "Tealeaf", "Thorngage",
            "Tosscobble", "Underbough", "Appleblossom", "Berryfield", "Cloverhill", "Dandelion", "Eveningstar", "Fairwind",
            "Goldleaf", "Honeysuckle", "Ivybrook", "Meadowbrook", "Peachbottom", "Quickstep", "Sweetwater", "Willowbend"
        ]
    },
    
    half_demon: {
        male: [
            "Khazar", "Velmuth", "Zereth", "Azazel", "Belphegor", "Caim", "Dagon", "Erebus",
            "Forneus", "Gusion", "Haures", "Ipos", "Jinn", "Kobal", "Leraje", "Malphas",
            "Naberius", "Orias", "Paimon", "Qemuel", "Raum", "Seere", "Tannin", "Uvall"
        ],
        female: [
            "Lilitha", "Zaria", "Nyx", "Agares", "Beleth", "Camio", "Dantalion", "Eligos",
            "Furfur", "Glasya", "Haagenti", "Istaroth", "Jezebeth", "Kimaris", "Lilith", "Marchosias",
            "Naberius", "Oriax", "Phenex", "Qetesh", "Ronove", "Sitri", "Tiamat", "Vassago"
        ],
        surnames: [
            "Hellborn", "Soulrender", "Voidwalker", "Shadowbane", "Nightfall", "Doomwhisper", "Darkflame", "Bloodthorn",
            "Grimheart", "Netherbane", "Voidcaller", "Shadowmend", "Darkweaver", "Soulforge", "Hellfire", "Demonbane",
            "Abyssal", "Infernal", "Cursed", "Damned", "Fallen", "Forsaken", "Wicked", "Sinister"
        ]
    }
};

// Regional name variations (could be expanded for different cultures within races)
setup.RegionalNameVariants = {
    human: {
        northern: {
            male: ["Bjorn", "Erik", "Gunnar", "Harald", "Ivar", "Leif", "Magnus", "Olaf", "Ragnar", "Sven"],
            female: ["Astrid", "Brynhild", "Freydis", "Gudrun", "Helga", "Ingrid", "Ragnhild", "Sigrid", "Solveig", "Thora"],
            surnames: ["Ironside", "Bloodaxe", "Stormborn", "Wolfsbane", "Ravenclaw", "Frostbeard", "Winterhold", "Icebreaker"]
        },
        southern: {
            male: ["Alessandro", "Dante", "Emilio", "Francesco", "Giovanni", "Lorenzo", "Marco", "Matteo", "Nicolo", "Stefano"],
            female: ["Alessandra", "Bianca", "Caterina", "Francesca", "Giulia", "Isabella", "Lucia", "Maria", "Sophia", "Valentina"],
            surnames: ["Medici", "Borgia", "Visconti", "Montague", "Capulet", "Romano", "Rossi", "Bianchi", "Ferrari", "Ricci"]
        },
        eastern: {
            male: ["Alexei", "Boris", "Dmitri", "Igor", "Ivan", "Mikhail", "Nikolai", "Pavel", "Sergei", "Vladimir"],
            female: ["Anastasia", "Ekaterina", "Irina", "Katarina", "Natasha", "Olga", "Svetlana", "Tatiana", "Yelena", "Zoya"],
            surnames: ["Volkov", "Petrov", "Ivanov", "Smirnov", "Kuznetsov", "Popov", "Sokolov", "Lebedev", "Kozlov", "Novikov"]
        }
    }
};

// Name generation utilities
setup.NameUtils = {
    // Get a random name from a specific pool
    getRandomName(race, gender, region = null) {
        let pool = setup.NamePools[race];
        
        // Check for regional variants
        if (region && setup.RegionalNameVariants[race] && setup.RegionalNameVariants[race][region]) {
            pool = setup.RegionalNameVariants[race][region];
        }
        
        if (!pool || !pool[gender]) {
            console.warn(`No name pool found for ${race}/${gender}${region ? `/${region}` : ''}`);
            return "Unknown";
        }
        
        const firstName = pool[gender][Math.floor(Math.random() * pool[gender].length)];
        let fullName = firstName;
        
        // Add surname if available
        if (pool.surnames) {
            const surname = pool.surnames[Math.floor(Math.random() * pool.surnames.length)];
            fullName = `${firstName} ${surname}`;
        } else if (setup.NamePools[race].surnames) {
            const surname = setup.NamePools[race].surnames[Math.floor(Math.random() * setup.NamePools[race].surnames.length)];
            fullName = `${firstName} ${surname}`;
        }
        
        return fullName;
    },
    
    // Generate a culturally appropriate name with regional consideration
    generateCulturalName(race, gender, region = null, rng = Math.random) {
        let pool = setup.NamePools[race];
        
        // Check for regional variants
        if (region && setup.RegionalNameVariants[race] && setup.RegionalNameVariants[race][region]) {
            pool = setup.RegionalNameVariants[race][region];
        }
        
        if (!pool || !pool[gender]) {
            console.warn(`No name pool found for ${race}/${gender}${region ? `/${region}` : ''}`);
            return "Unknown";
        }
        
        const firstName = pool[gender][Math.floor(rng() * pool[gender].length)];
        let fullName = firstName;
        
        // Add surname if available
        if (pool.surnames) {
            const surname = pool.surnames[Math.floor(rng() * pool.surnames.length)];
            fullName = `${firstName} ${surname}`;
        } else if (setup.NamePools[race].surnames) {
            const surname = setup.NamePools[race].surnames[Math.floor(rng() * setup.NamePools[race].surnames.length)];
            fullName = `${firstName} ${surname}`;
        }
        
        return fullName;
    }
};
/* twine-user-script #57: "personality_traits.js" */
/* ======================================================
   Personality Trait Library (Core Behavioral / Emotional Traits)
   --------------------------------------------------------------
   These traits shape daily behavior, conversation dynamics,
   emotional response patterns, and flavor interactions.
========================================================= */

setup.PersonalityTraits = {
    optimistic: { conflicts: ["pessimistic"], tags: ["emotional"] },
    pessimistic: { conflicts: ["optimistic"], tags: ["emotional"] },
    stoic: { conflicts: ["expressive"], tags: ["emotional"] },
    expressive: { conflicts: ["stoic"], tags: ["emotional"] },
    cheerful: { tags: ["emotional"] },
    melancholic: { tags: ["emotional"] },
    cynical: { conflicts: ["idealistic"], tags: ["emotional"] },
    idealistic: { conflicts: ["cynical"], tags: ["emotional"] },
    empathic: { tags: ["emotional"] },
    detached: { conflicts: ["empathic"], tags: ["emotional"] },
  
    goofy: { conflicts: ["serious"], tags: ["social"] },
    serious: { conflicts: ["goofy"], tags: ["social"] },
    charismatic: { tags: ["social"] },
    awkward: { tags: ["social"] },
    introverted: { conflicts: ["extroverted"], tags: ["social"] },
    extroverted: { conflicts: ["introverted"], tags: ["social"] },
    polite: { conflicts: ["crude"], tags: ["social"] },
    crude: { conflicts: ["polite"], tags: ["social"] },
    jealous: { tags: ["emotional"] },
    insecure: { tags: ["emotional"] },
    confident: { tags: ["emotional"] },
    flirty: { tags: ["social"] },
    guarded: { conflicts: ["flirty"], tags: ["emotional"] },
    affectionate: { tags: ["emotional"] },
    ruthless: { conflicts: ["kind", "empathic"], tags: ["emotional"] },
    kind: { conflicts: ["ruthless"], tags: ["emotional"] },
    dominant: { conflicts: ["submissive"], tags: ["social"] },
    submissive: { conflicts: ["dominant"], tags: ["social"] },
    independent: { conflicts: ["clingy"], tags: ["emotional"] },
    clingy: { conflicts: ["independent"], tags: ["emotional"] },
  
    anxious: { conflicts: ["bold"], tags: ["emotional"] },
    bold: { conflicts: ["anxious"], tags: ["emotional"] },
    secretive: { tags: ["emotional"] },
    trusting: { tags: ["emotional"] },
    judgmental: { tags: ["emotional"] },
    curious: { tags: ["mental"] },
    routineOriented: { tags: ["quirk"] },
    chaotic: { tags: ["quirk"] },
    possessive: { tags: ["emotional"] },
    detachedRomantic: { tags: ["romantic"] },
    loveBombing: { tags: ["romantic"] },
  
    entitled: { conflicts: ["humble"], tags: ["class"] },
    humble: { conflicts: ["entitled"], tags: ["class"] },
    pious: { tags: ["moral"] },
    hedonistic: { tags: ["moral", "social"] },
    militant: { tags: ["social"] },
    scholar: { tags: ["intellectual"] },
    merchant: { tags: ["social"] }
  };
  
/* twine-user-script #58: "social_styles.js" */
/* ======================================================
   Social Style Library (Tone, Mannerisms, Social Presence)
   ------------------------------------------------------
   Affects how NPCs present themselves socially — their
   tone, word choice, mannerisms, and general vibe.
   Often blends with class, personality, or upbringing.
   Does NOT directly influence conversation mechanics.
========================================================= */

setup.SocialStyles = {
    warm: {
      tags: ["friendly", "open"],
      notes: "Speaks kindly, often smiles, tends to put others at ease."
    },
    cold: {
      tags: ["distant", "guarded"],
      notes: "Rarely emotive, hard to read, often blunt."
    },
    polite: {
      tags: ["formal", "measured"],
      notes: "Courteous and restrained, avoids vulgarity or informality."
    },
    crude: {
      tags: ["vulgar", "casual"],
      notes: "Swears, jokes off-color, generally relaxed in speech."
    },
    seductive: {
      tags: ["flirty", "charming"],
      notes: "Uses innuendo, body language, and tone to entice."
    },
    arrogant: {
      tags: ["haughty", "entitled"],
      notes: "Talks down to others, may use elevated or dismissive language."
    },
    humble: {
      tags: ["meek", "respectful"],
      notes: "Deferential, often puts themselves second, avoids spotlight."
    },
    theatrical: {
      tags: ["dramatic", "expressive"],
      notes: "Big hand gestures, vivid language, flair for storytelling."
    },
    stern: {
      tags: ["strict", "firm"],
      notes: "Controlled voice, serious tone, rarely jokes."
    },
    aloof: {
      tags: ["disengaged", "quiet"],
      notes: "Short answers, little emotion, easily distracted."
    },
    bubbly: {
      tags: ["energetic", "playful"],
      notes: "Talks fast, giggles, prone to tangents or excitement."
    },
    stoic: {
      tags: ["reserved", "emotionless"],
      notes: "Rarely shows emotion even under stress, speaks flatly."
    },
    scholarly: {
      tags: ["academic", "precise"],
      notes: "Careful wording, references theory or history, avoids slang."
    },
    cunning: {
      tags: ["subtle", "manipulative"],
      notes: "May flatter or provoke to gain an edge, reads people quickly."
    }
  };
/* twine-user-script #59: "DataAuditor.js" */
setup.DataAuditor = {
    listUniqueValues(objectArray, property) {
      const values = objectArray.flatMap(item => {
        if (Array.isArray(item[property])) {
          return item[property].map(val => val.toLowerCase());
        } else if (item[property] !== undefined) {
          return [item[property].toLowerCase()];
        } else {
          return [];
        }
      });
      const uniqueValues = [...new Set(values)];
      console.log(`✅ Unique "${property}" values (${uniqueValues.length} total):`, uniqueValues.sort());
      return uniqueValues;
    },
  
    compareValues(listA, listB) {
      const lowerA = listA.map(val => val.toLowerCase());
      const lowerB = listB.map(val => val.toLowerCase());
      const missingFromB = lowerA.filter(val => !lowerB.includes(val));
      const missingFromA = lowerB.filter(val => !lowerA.includes(val));
      console.group("🧹 Data Comparison Results:");
      console.log("In A but missing from B:", missingFromB.length ? missingFromB : "None");
      console.log("In B but missing from A:", missingFromA.length ? missingFromA : "None");
      console.groupEnd();
    },
  
    auditMultipleArrays(arrays, property) {
      const merged = arrays.flat();
      return this.listUniqueValues(merged, property);
    },

    
  };
  window.audit = {
    prompts: {
      themes() {
        return setup.DataAuditor.listUniqueValues(setup.ConvoPrompts, "theme");
      },
      difficultyMods() {
        return setup.DataAuditor.listUniqueValues(setup.ConvoPrompts, "baseDifficultyMod");
      }
    },
    characters: {
      trustAndAffection() {
        const chars = State.variables.characters || {};
        console.group("🧡 Character Trust and Affection Levels:");
        Object.entries(chars).forEach(([id, char]) => {
          console.log(`${id}: Trust=${char.trust ?? 0} | Affection=${char.affection ?? 0}`);
        });
        console.groupEnd();
      }
    },
    
    tropes: {
      skills() {
        const allTropes = [
          ...setup.ConvoTropesByTier[1],
          ...setup.ConvoTropesByTier[2],
          ...setup.ConvoTropesByTier[3],
          ...setup.ConvoTropesByTier[4],
          ...setup.ConvoTropesByTier[5]
        ];
        return setup.DataAuditor.listUniqueValues(allTropes, "skill");
      },
      effects() {
        const allTropes = [].concat(
          ...Object.values(setup.ConvoTropesByTier)
        );
        const flatKeys = allTropes.flatMap(t => Object.keys(t.effects || {}));
        const unique = [...new Set(flatKeys)];
        console.log("Unique effect keys:", unique.sort());
        return unique;
      }
    },
  
    compare: {
      themesToTraits() {
        const themes = setup.DataAuditor.listUniqueValues(setup.ConvoPrompts, "theme");
        const allTraits = Object.values(State.variables.characters)
          .flatMap(c => c.traits || []);
        const traits = [...new Set(allTraits.map(t => t.toLowerCase()))];
        setup.DataAuditor.compareValues(themes, traits);
      }
    }
  };
  
/*
===========================================================
🧠 DataAuditor.js — Dev Cheatsheet
Quick reference for running audits and comparisons
===========================================================

✅ Quick Natural Language Macros:

audit.prompts.themes();            → List all unique prompt themes
audit.prompts.difficultyMods();     → List all prompt difficulty modifiers
audit.tropes.skills();              → List all skills used in tropes across all tiers
audit.tropes.effects();             → List all unique trust/affection effect keys
audit.compare.themesToTraits();     → Compare prompt themes vs NPC traits

-----------------------------------------------------------

✅ Print a live help menu anytime:
audit.help();

-----------------------------------------------------------

🧠 Run these in your browser's DevTools Console
after compiling your game with Tweego and loading index.html.

Pro Tip: You can suppress duplicate console returns by prefixing commands with 'void'.

Example:
void audit.prompts.themes();

===========================================================
*/

/* twine-user-script #60: "random-event.js" */
// repository: https://github.com/TweePower/twee-sugarcube-random-events

const debugLevel = 3; // max debug level

(function () {
    'use strict';

    /*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
var RandomEventAppExport;
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/ConstraintsVerificator.ts":
/*!***************************************!*\
  !*** ./src/ConstraintsVerificator.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ ConstraintsVerificator)\n/* harmony export */ });\n/* harmony import */ var _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./DebugLogCollector */ \"./src/DebugLogCollector.ts\");\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n\n\nclass ConstraintsVerificator {\n    constructor(sugarcubeFacade, tagsManager, randomEventStats) {\n        this.sugarcubeFacade = sugarcubeFacade;\n        this.tagsManager = tagsManager;\n        this.randomEventStats = randomEventStats;\n    }\n    verify(randomEvent, compiledTags, rewriteConfiguration) {\n        var _a, _b, _c;\n        let result = true;\n        let usedLimitationStrategyTags = [];\n        const debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        if (rewriteConfiguration.isValidateIsEnable === false) {\n            debugLogCollector.addLog(true, 'skip IsEnable verify', 2);\n        }\n        else {\n            const checkResult = this.verifyIsEnable((_a = rewriteConfiguration.isEnabled) !== null && _a !== void 0 ? _a : randomEvent.isEnabled);\n            result = checkResult.result;\n            debugLogCollector\n                .addLog(checkResult.result, `verify IsEnable using: ${rewriteConfiguration.isEnabled ? 'rewrite configuration' : 'passage metadata'}`, 2)\n                .increaseLevel()\n                .merge(checkResult.debugLogCollector)\n                .decreaseLevel();\n        }\n        if (result) {\n            if (rewriteConfiguration.isValidateFilter === false) {\n                debugLogCollector.addLog(true, 'skip filter verify', 2);\n            }\n            else {\n                const checkResult = this.verifyFilter((_b = rewriteConfiguration.filter) !== null && _b !== void 0 ? _b : randomEvent.filter);\n                result = checkResult.result;\n                debugLogCollector\n                    .addLog(checkResult.result, `verify filter using: ${rewriteConfiguration.filter ? 'rewrite configuration' : 'passage metadata'}`, 2)\n                    .increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n            }\n        }\n        if (result) {\n            let checkResult;\n            if (randomEvent._isLimitationStrategiesTagged) {\n                checkResult = this.verifyTaggedLimitationStrategy(randomEvent.passageName, randomEvent.limitationStrategies, compiledTags);\n            }\n            else {\n                checkResult = this.verifyNotTaggedLimitationStrategy(randomEvent.passageName, randomEvent.limitationStrategies, compiledTags);\n            }\n            result = checkResult.result;\n            debugLogCollector\n                .addLog(checkResult.result, `verify limitationStrategies using: 'passage metadata'`, 2)\n                .increaseLevel()\n                .merge(checkResult.debugLogCollector)\n                .decreaseLevel();\n            usedLimitationStrategyTags = checkResult.additionalData.usedLimitationStrategyTags;\n        }\n        if (result) {\n            if (rewriteConfiguration.isValidateThreshold === false) {\n                debugLogCollector.addLog(true, 'skip threshold verify', 2);\n            }\n            else {\n                const checkResult = this.verifyThreshold((_c = rewriteConfiguration.threshold) !== null && _c !== void 0 ? _c : randomEvent.threshold);\n                result = checkResult.result;\n                debugLogCollector\n                    .addLog(checkResult.result, `verify threshold using: ${rewriteConfiguration.threshold ? 'rewrite configuration' : 'passage metadata'}`, 2).increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n            }\n        }\n        return {\n            result,\n            debugLogCollector,\n            additionalData: {\n                usedLimitationStrategyTags\n            }\n        };\n    }\n    verifyIsEnable(isEnabled) {\n        const result = isEnabled;\n        return {\n            result,\n            debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(result, result ? 'event enabled' : 'event disabled', 3)\n        };\n    }\n    verifyFilter(filter) {\n        if (filter === true || filter === false) {\n            return {\n                result: filter,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(filter, `filter expression returns ${filter ? 'true' : 'false'}`, 3)\n            };\n        }\n        let result;\n        try {\n            result = this.sugarcubeFacade.runTeweeScript(filter);\n        }\n        catch (error) {\n            error.message = \"bad evaluation: \" + error.message;\n            throw error;\n        }\n        if (result !== true && result !== false) {\n            throw new Error(`invalid filter expression return type (expected: boolean: actual: ${typeof result})`);\n        }\n        return {\n            result,\n            debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(result, `filter expression returns ${result ? 'true' : 'false'}`, 3)\n        };\n    }\n    verifyTaggedLimitationStrategy(passageName, limitationStrategies, compiledTags) {\n        const debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        const usedLimitationStrategyTags = [];\n        let isSuccess = true;\n        if (limitationStrategies.length <= 0) {\n            return {\n                result: true,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"](),\n                additionalData: {\n                    usedLimitationStrategyTags: []\n                },\n            };\n        }\n        limitationStrategies.forEach(limitationStrategy => {\n            // skip all next if already found limitation which is not passed\n            if (isSuccess === false) {\n                return;\n            }\n            if (limitationStrategy.max <= 0) {\n                debugLogCollector.addLog(true, 'limitationStrategy max value <= 0', 3);\n                return;\n            }\n            if (limitationStrategy.tags.length > 0) {\n                const limitationStrategyTags = [...this.tagsManager.prepareTags(limitationStrategy.tags)];\n                // skip checking limitationStrategy when current compiled tags have not included `limitation.tags`\n                for (let i = 0; i < limitationStrategyTags.length; i++) {\n                    if (!compiledTags.includes(limitationStrategyTags[i])) {\n                        debugLogCollector\n                            .addLog(false, `tag '${limitationStrategyTags[i]}' not found in current tags`, 3)\n                            .increaseLevel()\n                            .increaseLevel()\n                            .addLog(null, `current tags   : ${compiledTags.join(', ')}`, 3)\n                            .addLog(null, `limitation tags: ${limitationStrategyTags.join(', ')}`, 3)\n                            .decreaseLevel()\n                            .decreaseLevel();\n                        return;\n                    }\n                }\n                const fullLimitationStrategyTags = [\n                    ...limitationStrategyTags,\n                    ...(limitationStrategy.isSeparate ? [passageName] : [])\n                ];\n                const fullLimitationStrategyTagsKey = this.tagsManager.convertTagsToStringKey(fullLimitationStrategyTags);\n                const actualFiredTagCount = this.randomEventStats.getTagRunCountActual(fullLimitationStrategyTagsKey);\n                if (actualFiredTagCount >= limitationStrategy.max) {\n                    isSuccess = false;\n                    debugLogCollector.addLog(false, `limitationStrategy with tags ['${limitationStrategyTags.join(', ')}'] have max value ${limitationStrategy.max} but already fired ${actualFiredTagCount} times`, 3);\n                    return;\n                }\n                else {\n                    usedLimitationStrategyTags.push(fullLimitationStrategyTags);\n                    debugLogCollector.addLog(true, `limitationStrategy with tags ['${limitationStrategyTags.join(', ')}'] have max value ${limitationStrategy.max} and already fired ${actualFiredTagCount} times`, 3);\n                }\n            }\n            else {\n                const actualFiredEventCount = this.randomEventStats.getPassageRunCountActual(passageName);\n                if (actualFiredEventCount >= limitationStrategy.max) {\n                    isSuccess = false;\n                    debugLogCollector.addLog(false, `limitationStrategy without tags have max value ${limitationStrategy.max} but already fired ${actualFiredEventCount} times`, 3);\n                    return;\n                }\n                else {\n                    debugLogCollector.addLog(true, `limitationStrategy without tags have max value ${limitationStrategy.max} and already fired ${actualFiredEventCount} times`, 3);\n                }\n            }\n        });\n        if (isSuccess && usedLimitationStrategyTags.length <= 0) {\n            isSuccess = false;\n            debugLogCollector.addLog(false, `not found any limitationStrategy where current tags cover all limitationStrategy tags (current tags: ${compiledTags.join(', ')}`, 3);\n        }\n        return {\n            result: isSuccess,\n            debugLogCollector,\n            additionalData: { usedLimitationStrategyTags }\n        };\n    }\n    verifyNotTaggedLimitationStrategy(passageName, limitationStrategies, compiledTags) {\n        const debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        const usedLimitationStrategyTags = [];\n        let isSuccess = true;\n        if (limitationStrategies.length <= 0) {\n            return {\n                result: true,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"](),\n                additionalData: {\n                    usedLimitationStrategyTags: []\n                },\n            };\n        }\n        limitationStrategies.forEach(limitationStrategy => {\n            if (limitationStrategy.max <= 0) {\n                debugLogCollector.addLog(true, 'limitationStrategy max value <= 0', 3);\n                return;\n            }\n            const actualFiredEventCount = this.randomEventStats.getPassageRunCountActual(passageName);\n            if (actualFiredEventCount >= limitationStrategy.max) {\n                isSuccess = false;\n                debugLogCollector.addLog(false, `random event have max value ${limitationStrategy.max} but already fired ${actualFiredEventCount} times`, 3);\n                return;\n            }\n            else {\n                debugLogCollector.addLog(true, `random event have max value ${limitationStrategy.max} and already fired ${actualFiredEventCount} times`, 3);\n            }\n        });\n        return {\n            result: isSuccess,\n            debugLogCollector,\n            additionalData: { usedLimitationStrategyTags }\n        };\n    }\n    verifyThreshold(threshold) {\n        let thresholdResult = 0;\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_1__.isNumber)(threshold)) {\n            try {\n                thresholdResult = this.sugarcubeFacade.runTeweeScript(threshold.toString());\n            }\n            catch (error) {\n                error.message = \"bad evaluation: \" + error.message;\n                throw error;\n            }\n        }\n        else {\n            thresholdResult = threshold;\n        }\n        if (thresholdResult >= 100) {\n            return {\n                result: true,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(true, 'threshold is equal to or greater than 100', 3)\n            };\n        }\n        const randomValue = Math.floor(Math.random() * 100);\n        if (randomValue > thresholdResult) {\n            return {\n                result: false,\n                debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(false, `random value is greater than threshold (random=${randomValue} > threshold=${thresholdResult})`, 3)\n            };\n        }\n        return {\n            result: true,\n            debugLogCollector: new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_0__[\"default\"]().addLog(true, 'threshold passed (random=' + randomValue + ' <= threshold=' + thresholdResult + ')', 3)\n        };\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/ConstraintsVerificator.ts?");

/***/ }),

/***/ "./src/DebugLogCollector.ts":
/*!**********************************!*\
  !*** ./src/DebugLogCollector.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ DebugLogCollector)\n/* harmony export */ });\nclass DebugLogCollector {\n    constructor(debugLevel = 0) {\n        this.debugLevel = debugLevel;\n        this.currentLevel = 0;\n        this.logs = [];\n        if (debugLevel !== 0 && debugLevel !== 1 && debugLevel !== 2 && debugLevel !== 3) {\n            throw new Error(\"Debug level should be 0, 1, 2 or 3\");\n        }\n    }\n    addLog(result, message, debugLevel, level) {\n        this.logs.push({\n            result: result,\n            message: message,\n            debugLevel: debugLevel,\n            level: level === undefined ? this.currentLevel : level,\n        });\n        return this;\n    }\n    merge(debugLogCollector) {\n        debugLogCollector.all().forEach(log => this.addLog(log.result, log.message, log.debugLevel, log.level + this.currentLevel));\n        return this;\n    }\n    increaseLevel() {\n        this.currentLevel++;\n        return this;\n    }\n    decreaseLevel() {\n        this.currentLevel--;\n        if (this.currentLevel < 0) {\n            this.currentLevel = 0;\n        }\n        return this;\n    }\n    get length() {\n        return this.logs.length;\n    }\n    all() {\n        return this.logs;\n    }\n    toString() {\n        return this.logs\n            .filter(log => log.debugLevel <= this.debugLevel)\n            .map(log => ('  '.repeat(log.level)) + (log.result === true ? '+ ' : (log.result === false ? '- ' : '')) + log.message)\n            .join(\"\\n\");\n    }\n    clear() {\n        this.currentLevel = 0;\n        this.logs = [];\n        return this;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/DebugLogCollector.ts?");

/***/ }),

/***/ "./src/Lock.ts":
/*!*********************!*\
  !*** ./src/Lock.ts ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ Lock)\n/* harmony export */ });\nclass Lock {\n    constructor() {\n        this.lockData = {\n            isLocked: false,\n            isForce: false,\n        };\n    }\n    acquire() {\n        if (this.lockData.isForce === false) {\n            this.lockData.isLocked = true;\n        }\n    }\n    release() {\n        if (this.lockData.isForce === false) {\n            this.lockData.isLocked = false;\n        }\n    }\n    forceAcquire() {\n        this.lockData.isLocked = true;\n        this.lockData.isForce = true;\n    }\n    forceRelease() {\n        this.lockData.isLocked = false;\n        this.lockData.isForce = false;\n    }\n    get isLocked() {\n        return this.lockData.isLocked;\n    }\n    get isForce() {\n        return this.lockData.isForce;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/Lock.ts?");

/***/ }),

/***/ "./src/RandomEventApp.ts":
/*!*******************************!*\
  !*** ./src/RandomEventApp.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RandomEventApp)\n/* harmony export */ });\n/* harmony import */ var _Lock__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Lock */ \"./src/Lock.ts\");\n/* harmony import */ var _DebugLogCollector__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./DebugLogCollector */ \"./src/DebugLogCollector.ts\");\n/* harmony import */ var _ConstraintsVerificator__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./ConstraintsVerificator */ \"./src/ConstraintsVerificator.ts\");\n/* harmony import */ var _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./enum/GroupTypeEnum */ \"./src/enum/GroupTypeEnum.ts\");\n/* harmony import */ var _TagsManager__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./TagsManager */ \"./src/TagsManager.ts\");\n/* harmony import */ var _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./error/PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n/* harmony import */ var _processors_RandomEventPassageMetadataProcessor__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./processors/RandomEventPassageMetadataProcessor */ \"./src/processors/RandomEventPassageMetadataProcessor.ts\");\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n/* harmony import */ var _macros_index__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./macros/index */ \"./src/macros/index.ts\");\n/* harmony import */ var _facade_SugarcubeFacade__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./facade/SugarcubeFacade */ \"./src/facade/SugarcubeFacade.ts\");\n/* harmony import */ var _RandomEventStats__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./RandomEventStats */ \"./src/RandomEventStats.ts\");\n\n\n\n\n\n\n\n\n\n\n\nclass RandomEventApp {\n    constructor(passageMetadataApp, debugLevel = 0) {\n        this.passageMetadataApp = passageMetadataApp;\n        this._passagesByTagIndex = {};\n        this._passagesByGroupIndex = {};\n        this.acquireLock = () => this.lock.acquire();\n        this.releaseLock = () => this.lock.release();\n        this.forceAcquireLock = () => this.lock.forceAcquire();\n        this.forceReleaseLock = () => this.lock.forceRelease();\n        this.has = (passageName) => this.passageMetadataApp.has(passageName);\n        this.find = (passageName) => this.passageMetadataApp.find(passageName);\n        this.sugarcubeFacade = new _facade_SugarcubeFacade__WEBPACK_IMPORTED_MODULE_9__[\"default\"]();\n        this.tagsManager = new _TagsManager__WEBPACK_IMPORTED_MODULE_4__[\"default\"](this.sugarcubeFacade);\n        this.lock = new _Lock__WEBPACK_IMPORTED_MODULE_0__[\"default\"]();\n        this.debugLogCollector = new _DebugLogCollector__WEBPACK_IMPORTED_MODULE_1__[\"default\"](debugLevel);\n        this.randomEventStats = new _RandomEventStats__WEBPACK_IMPORTED_MODULE_10__[\"default\"](passageMetadataApp, this.tagsManager);\n        this.constraintsVerificator = new _ConstraintsVerificator__WEBPACK_IMPORTED_MODULE_2__[\"default\"](this.sugarcubeFacade, this.tagsManager, this.randomEventStats);\n        const randomEventPassageMetadataProcessor = new _processors_RandomEventPassageMetadataProcessor__WEBPACK_IMPORTED_MODULE_6__[\"default\"]();\n        passageMetadataApp.onBeforeAddMetadata.add((passageMetadataObject) => {\n            try {\n                randomEventPassageMetadataProcessor.process(passageMetadataObject);\n            }\n            catch (error) {\n                if (error instanceof _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_5__[\"default\"]) {\n                    let message = error.message;\n                    if (error.path.length > 0) {\n                        message += ' ';\n                        error.path.forEach((path, index) => {\n                            if (index === 0 || path[0] === '[') {\n                                message += path;\n                            }\n                            else {\n                                message += '.' + path;\n                            }\n                        });\n                    }\n                    let scopeMessage = [];\n                    if (error.expected !== null) {\n                        scopeMessage.push('expected ' + error.expected);\n                    }\n                    if (error.actual !== null) {\n                        scopeMessage.push('actual ' + error.actual);\n                    }\n                    throw new Error(`${message}${scopeMessage.join.length > 0 ? ` (${scopeMessage.join(', ')})` : ''}`);\n                }\n                throw error;\n            }\n        });\n        passageMetadataApp.onAfterAddMetadata.add((passageMetadata) => {\n            const data = passageMetadata.data;\n            if (data.tags.length > 0) {\n                data.tags.forEach((tag) => {\n                    if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isTweeScript)(tag)) {\n                        return;\n                    }\n                    if (this._passagesByTagIndex[tag] === undefined) {\n                        this._passagesByTagIndex[tag] = [];\n                    }\n                    this._passagesByTagIndex[tag].push(data.passageName);\n                });\n            }\n            if (data.groups.length > 0) {\n                data.groups.forEach((group) => {\n                    if (this._passagesByGroupIndex[group.name] === undefined) {\n                        this._passagesByGroupIndex[group.name] = [];\n                    }\n                    this._passagesByGroupIndex[group.name].push(data.passageName);\n                });\n            }\n        });\n        passageMetadataApp.onBeforeRestore.add((state) => {\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                const data = state[passageName];\n                if (data.e !== undefined) {\n                    data.isEnabled = data.e;\n                    delete data.e;\n                }\n            });\n        });\n        passageMetadataApp.onBeforeStore.add((state) => {\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                const data = state[passageName];\n                if (data.isEnabled !== undefined) {\n                    data.e = data.isEnabled;\n                    delete data.isEnabled;\n                }\n            });\n        });\n        (0,_macros_index__WEBPACK_IMPORTED_MODULE_8__[\"default\"])(this, passageMetadataApp, this.sugarcubeFacade);\n    }\n    get isLocked() {\n        return this.lock.isLocked;\n    }\n    ;\n    get isForceLocked() {\n        return this.lock.isForce;\n    }\n    ;\n    enable(passageName) {\n        if (!this.passageMetadataApp.has(passageName)) {\n            if (!this.sugarcubeFacade.hasPassage(passageName)) {\n                throw new Error(`passage \"${passageName}\" does not exist`);\n            }\n            if (this.passageMetadataApp.mode === 'byTag') {\n                throw new Error(`passage \"${passageName}\" exist but without tag \"${this.passageMetadataApp.modeParams.filterTag}\"`);\n            }\n            else {\n                throw new Error(`passage \"${passageName}\" does'n contain metadata`);\n            }\n        }\n        this.passageMetadataApp.get(passageName).setValue('isEnabled', true);\n        this.passageMetadataApp.storeState();\n    }\n    disable(passageName) {\n        if (!this.passageMetadataApp.has(passageName)) {\n            if (!this.sugarcubeFacade.hasPassage(passageName)) {\n                throw new Error(`passage \"${passageName}\" does not exist`);\n            }\n            if (this.passageMetadataApp.mode === 'byTag') {\n                throw new Error(`passage \"${passageName}\" exist but without tag \"${this.passageMetadataApp.modeParams.filterTag}\"`);\n            }\n            else {\n                throw new Error(`passage \"${passageName}\" does'n contain metadata`);\n            }\n        }\n        this.passageMetadataApp.get(passageName).setValue('isEnabled', false);\n        this.passageMetadataApp.storeState();\n    }\n    enableByTag(tag) {\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isArray)(this._passagesByTagIndex[tag])) {\n            this._passagesByTagIndex[tag].forEach((passageName) => {\n                const passageMetadata = this.passageMetadataApp.get(passageName);\n                passageMetadata.setValue('isEnabled', true);\n            });\n            this.passageMetadataApp.storeState();\n        }\n    }\n    disableByTag(tag) {\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isArray)(this._passagesByTagIndex[tag])) {\n            this._passagesByTagIndex[tag].forEach((passageName) => {\n                const passageMetadata = this.passageMetadataApp.get(passageName);\n                passageMetadata.setValue('isEnabled', false);\n            });\n            this.passageMetadataApp.storeState();\n        }\n    }\n    runRandomEvent(passageName, rewriteConfiguration) {\n        this.debugLogCollector.clear();\n        rewriteConfiguration = {\n            ...{\n                isValidateIsEnable: true,\n                isEnabled: null,\n                isValidateFilter: true,\n                filter: null,\n                isValidateLimitationStrategy: true,\n                limitationStrategy: null,\n                isValidateThreshold: true,\n                threshold: null,\n            },\n            ...(rewriteConfiguration !== null && rewriteConfiguration !== void 0 ? rewriteConfiguration : {})\n        };\n        if (!this.passageMetadataApp.has(passageName)) {\n            if (!this.sugarcubeFacade.hasPassage(passageName)) {\n                throw new Error(`passage \"${passageName}\" does not exist`);\n            }\n            throw new Error(`passage \"${passageName}\" exist but without tag \"${this.passageMetadataApp.modeParams.filterTag}\"`);\n        }\n        const passageMetadata = (this.passageMetadataApp.get(passageName)).data;\n        this.debugLogCollector.addLog(null, `Start random event ${passageMetadata.passageName}`, 1);\n        this.debugLogCollector.increaseLevel();\n        let result = true;\n        if (this.lock.isLocked) {\n            result = false;\n            this.debugLogCollector.addLog(null, `Skip because lock already acquired`, 1);\n            return {\n                isSuccess: result,\n                debugLogCollector: this.debugLogCollector,\n                passageMetadata,\n                usedTags: []\n            };\n        }\n        try {\n            const compiledTags = this.tagsManager.prepareTags(passageMetadata.tags);\n            const checkResult = this.constraintsVerificator.verify(passageMetadata, compiledTags, rewriteConfiguration);\n            this.debugLogCollector\n                .addLog(null, `Verify:`, 2)\n                .increaseLevel()\n                .merge(checkResult.debugLogCollector)\n                .decreaseLevel();\n            return {\n                isSuccess: checkResult.result,\n                debugLogCollector: this.debugLogCollector,\n                passageMetadata,\n                usedTags: passageMetadata._isLimitationStrategiesTagged ? checkResult.additionalData.usedLimitationStrategyTags : [compiledTags]\n            };\n        }\n        catch (error) {\n            // TODO add data to error\n            throw error;\n        }\n    }\n    runGroup(groupName, groupThreshold, rewriteConfiguration) {\n        this.debugLogCollector.clear();\n        rewriteConfiguration = {\n            ...{\n                isValidateIsEnable: true,\n                isEnable: null,\n                isValidateFilter: true,\n                filter: null,\n                isValidateLimitationStrategy: true,\n                limitationStrategy: null,\n                isValidateThreshold: true,\n                threshold: null,\n            },\n            ...(rewriteConfiguration !== null && rewriteConfiguration !== void 0 ? rewriteConfiguration : {})\n        };\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isArray)(this._passagesByGroupIndex[groupName])) {\n            throw new Error(`group \"${groupName}\" does not exist`);\n        }\n        this.debugLogCollector.addLog(null, `Start group ${groupName}`, 1);\n        this.debugLogCollector.increaseLevel();\n        let result = true;\n        if (this.lock.isLocked) {\n            result = false;\n            this.debugLogCollector.addLog(null, `Skip because lock already acquired`, 1);\n            return {\n                isSuccess: result,\n                debugLogCollector: this.debugLogCollector,\n            };\n        }\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isNumber)(groupThreshold) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_7__.isString)(groupThreshold)) {\n            try {\n                const checkResult = this.constraintsVerificator.verifyThreshold(groupThreshold);\n                result = checkResult.result;\n                this.debugLogCollector\n                    .addLog(null, 'Verify group threshold', 2)\n                    .increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n            }\n            catch (error) {\n                // TODO add data to error\n                throw error;\n            }\n            if (result === false) {\n                return {\n                    isSuccess: result,\n                    debugLogCollector: this.debugLogCollector,\n                };\n            }\n            rewriteConfiguration.isValidateThreshold = false;\n        }\n        this.debugLogCollector\n            .increaseLevel()\n            .addLog(null, 'Verify random events in group', 1)\n            .increaseLevel();\n        let totalWeight = 0;\n        const sucessRandomEventsResults = [];\n        for (let groupIndex = 0; groupIndex < this._passagesByGroupIndex[groupName].length; groupIndex++) {\n            const passageName = this._passagesByGroupIndex[groupName][groupIndex];\n            const passageMetadata = (this.passageMetadataApp.get(passageName)).data;\n            const group = passageMetadata.groups[passageMetadata._groupByNameIndex[groupName]];\n            this.debugLogCollector\n                .addLog(null, `Random event ${passageMetadata.passageName} with weight ${group.weight}`, 1)\n                .increaseLevel();\n            try {\n                const compiledTags = this.tagsManager.prepareTags(passageMetadata.tags);\n                const checkResult = this.constraintsVerificator.verify(passageMetadata, compiledTags, rewriteConfiguration);\n                const result = checkResult.result;\n                this.debugLogCollector\n                    .addLog(null, `Verify`, 2)\n                    .increaseLevel()\n                    .merge(checkResult.debugLogCollector)\n                    .decreaseLevel();\n                if (result) {\n                    totalWeight += group.weight;\n                    sucessRandomEventsResults.push({\n                        isSuccess: result,\n                        passageMetadata: passageMetadata,\n                        usedTags: passageMetadata._isLimitationStrategiesTagged ? checkResult.additionalData.usedLimitationStrategyTags : [compiledTags],\n                        group: group,\n                    });\n                }\n            }\n            catch (error) {\n                // TODO add data to error\n                throw error;\n            }\n            this.debugLogCollector.decreaseLevel();\n        }\n        if (sucessRandomEventsResults.length <= 0) {\n            result = false;\n            this.debugLogCollector.addLog(false, `not found any suitable random events in group`, 2);\n            return {\n                isSuccess: result,\n                debugLogCollector: this.debugLogCollector,\n            };\n        }\n        let winnerRandomEventResult = null;\n        if (sucessRandomEventsResults[0].group.type === _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_3__.GroupTypeEnum.Sequential) {\n            this.debugLogCollector\n                .addLog(true, `Find winner event`, 2)\n                .increaseLevel();\n            const sucessRandomEventsSequentialResults = sucessRandomEventsResults.filter((sucessRandomEventsResult) => {\n                return this.randomEventStats.getPassageRunCountHistory(sucessRandomEventsResult.passageMetadata.passageName) < sucessRandomEventsResult.group.sequentialCount;\n            });\n            this.debugLogCollector.addLog(true, `sequential search found ${sucessRandomEventsSequentialResults.length} siutable events`, 3);\n            if (sucessRandomEventsSequentialResults.length > 0) {\n                winnerRandomEventResult = sucessRandomEventsSequentialResults.sort((a, b) => {\n                    return a.group.sequentialIndex - b.group.sequentialIndex;\n                })[0];\n                this.debugLogCollector.addLog(true, `winner random event: ${winnerRandomEventResult.passageMetadata.passageName}`, 3);\n                return {\n                    isSuccess: result,\n                    debugLogCollector: this.debugLogCollector,\n                    passageMetadata: winnerRandomEventResult.passageMetadata,\n                    usedTags: winnerRandomEventResult.usedTags,\n                    group: winnerRandomEventResult.group,\n                };\n            }\n        }\n        let winnerWeight = Math.floor(Math.random() * totalWeight);\n        this.debugLogCollector.addLog(true, `total weight: ${totalWeight} | wittner weight: ${winnerWeight}`, 3);\n        for (let i = 0; i < sucessRandomEventsResults.length; i++) {\n            winnerWeight -= sucessRandomEventsResults[i].group.weight;\n            if (winnerWeight <= 0) {\n                winnerRandomEventResult = sucessRandomEventsResults[i];\n                break;\n            }\n        }\n        this.debugLogCollector.addLog(true, `winner random event: ${winnerRandomEventResult.passageMetadata.passageName}`, 3);\n        return {\n            isSuccess: result,\n            debugLogCollector: this.debugLogCollector,\n            passageMetadata: winnerRandomEventResult.passageMetadata,\n            usedTags: winnerRandomEventResult.usedTags,\n            group: winnerRandomEventResult.group,\n        };\n    }\n    incrementRunCounters(passageName, usedTags) {\n        this.randomEventStats.incrementPassageRunCount(passageName);\n        this.randomEventStats.incrementTagsRunCount(passageName, usedTags);\n        this.passageMetadataApp.storeState();\n    }\n    resetRunCounterByPassage(passageName) {\n        this.randomEventStats.resetPassageRunCount(passageName);\n        this.passageMetadataApp.storeState();\n    }\n    resetRunCounterByTag(tag) {\n        this.randomEventStats.resetTagsRunCount(tag);\n        this.passageMetadataApp.storeState();\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/RandomEventApp.ts?");

/***/ }),

/***/ "./src/RandomEventStats.ts":
/*!*********************************!*\
  !*** ./src/RandomEventStats.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RandomEventStats)\n/* harmony export */ });\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n\nclass RandomEventStats {\n    constructor(passageMetadataApp, tagsManager) {\n        this.passageMetadataApp = passageMetadataApp;\n        this.tagsManager = tagsManager;\n        this.passagesRunCountHistory = {};\n        this.passagesRunCountActual = {};\n        this.tagsRunCountHistory = {};\n        this.tagsRunCountActual = {};\n        this._passagesByTagIndex = {};\n        this._tagsStringKeysByPassageAndTagIndex = {};\n        this._tagsStringKeysIndex = {};\n        passageMetadataApp.onAfterAddMetadata.add((passageMetadata) => {\n            const data = passageMetadata.data;\n            data._stringTags.forEach((tag) => {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isString)(tag) || tag.length <= 0) {\n                    return;\n                }\n                if (this._passagesByTagIndex[tag] === undefined) {\n                    this._passagesByTagIndex[tag] = [];\n                }\n                this._passagesByTagIndex[tag].push(data.passageName);\n            });\n            data.limitationStrategies.forEach((limitationStrategy) => {\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(limitationStrategy.tags) && limitationStrategy.tags.length > 0) {\n                    const tags = limitationStrategy.tags;\n                    if (limitationStrategy.isSeparate === true) {\n                        tags.push(data.passageName);\n                    }\n                    const tagsStringKey = this.tagsManager.convertTagsToStringKey(tags);\n                    if (this._tagsStringKeysIndex[tagsStringKey] === undefined) {\n                        this._tagsStringKeysIndex[tagsStringKey] = [];\n                    }\n                    if (limitationStrategy.isSeparate === true) {\n                        tags.push(data.passageName);\n                    }\n                    limitationStrategy.tags.forEach((tag) => {\n                        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isString)(tag) || tag.length <= 0) {\n                            return;\n                        }\n                        if (this._passagesByTagIndex[tag] === undefined) {\n                            this._passagesByTagIndex[tag] = [];\n                        }\n                        if (!this._passagesByTagIndex[tag].includes(passageMetadata.passageName)) {\n                            this._passagesByTagIndex[tag].push(passageMetadata.passageName);\n                        }\n                        if (this._tagsStringKeysByPassageAndTagIndex[tag] === undefined) {\n                            this._tagsStringKeysByPassageAndTagIndex[tag] = {};\n                        }\n                        if (this._tagsStringKeysByPassageAndTagIndex[tag][data.passageName] === undefined) {\n                            this._tagsStringKeysByPassageAndTagIndex[tag][data.passageName] = [];\n                        }\n                        this._tagsStringKeysByPassageAndTagIndex[tag][data.passageName].push(tagsStringKey);\n                        if (!this._tagsStringKeysIndex[tagsStringKey].includes(tag)) {\n                            this._tagsStringKeysIndex[tagsStringKey].push(tag);\n                        }\n                    });\n                }\n            });\n        });\n        passageMetadataApp.onBeforeRestore.add((state) => {\n            console.log(state);\n            const tagsIndex = {};\n            if (state.__tags !== undefined) {\n                state.__tags.forEach((tag, index) => {\n                    tagsIndex[index] = tag;\n                });\n                delete state.__tags;\n            }\n            this.passagesRunCountHistory = {};\n            this.passagesRunCountActual = {};\n            this.tagsRunCountHistory = {};\n            this.tagsRunCountActual = {};\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                var _a, _b;\n                const data = state[passageName];\n                if (data._runCountActual === undefined) {\n                    data._runCountActual = 0;\n                }\n                if (data._runCountHistory === undefined) {\n                    data._runCountHistory = 0;\n                }\n                if (data._runCountByTagsActual === undefined) {\n                    data._runCountByTagsActual = {};\n                }\n                if (data._runCountByTagsHistory === undefined) {\n                    data._runCountByTagsHistory = {};\n                }\n                if (data.s !== undefined) {\n                    data._runCountActual = (_a = data.s.a) !== null && _a !== void 0 ? _a : data._runCountActual;\n                    data._runCountHistory = (_b = data.s.h) !== null && _b !== void 0 ? _b : data._runCountHistory;\n                    if (data.s.t !== undefined) {\n                        const tagsIndexes = Object.keys(data.s.t).map((index) => parseInt(index));\n                        tagsIndexes.forEach((tagIndex) => {\n                            if (data.s.t[tagIndex].a !== undefined) {\n                                data._runCountByTagsActual[tagsIndex[tagIndex]] = data.s.t[tagIndex].a;\n                            }\n                            if (data.s.t[tagIndex].h !== undefined) {\n                                data._runCountByTagsHistory[tagsIndex[tagIndex]] = data.s.t[tagIndex].h;\n                            }\n                        });\n                    }\n                    delete data.s;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountActual)) {\n                    this.passagesRunCountActual[passageName] = data._runCountActual;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountHistory)) {\n                    this.passagesRunCountHistory[passageName] = data._runCountHistory;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsActual)) {\n                    const tags = Object.keys(data._runCountByTagsActual);\n                    tags.forEach((tag) => {\n                        if (this.tagsRunCountActual[tag] === undefined) {\n                            this.tagsRunCountActual[tag] = 0;\n                        }\n                        this.tagsRunCountActual[tag] += data._runCountByTagsActual[tag];\n                    });\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsHistory)) {\n                    const tags = Object.keys(data._runCountByTagsHistory);\n                    tags.forEach((tag) => {\n                        if (this.tagsRunCountHistory[tag] === undefined) {\n                            this.tagsRunCountHistory[tag] = 0;\n                        }\n                        this.tagsRunCountHistory[tag] += data._runCountByTagsHistory[tag];\n                    });\n                }\n            });\n        });\n        passageMetadataApp.onBeforeStore.add((state) => {\n            let tagsIndexLength = 0;\n            const tagsIndex = {};\n            const passageNames = Object.keys(state);\n            passageNames.forEach((passageName) => {\n                const data = state[passageName];\n                const optimizedStats = {};\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountActual)) {\n                    optimizedStats.a = data._runCountActual;\n                    delete data._runCountActual;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isNumber)(data._runCountHistory)) {\n                    optimizedStats.h = data._runCountHistory;\n                    delete data._runCountHistory;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsActual)) {\n                    const tags = Object.keys(data._runCountByTagsActual);\n                    if (tags.length > 0) {\n                        optimizedStats.t = {};\n                        tags.forEach((tag) => {\n                            if (tagsIndex[tag] === undefined) {\n                                tagsIndex[tag] = tagsIndexLength;\n                                tagsIndexLength++;\n                            }\n                            if (optimizedStats.t[tagsIndex[tag]] === undefined) {\n                                optimizedStats.t[tagsIndex[tag]] = {};\n                            }\n                            optimizedStats.t[tagsIndex[tag]].a = data._runCountByTagsActual[tag];\n                        });\n                    }\n                    delete data._runCountByTagsActual;\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(data._runCountByTagsHistory)) {\n                    const tags = Object.keys(data._runCountByTagsHistory);\n                    if (tags.length > 0) {\n                        if (optimizedStats.t === undefined) {\n                            optimizedStats.t = {};\n                        }\n                        tags.forEach((tag) => {\n                            if (tagsIndex[tag] === undefined) {\n                                tagsIndex[tag] = tagsIndexLength;\n                                tagsIndexLength++;\n                            }\n                            if (optimizedStats.t[tagsIndex[tag]] === undefined) {\n                                optimizedStats.t[tagsIndex[tag]] = {};\n                            }\n                            optimizedStats.t[tagsIndex[tag]].h = data._runCountByTagsHistory[tag];\n                        });\n                    }\n                    delete data._runCountByTagsHistory;\n                }\n                if (Object.keys(optimizedStats).length > 0) {\n                    data.s = optimizedStats;\n                }\n            });\n            if (tagsIndexLength > 0) {\n                state.__tags = Object.keys(tagsIndex);\n            }\n        });\n    }\n    incrementPassageRunCount(passageName, count = 1, isStoreImmediately = false) {\n        const passageMetadata = this.passageMetadataApp.get(passageName);\n        const runCountHistory = passageMetadata.data._runCountHistory + count;\n        const runCountActual = passageMetadata.data._runCountActual + count;\n        passageMetadata.setValue('_runCountHistory', runCountHistory);\n        passageMetadata.setValue('_runCountActual', runCountActual);\n        this.passagesRunCountHistory[passageName] = runCountHistory;\n        this.passagesRunCountActual[passageName] = runCountActual;\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    incrementTagsRunCount(passageName, tagsList, count = 1, isStoreImmediately = false) {\n        const passageMetadata = this.passageMetadataApp.get(passageName);\n        const currentRunCountByTagsHistory = passageMetadata.data._runCountByTagsHistory;\n        const currentRunCountByTagsActual = passageMetadata.data._runCountByTagsActual;\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(tagsList) && tagsList.length > 0) {\n            tagsList.forEach(tags => {\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(tags) && tags.length > 0) {\n                    const uniqueTags = [...tags].filter((tag, index, array) => array.indexOf(tag) === index);\n                    const tagsStringKey = this.tagsManager.convertTagsToStringKey(tags);\n                    uniqueTags.forEach(tag => {\n                        if (tag !== '') {\n                            currentRunCountByTagsHistory[tag] = currentRunCountByTagsHistory[tag] === undefined ? count : currentRunCountByTagsHistory[tag] + count;\n                            currentRunCountByTagsActual[tag] = currentRunCountByTagsActual[tag] === undefined ? count : currentRunCountByTagsActual[tag] + count;\n                            this.tagsRunCountHistory[tag] = this.tagsRunCountHistory[tag] === undefined ? count : this.tagsRunCountHistory[tag] + count;\n                            this.tagsRunCountActual[tag] = this.tagsRunCountActual[tag] === undefined ? count : this.tagsRunCountActual[tag] + count;\n                        }\n                    });\n                    if (tagsStringKey !== '') {\n                        currentRunCountByTagsHistory[tagsStringKey] = currentRunCountByTagsHistory[tagsStringKey] === undefined ? count : currentRunCountByTagsHistory[tagsStringKey] + count;\n                        currentRunCountByTagsActual[tagsStringKey] = currentRunCountByTagsActual[tagsStringKey] === undefined ? count : currentRunCountByTagsActual[tagsStringKey] + count;\n                        this.tagsRunCountHistory[tagsStringKey] = this.tagsRunCountHistory[tagsStringKey] === undefined ? count : this.tagsRunCountHistory[tagsStringKey] + count;\n                        this.tagsRunCountActual[tagsStringKey] = this.tagsRunCountActual[tagsStringKey] === undefined ? count : this.tagsRunCountActual[tagsStringKey] + count;\n                    }\n                }\n            });\n        }\n        passageMetadata.setValue('_runCountByTagsHistory', currentRunCountByTagsHistory);\n        passageMetadata.setValue('_runCountByTagsActual', currentRunCountByTagsActual);\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    resetPassageRunCount(passageName, isStoreImmediately = false) {\n        const passageMetadata = this.passageMetadataApp.get(passageName);\n        passageMetadata.setValue('_runCountActual', 0);\n        this.passagesRunCountActual[passageName] = 0;\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    resetTagsRunCount(tags, isStoreImmediately = false) {\n        if (!Array.isArray(tags)) {\n            tags = [tags];\n        }\n        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(tags)) {\n            tags.forEach((tag) => {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isString)(tag)) {\n                    throw new Error('Tag shouldb be string');\n                }\n                if (this.tagsRunCountActual[tag] !== undefined) {\n                    delete this.tagsRunCountActual[tag];\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(this._passagesByTagIndex[tag])) {\n                    this._passagesByTagIndex[tag].forEach((passageName) => {\n                        const passageMetadata = this.passageMetadataApp.get(passageName);\n                        passageMetadata.setValue('_runCountActual', 0);\n                        delete this.passagesRunCountActual[passageName];\n                        const runCountByTagsActual = { ...passageMetadata.data._runCountByTagsActual };\n                        delete runCountByTagsActual[tag];\n                        passageMetadata.setValue('_runCountByTagsActual', runCountByTagsActual);\n                    });\n                }\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isObject)(this._tagsStringKeysByPassageAndTagIndex[tag])) {\n                    const passageNames = Object.keys(this._tagsStringKeysByPassageAndTagIndex[tag]);\n                    passageNames.forEach((passageName) => {\n                        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isArray)(this._tagsStringKeysByPassageAndTagIndex[tag][passageName])) {\n                            const passageMetadata = this.passageMetadataApp.get(passageName);\n                            this._tagsStringKeysByPassageAndTagIndex[tag][passageName].forEach((tagsStringKey) => {\n                                const runCountByTagsActual = { ...passageMetadata.data._runCountByTagsActual };\n                                if (runCountByTagsActual[tagsStringKey] !== undefined) {\n                                    if (this._tagsStringKeysIndex[tagsStringKey] !== undefined) {\n                                        this._tagsStringKeysIndex[tagsStringKey].forEach((tagFromTagsStringKey) => {\n                                            if (runCountByTagsActual[tagFromTagsStringKey] !== undefined) {\n                                                delete runCountByTagsActual[tagFromTagsStringKey];\n                                            }\n                                            if (this.tagsRunCountActual[tagFromTagsStringKey] !== undefined) {\n                                                delete this.tagsRunCountActual[tagFromTagsStringKey];\n                                            }\n                                        });\n                                    }\n                                    delete runCountByTagsActual[tagsStringKey];\n                                }\n                                passageMetadata.setValue('_runCountByTagsActual', runCountByTagsActual);\n                                if (this.tagsRunCountActual[tagsStringKey] !== undefined) {\n                                    delete this.tagsRunCountActual[tagsStringKey];\n                                }\n                            });\n                        }\n                    });\n                }\n            });\n        }\n        if (isStoreImmediately === true) {\n            this.passageMetadataApp.storeState();\n        }\n    }\n    getPassageRunCountActual(passageName) {\n        var _a;\n        return (_a = this.passagesRunCountActual[passageName]) !== null && _a !== void 0 ? _a : 0;\n    }\n    getPassageRunCountHistory(passageName) {\n        var _a;\n        return (_a = this.passagesRunCountHistory[passageName]) !== null && _a !== void 0 ? _a : 0;\n    }\n    getTagRunCountActual(tag) {\n        var _a;\n        return (_a = this.tagsRunCountActual[tag]) !== null && _a !== void 0 ? _a : 0;\n    }\n    getTagRunCountHistory(tag) {\n        var _a;\n        return (_a = this.tagsRunCountHistory[tag]) !== null && _a !== void 0 ? _a : 0;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/RandomEventStats.ts?");

/***/ }),

/***/ "./src/TagsManager.ts":
/*!****************************!*\
  !*** ./src/TagsManager.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ TagsManager)\n/* harmony export */ });\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n\nclass TagsManager {\n    constructor(sugarcubeFacade) {\n        this.sugarcubeFacade = sugarcubeFacade;\n    }\n    prepareTags(tags) {\n        return tags.map((tag) => {\n            if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.isTweeScript)(tag)) {\n                return tag;\n            }\n            else {\n                try {\n                    return this.sugarcubeFacade.runTeweeScript(tag).trim().replace(' ', '__');\n                }\n                catch (error) {\n                    throw new Error(\"Invalid random event scripted tag: \" + tag);\n                }\n            }\n        }).sort();\n    }\n    convertTagsToStringKey(tags) {\n        return this.prepareTags(tags).join('_');\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/TagsManager.ts?");

/***/ }),

/***/ "./src/enum/GroupTypeEnum.ts":
/*!***********************************!*\
  !*** ./src/enum/GroupTypeEnum.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   GroupTypeEnum: () => (/* binding */ GroupTypeEnum)\n/* harmony export */ });\nvar GroupTypeEnum;\n(function (GroupTypeEnum) {\n    GroupTypeEnum[\"Random\"] = \"random\";\n    GroupTypeEnum[\"Sequential\"] = \"sequential\";\n})(GroupTypeEnum || (GroupTypeEnum = {}));\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/enum/GroupTypeEnum.ts?");

/***/ }),

/***/ "./src/enum/Type.ts":
/*!**************************!*\
  !*** ./src/enum/Type.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   TypeEnum: () => (/* binding */ TypeEnum)\n/* harmony export */ });\nvar TypeEnum;\n(function (TypeEnum) {\n    TypeEnum[\"Embedded\"] = \"embedded\";\n    TypeEnum[\"Goto\"] = \"goto\";\n})(TypeEnum || (TypeEnum = {}));\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/enum/Type.ts?");

/***/ }),

/***/ "./src/error/InvalidPassageMetadataValue.ts":
/*!**************************************************!*\
  !*** ./src/error/InvalidPassageMetadataValue.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ InvalidPassageMetadataValue)\n/* harmony export */ });\n/* harmony import */ var _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n\nclass InvalidPassageMetadataValue extends _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"] {\n    constructor(passageName = null, path = [], expected = null, actual = null) {\n        super('Invalid value', passageName, path, expected, actual);\n        Object.setPrototypeOf(this, _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"].prototype);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/InvalidPassageMetadataValue.ts?");

/***/ }),

/***/ "./src/error/InvalidPassageMetadataValueType.ts":
/*!******************************************************!*\
  !*** ./src/error/InvalidPassageMetadataValueType.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ InvalidPassageMetadataValueType)\n/* harmony export */ });\n/* harmony import */ var _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n\nclass InvalidPassageMetadataValueType extends _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"] {\n    constructor(passageName = null, path = [], expected = null, actual = null) {\n        super('Invalid type', passageName, path, expected, actual);\n        Object.setPrototypeOf(this, _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"].prototype);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/InvalidPassageMetadataValueType.ts?");

/***/ }),

/***/ "./src/error/PassageMetadataValidationError.ts":
/*!*****************************************************!*\
  !*** ./src/error/PassageMetadataValidationError.ts ***!
  \*****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ PassageMetadataValidationError)\n/* harmony export */ });\nclass PassageMetadataValidationError extends Error {\n    constructor(message, passageName = null, path = [], expected = null, actual = null) {\n        super(message);\n        this._path = [];\n        this._expected = null;\n        this._actual = null;\n        this._passageName = passageName;\n        this._path = path;\n        this._expected = expected;\n        this._actual = actual;\n        Object.setPrototypeOf(this, PassageMetadataValidationError.prototype);\n    }\n    static fromPreviousError(previousError, passageName = null, path = []) {\n        path = [\n            ...path,\n            ...(previousError instanceof PassageMetadataValidationError) ? previousError.path : []\n        ];\n        passageName = passageName !== null ? passageName : (previousError instanceof PassageMetadataValidationError) ? previousError.passageName : null;\n        const error = new PassageMetadataValidationError(previousError.message, passageName, previousError instanceof PassageMetadataValidationError ? previousError.expected : null, previousError instanceof PassageMetadataValidationError ? previousError.actual : null);\n        error.stack = previousError.stack;\n        return error;\n    }\n    get passageName() {\n        return this._passageName;\n    }\n    get path() {\n        return this._path;\n    }\n    get expected() {\n        return this._expected;\n    }\n    get actual() {\n        return this._actual;\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/PassageMetadataValidationError.ts?");

/***/ }),

/***/ "./src/error/RequiredPassageMetadataValue.ts":
/*!***************************************************!*\
  !*** ./src/error/RequiredPassageMetadataValue.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RequiredPassageMetadataValue)\n/* harmony export */ });\n/* harmony import */ var _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n\nclass RequiredPassageMetadataValue extends _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"] {\n    constructor(condition, passageName = null, path = [], expected = null, actual = null) {\n        if (condition === null) {\n            super('Valie is required', passageName, path, expected, actual);\n        }\n        else {\n            super('Valie is required when ' + condition, passageName, path, expected, actual);\n        }\n        Object.setPrototypeOf(this, _PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_0__[\"default\"].prototype);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/error/RequiredPassageMetadataValue.ts?");

/***/ }),

/***/ "./src/facade/SugarcubeFacade.ts":
/*!***************************************!*\
  !*** ./src/facade/SugarcubeFacade.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ SugarcubeFacade)\n/* harmony export */ });\nclass SugarcubeFacade {\n    getAllPassages() {\n        return Story.lookup();\n    }\n    runTeweeScript(expression) {\n        return Scripting.evalJavaScript(Scripting.parse(expression));\n    }\n    getCurrentPassage() {\n        return passage();\n    }\n    hasPassage(passageName) {\n        return Story.has(passageName);\n    }\n    getVariable(name) {\n        return State.variables[name];\n    }\n    saveVariable(name, value) {\n        State.variables[name] = value;\n    }\n    addMacros(name, options) {\n        Macro.add(name, options);\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/facade/SugarcubeFacade.ts?");

/***/ }),

/***/ "./src/macros/index.ts":
/*!*****************************!*\
  !*** ./src/macros/index.ts ***!
  \*****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((randomEventApp, passageMetadataApp, sugarcubeFacade) => {\n    sugarcubeFacade.addMacros('REEnable', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                randomEventApp.enable(randomEventPassageName);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later\n    sugarcubeFacade.addMacros('REEnableByTag', {\n        handler: function () {\n            if (this.args.length !== 1) {\n                return this.error('Need to pass just 1 tag');\n            }\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event tag should be a string value');\n            }\n            try {\n                randomEventApp.enableByTag(this.args[0]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('REDisable', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                randomEventApp.disable(randomEventPassageName);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later\n    sugarcubeFacade.addMacros('REDisableByTag', {\n        handler: function () {\n            if (this.args.length !== 1) {\n                return this.error('Need to pass just 1 tag');\n            }\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event tag should be a string value');\n            }\n            try {\n                randomEventApp.disableByTag(this.args[0]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('REReset', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                randomEventApp.resetRunCounterByPassage(randomEventPassageName);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later\n    sugarcubeFacade.addMacros('REResetByTag', {\n        handler: function () {\n            if (this.args.length !== 1) {\n                return this.error('Need to pass just 1 tag');\n            }\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event tag should be a string value');\n            }\n            try {\n                randomEventApp.resetRunCounterByTag(this.args[0]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('RE', {\n        handler: function () {\n            if (this.args.length === 0) {\n                return this.error('No random event passage name specified');\n            }\n            var randomEventPassageName;\n            if (typeof this.args[0] === 'object') {\n                randomEventPassageName = this.args[0].link;\n            }\n            else {\n                randomEventPassageName = this.args[0];\n            }\n            try {\n                // TODO: maybe need to add more rewrite widget arguments\n                var result = randomEventApp.runRandomEvent(randomEventPassageName, {\n                    threshold: this.args[1]\n                });\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n            if (Config.debug) {\n                var debugLog = '';\n                if (result.debugLogCollector.debugLevel > 0) {\n                    debugLog = result.debugLogCollector.toString();\n                }\n                this.debugView.name = 'RE \"' + result.passageMetadata.passageName + '\"';\n                this.debugView.title = debugLog;\n                this.debugView.modes({\n                    nonvoid: true,\n                    hidden: false,\n                    invalid: !result.isSuccess\n                });\n                if (result.debugLogCollector.debugLevel > 0) {\n                    console.log(debugLog);\n                }\n            }\n            // TODO remove this\n            if (result.debugLogCollector.debugLevel > 0) {\n                var debugLog = '';\n                debugLog += result.debugLogCollector.toString();\n                console.log(debugLog);\n            }\n            if (result.isSuccess) {\n                randomEventApp.incrementRunCounters(result.passageMetadata.passageName, result.usedTags);\n                if (result.passageMetadata.type === 'embedded') {\n                    var $el = jQuery(this.output);\n                    $el.wiki(Story.get(result.passageMetadata.passageName).processText());\n                }\n                else {\n                    randomEventApp.acquireLock();\n                    setTimeout(function () { Engine.play(result.passageMetadata.passageName, true), Engine.minDomActionDelay; });\n                }\n            }\n        },\n    });\n    sugarcubeFacade.addMacros('REGroup', {\n        handler: function () {\n            if (typeof this.args[0] !== 'string') {\n                return this.error('Random event group name should be a string value');\n            }\n            var groupName = this.args[0];\n            try {\n                // TODO: maybe need to add more arguments\n                var result = randomEventApp.runGroup(groupName, this.args[1]);\n            }\n            catch (err) {\n                this.error(err.message);\n            }\n            if (Config.debug) {\n                var debugLog = 'REGroup \"' + groupName + '\"';\n                if (result.debugLogCollector.debugLevel > 0) {\n                    debugLog = result.debugLogCollector.toString();\n                }\n                this.debugView.name = 'REGroup \"' + groupName + '\"';\n                this.debugView.title = debugLog;\n                this.debugView.modes({\n                    nonvoid: true,\n                    hidden: false,\n                    invalid: !result.isSuccess\n                });\n                if (result.debugLogCollector.debugLevel > 0) {\n                    console.log(debugLog);\n                }\n            }\n            // TODO remove this\n            if (result.debugLogCollector.debugLevel > 0) {\n                var debugLog = '';\n                debugLog += result.debugLogCollector.toString();\n                console.log(debugLog);\n            }\n            if (result.isSuccess) {\n                randomEventApp.incrementRunCounters(result.passageMetadata.passageName, result.usedTags);\n                if (result.passageMetadata.type === 'embedded') {\n                    var $el = jQuery(this.output);\n                    $el.wiki(Story.get(result.passageMetadata.passageName).processText());\n                }\n                else {\n                    randomEventApp.acquireLock();\n                    setTimeout(function () { Engine.play(result.passageMetadata.passageName, true), Engine.minDomActionDelay; });\n                }\n            }\n        },\n    });\n});\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/macros/index.ts?");

/***/ }),

/***/ "./src/processors/RandomEventPassageMetadataProcessor.ts":
/*!***************************************************************!*\
  !*** ./src/processors/RandomEventPassageMetadataProcessor.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ RandomEventPassageMetadataProcessor)\n/* harmony export */ });\n/* harmony import */ var _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../error/InvalidPassageMetadataValueType */ \"./src/error/InvalidPassageMetadataValueType.ts\");\n/* harmony import */ var _error_InvalidPassageMetadataValue__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../error/InvalidPassageMetadataValue */ \"./src/error/InvalidPassageMetadataValue.ts\");\n/* harmony import */ var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../tools/TypeChecker */ \"./src/tools/TypeChecker.ts\");\n/* harmony import */ var _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../error/PassageMetadataValidationError */ \"./src/error/PassageMetadataValidationError.ts\");\n/* harmony import */ var _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../enum/GroupTypeEnum */ \"./src/enum/GroupTypeEnum.ts\");\n/* harmony import */ var _error_RequiredPassageMetadataValue__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../error/RequiredPassageMetadataValue */ \"./src/error/RequiredPassageMetadataValue.ts\");\n/* harmony import */ var _enum_Type__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../enum/Type */ \"./src/enum/Type.ts\");\n\n\n\n\n\n\n\nclass RandomEventPassageMetadataProcessor {\n    // validate, normalize, enrich and build indexes for random event metadata\n    process(passageMetadataObject) {\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject)) {\n            // we shouldn't be here, passage metadata previously checked in PassageMetadataCollector, I added that check just in case\n            throw new Error(`Invalid passage metadata type (expected JSON object, actual ${typeof passageMetadataObject})`);\n        }\n        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.passageName)) {\n            // we shouldn't be here, passage name is always a string, I added that check just in case\n            throw new Error(`Invalid passage name type (expected string, actual ${typeof passageMetadataObject.passageName})`);\n        }\n        passageMetadataObject._isLimitationStrategiesTagged = false;\n        passageMetadataObject._groupByNameIndex = {};\n        passageMetadataObject._stringTags = [];\n        passageMetadataObject._runCountHistory = 0;\n        passageMetadataObject._runCountActual = 0;\n        passageMetadataObject._runCountByTagsHistory = {};\n        passageMetadataObject._runCountByTagsActual = {};\n        this.processIsEnabled(passageMetadataObject);\n        this.processGroups(passageMetadataObject);\n        this.processFilter(passageMetadataObject);\n        this.processType(passageMetadataObject);\n        this.processThreshold(passageMetadataObject);\n        this.processTags(passageMetadataObject);\n        this.processLimitationStrategies(passageMetadataObject);\n    }\n    processIsEnabled(passageMetadataObject) {\n        if (passageMetadataObject.isEnabled === undefined || passageMetadataObject.isEnabled === null) {\n            passageMetadataObject.isEnabled = true;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isBoolean)(passageMetadataObject.isEnabled)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'isEnabled'], 'boolean', typeof passageMetadataObject.isEnabled);\n        }\n    }\n    processGroups(passageMetadataObject) {\n        if (passageMetadataObject.groups === undefined || passageMetadataObject.groups === null) {\n            passageMetadataObject.groups = [];\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.groups) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.groups)) {\n            if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.groups)) {\n                passageMetadataObject.groups = [passageMetadataObject.groups];\n            }\n            for (let index = 0; index < passageMetadataObject.groups.length; index++) {\n                if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups[index])) {\n                    passageMetadataObject.groups[index] = {\n                        name: passageMetadataObject.groups[index],\n                        weight: 10,\n                        type: _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random,\n                        sequentialIndex: null,\n                        sequentialCount: null,\n                    };\n                }\n                else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.groups[index])) {\n                    if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups[index].name)) {\n                        throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'name'], 'string', typeof passageMetadataObject.groups[index].name);\n                    }\n                    if (passageMetadataObject.groups[index].weight === undefined || passageMetadataObject.groups[index].weight === null) {\n                        passageMetadataObject.groups[index].weight = 10;\n                    }\n                    else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.groups[index].weight)) {\n                        throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'weight'], 'integer', typeof passageMetadataObject.groups[index].weight);\n                    }\n                    if (passageMetadataObject.groups[index].type === undefined || passageMetadataObject.groups[index].type === null) {\n                        passageMetadataObject.groups[index].type = _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random;\n                    }\n                    else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.groups[index].type)) {\n                        throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'type'], 'string', typeof passageMetadataObject.groups[index].type);\n                    }\n                    else if (passageMetadataObject.groups[index].type !== _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random && passageMetadataObject.groups[index].type !== _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential) {\n                        throw new _error_InvalidPassageMetadataValue__WEBPACK_IMPORTED_MODULE_1__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'type'], `\"${_enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Random}\" or \"${_enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential}\"`, passageMetadataObject.groups[index].type);\n                    }\n                    if (passageMetadataObject.groups[index].type === _enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential) {\n                        if (passageMetadataObject.groups[index].sequentialIndex === undefined) {\n                            throw new _error_RequiredPassageMetadataValue__WEBPACK_IMPORTED_MODULE_5__[\"default\"](`groupMetadata.type = \"${_enum_GroupTypeEnum__WEBPACK_IMPORTED_MODULE_4__.GroupTypeEnum.Sequential}\"`, passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'sequentialIndex']);\n                        }\n                        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.groups[index].sequentialIndex)) {\n                            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'sequentialIndex'], 'integer', typeof passageMetadataObject.groups[index].sequentialIndex);\n                        }\n                        if (passageMetadataObject.groups[index].sequentialCount === undefined || passageMetadataObject.groups[index].sequentialCount === null) {\n                            passageMetadataObject.groups[index].sequentialCount = 1;\n                        }\n                        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.groups[index].sequentialCount)) {\n                            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups', index, 'sequentialCount'], 'integer', typeof passageMetadataObject.groups[index].sequentialCount);\n                        }\n                    }\n                }\n                passageMetadataObject._groupByNameIndex[passageMetadataObject.groups[index].name] = index;\n            }\n        }\n        else {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'groups'], 'string, object or array of strings or objects', typeof passageMetadataObject.groups);\n        }\n    }\n    processFilter(passageMetadataObject) {\n        if (passageMetadataObject.filter === undefined || passageMetadataObject.filter === null) {\n            passageMetadataObject.filter = true;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.filter) && !(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isBoolean)(passageMetadataObject.filter)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'filter'], 'string or boolean', typeof passageMetadataObject.filter);\n        }\n    }\n    processType(passageMetadataObject) {\n        if (passageMetadataObject.type === undefined || passageMetadataObject.type === null) {\n            passageMetadataObject.type = _enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Embedded;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.type)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'type'], 'string', typeof passageMetadataObject.type);\n        }\n        else if (passageMetadataObject.type !== _enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Embedded && passageMetadataObject.type !== _enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Goto) {\n            throw new _error_InvalidPassageMetadataValue__WEBPACK_IMPORTED_MODULE_1__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'type'], `\"${_enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Embedded}\" or \"${_enum_Type__WEBPACK_IMPORTED_MODULE_6__.TypeEnum.Goto}\"`, passageMetadataObject.type);\n        }\n    }\n    processThreshold(passageMetadataObject) {\n        if (passageMetadataObject.threshold === undefined || passageMetadataObject.threshold === null) {\n            passageMetadataObject.threshold = 100;\n        }\n        else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isNumber)(passageMetadataObject.threshold) && !(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.threshold)) {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'threshold'], 'integer or string', typeof passageMetadataObject.threshold);\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isNumber)(passageMetadataObject.threshold)) {\n            if (passageMetadataObject.threshold < 0) {\n                throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should equal or greater than 0', passageMetadataObject.passageName, ['PassageMetadata', 'threshold']);\n            }\n            else if (passageMetadataObject.threshold > 100) {\n                throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should equal or less than 100', passageMetadataObject.passageName, ['PassageMetadata', 'threshold']);\n            }\n        }\n    }\n    processTags(passageMetadataObject) {\n        if (passageMetadataObject.tags === undefined || passageMetadataObject.tags === null) {\n            passageMetadataObject.tags = [];\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.tags) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.tags)) {\n            if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.tags)) {\n                passageMetadataObject.tags = [passageMetadataObject.tags];\n            }\n            for (let index = 0; index < passageMetadataObject.tags.length; index++) {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.tags[index])) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'tags', index], 'string', typeof passageMetadataObject.tags[index]);\n                }\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isTweeScript)(passageMetadataObject.tags[index])) {\n                    passageMetadataObject._stringTags.push(passageMetadataObject.tags[index]);\n                }\n            }\n        }\n    }\n    processLimitationStrategies(passageMetadataObject) {\n        if (passageMetadataObject.limitationStrategies === undefined || passageMetadataObject.limitationStrategies === null) {\n            passageMetadataObject.limitationStrategies = [];\n        }\n        else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.limitationStrategies) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.limitationStrategies)) {\n            if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.limitationStrategies)) {\n                passageMetadataObject.limitationStrategies = [passageMetadataObject.limitationStrategies];\n            }\n            for (let index = 0; index < passageMetadataObject.limitationStrategies.length; index++) {\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isObject)(passageMetadataObject.limitationStrategies[index])) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index], 'object', typeof passageMetadataObject.limitationStrategies[index]);\n                }\n                if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isInteger)(passageMetadataObject.limitationStrategies[index].max)) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'max'], 'integer', typeof passageMetadataObject.limitationStrategies[index].max);\n                }\n                if (passageMetadataObject.limitationStrategies[index].max < 0) {\n                    throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should equal or greater than 0', passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'max'], null, passageMetadataObject.limitationStrategies[index].max);\n                }\n                if (passageMetadataObject.limitationStrategies[index].isSeparate === undefined || passageMetadataObject.limitationStrategies[index].isSeparate === null) {\n                    passageMetadataObject.limitationStrategies[index].isSeparate = false;\n                }\n                else if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isBoolean)(passageMetadataObject.limitationStrategies[index].isSeparate)) {\n                    throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'isSeparate'], 'boolean', typeof passageMetadataObject.limitationStrategies[index].isSeparate);\n                }\n                if (passageMetadataObject.limitationStrategies[index].tags === undefined || passageMetadataObject.limitationStrategies[index].tags === null) {\n                    passageMetadataObject.limitationStrategies[index].tags = [];\n                }\n                else if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.limitationStrategies[index].tags) || (0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isArray)(passageMetadataObject.limitationStrategies[index].tags)) {\n                    if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.limitationStrategies[index].tags)) {\n                        passageMetadataObject.limitationStrategies[index].tags = [passageMetadataObject.limitationStrategies[index].tags];\n                    }\n                    for (let tagindex = 0; tagindex < passageMetadataObject.limitationStrategies[index].tags.length; tagindex++) {\n                        if (!(0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isString)(passageMetadataObject.limitationStrategies[index].tags[tagindex])) {\n                            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'tags', tagindex], 'string', typeof passageMetadataObject.limitationStrategies[index].tags[tagindex]);\n                        }\n                        if ((0,_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_2__.isTweeScript)(passageMetadataObject.limitationStrategies[index].tags[tagindex])) {\n                            throw new _error_PassageMetadataValidationError__WEBPACK_IMPORTED_MODULE_3__[\"default\"]('Should not contain twee scripts', passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies', index, 'tags', tagindex], 'string', typeof passageMetadataObject.limitationStrategies[index].tags[tagindex]);\n                        }\n                    }\n                }\n                if (passageMetadataObject.limitationStrategies[index].tags.length > 0) {\n                    passageMetadataObject.limitationStrategies[index]._isTagged = true;\n                    passageMetadataObject._isLimitationStrategiesTagged = true;\n                }\n                else {\n                    passageMetadataObject.limitationStrategies[index]._isTagged = false;\n                }\n            }\n        }\n        else {\n            throw new _error_InvalidPassageMetadataValueType__WEBPACK_IMPORTED_MODULE_0__[\"default\"](passageMetadataObject.passageName, ['PassageMetadata', 'limitationStrategies'], 'object or array', typeof passageMetadataObject.limitationStrategies);\n        }\n    }\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/processors/RandomEventPassageMetadataProcessor.ts?");

/***/ }),

/***/ "./src/tools/TypeChecker.ts":
/*!**********************************!*\
  !*** ./src/tools/TypeChecker.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   isArray: () => (/* binding */ isArray),\n/* harmony export */   isBoolean: () => (/* binding */ isBoolean),\n/* harmony export */   isFloat: () => (/* binding */ isFloat),\n/* harmony export */   isInteger: () => (/* binding */ isInteger),\n/* harmony export */   isNumber: () => (/* binding */ isNumber),\n/* harmony export */   isObject: () => (/* binding */ isObject),\n/* harmony export */   isString: () => (/* binding */ isString),\n/* harmony export */   isStringFloat: () => (/* binding */ isStringFloat),\n/* harmony export */   isStringInteger: () => (/* binding */ isStringInteger),\n/* harmony export */   isStringNumber: () => (/* binding */ isStringNumber),\n/* harmony export */   isTweeScript: () => (/* binding */ isTweeScript)\n/* harmony export */ });\nfunction isString(variable) {\n    return typeof variable === 'string' || variable instanceof String;\n}\nfunction isBoolean(variable) {\n    return typeof variable == \"boolean\" || variable instanceof Boolean;\n}\nfunction isArray(variable) {\n    return Object.prototype.toString.call(variable) === '[object Array]';\n}\nfunction isInteger(variable) {\n    return isNumber(variable) && variable % 1 === 0;\n}\nfunction isFloat(variable) {\n    return isNumber(variable) && variable % 1 !== 0;\n}\nfunction isNumber(variable) {\n    return typeof variable === 'number' && !isNaN(variable);\n}\nfunction isStringInteger(variable) {\n    return isString(variable) && !isNaN(variable) && isInteger(parseFloat(variable));\n}\nfunction isStringFloat(variable) {\n    return isString(variable) && !isNaN(variable) && isFloat(parseFloat(variable));\n}\nfunction isStringNumber(variable) {\n    return isString(variable) && !isNaN(variable) && isNumber(parseFloat(variable));\n}\nfunction isObject(variable) {\n    return typeof variable === 'object' && !Array.isArray(variable) && variable !== null;\n}\nfunction isTweeScript(variable) {\n    return isString(variable) && !(/^\\w+[\\w_\\- ]+$/.test(variable));\n}\n\n\n//# sourceURL=webpack://RandomEventAppExport/./src/tools/TypeChecker.ts?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./src/RandomEventApp.ts");
/******/ 	RandomEventAppExport = __webpack_exports__;
/******/ 	
/******/ })()
;
    var RandomEventApp = RandomEventAppExport.default;

    function initialize() {
        var randomEventApp = new RandomEventApp(
            window.passageMetadataApp,
            debugLevel,
        );

        $(document).on(':passageend', function() {
            randomEventApp.releaseLock();
        });

        Config.navigation.override = (destinationPassage) => {
            if (randomEventApp.isLocked && !randomEventApp.has(destinationPassage)) {
                // if random event fired in <<button>> or <<link>>, return previous passage to normal history forward work
                return realCurrentPassage ?? passage();
            }

            return destinationPassage;
        };

        window.randomEventApp = randomEventApp;
    }

    window.addEventListener('passage-metadata-app-initialized', () => {
        initialize();
    });
    if (window.passageMetadataApp !== undefined) {
        initialize();
    }
}());
</script><tw-passagedata pid="1" name="SexScene" tags="" position="100,100" size="100,100">&lt;&lt;StartSexSceneLayout&gt;&gt;




&lt;&lt;run setup.renderSexSceneActions()&gt;&gt;</tw-passagedata><tw-passagedata pid="2" name="Adda_ThisPlaceIsYours" tags="widget" position="225,100" size="100,100">&lt;&lt;widget &quot;Adda_ThisPlaceIsYours&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;This place... it&#39;s all yours?&lt;&lt;/speech&gt;&gt;

  Adda lets out a breath, not quite a sigh—more like a release of tension she hadn&#39;t noticed she was holding. Her gaze sweeps slowly across the parlor as if seeing it for the first time in a while.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;It is. Every velvet curtain, every loose floorboard, every soul that walks through that door... I&#39;ve had a hand in it all.&lt;&lt;/speech&gt;&gt;

  She trails her fingers across the back of the chair beside her, the tips brushing the velvet like she&#39;s testing it for secrets. In the distance, laughter flutters from behind a curtain, followed by the muted clink of glass.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;When I took over this place, it was crumbling. In debt, in spirit, and in reputation. But I don&#39;t give up on things just because they&#39;re broken.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $addaMentionedTakeover = true&gt;&gt;

  She turns back to you, voice quieter now—more intimate.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I tore out the rot. Laid new bones. And I stitched it back together with silk, sweat, and no small amount of blood.&lt;&lt;/speech&gt;&gt;

  She smiles. Not a selfish smile, but one filled with unmistakable pride.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Now the city doesn&#39;t just know it... it respects it. Noctail&#39;s not just a place. It&#39;s a promise. One I intend to keep.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="3" name="Adda_HostsCare" tags="widget" position="350,100" size="100,100">&lt;&lt;widget &quot;Adda_HostsCare&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Your hosts really seem to care about you.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s expression softens—not in weakness, but in memory. She glances toward a group of them laughing quietly in a corner, her eyes flicking across each face like she&#39;s counting blessings.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;They do. And not because they&#39;re told to. It&#39;s... earned. Like anything worth having.&lt;&lt;/speech&gt;&gt;

  She folds her arms, the weight of her gaze returning to you.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I care about them. Every one of them. Not because it&#39;s good business—but because they deserve to be seen, protected... valued.&lt;&lt;/speech&gt;&gt;

  A deep rumble of thunder presses against the building&#39;s bones. Somewhere above, a window rattles gently in its frame. Adda doesn&#39;t flinch.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;This house doesn&#39;t run on coin or charm alone, Jaylie. It runs on trust. On knowing someone&#39;s got your back, even when the storm gets close.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="4" name="Adda_Different" tags="widget" position="475,100" size="100,100">&lt;&lt;widget &quot;Adda_Different&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;The others here—they smile, they charm, but with you it&#39;s different. They *listen.* Like they&#39;re waiting for your lead.&lt;&lt;/speech&gt;&gt;

  Adda smiles faintly, her eyes still sweeping the room before settling on you.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;They know I won&#39;t ask anything of them I wouldn&#39;t do myself. That earns you more than loyalty—it earns you weight.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You carry it well. There&#39;s a steadiness to you. Like… no matter what&#39;s happening out here, you&#39;ve already seen worse and lived through it.&lt;&lt;/speech&gt;&gt;

  Adda chuckles low in her throat, the sound warm but edged in memory.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Most who come into this line of work burn hot. Big fire, quick fade. They live fast, charm fast, fall fast. And the world wouldn&#39;t give two shits for their ashes.&lt;&lt;/speech&gt;&gt;

  Her gaze lingers on one of the hosts across the room—someone young, laughing a little too loudly.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I learned early that smoldering lasts longer. Still heat. Still flame, but you just… have to be more patient.&lt;&lt;/speech&gt;&gt;

  A soft rumble rolls through the building—distant thunder shifting the air, rattling the stemware behind the bar. Neither of you flinch.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And now you&#39;re the fire everyone gathers around.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s lips curl into a knowing smile.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Maybe. These men and women know how cold it gets when the fire goes out. I just do my best to make sure that doesn&#39;t happen.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="5" name="Adda_StartMinigame" tags="widget" position="600,100" size="100,100">&lt;&lt;widget &quot;Adda_StartMinigame&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Mind if I ask you a few real questions? I&#39;d like to know more about you.&lt;&lt;/speech&gt;&gt;

  Adda tilts her head, one brow lifting with quiet amusement.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;That depends—are you asking to understand me, or just hoping to catch me off guard?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Guess you&#39;ll have to find out.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s smirk softens. She nods once.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Alright then. Ask away.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;adda&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="6" name="Adda_OriginStory" tags="widget" position="725,100" size="100,100">&lt;&lt;widget &quot;Adda_OriginStory&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You mentioned taking this place over… mind if I ask you more about how that happened?&lt;&lt;/speech&gt;&gt;

  Adda&#39;s expression shifts slightly — not softer, but heavier. She leans her weight onto one hip, arms folding under her chest.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;It&#39;s not short. And it&#39;s not sweet. But it&#39;s mine. If you&#39;re really curious, I&#39;d be glad to share it with you.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;set $addaMentionedOrigin = true&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;adda&quot; &quot;NoctailOrigin&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="7" name="Adda_CommandPresence" tags="widget" position="850,100" size="100,100">&lt;&lt;widget &quot;Adda_CommandPresence&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;People seem to listen when you speak.&lt;&lt;/speech&gt;&gt;

  Adda lifts her chin slightly, a half-smile playing at her lips. Her eyes track a pair of patrons chuckling a little too loudly in the far corner.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;They listen because I don&#39;t waste words. And because they know I see everything that happens under this roof.&lt;&lt;/speech&gt;&gt;

  As if on cue, Bert slides past with a tray balanced flawlessly on one hand, delivering drinks with silent precision. Adda watches him for a moment, her gaze softening with approval.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;See that? I never once had to tell Bert what this place demands. He just understood. People like him... they make my job easier.&lt;&lt;/speech&gt;&gt;

  Her voice lowers, inviting you into a more intimate tone.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;But others... others needed to be taught. Taught to listen. Taught to respect. And sometimes, taught what happens when they don&#39;t.&lt;&lt;/speech&gt;&gt;

  You&#39;re not sure if she&#39;s talking about staff, guests, or someone else entirely. But there&#39;s a weight to her words that lands heavy, even in the warmth of the parlor.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You make it look effortless.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Effortless is always the result of effort well hidden, dear.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="8" name="Adda_OrderDrink" tags="widget" position="975,100" size="100,100">&lt;&lt;widget &quot;Adda_OrderDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could you help me get a drink?&lt;&lt;/speech&gt;&gt;

  Adda gives you a measured look, as if weighing what sort of drink might suit you… or perhaps what message she wants it to send.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Well of course, dear. You should have asked sooner. Bert—&lt;&lt;/speech&gt;&gt;

  She lifts two fingers, and without needing to raise her voice, catches his attention across the room. He nods once before turning to his station behind the bar.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Something full-bodied, dark at the center, with a kiss of spice. Just sweet enough to surprise you… and strong enough to be remembered in the morning.&lt;&lt;/speech&gt;&gt;

  A few moments later, Bert returns, fluid and precise in every motion, holding a cut-crystal glass that gleams like a gem in the low light.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;One *Velvet Verdict*, as requested.&lt;&lt;/speech&gt;&gt;

  The scent rises to meet you even before you lift it: smoke, black cherry, citrus oil, and something faintly floral—like crushed violets beneath warm stone.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Sip it slow. It should teach you something new about yourself with every sip.&lt;&lt;/speech&gt;&gt;

  You raise the glass, fingers brushing the beveled edge, and take a slow drink.

  It hits in waves—first the sweetness, like burnt sugar and ripe fruit, then a curl of warmth that lingers at the back of your throat. Beneath it all, a whisper of something earthy and elusive. Something older than you expected. There&#39;s complexity in it, the kind that hides a story you&#39;re not sure you&#39;re ready to hear.

  You exhale slowly, the alcohol blooming through your chest like warmth under thick blankets.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s… incredible.&lt;&lt;/speech&gt;&gt;

  Adda doesn&#39;t respond right away. She simply watches you, her lips curled into the faintest smile—like she already knew what you&#39;d say.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Bert doesn&#39;t miss. Neither do I.&lt;&lt;/speech&gt;&gt;

  The thunder outside rolls again, louder now, and the lights in the sconces flicker ever so slightly as if stirred by the storm&#39;s breath.
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="9" name="Adda_GoPrivate" tags="widget" position="1100,100" size="100,100">&lt;&lt;widget &quot;Adda_GoPrivate&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Would you ever step away for something a little more private?&lt;&lt;/speech&gt;&gt;

  For the first time in your entire conversation, Adda doesn&#39;t have an immediate answer. Her eyes soften just slightly, the sharp edge behind them dulled by something unspoken.

  She looks away, watching the parlor for a breath or two — the flick of a lighter at the bar, the rustle of skirts, the distant creak of the upstairs floor.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Well now… that&#39;s not a request I get very often anymore.&lt;&lt;/speech&gt;&gt;

  She turns back, lips curved just barely in a knowing smile.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;But since you&#39;ve gone and got me talking about the old days… sure. I wouldn&#39;t mind a little more reminiscing.&lt;&lt;/speech&gt;&gt;

  She moves gracefully to her feet, smoothing the front of her long black dress. A slow step toward you — deliberate, poised.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Just don&#39;t expect the same girl who used to work the floor. She&#39;s still in here somewhere… but you&#39;ll have to be clever to find her.&lt;&lt;/speech&gt;&gt;

  Without another word, she gestures for you to follow, and begins walking toward the a door just behind and to the side of the bar, one which you hadn&#39;t noticed was there before.

  [[You follow Adda into her private room.|Adda_PrivateScene]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 3&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 3&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="10" name="GoodbyeAddaZero" tags="widget" position="1225,100" size="100,100">&lt;&lt;widget &quot;GoodbyeAddaZero&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk more later.&lt;&lt;/speech&gt;&gt;

  Adda gives you a small, approving nod — not dismissive, but understanding.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Of course. The parlor&#39;s yours to roam. Just don&#39;t go falling for anyone too quickly, now.&lt;&lt;/speech&gt;&gt;

  Her lips curl in a subtle smirk, and she returns her attention to the room — already half-in, half-out of your conversation, watching the ebb and flow of her domain.

  You rise from the couch and glance around. The hush of the brothel settles over you again — warm light, distant laughter, the clink of glass, the faint rumble of thunder pulsing against the windows.

  [[You step away from Adda and return to the parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Adda Noctail Origin Convo Branch - Start */</tw-passagedata><tw-passagedata pid="11" name="Adda_Origin_WhatWasItLike" tags="widget" position="100,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_WhatWasItLike&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What was the brothel like before you took over?&lt;&lt;/speech&gt;&gt;

  Adda leans back against the velvet cushion, one leg crossed over the other, fingers tapping lightly on her knee.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;Dusty. Desperate. The kind of place where eyes don&#39;t meet and names aren&#39;t asked. It made coin, sure—but it bled for it. No warmth, no rules, just survival with a smile.&lt;&lt;/speech&gt;&gt;

  Her voice tightens, just slightly.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;There were still good people under this roof. One in particular. She kept the light on in the dark, even when no one deserved it. The kind of person who made you sit straighter just by walking into a room.&lt;&lt;/speech&gt;&gt;

  Adda&#39;s eyes drift upward, unfocused. A hint of warmth in the corner of her mouth, bittersweet.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;She used to say the walls had ears. So she made sure they only heard kindness. I thought it was naive at the time. Now? I think it&#39;s the bravest damn thing anyone ever tried in a place like this.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="12" name="Adda_Origin_PreviousOwner" tags="widget" position="225,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_PreviousOwner&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Who was the previous owner?&lt;&lt;/speech&gt;&gt;

  Adda&#39;s posture shifts at the question—just slightly. Her shoulders drop, the air around her suddenly quieter, like a memory is stepping between you both.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;That would be Lys. Though to call her the “owner” isn&#39;t quite right. She was never on the deed. Never had the keys, not really. But she ran the floor. Managed the girls. Kept the worst of the wolves at bay.&lt;&lt;/speech&gt;&gt;

  She folds her arms, eyes drifting to a point just over your shoulder.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;The real owners—the ones with coin and clean ledgers—didn&#39;t care what this place became, so long as it kept making money. Lys tried to shift that. Bit by bit. She made the rooms safer. Banned the regulars who didn&#39;t respect limits. Bought better wine, better sheets. Even lit the place in amber instead of white—said it made everyone feel warmer, softer.&lt;&lt;/speech&gt;&gt;

  Her lips press into a thin smile.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;But she ruffled the wrong feathers. There were men in high collars who didn&#39;t like that she had a voice. And even fewer liked that she didn&#39;t hide who she was. Said she was... unsettling. That her kind didn&#39;t belong in polite society, let alone business.&lt;&lt;/speech&gt;&gt;

  She runs a thumb along the edge of her ring.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;I told her to keep her head down. She laughed in my face. Said, “You don&#39;t fix rot by pretending it smells sweet.”&lt;&lt;/speech&gt;&gt;

  There&#39;s silence for a moment. Even the parlor seems to hush.

  &lt;&lt;speech &quot;adda&quot;&gt;&gt;She was brave. And she paid for it.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="13" name="Adda_Origin_HowSheTookIt" tags="widget" position="350,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_HowSheTookIt&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So… how did you end up taking control of the Noctail?&lt;&lt;/speech&gt;&gt;

Adda doesn&#39;t answer immediately. Her fingers idly trace the rim of her glass, her gaze drifting to a quiet corner of the parlor as if searching for a memory still lingering there.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;It wasn&#39;t supposed to be me, you know. The one running things.&lt;&lt;/speech&gt;&gt;

The soft thunder outside rolls again, low and distant.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Lys—she was the heart of this place back then. Not in title, but in spirit. She had a way of making people feel seen. Made the girls stand taller. Made the guests a little less cruel. The plan was always for her to take over fully once the old owner finally let go.&lt;&lt;/speech&gt;&gt;

She lets out a dry breath, almost a laugh.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;But plans don&#39;t hold up well in this city. Not when people like Lys start asking for better. She&#39;d begun drawing lines—no more rent skimming from the Guild, no more silent bribes to the watch. Just… honest work, done with dignity. That ruffled more than a few feathers.&lt;&lt;/speech&gt;&gt;

Jaylie shifts slightly, the tension in Adda&#39;s voice registering now.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;One night, she didn&#39;t come back. No note. No farewell. Just… gone.&lt;&lt;/speech&gt;&gt;

She presses her lips together. The silence that follows is heavy, not just with grief but with unfinished justice.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;The old owner—he panicked. With Lys gone, the whole place started to fray. Clients got bolder. Staff grew scared. I wasn&#39;t in charge, but I was still here. Still loyal. And loud enough to matter.&lt;&lt;/speech&gt;&gt;

She finally meets your eyes.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I leaned on the right people. Called in favors. Found ways to make things… difficult for him. Let&#39;s just say the Guild figured it was better for their business if someone more stable took the reins. A deed signed under pressure is still a deed.&lt;&lt;/speech&gt;&gt;

She leans back, thoughtful.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I didn&#39;t steal this place. I claimed it. For her. For everyone still here. And for myself.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="14" name="Adda_Origin_ChangesMade" tags="widget" position="475,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_ChangesMade&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And once you took over… what changed?&lt;&lt;/speech&gt;&gt;

Adda gives a small grunt, not unkind—more reflective than anything. She swirls the liquid in her glass, the ice clinking softly like distant wind chimes.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Almost everything. But not all at once. You don&#39;t reshape a house like this with fire and hammers. You do it like a tailor—quiet snips and careful stitching. Little by little, until the seams hold different shapes.&lt;&lt;/speech&gt;&gt;

She shifts in her seat, eyes sweeping the room.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;First thing I did was remove the locks from the inside of the rooms. No one here should ever feel like they&#39;re trapped, even for show. Then I started cutting ties—with certain clients, certain fixers. If someone didn&#39;t treat my people like people, they were no longer welcome. No exceptions.&lt;&lt;/speech&gt;&gt;

Jaylie nods slowly, watching Adda&#39;s expression.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I hired guards that worked for the hosts, not just the clients. Switched contracts from oral deals to proper ones—signed, sealed, enforceable. Doesn&#39;t stop everything, but it gives us a shield if the law ever decides to remember we exist.&lt;&lt;/speech&gt;&gt;

A subtle crack of thunder echoes from outside, barely audible beneath the murmur of the parlor. Adda glances toward the window briefly, then back.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;The biggest change, though? I made it clear that no one here belongs to anyone. Not to me. Not to the house. Not to the city. Anyone can walk when they want—no debts. No shame. Stay because you choose to. Leave because you can.&lt;&lt;/speech&gt;&gt;

She pauses, looking back at Jaylie. Her voice softens.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Lys used to say that dignity was the rarest thing in places like this. So I built a home where it could grow.&lt;&lt;/speech&gt;&gt;

Jaylie watches her quietly for a beat before offering a small, genuine smile.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I think she&#39;d be proud.&lt;&lt;/speech&gt;&gt;

Adda returns the smile, just barely.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I hope so...&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="15" name="Adda_Origin_LocalPolitics" tags="widget" position="600,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_LocalPolitics&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Any enemies left over from those days?&lt;&lt;/speech&gt;&gt;

Adda&#39;s mouth curls—not into a smile, exactly, but something sharp and knowing. She leans back, exhaling slowly through her nose, like she&#39;s weighing which ghosts are safe to speak aloud.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;You don&#39;t clear a den of rats without some of them slipping through the cracks. A few of them scurry still. Names I&#39;d prefer you not repeat, unless you want your shoes filled with glass.&lt;&lt;/speech&gt;&gt;

She picks up her glass, takes a slow sip, then gestures lazily with it.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;There was a man named Vell. Muscle for one of the guilds, back when Lys was still alive. Thought he could own the house from the shadows—skim coin, push substances, threaten the girls if they didn&#39;t ‘perform&#39; to spec. I told him once to leave. The second time… I didn&#39;t ask.&lt;&lt;/speech&gt;&gt;

Her gaze flicks toward the far side of the parlor, where a pair of guests laugh too loudly before quieting again.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;He doesn&#39;t come around anymore. But he&#39;s not gone. Not really. The city has a long memory and a short leash, and some men never forget the bruise to their pride.&lt;&lt;/speech&gt;&gt;

Jaylie shifts slightly in her seat, sensing the weight behind her words.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Then there&#39;s the Nobleman&#39;s Club over on Fallow Row. Not a brothel, technically. More of a... gentleman&#39;s retreat. They don&#39;t like that we cut into their profits and do it without bowing. One of their chairs still sends little spies now and then, trying to find dirt on us.&lt;&lt;/speech&gt;&gt;

Thunder rolls distantly again, this time closer, the windows of the parlor murmuring with a soft, sympathetic rattle. Adda glances toward the sound, then turns her attention back.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;But none of them come here. Not anymore. They know what it costs. And I&#39;ve made it very clear—if anyone touches one of mine, I&#39;ll spend every last coin I have making sure it&#39;s the last thing they do.&lt;&lt;/speech&gt;&gt;

A pause hangs between you.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Remind me not to get on your bad side.&lt;&lt;/speech&gt;&gt;

Adda lets out a short, warm chuckle that almost cuts the tension.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Smart girl.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.adda_Conversation_Options_NoctailOrigin()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="16" name="Adda_Origin_Exit" tags="widget" position="725,225" size="100,100">&lt;&lt;widget &quot;Adda_Origin_Exit&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
You exhale softly, your fingers tracing the rim of your glass. Adda watches you for a moment, then shifts her weight in the seat, like she&#39;s letting go of something that had settled heavy on her shoulders.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We don&#39;t have to keep talking about the past.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;No. We don&#39;t. But thank you for asking. Not many care enough to hear it, let alone understand what it took to get here.&lt;&lt;/speech&gt;&gt;

Her gaze drifts for a moment—out toward the parlor where her hosts mingle, laugh, seduce, and survive. The room seems softer in the golden light, but the thunder outside is closer now. A low boom rolls through the walls, like a memory passing overhead.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Now then. You&#39;ve heard enough ghosts for one night, I think. Let&#39;s get back to the living.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;adda&quot; &quot;affection&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;adda&quot; &quot;Phase0&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="17" name="Allura_Watching" tags="widget" position="850,225" size="100,100">&lt;&lt;widget &quot;Allura_Watching&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Were you watching me?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Of course I was.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

She says it like it costs her nothing. No hesitation. No apology. Her tail flicks lazily behind her again, curling in a figure eight.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Like I said before, you walked in like you didn&#39;t want anyone to notice, which only made it harder not to. And then... you looked at me like you were hoping I&#39;d notice anyway. I do not know how you expected me not to stare. It was the most entertaining thing I have seen all night.&lt;&lt;/speech&gt;&gt;

You open your mouth, caught somewhere between denial and deflection, but she doesn&#39;t give you room to find either.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;It&#39;s sweet, you know. The way your eyes try not to linger. The way you sit just far enough away to lie about your curiosity. Please go on and look all you want. I would not have dressed like this if I did not welcome it. I like how your gaze feels on my skin.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

She leans in just enough to make your pulse catch, but not so much that you could call her out for it. Her eyes are impossibly gold this close—like molten metal poured into a feline frame.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re very confident. I mean that in a good way of course.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mm. That&#39;s part of the fun. Most people want to be seen. They just don&#39;t know how to ask for it.&lt;&lt;/speech&gt;&gt;

She lifts her glass—something crimson and jeweled with condensation—and takes a sip without ever breaking eye contact. Then she tilts her head, just slightly.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So, Jaylie... now that I&#39;ve seen you, what will you show me next?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="18" name="Allura_OutOfPlace" tags="widget" position="975,225" size="100,100">&lt;&lt;widget &quot;Allura_OutOfPlace&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Don&#39;t take this the wrong way, but... you feel kind of out of place here.&lt;&lt;/speech&gt;&gt;

Allura freezes — dramatically, like a courtesan in a stage play. Her head tilts, her lips part slightly, and she places a hand to her chest with faux offense.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Out of place? You wound me, &lt;em&gt;petite&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She gives an exaggerated sigh, then lets her hand slide down to rest at her hip. Her smile returns, but it&#39;s sharper now — teasing, dangerous.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Here I thought I was the very portrait of hospitality. My tail&#39;s behaving, my cleavage is curated, my drink is full — and yet somehow, I am a misfit in my own chaise lounge.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;No, I didn&#39;t mean— I just meant that… I don&#39;t get it. You&#39;re stunning. Charismatic. You look like someone who should be draped in silks, surrounded by admirers. I guess I was surprised to find you alone.&lt;&lt;/speech&gt;&gt;

Allura&#39;s eyes narrow slightly, the mockery fading just a hair — enough to let something thoughtful flicker underneath.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah. So what you&#39;re saying is... I look like I should come with an entourage. A pedestal. A personal fan brigade?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I mean... yes? But in a nice way.&lt;&lt;/speech&gt;&gt;

Allura chuckles — a low, velvety sound. She sips her drink again and lets a moment pass before responding.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You&#39;re not wrong, mon trésor. I&#39;ve had those nights. But not all attention is desirable. And not every pedestal is worth standing on. Sometimes it&#39;s more fun to pick someone &lt;em&gt;specific&lt;/em&gt; to make the effort.&lt;&lt;/speech&gt;&gt;

Her tail flicks again, brushing your calf this time — slower, more deliberate.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;And tonight, I think I like being the mystery in the corner. The one worth crossing the room for. After all, it worked, no?&lt;&lt;/speech&gt;&gt;

You cannot even begin to argue with the logic. You look down and your hands in your lap and laugh to yourself for a moment. Then you look up at Allura. She stares at you. Her lips curling. Then together you both laugh louder, more heartily. It is the first time, you notice, that you have seen a truly revealing response from her. 

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; You got me. &lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="19" name="Allura_Enjoyment" tags="widget" position="1100,225" size="100,100">&lt;&lt;widget &quot;Allura_Enjoyment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I ask you something real?&lt;&lt;/speech&gt;&gt;

Allura arches a brow — the expression almost amused, but there&#39;s a flicker of something sharper beneath it. Caution, maybe. Or curiosity.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You just did, mon cœur. But go on. I&#39;m listening.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you actually enjoy this? I mean... not the show. Not the act. But the being here. Talking like this. Connecting with someone.&lt;&lt;/speech&gt;&gt;

The question lingers between you, heavier than the rest. For the first time, Allura doesn&#39;t immediately answer. She swirls her drink slowly, eyes focused on the glass like the answer might settle at the bottom.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You know what most people ask me?&lt;&lt;/speech&gt;&gt;

She doesn&#39;t wait for you to guess.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;They ask me what I charge. What I like. What I&#39;ll do and what I won&#39;t. You&#39;re the first person tonight who&#39;s asked if I &lt;em&gt;want&lt;/em&gt; to be here.&lt;&lt;/speech&gt;&gt;

She exhales slowly through her nose and leans back against the cushions, her posture more relaxed than before — not staged, not seductive. Just tired. Honest.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;The truth is… some nights, yes. I like the games. The theater of it all. There&#39;s power in being seen — in choosing how to be seen. But then there are nights where I feel like a painting left in the rain. Pretty from a distance, but bleeding underneath.&lt;&lt;/speech&gt;&gt;

Her voice never cracks. It doesn&#39;t need to. You hear the weight behind every syllable.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But talking like this? With you? That part I enjoy.&lt;&lt;/speech&gt;&gt;

She sets her glass down, empty now, and folds her hands neatly in her lap.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ask me another one like that, and I might even answer it honestly.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="20" name="Allura_WhatCanIDo" tags="widget" position="1225,225" size="100,100">&lt;&lt;widget &quot;Allura_WhatCanIDo&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If there was anything I could do — right now — to truly make the rest of your night… what would it be?&lt;&lt;/speech&gt;&gt;

Allura blinks.

Just once.

You catch the faintest hitch in her breath — like a stage performer who&#39;s forgotten her next line.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Now that...&lt;em&gt;that&#39;s&lt;/em&gt; a dangerous question.&lt;&lt;/speech&gt;&gt;

She says it quietly, almost to herself. No teasing, no act — not yet. She leans forward just a touch, like gravity&#39;s decided she should be closer to you now.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You&#39;d be surprised how few people ask that with any intention behind it. Most of them want a specific answer. One they can anticipate. One that makes them feel clever for guessing right.&lt;&lt;/speech&gt;&gt;

Her tail doesn&#39;t flick this time. It curls gently around one ankle, like a ribbon tied in thought.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But you…&lt;&lt;/speech&gt;&gt;

She lifts her eyes to meet yours, and for a moment, the room feels quieter. As if everything&#39;s paused to hear her answer too.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;If you mean it — if this isn&#39;t just another performance…?&lt;&lt;/speech&gt;&gt;

She smiles softly. Not like before. No hunger in it. Just something warm and fragile.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Then maybe you&#39;ve already done it. You asked the question.&lt;&lt;/speech&gt;&gt;

You feel a strange mix of pride and disappointment, as if you were upset that she didn&#39;t ask you to go fight the lightning outside—which but in this moment—something is making you feel like you could have done it.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 2&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="21" name="Allura_DrinkOrder" tags="widget" position="100,350" size="100,100">&lt;&lt;widget &quot;Allura_DrinkOrder&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Would you mind ordering a drink for me?&lt;&lt;/speech&gt;&gt;

Allura raises an eyebrow, her smile curling at the edges like parchment near flame.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mmm. Dangerous thing to offer a woman like me that much power, &lt;em&gt;chérie&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She turns slightly, catching Bert&#39;s eye across the room with a subtle flick of her fingers and a tilt of her chin.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Bert, love — something slow and seductive, but with a little teeth. Like me.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;bert&quot;&gt;&gt;Comin&#39; right up, madame.&lt;&lt;/speech&gt;&gt;

Moments later, a pale violet drink arrives in a crystal glass shaped like a blooming flower. The scent hits first—berries, wine, and something herbal beneath it.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;We call this one &lt;em&gt;Velvet Mercy&lt;/em&gt;. Tastes like a favor you didn&#39;t earn. Be careful with it.&lt;&lt;/speech&gt;&gt;

You lift the glass and sip. It&#39;s sweet, rich, and ends with a bitter curl that coils at the back of your throat like smoke.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s... complex.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Aren&#39;t we all?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="22" name="Allura_GoSomewherePrivate" tags="widget" position="225,350" size="100,100">&lt;&lt;widget &quot;Allura_GoSomewherePrivate&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Hey do you have maybe like a private room we could go to? We don&#39;t have to like... &lt;strong&gt;DO&lt;/strong&gt; anything, I just wanted to get to know you more.&lt;&lt;/speech&gt;&gt;

Allura&#39;s eyes shine and glow. She feigns emotional damage again, this time less dramatic.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So you want to do nothing with me? &lt;em&gt;Mon trésor.&lt;/em&gt; Here I was thinking my charms were working on you.&lt;&lt;/speech&gt;&gt;

You blush but don&#39;t get a chance to respond before she begins to stand. Her tail brushes down your leg like it has a mind of its own before she gathers to her feet.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Viens.&lt;/em&gt; Come then. Let&#39;s see if the air upstairs is any quieter.&lt;&lt;/speech&gt;&gt;

[[You take her hand and stand.|Allura_GoingUpstairs]]

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="23" name="Allura_ReturnToParlor" tags="widget" position="350,350" size="100,100">&lt;&lt;widget &quot;Allura_ReturnToParlor&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk more later.&lt;&lt;/speech&gt;&gt;

Allura stretches languidly on the chaise, her body language equal parts feline and flame.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Of course, &lt;em&gt;petite&lt;/em&gt;. I&#39;ll still be here — spinning webs and sipping slow poison.&lt;&lt;/speech&gt;&gt;

She raises her glass slightly toward you.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Don&#39;t stay gone too long, hmm? I find myself... growing fond.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
[[You rise and return to middle of the parlor.|Scene02_ReturnToParlor]]
[[You rise and return to middle of the parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="24" name="AlluraRoom" tags="widget" position="475,350" size="100,100">&lt;&lt;widget &quot;AlluraRoom&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Your room is beautiful. Do they all look like this?&lt;&lt;/speech&gt;&gt;

Allura smiles—not the wicked or sultry kind she often uses downstairs, but something softer. Something a little less prepared.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah, you flatter me, mon trésor. But no. Not quite like this.&lt;&lt;/speech&gt;&gt;

She glances around her space, her eyes catching on the hanging lanterns, the draped silks, the round bed cradled in shadow and color.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Each room here belongs to the one who lives in it. Decor is left to taste. Some are sparse. Others look like shrines. Mine...&lt;em&gt;mine is a cocoon&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She reaches her arms to either side, taking handfuls of sheets and pulls them in close to her chin. She softly sways back and forth as a moth would, preparing for the comfort of metamorphasis. 

&lt;&lt;speech &quot;allura&quot;&gt;&gt;I spend more time here than I do anywhere else. So I wanted it to feel like a dream I could live in. A place that would greet me with gentleness, even when the rest of the world is sharp.&lt;&lt;/speech&gt;&gt;

You nod, taking in the details. The smell. The light. The faint brush of silk against your sleeve as you shift where you sit.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It feels safe here.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;That is the idea. Intimacy without expectation. Warmth without heat. Unless you ask for it, of course.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Does it ever get difficult? Sleeping where you— &lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Fuck strangers for money?&lt;&lt;/speech&gt;&gt;

The bluntness catches you off guard. You just shrug a little.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;If I worked anywhere else in the city, it might. Here I know I am protected. Adda is not one easily trifled.&lt;&lt;/speech&gt;&gt;

She winks—playful again, but not dismissive. Just present. Just... Allura.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="25" name="Allura_WhatDoNow" tags="widget" position="600,350" size="100,100">&lt;&lt;widget &quot;Allura_WhatDoNow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So... what do we do now?&lt;&lt;/speech&gt;&gt;

Allura doesn&#39;t answer right away.

She moves to the edge of the bed and folds her legs beneath her, the sheer fabric of her skirt pooling around her like dusk caught in a net. Her eyes follow the gentle flicker of one of the lanterns for a beat before returning to you.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Such a simple question, and yet it always reveals so much.&lt;&lt;/speech&gt;&gt;

She pats the bed beside her—not insistently, just an invitation.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Do you ask because you want to be told what comes next? Or because you want permission to choose it yourself?&lt;&lt;/speech&gt;&gt;

You sit beside her, close enough to feel the warmth of her thigh near yours.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I don&#39;t know yet. Maybe both.&lt;&lt;/speech&gt;&gt;

Allura hums—a thoughtful, amused sound. She turns her body toward you, one hand gently resting between you both, fingers splayed on the silk.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Then let&#39;s just... &lt;em&gt;be&lt;/em&gt; here for a moment.&lt;&lt;/speech&gt;&gt;

She leans back slightly on her hands, her eyes still on yours.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;We don&#39;t have to name it. Not yet.&lt;&lt;/speech&gt;&gt;

Outside, the thunder murmurs like a distant conversation. Inside, the hush is almost sacred.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But I&#39;m glad you asked.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="26" name="Allura_GetComfortable" tags="widget" position="725,350" size="100,100">&lt;&lt;widget &quot;Allura_GetComfortable&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I… get comfortable with you?&lt;&lt;/speech&gt;&gt;

Allura&#39;s lips part, slow and deliberate. She doesn&#39;t blink. She doesn&#39;t breathe. Then—softly—she laughs.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Enfin, putain&lt;/em&gt;. Mon trésor, I thought you&#39;d never ask.&lt;&lt;/speech&gt;&gt;

She rises from the bed in a single, fluid motion, the sheer fabric of her robe catching the lantern light as it flows around her. Her steps toward you are slow, but not hesitant. Intentional. Like she&#39;s savoring the moment as much as the act.

She stops in front of you and holds out her hands—palms up, waiting.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;May I?&lt;&lt;/speech&gt;&gt;

You nod.

She starts with your boots, kneeling as she unlaces them one by one, her fingers brushing your calves, your ankles. Then your leather jerkin, her hands sliding beneath the hem to feel the warmth of your waist before peeling it away. Her touch never lingers longer than it needs to—but it never hurries either.

Next, she rises, her fingers teasing at the waistband of your trousers. She unbuttons them with slow precision, then draws them down your hips, past your thighs, until they fall away and you&#39;re left in only your long tunic and a pair of plain white panties.

You feel the cool air of the room against your skin, and her warmth just in front of you. She looks you over, not with hunger—but appreciation. Admiration.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;There. That&#39;s better.&lt;&lt;/speech&gt;&gt;

She guides you to the bed with a hand at your back and a whisper of a smile. The cushions embrace you as you sit. Then, without breaking eye contact, she climbs onto the bed beside you and drapes one leg over the other, close but not quite touching.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Comfort is a sacred thing, Jaylie. It&#39;s not always earned. But you? You wear it beautifully.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="27" name="AlluraOpenConvoMinigameOne" tags="widget" position="850,350" size="100,100">&lt;&lt;widget &quot;AlluraOpenConvoMinigameOne&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I want to get to know you better. Not just the part you show the room. I mean... you.&lt;&lt;/speech&gt;&gt;

Allura shifts where she sits, her eyes narrowing with intrigue. The corners of her lips curl—not into a smirk, but something softer.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah... a rare pleasure. Careful you don&#39;t go to far. I have been known to bite when provoked.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;allura&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.allura_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="28" name="BackstoryStart" tags="widget" position="975,350" size="100,100">&lt;&lt;widget &quot;BackstoryStart&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I ask you a little bit about your past?&lt;&lt;/speech&gt;&gt;

Allura doesn&#39;t answer immediately. In fact for the first time she seems to be truly caught off guard. She cocks her head to the side and raises an eyebrow.

She reaches up an runs a delicate finger along your face, brushing your cheekbone down to your chin.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Now why would you want to go and do something like that?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I just want to know a little about where you come from.&lt;&lt;/speech&gt;&gt;

Allura seemed to ponder for a moment. The room is silent, she lightly tickles your chin with the tip of her nail.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You may ask anything you like. I am an open book. Not normally, I&#39;m not, but for you I will make an exception.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;allura&quot; &quot;alluraBackstory&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;
/* Allura Backstory Branch - Start */
    :: WhereAlluraGrewUp [widget]
    &lt;&lt;widget &quot;WhereAlluraGrewUp&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Where did you grow up?&lt;&lt;/speech&gt;&gt;

    Allura shifts on the bed, stretching one leg out beneath the silk and draping her arm across a cushion.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Far from here. Farther than you&#39;d guess, I think.&lt;&lt;/speech&gt;&gt;

    Her tone is gentle, not evasive—like she&#39;s choosing each word with care rather than caution.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;A small village in the eastern cliffs of Taramel. You wouldn&#39;t find it on most maps. A place of rock and wind and stubborn people who didn&#39;t take kindly to anything they couldn&#39;t explain. Especially not a girl with gold eyes, blue skin, and a tail.&lt;&lt;/speech&gt;&gt;

    She doesn&#39;t sound bitter, but there&#39;s a weight behind the words—something old and settled.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;My mother was from that village, but one day when I was around 8 years old I went out to watch the other kids play Fae-Ball. When I went back to our hut my mother was gone along with just about everything we owned, which wasn&#39;t much to begin with.&lt;&lt;/speech&gt;&gt;

    She watches your face closely as she talks. When you don&#39;t seem to be offering comment she continues.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;I stayed there only as long as I had to after that. I truly had no one and spent most of my time begging or scrounging for food. Eventually, I gathered enough coin to make it to the next closest town, down out of the mountains. Then I did that again and then again, until I eventually found myself across an ocean and living in Bastion.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you miss it? The cliffs. The people.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Not even for a second, but sometimes when I close my eyes and dream, I can still feel the moutain air blowing on my back, as if I&#39;m not to forget.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;set $currentPhase = &quot;alluraBackstory&quot;&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
   &lt;&lt;run setup[`allura_Conversation_Options_${$currentPhase}`]()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: Parentage [widget]
    &lt;&lt;widget &quot;Parentage&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you know much about your parents?&lt;&lt;/speech&gt;&gt;

    Allura leans back on one elbow, her gaze drifting to the lanterns above, watching them swing faintly with the wind outside.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;My mother, a little. My father... well, I know more about him than I&#39;d like to.&lt;&lt;/speech&gt;&gt;

    She runs a finger along the edge of a cushion, as if tracing the outline of a thought she hasn&#39;t quite dared to speak aloud.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;My mother was human. Village-born. Hard-edged. She worked with herbs—mostly tinctures and poultices, but also... other things. People came to her with needs they couldn&#39;t name. Secrets steeped in boiling water.&lt;&lt;/speech&gt;&gt;

    A faint chuckle escapes her lips, but there&#39;s no joy in it.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;She never spoke of my father. Not once. I asked often. I didn&#39;t understand what I was—so how could I know what he was?&lt;&lt;/speech&gt;&gt;

    She looks at you, her expression unreadable.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And what was he? Did she ever tell you?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;She told me, &quot;&lt;em&gt;C&#39;était une malédiction… qui m&#39;a laissée un cadeau.&lt;/em&gt;&quot;&lt;&lt;/speech&gt;&gt;

    She pauses, letting the words echo. You almost ask for clarification when she speaks again.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;A curse… that left a gift.&lt;&lt;/speech&gt;&gt;

    You see the shimmer of a tear, but she wipes it away before it can earn an identity.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;It wasn&#39;t until years later, in Altherin, that I met a Seer who told me more about my patronage. She did a ritual with a drop of my blood... and found a name buried deep inside it.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Traloin.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Is that a name I should know?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;If you studied the Jade Coast wars, you might. He wasn&#39;t just a demon. He was responsible for razing half of Medmarr and almost destroying Hale about two centuries ago.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.allura_Conversation_Options_alluraBackstory()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: TravelWish [widget]
    &lt;&lt;widget &quot;TravelWish&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If you could go anywhere in the world, where would it be?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Exciting. This question is far less depressing than I would have guessed you&#39;d ask. I like it all the same.&lt;&lt;/speech&gt;&gt;

    She traces a fingertip along the hem of her pillow, thoughtful.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Somewhere warm. Somewhere that I can get naked and run my feet through the sand and swim in water bluer than I am.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That sounds fun. I wouldn&#39;t mind a trip like that either.&lt;&lt;/speech&gt;&gt;

    Allura clicks her tongue at you a few times. A sound of disapproval.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Not a trip for me, &lt;em&gt;Mon Trésor&lt;/em&gt;. The day I find that place, I think I would stay there for the rest of time.&lt;&lt;/speech&gt;&gt;

    She looks at your almost dejected expression.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Still... I would not mind the company.&lt;&lt;/speech&gt;&gt;

    You smile at the invitation.

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 2&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 2&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.allura_Conversation_Options_alluraBackstory()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: StrangeClient [widget]
    &lt;&lt;widget &quot;StrangeClient&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What&#39;s the worst or strangest client you&#39;ve ever had?&lt;&lt;/speech&gt;&gt;

    Allura exhales a long breath through her nose, a single brow rising.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;You know, I thought you&#39;d ask that much sooner. Most people do. It&#39;s usually the first thing that drips out of their curiosity — the scandal, the grotesque, the half-formed fantasy of someone else&#39;s humiliation.&lt;&lt;/speech&gt;&gt;

    She swirls the drink in her hand once, slowly. The glass catches the lamplight like a gemstone.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;But since you&#39;ve waited until now, I&#39;ll reward your patience.&lt;&lt;/speech&gt;&gt;

    She smiles, but it doesn&#39;t quite reach her eyes.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;There was a man—years ago now. Noble type. Clean boots in a muddy city. Came in once a week, every week, like clockwork. Always asked for silence. Would lie down, fully clothed, on the bed. And just… cry.&lt;&lt;/speech&gt;&gt;

    You blink.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Cry?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Loudly. Unapologetically. Never said a word otherwise. No touching, no questions. Just weeping for the full hour. Then he&#39;d leave double payment and vanish into the street like fog.&lt;&lt;/speech&gt;&gt;

    She tilts her head back slightly, eyes drifting upward.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;I don&#39;t know what broke him, or why I was the one he chose to break in front of. But there&#39;s something sacred about being someone&#39;s safe place—even if they can&#39;t say your name.&lt;&lt;/speech&gt;&gt;

    A hush falls between you, deeper than the storm outside. You don&#39;t feel the need to fill it.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;That was the strangest. The worst? Perhaps another time.&lt;&lt;/speech&gt;&gt;

    She winks—softly this time—and sips her drink.

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.allura_Conversation_Options_alluraBackstory()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;

    :: BackstoryExit [widget]
    &lt;&lt;widget &quot;BackstoryExit&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Thanks for sharing all that with me. I&#39;d like to talk about something else now, if that&#39;s alright.&lt;&lt;/speech&gt;&gt;

    Allura gives a soft nod and a smile touched with warmth.

    &lt;&lt;speech &quot;allura&quot;&gt;&gt;Of course, mon trésor. Curiosity comes in waves. I&#39;ll be here when the next one rises.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;DialogueTree &quot;allura&quot; &quot;Phase1&quot;&gt;&gt;
    &lt;&lt;/widget&gt;&gt;
/* Allura Backstory Branch - End */</tw-passagedata><tw-passagedata pid="29" name="KissAllura" tags="widget" position="1100,350" size="100,100">&lt;&lt;widget &quot;KissAllura&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I kiss you?&lt;&lt;/speech&gt;&gt;

Allura blinks—slow and deliberate. Her smile curves like a question, but she doesn&#39;t answer immediately. Instead, she shifts on the bed, drawing her knees up slightly as her fingers press into the silk.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You&#39;ve asked for a lot tonight, &lt;em&gt;mon trésor&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

She leans toward you—but only just enough to make you ache for the rest of the distance.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;But a kiss? A real one? That isn&#39;t something I give. It&#39;s something you take.&lt;&lt;/speech&gt;&gt;

You feel the room tilt—not physically, but like the air has changed. Her eyes hold yours, daring you to break the space between you. Your eyes lock on her lips, their luscious hue of blue drawing desire out of you all their own. 

She speaks slowly.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So come take it, if you want it.&lt;&lt;/speech&gt;&gt;

&lt;p&gt;You do.&lt;/p&gt;

You reach for her slowly, one hand brushing her cheek, the other resting on the edge of the bed for balance. And when your lips finally meet—gods, it&#39;s everything. Soft. Warm. Hungrier than you meant it to be, and slower than you expected. She tastes faintly of wine and pomegranate, and the kiss deepens before you even realize it has.

One of her hands finds your waist. The other curls behind your neck, anchoring you in the moment like she doesn&#39;t want it to end.

When you part, neither of you speak at first. Her forehead rests against yours, and her breath is a shared thing between you now.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mmm. Worth the wait. I am not done with you though, &lt;em&gt;Jaylie&lt;/em&gt;. &lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;affection&quot; 3&gt;&gt;
&lt;&lt;relation &quot;allura&quot; &quot;trust&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;StartSexScene &quot;allura&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Allura_PostSexPhase1&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="30" name="JustLay" tags="widget" position="1225,350" size="100,100">&lt;&lt;widget &quot;JustLay&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If it&#39;s alright... I think I&#39;d just like to lay here with you.&lt;&lt;/speech&gt;&gt;

Allura tilts her head, surprised—but not displeased. Her smile softens like warm silk folding.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;No rush, no performance... I like that. Come, then. Let&#39;s waste time beautifully.&lt;&lt;/speech&gt;&gt;

She pulls back a layer of cushions and makes space beside her with a lazy, fluid grace. You slide closer.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Lay your head here. Just for a while.&lt;&lt;/speech&gt;&gt;

[[You curl beside her and close your eyes.|Allura_JustLay_Route]]

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="31" name="Bert_DenyMinigame" tags="widget" position="100,475" size="100,100">&lt;&lt;widget &quot;Bert_DenyMinigame&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I want to get to know you better.&lt;&lt;/speech&gt;&gt;
  Bert does not break eye contact, nor does he hesiate for a moment in his polishing of the glass in his hand.
  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Unfortunately Miss, that&#39;s not on the menu.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.bert_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="32" name="Bert_OpenShop" tags="widget" position="225,475" size="100,100">&lt;&lt;widget &quot;Bert_OpenShop&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Drinks are listed behind me. If it&#39;s wet and numbs the tongue, I probably have it.&lt;&lt;/speech&gt;&gt;

  He glances toward a modest slate board mounted near the shelf. The handwriting is neat, efficient—chalked in white and underlined.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Ale, spirits, something local we call ‘Red Mercy&#39;—not for the faint-hearted. I&#39;ve also got roasted nuts if you need to fool your stomach into thinking it&#39;s eaten.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.openShop(&quot;bert&quot;)&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="33" name="Bert_CustomDrink" tags="widget" position="350,475" size="100,100">&lt;&lt;widget &quot;Bert_CustomDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I don&#39;t usually have such a selection to drink from. I&#39;m not even sure what to ask for.&lt;&lt;/speech&gt;&gt;
  Bert raises an eyebrow at you as if waiting for you to get the the point of your request.
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; Would you mind making something special for me? I&#39;ll trust your judgement.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt; Something special you say? I would delight in the occasion, Miss.&lt;&lt;/speech&gt;&gt;
    With a quick flourish of his arms, a shining metal cup is produced from under the counter, catching the glow of the hanging lanterns as if it had been waiting for just this moment. Bert runs a cloth over it with meticulous care, inspecting it like a jeweler inspecting a rare gem.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;You strike me as someone with fire in her spirit, but a touch of sadness behind the eyes. Let&#39;s see if we can match that with something... complicated.&lt;&lt;/speech&gt;&gt;

  He turns to the shelf behind him, fingers ghosting over rows of vividly colored bottles, some of which emit a faint shimmer or trace of smoke within their glass. He selects four: 
    -A bottle of *Whisperleaf Gin*—a pale green spirit known for its calming aftertaste
    - *Ashplum Cordial*—a dark, bitter-sweet reduction brewed in volcanic soil, 
    -A vial of *Feyroot Elixir*—glowing faintly pink and said to react to emotion, 
    -A twist-top jar of crushed *Iceblossom Petals*—frosted over like snowflakes.

  Bert begins to mix. 

  He measures with an instinctual confidence, pouring the gin in first—a sharp, cool base that fogs the metal cup. The cordial follows, swirling through like a bloodstain in silver. The elixir is added last, just a drop, but as it hits the mix, you swear the entire cup glows for a brief moment.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;And now for the ice...&lt;&lt;/speech&gt;&gt;

  He reaches into a chilled drawer and pulls out a single crystalline sphere—transparent, but with what looks like a tiny storm cloud suspended in its center. He cracks it gently against the bar&#39;s edge, letting the shards fall like glass snow into the cup. A cover is placed over the top, of the metal cup and Bert quickly begins to shake it with a certain measure and efficiency.

  After a moment, one of Bert&#39;s hands reaches from above and pulls down a conical, crystal glass. He sets the glass on its edge and gives it a spin. The glass twirls rapidly in place, balancing in such a way that almost defies reason.

  Quickly bert removes the lid of the metal container and pours into the glass as it spins. The contents create a spiral of green and blue which quickly meld together in a vibrant color reminiscent of a dark sea.

  Bert finishes by garnishing the rim with a single frozen petal and a twist of a dark citrus rind, its scent a faint mix of orange and something darker, more elusive.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Here we are madam. I call it a *Storm of Grace.* Because it looks delicate, tastes bold, and lingers longer than it should. Like some people.&lt;&lt;/speech&gt;&gt;

  He slides the drink towards you and watches you closely for a moment, awaiting your reaction.

  You bring the glass to your lips. Inhaling for a moment, you inhale an exciting aroma, sweet and light. You sip.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Wow. This is... incredible!&lt;&lt;/speech&gt;&gt;
  
  The bartender smiles, just a hint of pride, gone before you were sure you actually saw it. He nods ever so slightly.

  &lt;&lt;speech &quot;bert&quot;&gt;&gt; Please enjoy Miss. This one is on the house, compliments of the Madam.&lt;&lt;/speech&gt;&gt;
  
  You glance over to Adda, watching from now so far away. You smile, raise your glass to her. She smiles and nods before turning her attention back to the rest of the parlor.
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.bert_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="34" name="Bert_SeriousResponse" tags="widget" position="475,475" size="100,100">&lt;&lt;widget &quot;Bert_SeriousResponse&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You seem to take your job very seriously.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt;Well one could hardly expect to deliver a standard of professionalism without taking one&#39;s occupation seriously, Ma&#39;am.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; So you aren&#39;t so serious in your personal life?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;bert&quot;&gt;&gt; I like to keep things professional.&lt;&lt;/speech&gt;&gt;
  His avoidance of his personal life as a topic is palpable. You decide to drop the subject.
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.bert_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="35" name="Bert_ReturnToParlor" tags="widget" position="600,475" size="100,100">&lt;&lt;widget &quot;Bert_ReturnToParlor&quot;&gt;&gt;
&lt;&lt;append #convoBox&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I think I&#39;ll explore the rest of the parlor.&lt;&lt;/speech&gt;&gt;
&lt;&lt;speech &quot;bert&quot;&gt;&gt; Of course, Miss. Please enjoy your evening.&lt;&lt;/speech&gt;&gt;

[[You step away from the bar.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="36" name="Brakka_Howareyoutonight" tags="widget" position="725,475" size="100,100">&lt;&lt;widget &quot;Brakka_Howareyoutonight&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;How are you doing tonight?&lt;&lt;/speech&gt;&gt;

Brakka lifts her mug and downs a swig without looking at you.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;I must’ve looked like I was doing pretty damn well for you to walk up that casual.&lt;&lt;/speech&gt;&gt;

She wipes her mouth with the back of her hand and finally gives you a once-over.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Listen &lt;em&gt;Silks&lt;/em&gt;, unless you&#39;ve got business with me, I&#39;d prefer to finish my meal in peace so I can get home before this storm drowns the city.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

She let&#39;s out a little grunt before taking another swig from her mug, the foaming liquid runs down her chin which she wipes with the back of a greasy hand.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="37" name="Brakka_WhySilks" tags="widget" position="850,475" size="100,100">&lt;&lt;widget &quot;Brakka_WhySilks&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Why do you keep calling me &quot;Silks&quot;?&lt;&lt;/speech&gt;&gt;

Brakka doesn’t answer at first. She tears another bite from her mutton, chews, and swallows without rushing.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Because you&#39;re soft.&lt;&lt;/speech&gt;&gt;

You blink. She looks at you like that should’ve been the full explanation.

A beat passes. Brakka lets out a slow exhale—half sigh, half surrender—and gestures vaguely in your direction with the bone still in her hand.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You walk like the ground was paved for you. Like the floorboards were laid so your steps wouldn’t creak.&lt;&lt;/speech&gt;&gt;

She takes a quick bite of her mutton, but doesn&#39;t pause to chew. She continues, muffled, through thick chomps of meat.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You approach strangers like they owe you the conversation. Everything about you is soft. Your clothes. Your voice. Your hair. Your skin.&lt;&lt;/speech&gt;&gt;

She narrows her eyes, not unkindly—but weighing you.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You look like someone who’s never had to fight hard for much in her life. Like someone who’s known luxury. Silk sheets. Soft hands. Easy roads.&lt;&lt;/speech&gt;&gt;

She turns her gaze back toward the fire.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Talk to me again when you wear a few scars.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="38" name="Brakka_FightComment" tags="widget" position="975,475" size="100,100">&lt;&lt;widget &quot;Brakka_FightComment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You look like you’ve seen some fights.&lt;&lt;/speech&gt;&gt;

Brakka lets out a low grunt—could be amusement, could be approval. She tears off another bite of meat and speaks with her mouth half full.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Few. Guild sends me where the coin flows. Sometimes that’s escort duty. Sometimes it’s cracking skulls at the edge of the provinces.&lt;&lt;/speech&gt;&gt;

She finally looks at you, eyes sharp but not unkind.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;This city&#39;s soft, &lt;em&gt;Silks&lt;/em&gt;, but the bastards crawling outside it? They know how to bleed.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

She takes a swig from her mug and wipes her mouth with the back of her wrist.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;If you’re asking whether I’ve earned my scars—yeah. I’ve earned ’em.&lt;&lt;/speech&gt;&gt;

She goes quiet again, shifting her weight against the beam, her focus already drifting back to her meal.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="39" name="Brakka_HelloAttempt" tags="widget" position="1100,475" size="100,100">&lt;&lt;widget &quot;Brakka_HelloAttempt&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I just wanted to say hi.&lt;&lt;/speech&gt;&gt;

Brakka doesn’t look up. She just rips another chunk from the mutton bone and chews slowly, deliberately.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;You just did.&lt;&lt;/speech&gt;&gt;

She finally lifts her eyes—just enough to make it feel like a warning.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Now unless you’re here to fight, drink, or pay off a debt, take your manners elsewhere, &lt;em&gt;Silks&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.brakka_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="40" name="Brakka_ExitwithTournyInvite" tags="widget" position="1225,475" size="100,100">&lt;&lt;widget &quot;Brakka_ExitwithTournyInvite&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Enjoy your meal.&lt;&lt;/speech&gt;&gt;

Brakka grunts—noncommittal, but not dismissive. She downs what’s left in her mug and eyes you over the rim.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;If you’re feeling not-so-soft, come find me during the fair.&lt;&lt;/speech&gt;&gt;

She tosses the bare mutton bone into the fire and cracks her knuckles one-handed.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Guild’s hosting a tournament. I’ll be there. Figured I’d offer you the chance to prove me wrong—or right. Either way, I’ll enjoy the show.&lt;&lt;/speech&gt;&gt;

&lt;&lt;if not $TalkedTo_Brakka&gt;&gt;
  &lt;&lt;set $TalkedTo_Brakka = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You step away from the hearth and return to the main tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="41" name="Brakka_ExitNormally" tags="widget" position="100,600" size="100,100">&lt;&lt;widget &quot;Brakka_ExitNormally&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Enjoy your meal.&lt;&lt;/speech&gt;&gt;

Brakka doesn’t look up—just raises her mug slightly in acknowledgment and takes a slow drink.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Might do, Silks.&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

&lt;&lt;if not $TalkedTo_Brakka&gt;&gt;
  &lt;&lt;set $TalkedTo_Brakka = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You turn back toward the tavern’s main floor.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="42" name="Darian_HowLongHere" tags="widget" position="225,600" size="100,100">&lt;&lt;widget &quot;Darian_HowLongHere&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So how long have you worked here?&lt;&lt;/speech&gt;&gt;

Darian leans back a little, glancing around the room with something like fondness. Not for the building, necessarily—but for the people moving within it.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;A few years, give or take. I wasn&#39;t planning to stay this long, but... the place has a way of pulling you in.&lt;&lt;/speech&gt;&gt;

He shrugs, though there&#39;s more weight behind it than he lets on.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;It&#39;s not the walls, it&#39;s the people. We look after each other. You don&#39;t find that everywhere. Especially not in this line of work.&lt;&lt;/speech&gt;&gt;

He looks at you, warm but steady.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You learn a lot about someone when you&#39;re the reason they let their guard down. It&#39;s not always pretty. But sometimes... sometimes it&#39;s beautiful.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="43" name="Darian_DoYouLikeJob" tags="widget" position="350,600" size="100,100">&lt;&lt;widget &quot;Darian_DoYouLikeJob&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you actually enjoy this job?&lt;&lt;/speech&gt;&gt;

Darian&#39;s eyebrows lift slightly, then settle into a thoughtful expression. He doesn&#39;t laugh it off or dodge—it&#39;s clear he&#39;s been asked this before.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Some nights more than others.&lt;&lt;/speech&gt;&gt;

He smiles—genuine, not forced.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I won&#39;t pretend every moment is fulfilling. But I meet people. I learn from them. Sometimes I help them feel human again, even if just for a little while. That means something to me.&lt;&lt;/speech&gt;&gt;

His fingers absentmindedly trace the edge of a nearby glass, thoughtful.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;The job isn&#39;t really about what we do. It&#39;s about what people leave with. And when I get that part right... yeah. I like it.&lt;&lt;/speech&gt;&gt;


&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="44" name="Darian_Bracelet" tags="widget" position="475,600" size="100,100">&lt;&lt;widget &quot;Darian_Bracelet&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That bracelet you&#39;re wearing... where did it come from?&lt;&lt;/speech&gt;&gt;

Darian glances down at his wrist like he forgot it was even there. His fingers graze the band slowly, almost unconsciously.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;It was a gift. From someone important.&lt;&lt;/speech&gt;&gt;

He doesn&#39;t elaborate, not right away. His eyes lose focus for a moment—caught somewhere between memory and the present.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I&#39;ve worn it every day since they gave it to me. It&#39;s held up surprisingly well... not unlike the person who made it.&lt;&lt;/speech&gt;&gt;

There&#39;s a small pause—long enough for you to sense he&#39;s choosing what *not* to say.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Maybe I&#39;ll tell you more about it sometime. If the night keeps going like this.&lt;&lt;/speech&gt;&gt;

He offers a smile—not flirtatious this time, just sincere.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="45" name="Darian_GetDrink" tags="widget" position="600,600" size="100,100">&lt;&lt;widget &quot;Darian_GetDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think you could help me get a drink?&lt;&lt;/speech&gt;&gt;

Darian chuckles softly.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You asking because you want a drink, or because you want an excuse to talk to me longer?&lt;&lt;/speech&gt;&gt;

Before you can answer, he lifts a hand to catch Bert&#39;s attention.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Bert, can we get something a little warm but not too strong? Something for thinking, not forgetting.&lt;&lt;/speech&gt;&gt;

Bert grunts from the far end of the bar, already reaching for bottles.

&lt;&lt;speech &quot;bert&quot;&gt;&gt;So... not the ‘Red Mercy,&#39; then. Got it.&lt;&lt;/speech&gt;&gt;

Darian leans in slightly, lowering his voice.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;He pretends to be grumpy, but he&#39;s one of the kindest souls in this place. That drink you&#39;re about to get? He only makes it for people he actually likes.&lt;&lt;/speech&gt;&gt;

He straightens as Bert slides a glass across the counter. The liquid inside glows a soft amber, curling with steam.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Try that. It&#39;s got a name, but I like calling it &#39;Second Wind.&#39; Makes you feel like the night&#39;s still got promise.&lt;&lt;/speech&gt;&gt;

You lift the glass and breathe in.

The aroma is warm and spiced—notes of orange peel, clove, and something almost floral beneath the heat. When you take a sip, it&#39;s smoother than you expected. The burn is soft, the flavor deep. It blooms across your tongue like dusk settling into firelight.

It doesn&#39;t dull your senses. It *clarifies* them.

You lower the glass, exhaling slow.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s... actually perfect.&lt;&lt;/speech&gt;&gt;

Darian smiles. Not smug. Just pleased.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I thought you might say that.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="46" name="Darian_Humming" tags="widget" position="725,600" size="100,100">&lt;&lt;widget &quot;Darian_Humming&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You hum a lot. Were you a musician once?&lt;&lt;/speech&gt;&gt;

Darian pauses, the question catching him mid-thought. He laughs softly—but there&#39;s a heaviness under it, like the air changes just a little.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Yeah... I was. Before all this.&lt;&lt;/speech&gt;&gt;

He glances down at his hands, flexing his fingers like they still remember a different rhythm.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I was trained in opera. Classical stuff. Big stages, packed halls, fancy suits with too much starch in the collars.&lt;&lt;/speech&gt;&gt;

His eyes go distant for a moment.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I used to love it. Music made sense in ways life didn&#39;t. I could climb an aria like a staircase and feel like I&#39;d gone somewhere worth arriving.&lt;&lt;/speech&gt;&gt;

A quiet beat.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;But that was before. Before a lot of things changed.&lt;&lt;/speech&gt;&gt;

He doesn&#39;t say more—not here, not yet—but you can tell the story&#39;s still close behind his smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Now I hum to keep pieces of it close. Not for performance. Just... for me.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="47" name="Darian_StartMinigame" tags="widget" position="850,600" size="100,100">&lt;&lt;widget &quot;Darian_StartMinigame&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I just want to get to know you better.&lt;&lt;/speech&gt;&gt;

Darian tilts his head, his expression unreadable for a moment—thoughtful, maybe a little surprised. Then he smiles, slow and sincere.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;That&#39;s not something I hear very often. At least not from people who mean it.&lt;&lt;/speech&gt;&gt;

He leans against the bar, arms folded lightly.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Alright, then. Let&#39;s talk. But fair warning—I&#39;m not always the easiest book to read.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;darian&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="48" name="Darian_GoPrivate" tags="widget" position="975,600" size="100,100">&lt;&lt;widget &quot;Darian_GoPrivate&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think we could go somewhere more private?&lt;&lt;/speech&gt;&gt;

Darian doesn&#39;t answer immediately. His gaze lingers on you a moment longer than usual, soft but searching.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;We could. If that&#39;s really what you want.&lt;&lt;/speech&gt;&gt;

His voice isn&#39;t challenging—it&#39;s careful, like he wants to be sure you&#39;re not asking just to fill the space between you.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;My room in the hallway upstairs is relatively quiet this time of night, and far more private overall. No one will bother us there.&lt;&lt;/speech&gt;&gt;

He steps forward, extending a hand—not dramatic, not performative. Just steady.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Come on. I&#39;ll walk with you.&lt;&lt;/speech&gt;&gt;

[[You take his hand and follow him.|Darian_GoingUpstairs]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="49" name="Darian_ReturnToParlor" tags="widget" position="1100,600" size="100,100">&lt;&lt;widget &quot;Darian_ReturnToParlor&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I hope you don&#39;t mind, I think I am going to explore the parlor a bit more.&lt;&lt;/speech&gt;&gt;

Darian nods, easy and warm.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Of course. The night&#39;s still young—plenty of stories left to find.&lt;&lt;/speech&gt;&gt;

He gives a small bow of the head and gestures subtly back toward the center of the lounge.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;If you change your mind... you know where to find me.&lt;&lt;/speech&gt;&gt;

[[You walk back to the middle of the parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="50" name="Darian_RoomComment" tags="widget" position="1225,600" size="100,100">&lt;&lt;widget &quot;Darian_RoomComment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I like your room. Are they all like this?&lt;&lt;/speech&gt;&gt;

Darian smiles faintly, glancing around at the heavy curtain-lined walls like he&#39;s seeing them through someone else&#39;s eyes.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Not quite. Each host decorates their own. Some lean decadent. Others lean... chaotic.&lt;&lt;/speech&gt;&gt;

He runs a hand along one of the thick curtains.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;These started as an attempt to make the place feel more like a theater. Turns out, they&#39;re also pretty good at keeping sound in. Which is useful, apparently, because not all the customers enjoy spontaneous arias through the walls.&lt;&lt;/speech&gt;&gt;

He laughs softly, then looks at you with just a hint of that stage-smile beneath the surface.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I try not to take it personally, but I do sing quieter now.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="51" name="Darian_WhatNow" tags="widget" position="100,725" size="100,100">&lt;&lt;widget &quot;Darian_WhatNow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So... what do we do now?&lt;&lt;/speech&gt;&gt;

Darian leans back slightly, resting his hands behind him on the bed. His smile curves just a little, thoughtful rather than teasing.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;That depends on what you need from tonight.&lt;&lt;/speech&gt;&gt;

He shifts to look at you more directly, his tone quiet but grounded.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Some people come here to forget. Others come to feel something real. A few aren&#39;t even sure why they showed up—they just didn&#39;t want to be alone.&lt;&lt;/speech&gt;&gt;

He shrugs—not indifferent, but understanding.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;I don&#39;t have a script for this part. We write it together.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="52" name="Darian_HowsYourNight" tags="widget" position="225,725" size="100,100">&lt;&lt;widget &quot;Darian_HowsYourNight&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So how&#39;s your night been? You know... before I showed up and clearly became the highlight of it.&lt;&lt;/speech&gt;&gt;

Darian laughs, low and honest.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Dangerously bold of you to assume you were the highlight at all. I&#39;ll have you know I have been proposed to by &lt;em&gt;three&lt;/em&gt; women tonight.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Only three? Clearly you&#39;re slipping.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;darian&quot;&gt;&gt;One of them offered me a goat in exchange. I almost said yes just to see if she&#39;d actually follow through.&lt;&lt;/speech&gt;&gt;

You both laugh for a moment before the room goes quiet again. The walls absorbing the laughs like they were hungry for it. Darian speaks again through a half-hearted smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;But in truth? It&#39;s been a long night. Not bad. Just... long. The kind that leaves you a little quiet inside.&lt;&lt;/speech&gt;&gt;

He exhales gently, like saying that out loud takes some of the weight off.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Still, you showing up when you did? Definitely helped balance the scales.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.darian_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="53" name="Darian_AskDeeper" tags="widget" position="350,725" size="100,100">&lt;&lt;widget &quot;Darian_AskDeeper&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I ask you some more personal questions?&lt;&lt;/speech&gt;&gt;

Darian arches a brow, his smile tugging crooked at the edges.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You can—but they won&#39;t come cheap.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh. I, uh... I have coin.&lt;&lt;/speech&gt;&gt;

He laughs softly, shaking his head.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Keep your coin, girl. I meant you&#39;ll pay with answers of your own.&lt;&lt;/speech&gt;&gt;

He leans forward slightly, eyes steady now—no longer teasing.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Fair exchange. You ask. I ask. We both leave a little lighter.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;darian&quot; &quot;DarianDialogueDuet&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;


/*DarianDialogueDuet - Start */
    :: DarianDuet_Bracelet [widget]
    &lt;&lt;widget &quot;DarianDuet_Bracelet&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Tell me about that bracelet.&lt;&lt;/speech&gt;&gt;

    Darian lifts his wrist slightly, glancing at the worn gold band like he forgot it was there. His smile twists—not embarrassed, exactly. Just private.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;That&#39;s not a question.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Alright, fine. Who gave you the bracelet?&lt;&lt;/speech&gt;&gt;

    He runs his thumb over the clasp once. Slowly.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;My sister. The one person who knew me before the stage, before the noise. She made it by hand when we were younger. Said I needed something to wear that wasn&#39;t an act.&lt;&lt;/speech&gt;&gt;

    A beat.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I don&#39;t take it off. Not ever.&lt;&lt;/speech&gt;&gt;

    He lets that linger, then leans slightly closer—eyes on you now, not the bracelet.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;My turn.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Who is this girl wearing royal-cut leather, trying so hard not to be a girl?&lt;&lt;/speech&gt;&gt;

    You freeze.

    It isn&#39;t accusation. It&#39;s observation. Quiet. Precise.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;You carry yourself like a noble, but you look at people like you&#39;re still hoping you can be one of them. That&#39;s not common. Especially not in this city.&lt;&lt;/speech&gt;&gt;

    You open your mouth, but the words come slower than you expect.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re sharp. I am a noble. I don&#39;t get out often enough because of it, so moments like this are special to me. I often wish I was on this side of that wall. Being born never felt much like the gift people make it out to be.&lt;&lt;/speech&gt;&gt;

    Darian&#39;s voice softens.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Keep it up then noble-girl. Perhaps you&#39;ll be a &#39;noble of the people&#39; one day. Gods know we don&#39;t have enough of those. Common folk starve while the rich can eat themselves to bursting.&lt;&lt;/speech&gt;&gt;

    You frown slightly. Darian notices.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I apologize. That wasn&#39;t an accusation. Quite the opposite. Like I said, we need more people like you.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_Performing [widget]
    &lt;&lt;widget &quot;DarianDuet_Performing&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What was it like to travel around performing?&lt;&lt;/speech&gt;&gt;

    Darian leans back against the curtain-lined wall, head tilted, gaze drifting.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Lonely. But rewarding. Like lighting candles in the dark and hoping someone out there is warmed by the glow.&lt;&lt;/speech&gt;&gt;

    He breathes out through his nose, not quite a sigh.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;For a while, my sister traveled with me. She was the pragmatic one. Knew when to rest. Knew when I was pushing too hard. She got sick, though. Had to settle. I stayed close when I could... but life pulls in too many directions.&lt;&lt;/speech&gt;&gt;

    He doesn&#39;t say the rest right away. He just looks down at his hands.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;When she passed, I didn&#39;t even know until days after. No final song. No goodbye. Just... silence. And after that, the stage never felt like it had room for me anymore.&lt;&lt;/speech&gt;&gt;

    He looks solemn for a moment before looking back at you.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Your turn.&lt;&lt;/speech&gt;&gt;

    He looks at you now, not accusing, but searching.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Was it your mother or father?&lt;&lt;/speech&gt;&gt;

    You blink.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;One of them died. I can tell. You speak like someone who carries the absence of a parent like a second name.&lt;&lt;/speech&gt;&gt;

    You hesitate, then lower your gaze.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;My mother. She died giving birth to me.&lt;&lt;/speech&gt;&gt;

    He nods slowly. Not with pity—just understanding.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I thought so. You don&#39;t dress like a girl who was raised by her mother.&lt;&lt;/speech&gt;&gt;

    You glance down at yourself, a soft scoff rising from your throat.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Guess I didn&#39;t realize that was a style now.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Not style. Energy. You dress like someone who had to learn softness the hard way.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_WhyNoctail [widget]
    &lt;&lt;widget &quot;DarianDuet_WhyNoctail&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Why did you start working at the Noctail?&lt;&lt;/speech&gt;&gt;

    Darian gives a short laugh—one with no real humor behind it.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Because there&#39;s no applause in grief. And no stage that wants a broken voice.&lt;&lt;/speech&gt;&gt;

    He shifts, hands clasped loosely in his lap.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;After my sister passed, I couldn&#39;t sing without feeling like the echo was chasing me. I tried. Gods, I tried. But every theater felt too big. Too empty.&lt;&lt;/speech&gt;&gt;

    His voice lowers.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;So I came here. Not because I wanted to be touched, or paid, or even needed... but because I wanted to disappear into something smaller. Something real. Where no one claps when you bleed well.&lt;&lt;/speech&gt;&gt;

    He pauses, then looks around the room—not wistfully, but with something close to gratitude.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Strange thing is... I didn&#39;t disappear. I just stopped performing. And somewhere in the quiet, I started to feel like I belonged again.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;The others here—Adda, Bert, Marie... they became something like family. They don&#39;t need me to dazzle. They just need me to show up. And I can do that.&lt;&lt;/speech&gt;&gt;

    He lets the silence settle. Then:

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Now it&#39;s my turn...Why did *you* come here tonight?&lt;&lt;/speech&gt;&gt;

    You falter—not because you don&#39;t know, but because no one&#39;s asked it quite like that.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Honestly? I&#39;m not sure. I went out tonight because I wanted to drink.&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t let that sit.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;What were you trying to drown?&lt;&lt;/speech&gt;&gt;

    You hesitate, gaze falling.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It&#39;s my birthday.&lt;&lt;/speech&gt;&gt;

    He blinks once, then nods—like it clicks into place.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;My birthdays have never been a happy occasion. Just reminders. Of what&#39;s gone. Of what&#39;s expected. Of what I&#39;ll never quite live up to.&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t interrupt. He just watches you, steady as the curtains lining his room.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Then I&#39;m glad you came here. And I hope, just for tonight... you get to forget every bit of that.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_StageLove [widget]
    &lt;&lt;widget &quot;DarianDuet_StageLove&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Did you ever fall in love on stage?&lt;&lt;/speech&gt;&gt;

    Darian laughs, the sound low but fond—like a memory he&#39;s already forgiven himself for.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Far too many times. It&#39;s a dangerous thing, singing love into the dark and pretending you don&#39;t mean it.&lt;&lt;/speech&gt;&gt;

    He leans forward, elbows on knees.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I fell for duets, for glances across the wings, for the way some people touched your hand like it was the first time &lt;strong&gt;every&lt;/strong&gt;time. But the stage is a mirror, not a home. Love there doesn&#39;t last—it just echoes.&lt;&lt;/speech&gt;&gt;

    His smile falters, just slightly.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Still, I&#39;d be lying if I said I didn&#39;t chase it. And some of those moments? They were real. Even if they didn&#39;t survive the final bow.&lt;&lt;/speech&gt;&gt;

    He meets your gaze again.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;My turn.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;When was the last time someone looked at you and didn&#39;t want something?&lt;&lt;/speech&gt;&gt;

    The question hits deeper than you expect. You try to answer—but nothing comes right away.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I... don&#39;t know.&lt;&lt;/speech&gt;&gt;

    You smile, but it&#39;s brittle.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Maybe that&#39;s why I&#39;m here.&lt;&lt;/speech&gt;&gt;

    Darian watches you for a breath, then nods. The air between you shifts—quieter now, but fuller.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Then I hope I&#39;m not the exception. Just the reminder you deserved.&lt;&lt;/speech&gt;&gt;

    He says it without ceremony. No smile. No teasing tone. Just truth.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;That you&#39;re still worth looking at... without wanting to take anything away.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_MissOldLife [widget]
    &lt;&lt;widget &quot;DarianDuet_MissOldLife&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you ever miss the life you had before all this?&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t answer right away. His gaze drops—not distant, but inward. Like he&#39;s checking a wound to see if it still stings.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;No. Not exactly.&lt;&lt;/speech&gt;&gt;

    He leans back, the curtain behind him pressing in like quiet velvet.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I remember it fondly. The stages. The travel. The music. The way it all felt like I was part of something larger than myself.&lt;&lt;/speech&gt;&gt;

    A pause.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;But missing it... that would mean wanting it back. And I know what it would cost to have that again.&lt;&lt;/speech&gt;&gt;

    He taps the bracelet lightly with one finger.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I don&#39;t need the stage. I needed her. The rest was just echo.&lt;&lt;/speech&gt;&gt;

    He glances at you—not fragile, but stripped down to something real.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Your turn. Where would you go if you didn&#39;t have to be anyone tonight?&lt;&lt;/speech&gt;&gt;

    You think on it for a moment.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Poor choice of question. It answers itself don&#39;t you think? This was my attempt at not being anyone tonight. Yet it still feels like running away from something rather than being something else.&lt;&lt;/speech&gt;&gt;

    Darian smiles gently.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Then maybe it&#39;s not about being something else. Maybe it&#39;s about letting yourself &lt;strong&gt;be&lt;/strong&gt;, without needing a title to go with it.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: DarianDuet_MostBeautiful [widget]
    &lt;&lt;widget &quot;DarianDuet_MostBeautiful&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What&#39;s the most beautiful thing you&#39;ve ever seen?&lt;&lt;/speech&gt;&gt;

    Darian doesn&#39;t answer immediately. When he does, it&#39;s without flourish.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Oh I remember. Once after a show I found myself not quite able to go to sleep, so I went out and explored the city. The theater I had been in, I learned, was brand new because the old one in the city had burned down. Rather than build on top of the ashes, the town left the old theater still standing. I made a mission of finding it.&lt;&lt;/speech&gt;&gt;

    He smiles faintly, the memory distant but polished.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;I found the old theater a few blocks away and was terrified upon my approach because I heard a truly haunting voice coming from within. I&#39;ve no clue what came over me because despite thinking it must be haunted I was drawn inside like a sailor to a siren. There was no vengeful spirit though, just a girl standing on the remnants of the old stage, singing her heart out to an empty theater, now an audience of one. Her voice cracked halfway through, and she laughed at herself. Kept singing anyway. That was years ago. I never learned her name. But I still remember how the sound carried through the rain.&lt;&lt;/speech&gt;&gt;

    He turns to you now—softer, but not fragile.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;What about you? What moment do you carry around when the world&#39;s too loud?&lt;&lt;/speech&gt;&gt;

    You breathe in, slow. A flicker of something rises—small, strange, but real.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;There&#39;s a well behind the old barracks. When I was a child, I used to sit there and listen to the wind echo down the stone. It sounded like a voice trying to remember a song it had almost forgotten.&lt;&lt;/speech&gt;&gt;

    Darian&#39;s gaze doesn&#39;t waver.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;Maybe that&#39;s what we are, then. Songs trying to remember themselves.&lt;&lt;/speech&gt;&gt;

    You laugh at him, not cruelly. 

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You are so full of cheesey clichés.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;/append&gt;&gt;
    &lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 1&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;run setup.darian_Conversation_Options_DarianDialogueDuet()&gt;&gt;
    &lt;&lt;/widget&gt;&gt;



    :: ReturnToDarianPhase1 [widget]
    &lt;&lt;widget &quot;ReturnToDarianPhase1&quot;&gt;&gt;
    &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Let&#39;s talk about something else.&lt;&lt;/speech&gt;&gt;

    Darian nods once, as if to say: *Of course.*

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;The world will still be waiting for us after the quiet. No need to rush back into it.&lt;&lt;/speech&gt;&gt;

    He leans back slightly, letting the moment stretch just long enough to breathe.

    &lt;&lt;speech &quot;darian&quot;&gt;&gt;So... what else would you like to know?&lt;&lt;/speech&gt;&gt;

    &lt;&lt;/append&gt;&gt;
    &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
    &lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase1&quot;&gt;&gt;
    &lt;&lt;/widget&gt;&gt;
/* DarianDialogueDuet - End */</tw-passagedata><tw-passagedata pid="54" name="Darian_AskToKiss" tags="widget" position="475,725" size="100,100">&lt;&lt;widget &quot;Darian_AskToKiss&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I kiss you?&lt;&lt;/speech&gt;&gt;

Darian doesn&#39;t respond immediately. He watches you for a moment, the playful glint in his eyes softening into something steadier.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You could have, you know. Without asking.&lt;&lt;/speech&gt;&gt;

He says it gently—not dismissively, but as if to say *you don&#39;t need permission to be kind.*

&lt;&lt;speech &quot;darian&quot;&gt;&gt;But I&#39;m glad you did.&lt;&lt;/speech&gt;&gt;

He leans forward—not fast, not hesitant—and meets you halfway.

The kiss is quiet. Warm. Intentional. The kind that doesn&#39;t ask for anything back.

His hand brushes your cheek like he&#39;s trying to memorize its shape. When the kiss breaks, he doesn&#39;t move far—just far enough to breathe.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Well... that ruined me a little.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could we take it further?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You don&#39;t need to as—&lt;&lt;/speech&gt;&gt;

You kiss him again. More passionately.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;darian&quot; &quot;affection&quot; 2&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;StartSexScene &quot;darian&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Darian_PostSexPhase1&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="55" name="Darian_MusicRequest" tags="widget" position="600,725" size="100,100">&lt;&lt;widget &quot;Darian_MusicRequest&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;p&gt;You glance around the room, then back at Darian. The question escapes you before you can second-guess it.&lt;/p&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Would it be too much trouble... to pass the time with some music?&lt;&lt;/speech&gt;&gt;

For a moment, Darian doesn&#39;t speak. He just watches you. Not guarded—but still. Like you&#39;ve opened a door he hasn&#39;t walked through in years.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You&#39;re the first person who&#39;s asked that in a long time.&lt;&lt;/speech&gt;&gt;

[[He gives you a warm, welcoming smile.|Darian_MusicMontage]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="56" name="Dummy_Placeholder_Locked" tags="widget" position="725,725" size="100,100">&lt;&lt;widget &quot;Dummy_Placeholder_Locked&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
    &lt;em&gt;This option is currently locked.&lt;/em&gt;
  &lt;&lt;/append&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="57" name="Harroc_OrderDrink" tags="widget" position="850,725" size="100,100">&lt;&lt;widget &quot;Harroc_OrderDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could I get a drink, please?&lt;&lt;/speech&gt;&gt;

  Harroc pauses mid-wipe on a tankard, eyes sliding to meet yours without turning his head. His voice is steady, low.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;You could. But that didn&#39;t sound like someone who *wants* a drink. Try again.&lt;&lt;/speech&gt;&gt;

  You blink. He doesn&#39;t look angry—just expectant. Testing.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;...Alright. I want a drink. Something strong. Something that proves I&#39;m not just a girl in a dress, out past her bedtime.&lt;&lt;/speech&gt;&gt;

  That gets the faintest grunt of approval. He sets the mug down and turns away to pour.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Better.&lt;&lt;/speech&gt;&gt;

  He slides a dark, frothy brew toward you. The mug is heavy, the liquid inside smelling faintly of burnt caramel and black pepper.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Locals call it Emberjaw. Kicks harder than it starts. Like most things worth finishing.&lt;&lt;/speech&gt;&gt;

  You take a sip—it hits your tongue smooth, then sears your throat with a trailing warmth. You try not to cough.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s... intense.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;That&#39;s the idea.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="58" name="Harroc_RecentEvents" tags="widget" position="975,725" size="100,100">&lt;&lt;widget &quot;Harroc_RecentEvents&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Has it always been this quiet in here?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;No.&lt;&lt;/speech&gt;&gt;

  He doesn&#39;t elaborate. Just goes back to wiping the rim of a thick mug, gaze drifting over the room without much interest.

  You wait a beat. Then try again.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Is it just... one of those nights, or is something going on?&lt;&lt;/speech&gt;&gt;

  Harroc finally shrugs. Not dismissive—just honest.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Fair starts tomorrow. Most folk are home, saving coin or nursing livers. Fewer fights that way. Easier cleanup.&lt;&lt;/speech&gt;&gt;

  He sets the mug down and grabs another without looking at you.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Two nights from now, this place&#39;ll smell like sweat, cheap wine, and regret. Tonight&#39;s just the pause.&lt;&lt;/speech&gt;&gt;

  A log pops loudly in the hearth behind you. He doesn&#39;t react.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="59" name="Harroc_OpenShop" tags="widget" position="1100,725" size="100,100">&lt;&lt;widget &quot;Harroc_OpenShop&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you have a food menu, or is it just drinks?&lt;&lt;/speech&gt;&gt;

  Harroc doesn&#39;t stop what he&#39;s doing—just gestures with a thick thumb toward a chalkboard hung crooked on the wall behind him.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Menu&#39;s there. Three kinds of stew. Bread if it&#39;s not gone. Couple of pickled things in jars. Mostly drinks though.&lt;&lt;/speech&gt;&gt;

  He grabs a bottle, uncorks it, sniffs it, and nods to himself.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;People don&#39;t come here for variety. They come because it stays open, and I don&#39;t water anything down.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.openShop(&quot;harroc&quot;)&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="60" name="Harroc_Rumors" tags="widget" position="1225,725" size="100,100">&lt;&lt;widget &quot;Harroc_Rumors&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Aside from the fair, you heard about anything interesting lately?&lt;&lt;/speech&gt;&gt;

  Harroc doesn&#39;t look up, just sets a clean mug down on the bar with a dull *clunk*.  

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Aside from the usual bounty-hunter and underworld nonsense, the city&#39;s been quiet. Think either everything&#39;s going fine, which it&#39;s usual not, or the city is just holding its breath waiting for something to happen.&lt;&lt;/speech&gt;&gt;

  You give him an eyebrow.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What do you mean about the underworld nonsense.&lt;&lt;/speech&gt;&gt;

  Harroc finally looks up at you, as serious as you have seen him tonight.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Don&#39;t you go worrying about that, not something you should muddy yer&#39; boots with.&lt;&lt;/speech&gt;&gt;  

  His tone seems final, and you decide not to press the issue. The criminal element in Bastion is something you always knew existed, but no matter who you ask, you never manage to learn much about it.

  He picks up another mug. Starts wiping again.  

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What about the bounty hunter stuff?&lt;&lt;/speech&gt;&gt;

  He doesn&#39;t quite sigh so much as deflate a little.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Want to know about that? Talk to the fella in the corner over there. Think he&#39;s with the guild.&lt;&lt;/speech&gt;&gt;

  He moves onto the next mug with his rag.

  &lt;&lt;speech &quot;harroc&quot;&gt;&gt;Somethin&#39; else, girl?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;harroc&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.harroc_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="61" name="Harroc_Phase0_Goodbye" tags="widget" position="100,850" size="100,100">&lt;&lt;widget &quot;Harroc_Phase0_Goodbye&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You offer Harroc a small nod.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I&#39;ll let you get back to it.&lt;&lt;/speech&gt;&gt;

He grunts in acknowledgment, still polishing the same mug with practiced, absent motions. The clink of glass and quiet murmur of voices fills the space as you turn away.

&lt;&lt;if not $TalkedTo_Harroc&gt;&gt;
  &lt;&lt;set $TalkedTo_Harroc = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You walk back toward the main area of the tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="62" name="Marie_Howareyoudoing" tags="widget" position="225,850" size="100,100">&lt;&lt;widget &quot;Marie_Howareyoudoing&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I&#39;m Jaylie, by the way.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;know &quot;marie&quot;&gt;&gt;&lt;&lt;speech &quot;marie&quot;&gt;&gt; Marie.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; How are you doing?&lt;&lt;/speech&gt;&gt;
    
    Her face twists in annoyance. Likely more than she even intended.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt; Oh just wonderful. This night is going so well. Can&#39;t you tell?&lt;&lt;/speech&gt;&gt;
    You frown at her sarcasm. She isn&#39;t looking at you, but you felt her eyes roll.
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;set $marieCanApologize = true&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="63" name="Marie_ToughNight" tags="widget" position="350,850" size="100,100">&lt;&lt;widget &quot;Marie_ToughNight&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    You try softening your tone, hoping to break through whatever storm is brewing behind her eyes.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Looks like you&#39;ve had a rough night.&lt;&lt;/speech&gt;&gt;
    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Is it the scowl, the clenched jaw, or the ‘go away&#39; energy that gave it away?&lt;&lt;/speech&gt;&gt;

    She exhales through her nose. Not quite a laugh, not quite a sigh.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Either way, ten points to you for perception.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;set $marieCanApologize = true&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="64" name="Marie_SilentTreatment" tags="widget" position="475,850" size="100,100">&lt;&lt;widget &quot;Marie_SilentTreatment&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    You glance at her, then at the space between you both. It stretches like a wall you can&#39;t climb.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You know, if it helps, you can talk to me about what happened. I&#39;ve been told I can be a good listener.&lt;&lt;/speech&gt;&gt;

    Marie doesn&#39;t answer at first. Just blinks slowly, then tilts her head ever so slightly in your direction.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t need to talk about it. Especially to strangers who sit next to me like I&#39;m a stray cat that needs saving.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;set $marieCanApologize = true&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="65" name="Marie_ImSorryIllGo" tags="widget" position="600,850" size="100,100">&lt;&lt;widget &quot;Marie_ImSorryIllGo&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    Obviously not getting anywhere, with her you get up to leave.

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I&#39;m gonna go. I hope your night gets a little better.&lt;&lt;/speech&gt;&gt;
    
    You turn to leave and make it only a step before you feel a hand on your hand, soft and warm. You turn and look back at the girl. Her eyes meet yours for the first time.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;I&#39;m sorry, Jaylie. That&#39;s not who I am. That man just really brought the worst out of me. Think we can start again?&lt;&lt;/speech&gt;&gt;

    You hesitate for a brief moment, then smile and nod at her. She gently pulls your hand, guiding you back to the couch.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you for trying to check on me.&lt;&lt;/speech&gt;&gt;

    She smiles. It looks a little forced, but you can tell she is genuinely trying.

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;I&#39;m sorry. This isn&#39;t how I normally am. It&#39;s just been... a night. But I&#39;d like to start over, if you don&#39;t mind.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; Don&#39;t worry about it at all. I definitely have my bad days too, but nothing like what you have to deal with.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 2&gt;&gt;
  &lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase1&quot;&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Marie Phase 1 Dialogue Options */</tw-passagedata><tw-passagedata pid="66" name="Marie_WhyThisWork" tags="widget" position="725,850" size="100,100">&lt;&lt;widget &quot;Marie_WhyThisWork&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Why did you choose this kind of work?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Chose? That&#39;s generous. I chose not to starve. Turns out I&#39;m good at more than surviving, though. I learned how to turn the game in my favor.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;bg &quot;Scene02_LessAngryHost&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="67" name="Marie_HostsOrFriends" tags="widget" position="850,850" size="100,100">&lt;&lt;widget &quot;Marie_HostsOrFriends&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Are the other hosts your friends... or just coworkers?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Depends on who you ask, probably. Generally though, these are really good people. Some better than others. We definitely fight, step on each other&#39;s toes sometimes maybe. These people are the one&#39;s who pull you out after a long night though. It helps that Mistress Adda is a very good boss.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I can imagine how that would make a big difference. I can&#39;t imagine doing this job surrounded by people you don&#39;t trust or like.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="68" name="Marie_DoYouLikeItHere" tags="widget" position="975,850" size="100,100">&lt;&lt;widget &quot;DoYouLikeItHere&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you like it here? The Nuzzling Noctail, I mean.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Days like today I don&#39;t, but I have to remember that there are far worse establishments in the city. Worse jobs altogether, really. 
  
  Honestly though the good people do outnumber the bad. The bad just tend to make sure they are more memorable.
  
  I go to bed at night with a full belly, and coin in my purse though. I also can&#39;t think of anywhere else I would rather be working.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="69" name="Marie_LivedAnywhereElse" tags="widget" position="1100,850" size="100,100">&lt;&lt;widget &quot;Marie_LivedAnywhereElse&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Have you ever lived or traveled outside the city?&lt;&lt;/speech&gt;&gt;

  Marie&#39;s expression lights up and she genuinely smiles for a moment. 

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I was born in Albcorr, actually. I don&#39;t remember it very well. My family moved here when I was very little. Sometimes I have dreams though... I think they are memories. The tall trees. The green fields. The open sky, not choked with chimney smoke.&lt;&lt;/speech&gt;&gt;

  Her smile fades a little, but you can still tell she is thinking about it fondly.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I&#39;ve saved my coin for years. I want to go back one day. I want to see the trees. I want to &lt;strong&gt;CLIMB&lt;/strong&gt; one. I want to sleep out in the fields covered only by a blanket of stars. Go so far away from the city that the only voice I would ever have to hear is my own... or maybe a friend&#39;s&lt;&lt;/speech&gt;&gt;

  She glances at you, and smiles warmly.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Well, all you had to do was ask. Let&#39;s go now!&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh, sure let&#39;s go, my bags are packed!&lt;&lt;/speech&gt;&gt;

  As if waiting for this, lightning strikes somewhere in the distance, thunder lightly rumbles the building. Crystal and glass chime and tink for a moment.

  You and marie look at each other with straight faces, the burst into simultaneous laughter.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Okay maybe not tonight. But I could be the friend one day.&lt;&lt;/speech&gt;&gt;

  Marie scrunches her shoulder to her chin and gives you a playful look.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt; You promise, friend?&lt;&lt;/speech&gt;&gt;

  You both laugh again.
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="70" name="Marie_TheFairTomorrow" tags="widget" position="1225,850" size="100,100">&lt;&lt;widget &quot;Marie_TheFairTomorrow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Are you looking forward to the fair tomorrow?&lt;&lt;/speech&gt;&gt;
 
  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh definitely! I love the fair. I don&#39;t have to work the mornings, so I will spend most of my time looking at all the foreign jewellry and animals most likely. Then if I am lucky, maybe I&#39;ll meet some hunky foreigner for the evening.&lt;&lt;/speech&gt;&gt;

  You both laugh at the thought.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I hope they treat you like a queen for the day.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;How about you? Will you be in attendence tomorrow?&lt;&lt;/speech&gt;&gt;

  Your face falls a bit. The question was fair play, and still somehow catches you off guard. Summoning thoughts of your mom.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;The fair is always a little hard for me. Reminds me a lot of my mom. She died right around this time of year... When I was born actually.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh I am sorry to hear that. So you never got to know her?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Well not for a long time. But around the time I was about eight my dad started telling me more stories about her. She was the best type of person to exist. She was a healer. Dedicated her life to helping others.&lt;&lt;/speech&gt;&gt;

  You frown a little. A tear wells in the corner of your eye. Marie notices and reaches out, wiping it away with her thumb. She cups your cheek and just smiles. You reach up and grab her hand, wrapping her fingers in yours and pulling it down to your lap. 

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It was nice being able to learn about who she was, but sometimes it was still hard, because then I always felt like I had to live up to her standards. I&#39;m afraid I could live a hundred lifetimes though and never be half the woman she was.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Well if it&#39;s any consolation, you are making my night better. You couldn&#39;t be all bad.&lt;&lt;/speech&gt;&gt;

  You laugh a little, a short hearty chuckle. You trace her knuckle with your thumb.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re not so bad yourself.&lt;&lt;/speech&gt;&gt;

  She lets out a sharp chuckle and slaps your hand lightly.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh I know I&#39;m a right bitch sometimes. But I do try to be a good person.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 8&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="71" name="Marie_StartMinigameOne" tags="widget" position="100,975" size="100,100">&lt;&lt;widget &quot;Marie_StartMinigameOne&quot;&gt;&gt;

  &lt;&lt;append #convoBox&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If you don&#39;t mind, I would really like to get to know you better.&lt;&lt;/speech&gt;&gt;
    
    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh Gods. I am sure that you&#39;d be happier talking to someone else around here.&lt;&lt;/speech&gt;&gt;

    You grin at her. She looks back at you and her lips crack into a sly smile.
    
    &lt;&lt;speech &quot;marie&quot;&gt;&gt;...but if you *really* want to know me, don&#39;t say I didn&#39;t warn you.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;OpenConvoGame &quot;marie&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase1()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="72" name="Marie_GoUpstairs" tags="widget" position="225,975" size="100,100">&lt;&lt;widget &quot;Marie_GoUpstairs&quot;&gt;&gt;
  &lt;&lt;append #convoBox&gt;&gt;
    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Hey do you by chance—&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;marie&quot;&gt;&gt;Want to go somewhere more private? I have just the place upstairs.&lt;&lt;/speech&gt;&gt;

    &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You read my mind. Lead the way.&lt;&lt;/speech&gt;&gt;

    You and Marie stand from your velvet couch and she takes you by the hand, leading you through the parlor, back towards the entrance. You pass through the heavy velvet curtain and make your way up the stairs. The air thickens even more with the smell of incense and perfume as you ascend.

    At the top of the stairs, Marie leads you down a long, narrow hallway before stopping at a non-descript door. She opens it and gestures for you to enter first.

    [[You enter Marie&#39;s room.|Marie_UpstairsPhase1]]
    &lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="73" name="Marie_Phase1Goodbye" tags="widget" position="350,975" size="100,100">&lt;&lt;widget &quot;Marie_Phase1Goodbye&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk more later.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Sure. I&#39;ll be here. Try not to get swallowed by the velvet in the meantime.&lt;&lt;/speech&gt;&gt;

[[Leave Marie and Return to the Parlor.|Scene02_ReturnToParlor]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Marie Phase 2 Start */</tw-passagedata><tw-passagedata pid="74" name="Marie_RoomComment" tags="widget" position="475,975" size="100,100">&lt;&lt;widget &quot;Marie_RoomComment&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I really like your room. Do they all look like this?&lt;&lt;/speech&gt;&gt;

Marie looks at you like you&#39;ve just said something suspicious. She glances around her own space, then back at you with a raised brow.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;You like *this* room? With the busted light sconce and the “aesthetic” wall stain I&#39;ve covered with a bookshelf?&lt;&lt;/speech&gt;&gt;

You laugh softly.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Yeah. There&#39;s not a lot here—but what is here says a lot about you. Most people in your position wouldn&#39;t be able to read let alone fill their time with philosophy, art, and history. Also your bookshelf did its job. I had no clue about the stain.&lt;&lt;/speech&gt;&gt;

Marie lets out a small chuckle– a short, quick huff of air through her nose– and stares at you for a beat longer than necessary. You realize that you possibly just betrayed a piece of your &#39;cover&#39; which had not been exposed before. You feel Marie&#39;s eyes look you up and down. They are not cold, just... uncertain. Then she leans back a little against the wall, her voice softening.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Well. That&#39;s either the smoothest deflection I&#39;ve heard tonight... or the first honest thing.&lt;&lt;/speech&gt;&gt;

She doesn&#39;t press it. But she doesn&#39;t look away either.

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase2()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="75" name="Marie_WhatNow" tags="widget" position="600,975" size="100,100">&lt;&lt;widget &quot;Marie_WhatNow&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What do you want to do now?&lt;&lt;/speech&gt;&gt;

Marie turns her head slightly, eyes narrowing in mild amusement. Not mocking—just thoughtful.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t mean to sound indifferent, but you are the own who pays to be here.&lt;&lt;/speech&gt;&gt;

She stretches her legs out a bit, brushing her fingers along the edge of the quilt like she&#39;s grounding herself in the fabric.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;That usually makes you the one who gets to decide.&lt;&lt;/speech&gt;&gt;

There&#39;s a pause. Just long enough to let the implication settle.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;But if you&#39;re asking because you *actually* care what I want...&lt;&lt;/speech&gt;&gt;

She glances at you, eyes sharp but not unkind.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;...then I&#39;d say: talk a little, sit a little, maybe let the night happen slowly for once.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase2()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="76" name="Marie_TalkAboutIt_Success" tags="widget" position="725,975" size="100,100">&lt;&lt;widget &quot;Marie_TalkAboutIt_Success&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you want to talk about what happened outside?&lt;&lt;/speech&gt;&gt;

Marie exhales slowly through her nose and tilts her head back against the wall. Her eyes drift toward the ceiling like she&#39;s counting breaths—or deciding if she wants to let them out.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Kallot and I… it&#39;s complicated.&lt;&lt;/speech&gt;&gt;

She lets that hang for a moment before continuing, voice quiet but clear.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;He&#39;s not usually like that. He&#39;s kind. Gentle. The kind of drunk who rambles about stars and apologizes for existing too much. But tonight he was…&lt;&lt;/speech&gt;&gt;

She trails off, shakes her head once.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;He was angry. Dismissive. I&#39;ve never seen him like that. I thought maybe he came to see me—but it was like I wasn&#39;t even there.&lt;&lt;/speech&gt;&gt;

Her fingers curl into the edge of the quilt again.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I want to forgive him. I do. But I don&#39;t understand why he was like that. Why he *chose* to be like that.&lt;&lt;/speech&gt;&gt;

She finally looks at you. Really looks at you.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;You ever see someone you care about... shift into someone you don&#39;t recognize? Just long enough to scare you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;marie&quot; &quot;TheFight&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;
  /* Marie Talk about TheFight Branch - Start */
  :: Marie_Fight_HowLong [widget]
  &lt;&lt;widget &quot;Marie_Fight_HowLong&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;How long have you and Kallot been... whatever you are?&lt;&lt;/speech&gt;&gt;

  Marie lifts one eyebrow at the phrasing, but there&#39;s no venom in it. Just tired humor.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;That&#39;s one way to put it.&lt;&lt;/speech&gt;&gt;

  She draws her legs up slightly and rests her chin on her knees, eyes fixed on the opposite wall as she answers.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;We met about a year ago. He came to the brothel drunk one night, but not... messy. Just lonely. Sad in this quiet, polite kind of way that made me feel like I couldn&#39;t be mean to him, even if I wanted to.&lt;&lt;/speech&gt;&gt;

  She gives a faint, private smile.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;He didn&#39;t even ask for anything. Just talked to me. Listened too. Came back the next week with a book he thought I&#39;d like. Some old thing about myths from the Inner Isles. It had footnotes. He highlighted the wrong parts, but still—&lt;&lt;/speech&gt;&gt;

  She stops herself, looking back to you.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Anyway. It just kind of happened. We&#39;d talk. Sometimes he&#39;d hold my hand. Sometimes I&#39;d let him fall asleep on my shoulder. I don&#39;t know what to call that, but… it was something.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Marie_Fight_Intent [widget]
  &lt;&lt;widget &quot;Marie_Fight_Intent&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think he meant to hurt you?&lt;&lt;/speech&gt;&gt;

  Marie&#39;s jaw tightens slightly. She doesn&#39;t answer right away. When she finally does, it&#39;s with a kind of careful quiet, like she&#39;s placing each word on a scale.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;No.&lt;&lt;/speech&gt;&gt;

  A beat.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t think so. Not *like that.*&lt;&lt;/speech&gt;&gt;

  She folds her arms across her chest, not defensive—more like she&#39;s holding herself in place.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;He&#39;s never laid a hand on me. Not when I didn&#39;t want him to. He&#39;s the type to apologize if his elbow brushed me by mistake. That&#39;s... who I thought he was.&lt;&lt;/speech&gt;&gt;

  She exhales slowly, the breath catching on something unsaid.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;But words? Being cold? Acting like I was a stranger? I think maybe part of him *did* want to push me away. And maybe that part didn&#39;t care how much it would sting.&lt;&lt;/speech&gt;&gt;

  She doesn&#39;t cry. She doesn&#39;t need to.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Sometimes people hurt you just enough that you&#39;ll walk away... so they won&#39;t have to.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I hope this doesn&#39;t come across like I am trying to defend his actions. He hurt you and it&#39;s okay for you to feel like that, but maybe he did have something extra going on. Something that made him act out like that. I don&#39;t know him, obviously, but maybe there is more to the story that only Kallot knows.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 2&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;


  :: Marie_Fight_Pattern [widget]
  &lt;&lt;widget &quot;Marie_Fight_Pattern&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Has he ever scared you before tonight?&lt;&lt;/speech&gt;&gt;

  Marie&#39;s mouth pulls into a line—not frowning, just thoughtful. She glances toward the door, then back at you.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;No. Not once.&lt;&lt;/speech&gt;&gt;

  She shifts slightly on the bed, fingers fidgeting with the corner of the quilt.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Even when he drinks, he&#39;s... careful. Polite, even. If anything, he&#39;s usually the one looking scared—like he&#39;s afraid of taking up too much space.&lt;&lt;/speech&gt;&gt;

  She pauses, then adds with a lowered voice:

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I know he&#39;s tied up in something. Work, maybe. Maybe worse. He&#39;s never said it outright, but I&#39;ve heard names. Watched the way he changes when certain people come around.&lt;&lt;/speech&gt;&gt;

  She meets your eyes now, steady and certain.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;But even then, he never raised his voice. Never made me flinch. That&#39;s why tonight was...&lt;&lt;/speech&gt;&gt;

  She exhales through her nose.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;It felt like looking at a stranger wearing someone I cared about.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;/append&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;
  
  :: Marie_Fight_Forgiveness [widget]
  &lt;&lt;widget &quot;Marie_Fight_Forgiveness&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you think you&#39;ll talk to him again after this?&lt;&lt;/speech&gt;&gt;

  Marie doesn&#39;t answer right away. She draws one leg beneath her, adjusting her posture like the question physically shifted her balance.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I don&#39;t know.&lt;&lt;/speech&gt;&gt;

  Her voice isn&#39;t cold—it&#39;s honest. Worn a little thin at the edges.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I want to. Part of me does, anyway. The part that still believes this was... an outlier. A bad night. Something explainable.&lt;&lt;/speech&gt;&gt;

  She looks down at her hands, thumbs idly tracing one another.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;But if I open that door and he&#39;s still wearing that same face—the one from tonight—I don&#39;t think I could pretend it didn&#39;t scare me.&lt;&lt;/speech&gt;&gt;

  She swallows. Not hard. Not dramatic. Just a quiet moment of choosing her next words carefully.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I think forgiveness is easier when you understand *why* someone hurt you. When you can file it under something that makes sense. But right now... I&#39;ve got nothing to file it under.&lt;&lt;/speech&gt;&gt;

  She glances back at you with a faint, almost bitter smile.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Maybe that&#39;s the hardest part. Not the pain. The silence that follows it.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Jaylie_Helped_Kallot [widget]
  &lt;&lt;widget &quot;Jaylie_Helped_Kallot&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I helped him, you know...&lt;&lt;/speech&gt;&gt;

  Marie tilts her head slightly, curious but guarded.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;You what?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Out on the pavement I mean. You hit him really good and he was bleeding so I pulled him to the alley, out of the rain and put a bandage on his head. When I did he woke up for a second and smiled at me long enough to tell me my hair was pretty.&lt;&lt;/speech&gt;&gt;

  You nod slowly, thinking back to that rain-drenched street. The weight of his body. The blood. The way he smiled, even half-conscious.

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I didn&#39;t know him. I didn&#39;t know you. He just looked like he wouldn&#39;t do so well if he was left out there.&lt;&lt;/speech&gt;&gt;

  Marie doesn&#39;t speak for a few seconds. Her gaze drifts—not away from you, but somewhere distant. Somewhere inside.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;That sounds like him. I nearly killed him, and there he was smiling about it like an idiot.&lt;&lt;/speech&gt;&gt;

  She gives a quiet laugh. It&#39;s not bitter.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you... For not leaving him, not walking past.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 4&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 4&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Marie_Fight_Backstory [widget]
  &lt;&lt;widget &quot;Marie_Fight_Backstory&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What were you like before all this? Before the Noctail?&lt;&lt;/speech&gt;&gt;

  Marie blinks, clearly caught off guard—not upset, just surprised by the question.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;That&#39;s... not something people usually ask.&lt;&lt;/speech&gt;&gt;

  She looks down for a moment, pulling her knees in closer to her chest as if the question peeled away some layer of armor.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I was quieter, believe it or not. Not in the sulking-in-a-corner way, just... always in my head. I used to read in stairwells, write notes in margins. I wanted to be a scribe, maybe. Work in a library. Somewhere with ink stains and silence and no customers to please.&lt;&lt;/speech&gt;&gt;

  A small smile tugs at her mouth—genuine, if faint.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;I was also naïve. Thought I could change the world with enough wit and well-placed sarcasm. Thought people would see value in me just because I was smart and sharp and didn&#39;t take shit from anyone.&lt;&lt;/speech&gt;&gt;

  She looks at you then, more open than before. Not vulnerable—just honest.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Turns out, none of that pays rent. But it still lives in here.&lt;&lt;/speech&gt;&gt;

  She taps two fingers gently against her temple.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;And some nights, like this one... I let her back out, just for a little while.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 2&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;run setup.marie_Conversation_Options_TheFight()&gt;&gt;
  &lt;&lt;/widget&gt;&gt;

  :: Marie_Fight_Exit [widget]
  &lt;&lt;widget &quot;Marie_Fight_Exit&quot;&gt;&gt;
  &lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;We can talk about something else, if you&#39;d like.&lt;&lt;/speech&gt;&gt;

  Marie exhales through her nose—not in annoyance, but relief. Not because the conversation was too much, but because you knew when to let go.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Thanks. It&#39;s not that I mind talking about it... just sometimes you don&#39;t realize how heavy something is until you say it out loud.&lt;&lt;/speech&gt;&gt;

  She adjusts her posture slightly, her tone lighter now—like she&#39;s shaking off a weight but not ignoring it.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;Besides, this was supposed to be your night, wasn&#39;t it?&lt;&lt;/speech&gt;&gt;

  There&#39;s a faint smile. Not a performance. Just a moment of softness.

  &lt;&lt;speech &quot;marie&quot;&gt;&gt;So... what do you want to talk about instead?&lt;&lt;/speech&gt;&gt;
  &lt;&lt;/append&gt;&gt;
  &lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
  &lt;&lt;run setup.clearConvoChoices()&gt;&gt;
  &lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase2&quot;&gt;&gt;
  &lt;&lt;/widget&gt;&gt;
/* End of TheFight Branch */</tw-passagedata><tw-passagedata pid="77" name="Marie_TalkAboutIt_Fail" tags="widget" position="850,975" size="100,100">&lt;&lt;widget &quot;Marie_TalkAboutIt_Fail&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you want to talk about what happened outside?&lt;&lt;/speech&gt;&gt;

Marie&#39;s expression hardens immediately—not dramatically, but enough to feel the shift. Her jaw tightens. Her eyes narrow just slightly.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you for offering, but I think that I am just going to let it simmer a little longer. I don&#39;t mean any offense, but I hope you understand.&lt;&lt;/speech&gt;&gt;

She seems sincere, and you aren&#39;t about to push it any further.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;No problem. If you change your mind let me know. Otherwise let&#39;s just try to enjoy the rest of the night.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you, Jaylie.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 1&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.marie_Conversation_Options_Phase2()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="78" name="Marie_AskToTouch" tags="widget" position="975,975" size="100,100">&lt;&lt;widget &quot;Marie_AskToTouch&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can I touch you?&lt;&lt;/speech&gt;&gt;

Marie blinks, her breath catching just slightly. Not from fear—but from the weight of the question. You can see it in the way she looks at you now. Like she&#39;s measuring something. Like no one&#39;s asked her *that* before—not like this.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;You&#39;re... asking?&lt;&lt;/speech&gt;&gt;

She says it softly, more observation than surprise. Her voice drops to a hush, and she leans in—just enough that you feel the warmth between you shift.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Of course. I don&#39;t really know another way.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thats the most innocent thing I think I have ever heard in this room.&lt;&lt;/speech&gt;&gt;

She extends one hand toward you, palm open, fingers still. Waiting.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Go on, then. Just... be gentle.&lt;&lt;/speech&gt;&gt;

You take her hand. She doesn&#39;t pull away.

She just holds it there, eyes never leaving yours, her thumb brushing once—light as breath—against your skin.

With your other hand you reach up to her cheek and gently caress the softness of her face. As you do she leans into your hand slightly, like a cat excited to be touched. You lean towards her. She follows your lead.

When your lips melt you have a hard time thinking the best way to describe the sensation. Not explosions, not passion. The closest thing that comes to mind is contentment. You hold the position for a moment that feels much longer than it likely was, your lips locked together.

When you pull apart Marie does not look directly at you, but speaks downward, her breath shorter than you&#39;d expect it to be.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Lay down on your back.&lt;&lt;/speech&gt;&gt;

You don&#39;t hesitate to comply.



&lt;&lt;/append&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;trust&quot; 2&gt;&gt;
&lt;&lt;relation &quot;marie&quot; &quot;affection&quot; 1&gt;&gt;
&lt;&lt;StartSexScene &quot;marie&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Marie_PostSexPhase1&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="79" name="Marie_LayAndTalk" tags="widget" position="1100,975" size="100,100">&lt;&lt;widget &quot;Marie_LayAndTalk&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If it&#39;s alright... I think I&#39;d just like to lay here with you.&lt;&lt;/speech&gt;&gt;

Marie doesn&#39;t answer right away. She shifts slightly, thoughtful, and then—surprisingly—smiles.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Yeah. That actually sounds... really nice.&lt;&lt;/speech&gt;&gt;

She scoots back and folds the blanket down beside her. The gesture is plain, but there&#39;s something careful in it. She&#39;s not offering a show. She&#39;s offering *space*.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Just don&#39;t snore. I&#39;ve already had enough surprises for one night.&lt;&lt;/speech&gt;&gt;

You both laugh, quiet and close.

[[You settle in beside her and let the quiet take over.|Marie_JustLay_Route]]

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="80" name="Redmarrow_ArmorFlattery" tags="widget" position="1225,975" size="100,100">&lt;&lt;widget &quot;Redmarrow_ArmorFlattery&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You nod toward his outfit, eyebrows raised.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You always dress this sharp, or is tonight special?&lt;&lt;/speech&gt;&gt;

He doesn&#39;t look up right away—just finishes a long, deliberate stroke of his whetstone before setting the blade aside.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;A professional must cultivate presence. Fear is a language, girl—and sometimes the only way to speak it is with polish and posture.&lt;&lt;/speech&gt;&gt;

His voice is smooth, deliberate—like every word was chosen for maximum effect. There&#39;s a hint of a foreign accent, just enough to sound exotic without quite placing it. Every syllable lands with the flair of a man who enjoys being listened to.

He lifts his glass, swirling the inky red liquid like it&#39;s blood.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Besides, if you knew how many lives this armor&#39;s saved, you&#39;d understand why I keep it looking just the right kind of worn.&lt;&lt;/speech&gt;&gt;

You can&#39;t help a soft laugh. You question for a moment if armor is meant to save any lives other than the wearer&#39;s but decide against questioning this out loud.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You kinda look like you stepped out of a painting.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Good. I intend to be remembered like one.&lt;&lt;/speech&gt;&gt;

Your comment was less a compliment and more an observation, but he obviously took it to his ego anyhow.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="81" name="Redmarrow_JobPrompt" tags="widget" position="100,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_JobPrompt&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You tilt your head slightly, taking in the armor, the dagger, the air of self-importance.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So… what do you do, exactly? You look like you&#39;re either waiting for a duel or a portrait session.&lt;&lt;/speech&gt;&gt;

He chuckles softly, finally setting down his glass.
&lt;&lt;know &quot;redmarrow&quot;&gt;&gt;
&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Both, if I&#39;m lucky. But officially? I&#39;m a licensed bounty contractor—charter-recognized and Guild-backed. Dangerous work, of course, but Leopold Redmarrow does not shy from danger.&lt;&lt;/speech&gt;&gt;

He leans forward, resting one elbow on the table with the confidence of a man who knows how to fill space.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Most days, it&#39;s chasing coin. Some days, justice. And every so often, something a bit more... poetic.&lt;&lt;/speech&gt;&gt;

You&#39;re not sure what “poetic” bounty work looks like, but he clearly thinks it sounds impressive.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So you catch criminals for money.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;That&#39;s the skeleton of it, sure. But when you dress the bones in legend and legacy, it walks a bit taller.&lt;&lt;/speech&gt;&gt;

He flashes a smile so polished it might as well be part of his armor.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="82" name="Redmarrow_NameOrigin" tags="widget" position="225,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_NameOrigin&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

You squint slightly, letting your tone ride the edge of teasing.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Redmarrow? That your real name?&lt;&lt;/speech&gt;&gt;

He smirks before you even finish the question, like he&#39;s been waiting for this exact moment.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Ah. The question behind all great men.&lt;&lt;/speech&gt;&gt;

He picks up his glass again, but doesn&#39;t drink—just holds it aloft like a toast to himself.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Some are born into names. Others earn them. And a rare few... are wise enough to choose their own before fate does it for them.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That&#39;s not really an answer. Which are you?&lt;&lt;/speech&gt;&gt;

He winks, finally sipping the wine.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;If the name fits, wears well, and inspires fear in your enemies—what more proof of its truth do you need?&lt;&lt;/speech&gt;&gt;

You get the sense that “truth” is a negotiable concept for Leopold Redmarrow.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="83" name="Redmarrow_BountyQuest" tags="widget" position="350,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_BountyQuest&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can anyone take work from the Guild? Or do you have to be invited or something?&lt;&lt;/speech&gt;&gt;

Redmarrow leans back slightly, resting one boot on the leg of the table like he&#39;s posing for a statue.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Not normally, no. To be properly registered, you need to be recruited by an active member, sign the charter, and—of course—pay the initiation fees.&lt;&lt;/speech&gt;&gt;

He swirls his wine and grins.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;You know how it is. Spend money to make money.&lt;&lt;/speech&gt;&gt;

You raise an eyebrow.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So it&#39;s expensive?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Costly? No, no. *Efficient.* Twenty gold covers all the paperwork. And, coincidentally, I happen to have a contract I could share that would more than offset that upfront cost.&lt;&lt;/speech&gt;&gt;

He taps his dagger lightly against the table. Not threatening—just a gesture, a rhythm.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Opportunity knocks quietly, girl. Better you answer now than regret it later.&lt;&lt;/speech&gt;&gt;

He gestures vaguely, as if the very concept of time is slipping through your fingers.

&lt;&lt;/append&gt;&gt;
&lt;&lt;set $readyForBoutyQuestion = true&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="84" name="Redmarrow_TheJob" tags="widget" position="475,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_TheJob&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;About that job you mentioned...&lt;&lt;/speech&gt;&gt;

He doesn&#39;t answer right away—just gives you a slow smile, like you passed some invisible test.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;I&#39;m glad to see you&#39;re thinking about it. Before we get down to brass tacks. Do you have the twenty gold?&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;redmarrow&quot; &quot;TheFirstBounty&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Redmarrow_TheFirstBounty Branch - Start */

    :: Redmarrow_BountySignUp [widget]
&lt;&lt;widget &quot;Redmarrow_BountySignUp&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I want to join the bounty hunter&#39;s guild.&lt;&lt;/speech&gt;&gt;

You place the coin down on the table.

Leopold sweeps it up with one smooth motion—almost too smooth, like he&#39;s done this *a lot*. He doesn&#39;t even check the weight.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;A wise investment, er–.&lt;&lt;/speech&gt;&gt;

You realize you haven&#39;t shared your name yet.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Jaylie.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;A wise investment, Jaylie.&lt;&lt;/speech&gt;&gt;

He pulls a folded scrap of parchment from inside his coat and slides it toward you like it&#39;s contraband.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Target&#39;s a pickpocket named Tel Varas. He&#39;s known well enough around the city, and he&#39;s slipped past the Wardens more times than they care to admit. So much so, apparently that the City passed it to the guild. He&#39;s not dangerous, just slimy.&lt;&lt;/speech&gt;&gt;

You glance down at the parchment. It&#39;s vague. A name, a rough sketch, and a few scribbled locations—none of it official.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;This looks like it was written in a tavern bathroom.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Field work is messy, girl. Welcome to the Guild.&lt;&lt;/speech&gt;&gt;

He raises his glass in your direction, utterly satisfied with himself.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do I need to sign anything else to become an official member?&lt;&lt;/speech&gt;&gt;

He chuckles at you flatly.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;I wouldn&#39;t dream of wasting your time with that nonsense until after you have your first mark on your belt.&lt;&lt;/speech&gt;&gt;

He smiles—content, apparently, that the conversation is over.

&lt;&lt;/append&gt;&gt;
&lt;&lt;bg &quot;PayingTheBountyHunter&quot;&gt;&gt;
&lt;&lt;additem &quot;player&quot; &quot;gold_coin&quot; -20&gt;&gt;
/*&lt;&lt;set $quests.bounty_cutpurse = { active: true, name: &quot;Tel Varas&quot;, paidRedmarrow: true }&gt;&gt;*/
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="85" name="Redmarrow_WhoIsItAgain" tags="widget" position="600,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_WhoIsItAgain&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can you remind me who the target is again?&lt;&lt;/speech&gt;&gt;

Redmarrow gives a slight, theatrical sigh—but it&#39;s performative, not impatient.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Tel Varas. Pickpocket. Slippery. Not dangerous, just irritating. Like a fly that knows how to open windows.&lt;&lt;/speech&gt;&gt;

He taps the parchment again with one finger.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;He&#39;s been dipping through the outer wards for weeks. The city watch is tired of chasing him in circles, so they handed it off to the Guild. Which means us.&lt;&lt;/speech&gt;&gt;

He sips from his glass like he just summarized a real war criminal.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="86" name="HowFindTelVaras" tags="widget" position="725,1100" size="100,100">&lt;&lt;widget &quot;HowFindTelVaras&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Any idea where I should start looking for him?&lt;&lt;/speech&gt;&gt;

Redmarrow waves a hand vaguely, like the question&#39;s too mundane for a man of his rank.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;If I knew *exactly* where he was, I wouldn&#39;t need to outsource the job, would I?&lt;&lt;/speech&gt;&gt;

He leans back with an easy smirk.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;But word is he&#39;s been casing the outer wards. And with the fair about to start, let&#39;s just say it&#39;s a pickpocket&#39;s wet dream.&lt;&lt;/speech&gt;&gt;

He taps his temple with one gloved finger.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Trust your instincts. Rats like him always sniff out the biggest crumbs.&lt;&lt;/speech&gt;&gt;

You imagine he might be stay close to the fairgrounds in King Market square over the next few days.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="87" name="TelVarasHowMuchPay" tags="widget" position="850,1100" size="100,100">&lt;&lt;widget &quot;TelVarasHowMuchPay&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And how much is this job paying again?&lt;&lt;/speech&gt;&gt;

Redmarrow grins like he&#39;s just been waiting for the question.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Official bounty on Tel Varas is a hundred gold.&lt;&lt;/speech&gt;&gt;

He lets the number hang in the air for a beat, watching your reaction.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Modest by Guild standards, but for a first mark? It&#39;s a fine stepping stone.&lt;&lt;/speech&gt;&gt;

He lifts his glass again, just shy of a toast.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Of course, final payout depends on paperwork, processing, deductions… you know. Standard procedure.&lt;&lt;/speech&gt;&gt;

He says it like he&#39;s quoting an invisible rulebook that only he has access to.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="88" name="TelVarasAnythingElse" tags="widget" position="975,1100" size="100,100">&lt;&lt;widget &quot;TelVarasAnythingElse&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Is there anything else I should know before I go after him?&lt;&lt;/speech&gt;&gt;

Redmarrow hesitates—just for a breath—then offers a casual shrug.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Technically… there&#39;s a standing bonus if any stolen goods are recovered intact.&lt;&lt;/speech&gt;&gt;

He says it lightly, like he&#39;s not sure why he even bothered mentioning it.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Twenty percent of their appraised value, paid out separately. But that&#39;s the kind of thing that only comes up if you&#39;re *very* lucky and *very* quick.&lt;&lt;/speech&gt;&gt;

He waves a hand as if to dismiss the thought entirely.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Just focus on the bounty. Clean job, clear proof, no complications—that&#39;s how you build a name.&lt;&lt;/speech&gt;&gt;

He smiles like he&#39;s being helpful, but you can feel the unspoken asterisk hovering behind his words.

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.redmarrow_Conversation_Options_TheFirstBounty()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="89" name="Redmarrow_ReturnBountytoPhase0" tags="widget" position="1100,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_ReturnBountytoPhase0&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Let&#39;s talk about something else.&lt;&lt;/speech&gt;&gt;

Redmarrow gives a faint nod and adjusts his posture, as if shedding the whole “professional” act without hesitation.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;As you like. I can be versatile.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;bg &quot;Scene03_ApproachBountyHunter&quot;&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;DialogueTree &quot;redmarrow&quot; &quot;Phase0&quot;&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="90" name="Redmarrow_Exit" tags="widget" position="1225,1100" size="100,100">&lt;&lt;widget &quot;Redmarrow_Exit&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Enjoy your night.&lt;&lt;/speech&gt;&gt;

Redmarrow gives a shallow nod, swirling his glass slowly before taking a measured sip.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;I intend to. Should fortune favor you, perhaps you&#39;ll earn the same.&lt;&lt;/speech&gt;&gt;

&lt;&lt;if not $TalkedTo_Redmarrow&gt;&gt;
  &lt;&lt;set $TalkedTo_Redmarrow = true&gt;&gt;
  &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
  &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
  [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
&lt;&lt;/if&gt;&gt;

[[You turn back toward the tavern&#39;s main floor.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="91" name="Tesska_GetDrink" tags="widget" position="100,1225" size="100,100">&lt;&lt;widget &quot;Tesska_GetDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
	&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Could I get a drink? Nothing fancy. Just... something real.&lt;&lt;/speech&gt;&gt;
	&lt;&lt;set $tesskaOrderedDrink = true&gt;&gt;
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Coming right up, sugar. Nothing wrong with wanting something simple that still gets the job done. You want flavor or fire? &#39;Cause I can give you both, but I won&#39;t lie—one of &#39;em&#39;s a bit harder to forget.&lt;&lt;/speech&gt;&gt;
	
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Let&#39;s start with something strong, I think. I&#39;ll work my way toward flavor.&lt;&lt;/speech&gt;&gt;
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Attagirl. One mug of Strongarm Swill, coming up. First one&#39;s free &#39;cus I like the look of ya.&lt;&lt;/speech&gt;&gt;
	
  &lt;p&gt;You watch her cross to the bar and shout something over to Harroc. He doesn&#39;t respond, but reaches for a barrel tap without looking and draws a dark amber drink into a battered tin mug. Tesska slides it in front of you a moment later, and gives the table a soft knock with her knuckle.&lt;/p&gt;
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Drink it fast if you hate yourself. Slow if you&#39;re tryin&#39; to find out whether you do.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="92" name="Tesska_QuietNight" tags="widget" position="225,1225" size="100,100">&lt;&lt;widget &quot;Tesska_QuietNight&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
	&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It&#39;s kind of quiet in here tonight.&lt;&lt;/speech&gt;&gt;
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mmhmm. If you asked Harroc, he&#39;d say folks are savin&#39; their strength for the fair. Three days of booze, music, and regrets.&lt;&lt;/speech&gt;&gt;
	
  She chuckles and wipes a bit of condensation from your table.
	
  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;But me? I think something&#39;s in the air. Knights have been too quiet. Too polite. Feels like the city&#39;s holdin&#39; its breath for something, and not the good kind.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="93" name="Tesska_DoYouWorkNights" tags="widget" position="350,1225" size="100,100">&lt;&lt;widget &quot;Tesska_WorkNights&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you always work nights?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mmh, nights, days. When you want to keep a place like this running in the city you never stop working.&lt;&lt;/speech&gt;&gt;

  Your face fills with shock for a moment, realizing your mistake. 

  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh I am sorry, it was unfair of me to assume—&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Oh hush, don&#39;t fret so much, Sweetheart. It happens more than you think. I have gotten used to it ever since the big guy came into my life. People see his big shiny dome and the wall of muscle and think he must have constructed this whole place himself with logs and stones he cut with his bare hands. Truth is, I was running this place long before Harroc ever stepped out of the ring.&lt;&lt;/speech&gt;&gt;
  &lt;&lt;set State.variables.hintedharrocfighter = true&gt;&gt;
  You take another moment to look around the room. The rafters, the center hearth, the walls, tables, benches and stools. You have to appreciate for a moment how pristine things look. Some of the furniture is a little beat up, sure, but you figure all of those are just stories.

  A distant crack of thunder shakes you from your inspection. Tesska hardly seems to notice, her eyes pointed towards the bar.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Though don&#39;t get me wrong... watching him behind that counter with his arms all flexed and grumbly? Not a bad view while I work.&lt;&lt;/speech&gt;&gt;

  You watch Tesska&#39;s face as she looks over at Harroc. It&#39;s full of a mix of desire and love. You realize only then that Harroc has hardly looked away from Tesska either. They are obviously quite taken by each other.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;But yes, sweetheart. I happily work most every night. Daytime drinkers are hardly any fun, the nights are when lips get loose and coin purses empty.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;set $tesskaTalkedAboutNights = true&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;widget &quot;Tesska_HowLongYouAndHarroc&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;So... how long have &lt;em&gt;you&lt;/em&gt; been running the place? And how long&#39;s Harroc been part of it?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mm. Careful now, sweetheart. Ask questions like that and I might just fall in love.&lt;&lt;/speech&gt;&gt;

  She leans slightly closer as she says it, her voice velvet-wrapped and playful. Then, with a shift in posture and a glimmer of pride, she eases back into her usual rhythm.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;I bought this place just short of fifteen years ago. Back when the hearth cracked worse than the mugs and the roof cried harder than the patrons.&lt;&lt;/speech&gt;&gt;

  She chuckles softly, folding her arms beneath her chest.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;I cleaned it up, ran it smart, made it safe. For a while it was just me and a handful of stubborn regulars. Then after a few years of thinking I bit off more than I could chew, Harroc started showing up. Silent, broody, respectful—every tavern has a few. But he kept showing up. And then one night I caught him tossing a rowdy drunk through the door without ever spilling a drop of his own drink and... well. The rest is sweaty, romantic history.&lt;&lt;/speech&gt;&gt;

  She glances toward the bar again where Harroc, stoic as ever, appears to be polishing the same mug as always.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;He moved in about six months after that. Been glued to the floor ever since. Calls me his boss, but we both know better. He&#39;s the spine, sure. But I&#39;m the soul.&lt;&lt;/speech&gt;&gt;

  A gust of wind blows against the front wall of the building. You hear the supports of the building crackle, but not falter. A daring whistling as the building cuts the storm like a rock in the sea.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;It may be my baby, but that man is the only thing that has kept me and this place from blowing away.&lt;&lt;/speech&gt;&gt;

&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="94" name="Tesska_UnusualCustomers" tags="widget" position="475,1225" size="100,100">&lt;&lt;widget &quot;Tesska_UnusualCustomers&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you get a lot of unusual customers in here?&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Unusual? What, like wide-eyed princesses trying their best to look like they are slumming it with the common-folk?&lt;&lt;/speech&gt;&gt;

  You feel your cheeks flush, and she catches it instantly.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Relax, sweetheart. I don&#39;t mean it cruel. Your secret&#39;s not out. I&#39;m just not as innebriated like the rest of this lot, and keeping your wits about you is a requirement for this job. It&#39;s not every day a girl like you walks in looking like she&#39;s never had to split a tab or fend off a drunkard.&lt;&lt;/speech&gt;&gt;

  She leans a little closer, voice lowered just enough to feel like a secret.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;But yes. We get our share. Half-orc mercenaries like Drekka over there, who bathe in ale more than water. Quiet types with knives too clean and coin too heavy. Once had a man come in wearing a full suit of armor just to drink milk. Sat for three hours. Didn&#39;t say a word. Tipped a whole gold and walked out.&lt;&lt;/speech&gt;&gt;&lt;&lt;know &quot;brakka&quot;&gt;&gt;
    
  She pauses as if waiting for your expression—then grins when you meet her eyes.

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Point is, Bastion&#39;s big. It spills strange folks into every corner, especially places with warmth and liquor. You stay long enough, you&#39;ll see a few things that&#39;ll make your palace stories feel quaint.&lt;&lt;/speech&gt;&gt;
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;run setup.tesska_Conversation_Options_Phase0()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="95" name="Tesska_Exit" tags="widget" position="600,1225" size="100,100">&lt;&lt;widget &quot;Tesska_Exit&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Thanks, Tesska. I think I&#39;ll just sit quietly for a bit.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Suit yourself, sweetheart. But if you get bored, I&#39;m just a holler away—as long as I&#39;m not elbow-deep in someone else&#39;s bad decisions.&lt;&lt;/speech&gt;&gt;

  She winks, then turns with a little extra sway in her hips as she walks away, glancing once over her shoulder to make sure you&#39;re watching.

  &lt;&lt;if not $TalkedTo_Tesska&gt;&gt;
    &lt;&lt;set $TalkedTo_Tesska = true&gt;&gt;
    &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
  &lt;&lt;/if&gt;&gt;

  &lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
    &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
    [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
  &lt;&lt;/if&gt;&gt;
  [[Look around the tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="96" name="Tesska_ExitDrink" tags="widget" position="725,1225" size="100,100">&lt;&lt;widget &quot;Tesska_ExitDrink&quot;&gt;&gt;
&lt;&lt;append &quot;#convoBox&quot;&gt;&gt;
  &lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I think I&#39;m just going to nurse this drink for a while. Thanks again.&lt;&lt;/speech&gt;&gt;

  &lt;&lt;speech &quot;tesska&quot;&gt;&gt;Mmh, take your time with it. Good drinks—and good company—are meant to be savored.&lt;&lt;/speech&gt;&gt;

  She taps her knuckle lightly on the table, gives you a knowing smile, and glides off into the crowd like she owns every beam and brick of the room.

  &lt;&lt;if not $TalkedTo_Tesska&gt;&gt;
    &lt;&lt;set $TalkedTo_Tesska = true&gt;&gt;
    &lt;&lt;set $TavernTalkCount += 1&gt;&gt;
  &lt;&lt;/if&gt;&gt;

  &lt;&lt;if $TavernTalkCount &gt;= 3 and not $DiceRatsCalled&gt;&gt;
    &lt;&lt;set $DiceRatsCalled = true&gt;&gt;
    [[You hear a commotion from the direction of the dice player&#39;s table.|DiceRat_CallEvent]]
  &lt;&lt;/if&gt;&gt;

  [[Look around the tavern.|Scene03_TheSpace]]
&lt;&lt;/append&gt;&gt;
&lt;&lt;run setup.clearConvoChoices()&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="97" name="center" tags="" position="850,1225" size="100,100">the center node &lt;&lt;loadmap &quot;test-map&quot;&gt;&gt;&gt;&gt;</tw-passagedata><tw-passagedata pid="98" name="bottom" tags="" position="975,1225" size="100,100">The bottom node. Can&#39;t go back up.</tw-passagedata><tw-passagedata pid="99" name="bottom-right" tags="" position="1100,1225" size="100,100">&lt;!-- Auto-generated passage for Test --&gt;
&lt;!-- Add your passage content here --&gt;</tw-passagedata><tw-passagedata pid="100" name="right" tags="" position="1225,1225" size="100,100">The right passage. Can&#39;t go back left.</tw-passagedata><tw-passagedata pid="101" name="top-right" tags="" position="100,1350" size="100,100">The top right passage.</tw-passagedata><tw-passagedata pid="102" name="top" tags="" position="225,1350" size="100,100">The top node.

 * DING *&lt;&lt;set $VisitedNorth = true&gt;&gt;

Go down. A path has opened.</tw-passagedata><tw-passagedata pid="103" name="left" tags="" position="350,1350" size="100,100">The left node. Congrats. What a prize.</tw-passagedata><tw-passagedata pid="104" name="Test_MapData" tags="" position="475,1350" size="100,100">&lt;!-- Map data for Test --&gt;
&lt;!-- This passage contains the map configuration --&gt;</tw-passagedata><tw-passagedata pid="105" name="FireConvergence" tags="" position="600,1350" size="100,100">You run as fast as your feet can carry you, boots slapping against the drenched cobblestones, each step sending up cold sprays of rainwater. The storm howls overhead, a constant, deafening roar of wind and thunder. By the time you reach the source of the blaze, you are soaked to the skin, your breath sawing in and out of your chest—but none of it matters once you see what lies ahead.

A building—large, old, familiar—stands wreathed in fire, the night around it lit with a sickly orange glare. Thick black smoke coils up into the rain-choked sky, carrying with it the stench of burning wood, scorched cloth, and something darker—something that makes your stomach twist. A massive, jagged scorch mark scars the front facade where the lightning bolt struck, its edges still glowing faintly, like the wound is too fresh to scab over.

Flames rage from shattered windows and splintered beams, licking out into the storm like hungry tongues. Beneath the crackle and roar of the fire, you hear the building groaning—wooden supports bending and breaking with sharp, splintering sounds as the structure slowly loses its battle against the flames.

Stumbling out into the street are a handful of women, their conservative nightgowns plastered to their bodies, clinging and translucent from the relentless rain. Soot streaks their faces and arms, mingling with the ash that sticks to wet skin. In their arms, clutching at hems and hands, is a herd of children—small, shivering forms, wide-eyed with terror. The women move frantically, gathering them in, counting, searching.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;&lt;em&gt;Gods...&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

The realization strikes you like a blow to the chest. The building, this burning monolith of dread, is an &lt;strong&gt;Orphanage&lt;/strong&gt;.

You force your legs forward, heart hammering against your ribs as you approach the women—priestesses, you realize now, of the Order of Palms.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;My name is Jaylie. Is everyone alright? Did everyone get out okay?&lt;&lt;/speech&gt;&gt;

One of the women—young, her hair plastered to her skull, face slick with rain and soot—barely acknowledges you. Her eyes dart feverishly from child to child, lips moving soundlessly as she ticks off names in her head. And then—her face freezes. Horror blooms across her features like a spreading stain.

She whirls toward an older priestess, a broad-shouldered woman whose sodden gray hair hangs in ropes down her back.

&lt;&lt;speech &quot;priestess_anna&quot;&gt;&gt;Priestess Rema! Where&#39;s Zan? I don&#39;t see Zan—he must not have been in bed!&lt;&lt;/speech&gt;&gt;&lt;&lt;know &quot;priestess_rema&quot;&gt;&gt;

The older woman repeats the scan, her mouth tightening as the grim calculation settles in. She shakes her head slowly, as if trying to deny the truth even as it forms.

&lt;&lt;speech &quot;priestess_rema&quot;&gt;&gt;Oh gods, Anna. He&#39;s still inside!&lt;&lt;/speech&gt;&gt;&lt;&lt;know &quot;priestess_anna&quot;&gt;&gt;

You speak again, louder this time, cutting through the crackle of the fire and the hammering of rain.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Tell me where to look for him!&lt;&lt;/speech&gt;&gt;

A voice stirs in the back of your mind, cold and rational, asking a simple, harrowing question: &lt;strong&gt;*What are you doing?*&lt;/strong&gt;

But already your body is moving, your breath coming faster—not with fear, but with grim determination.

&lt;&lt;speech &quot;priestess_anna&quot;&gt;&gt;Zan likes to wander at night. He could have gone to the kitchens, the restroom, the library—I don&#39;t know! But the fire— You can&#39;t!&lt;&lt;/speech&gt;&gt;

You barely hear her protest. Logic, caution, fear—all of it burns away under a rising tide of purpose. Your fingers clench into fists at your sides. Your feet find the ground. Your lungs fill with smoke-tinged air.

Without another word, [[you step toward the inferno.|OrphanageFireStart]]</tw-passagedata><tw-passagedata pid="106" name="OrphanageFireStart" tags="" position="725,1350" size="100,100">You stand in front of the Orphanage of Palms.  &lt;&lt;loadmap &quot;orphanage_fire_1F&quot;&gt;&gt;

The building has a pillar of black smoke melding with the night sky above. Despite the heavy rain, the upper floor of the building is engulfed in flames. &lt;div&gt;
&lt;/div&gt;&lt;div&gt;The front door to orphanage stands open, swinging in the gusty winds of the storm. Wisps of dark smoke creep out from the top of the door frame, carried away by the wind.

Somewhere inside.... A young boy is all on his own.&lt;/div&gt;</tw-passagedata><tw-passagedata pid="107" name="OrphanageEntryway" tags="" position="850,1350" size="100,100"></tw-passagedata><tw-passagedata pid="108" name="OrphanageMainHall1" tags="" position="975,1350" size="100,100"></tw-passagedata><tw-passagedata pid="109" name="OrphanageHall4-6" tags="" position="1100,1350" size="100,100"></tw-passagedata><tw-passagedata pid="110" name="OrphanageHall3-6" tags="" position="1225,1350" size="100,100"></tw-passagedata><tw-passagedata pid="111" name="OrphanageHall3-5" tags="" position="100,1475" size="100,100"></tw-passagedata><tw-passagedata pid="112" name="OrphanageHall3-4" tags="" position="225,1475" size="100,100"></tw-passagedata><tw-passagedata pid="113" name="OrphanageMainHall3" tags="" position="350,1475" size="100,100"></tw-passagedata><tw-passagedata pid="114" name="OrphanageHall6-6" tags="" position="475,1475" size="100,100"></tw-passagedata><tw-passagedata pid="115" name="OrphanageHall7-6" tags="" position="600,1475" size="100,100"></tw-passagedata><tw-passagedata pid="116" name="OrphanageChapelNorth" tags="" position="725,1475" size="100,100"></tw-passagedata><tw-passagedata pid="117" name="OrphanageHall3-3" tags="" position="850,1475" size="100,100"></tw-passagedata><tw-passagedata pid="118" name="OrphanageHall4-3" tags="" position="975,1475" size="100,100"></tw-passagedata><tw-passagedata pid="119" name="OrphanageMainHall4" tags="" position="1100,1475" size="100,100"></tw-passagedata><tw-passagedata pid="120" name="OrphanageHall8-6" tags="" position="1225,1475" size="100,100"></tw-passagedata><tw-passagedata pid="121" name="OrphanageHall8-5" tags="" position="100,1600" size="100,100"></tw-passagedata><tw-passagedata pid="122" name="OrphanageHall8-4" tags="" position="225,1600" size="100,100"></tw-passagedata><tw-passagedata pid="123" name="OrphanageHall8-3" tags="" position="350,1600" size="100,100"></tw-passagedata><tw-passagedata pid="124" name="OrphanageHall7-3" tags="" position="475,1600" size="100,100"></tw-passagedata><tw-passagedata pid="125" name="OrphanageHall6-3" tags="" position="600,1600" size="100,100"></tw-passagedata><tw-passagedata pid="126" name="OrphanageChapelSouth" tags="" position="725,1600" size="100,100"></tw-passagedata><tw-passagedata pid="127" name="OrphanageFirstFloorWashroom" tags="" position="850,1600" size="100,100"></tw-passagedata><tw-passagedata pid="128" name="OrphanageUtilityStorage" tags="" position="975,1600" size="100,100"></tw-passagedata><tw-passagedata pid="129" name="OrphanageLibraryNorth" tags="" position="1100,1600" size="100,100"></tw-passagedata><tw-passagedata pid="130" name="OrphanageMainStairwell1F" tags="" position="1225,1600" size="100,100"></tw-passagedata><tw-passagedata pid="131" name="OrphanageClassroom1East" tags="" position="100,1725" size="100,100"></tw-passagedata><tw-passagedata pid="132" name="OrphanageMainHall2" tags="" position="225,1725" size="100,100"></tw-passagedata><tw-passagedata pid="133" name="OrphanagePlayroom" tags="" position="350,1725" size="100,100"></tw-passagedata><tw-passagedata pid="134" name="OrphanageGreenhouse" tags="" position="475,1725" size="100,100"></tw-passagedata><tw-passagedata pid="135" name="OrphanageHeadArbiterOfficeWest" tags="" position="600,1725" size="100,100"></tw-passagedata><tw-passagedata pid="136" name="OrphanageServiceStairwell1F" tags="" position="725,1725" size="100,100"></tw-passagedata><tw-passagedata pid="137" name="OrphanageKitchen" tags="" position="850,1725" size="100,100"></tw-passagedata><tw-passagedata pid="138" name="OrphanageMessHall" tags="" position="975,1725" size="100,100"></tw-passagedata><tw-passagedata pid="139" name="NPCGenerator" tags="widget" position="1675,350" size="100,100">&lt;&lt;widget &quot;GenerateNPC&quot;&gt;&gt;
&lt;&lt;set _npc to setup.generateNPC(&quot;female&quot;, &quot;human&quot;, &quot;Courtesan&quot;)&gt;&gt;
&lt;&lt;print &quot;Generated NPC: &quot;&gt;&gt;
&lt;&lt;print _npc.name&gt;&gt; the &lt;&lt;_npc.archetype&gt;&gt; (&lt;&lt;_npc.race&gt;&gt;)
&lt;&lt;print &quot;Style: &quot; + _npc.style&gt;&gt;
&lt;&lt;print &quot;Trait: &quot; + _npc.trait + &quot;, Inclination: &quot; + _npc.inclination&gt;&gt;
&lt;&lt;/widget&gt;&gt;</tw-passagedata><tw-passagedata pid="140" name="MiniMap" tags="special" position="1225,1725" size="100,100">&lt;!-- 
MiniMap.tw - Twine Special Passage for Enhanced Node Network System
This passage initializes the new NodeMapSystem and provides integration hooks.
--&gt;

&lt;script&gt;
// Initialize node map system when this passage is processed
$(document).ready(function() {
    // Wait for all systems to be loaded
    setTimeout(() =&gt; {
        if (typeof NodeMapSystem !== &#39;undefined&#39; &amp;&amp; setup.SidebarUI) {
            // Initialize node map if not already done
            if (!setup.SidebarUI.nodeMapSystem) {
                setup.SidebarUI.initializeNodeMap();
            }
        } else {
            console.warn(&#39;[MiniMap] Required systems not available&#39;);
        }
    }, 500);
});

// Global node map update functions for backward compatibility
window.updateMinimapLegacy = function(mapId, position) {
    if (setup.SidebarUI &amp;&amp; setup.SidebarUI.updateNodeMap) {
        setup.SidebarUI.updateNodeMap(mapId, position);
    }
};

window.refreshMinimapLegacy = function() {
    if (setup.SidebarUI &amp;&amp; setup.SidebarUI.refreshNodeMap) {
        setup.SidebarUI.refreshNodeMap();
    }
};

// New node-based functions
window.updateNodeMap = function(mapId, nodeId) {
    if (setup.SidebarUI &amp;&amp; setup.SidebarUI.updateNodeMap) {
        setup.SidebarUI.updateNodeMap(mapId, { nodeId: nodeId });
    }
};

window.refreshNodeMap = function() {
    if (setup.SidebarUI &amp;&amp; setup.SidebarUI.refreshNodeMap) {
        setup.SidebarUI.refreshNodeMap();
    }
};

window.setPlayerNode = function(nodeId) {
    if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeMapSystem) {
        setup.SidebarUI.nodeMapSystem.setPlayerPosition(nodeId);
    }
};

// Integration with existing navigation events
$(document).on(&#39;:passagedisplay&#39;, function() {
    // Update node map when passages change
    if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeMapSystem) {
        const currentMap = State.variables.currentMap;
        const playerNode = State.variables.playerNode || State.variables.currentNode;
        
        if (currentMap &amp;&amp; playerNode) {
            setup.SidebarUI.updateNodeMap(currentMap, { nodeId: playerNode });
        }
    }
});

// Helper functions for node navigation
window.NodeMapHelpers = {
    // Move player to a specific node
    moveToNode: function(nodeId) {
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeNavigationSystem) {
            setup.SidebarUI.nodeNavigationSystem.teleport(nodeId);
            State.variables.playerNode = nodeId;
            State.variables.currentNode = nodeId;
        }
    },
    
    // Get current player node
    getCurrentNode: function() {
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeNavigationSystem) {
            return setup.SidebarUI.nodeNavigationSystem.getPosition();
        }
        return State.variables.playerNode || State.variables.currentNode;
    },
    
    // Get connected nodes from current position
    getConnectedNodes: function() {
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeMapSystem &amp;&amp; setup.SidebarUI.nodeNavigationSystem) {
            const currentNode = setup.SidebarUI.nodeNavigationSystem.getPosition();
            return setup.SidebarUI.nodeMapSystem.getConnectedNodes(currentNode);
        }
        return [];
    },
    
    // Check if movement to a node is valid
    canMoveTo: function(nodeId) {
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeMapSystem &amp;&amp; setup.SidebarUI.nodeNavigationSystem) {
            const currentNode = setup.SidebarUI.nodeNavigationSystem.getPosition();
            return setup.SidebarUI.nodeMapSystem.isValidMovement(currentNode, nodeId);
        }
        return false;
    },
    
    // Load a new map
    loadMap: function(mapId, startNodeId) {
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeMapSystem) {
            const position = startNodeId ? { nodeId: startNodeId } : null;
            return setup.SidebarUI.nodeMapSystem.loadMap(mapId, position);
        }
        return Promise.resolve(false);
    },
    
    // Get current map info
    getCurrentMapInfo: function() {
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeMapSystem) {
            return setup.SidebarUI.nodeMapSystem.getCurrentMapInfo();
        }
        return null;
    }
};

// Macro integration for Twine passages
window.NodeMapMacros = {
    // Set current node (for use in passages)
    setNode: function(nodeId) {
        State.variables.playerNode = nodeId;
        State.variables.currentNode = nodeId;
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeNavigationSystem) {
            setup.SidebarUI.nodeNavigationSystem.setPosition(nodeId, true);
        }
    },
    
    // Load map and set position (for use in passages)
    loadMapAndSetNode: function(mapId, nodeId) {
        State.variables.currentMap = mapId;
        State.variables.playerNode = nodeId;
        State.variables.currentNode = nodeId;
        
        if (setup.SidebarUI &amp;&amp; setup.SidebarUI.nodeMapSystem) {
            setup.SidebarUI.nodeMapSystem.loadMap(mapId, { nodeId: nodeId });
        }
    },
    
    // Check if player is at a specific node
    isAtNode: function(nodeId) {
        const currentNode = State.variables.playerNode || State.variables.currentNode;
        return currentNode === nodeId;
    },
    
    // Check if player can access a node
    canAccessNode: function(nodeId) {
        return NodeMapHelpers.canMoveTo(nodeId);
    }
};

console.log(&#39;[MiniMap] Enhanced node network system integration loaded&#39;);
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="141" name="SidebarUI" tags="nobr" position="100,1850" size="100,100">&lt;!-- Top Nav and Collapse --&gt;
&lt;div id=&quot;sidebar-topbar&quot;&gt;
	&lt;div id=&quot;sidebar-nav&quot;&gt;
		&lt;button id=&quot;sidebar-nav-back&quot; class=&quot;sidebar-nav-btn&quot; title=&quot;Go back&quot;&gt;
			&lt;i data-lucide=&quot;undo-2&quot;&gt;&lt;/i&gt;
		&lt;/button&gt;
		&lt;button id=&quot;sidebar-nav-forward&quot; class=&quot;sidebar-nav-btn&quot; title=&quot;Go forward&quot;&gt;
			&lt;i data-lucide=&quot;redo-2&quot;&gt;&lt;/i&gt;
		&lt;/button&gt;
	&lt;/div&gt;
	&lt;button id=&quot;sidebar-toggle&quot; type=&quot;button&quot; class=&quot;sidebar-btn&quot;&gt;
		&lt;i id=&quot;sidebar-arrow&quot; data-lucide=&quot;arrow-left&quot;&gt;&lt;/i&gt;
	&lt;/button&gt;
&lt;/div&gt;


&lt;!-- Collapsed Summary --&gt;
&lt;div id=&quot;sidebar-summary&quot; style=&quot;display: none; flex-direction: column; align-items: center; gap: 8px;&quot;&gt;
	&lt;span id=&quot;summary-time&quot;&gt;--:--&lt;/span&gt;
	&lt;span id=&quot;summary-date&quot;&gt;Loading Date...&lt;/span&gt;
	&lt;div id=&quot;summary-location-weather&quot; style=&quot;display: flex; flex-direction: column; align-items: center;&quot;&gt;
		&lt;i id=&quot;sidebar-weather-icon&quot; data-lucide=&quot;sun&quot; title=&quot;Clear Skies&quot;&gt;&lt;/i&gt;
		&lt;span id=&quot;summary-location&quot;&gt;Unknown&lt;/span&gt;
	&lt;/div&gt;
	&lt;span id=&quot;summary-gold&quot;&gt;0&lt;/span&gt;
	&lt;div id=&quot;summary-status-icons&quot;&gt;
		&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-health-wrap&quot;&gt;
			&lt;div class=&quot;summary-fill&quot; id=&quot;summary-health-fill&quot;&gt;&lt;/div&gt;
			&lt;i id=&quot;summary-health&quot; data-lucide=&quot;heart&quot;&gt;&lt;/i&gt;
		&lt;/div&gt;
		&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-fatigue-wrap&quot;&gt;
			&lt;div class=&quot;summary-fill&quot; id=&quot;summary-fatigue-fill&quot;&gt;&lt;/div&gt;
			&lt;i id=&quot;summary-fatigue&quot; data-lucide=&quot;zap&quot;&gt;&lt;/i&gt;
		&lt;/div&gt;
		&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-composure-wrap&quot;&gt;
			&lt;div class=&quot;summary-fill&quot; id=&quot;summary-composure-fill&quot;&gt;&lt;/div&gt;
			&lt;i id=&quot;summary-composure&quot; data-lucide=&quot;brain&quot;&gt;&lt;/i&gt;
		&lt;/div&gt;
		&lt;div class=&quot;summary-icon-wrap&quot; id=&quot;summary-excitement-wrap&quot;&gt;
			&lt;div class=&quot;summary-fill&quot; id=&quot;summary-excitement-fill&quot;&gt;&lt;/div&gt;
			&lt;i id=&quot;summary-excitement&quot; data-lucide=&quot;flame&quot;&gt;&lt;/i&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;div id=&quot;summary-level-exp&quot; style=&quot;display: flex; flex-direction: column; align-items: center;&quot;&gt;
		&lt;span id=&quot;summary-level&quot;&gt;Lvl 1&lt;/span&gt;
		&lt;div class=&quot;exp-bar-mini&quot;&gt;
			&lt;div class=&quot;exp-bar-fill-mini&quot; id=&quot;exp-fill-mini&quot;&gt;&lt;/div&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;div id=&quot;summary-conditions&quot;&gt;&lt;/div&gt;
	&lt;div id=&quot;summary-bug-report&quot;&gt;
		&lt;button class=&quot;sidebar-icon-only&quot; onclick=&quot;openOverlay(&#39;bug-report-page&#39;)&quot; title=&quot;Report Bug&quot;&gt;
		&lt;i data-lucide=&quot;bug-play&quot;&gt;&lt;/i&gt;
		&lt;/button&gt;
	&lt;/div&gt;
&lt;/div&gt;

&lt;!-- Main Scrollable Content --&gt;
&lt;div id=&quot;sidebar-content&quot;&gt;
	&lt;div id=&quot;sidebar-top-info&quot;&gt;
		&lt;div id=&quot;sidebar-top-line1&quot;&gt;
			&lt;span id=&quot;sidebar-time&quot;&gt;6:00&lt;/span&gt;
			&lt;span class=&quot;dot-separator&quot;&gt;•&lt;/span&gt;
			&lt;span id=&quot;sidebar-date&quot;&gt;1 Rain, 12219 AI&lt;/span&gt;
			&lt;span class=&quot;dot-separator&quot;&gt;•&lt;/span&gt;
			&lt;span id=&quot;sidebar-location&quot;&gt;Unknown Location&lt;/span&gt;
		&lt;/div&gt;
		&lt;div id=&quot;sidebar-top-line2&quot;&gt;
			&lt;span id=&quot;sidebar-gold&quot;&gt;
				&lt;i data-lucide=&quot;coins&quot;&gt;&lt;/i&gt;
				&lt;span id=&quot;sidebar-gold-amount&quot;&gt;100&lt;/span&gt;g
			&lt;/span&gt;
		&lt;span class=&quot;dot-separator&quot;&gt;•&lt;/span&gt;
		&lt;span id=&quot;sidebar-weather&quot;&gt;
			&lt;i id=&quot;sidebar-weather-icon&quot; data-lucide=&quot;sun&quot; title=&quot;Clear Skies&quot;&gt;&lt;/i&gt;
		&lt;/span&gt;
	&lt;/div&gt;
&lt;/div&gt;

	&lt;div id=&quot;sidebar-status-tracker&quot;&gt;
		&lt;div class=&quot;status-bar&quot; id=&quot;health-bar&quot;&gt;
			&lt;i data-lucide=&quot;heart&quot;&gt;&lt;/i&gt;
			&lt;span&gt;Health&lt;/span&gt;
			&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
				&lt;div class=&quot;status-bar-fill&quot; id=&quot;health-fill&quot;&gt;&lt;/div&gt;
			&lt;/div&gt;
			&lt;span class=&quot;bar-value&quot; id=&quot;health-value&quot;&gt;&lt;/span&gt;
		&lt;/div&gt;
		&lt;div class=&quot;status-bar&quot; id=&quot;fatigue-bar&quot;&gt;
			&lt;i data-lucide=&quot;zap&quot;&gt;&lt;/i&gt;
			&lt;span&gt;Fatigue&lt;/span&gt;
			&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
				&lt;div class=&quot;status-bar-fill&quot; id=&quot;fatigue-fill&quot;&gt;&lt;/div&gt;
			&lt;/div&gt;
			&lt;span class=&quot;bar-value&quot; id=&quot;fatigue-value&quot;&gt;&lt;/span&gt;
		&lt;/div&gt;
		&lt;div class=&quot;status-bar&quot; id=&quot;composure-bar&quot;&gt;
			&lt;i data-lucide=&quot;brain&quot;&gt;&lt;/i&gt;
			&lt;span&gt;Composure&lt;/span&gt;
			&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
				&lt;div class=&quot;status-bar-fill&quot; id=&quot;composure-fill&quot;&gt;&lt;/div&gt;
			&lt;/div&gt;
			&lt;span class=&quot;bar-value&quot; id=&quot;composure-value&quot;&gt;&lt;/span&gt;
		&lt;/div&gt;
		&lt;div class=&quot;status-bar&quot; id=&quot;excitement-bar&quot;&gt;
			&lt;i data-lucide=&quot;flame&quot;&gt;&lt;/i&gt;
			&lt;span&gt;Excitement&lt;/span&gt;
			&lt;div class=&quot;status-bar-fill-wrapper&quot;&gt;
				&lt;div class=&quot;status-bar-fill&quot; id=&quot;excitement-fill&quot;&gt;&lt;/div&gt;
			&lt;/div&gt;
			&lt;span class=&quot;bar-value&quot; id=&quot;excitement-value&quot;&gt;&lt;/span&gt;
		&lt;/div&gt;
		&lt;div id=&quot;conditional-status-bars&quot;&gt;&lt;/div&gt;
	&lt;/div&gt;

	&lt;div id=&quot;sidebar-carryweight&quot; style=&quot;display:none;&quot;&gt;
		&lt;i data-lucide=&quot;package&quot;&gt;&lt;/i&gt; &lt;span id=&quot;carryweight-text&quot;&gt;Carryweight: 0/100&lt;/span&gt;
		&lt;div class=&quot;status-bar-carry&quot;&gt;
			&lt;div class=&quot;carry-bar-fill&quot; id=&quot;carry-fill&quot;&gt;&lt;/div&gt;
		&lt;/div&gt;
	&lt;/div&gt;

	&lt;div id=&quot;sidebar-level-exp&quot;&gt;
		&lt;span id=&quot;sidebar-level&quot;&gt;Lvl 1&lt;/span&gt;
		&lt;div class=&quot;exp-bar&quot;&gt;
			&lt;div class=&quot;exp-bar-fill&quot; id=&quot;exp-fill&quot;&gt;&lt;/div&gt;
		&lt;/div&gt;
		&lt;span id=&quot;exp-text&quot;&gt;0/100 XP&lt;/span&gt;
	&lt;/div&gt;

	&lt;!-- Minimap Section --&gt;
	&lt;div id=&quot;sidebar-minimap-container&quot;&gt;
		&lt;div class=&quot;minimap-header&quot;&gt;
			&lt;i data-lucide=&quot;map&quot;&gt;&lt;/i&gt;
			&lt;span&gt;Local Map&lt;/span&gt;
			&lt;button id=&quot;minimap-fullscreen-btn&quot; class=&quot;minimap-control-btn&quot; title=&quot;View Full Map&quot;&gt;
				&lt;i data-lucide=&quot;maximize-2&quot;&gt;&lt;/i&gt;
			&lt;/button&gt;
		&lt;/div&gt;
		&lt;div id=&quot;tile-map-container&quot; class=&quot;minimap-display&quot;&gt;&lt;/div&gt;
		&lt;div class=&quot;minimap-info&quot;&gt;
			&lt;div class=&quot;minimap-location&quot;&gt;
				&lt;span id=&quot;minimap-current-map&quot;&gt;Loading...&lt;/span&gt;
			&lt;/div&gt;
			&lt;div class=&quot;minimap-position&quot;&gt;
				Pos: &lt;span id=&quot;minimap-player-coords&quot;&gt;(0, 0)&lt;/span&gt;
			&lt;/div&gt;
		&lt;/div&gt;
	&lt;/div&gt;

	&lt;div id=&quot;custom-sidebar-buttons&quot;&gt;
		&lt;div class=&quot;button-single&quot;&gt;
			&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;character-sheet&#39;)&quot;&gt;
				&lt;i data-lucide=&quot;scroll-text&quot;&gt;&lt;/i&gt; Character
			&lt;/button&gt;
		&lt;/div&gt;
		&lt;div class=&quot;button-single&quot;&gt;
			&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;inventory-page&#39;)&quot;&gt;
				&lt;i data-lucide=&quot;backpack&quot;&gt;&lt;/i&gt; Inventory
			&lt;/button&gt;
		&lt;/div&gt;
		&lt;div class=&quot;button-pair&quot;&gt;
			&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;journal-page&#39;)&quot;&gt;
				&lt;i data-lucide=&quot;book-open&quot;&gt;&lt;/i&gt; Journal
			&lt;/button&gt;
			&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;people-page&#39;)&quot;&gt;
				&lt;i data-lucide=&quot;users&quot;&gt;&lt;/i&gt; People
			&lt;/button&gt;
		&lt;/div&gt;
		&lt;div class=&quot;button-pair&quot;&gt;
			&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;stats-page&#39;)&quot;&gt;
				&lt;i data-lucide=&quot;brain&quot;&gt;&lt;/i&gt; Stats
			&lt;/button&gt;
			&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;achievements-page&#39;)&quot;&gt;
				&lt;i data-lucide=&quot;star&quot;&gt;&lt;/i&gt; Achievements
			&lt;/button&gt;
		&lt;/div&gt;
		&lt;div class=&quot;button-pair&quot;&gt;
			&lt;&lt;button &#39;&lt;i data-lucide=&quot;save&quot;&gt;&lt;/i&gt; Saves&#39;&gt;&gt;
				&lt;&lt;run UI.saves()&gt;&gt;
			&lt;&lt;/button&gt;&gt;
			&lt;button class=&quot;sidebar-btn&quot; id=&quot;sidebar-options&quot;&gt;
                &lt;i data-lucide=&quot;settings&quot;&gt;&lt;/i&gt; Options
            &lt;/button&gt;
		&lt;/div&gt;	
	&lt;/div&gt;
	&lt;div id=&quot;sidebar-support-links&quot;&gt;
		&lt;a href=&quot;https://pmoe-97.itch.io/liff-origins-jaylie&quot; target=&quot;_blank&quot; title=&quot;Visit on Itch.io&quot;&gt;
			&lt;img src=&quot;images/itch-icon.png&quot; alt=&quot;Itch.io&quot; class=&quot;sidebar-support-icon&quot;&gt;
		&lt;/a&gt;
		&lt;a href=&quot;https://patreon.com/Pmoe&quot; target=&quot;_blank&quot; title=&quot;Support on Patreon&quot;&gt;
			&lt;img src=&quot;images/patreon-icon.png&quot; alt=&quot;Patreon&quot; class=&quot;sidebar-support-icon&quot;&gt;
		&lt;/a&gt;
	&lt;/div&gt;

	&lt;div id=&quot;bug-report-button&quot;&gt;
		&lt;button class=&quot;sidebar-btn&quot; onclick=&quot;openOverlay(&#39;bug-report-page&#39;)&quot;&gt;
			&lt;i data-lucide=&quot;bug-play&quot;&gt;&lt;/i&gt; Report Bug
		&lt;/button&gt;
	&lt;/div&gt;
&lt;/div&gt;

&lt;&lt;script&gt;&gt;
const s = State.variables.player.status;

function updateBar(id, current, max) {
	const fill = document.getElementById(id + &quot;-fill&quot;);
	const value = document.getElementById(id + &quot;-value&quot;);
	if (fill) fill.style.width = ((current / max) * 100) + &quot;%&quot;;
	if (value) value.textContent = Math.round(current) + &quot; / &quot; + Math.round(max);
}

updateBar(&quot;health&quot;, s.health, s.maxHealth);
updateBar(&quot;fatigue&quot;, s.fatigue, s.maxFatigue);
updateBar(&quot;composure&quot;, s.composure, s.maxComposure);
updateBar(&quot;excitement&quot;, s.excitement, s.maxExcitement);

if (typeof setup?.SidebarUI?.initialize === &quot;function&quot;) {
	setup.SidebarUI.initialize();
}

(function waitForLucide(retries = 20) {
	if (window.lucide &amp;&amp; typeof lucide.createIcons === &quot;function&quot;) {
		console.log(&quot;[SidebarUI] Lucide is ready — rendering icons!&quot;);
		lucide.createIcons();
	} else if (retries &gt; 0) {
		setTimeout(() =&gt; waitForLucide(retries - 1), 100);
	} else {
		console.warn(&quot;[SidebarUI] Lucide failed to initialize after timeout.&quot;);
	}
})();
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="142" name="StoryAuthor" tags="" position="100,0" size="100,100">Pmoe</tw-passagedata><tw-passagedata pid="143" name="StoryAuthorInfo" tags="" position="200,0" size="100,100">Copyright © 2025 Parker Lee Christiansen. All Rights Reserved.</tw-passagedata><tw-passagedata pid="144" name="StoryBanner" tags="" position="300,0" size="100,100">&lt;b&gt;Liff Origins&lt;/b&gt; — Jaylie</tw-passagedata><tw-passagedata pid="145" name="StoryDisplay" tags="startup nobr" position="500,0" size="100,100">&lt;!-- No longer used for sidebar logic --&gt;</tw-passagedata><tw-passagedata pid="146" name="StoryInit" tags="" position="600,0" size="100,100">&lt;&lt;if $DEBUG is true&gt;&gt;
  &lt;&lt;print Macro.has(&quot;SidebarUI&quot;)&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;run setup.NPCs = []&gt;&gt;
&lt;&lt;run setup.Seed = Math.seedrandom(&quot;liff&quot;)&gt;&gt;


&lt;&lt;run State.variables.characters = setup.initializeCharacters()&gt;&gt;

&lt;&lt;run
	(() =&gt; {
		const path = State.variables.bgImage;
		const el = document.getElementById(&quot;background&quot;);
		if (path &amp;&amp; el) {
			el.style.backgroundImage = `url(&#39;${path}&#39;)`;
			console.log(`🖼️ Background applied on init: ${path}`);
		}
	})();
&gt;&gt;</tw-passagedata><tw-passagedata pid="147" name="StoryInterface" tags="" position="700,0" size="100,100">&lt;!-- =============================
=     Required SugarCube Node    =
============================= --&gt;
&lt;div id=&quot;passages&quot;&gt;&lt;/div&gt;

&lt;!-- =============================
=     Main Visual Structure      =
============================= --&gt;
&lt;div id=&quot;background-image&quot;&gt;&lt;/div&gt;

&lt;div id=&quot;text-container&quot;&gt;
  &lt;div id=&quot;text-backdrop&quot;&gt;
    &lt;!-- This will either get populated with dialogue layout OR reattached #dynamic-content --&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;!-- =============================
=        Custom Sidebar         =
============================= --&gt;
&lt;div id=&quot;custom-sidebar&quot; data-passage=&quot;SidebarUI&quot;&gt;&lt;/div&gt;


&lt;!-- =============================
=         Overlay Panel          =
============================= --&gt;
&lt;div id=&quot;overlay-panel&quot; class=&quot;overlay-hidden&quot;&gt;
  &lt;div id=&quot;overlay-body&quot;&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;!--===============================
=  Conversation Overlay Startup   =
================================--&gt;
&lt;div id=&quot;conversation-overlay&quot; class=&quot;convo-overlay overlay-hidden&quot;&gt;
    &lt;div class=&quot;convo-window&quot;&gt;
    &lt;img id=&quot;convo-avatar&quot; src=&quot;&quot; alt=&quot;Avatar&quot; /&gt;
    &lt;h2 id=&quot;convo-npc-name&quot;&gt;&lt;/h2&gt;
    &lt;div id=&quot;convo-npc-style&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;convo-npc-prompt&quot; class=&quot;convo-prompt&quot;&gt;&lt;/div&gt;

    &lt;div class=&quot;convo-choices&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;convo-actions&quot;&gt;
      &lt;!-- Action buttons here --&gt;
    &lt;/div&gt;

    &lt;div class=&quot;convo-results&quot;&gt;
      &lt;p id=&quot;convo-summary-gains&quot;&gt;&lt;/p&gt;
      &lt;p id=&quot;convo-summary-rapport&quot;&gt;&lt;/p&gt;
      &lt;p id=&quot;convo-summary-gifts&quot;&gt;&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;


&lt;!--===============================
=  Crown &amp; Caste Overlay Startup =
================================--&gt;
&lt;div id=&quot;crown-and-caste-page&quot; class=&quot;overlay-hidden&quot;&gt;

  &lt;div id=&quot;crown-caste-frame&quot;&gt;
    
    &lt;!-- Crown Dice Center Circle --&gt;
    &lt;div id=&quot;center-circle&quot;&gt;
      &lt;div class=&quot;crown-die&quot; id=&quot;crown-die-1&quot;&gt;?&lt;/div&gt;
      &lt;div class=&quot;crown-die&quot; id=&quot;crown-die-2&quot;&gt;?&lt;/div&gt;
      &lt;div class=&quot;crown-die&quot; id=&quot;crown-die-3&quot;&gt;?&lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Quadrant Player Zones --&gt;
    &lt;div id=&quot;top-left&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;
    &lt;div id=&quot;top-right&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;
    &lt;div id=&quot;bottom-left&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;
    &lt;div id=&quot;bottom-right&quot; class=&quot;player-zone&quot;&gt;...&lt;/div&gt;

    &lt;!-- Action Panel --&gt;
    &lt;div id=&quot;action-panel&quot;&gt;
      &lt;div id=&quot;action-title&quot;&gt;Your Turn&lt;/div&gt;
      &lt;button id=&quot;btn-roll&quot;&gt;Roll&lt;/button&gt;
      &lt;button id=&quot;btn-lock&quot;&gt;Lock/Unlock&lt;/button&gt;
      &lt;button id=&quot;btn-chip&quot;&gt;Use Chip&lt;/button&gt;
      &lt;button id=&quot;btn-end&quot;&gt;End Turn&lt;/button&gt;
    &lt;/div&gt;

  &lt;/div&gt;

&lt;/div&gt;</tw-passagedata><tw-passagedata pid="148" name="StoryMenu" tags="" position="800,0" size="100,100">* [[Credits]]
* [[Help]]</tw-passagedata><tw-passagedata pid="149" name="StorySubtitle" tags="" position="900,0" size="100,100">A Liff Story.</tw-passagedata><tw-passagedata pid="150" name="Start" tags="" position="175,125" size="100,100">&lt;&lt;bg &quot;default&quot;&gt;&gt;
# Introduction

Hello there and welcome to Liff Origins: Jaylie. This is my first game-development project and an introduction to the World of Liff, a fantasy world all my own where this small prequel and my planned future project, Adventures of Liff,  will take place.

In this story you play from the perspective of //Jaylie Primmon//, the Princess and heir to the throne of the Kingdom of Bastion. 

This story will contain elements of an &#39;&#39;ADULT/MATURE&#39;&#39; nature. Content like this is typically prohibited by law to be consumed by non-adults (18-21 in most places). By continuing with this story you confirm that you are legally allowed to consume this type of content wherever you are. 

[[Go forth and journey on|StoryStart_Scene01]]

[[Wait I am NOT an adult|Underage_Response]]


/* Placeholder - Remove before packaging for release */ 
&lt;&lt;CrownAndCaste 15 &quot;Dice Rat 1&quot; &quot;sarjan&quot; &quot;Dice Rat 2&quot; &quot;PostCAndCWinFightSetup&quot; &quot;PostCAndCLose&quot; 2.5&gt;&gt;

&lt;&lt;StartSexScene &quot;allura&quot;&gt;&gt;

[[Travel to the Fire Convergence|FireConvergence]]</tw-passagedata><tw-passagedata pid="151" name="Underage_Response" tags="" position="275,150" size="100,100">&#39;&#39;Get out of here!&#39;&#39;</tw-passagedata><tw-passagedata pid="152" name="Scene02_AddasGreeting" tags="" position="75,650" size="100,100">&lt;&lt;bg &quot;Scene02_AddaGreeting&quot;&gt;&gt;
&lt;&lt;speech &quot;adda&quot;&gt;&gt;You will have to forgive me for staring. If I didn&#39;t know any better I would have thought royalty had just walked into my humble parlor.&lt;&lt;/speech&gt;&gt;
	
	She gives you a thoughtful wink.
&lt;&lt;set $characters[&quot;adda&quot;].known = true&gt;&gt;
&lt;&lt;speech &quot;adda&quot;&gt;&gt;My name is Adda. The locals call me Mistress Adda, or Madam Adda, and this is my establishment, The Nuzzling Noctail. I assure you we have anything that could suit the needs of…&lt;&lt;/speech&gt;&gt;

	She looks you up and down, staring rather obviously at your hair, obviously recognizing its shade.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;...even the most discerning of clientele. May I ask what you&#39;d like to be called, &lt;em&gt;young Lady?&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

You shuffle uncomfortably for a moment. Coming in here seemed like such a great moment only seconds ago and now you stand before Mistress Adda whom you feel unpacked your whole identity in mere seconds.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; I suppose Jaylie would be fine, right?&lt;&lt;/speech&gt;&gt;

	You swear you&#39;d never felt more unsure of yourself than you suddenly were in this exact moment.

&lt;&lt;speech &quot;adda&quot;&gt;&gt; Not to worry, Jaylie. My hosts are all trained to uphold the utmost discretion, not that many of them are as observant as myself… &lt;span class=&quot;whisper&quot;&gt;your highness&lt;/span&gt;.&lt;&lt;/speech&gt;&gt;

You take a moment to catch your breath and find your tongue.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Well thank you Madam Adda. I appreciate the hospitality and the discretion. Now if I may ask, what would one girl have to do to get a birthday drink for herself in your fine establishment? &lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;
&lt;em&gt;Birthday!?&lt;/em&gt; But of course! Why don&#39;t you follow me into the parlor. Let&#39;s get you comfortable. There&#39;s a bar if you want something to drink, but any of my talented hosts will be happy to assist you.&lt;&lt;/speech&gt;&gt;

&lt;p&gt;You follow Mistress Adda through a set of velvet red curtains and [[into the parlor|TheBrothelParlorOverview]].&lt;/p&gt;</tw-passagedata><tw-passagedata pid="153" name="Scene02_BrothelBar" tags="" position="350,1975" size="100,100">&lt;&lt;bg &quot;Scene02_TheBrothelParlor&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You make your way across the plush floor toward the bar, the air thick with perfume and low conversation. The man behind the counter is a picture of precision — tall, thin, immaculately dressed in a crimson waistcoat. His dark hair is slicked back without a single strand out of place, and the thick, hemispherical mustache above his lip gives him the appearance of someone who might scowl by default… if he ever showed enough expression to scowl.

At the moment, he&#39;s in the middle of mixing a drink — tossing a silver shaker through the air, flipping a small glass behind his back, and catching it without so much as glancing down. The movements are practiced, fluid, and somehow both showy and completely effortless.

Without looking your way, he pours the drink with one final flourish and slides it across the bar to a waiting hand.

Only then does he turn to you.

&lt;&lt;speech &quot;bert&quot;&gt;&gt;Can I get you something to drink? Maybe something to loosen your inhibitions. Or sharpen them, if that&#39;s more your taste.&lt;&lt;/speech&gt;&gt;

His voice is calm. Clipped. Not unfriendly — just focused. Every word is perfectly enunciated, with not a syllable wasted.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;It&#39;s my birthday, actually. Thought I&#39;d treat myself.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;bert&quot;&gt;&gt;In that case, the first one&#39;s on the house. Anything in particular you like? Or shall I surprise you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;bert&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="154" name="Scene02_ReturnToParlor" tags="" position="75,775" size="100,100">&lt;&lt;bg &quot;parloroverview&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

The familiar blend of perfume, wine, and something unplaceably warm hits you again as you step back into the middle of the parlor. The scent doesn&#39;t surprise you this time—it, but welcomes you, like returning to a book left open mid-page.

The hush still lingers, that velvety quiet filled with murmured voices and the occasional laugh from unseen corners. Somewhere above, the faint rhythm of movement—floorboards creaking in time with breath—reminds you that pleasure here takes many forms, not all of them spoken.

Low golden light from the crystal sconces bathes the space in its usual amber glow. The shadows aren&#39;t as deep now that your eyes have adjusted, but they still seem to hold secrets just out of reach. Plush couches and marble tables remain as inviting as ever, though the cushions now bear the soft impressions of earlier guests. The room doesn&#39;t reset; it evolves.

Behind the bar, the bartender is polishing glassware, his crimson waistcoat catching the light as he leans into a quiet routine. He spares you a glance, but it&#39;s less assessing this time—more like acknowledgment. Recognition.

Adda stands where she often does, by the column in the corner, hands folded in front of her. Her posture is poised, but you catch a slight tilt to her head, as if curious what you&#39;ve learned since last you spoke. She offers a brief smile without words. For her, that&#39;s warmth enough.

The blue-tinted, half-demon still sprawls across her chaise, though her eyes narrow slightly when she sees you again. Her tail twitches once, idly, like a cat deciding whether to approach. She watches you longer than before.

The blonde hostest sits off to one side of the Parlor. Her expression is flat and uninviting, but she stills seems like she might be shaken from the confrontation you witnessed in the street.

The male host moves from space to space, quietly and respectfully checking on other guests and hosts. His vest-shirt is still scandalously unbuttoned, his smile is practiced yet warm. When he notices you looking he nods .

From here, you may:
[[Approach the bar.|Scene02_BrothelBar]]
[[Approach the half-demon woman.|Scene02_TalkToExotic]]
[[Approach the male host.|Scene02_TalkToMaleHost]]
[[Approach the blonde hostest.|Scene02_TalkToAngryHost]]
[[Approach Adda, the Brothel Mistress.|Scene02_TalkToAdda]]</tw-passagedata><tw-passagedata pid="155" name="Scene02_TalkToAdda" tags="" position="600,1975" size="100,100">&lt;&lt;bg &quot;Scene02_TalkToAdda&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

Mistress Adda stands with one hand resting lightly on the back of a velvet chair, her other cradling a delicate crystal glass of something deep amber. She is half-illuminated by the glow of a nearby sconce, her dark gown catching the light like polished coal. Her posture is perfect—spine straight, shoulders regal—but there is something soft in her gaze as she watches you approach.

She doesn&#39;t speak at first. Just lets her eyes travel over you with the weight of someone who misses nothing. Then, a faint smirk curls the corner of her mouth.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;You walk like someone who&#39;s trying to appear casual... but hasn&#39;t decided whether to flee or fight.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Maybe I&#39;m still deciding.&lt;&lt;/speech&gt;&gt;

She chuckles—a low, warm sound—and gestures to the seat across from her.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Then sit. Speak. Let&#39;s see if I can help you make up your mind.&lt;&lt;/speech&gt;&gt;

You take a seat, and Adda sits next to you, tucking her knees close to yours. Her posture is personal, but not what you would call intimate. The chair is plush beneath you, the fabric warm from the heat of the room. Adda watches you settle with the ease of someone used to holding court.

&lt;&lt;DialogueTree &quot;adda&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="156" name="Scene02_TalkToAngryHost" tags="" position="725,1975" size="100,100">&lt;&lt;bg &quot;Scene02_TalkToAngryHost&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You approach the blonde girl, who had thrown the horseshoe at the man outside. She turns half a face towards you as you sit on the couch next to her. Her face is soft, but she is obviously annoyed.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you mind if I sit here with you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I suppose you can. I&#39;m not much in the mood to talk.&lt;&lt;/speech&gt;&gt;

You take a seat next to her, your knees pointed away from her, making sure to give her space. She seems to stare at everything in the room but you.

&lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="157" name="Scene02_TalkToExotic" tags="" position="25,900" size="100,100">&lt;&lt;bg &quot;parlorallura&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You drift toward the velvet chaise, where the blue-skinned woman is laying, drawn more by the stillness around it than the woman herself—at first.

Then her eyes find you. Golden, slitted like a cat&#39;s, and too calm for the room they&#39;re in.

She doesn&#39;t rise. She doesn&#39;t need to.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You walk like someone hoping not to be noticed… and yet, here you are.&lt;&lt;/speech&gt;&gt;

Her voice is warm and low, with an accent that paints every vowel like a slow drag of silk. She doesn&#39;t smile, exactly—but her lips curl at the edges, just enough to make you feel seen.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Sorry, I just...&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Ah-ah.&lt;&lt;/speech&gt;&gt; 

She lifts a finger, not to silence you, but to taste the moment. Her tail curls idly along the back of the couch.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Let&#39;s not ruin it with apologies. Come. Sit. Lie, if you prefer.&lt;&lt;/speech&gt;&gt;

You hesitate only long enough to feel foolish, then ease onto the edge of the chaise. The cushion dips beneath you, a hush of perfume and velvet rising around your skin.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Mmm. Much better. Now… what name do I have the pleasure of toying with tonight?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Jaylie.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Jaylie.&lt;em&gt; Such a soft name. But there&#39;s something beneath it, I think. Something sharp.&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

She tilts her head and watches you like she&#39;s measuring shadows in candlelight.
&lt;&lt;know &quot;allura&quot;&gt;&gt;
&lt;&lt;speech &quot;allura&quot;&gt;&gt;You may call me Allura. For now.&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;allura&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="158" name="Scene02_TalkToMaleHost" tags="" position="975,1975" size="100,100">&lt;&lt;bg &quot;parlordarian&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You find him standing near one of the larger couches, laughing gently with a pair of guests as he pours wine into their cups. His presence is easy—casual, but not careless. Confident, but never imposing. He thanks them with a soft smile and turns just in time to catch your approach.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Good evening, my lady. Looking for someone to share it with?&lt;&lt;/speech&gt;&gt;

There&#39;s a charm in his voice, but not the kind that smothers. He doesn&#39;t try too hard, just offers the warmth of someone who&#39;s good at reading what people need, and giving only as much as they&#39;re comfortable taking.

You notice his eyes flick briefly toward one of the other hosts in the room, checking in without missing a beat. It&#39;s subtle, but you catch it again later—his gaze always wandering protectively, watching the others like a quiet sentinel.

He turns his attention fully back to you.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Most folks who come in here are either looking to forget… or to feel something. Not always the same thing.&lt;&lt;/speech&gt;&gt;

He says it gently, almost like it&#39;s a well-worn lyric he&#39;s sung a thousand times.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;And which are you?&lt;&lt;/speech&gt;&gt;

He chuckles, brushing one hand through his thick, short-cropped hair. A thin golden bracelet glints on his wrist, a simple, yet beautiful, braided-metal piece. You spot tiny inscriptions etched into the broad clasp, but you can&#39;t quite make them out.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Me? I&#39;m here to make sure no one leaves feeling worse than they came in. Maybe inspire a few songs in peoples&#39; souls.&lt;&lt;/speech&gt;&gt;

He gives a short whistle—just a few notes. It&#39;s simple, a melody that feels nostalgic even if you&#39;ve never heard it before.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You&#39;ve got that look, you know. Like a song I haven&#39;t heard in a long time.&lt;&lt;/speech&gt;&gt;

He freezes slightly, just for a second. His sudden expression draws a chortle from somewhere deep within you. He looks like he didn&#39;t mean to say it out loud. He laughs himself, awkwardly.
&lt;&lt;set $characters[&quot;darian&quot;].known = true&gt;&gt;
&lt;&lt;speech &quot;darian&quot;&gt;&gt;Sorry. That was... cliché. I&#39;m better when I&#39;m not trying so hard. I am Darian by the way.&lt;&lt;/speech&gt;&gt;

You can&#39;t help but smile. There&#39;s something very real about him—beneath the smooth edges and trained elegance, a softness that feels rare in a place like this.

&lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="159" name="Scene02_TheBrothelEntry" tags="" position="75,550" size="100,100">&lt;&lt;bg &quot;Scene02_TheBrothelEntry&quot;&gt;&gt;

You walk up to the steps of the brothel and look up at the dark and heavy door. On either side of it are frosted glass windows which bathe you in a diffused orange glow of the warm fire-light within.  
You walk up the few steps, pull on the handle, open the door and step inside.  

Once inside you see, just ahead of you a narrow staircase adorned with opulent candle-holders ascends to the next floor. To your left the room opens up into a very inviting space filled with plush furniture upholstered in crimson velvet, lined in gold filigree.  

As your boots echo across the floor boards at your entry you hear a familiar voice,  
&lt;&lt;speech &quot;adda&quot;&gt;&gt; I swear if that is you again, Kallot, I will not need the wardens to kill you–&lt;&lt;/speech&gt;&gt;

The madam from before walks around the corner of the wall from an area of the main room which you couldn&#39;t see before. Her scowl melts the moment she sees it&#39;s you — not Kallot. You assume that must be the name of the man outside.  
&lt;&lt;set $characters[&quot;kallot&quot;].known = true&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt; Oh, I&#39;m sorry my dear. You must forgive me, I thought you were that lecherous roach out on the pavement again. Please! Come inside, allow me to remove that soaked cloak for you. &lt;&lt;/speech&gt;&gt;

&lt;span id=&quot;brothel-reveal&quot;&gt;She approaches you, heels clicking on the ground, arms outstretched toward your &lt;&lt;link &quot;cloak&quot;&gt;&gt;
  &lt;&lt;replace &quot;#brothel-reveal&quot;&gt;&gt;
    &lt;p&gt;She approaches you, heels clicking on the ground, arms outstretched toward your cloak.
	&lt;p&gt;She unclasps your cloak and draws back your hood, revealing your face and hair. The warmth of the room brushes your cheeks. Her smile softens.&lt;/p&gt;
    &lt;&lt;speech &quot;adda&quot;&gt;&gt; &lt;em&gt;Ahhh.&lt;/em&gt; What have we [[here?|Scene02_AddasGreeting]] &lt;&lt;/speech&gt;&gt;
  &lt;&lt;/replace&gt;&gt;
&lt;&lt;/link&gt;&gt;&lt;/span&gt;</tw-passagedata><tw-passagedata pid="160" name="TheBrothelParlorOverview" tags="" position="75,775" size="100,100">&lt;&lt;bg &quot;parloroverview&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Please, Jaylie. Make yourself comfortable. Drink if you wish. Speak with whoever calls to you. No pressure. No expectations. Just enjoy yourself.&lt;&lt;/speech&gt;&gt;
The scent hits you first — a blend of perfume, wine, and something warmer, deeper. Not quite sweat. Not quite incense. Something in between.

A hush seems to hang over the parlor, but it&#39;s not silent. Muted voices murmur from shadowed corners, glassware clinks against trays, and faintly—almost imperceptibly—soft, rhythmic sounds drift from the rooms above. Moans, maybe. Laughter. The creak of old floorboards under shifting weight.


Low golden light spills from crystal sconces along the walls, casting velvet shadows over the space. The parlor is wide and low-ceilinged, wrapped in plush couches, tufted chairs, and elaborate floor cushions arranged around small marble tables. Deep reds, rich purples, and blacks dominate the palette—each surface layered and inviting, like the room itself is daring you to touch.

The bar runs along the far western wall, its surface an elegant arc of dark mahogany carved with lewd but tasteful reliefs. The bartender, a thin man in a crimson waistcoat and far too many rings, gestures with flair as he pours a glowing amber spirit into a cut-crystal glass. His dark hair is perfectly slicked back. His brown eyes meet yours for only a moment. He sports a stylish, thick, well-groomed mustache which covers most of his mouth in a neat hemispherical shape.

Mistress Adda lingers near a column in the corner of the room, eyes calm but sharp. She speaks to no one now, content to observe, like a spider sitting comfortably at the center of her web. You see her eyes dart from one side of the room to another, perhaps making sure everyone is behaving. You get an occasional momentary glance mixed with a warm smile, before she returns to the rest of the Parlor with her scanning eyes.

To your right, a woman leans lazily across a velvet chaise—half-demon by the look of her. Midnight skin, speckled with tiny bright blue bioluminescent marks as if she was wearing the night sky itself on her skin. She has curling horns, and golden eyes that catch the light even when she&#39;s still. Her tail flicks lazily behind her as she watches you, smiling with the kind of hunger that doesn&#39;t belong to mortals. When your eyes meet her you can&#39;t help but feel your heart speed in your chest.

A soft scoff draws your attention as another figure steps back into the room—Marie. Her blouse has been hastily repaired, though the fabric still strains where the tear once split open. Her hair is neat save for a few strands gone astray, but her scowl is sharp. Adda&#39;s eyes meet hers as she enters. A silent exchange passes between them, and Marie&#39;s expression softens—if only slightly. She crosses the floor quickly, heels clicking like punctuation marks, seemingly avoiding anyone&#39;s gaze including your own.

From behind one of the larger couches, a male host appears—dark skinned, broad-shouldered, clean-shaven, with a silk shirt left scandalously half-unbuttoned. He flashes you a smile, the kind that&#39;s too practiced to be genuine, with teeth whiter than a pearls, before he returns to a quiet conversation with a pair of guests lounging nearby.


From here, you may:
[[Approach Adda again and speak with her.|Scene02_TalkToAdda]]
[[Approach the bar and request a drink.|Scene02_BrothelBar]]
[[Speak to the exotic blue-skinned woman.|Scene02_TalkToExotic]]
[[Strike up a conversation with the male host.|Scene02_TalkToMaleHost]]
[[Follow the upset host and try to speak with her.|Scene02_TalkToAngryHost]]</tw-passagedata><tw-passagedata pid="161" name="Adda_PostSexPhase1" tags="" position="100,2100" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Adda_PostSexPhase1&quot;&gt;&gt;

Adda rises before you&#39;ve even shifted. She moves with quiet finality, gathering her dark blue dress from its heap on the floor and pulling it up her body and onto her arms. The silky material falls against her skin like it never left.

You sit up slowly as she crosses to a low shelf tucked behind the bar. A ceramic teapot waits—still warm, still full. She pours a single cup, adds a measured spoon of honey, stirs without looking.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Apologies if you were hoping to linger, but I have a business to run. Cuddling doesn&#39;t keep the lights on.&lt;&lt;/speech&gt;&gt;

She says it without cruelty. Just truth. You watch the steam rise from her cup as she takes a sip and exhales—quiet, focused. Already in the next moment.

You begin to dress. She doesn&#39;t rush you, but she doesn&#39;t slow down either. The calm between you isn&#39;t intimate—it&#39;s professional. Familiar. Like two performers striking the final pose before the curtain falls.

When you&#39;re both ready, she moves to the inner door leading back to the parlor and opens it with a practiced flick of the wrist.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Come. Let&#39;s not make the others wonder if I&#39;ve decided to retire on a whim.&lt;&lt;/speech&gt;&gt;

You follow her through the velvet curtain. The parlor is quieter now, low laughter and murmured voices brushing the candlelit air. She walks with purpose, already surveying the room, reading it like a ledger.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You really do see everything that happens here, don&#39;t you?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I have to. This house only works because someone&#39;s watching when the rest of the world blinks.&lt;&lt;/speech&gt;&gt;

You&#39;re halfway across the floor when it happens.

Light. So bright it swallows everything—color, shape, thought. The room vanishes in a white roar. And then—

Sound. A thunderclap so close it doesn&#39;t crack—it detonates.

Glass behind the bar bursts. The floor lurches. Every guest in the room freezes.

Adda&#39;s head snaps toward the front curtain, her voice suddenly all business.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;That wasn&#39;t distant. Move.&lt;&lt;/speech&gt;&gt;

You push forward with her, the curtain parting beneath your hands. At the brothel&#39;s entrance, the door rattles against its frame.

Through the windows, down the street—

A flicker of orange.

It grows. It dances.

It burns.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[...Fire.|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="162" name="Adda_PrivateScene" tags="" position="225,2100" size="100,100">&lt;&lt;bg &quot;Adda_PrivateScene&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

The door to her private chamber closes with a decisive click behind you. The sound echoes in the stillness like a judgment passed. No music, no muffled laughter from the floor below—just the rich silence of a room that doesn&#39;t often welcome guests.

Adda moves without hurry, shedding her outer shawl and draping it over a chaise as though undressing were a form of punctuation. Everything about the space feels deliberate. The scent of saffron and roses lingers in the warm air, catching in your throat.

She doesn&#39;t look at you right away. Instead, she adjusts a lamp on the wall, softening the light until it pools golden across the silk-covered bed.

Then she turns. And that gaze of hers—steady, dark, faintly amused—lands on you like a touch.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;I&#39;m not sure that you recognize quite how rare it is for someone to be standing here in the position you are in, young Lady. I have not taken anyone back here in quite some time.&lt;&lt;/speech&gt;&gt;

Her voice is velvet wrapped around something sharper. It&#39;s not a question. It&#39;s a reminder.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;So. Shall I reward your diligence... or teach you what it *really* means to please a mistress?&lt;&lt;/speech&gt;&gt;

She steps closer, slowly—never hurrying, never uncertain. One hand reaches out, gliding up your arm, fingertips dragging softly toward your neck. A test, maybe. Or a promise.

&lt;&lt;speech &quot;adda&quot;&gt;&gt;Strip, darling. Slowly. I want to see if you can follow orders... before I give the ones that matter.&lt;&lt;/speech&gt;&gt;

&lt;&lt;StartSexScene &quot;adda&quot;&gt;&gt;
&lt;&lt;EndSexScene &quot;Adda_PostSexPhase1&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="163" name="Allura_GoingUpstairs" tags="" position="350,2100" size="100,100">&lt;&lt;bg &quot;Allura_GoingUpstairs&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;
&lt;p&gt;You follow her through the parlor, back towards the entrance, and through the heavy velvet curtain. She leads you all the way to the stairs by one hand. As you get to the bottom of the stairs lightning cracks, and thunder bellows. The entryway is illuminated in flashing light for a moment and the foundation shakes be beneath your feet. Allura pauses on the second step; she pivots, facing the glass door.&lt;/p&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Certainly, I hope this storm breaks before morning. Would be a shame for it to ruin the fair.&lt;&lt;/speech&gt;&gt;

She turns on her heels once more and climbs the rest of the stairs holding her skirt in her hands as to not step on it. You follow behind her closely.

At the top of the stairs you enter a long, narrow hallway lined with ten or so doors, each — you assume — belonging to a different host. Allura stops at the second door on the left. She leans against the door frame, turns and looks at you.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Welcome to my humble abode, Mon trésor.&lt;&lt;/speech&gt;&gt;

She reaches down and turns the handle to the door, pushing it open and gesturing with her arm for you to [[step inside.|Allura_UpstairsPhase1]]</tw-passagedata><tw-passagedata pid="164" name="Allura_JustLay_Route" tags="" position="475,2100" size="100,100">&lt;&lt;set $currentPhase = &quot;None&quot;&gt;&gt;&lt;&lt;bg &quot;Allura_JustLay_Route&quot;&gt;&gt;
&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;div id=&quot;montage&quot;&gt;
	&lt;p&gt;You settle in beside her, head finding a soft spot in the sea of cushions. Allura doesn&#39;t pull you close—she lets you come to her at your own pace. But her presence is magnetic, and soon your shoulders touch. Her tail coils near your leg, not quite brushing it.&lt;/p&gt;

	&lt;p&gt;One of her hands finds your hair. She brushes it back, slow and rhythmic, untangling knots that weren&#39;t really there. You close your eyes to the sound of her gentle breathing and the soft hiss of rain outside the window.&lt;/p&gt;
&lt;/div&gt;

&lt;span id=&quot;montage-link&quot;&gt;
	&lt;&lt;link &quot;Some time passes.&quot;&gt;&gt;
		&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
			&lt;&lt;append &quot;#montage&quot;&gt;&gt;
				&lt;div class=&quot;montage-fade fade-start&quot;&gt;
					&lt;p&gt;The lamp light flickers as a draft slips through the hallway. You shift to your side and feel the cushions dip with her weight as she mirrors you.&lt;/p&gt;
					&lt;&lt;speech &quot;allura&quot;&gt;&gt;You tense when you think too much... It makes your bones feel noisy.&lt;&lt;/speech&gt;&gt;
					&lt;p&gt;You laugh, then stifle it when her fingers slide back up to your neck.&lt;/p&gt;
					&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Ooh... Don&#39;t stop.&lt;&lt;/speech&gt;&gt;
				&lt;/div&gt;
			&lt;&lt;/append&gt;&gt;
			&lt;&lt;SceneFadeInNow&gt;&gt;

			&lt;span id=&quot;montage-link&quot;&gt;
				&lt;&lt;link &quot;More time passes.&quot;&gt;&gt;
					&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
						&lt;&lt;append &quot;#montage&quot;&gt;&gt;
							&lt;div class=&quot;montage-fade fade-start&quot;&gt;
								&lt;p&gt;Allura hums now. A tune you don&#39;t recognize. You&#39;re both facing the ceiling, barely touching.&lt;/p&gt;
								&lt;p&gt;Eventually, she shifts closer and drapes one leg across yours, lazily.&lt;/p&gt;
								&lt;&lt;speech &quot;allura&quot;&gt;&gt;Still breathing?&lt;&lt;/speech&gt;&gt;
								&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Best hour of my life.&lt;&lt;/speech&gt;&gt;
								&lt;p&gt;You reply without thinking. She smiles at that. Not the coy one. The real one.&lt;/p&gt;
							&lt;/div&gt;
						&lt;&lt;/append&gt;&gt;
						&lt;&lt;SceneFadeInNow&gt;&gt;

						&lt;span id=&quot;montage-link&quot;&gt;
							&lt;&lt;link &quot;Even more time passes.&quot;&gt;&gt;
								&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
									&lt;&lt;append &quot;#montage&quot;&gt;&gt;
										&lt;div class=&quot;montage-fade fade-start&quot;&gt;
											&lt;p&gt;You don&#39;t remember who moved first, but at some point, you&#39;re tucked against her completely.&lt;/p&gt;
											&lt;p&gt;“You know,” she says, voice quiet and rich, “you&#39;re dangerous in your own way. You&#39;re kind.”&lt;/p&gt;
											&lt;p&gt;You want to say something clever. Instead, you nuzzle her collarbone and say, “Then let me be dangerous a little longer.”&lt;/p&gt;
										&lt;/div&gt;&lt;&lt;/append&gt;&gt;&lt;&lt;SceneFadeInNow&gt;&gt;&lt;&lt;timed 5s&gt;&gt;
										&lt;&lt;replace &quot;#finalLink&quot;&gt;&gt;
											&lt;p&gt;&lt;a id=&quot;finalLink&quot; class=&quot;fade-slow&quot; href=&quot;EverythinggoeswhiteLightningStrikeScene&quot;&gt;Suddenly—&lt;/a&gt;&lt;/p&gt;
										&lt;&lt;/replace&gt;&gt;
									&lt;&lt;/timed&gt;&gt;
								&lt;&lt;/replace&gt;&gt;
							&lt;&lt;/link&gt;&gt;
						&lt;/span&gt;
					&lt;&lt;/replace&gt;&gt;
				&lt;&lt;/link&gt;&gt;
			&lt;/span&gt;
		&lt;&lt;/replace&gt;&gt;
	&lt;&lt;/link&gt;&gt;
&lt;/span&gt;

&lt;div id=&quot;finalLink&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="165" name="Allura_PostSexPhase1" tags="" position="600,2100" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Allura_PostSexPhase1&quot;&gt;&gt;

Allura lounges beside you like a goddess painted into silk—one leg draped over yours, her skin glowing with the heat of what just passed. She doesn&#39;t speak right away. She just exists there beside you—smug, sensual, and devastatingly at ease.

She stretches slowly, arms above her head, the fabric of her robe slipping from one shoulder.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Mmm. Mon trésor...&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

Her voice curls around the words like incense.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;You are full of surprises. I thought I had you mapped by now—but then you go and do &lt;em&gt;that&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

You raise an eyebrow. She smirks.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;That was you thinking you had me figured out?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Of course. I always think that. Until someone proves me wrong. Which you did—deliciously.&lt;&lt;/speech&gt;&gt;

She rolls onto her side, propping her head on one hand, and drags a single nail lightly down your chest.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Tell me… was it always in you? That hunger? That nerve? Or did I bring it out of you?&lt;&lt;/speech&gt;&gt;

You open your mouth to respond—

And then the world ends.

A blinding flash detonates against the window, bathing the room in pure white. There&#39;s no delay. No pause.

The thunderclap that follows is instant and violent, like the sky itself has been torn open above you. The bed trembles beneath you. The perfume in the air turns sharp. You can taste the charge on your tongue.

Allura bolts upright—fluid, alert. Her playfulness gone in an instant.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;&lt;em&gt;Putain de merde—&lt;/em&gt; that was &lt;strong&gt;close.&lt;/strong&gt;&lt;&lt;/speech&gt;&gt;

She moves to the window without waiting, yanking the curtain back. Her eyes narrow.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;There. Down the street.&lt;&lt;/speech&gt;&gt;

You move beside her following her gaze.

An orange glow is climbing the darkness—faint, flickering... spreading.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[...Fire.|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="166" name="Allura_UpstairsPhase1" tags="" position="725,2100" size="100,100">&lt;&lt;bg &quot;Allura_UpstairsPhase1&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You aren&#39;t entirely sure what you expected, but her room surprises you in more ways than one.

It&#39;s dimly lit — not from lack of light, but from choice. A cluster of colored glass lanterns hang in the far corner, casting hues of deep amethyst, rose, and sea-green across the velvet drapes that hang like soft walls over real ones. The air smells faintly of sandalwood and something sweeter, darker — like black cherries left to soak in wine.

The space is smaller than you&#39;d imagined. Intimate. A circular bed rests low to the floor, draped in sheer curtains and piled with cushions in every shade of desire. There&#39;s no vanity, no mirror. No trace of a mask waiting to be put back on. Just an old record player humming gently in the corner with no record turning.

Allura doesn&#39;t close the door behind you right away. She steps past you, brushing your shoulder with hers as she enters, letting her fingers linger on your arm. Her voice loses some of its playful cadence as she speaks next.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;Most people don&#39;t make it this far without trying to impress me, or undress me. You seem to want neither. Or maybe both. Perhaps you have not decided yet, either.&lt;&lt;/speech&gt;&gt;

She turns to face you again, her hands resting on her hips, her silhouette framed by the soft light behind her.

&lt;&lt;speech &quot;allura&quot;&gt;&gt;So... what shall we do with this quiet?&lt;&lt;/speech&gt;&gt;

You turn and close the door, the bolt clicks into place and now the two of you feel truly alone. When you&#39;ve turned back around Allura is laid back on the mattress, her arms reached above her head. She is calm. She is vulnerable. You can&#39;t help but feel like she truly wants to be in here with you.

&lt;&lt;DialogueTree &quot;allura&quot; &quot;Phase1&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="167" name="Darian_GoingUpstairs" tags="" position="850,2100" size="100,100">&lt;&lt;bg &quot;Darian_GoingUpstairs&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

You follow him out of the parlor and through the heavy velvet-curtained hall, past the lingering music and soft laughter of the parlor. He guides you by the hand the whole way— a proper gentleman&#39;s escort.

As you reach the foot of the stairs, thunder rolls distantly outside. Darian glances toward the door but says nothing. He simply smiles and starts up the steps, his boots light on the old wood.

The hallway above is quiet, lined with rooms like small forgotten stories. Some doors are closed. A few are cracked just enough to spill warm light into the hall.

He leads you to the very end—furthest from everything else—and pauses at a door with a subtle, worn plaque. Not a number. A name.

The brass is dulled with age, but you can make out the engraving: *Avelen*.

He catches your glance.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Stage name. From another life. I like to keep it there for nostalgia now.&lt;&lt;/speech&gt;&gt;

He opens the door without ceremony, stepping aside to let you enter first.

[[You step into his room.|Darian_UpstairsPhase1]]</tw-passagedata><tw-passagedata pid="168" name="Darian_MusicMontage" tags="" position="975,2100" size="100,100">&lt;&lt;bg &quot;DarianMusicMontage&quot;&gt;&gt;
&lt;&lt;set $currentPhase = &quot;None&quot;&gt;&gt;
&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;div id=&quot;montage&quot;&gt;
	&lt;p&gt;Darian crosses the room and brushes the dust cover off a dark upright piano tucked into a curtained alcove. It looks worn but carefully maintained—like it&#39;s been waiting, not forgotten. He runs a hand across the keys once without pressing them, then sits.&lt;/p&gt;

	&lt;p&gt;He doesn&#39;t look at you right away. He just closes his eyes and breathes in. Then his fingers begin to move.&lt;/p&gt;
&lt;/div&gt;

&lt;span id=&quot;montage-link&quot;&gt;
	&lt;&lt;link &quot;Some time passes.&quot;&gt;&gt;
		&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
			&lt;&lt;append &quot;#montage&quot;&gt;&gt;
				&lt;div class=&quot;montage-fade fade-start&quot;&gt;
					&lt;p&gt;At first, it&#39;s only piano. A slow, minor melody that unfolds like candlelight—soft and flickering. The chords are melancholy but not sad. Reflective. Like something that remembers joy without claiming it.&lt;/p&gt;

					&lt;p&gt;You close your eyes. The curtains absorb every echo. This isn&#39;t a performance. It&#39;s a confession.&lt;/p&gt;
				&lt;/div&gt;
			&lt;&lt;/append&gt;&gt;
			&lt;&lt;SceneFadeInNow&gt;&gt;

			&lt;span id=&quot;montage-link&quot;&gt;
				&lt;&lt;link &quot;More time passes.&quot;&gt;&gt;
					&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
						&lt;&lt;append &quot;#montage&quot;&gt;&gt;
							&lt;div class=&quot;montage-fade fade-start&quot;&gt;
								&lt;p&gt;Then he begins to sing.&lt;/p&gt;

								&lt;blockquote&gt;
								&lt;i&gt;“In halls of glass and violet dusk,&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;I wandered once, and dared to trust.&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;The silence watched, the shadows stayed—&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;and yet I sang, though light decayed.”&lt;/i&gt;&lt;br&gt;&lt;br&gt;

								&lt;i&gt;“My sister&#39;s laugh, my mother&#39;s grace,&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;the echo lost in every place.&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;I sing not now to be adored—&lt;/i&gt;&lt;br&gt;
								&lt;i&gt;I sing for ghosts I can&#39;t afford.”&lt;/i&gt;
								&lt;/blockquote&gt;

								&lt;p&gt;His voice is soft, low, haunting. Every note feels chosen. Earned. You don&#39;t move. You don&#39;t breathe too loudly. You just &lt;em&gt;listen&lt;/em&gt;.&lt;/p&gt;
							&lt;/div&gt;
						&lt;&lt;/append&gt;&gt;
						&lt;&lt;SceneFadeInNow&gt;&gt;

						&lt;span id=&quot;montage-link&quot;&gt;
							&lt;&lt;link &quot;Even more time passes.&quot;&gt;&gt;
								&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
									&lt;&lt;append &quot;#montage&quot;&gt;&gt;
										&lt;div class=&quot;montage-fade fade-start&quot;&gt;
											&lt;p&gt;The final note fades into silence. Darian lets his hands fall away from the keys slowly, like he&#39;s afraid the stillness will shatter if he moves too quickly.&lt;/p&gt;

											&lt;p&gt;He looks at you—really looks at you. There&#39;s no performer left in him. Just a man who let go of something heavy and wants to know if it landed softly.&lt;/p&gt;

											&lt;&lt;speech &quot;darian&quot;&gt;&gt;That song&#39;s never had an audience before.&lt;&lt;/speech&gt;&gt;

											&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You should give it more often. If not to them... then to yourself.&lt;&lt;/speech&gt;&gt;

											&lt;p&gt;He smiles, small but warm. His hand lingers near yours, not touching. Just close enough that you feel it.&lt;/p&gt;
										&lt;/div&gt;
									&lt;&lt;/append&gt;&gt;
									&lt;&lt;SceneFadeInNow&gt;&gt;

									&lt;&lt;timed 5s&gt;&gt;
										&lt;&lt;replace &quot;#finalLink&quot;&gt;&gt;
											&lt;p&gt;&lt;a id=&quot;finalLink&quot; class=&quot;fade-slow&quot; href=&quot;EverythinggoeswhiteLightningStrikeScene&quot;&gt;Suddenly—&lt;/a&gt;&lt;/p&gt;
										&lt;&lt;/replace&gt;&gt;
									&lt;&lt;/timed&gt;&gt;
								&lt;&lt;/replace&gt;&gt;
							&lt;&lt;/link&gt;&gt;
						&lt;/span&gt;
					&lt;&lt;/replace&gt;&gt;
				&lt;&lt;/link&gt;&gt;
			&lt;/span&gt;
		&lt;&lt;/replace&gt;&gt;
	&lt;&lt;/link&gt;&gt;
&lt;/span&gt;

&lt;div id=&quot;finalLink&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="169" name="Darian_PostSexPhase1" tags="" position="1100,2100" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Darian_PostSexPhase1&quot;&gt;&gt;

Darian lies beside you, one arm behind his head, the other tracing slow, absent lines along your upper arm. His skin is cool, covered in a sweet sheen of sweat. You feel the rise and fall of his breath as it slowly steadies.

For a while, he just gazes up at the ceiling, silent. When he finally speaks, his voice is soft—mellowed by the moment.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You know… I used to think there was nothing sweeter than holding a final note and hearing a crowd hold its breath.&lt;&lt;/speech&gt;&gt;

He glances toward you, lips curling into a faint, crooked smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;That… might be the first thing to ever compete.&lt;&lt;/speech&gt;&gt;

You smack his arm with a grin, laughing.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Gods! How do you still have lame pickup lines &lt;em&gt;after&lt;/em&gt;?&lt;&lt;/speech&gt;&gt;

He rolls onto his side, brushing a knuckle along your collarbone—light as a sigh.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;You&#39;re right, that was terrible.&lt;&lt;/speech&gt;&gt;

Your lips curl into a devilish smile as you lean in.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh, so I was that bad, then?&lt;&lt;/speech&gt;&gt;

His face flushes. The smile falters. He stammers an awkward apology. You burst out laughing as he bows his head in exaggerated defeat.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Please, have mercy on me, woman. You do something to me—I lose my edge.&lt;&lt;/speech&gt;&gt;

You&#39;re just about to reply when the world erupts.

A flash of white fills the room—brilliant, blinding, immediate. No delay. The explosion that follows shakes the walls and rattles the floor beneath you.

You feel it in your bones. The hair on your body stands on end. There&#39;s a sharp taste of metal on your tongue.

As the light fades, you blink rapidly, trying to clear your vision. You cross to the window, searching the street outside for answers.

Just down the road, a faint orange glow flickers.

At first, it looks like lamplight.

But then you realize the truth.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[Fire!|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="170" name="Darian_UpstairsPhase1" tags="" position="1225,2100" size="100,100">&lt;&lt;bg &quot;Darian_UpstairsPhase1&quot;&gt;&gt;&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You step inside, and the first thing you notice is the quiet.

Not the absence of sound—but a kind of intentional stillness, like the room was waiting for you. The lighting is soft, coming from an old floor lamp with a tasseled shade that throws golden light across the space. No garish colors. No scent of perfume or smoke. Just wood polish, old books, and something faintly herbal.

The furniture is modest and well kept—an upright piano stands against one wall, its top dusted and adorned with a single framed photo turned inward. Beside it, a stack of music books, some well-worn, some pristine. One still bears a theater stamp from another city. Another life.

A velvet armchair sits near the bed, and atop it lies a folded overcoat and a small, flat tin. You recognize it immediately for what it is: a vocal tin, used by singers to keep their throat warm and clear.

There&#39;s no mirror. No vanity. But on the wall above the bed hangs a tapestry—simple, woven, depicting a great lake beneath a starry sky. No name, no inscription. Just still water and distant light.

Darian closes the door behind you gently.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;It&#39;s not much, but it&#39;s mine. What I&#39;ve held onto. What I&#39;ve let go.&lt;&lt;/speech&gt;&gt;

He steps past you and gestures to the bed with a soft smile.

&lt;&lt;speech &quot;darian&quot;&gt;&gt;Make yourself comfortable. You&#39;re safe here.&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase1&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="171" name="Marie_JustLay_Route" tags="" position="100,2225" size="100,100">&lt;&lt;set $currentPhase = &quot;None&quot;&gt;&gt;&lt;&lt;bg &quot;Marie_JustLay_Route&quot;&gt;&gt;
&lt;&lt;EndDialogueLayout&gt;&gt;

&lt;div id=&quot;montage&quot;&gt;
	&lt;p&gt;You lie on your side, facing her. Marie&#39;s hair spills over her pillow in soft, tangled waves. She watches you—not intensely, but openly, like she&#39;s studying something she never thought she&#39;d have a chance to.&lt;/p&gt;

	&lt;p&gt;You both say nothing for a while. Her fingertips trail small patterns on the quilt between you.&lt;/p&gt;
&lt;/div&gt;

&lt;span id=&quot;montage-link&quot;&gt;
	&lt;&lt;link &quot;Some time passes.&quot;&gt;&gt;
		&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
			&lt;&lt;append &quot;#montage&quot;&gt;&gt;
				&lt;div class=&quot;montage-fade fade-start&quot;&gt;
					&lt;p&gt;The rain outside ticks against the window like a soft metronome. Marie shifts closer, not quite touching you. Her voice is quiet when it comes.&lt;/p&gt;

					&lt;&lt;speech &quot;marie&quot;&gt;&gt;Do you ever think about how different your life might&#39;ve been... if you&#39;d just taken one wrong turn and never noticed?&lt;&lt;/speech&gt;&gt;

					&lt;p&gt;You hum in reply. She smiles faintly and lets it drop.&lt;/p&gt;
				&lt;/div&gt;
			&lt;&lt;/append&gt;&gt;
			&lt;&lt;SceneFadeInNow&gt;&gt;

			&lt;span id=&quot;montage-link&quot;&gt;
				&lt;&lt;link &quot;More time passes.&quot;&gt;&gt;
					&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
						&lt;&lt;append &quot;#montage&quot;&gt;&gt;
							&lt;div class=&quot;montage-fade fade-start&quot;&gt;
								&lt;p&gt;You&#39;re both lying on your backs now, staring at the ceiling. Marie lifts one hand and slowly traces constellations you can&#39;t see in the wooden grain above.&lt;/p&gt;

								&lt;&lt;speech &quot;marie&quot;&gt;&gt;They say in Medmarr there&#39;s a lake so deep, it reflects the stars even at noon.&lt;&lt;/speech&gt;&gt;

								&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Have you seen it?&lt;&lt;/speech&gt;&gt;

								&lt;&lt;speech &quot;marie&quot;&gt;&gt;No. But I want to. And I&#39;d rather not go alone.&lt;&lt;/speech&gt;&gt;
							&lt;/div&gt;
						&lt;&lt;/append&gt;&gt;
						&lt;&lt;SceneFadeInNow&gt;&gt;

						&lt;span id=&quot;montage-link&quot;&gt;
							&lt;&lt;link &quot;Even more time passes.&quot;&gt;&gt;
								&lt;&lt;replace &quot;#montage-link&quot;&gt;&gt;
									&lt;&lt;append &quot;#montage&quot;&gt;&gt;
										&lt;div class=&quot;montage-fade fade-start&quot;&gt;
											&lt;p&gt;At some point, your head finds her shoulder, and her hand settles just above your hip. Neither of you say anything for a long time.&lt;/p&gt;

											&lt;p&gt;Then softly—so softly you almost miss it—she murmurs:&lt;/p&gt;

											&lt;&lt;speech &quot;marie&quot;&gt;&gt;Stay a little longer. Just until the rain stops.&lt;&lt;/speech&gt;&gt;
										&lt;/div&gt;
									&lt;&lt;/append&gt;&gt;
									&lt;&lt;SceneFadeInNow&gt;&gt;&lt;&lt;timed 5s&gt;&gt;&lt;&lt;replace &quot;#finalLink&quot;&gt;&gt;&lt;p&gt;&lt;a id=&quot;finalLink&quot; class=&quot;fade-slow&quot; href=&quot;EverythinggoeswhiteLightningStrikeScene&quot;&gt;Suddenly—&lt;/a&gt;&lt;/p&gt;
									&lt;&lt;/replace&gt;&gt;
									&lt;&lt;/timed&gt;&gt;
								&lt;&lt;/replace&gt;&gt;
							&lt;&lt;/link&gt;&gt;
						&lt;/span&gt;
					&lt;&lt;/replace&gt;&gt;
				&lt;&lt;/link&gt;&gt;
			&lt;/span&gt;
		&lt;&lt;/replace&gt;&gt;
	&lt;&lt;/link&gt;&gt;
&lt;/span&gt;

&lt;div id=&quot;finalLink&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="172" name="Marie_PostSexPhase1" tags="" position="225,2225" size="100,100">&lt;&lt;EndSexSceneLayout&gt;&gt;&lt;&lt;bg &quot;Marie_PostSexPhase1&quot;&gt;&gt;

Marie lies with her back to you, the candlelight tracing gentle edges across her curves. The bedsheets cling to her hips, one leg stretched long, the other bent in close. She&#39;s quiet. Not withdrawn—just still, like she&#39;s waiting to remember how to breathe.

You reach out, grazing your fingertips down her arm. She doesn&#39;t flinch. Doesn&#39;t speak. Not until a long breath slips out of her nose.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I—&lt;&lt;/speech&gt;&gt;

She looks at you with something between a frown and confusion.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What is it?&lt;&lt;/speech&gt;&gt;

She tries again.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;I just don&#39;t know how you did that. You came in here looking innocent as a mouse, disarmed me right in the middle of feeling like an angry feral Noctail and got me to do all of that.&lt;&lt;/speech&gt;&gt;

You can&#39;t help but chuckle a little, an act which almost seems to annoy and confuse Marie even more. She looks at you with her brilliant emerald eyes, waiting for an answer.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;If it makes you feel any better, that was not at all the way I expected tonight to go either.&lt;&lt;/speech&gt;&gt;

She finally relents. She smiles.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Thank you for not letting my entire night be awful. It was really nice that you came along. Maybe next time I can learn a thing or two about you instead of you letting me talk about my problems the whole time.&lt;&lt;/speech&gt;&gt;

You nod against the silence. No quip. No follow-up. Just listening.

She shifts slightly, rolling enough that her shoulder brushes yours. A pause. Then a sigh—softer now.

Then it happens.

A blinding flash. Light so white it devours the room, your sight, your sense of space. There&#39;s no time to react before the sound comes—a thunderclap so immediate and powerful it feels like a war drum in your ribs.

Marie is up in an instant. No panic—just motion. A practiced readiness. Her eyes sharpen.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Gods, what the hell?&lt;&lt;/speech&gt;&gt;

You&#39;re already pulling yourself up, heartbeat tripping over itself.

You cross to the window and draw the curtain back. Down the street, an orange glow is licking upward into the night.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[...Fire.|Universal_FireEvent_Start]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="173" name="Marie_UpstairsPhase1" tags="" position="350,2225" size="100,100">&lt;&lt;bg &quot;Marie_UpstairsPhase1&quot;&gt;&gt;&lt;&lt;EndDialogueLayout&gt;&gt;

You follow Marie through the parlor without a word. She doesn&#39;t take your hand to lead you, but does not go too far in front of you either. She consistently glances over her shoulder to maintain her distance to you. 

She parts the velvet curtain with one hand and steps into the entry hall. A rumble of thunder rolls through the foundation just as you reach the staircase. Marie pauses at the bottom, her gaze fixed on the door, though she does not comment.

She ascends slowly, as if she is trying to make sure of her own balance with each step, her heels soft against the wood. You trail behind her up a narrow staircase, then down a hallway lined with numbered doors. Faint murmurs echo behind some of them. Laughter behind others.

Marie stops at the third door on the left, near the end. It is decorated with simple red jewels, similar in color to the broach she wears. She hesitates—not dramatically, just enough for you to notice—then opens the door and motions gracefully with one hand for you to step inside first.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;This one&#39;s me.&lt;&lt;/speech&gt;&gt;

[[You approached the doorway and take a step inside.|Marie_UpstairsPhase2]]</tw-passagedata><tw-passagedata pid="174" name="Marie_UpstairsPhase2" tags="" position="475,2225" size="100,100">&lt;&lt;bg &quot;Marie_UpstairsPhase2&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;

You aren&#39;t sure what you expected from Marie&#39;s room, but this… this is surprising.

It&#39;s small, and intimate, but thoughtfully arranged. A single bookshelf stands beside the bed, filled with a modest but curated collection—titles on history, philosophy, poetry, even a few old plays. A soft wool shawl hangs from a hook near the door. The bed is neat, tucked with military precision, save for a few deliberate comforts: an embroidered pillow with frayed edges, a stitched quilt that looks older than the rest of the room&#39;s furnishings.

There are no mirrors. But pinned beside the shelf, a few charcoal sketches are tacked to the wall—faces, flowers, a narrow field beneath a moon. All done by hand. All precise.

Marie closes the door behind you, then quietly turns the lock. The sound is subtle, not ominous. More… final. As though she&#39;s sealing the room off from the noise outside.

She walks past you and sits on the edge of the bed, smoothing the blanket before shifting back to rest against the wall. Then, glancing to the side, she pats the space beside her without a word.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;Come sit with me, Jaylie.&lt;&lt;/speech&gt;&gt;

You move to sit beside her. The bed dips gently beneath your weight, but Marie doesn&#39;t shift away. She just pulls her knees up and lets her shoulder brush lightly against yours. As you rest a hard shape pokes your butt. You stand up again to look at what you sat on and Marie reaches beneath the pillow and pulls out a book– &lt;em&gt;Avian Varieties of Medmarr&lt;/em&gt;.
&lt;&lt;speech &quot;marie&quot;&gt;&gt;Oh sorry about that, I was reading this early this morning and must have forgotten to put it back on the shelf. You mind?&lt;&lt;/speech&gt;&gt;

You are closer to the bookshelf so she hands it to you. You take it in your hands and the pages of the book naturally fall open to a page about the &lt;em&gt;Suma&lt;/em&gt; an apparent waterfowl native to the Myridin Lake. The book has a colorised depiction of the creature, perched in the shallows on long, stalky legs, and sporting a vibrant, colorful arrangement of pointed feathers. It&#39;s eyes are intelligent and thoughtful, as if the artist asked the bird to pose and so it had purposely complied. On the opposite page is a half done charcoal recreation of the same bird. Marie&#39;s work.

You look at her and smile before you close the book, turn and place it neatly next to the other&#39;s on the shelf.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You&#39;re quite the artist.&lt;&lt;/speech&gt;&gt;

She smiles and scoffs; you see blush forming in her cheeks.

&lt;&lt;speech &quot;marie&quot;&gt;&gt;An artist? No. They are just doodles... But anyway... now that we&#39;re alone... what kind of guest are you planning to be?&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;marie&quot; &quot;Phase2&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="175" name="Scene01_2a_TheBrothelFront" tags="" position="75,350" size="100,100">&lt;&lt;bg &quot;Scene01_2a_TheBrothelFront&quot;&gt;&gt;
&lt;&lt;speech &quot;adda&quot;&gt;&gt;	
&quot;You &lt;em&gt;lowlife bastard&lt;/em&gt;! Show your face here again I will have you killed, you worm. Trust me every other establishment in the city will hear of you too. You&#39;re lucky I don&#39;t have you lashed in the square.&quot;
&lt;&lt;/speech&gt;&gt;
	
	The man begins to pull up his pants while he states his case.

&lt;&lt;speech &quot;kallot&quot;&gt;&gt;	
&quot;Oooh come *hic* onnn. I &#39;ardly even touched the bitch!&quot;
&lt;&lt;/speech&gt;&gt;
	The apparent &quot;bitch&quot; in question lunged to the front of the group, aggressively shoving the rest to the side. A classically beautiful girl with blonde hair, emerald eyes and rosy cheeks, you noticed immediately the state of disrepair her dress was in, the lacy collar torn down to her midriff exposing her shapely breasts which jiggled with the excitement of her movements. What you didn&#39;t notice immediately was the metallic object which she produced seemingly from nowhere at all. 

	/* Angry Brothel Girl (Marie) .marie #c57e41 */
&lt;&lt;speech &quot;marie&quot;&gt;&gt;
&quot;Bitch, is it? &lt;em&gt;BITCH?!&lt;/em&gt;
&lt;&lt;/speech&gt;&gt;

With astonishing accuracy she launched the projectile, the light of the brothel&#39;s interior glinting off its finish for a fraction of a moment before it collided with the drunken man squarely in the middle of his forehead. The round metal bounced and hit the ground. After what seemed like ages, so too did the man fall, stiff as a board, onto his back. 

&lt;&lt;speech &quot;marie&quot;&gt;&gt;
&quot;Fucking swine.&quot;
&lt;&lt;/speech&gt;&gt;

	
Apparently satisfied with her own work, the girl turns heel, only half covering herself before turning to reenter the establishment, disappearing from view.

	The man in the street does not move again.
 &lt;&lt;set $watchedhsthrow = true&gt;&gt;
/* Referenced if the player still chooses to walk away after seeing marie throw the shoe */

The scene quickly dissipates as the rest of the brothel girls make their way back inside. The brothel&#39;s madam reaches outside, taking hold of the door and with a final scoff and a look down towards the man on the cobblestones, she closes the door. The orange glow on the street nearly disappears.

[[You approach the unconscious man|Scene01_2b_TheBrothelFront]]

[[Forget him. They might have drinks in there.|Scene02_TheBrothelEntry]]

[[That place seems like trouble. I should head to the tavern.|Scene01_2b_ToTheTavern]]</tw-passagedata><tw-passagedata pid="176" name="Scene01_2b_TheBrothelFront" tags="" position="75,450" size="100,100">&lt;&lt;bg &quot;Scene01_2b_TheBrothelFront&quot;&gt;&gt;
Soaking in rain and now shadowed by darkness, you approach the man. Your heels click quietly on the cobblestone as you draw near. Without so much as a crouch you look upon his immobile form, examining him.

	The man is human, that much is obvious. He has dark hair, which in its drenched state mixed with the darkness of the fallen night, you cannot tell if it&#39;s brown or black. He has a rather chiselled look and were it not for the performance you just witnessed from him, you might&#39;ve even considered him attractive.

	A steady stream of blood flows from the fresh wound on his forehead. Its darkness is quickly washed away by thick, heavy raindrops falling freely upon his still form in rhythmic taps. The wound seems superficial enough, but he surely will feel it in the morning. 

	Remembering the metal object that acted as the man&#39;s undoing, you glance around him to see what exactly it was that the woman had thrown.

	After a moment you see it. You bend over at the waist and pick up an &lt;em&gt;unusually&lt;/em&gt; small horseshoe. Suddenly a question dawns on you.

	&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;&lt;em&gt;Where the hell had she pulled this from?&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

&lt;div id=&quot;horseshoe-choice&quot;&gt;
Do you &lt;&lt;link &quot;take it&quot;&gt;&gt;
	&lt;&lt;replace &quot;#horseshoe-choice&quot;&gt;&gt;&lt;span class=&quot;tightblock&quot;&gt;You decide to keep it.&lt;/span&gt;&lt;&lt;/replace&gt;&gt;
	&lt;&lt;append &quot;#horseshoe-result&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	You tuck the horseshoe into your belt.
	&lt;&lt;additem &quot;player&quot; &quot;lucky_horseshoe&quot; 1&gt;&gt;
	&lt;&lt;append &quot;#horseshoe-followup&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	You glance back over at the man and a mix of emotions flow through you.&lt;br&gt;
	[[Maybe you should help him|Scene01_2c_HelpHim]]&lt;br&gt;
	He did get himself into this situation. [[The brothel looks more inviting anyway.|Scene02_TheBrothelEntry]]&lt;br&gt;
	[[I really should get going to the tavern.|Scene01_2b_ToTheTavern]]
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
&lt;&lt;/link&gt;&gt; or &lt;&lt;link &quot;leave it&quot;&gt;&gt;
	&lt;&lt;replace &quot;#horseshoe-choice&quot;&gt;&gt;&lt;span class=&quot;tightblock&quot;&gt;You can&#39;t think of any type of need for the object and half-heartedly toss it back to the ground at your feet. &lt;/span&gt;&lt;&lt;/replace&gt;&gt;
	&lt;&lt;append &quot;#horseshoe-result&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	&lt;&lt;append &quot;#horseshoe-followup&quot;&gt;&gt;&lt;span class=&quot;fadein tightblock&quot;&gt;
	You glance back over at the man and a mix of emotions flow through you.&lt;br&gt;
	[[Maybe you should help him|Scene01_2c_HelpHim]]&lt;br&gt;
	He did get himself into this situation. [[The brothel looks more inviting anyway.|Scene02_TheBrothelEntry]]&lt;br&gt;
	[[I really should get going to the tavern.|Scene01_2b_ToTheTavern]]
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
	&lt;/span&gt;&lt;&lt;/append&gt;&gt;
&lt;&lt;/link&gt;&gt;?
&lt;/div&gt;

&lt;div id=&quot;horseshoe-result&quot;&gt;&lt;/div&gt;
&lt;div id=&quot;horseshoe-followup&quot;&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="177" name="Scene01_2b_ToTheTavern" tags="" position="225,300" size="100,100">&lt;&lt;bg &quot;Scene01_2b_ToTheTavern&quot;&gt;&gt;
&lt;&lt;if $watchedhsthrow&gt;&gt;
&lt;p&gt;Thinking it is better to not insert yourself where it is not your business, you turn away from the commotion and continue down Kings Street towards the [[tavern|Scene01_2c_ToTheTavern]].&lt;/p&gt;
&lt;&lt;else&gt;&gt;
Certainly whatever that is about is none of your business. As you turn your head and keep walking down Kings Street you pull your hood more firmly against the hardening rain. After just a few steps you hear muffled through the rain,
&lt;&lt;speech &quot;marie&quot;&gt;&gt;&lt;span class=&quot;faintvoice&quot;&gt;&quot;Bitch, is it? &lt;em&gt;BITCH?!&lt;/em&gt;&quot;&lt;/span&gt; /*Fog text macro/ roll perception to hear this through the rain while walking away, needs correcting in its current state */&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;&lt;em&gt;[[I would hate to be that guy right now.|Scene01_2c_ToTheTavern]]&lt;/em&gt;&lt;&lt;/speech&gt;&gt;
&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="178" name="Scene01_2c_HelpHim" tags="" position="975,2225" size="100,100">&lt;&lt;bg &quot;Scene01_2c_HelpHim&quot;&gt;&gt;
&lt;&lt;set $helpedkallot = true&gt;&gt;
Falling harder now, the rain continues to pour mercilessly upon the bloodied man. Pools of water mixed with a deep crimson fill the divots of his closed eyes. 

You let out a sigh.
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Can&#39;t leave you here.&lt;&lt;/speech&gt;&gt;

You lean down and grab him by his shirt, pulling him out of his prone position and slowly dragging him from the middle of the street. After a few moments of dragging him towards the alley, you manage to prop the man up against the side of the building, protecting him from the worst of the weather underneath the eaves of the roof. Here at least, you think, he will be slightly protected from the elements.

Once again you examine the wound on his head. It has already begun to swell. In his new sitting position the bleeding, however, seems to have slowed at least a bit. Still you decide it may help to give it some pressure and coverage. You reach into your cloak and produce a ratty handkerchief.

You twirl the cloth into a coiled rope shape and reach over the man&#39;s head, wrapping the coil tightly against his forehead and tying it off at the back of his skull. As you do this, the drunkard for the first time since getting hit begins to move. He looks up at you with sleepy, crossed eyes, and then of all things, smiles. 

&lt;&lt;speech &quot;kallot&quot;&gt;&gt; &quot;You have such lovely *hic* hair. &lt;&lt;/speech&gt;&gt;

His eyes instantly droop again and once more consciousness escapes him. 

You finish your knot and then stand. Without bringing him to an infirmary and ruining your own night, you suppose this is the best you can do. It is certainly more than he probably deserves. 

I really should get going to the [[tavern.|Scene01_2b_ToTheTavern]]
All this dragging men in the rain has the [[brothel|Scene02_TheBrothelEntry]] looking great.</tw-passagedata><tw-passagedata pid="179" name="Scene01_2c_ToTheTavern" tags="" position="475,150" size="100,100">&lt;&lt;bg &quot;Scene01_2c_ToTheTavern&quot;&gt;&gt;
Before long you step beneath the tall, ornately carved stone archway that marks the edge of King&#39;s Market Square, and the world opens wide before you.
The square, paved in a mosaic of dark, glistening cobblestone, stretches out like a dull mirror beneath the gray, cloud-choked sky. Rain pools in the dips between stones, reflecting the warm lantern-light bleeding from shuttered shopfronts and upper-floor windows. The buildings that encircle the square are tall, sturdy things—crafted of dark stone, carved cornices, and slate roofs slick with rain. Their angles stand proud and immovable, like sentinels bearing witness to centuries of trade, betrayal, and proclamation.
But now, in the wake of the sudden Spring storm, the square lies mostly deserted. Only a few figures hurry through the mist, cloaks pulled tight, heads bowed against the water and wind.
And yet one man stands firm in the center of it all.
A ragged canopy—stitched of mismatched fabrics and affixed to a crooked wooden frame—shelters him from the worst of the weather. Beneath it, on a makeshift crate, the man looms like a scarecrow imbued with the powers of a voice. His face is sunken and pale, his eyes wild and rimmed with red, and his hands flail with frantic rhythm as he speaks to no one and everyone.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; “They &lt;em&gt;dream in the roots&lt;/em&gt;, I tell you! The dead—they &lt;em&gt;wait&lt;/em&gt; in the roots! And when the &lt;em&gt;youngest&lt;/em&gt; bleeds her mother&#39;s name, the &lt;em&gt;rain shall never stop&lt;/em&gt;.” &lt;&lt;/speech&gt;&gt;
His voice carries despite the rain, crisp and too-clear. He points at passersby as they scurry past him, damning them one by one with vague gestures and mad proclamations.
You keep your distance as best you can, adjusting your path to give him a wide berth. But his head snaps toward you the moment you step into the open.
His eyes lock with yours.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt;  &lt;em&gt;You.&lt;/em&gt; &lt;em&gt;You.&lt;/em&gt; &lt;&lt;/speech&gt;&gt;
[[You freeze.|Scene01_2d_TheCrier]]</tw-passagedata><tw-passagedata pid="180" name="Scene01_2d_TheCrier" tags="" position="475,250" size="100,100">&lt;&lt;bg &quot;Scene01_2d_TheCrier&quot;&gt;&gt;
The man&#39;s gaze is intense. His large, pitted eyes open up something in you and you feel unable to break free of him.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; The &lt;em&gt;Kind one&#39;s echo&lt;/em&gt;. The &lt;em&gt;shackled flame&lt;/em&gt;... The &lt;em&gt;storm that walks&lt;/em&gt;. &lt;&lt;/speech&gt;&gt;
The man climbs down from his box, stepping from beneath the imaginary shelter of his canopy and into the rain. A hard wind blows against him as he quickly approaches you, what is left of his scrappy white hair flowing freely around the form of his face. You feel stuck in place.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; &lt;em&gt;Hear me, girl!&lt;/em&gt; You come from a place whence you shall &lt;em&gt;never truly return&lt;/em&gt;. Your eyes shall be the ones of &lt;em&gt;darkness&lt;/em&gt; which men &lt;em&gt;pray not meet&lt;/em&gt;. Don&#39;t you understand!? The &lt;em&gt;crimson goddess curses you already&lt;/em&gt;. You will have no choice—&lt;em&gt;but now you do&lt;/em&gt;!&lt;&lt;/speech&gt;&gt;
He reaches through the air toward you. The lurching motion snaps you from the trance you felt during his approach. As you step back, he collapses to the ground where you just stood.
&lt;&lt;speech &quot;eristan&quot;&gt;&gt; Only &lt;em&gt;you&lt;/em&gt; can spare the city from the grip of &lt;em&gt;darkness&lt;/em&gt;, but that darkness will &lt;em&gt;plant its seeds in you&lt;/em&gt;. &lt;&lt;/speech&gt;&gt;
His head drops to the ground and he continues to mumble quietly at your feet. His words hang in the air like wet wool—heavy, clinging, impossible to shake off.
At a loss for words you just begin to walk away, unable to pull your eyes from the man crumpled on the ground.
&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; &lt;em&gt;What the fuck…madman.&lt;/em&gt; &lt;&lt;/speech&gt;&gt;
You move away from him quickly, your boots tapping sharply on stone as you cross the rain-streaked square. Finally, you peel your eyes away from his form and toward the far side of the square, where the tavern waits—a squat, inviting shape glowing with amber warmth. The laughter and clatter of its patrons drift just loud enough to break through the rain and invite you closer.
Still… you feel the weight of his words pressing against your back, long after you&#39;ve turned away.

After a moment you step up to the door and step inside the [[Three Sips Dragon.|Scene03_ThreeSipsDragon_Entry]]</tw-passagedata><tw-passagedata pid="181" name="Scene01_1" tags="" position="75,250" size="100,100">&lt;&lt;bg &quot;Scene01_1&quot;&gt;&gt;
You continue walking, your cloak flowing in the wet air behind you. You reach up and pull the hood of your cloak further over your ears and hair. It&#39;s times like these that your lineage can be an annoyance. The prolific dark maroon of your hair is a trait that you shared with your mother, Queen Ralmorra the Kind.

	If the queen&#39;s reputation were to be believed, your mother was closer to being a saint than anyone whom you&#39;d ever met in your life. She was a pinnacle of good in the Kingdom, and often spent her days among the people, using her training as a doctor from her life before becoming royalty to personally take care of her subjects. This was something your father often talked about in a tone that started sweet on his tongue, but always turned sour in his mouth; the memory of Ralmora&#39;s passing weighing on his very soul.

/* First instance of &quot;speech&quot;. Needs formatting with portrait, outline, and proper coloring (.jaylie #A24857, Light Maroon). */  

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt; &lt;em&gt;If only I&#39;d met her.&lt;/em&gt; &lt;&lt;/speech&gt;&gt;
Off to your left a sudden commotion grabs your attention as the front door of an establishment, apparently a brothel or something of the sort, bursts open. A man goes flying to the cold hard stones of the street. Standing in the doorway, covered by the warm, dry glow of candlelight, a group of women stand, scantily clad in colorful dresses. The woman in the front of the group, older than the rest and clad in a slightly more reserved attire of darker greys and black, seems to be the one who shoved the man. 

You assume she is the Mistress of the establishment.

[[Stop and pay attention to the commotion.|Scene01_2a_TheBrothelFront]]

[[That&#39;s none of my business. I have places to be.|Scene01_2b_ToTheTavern]]</tw-passagedata><tw-passagedata pid="182" name="StoryStart_Scene01" tags="" position="75,150" size="100,100">&lt;&lt;bg &quot;StoryStart_Scene01&quot;&gt;&gt;
Rain falls on the cobblestone streets all around you. The end of the day for the city is apparent, made obvious in the sounds of shops being shuttered and family dinners muffled by foggy glass. You suppose now would be the moment the oranges and purples of the sky would begin melting into the blackness of moonless night, however the sudden rain clouds clog the sky above.

You are one of few people left on the street. Most others find themselves covering their heads as they frantically secure their wares, or usher their families and children through the doors of their house in an attempt to escape the sudden Spring shower. You, however, are not the least bothered. The rain could never be an issue to you. After all you have a mission, a goal in mind. 

	You need a [[drink|Scene01_1]].</tw-passagedata><tw-passagedata pid="183" name="DiceRat_CallEvent" tags="" position="350,2350" size="100,100">A sharp clatter of dice and shouted curses cuts through the tavern’s usual noise. You turn toward the game table just in time to see one of the players—the only one not laughing—get up in a huff, knocking his chair back hard enough to draw more than a few stares. His face is red, his coin purse lighter, and his pride clearly wounded.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi, wipe that look off your face, handsome! You still got your boots—should be thankin’ me for lettin&#39; you walk out with those.&lt;&lt;/speech&gt;&gt;

The loudest of the trio kicks the empty chair with his boot, sending it spinning. His companions wheeze with laughter, like it’s the best thing they’ve seen all week.

Then his eyes find you across the tavern.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi! Red! You keen to play? Chair’s warm and luck’s waitin’. Won’t even make you polish me knob. Unless you lose, of course.&lt;&lt;/speech&gt;&gt;

The others cackle again, one of them already shuffling the dice in his hands, eager for a new mark—or maybe just new entertainment.

[[Approach the Dice Table.|Scene03_DiceIntro]]

[[Ignore Sarjan and head back to the tavern.|Scene03_SkipDiceGame]]</tw-passagedata><tw-passagedata pid="184" name="PostCAndCLose" tags="" position="475,2350" size="100,100">&lt;&lt;bg &quot;crownandcaste-table&quot;&gt;&gt;

Sarjan leans back with both arms wide, the clatter of the final dice still echoing as he rakes the pot toward himself with smug, meaty fingers.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Better luck next time, sweetheart. If you’re lucky, I’ll even let you polish the pot before I win it again.&lt;&lt;/speech&gt;&gt;

The two dice rats hoot like they’ve just witnessed divine comedy. One of them nearly chokes on his drink.

You exhale slowly. You lost, sure — but not by much. And you’ll be damned if Sarjan gets to strut away without at least one bruise to his pride.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;You know, Sarjan… it’s impressive, really. Takes a special kind of man to win a game of chance and still sound like he’s compensating.&lt;&lt;/speech&gt;&gt;

The laughter cuts off like a blade through string.

Sarjan blinks.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;The fuck you just say to me?&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Oh, I’m sorry — did I use too many syllables? I meant: you’ve got the dice, but not the stones.&lt;&lt;/speech&gt;&gt;

A sharp silence snaps through the table. Even the air feels tense, like the tavern itself is holding its breath.

Sarjan’s jaw tightens. His face goes crimson, mouth twisted in an ugly, wet sneer.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;That’s it, you little brat—&lt;em&gt;I’ll show you stones!&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

[[He lunges across the table!|TavernFightScene]]</tw-passagedata><tw-passagedata pid="185" name="PostCAndCWinFightSetup" tags="" position="600,2350" size="100,100">&lt;&lt;bg &quot;crownandcaste-table&quot;&gt;&gt;

The final die clatters to a stop. A perfect lineup. Your hand barely touches the table before Sarjan slams his fist down, scattering chips and curses alike.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Huh. Would you look at that.&lt;&lt;/speech&gt;&gt;

You stretch lazily, letting the silence thicken. Then you grin — all teeth and satisfaction — and rake the pot toward your side of the table.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Some beginner&#39;s luck, huh?.&lt;&lt;/speech&gt;&gt;

The dice rats fall silent. One of them lets out a stifled snort that he tries to smother in his drink. The other looks like he just bit his own tongue.

Sarjan’s face twists. His nostrils flare, his knuckles whiten, and for a heartbeat it looks like he’s chewing on nails instead of words.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;You little—&lt;em&gt;slitch&lt;/em&gt;.&lt;&lt;/speech&gt;&gt;

He stands so fast his chair topples backwards, hitting the tavern floor with a dull crack.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;You think you&#39;re clever, is that it?!&lt;&lt;/speech&gt;&gt;

The air shifts. The nearby chatter dies off. The dice rats scoot back from the table, suddenly very interested in the far corners of the room.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;What&#39;s the matter? Can&#39;t take a little loss without flipping the table?&lt;&lt;/speech&gt;&gt;

Sarjan’s hand twitches toward his belt — not quite drawing anything, but close enough to set your pulse humming.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;I’ll show you what losing feels like.&lt;&lt;/speech&gt;&gt;

[[He charges you!|TavernFightScene]]</tw-passagedata><tw-passagedata pid="186" name="Scene03_ApproachBountyHunter" tags="" position="725,2350" size="100,100">&lt;&lt;StartDialogueLayout&gt;&gt;&lt;&lt;bg &quot;Scene03_ApproachBountyHunter&quot;&gt;&gt;
The man in the corner doesn&#39;t look up as you approach—not at first. He continues dragging a whetstone down the edge of his dagger in slow, practiced strokes. His cloak is pulled back just enough to reveal a polished leather chestplate too clean to have seen real battle. The dark, tailored armor gleams faintly in the firelight, stitched with crimson threading that looks more decorative than durable.

Atop his head sits a wide-brimmed hat—deep gray, too dramatic for this tavern by half—plumed with a long, vividly colored feather that arcs like a banner. Everything about him is curated. Styled. Flashy. From the glint of his rings to the way his boots rest just-so, crossed at the ankle.

Eventually, he speaks—low, smooth, like a man who assumes you came here on purpose.

&lt;&lt;speech &quot;redmarrow&quot;&gt;&gt;Something I can help you with?&lt;&lt;/speech&gt;&gt;

&lt;&lt;DialogueTree &quot;redmarrow&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="187" name="Scene03_BarkeepDialogue" tags="" position="375,600" size="100,100">&lt;&lt;bg &quot;threesipsdragon_bar&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You decide to approach the bar and finally get your drink. As you approach, movement in the rafters catches your attention. You turn your gaze upward.

An orange-spotted noctail, which you hadn&#39;t noticed before, extends its rear into the air, pulling itself into a long, satisfying stretch. You watch for a moment as the feline finishes stretching and effortlessly bounds across the width of the room to a rafter on the opposite side, nearly thirty feet away. Despite the commonality of noctails in the city, their grace always amazes you.

You reach the bar and take a seat on a thick, heavy stool. Scooting closer, you settle your elbows onto the polished wood.

The barman steps forward and leans heavily onto the bar in front of you, resting his bulk onto hands as wide as battleaxes.

&lt;&lt;DialogueTree &quot;harroc&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="188" name="Scene03_DiceIntro" tags="" position="975,2350" size="100,100">&lt;&lt;bg &quot;crownandcaste-table&quot;&gt;&gt;

You slide into the now-empty chair. The other three players are already grinning like cats who’ve cornered a crippled mouse. Dice clatter between them—worn bone cubes inked with strange symbols and dark smudges that might be blood, or just years of spilled drink.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Right then. Pay attention, Red. I’m not explainin’ this twice.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;diceratone&quot;&gt;&gt;That&#39;s right tell er&#39; Sarjan!&lt;&lt;/speech&gt;&gt;&lt;&lt;know &quot;sarjan&quot;&gt;&gt;

Sarjan looks at the man who spoke with a stern scowl. Swiftly he reaches across the table and slaps the dice-rat across the ear.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;If you wouldn&#39;t fucking interrupt me, I&#39;d a been explainin&#39; it to er&#39; already.&lt;&lt;/speech&gt;&gt;

The second yes-man chuckles. The firs just leans in, holding his ear, looking sorry.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;This here&#39;s Crown and Caste. Four players, three dice each, the &lt;strong&gt;Caste dice&lt;/strong&gt;, and three shared dice in the middle, the &lt;strong&gt;Crown dice&lt;/strong&gt; Your goal? Lock the best damn combonation you can in three turns. There&#39;s bout fifteen combonations or so, but most of them are self-explanatory.&lt;&lt;/speech&gt;&gt;

He lifts a dice cup and shakes it once for show. The sound is oddly threatening.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;We take turns rollin’. Each roll, you can lock in dice— if ye&#39; don&#39;t they are rerolled on the next turn. But once you lock &#39;em, they stay. No backsies.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;dicerattwo&quot;&gt;&gt;And you’ve only got three rolls total—unless you burn a Control Chip to cheat fate.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;diceratone&quot;&gt;&gt;Or to fuck yourself over more efficiently. Depends how clever you are.&lt;&lt;/speech&gt;&gt;

Sarjan flashes a grin like a rusted dagger.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Scoring&#39;s simple if your brain ain&#39;t mush. Straights, groups of the same number, groups of pairs... Highest score wins the round, gets the pot. Second highest? Don&#39;t fucking matter none, if you ain&#39;t first yer last.&lt;&lt;/speech&gt;&gt;

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Lose all your coin, and you&#39;re out.&lt;&lt;/speech&gt;&gt;

The dice rattle again. Sarjan slides the pot to the center of the table.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Alright, Jaylie. Let&#39;s see if you’ve got more than hot air behind that smirk.&lt;&lt;/speech&gt;&gt;

&lt;&lt;CrownAndCaste 15 &quot;Dice Rat 1&quot; &quot;sarjan&quot; &quot;Dice Rat 2&quot; &quot;PostCAndCWinFightSetup&quot; &quot;PostCAndCLose&quot; 2.5&gt;&gt;</tw-passagedata><tw-passagedata pid="189" name="Scene03_DiceRatRejection" tags="" position="1100,2350" size="100,100">You approach the dice table—a clutter of ale mugs, crumpled betting slips, and three loud mouths with louder laughs. Four players are seated, but it’s clear who’s holding court: a wiry, mean-eyed man with a scar across his chin and a voice like gravel marinated in whiskey. 

He sees you coming before you say a word.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi, lads—would you look at that? The tavern’s got dessert walkin’ over on two legs.&lt;&lt;/speech&gt;&gt;

The other two snicker, elbowing each other.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Do you have room for one more?&lt;&lt;/speech&gt;&gt;

Sarjan leans back in his chair, boots up on the table like he owns the place.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Mmm... tempting. But unless you’re plannin’ to warm my lap or polish me knob while we play, I’d say we’re full up, sweetheart.&lt;&lt;/speech&gt;&gt;

The others howl with laughter, slapping the table and nearly spilling their drinks. One of them mimes scooting over, only to wave you off with a wink.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Come back when one of these pissants loses all their coin—shouldn’t take long.&lt;&lt;/speech&gt;&gt;

You stand there for a beat, the heat of their laughter washing over you. Then you turn and walk away.


[[Return to the tavern.|Scene03_TheSpace]]</tw-passagedata><tw-passagedata pid="190" name="Scene03_Firewatcher" tags="" position="1225,2350" size="100,100">&lt;&lt;StartDialogueLayout&gt;&gt;&lt;&lt;set $calledSilks to $calledSilks or 0&gt;&gt;
As you step toward the hearth, the half-orc woman turns just slightly—enough to clock you, not enough to welcome you.

She sizes you up with a glance, tearing another bite from the mutton before speaking.

&lt;&lt;speech &quot;brakka&quot;&gt;&gt;Your perfume is ruining the taste of my dinner. What do you want, Silks?&lt;&lt;/speech&gt;&gt;&lt;&lt;set $calledSilks += 1&gt;&gt;

&lt;&lt;DialogueTree &quot;brakka&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="191" name="Scene03_SecludedCorner" tags="" position="100,2475" size="100,100">&lt;&lt;bg &quot;Scene03_SecludedCorner&quot;&gt;&gt;&lt;&lt;StartDialogueLayout&gt;&gt;
You slip between the tables and claim a worn corner booth by yourself. The wood creaks under your weight, the seat still warm from whoever sat here last. For a moment, you watch the flicker of firelight dance across the floor, the sound of clinking mugs and shouted laughter rolling over you like a tide.

She approaches from the side, hips swaying with purpose and a smirk already playing on her lips.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;You drinking alone tonight, Miss?.&lt;&lt;/speech&gt;&gt;

You smile but don&#39;t have a chance to respond. She rests a hand on the table, leaning just close enough to let the scent of something floral and strong—like lilac and whiskey—hit you at once.
&lt;&lt;set $characters[&quot;tesska&quot;].known = true&gt;&gt;
&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Name&#39;s Tesska. Can I get you something, sweetheart? Or are you just here to make the furniture look pretty?&lt;&lt;/speech&gt;&gt;

You glance up to meet her gaze—bright, mischievous, and utterly unbothered.
&lt;&lt;set $tesskaOrderedDrink = false&gt;&gt;
&lt;&lt;DialogueTree &quot;tesska&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="192" name="Scene03_SkipDiceGame" tags="" position="225,2475" size="100,100">&lt;&lt;bg &quot;tavern-fight-pending&quot;&gt;&gt;

You fold your arms and cock your head, giving the man at the table the kind of look normally reserved for roaches in breadboxes.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;I think I’d rather scrub the floor with my tongue than sit next to you.&lt;&lt;/speech&gt;&gt;

The table goes still.

The boisterous man blinks—just once. Then the grin drains from his face like bad beer through a split mug.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;Oi, what’d you say to me?&lt;&lt;/speech&gt;&gt;

His cronies glance at each other, not sure whether to laugh or duck. Sarjan shoves back from the table, rising to full height—narrow, twitchy, all brittle swagger and wounded pride.

&lt;&lt;speech &quot;sarjan&quot;&gt;&gt;I was tryin’ to be friendly, you cocky little twat. Should’ve known a mouth like yours came without a brain to slow it down.&lt;&lt;/speech&gt;&gt;

You smile, razor-thin.

&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;Then I guess we both learned something tonight.&lt;&lt;/speech&gt;&gt;

Chairs scrape. A tankard hits the floor. One of the cronies mutters “Shit...” just as Sarjan lunges.

[[The tavern erupts in chaos.|TavernFightScene]]</tw-passagedata><tw-passagedata pid="193" name="Scene03_TheSpace" tags="" position="475,450" size="100,100">&lt;&lt;EndDialogueLayout&gt;&gt;&lt;&lt;bg &quot;threesipsdragon&quot;&gt;&gt;&lt;&lt;set $TavernTalkCount to $TavernTalkCount or 0&gt;&gt;
&lt;&lt;if !$seenTavernSpace&gt;&gt;
Surrounding the center hearth, more than a dozen figures cluster at thick wooden tables—scarred by knives, stained by drink, and mismatched in shape. The fire’s warmth ripples outward, licking the cracked flagstone floor and painting the rafters above in flickering gold.
&lt;&lt;/if&gt;&gt;

The bar stretches along the eastern wall, its counter worn smooth by time and tension. Behind it stands the barkeep—massive, grim, and seemingly committed to the slow execution of a single glass. He polishes it with the focus of a man settling a grudge.

Slumped beside him, head buried in his arms, a man snores softly into the crook of his elbow. Judging by the wobble of his stool and the crust of dried ale at his chin, he’s been a fixture of that spot for hours—if not days.

Across the room, a barmaid threads through the crowd with practiced grace, a tray of frothing mugs balanced in one hand like a weapon. Her braid swings like a pendulum, and her boots make no sound against the stone.

&lt;&lt;if !$seenTavernSpace&gt;&gt;
One of the patrons—red-faced and too drunk to remember his own hands—reaches for her as she passes. Without breaking stride, she twists at the waist and slams his wrist against the table with a move so fluid it seems rehearsed.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt; &quot;Try that again and you’ll be wearin’ your bollocks like earrings.&quot;&lt;&lt;/speech&gt;&gt;

The room barely reacts. The man yelps, but no one comes to his defense.
&lt;&lt;/if&gt;&gt;

The offender and his two friends stew in their corner, muttering into overturned tankards and picking half-heartedly at the bones of a shared meat pie.

Elsewhere, at a long communal bench near the hearth’s edge, an older man eats in silence. He’s flanked by two others—both silent, both chewing with the intensity of soldiers pretending not to listen.

Nearby, a more raucous table erupts with noise. Four men are locked in a tense dice game, knuckles white, coins scattered, curses loud. One slams the table with a triumphant shout as the bones scatter, while another curses so creatively he draws a laugh from a table over.

In the far northwestern corner, a figure reclines beneath the shadow of his own wide-brimmed hat. His legs are propped on the table’s edge, and in one hand he methodically sharpens a thin-bladed dagger. Between strokes, he sips from a delicate stemmed glass filled with something dark and expensive-looking. He doesn’t seem to notice—or care—that anyone else exists.

Leaning against a thick support beam near the hearth, a hulking woman watches the room with quiet disdain. She doesn’t sit—just looms, like she’s too restless or too proud to claim a seat.

A heavy fur is draped across her shoulders, its coarse texture concealing her chest without much ceremony. Her arms are bare—cords of muscle twisted like ropes beneath green-tinged skin. She wears no shirt, just a leather wrap beneath the fur and a belt strapped tight across her exposed midriff. From the belt hangs more fur, forming a crude skirt that sways with her movements.

In one hand, she grips a massive leg of mutton. In the other, a heavy metal mug of ale or something equally punishing. At her hip rests a greatsword nearly as tall as she is, the tip of its battered sheath brushing the floor with each subtle shift of her stance.

She tears off a bite of meat with thicker-than-average teeth, then scans the room with eyes that dare someone—anyone—to ruin her meal.

&lt;&lt;set $seenTavernSpace = true&gt;&gt;

From here, you may:
[[Approach the bar and speak with the barkeeper.|Scene03_BarkeepDialogue]]
[[Try your luck joining the dice game.|Scene03_DiceRatRejection]]
[[Approach the cloaked man in the corner.|Scene03_ApproachBountyHunter]]
[[Observe the half-orc woman.|Scene03_Firewatcher]]
[[Find an unoccupied corner and sit alone.|Scene03_SecludedCorner]]</tw-passagedata><tw-passagedata pid="194" name="Scene03_ThreeSipsDragon_Entry" tags="" position="475,350" size="100,100">&lt;&lt;bg &quot;threesipsdragon&quot;&gt;&gt;
You pull open the heavy oaken door and step inside. The wind whips at the precipice behind you but the warmth of the hearth greets you like the warm hug of a fellow, you instinctively lower your hood, water spilling down off of it.
Inside the Three Sips Dragon /* Thinking about having inline words you can hover over or click on to show little lore boxes like Alt-Text, entering a passage with one of these words will also add that information to the codex like a living and growing lore-book */, the air is thick with smoke, laughter, and the scent of hearth-brewed ale. Lanterns swing slightly overhead, their flickering light dancing across polished wood beams and walls darkened with age and spilled stories. The tavern&#39;s heart—a great firepit sunk into the floor—crackles merrily near the center of the room, casting long shadows that play on the faces of patrons scattered throughout.
A few eyes drift toward you, but none linger. Bastion is full of cloaked figures in rain-soaked hoods. No one spares much mind for another.
Except one.
&lt;&lt;speech &quot;randompatron1&quot;&gt;&gt; &quot;&lt;strong&gt;Close the damn door&lt;/strong&gt;, you&#39;re lettin&#39; the warm out, girl!&quot; &lt;&lt;/speech&gt;&gt;
Someone near the hearth waves a half-eaten leg of something at you without even turning. A few chuckles follow.
Heeding his words, you reach behind you and close the door, and just like that you are absorbed into the room.
To your right, the bar stretches across the far wall, worn smooth by time and elbows. Behind it, a man, tall and thick as a tree trunk, polishes a glass that doesn&#39;t seem to need polishing. His head is a shining dome, rich with wrinkled skin, his face, nestled atop a thick dark beard, is etched with long years and longer nights, but his eyes—piercing and pale blue—fix on you the moment you lower your hood.
He does little to acknowledge your existence aside from a half-hearted glance, barely longer than a blink.
[[You look around at the rest of the room.|Scene03_TheSpace]]</tw-passagedata><tw-passagedata pid="195" name="TavernLightningScene" tags="" position="600,2475" size="100,100">A flash.
White, searing, god-sent.

It splits the sky—and the tavern—down the spine. The thunder follows instantly, as if the world itself forgot to blink.

The Noctail shrieks from the rafters, flailing into a tangle of limbs and panicked wings. It slams against the floorboards, scrabbling under tables as tankards crash and patrons shout in stunned confusion.

The air turns electric, thick with ozone. You taste metal.
Your teeth buzz. Your ears ring with a high, cruel whine that drowns out the world.

The foundation of the Three Sips Dragon shudders, beams groaning in protest. Dust and plaster rain from the ceiling.

All of it—
The noise, the light, the vertigo—
Lasts less than a heartbeat.

But in that moment, it feels as though time refused to move forward.

It lingers.

Burns into your vision.

Stays behind your eyes.

After a moment you blink the brightness away. The world returns to you. 

Tesska moved from behind you at some point and now stands near a large window at the front of the room. She looks out onto the street.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Gods... Is that—&lt;&lt;/speech&gt;&gt;

You quickly walk up next to her, matching your gaze with her&#39;s.

Far down the street, you see a flickering orange glow. At first, it seems like lantern light. Then it brightens—flares—and the realization hits like a punch to the gut.


&lt;&lt;speech &quot;jaylie&quot;&gt;&gt;[[Fire—|FireConvergence]]&lt;&lt;/speech&gt;&gt;</tw-passagedata><tw-passagedata pid="196" name="TavernFightScene" tags="" position="725,2475" size="100,100">The table explodes as Sarjan shoves it aside, dice, coins, and drinks scatter like startled birds. He lunges—red-faced, snarling, swinging for your head.

He doesn’t get close.

A flash of motion—something huge moving between you—and suddenly you’re &lt;em&gt;falling&lt;/em&gt; backward. A firm hand pushes you clear, and you&#39;re caught in a pair of arms that smell faintly of citrus and sweat.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Oof—gotcha, sweetheart.&lt;&lt;/speech&gt;&gt;

Tesska holds your weight from behind like it is nothing to her. You turn your head and see her face—intimately close—she bites her lip looking towards her husband.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;Watch this, girl. It&#39;s always my favorite when the big guy gets worked up.&lt;&lt;/speech&gt;&gt;

Tesska&#39;s words ooze with a sexual tension that leads you to not doubt that what she said was true. You turn back towards Harroc.

Sarjan, after being pushed away from you took a moment to recalibrate. He looks at Harroc, the new object of his rage. He swings wildly. Harroc catches the hook with absolutely zero effort. You see Harroc&#39;s grip tighten and a quick series of pops eminate from Sarjan&#39;s now likely broken hand.

With another twist of his arm, and a shove, Sarjan is launched towards the main entrance of the tavern. Harroc with his free hands grabs the other two dice-rats. The skinny one by his ear, the same one Sarjan had slapped not so long ago; the fat one by his collar. Harroc moves with purpose, it&#39;s like watching a wild bear claiming its territory.

The two henchies in tow, Harroc approaches Sarjan once more before giving a powerful kick to his chest sending the drunkard soaring through the door. The sound of the heavy rain suddenly fills the tavern, and as if Harroc himself summoned it, a crack of thunder booms from somewhere in the distance. The men vanish into the downpour for only a moment. 

Harroc enters again, only slightly wet, as if the rain itself wasn&#39;t going to fuck with him tonight. His facial expression blank, untelling.

&lt;&lt;speech &quot;tesska&quot;&gt;&gt;&lt;em&gt;Isn&#39;t he incredible?&lt;/em&gt;&lt;&lt;/speech&gt;&gt;

You don&#39;t have time to answer before Harroc walks up to you and in his slow methodical boom of a voice says

&lt;&lt;speech &quot;harroc&quot;&gt;&gt;&#39;Get that you’ve got something to prove. Just don’t do it in Tesska&#39;s bar.&lt;&lt;/speech&gt;&gt;

His tone does not leave room for a proper response. You swallow hard, realizing you&#39;d been holding your breath.

You nod at him. 

Tesska stands you back up properly. Harroc moves back to his spot behind the bar, as if nothing had happened.



[[Suddenly your surrounding melt in a bright flash—|TavernLightningScene]]</tw-passagedata><tw-passagedata pid="197" name="KingsStreet3" tags="" position="850,2475" size="100,100">You stand in the heart of King&#39;s Street, the main thoroughfare of the district. The cobblestone street bustles with merchants, travelers, and locals going about their daily business. 

To the north, you can see the street continuing toward the upper district. To the south, it leads toward the palace gates. East takes you toward the merchant quarter, while west leads to a quieter residential area.

The Three Sips Dragon Tavern&#39;s sign creaks in the breeze to the northeast, and you can smell the aroma of roasted meat and ale drifting from its direction.

&lt;&lt;if MapSystem.currentMap&gt;&gt;
	&lt;div class=&quot;map-debug&quot;&gt;
		&lt;strong&gt;Map Debug Info:&lt;/strong&gt;&lt;br&gt;
		Current Map: &lt;&lt;print MapSystem.currentMap.name&gt;&gt;&lt;br&gt;
		Position: (&lt;&lt;print MapSystem.currentPosition.x&gt;&gt;, &lt;&lt;print MapSystem.currentPosition.y&gt;&gt;)&lt;br&gt;
		&lt;button onclick=&quot;MapSystem.setMovementBlocked(!MapSystem.movementBlocked)&quot;&gt;
			Toggle Movement (Currently: &lt;&lt;print MapSystem.movementBlocked ? &quot;Blocked&quot; : &quot;Enabled&quot;&gt;&gt;)
		&lt;/button&gt;
	&lt;/div&gt;
&lt;&lt;/if&gt;&gt;

[[Continue exploring-&gt;KingsStreet3]]</tw-passagedata><tw-passagedata pid="198" name="ThreeSipsDragonTavern" tags="" position="975,2475" size="100,100">You push through the heavy wooden doors of the Three Sips Dragon Tavern. The interior is warm and inviting, filled with the chatter of patrons and the clinking of tankards. A large fireplace crackles in the corner, casting dancing shadows on the walls.

The tavern keeper, a burly man with a graying beard, nods at you from behind the bar. Several locals sit at various tables, some engaged in animated conversations, others quietly nursing their drinks.

A bard in the corner strums a lute, singing tales of distant lands and heroic adventures.

&lt;&lt;button &quot;Order a drink&quot;&gt;&gt;
	&lt;&lt;replace &quot;#tavern-action&quot;&gt;&gt;You order a mug of the tavern&#39;s famous ale. The tavern keeper slides it across the bar with a friendly smile. &quot;That&#39;ll be 2 gold,&quot; he says.&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Listen to the bard&quot;&gt;&gt;
	&lt;&lt;replace &quot;#tavern-action&quot;&gt;&gt;You settle in to listen to the bard&#39;s tales. His voice is melodious as he sings of ancient heroes and forgotten kingdoms.&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Talk to locals&quot;&gt;&gt;
	&lt;&lt;replace &quot;#tavern-action&quot;&gt;&gt;You approach a table of locals. They welcome you warmly and share news of recent happenings in the district.&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;div id=&quot;tavern-action&quot;&gt;&lt;/div&gt;

[[Leave the tavern-&gt;KingsStreet1]]</tw-passagedata><tw-passagedata pid="199" name="AlchemistFireShop" tags="" position="1100,2475" size="100,100">You enter the Alchemist Fire, a shop filled with bubbling potions, glowing crystals, and the sharp scent of magical reagents. Shelves line the walls, packed with bottles of various shapes and sizes containing liquids of every color imaginable.

Behind the counter stands an elderly woman with silver hair and keen eyes. She looks up from grinding some herbs and smiles at you.

&quot;Welcome to the Alchemist Fire,&quot; she says in a warm voice. &quot;I&#39;m Elara. Looking for anything in particular? I have healing potions, magical components, and various alchemical supplies.&quot;

&lt;&lt;button &quot;Browse healing potions&quot;&gt;&gt;
	&lt;&lt;replace &quot;#shop-display&quot;&gt;&gt;
		&lt;strong&gt;Healing Potions:&lt;/strong&gt;&lt;br&gt;
		• Minor Healing Potion - 15 gold&lt;br&gt;
		• Healing Potion - 50 gold&lt;br&gt;
		• Greater Healing Potion - 150 gold
	&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Look at magical components&quot;&gt;&gt;
	&lt;&lt;replace &quot;#shop-display&quot;&gt;&gt;
		&lt;strong&gt;Magical Components:&lt;/strong&gt;&lt;br&gt;
		• Dragon Scale - 200 gold&lt;br&gt;
		• Phoenix Feather - 500 gold&lt;br&gt;
		• Moonstone Dust - 75 gold
	&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Ask about custom orders&quot;&gt;&gt;
	&lt;&lt;replace &quot;#shop-display&quot;&gt;&gt;
		&quot;Ah, a discerning customer!&quot; Elara&#39;s eyes light up. &quot;I can craft custom potions if you bring me the right ingredients. What did you have in mind?&quot;
	&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;div id=&quot;shop-display&quot;&gt;&lt;/div&gt;

[[Leave the shop-&gt;KingsStreet3]]</tw-passagedata><tw-passagedata pid="200" name="NuzzlingNoctailBrothel" tags="" position="1225,2475" size="100,100">You approach the entrance of the Nuzzling Noctail, an upscale establishment known throughout the district. The building is well-maintained with elegant decorations and soft lighting that creates an inviting atmosphere.

A well-dressed doorman greets you with a professional smile. &quot;Welcome to the Nuzzling Noctail. Are you here for companionship, entertainment, or perhaps just a drink in our lounge?&quot;

The establishment appears to cater to a refined clientele, with tasteful artwork adorning the walls and the sound of gentle music drifting from within.

&lt;&lt;button &quot;Enter the lounge&quot;&gt;&gt;
	&lt;&lt;replace &quot;#brothel-action&quot;&gt;&gt;You enter the main lounge, where patrons relax in comfortable chairs while enjoying drinks and conversation. The atmosphere is sophisticated and welcoming.&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Inquire about services&quot;&gt;&gt;
	&lt;&lt;replace &quot;#brothel-action&quot;&gt;&gt;The doorman explains the various services available, from simple companionship to more intimate arrangements. All interactions are consensual and professional.&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Ask about the establishment&quot;&gt;&gt;
	&lt;&lt;replace &quot;#brothel-action&quot;&gt;&gt;The doorman tells you about the history of the Nuzzling Noctail, how it&#39;s been a respected part of the district for many years, providing a safe and comfortable environment.&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;div id=&quot;brothel-action&quot;&gt;&lt;/div&gt;

[[Leave-&gt;KingsStreet3]]</tw-passagedata><tw-passagedata pid="201" name="PalaceGate" tags="" position="100,2600" size="100,100">You stand before the imposing gates of the royal palace. Tall iron bars topped with golden spikes stretch high above you, and beyond them you can see manicured gardens and the palace&#39;s magnificent architecture.

Two guards in polished armor stand at attention on either side of the gate. Their eyes follow your movements, but they remain silent and professional.

A brass plaque near the gate reads: &quot;Royal Palace of Bastion - Authorized Personnel Only&quot;

&lt;&lt;if State.variables.player &amp;&amp; State.variables.player.reputation &amp;&amp; State.variables.player.reputation.royal &gt;= 10&gt;&gt;
	The guards recognize your standing with the royal court and nod respectfully.
	
	[[Enter the palace-&gt;PalaceEntrance]]
&lt;&lt;else&gt;&gt;
	The guards eye you carefully. It&#39;s clear that you would need significant reputation with the royal court to gain entry here.
&lt;&lt;/if&gt;&gt;

[[Return to King&#39;s Street-&gt;KingsStreet4]]</tw-passagedata><tw-passagedata pid="202" name="CityGate" tags="" position="225,2600" size="100,100">You reach the eastern gate of the city, a massive stone archway that serves as one of the main entrances to the district. Guards check the papers of travelers coming and going, while merchants with loaded carts wait in line to have their goods inspected.

Beyond the gate, you can see the road stretching into the distance, leading to other parts of the kingdom. The countryside looks peaceful, with rolling hills and scattered farmsteads visible in the distance.

A notice board near the gate displays various announcements: job postings, wanted posters, and news from other settlements.

&lt;&lt;button &quot;Read the notice board&quot;&gt;&gt;
	&lt;&lt;replace &quot;#gate-info&quot;&gt;&gt;
		&lt;strong&gt;Current Notices:&lt;/strong&gt;&lt;br&gt;
		• Seeking adventurers for escort mission to Millbrook&lt;br&gt;
		• Reward offered for information about missing merchant caravan&lt;br&gt;
		• Royal decree: New trade regulations in effect&lt;br&gt;
		• Warning: Increased bandit activity on the northern roads
	&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Talk to the guards&quot;&gt;&gt;
	&lt;&lt;replace &quot;#gate-info&quot;&gt;&gt;
		The guards are friendly but professional. They tell you about recent travelers and any news from the roads. &quot;Been quiet lately,&quot; one says, &quot;but keep your wits about you if you&#39;re heading out.&quot;
	&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Observe the travelers&quot;&gt;&gt;
	&lt;&lt;replace &quot;#gate-info&quot;&gt;&gt;
		You watch the steady stream of people passing through the gate. Merchants, farmers, adventurers, and ordinary folk all make their way in and out of the city.
	&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;div id=&quot;gate-info&quot;&gt;&lt;/div&gt;

[[Return to the city-&gt;SilkStreet3]]</tw-passagedata><tw-passagedata pid="203" name="MapSystemTest" tags="" position="350,2600" size="100,100">&lt;h2&gt;Map System Test Page&lt;/h2&gt;

This is a test page for the Map System. Use the buttons below to test various features.

&lt;h3&gt;Basic Map Controls&lt;/h3&gt;
&lt;&lt;button &quot;Load Example Map&quot;&gt;&gt;
	&lt;&lt;run MapSystem.setCurrentMap(&#39;example-map&#39;)&gt;&gt;
	&lt;&lt;replace &quot;#map-status&quot;&gt;&gt;Map loaded successfully! You can now use WASD or arrow keys to move around.&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Open Full Map&quot;&gt;&gt;
	&lt;&lt;run MapSystem.openFullMap()&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Toggle Movement Block&quot;&gt;&gt;
	&lt;&lt;run MapSystem.setMovementBlocked(!MapSystem.movementBlocked)&gt;&gt;
	&lt;&lt;replace &quot;#movement-status&quot;&gt;&gt;Movement is now: &lt;&lt;print MapSystem.movementBlocked ? &quot;BLOCKED&quot; : &quot;ENABLED&quot;&gt;&gt;&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;h3&gt;Position Controls&lt;/h3&gt;
&lt;&lt;button &quot;Go to King&#39;s Street (5,3)&quot;&gt;&gt;
	&lt;&lt;run MapSystem.currentPosition = {x: 5, y: 3}&gt;&gt;
	&lt;&lt;run MapSystem.updateMinimapDisplay()&gt;&gt;
	&lt;&lt;run MapSystem.updateLocationInfo()&gt;&gt;
	&lt;&lt;replace &quot;#position-status&quot;&gt;&gt;Moved to King&#39;s Street&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Go to Tavern (6,1)&quot;&gt;&gt;
	&lt;&lt;run MapSystem.currentPosition = {x: 6, y: 1}&gt;&gt;
	&lt;&lt;run MapSystem.updateMinimapDisplay()&gt;&gt;
	&lt;&lt;run MapSystem.updateLocationInfo()&gt;&gt;
	&lt;&lt;replace &quot;#position-status&quot;&gt;&gt;Moved to Three Sips Dragon Tavern&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;&lt;button &quot;Go to Palace Gate (5,5)&quot;&gt;&gt;
	&lt;&lt;run MapSystem.currentPosition = {x: 5, y: 5}&gt;&gt;
	&lt;&lt;run MapSystem.updateMinimapDisplay()&gt;&gt;
	&lt;&lt;run MapSystem.updateLocationInfo()&gt;&gt;
	&lt;&lt;replace &quot;#position-status&quot;&gt;&gt;Moved to Palace Gate&lt;&lt;/replace&gt;&gt;
&lt;&lt;/button&gt;&gt;

&lt;h3&gt;Status&lt;/h3&gt;
&lt;div id=&quot;map-status&quot;&gt;No map loaded&lt;/div&gt;
&lt;div id=&quot;movement-status&quot;&gt;Movement status: Unknown&lt;/div&gt;
&lt;div id=&quot;position-status&quot;&gt;Position: Unknown&lt;/div&gt;

&lt;h3&gt;Instructions&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Keyboard Controls:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;W or ↑ - Move North&lt;/li&gt;
&lt;li&gt;S or ↓ - Move South&lt;/li&gt;
&lt;li&gt;A or ← - Move West&lt;/li&gt;
&lt;li&gt;D or → - Move East&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Mouse Controls:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Click the maximize button in the minimap to open the full map&lt;/li&gt;
&lt;li&gt;In the full map, click on adjacent tiles to move&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Features to Test:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Load the example map and try moving around&lt;/li&gt;
&lt;li&gt;Open the Journal and check the Map tab&lt;/li&gt;
&lt;li&gt;Try moving to different locations and see how the minimap updates&lt;/li&gt;
&lt;li&gt;Test movement blocking (useful for conversations/overlays)&lt;/li&gt;
&lt;/ul&gt;

[[Return to main story-&gt;KingsStreet3]]

&lt;&lt;script&gt;&gt;
// Initialize map system test
$(document).ready(function() {
	// Update status displays
	setTimeout(function() {
		if (MapSystem.currentMap) {
			$(&#39;#map-status&#39;).text(&#39;Map loaded: &#39; + MapSystem.currentMap.name);
		}
		$(&#39;#movement-status&#39;).text(&#39;Movement is: &#39; + (MapSystem.movementBlocked ? &#39;BLOCKED&#39; : &#39;ENABLED&#39;));
		if (MapSystem.currentPosition) {
			$(&#39;#position-status&#39;).text(&#39;Position: (&#39; + MapSystem.currentPosition.x + &#39;, &#39; + MapSystem.currentPosition.y + &#39;)&#39;);
		}
	}, 100);
});
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="204" name="TestRealm_ConvoMinigame" tags="" position="475,2600" size="100,100">&lt;div id=&quot;convoBox&quot;&gt;&lt;/div&gt;
&lt;div id=&quot;convoChoices&quot;&gt;&lt;/div&gt;

&lt;&lt;DialogueTree &quot;darian&quot; &quot;Phase0&quot;&gt;&gt;</tw-passagedata></tw-storydata>
	<script id="script-sugarcube" type="text/javascript">
	/*! SugarCube JS */
	if(document.documentElement.getAttribute("data-init")==="loading"){!function(window,document,jQuery,undefined){"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,i=undefined;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},errorPrologRegExp=/^(?:(?:uncaught\s+(?:exception:\s+)?)?\w*(?:error|exception|_err):\s+)+/i,Alert=function(){function e(e,t,r,n){var a="fatal"===e,i="Apologies! "+(a?"A fatal":"An")+" error has occurred.";i+=a?" Aborting.":" You may be able to continue, but some parts may not work properly.",null==t&&null==r||(i+="\n\nError",null!=t&&(i+=" ["+t+"]"),i+=null!=r?": "+r.replace(errorPrologRegExp,"")+".":": unknown error."),"object"===(void 0===n?"undefined":_typeof(n))&&n.stack&&(i+="\n\nStack Trace:\n"+n.stack),window.alert(i)}function t(t,r,n){e(null,t,r,n)}function r(t,r,n){e("fatal",t,r,n)}return function(e){window.onerror=function(n,a,i,o,s){"complete"===document.readyState?t(null,n,s):(r(null,n,s),window.onerror=e,"function"==typeof window.onerror&&window.onerror.apply(this,arguments))}}(window.onerror),Object.freeze(Object.defineProperties({},{error:{value:t},fatal:{value:r}}))}(),Patterns=function(){var e=function(){var e=new Map([[" ","\\u0020"],["\f","\\f"],["\n","\\n"],["\r","\\r"],["\t","\\t"],["\v","\\v"],[" ","\\u00a0"],[" ","\\u1680"],["᠎","\\u180e"],[" ","\\u2000"],[" ","\\u2001"],[" ","\\u2002"],[" ","\\u2003"],[" ","\\u2004"],[" ","\\u2005"],[" ","\\u2006"],[" ","\\u2007"],[" ","\\u2008"],[" ","\\u2009"],[" ","\\u200a"],["\u2028","\\u2028"],["\u2029","\\u2029"],[" ","\\u202f"],[" ","\\u205f"],["　","\\u3000"],["\ufeff","\\ufeff"]]),t=/^\s$/,r="";return e.forEach(function(e,n){t.test(n)||(r+=e)}),r?"[\\s"+r+"]":"\\s"}(),t="\\s"===e?"\\S":e.replace(/^\[/,"[^"),r="[0-9A-Z_a-z\\-\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u00ff\\u0150\\u0170\\u0151\\u0171]",n=r.replace("\\-",""),a=function(){return"("+r+"+)\\(([^\\)\\|\\n]+)\\):|("+r+"+):([^;\\|\\n]+);|((?:\\."+r+"+)+);|((?:#"+r+"+)+);"}();return Object.freeze({space:e,spaceNoTerminator:"[\\u0020\\f\\t\\v\\u00a0\\u1680\\u180e\\u2000-\\u200a\\u202f\\u205f\\u3000\\ufeff]",lineTerminator:"[\\n\\r\\u2028\\u2029]",notSpace:t,anyChar:"(?:.|[\\n\\r\\u2028\\u2029])",anyLetter:r,anyLetterStrict:n,identifierFirstChar:"[$A-Z_a-z]",identifierNextChar:"[$0-9A-Z_a-z]",identifier:"[$A-Z_a-z][$0-9A-Z_a-z]*",variableSigil:"[$_]",variable:"[$_][$A-Z_a-z][$0-9A-Z_a-z]*",macroName:"[A-Za-z][\\w-]*|[=-]",templateName:"[A-Za-z][\\w-]*",cssImage:"\\[[<>]?[Ii][Mm][Gg]\\[(?:\\s|\\S)*?\\]\\]+",inlineCss:a,url:"(?:file|https?|mailto|ftp|javascript|irc|news|data):[^\\s'\"]+"})}();!function(){!function(e){if(e&&e.prototype&&null==e.prototype.firstElementChild){var t=Node.ELEMENT_NODE;Object.defineProperty(e.prototype,"firstElementChild",{get:function(){for(var e=this.childNodes,r=0;r<e.length;++r){var n=e[r];if(n.nodeType===t)return n}return null}})}}(window.Node||window.Element)}(),function(){function e(e,t){var r=Number.parseInt(e,10)||0;if(r<1)return"";var n=void 0===t?"":String(t);for(""===n&&(n=" ");n.length<r;){var a=n.length,i=r-a;n+=a>i?n.slice(0,i):n}return n.length>r&&(n=n.slice(0,r)),n}var t=function(){function e(e,n){var a=String(e);if(!a)return a;switch(n){case"start":return t.test(a)?a.replace(t,""):a;case"end":return r.test(a)?a.replace(r,""):a;default:throw new Error('_trimString called with incorrect where parameter value: "'+n+'"')}}var t=new RegExp("^"+Patterns.space+Patterns.space+"*"),r=new RegExp(""+Patterns.space+Patterns.space+"*$");return e}();Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,writable:!0,value:function(){function e(){if(null==this)throw new TypeError("Array.prototype.flat called on null or undefined");var t=0===arguments.length?1:Number(arguments[0])||0;return t<1?Array.prototype.slice.call(this):Array.prototype.reduce.call(this,function(r,n){return n instanceof Array?r.push.apply(r,_toConsumableArray(e.call(n,t-1))):r.push(n),r},[])}return e}()}),Array.prototype.flatMap||Object.defineProperty(Array.prototype,"flatMap",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.flatMap called on null or undefined");return Array.prototype.map.apply(this,arguments).flat()}}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includes called on null or undefined");if(0===arguments.length)return!1;var e=this.length>>>0;if(0===e)return!1;var t=arguments[0],r=Number(arguments[1])||0;for(r<0&&(r=Math.max(0,e+r));r<e;++r){var n=this[r];if(n===t||n!==n&&t!==t)return!0}return!1}}),Object.entries||Object.defineProperty(Object,"entries",{configurable:!0,writable:!0,value:function(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)throw new TypeError("Object.entries object parameter must be an object");return Object.keys(e).map(function(t){return[t,e[t]]})}}),Object.fromEntries||Object.defineProperty(Object,"fromEntries",{configurable:!0,writable:!0,value:function(e){return Array.from(e).reduce(function(e,t){if(Object(t)!==t)throw new TypeError("Object.fromEntries iterable parameter must yield objects");return t[0]in e?Object.defineProperty(e,t[0],{configurable:!0,enumerable:!0,writable:!0,value:t[1]}):e[t[0]]=t[1],e},{})}}),Object.getOwnPropertyDescriptors||Object.defineProperty(Object,"getOwnPropertyDescriptors",{configurable:!0,writable:!0,value:function(e){if(null==e)throw new TypeError("Object.getOwnPropertyDescriptors object parameter is null or undefined");var t=Object(e);return Reflect.ownKeys(t).reduce(function(e,r){var n=Object.getOwnPropertyDescriptor(t,r);return void 0!==n&&(r in e?Object.defineProperty(e,r,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[r]=n),e},{})}}),Object.values||Object.defineProperty(Object,"values",{configurable:!0,writable:!0,value:function(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)throw new TypeError("Object.values object parameter must be an object");return Object.keys(e).map(function(t){return e[t]})}}),String.prototype.padStart||Object.defineProperty(String.prototype,"padStart",{configurable:!0,writable:!0,value:function(t,r){if(null==this)throw new TypeError("String.prototype.padStart called on null or undefined");var n=String(this),a=n.length,i=Number.parseInt(t,10);return i<=a?n:e(i-a,r)+n}}),String.prototype.padEnd||Object.defineProperty(String.prototype,"padEnd",{configurable:!0,writable:!0,value:function(t,r){if(null==this)throw new TypeError("String.prototype.padEnd called on null or undefined");var n=String(this),a=n.length,i=Number.parseInt(t,10);return i<=a?n:n+e(i-a,r)}}),String.prototype.trimStart||Object.defineProperty(String.prototype,"trimStart",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimStart called on null or undefined");return t(this,"start")}}),String.prototype.trimLeft||Object.defineProperty(String.prototype,"trimLeft",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimLeft called on null or undefined");return t(this,"start")}}),String.prototype.trimEnd||Object.defineProperty(String.prototype,"trimEnd",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimEnd called on null or undefined");return t(this,"end")}}),String.prototype.trimRight||Object.defineProperty(String.prototype,"trimRight",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimRight called on null or undefined");return t(this,"end")}})}(),function(){function _random(){var e=void 0,t=void 0;switch(arguments.length){case 0:throw new Error("_random called with insufficient parameters");case 1:e=0,t=arguments[0];break;default:e=arguments[0],t=arguments[1]}if(e>t){var r=[t,e];e=r[0],t=r[1]}return Math.floor(_nativeMathRandom()*(t-e+1))+e}function _randomIndex(e,t){var r=void 0,n=void 0;switch(t.length){case 1:r=0,n=e-1;break;case 2:r=0,n=Math.trunc(t[1]);break;default:r=Math.trunc(t[1]),n=Math.trunc(t[2])}return Number.isNaN(r)?r=0:!Number.isFinite(r)||r>=e?r=e-1:r<0&&(r=e+r)<0&&(r=0),Number.isNaN(n)?n=0:!Number.isFinite(n)||n>=e?n=e-1:n<0&&(n=e+n)<0&&(n=e-1),_random(r,n)}function _getCodePointStartAndEnd(e,t){var r=e.charCodeAt(t);if(Number.isNaN(r))return{char:"",start:-1,end:-1};if(r<55296||r>57343)return{char:e.charAt(t),start:t,end:t};if(r>=55296&&r<=56319){var n=t+1;if(n>=e.length)throw new Error("high surrogate without trailing low surrogate");var a=e.charCodeAt(n);if(a<56320||a>57343)throw new Error("high surrogate without trailing low surrogate");return{char:e.charAt(t)+e.charAt(n),start:t,end:n}}if(0===t)throw new Error("low surrogate without leading high surrogate");var i=t-1,o=e.charCodeAt(i);if(o<55296||o>56319)throw new Error("low surrogate without leading high surrogate");return{char:e.charAt(i)+e.charAt(t),start:i,end:t}}var _nativeMathRandom=Math.random;Object.defineProperty(Array,"random",{configurable:!0,writable:!0,value:function(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e||!Object.prototype.hasOwnProperty.call(e,"length"))throw new TypeError("Array.random array parameter must be an array or array-lke object");var t=e.length>>>0;if(0!==t){return e[0===arguments.length?_random(0,t-1):_randomIndex(t,Array.prototype.slice.call(arguments,1))]}}}),Object.defineProperty(Array.prototype,"concatUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.concatUnique called on null or undefined");var e=Array.from(this);if(0===arguments.length)return e;var t=Array.prototype.reduce.call(arguments,function(e,t){return e.concat(t)},[]),r=t.length;if(0===r)return e;for(var n=Array.prototype.indexOf,a=Array.prototype.push,i=0;i<r;++i){var o=t[i];-1===n.call(e,o)&&a.call(e,o)}return e}}),Object.defineProperty(Array.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.count called on null or undefined");for(var e=Array.prototype.indexOf,t=arguments[0],r=Number(arguments[1])||0,n=0;-1!==(r=e.call(this,t,r));)++n,++r;return n}}),Object.defineProperty(Array.prototype,"delete",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.delete called on null or undefined");if(0===arguments.length)return[];var e=this.length>>>0;if(0===e)return[];for(var t=Array.prototype.concat.apply([],arguments),r=t.length,n=[],a=0;a<e;++a)for(var i=this[a],o=0;o<r;++o){var s=t[o];if(i===s||i!==i&&s!==s){n.push(a);break}}for(var u=[],l=0,c=n.length;l<c;++l)u[l]=this[n[l]];for(var d=Array.prototype.splice,f=n.length-1;f>=0;--f)d.call(this,n[f],1);return u}}),Object.defineProperty(Array.prototype,"deleteAt",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.deleteAt called on null or undefined");if(0===arguments.length)return[];var e=this.length>>>0;if(0===e)return[];for(var t=Array.prototype.splice,r=[].concat(_toConsumableArray(new Set(Array.prototype.concat.apply([],arguments).map(function(t){return t<0?Math.max(0,e+t):t})).values())),n=[].concat(_toConsumableArray(r)).sort(function(e,t){return t-e}),a=[],i=0,o=r.length;i<o;++i)a[i]=this[r[i]];for(var s=0,u=n.length;s<u;++s)t.call(this,n[s],1);return a}}),Object.defineProperty(Array.prototype,"deleteWith",{configurable:!0,writable:!0,value:function(e,t){if(null==this)throw new TypeError("Array.prototype.deleteWith called on null or undefined");if("function"!=typeof e)throw new Error("Array.prototype.deleteWith predicate parameter must be a function");var r=this.length>>>0;if(0===r)return[];for(var n=Array.prototype.splice,a=[],i=[],o=0;o<r;++o)e.call(t,this[o],o,this)&&(i.push(this[o]),a.push(o));for(var s=a.length-1;s>=0;--s)n.call(this,a[s],1);return i}}),Object.defineProperty(Array.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.first called on null or undefined");if(0!=this.length>>>0)return this[0]}}),Object.defineProperty(Array.prototype,"includesAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAll called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAll.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var e=0,t=arguments.length;e<t;++e)if(!Array.prototype.some.call(this,function(e){return e===this.val||e!==e&&this.val!==this.val},{val:arguments[e]}))return!1;return!0}}),Object.defineProperty(Array.prototype,"includesAny",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAny called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAny.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var e=0,t=arguments.length;e<t;++e)if(Array.prototype.some.call(this,function(e){return e===this.val||e!==e&&this.val!==this.val},{val:arguments[e]}))return!0;return!1}}),Object.defineProperty(Array.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.last called on null or undefined");var e=this.length>>>0;if(0!==e)return this[e-1]}}),Object.defineProperty(Array.prototype,"pluck",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pluck called on null or undefined");var e=this.length>>>0;if(0!==e){var t=0===arguments.length?_random(0,e-1):_randomIndex(e,[].concat(Array.prototype.slice.call(arguments)));return Array.prototype.splice.call(this,t,1)[0]}}}),Object.defineProperty(Array.prototype,"pluckMany",{configurable:!0,writable:!0,value:function(e){if(null==this)throw new TypeError("Array.prototype.pluckMany called on null or undefined");var t=this.length>>>0;if(0===t)return[];var r=Math.trunc(e);if(!Number.isInteger(r))throw new Error("Array.prototype.pluckMany want parameter must be an integer");if(r<1)return[];r>t&&(r=t);var n=Array.prototype.splice,a=[],i=t-1;do{a.push(n.call(this,_random(0,i--),1)[0])}while(a.length<r);return a}}),Object.defineProperty(Array.prototype,"pushUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pushUnique called on null or undefined");var e=arguments.length;if(0===e)return this.length>>>0;for(var t=Array.prototype.indexOf,r=Array.prototype.push,n=0;n<e;++n){var a=arguments[n];-1===t.call(this,a)&&r.call(this,a)}return this.length>>>0}}),Object.defineProperty(Array.prototype,"random",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.random called on null or undefined");var e=this.length>>>0;if(0!==e){return this[0===arguments.length?_random(0,e-1):_randomIndex(e,[].concat(Array.prototype.slice.call(arguments)))]}}}),Object.defineProperty(Array.prototype,"randomMany",{configurable:!0,writable:!0,value:function(e){if(null==this)throw new TypeError("Array.prototype.randomMany called on null or undefined");var t=this.length>>>0;if(0===t)return[];var r=Math.trunc(e);if(!Number.isInteger(r))throw new Error("Array.prototype.randomMany want parameter must be an integer");if(r<1)return[];r>t&&(r=t);var n=new Map,a=[],i=t-1;do{var o=void 0;do{o=_random(0,i)}while(n.has(o));n.set(o,!0),a.push(this[o])}while(a.length<r);return a}}),Object.defineProperty(Array.prototype,"shuffle",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.shuffle called on null or undefined");var e=this.length>>>0;if(0===e)return this;for(var t=e-1;t>0;--t){var r=Math.floor(_nativeMathRandom()*(t+1));if(t!==r){var n=this[t];this[t]=this[r],this[r]=n}}return this}}),Object.defineProperty(Array.prototype,"unshiftUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.unshiftUnique called on null or undefined");var e=arguments.length;if(0===e)return this.length>>>0;for(var t=Array.prototype.indexOf,r=Array.prototype.unshift,n=0;n<e;++n){var a=arguments[n];-1===t.call(this,a)&&r.call(this,a)}return this.length>>>0}}),Object.defineProperty(Function.prototype,"partial",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Function.prototype.partial called on null or undefined");var e=Array.prototype.slice,t=this,r=e.call(arguments,0);return function(){for(var n=[],a=0,i=0;i<r.length;++i)n.push(r[i]===undefined?arguments[a++]:r[i]);return t.apply(this,n.concat(e.call(arguments,a)))}}}),Object.defineProperty(Math,"clamp",{configurable:!0,writable:!0,value:function(e,t,r){var n=Number(e);return Number.isNaN(n)?NaN:n.clamp(t,r)}}),Object.defineProperty(Math,"easeInOut",{configurable:!0,writable:!0,value:function(e){return 1-(Math.cos(Number(e)*Math.PI)+1)/2}}),Object.defineProperty(Number.prototype,"clamp",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Number.prototype.clamp called on null or undefined");if(2!==arguments.length)throw new Error("Number.prototype.clamp called with an incorrect number of parameters");var e=Number(arguments[0]),t=Number(arguments[1]);if(e>t){var r=[t,e];e=r[0],t=r[1]}return Math.min(Math.max(this,e),t)}}),RegExp.escape||function(){var e=/[\\^$*+?.()|[\]{}]/g,t=new RegExp(e.source);Object.defineProperty(RegExp,"escape",{configurable:!0,writable:!0,value:function(r){var n=String(r);return n&&t.test(n)?n.replace(e,"\\$&"):n}})}(),function(){var e=/{(\d+)(?:,([+-]?\d+))?}/g,t=new RegExp(e.source);Object.defineProperty(String,"format",{configurable:!0,writable:!0,value:function(r){function n(e,t,r){if(!t)return e;var n=Math.abs(t)-e.length;if(n<1)return e;var a=String(r).repeat(n);return t<0?e+a:a+e}if(arguments.length<2)return 0===arguments.length?"":r;var a=2===arguments.length&&Array.isArray(arguments[1])?[].concat(_toConsumableArray(arguments[1])):Array.prototype.slice.call(arguments,1);return 0===a.length?r:t.test(r)?(e.lastIndex=0,r.replace(e,function(e,t,r){var i=a[t];if(null==i)return"";for(;"function"==typeof i;)i=i();switch(void 0===i?"undefined":_typeof(i)){case"string":break;case"object":i=JSON.stringify(i);break;default:i=String(i)}return n(i,r?Number.parseInt(r,10):0," ")})):r}})}(),Object.defineProperty(String.prototype,"contains",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.contains called on null or undefined");return-1!==String.prototype.indexOf.apply(this,arguments)}}),Object.defineProperty(String.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.count called on null or undefined");var e=String(arguments[0]||"");if(""===e)return 0;for(var t=String.prototype.indexOf,r=e.length,n=Number(arguments[1])||0,a=0;-1!==(n=t.call(this,e,n));)++a,n+=r;return a}}),Object.defineProperty(String.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.first called on null or undefined");return _getCodePointStartAndEnd(String(this),0).char}}),Object.defineProperty(String.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.last called on null or undefined");var e=String(this);return _getCodePointStartAndEnd(e,e.length-1).char}}),Object.defineProperty(String.prototype,"splice",{configurable:!0,writable:!0,value:function(e,t,r){if(null==this)throw new TypeError("String.prototype.splice called on null or undefined");var n=this.length>>>0;if(0===n)return"";var a=Number(e);Number.isSafeInteger(a)?a<0&&(a+=n)<0&&(a=0):a=0,a>n&&(a=n);var i=Number(t);(!Number.isSafeInteger(i)||i<0)&&(i=0);var o=this.slice(0,a);return void 0!==r&&(o+=r),a+i<n&&(o+=this.slice(a+i)),o}}),Object.defineProperty(String.prototype,"splitOrEmpty",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.splitOrEmpty called on null or undefined");return""===String(this)?[]:String.prototype.split.apply(this,arguments)}}),Object.defineProperty(String.prototype,"toLocaleUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toLocaleUpperFirst called on null or undefined");var e=String(this),t=_getCodePointStartAndEnd(e,0),r=t.char,n=t.end;return-1===n?"":r.toLocaleUpperCase()+e.slice(n+1)}}),Object.defineProperty(String.prototype,"toUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toUpperFirst called on null or undefined");var e=String(this),t=_getCodePointStartAndEnd(e,0),r=t.char,n=t.end;return-1===n?"":r.toUpperCase()+e.slice(n+1)}}),Object.defineProperty(Date.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:date)",this.toISOString()]}}),Object.defineProperty(Function.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:eval)","("+this.toString()+")"]}}),Object.defineProperty(Map.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:map)",[].concat(_toConsumableArray(this))]}}),Object.defineProperty(RegExp.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:eval)",this.toString()]}}),Object.defineProperty(Set.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:set)",[].concat(_toConsumableArray(this))]}}),Object.defineProperty(JSON,"reviveWrapper",{configurable:!0,writable:!0,value:function(e,t){if("string"!=typeof e)throw new TypeError("JSON.reviveWrapper code parameter must be a string");return["(revive:eval)",[e,t]]}}),Object.defineProperty(JSON,"_real_parse",{value:JSON.parse}),Object.defineProperty(JSON,"parse",{configurable:!0,writable:!0,value:function value(text,reviver){return JSON._real_parse(text,function(key,val){var value=val;if(Array.isArray(value)&&2===value.length)switch(value[0]){case"(revive:set)":value=new Set(value[1]);break;case"(revive:map)":value=new Map(value[1]);break;case"(revive:date)":value=new Date(value[1]);break;case"(revive:eval)":try{if(Array.isArray(value[1])){var $ReviveData$=value[1][1];value=eval(value[1][0])}else value=eval(value[1])}catch(e){}}else if("string"==typeof value&&"@@revive@@"===value.slice(0,10))try{value=eval(value.slice(10))}catch(e){}if("function"==typeof reviver)try{value=reviver(key,value)}catch(e){}return value})}}),Object.defineProperty(Array.prototype,"contains",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.contains called on null or undefined");return Array.prototype.includes.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"containsAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.containsAll called on null or undefined");return Array.prototype.includesAll.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"containsAny",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.containsAny called on null or undefined");return Array.prototype.includesAny.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"flatten",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.flatten called on null or undefined");return Array.prototype.flat.call(this,1/0)}}),Object.defineProperty(String.prototype,"readBracketedList",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.readBracketedList called on null or undefined");for(var e=new RegExp("(?:\\[\\[((?:\\s|\\S)*?)\\]\\])|([^\"'\\s]\\S*)","gm"),t=[],r=void 0;null!==(r=e.exec(this));)r[1]?t.push(r[1]):r[2]&&t.push(r[2]);return t}})}();var Browser=function(){var e=navigator.userAgent.toLowerCase(),t=e.includes("windows phone"),r=Object.freeze({Android:!t&&e.includes("android"),BlackBerry:/blackberry|bb10/.test(e),iOS:!t&&/ip(?:hone|ad|od)/.test(e),Opera:!t&&("object"===_typeof(window.operamini)||e.includes("opera mini")),Windows:t||/iemobile|wpdesktop/.test(e),any:function(){return r.Android||r.BlackBerry||r.iOS||r.Opera||r.Windows}}),n=!r.Windows&&!/khtml|trident|edge/.test(e)&&e.includes("gecko"),a=!e.includes("opera")&&/msie|trident/.test(e),i=a?function(){var t=/(?:msie\s+|rv:)(\d+\.\d)/.exec(e);return t?Number(t[1]):0}():null,o=e.includes("opera")||e.includes(" opr/"),s=o?function(){var t=new RegExp((/khtml|chrome/.test(e)?"opr":"version")+"\\/(\\d+\\.\\d+)"),r=t.exec(e);return r?Number(r[1]):0}():null,u=e.includes("vivaldi");return Object.freeze({userAgent:e,isMobile:r,isGecko:n,isIE:a,ieVersion:i,isOpera:o,operaVersion:s,isVivaldi:u})}(),Has=function(){var e=function(){try{return"function"==typeof document.createElement("audio").canPlayType}catch(e){}return!1}(),t=e&&function(){try{var e=document.createElement("audio").play();return e.catch(function(){}),e instanceof Promise}catch(e){}return!1}(),r=function(){try{return"Blob"in window&&"File"in window&&"FileList"in window&&"FileReader"in window&&!Browser.isMobile.any()&&(!Browser.isOpera||Browser.operaVersion>=15)}catch(e){}return!1}(),n=function(){try{return"geolocation"in navigator&&"function"==typeof navigator.geolocation.getCurrentPosition&&"function"==typeof navigator.geolocation.watchPosition}catch(e){}return!1}(),a=function(){try{return"MutationObserver"in window&&"function"==typeof window.MutationObserver}catch(e){}return!1}(),i=function(){try{return"performance"in window&&"function"==typeof window.performance.now}catch(e){}return!1}(),o=function(){try{return"ontouchstart"in window||!!window.DocumentTouch&&document instanceof window.DocumentTouch||!!navigator.maxTouchPoints||!!navigator.msMaxTouchPoints}catch(e){}return!1}(),s=function(){try{for(var e=new Map([["transition","transitionend"],["MSTransition","msTransitionEnd"],["WebkitTransition","webkitTransitionEnd"],["MozTransition","transitionend"]]),t=[].concat(_toConsumableArray(e.keys())),r=document.createElement("div"),n=0;n<t.length;++n)if(r.style[t[n]]!==undefined)return e.get(t[n])}catch(e){}return!1}();return Object.freeze({audio:e,audioPromise:t,fileAPI:r,geolocation:n,mutationObserver:a,performance:i,touch:o,transitionEndEvent:s})}(),Visibility=function(){function e(){return Boolean(r&&document[r.hiddenProperty])}function t(){return r&&document[r.stateProperty]||"visible"}var r=function(){try{return Object.freeze([{hiddenProperty:"hidden",stateProperty:"visibilityState",changeEvent:"visibilitychange"},{hiddenProperty:"webkitHidden",stateProperty:"webkitVisibilityState",changeEvent:"webkitvisibilitychange"},{hiddenProperty:"mozHidden",stateProperty:"mozVisibilityState",changeEvent:"mozvisibilitychange"},{hiddenProperty:"msHidden",stateProperty:"msVisibilityState",changeEvent:"msvisibilitychange"}].find(function(e){return e.hiddenProperty in document}))}catch(e){}return null}();return Object.freeze(Object.defineProperties({},{isHidden:{value:e},state:{value:t},hiddenProperty:{value:r.hiddenProperty},stateProperty:{value:r.stateProperty},changeEvent:{value:r.changeEvent}}))}(),_ref3=function(){function e(t){if("object"!==(void 0===t?"undefined":_typeof(t))||null===t)return t;if(t instanceof String)return String(t);if(t instanceof Number)return Number(t);if(t instanceof Boolean)return Boolean(t);if("function"==typeof t.clone)return t.clone(!0);if(t.nodeType&&"function"==typeof t.cloneNode)return t.cloneNode(!0);var r=void 0;return t instanceof Array?r=new Array(t.length):t instanceof Date?r=new Date(t.getTime()):t instanceof Map?(r=new Map,t.forEach(function(t,n){return r.set(n,e(t))})):t instanceof RegExp?r=new RegExp(t):t instanceof Set?(r=new Set,t.forEach(function(t){return r.add(e(t))})):r=Object.create(Object.getPrototypeOf(t)),Object.keys(t).forEach(function(n){return r[n]=e(t[n])}),r}function t(e){for(var t=document.createDocumentFragment(),r=document.createElement("p"),n=void 0;null!==(n=e.firstChild);){if(n.nodeType===Node.ELEMENT_NODE){switch(n.nodeName.toUpperCase()){case"BR":if(null!==n.nextSibling&&n.nextSibling.nodeType===Node.ELEMENT_NODE&&"BR"===n.nextSibling.nodeName.toUpperCase()){e.removeChild(n.nextSibling),e.removeChild(n),t.appendChild(r),r=document.createElement("p");continue}if(!r.hasChildNodes()){e.removeChild(n);continue}break;case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":r.hasChildNodes()&&(t.appendChild(r),r=document.createElement("p")),t.appendChild(n);continue}}r.appendChild(n)}r.hasChildNodes()&&t.appendChild(r),e.appendChild(t)}function r(){try{return document.activeElement||null}catch(e){return null}}function n(e,t,r){var n="object"===(void 0===e?"undefined":_typeof(e))?e:document.getElementById(e);if(null==n)return null;var a=Array.isArray(t)?t:[t];jQuery(n).empty();for(var i=0,o=a.length;i<o;++i)if(Story.has(a[i]))return new Wikifier(n,Story.get(a[i]).processText().trim()),n;if(null!=r){var s=String(r).trim();""!==s&&new Wikifier(n,s)}return n}function a(e,t,r){var n=jQuery(document.createElement("div")),a=jQuery(document.createElement("button")),i=jQuery(document.createElement("pre")),o=L10n.get("errorTitle")+": "+(t||"unknown error");return a.addClass("error-toggle").ariaClick({label:L10n.get("errorToggle")},function(){a.hasClass("enabled")?(a.removeClass("enabled"),i.attr({"aria-hidden":!0,hidden:"hidden"})):(a.addClass("enabled"),i.removeAttr("aria-hidden hidden"))}).appendTo(n),jQuery(document.createElement("span")).addClass("error").text(o).appendTo(n),jQuery(document.createElement("code")).text(r).appendTo(i),i.addClass("error-source").attr({"aria-hidden":!0,hidden:"hidden"}).appendTo(n),n.addClass("error-view").appendTo(e),console.warn(o+"\n\t"+r.replace(/\n/g,"\n\t")),!1}function i(e,t){var r=i;switch(void 0===e?"undefined":_typeof(e)){case"number":if(Number.isNaN(e))return t;break;case"object":if(null===e)return t;if(Array.isArray(e))return e.map(function(e){return r(e,t)}).join(", ");if(e instanceof Set)return[].concat(_toConsumableArray(e)).map(function(e){return r(e,t)}).join(", ");if(e instanceof Map){return"{ "+[].concat(_toConsumableArray(e)).map(function(e){var n=_slicedToArray(e,2),a=n[0],i=n[1];return r(a,t)+" → "+r(i,t)}).join(", ")+" }"}return e instanceof Date?e.toLocaleString():"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e);case"function":case"undefined":return t}return String(e)}return Object.freeze(Object.defineProperties({},{clone:{value:e},convertBreaks:{value:t},safeActiveElement:{value:r},setPageElement:{value:n},throwError:{value:a},toStringOrDefault:{value:i}}))
}(),clone=_ref3.clone,convertBreaks=_ref3.convertBreaks,safeActiveElement=_ref3.safeActiveElement,setPageElement=_ref3.setPageElement,throwError=_ref3.throwError,toStringOrDefault=_ref3.toStringOrDefault;!function(){function e(e){13!==e.which&&32!==e.which||(e.preventDefault(),jQuery(safeActiveElement()||this).trigger("click"))}function t(e){return function(){var t=jQuery(this);t.ariaIsDisabled()||(t.is("[aria-pressed]")&&t.attr("aria-pressed","true"===t.attr("aria-pressed")?"false":"true"),e.apply(this,arguments))}}function r(e){return t(function(){jQuery(this).off(".aria-clickable").removeAttr("tabindex aria-controls aria-pressed").not("a,button").removeAttr("role").end().filter("button").prop("disabled",!0),e.apply(this,arguments)})}jQuery.fn.extend({ariaClick:function(n,a){if(0===this.length||0===arguments.length)return this;var i=n,o=a;return null==o&&(o=i,i=undefined),i=jQuery.extend({namespace:undefined,one:!1,selector:undefined,data:undefined,controls:undefined,pressed:undefined,label:undefined},i),"string"!=typeof i.namespace?i.namespace="":"."!==i.namespace[0]&&(i.namespace="."+i.namespace),"boolean"==typeof i.pressed&&(i.pressed=i.pressed?"true":"false"),this.filter("button").prop("type","button"),this.not("a,button").attr("role","button"),this.attr("tabindex",0),null!=i.controls&&this.attr("aria-controls",i.controls),null!=i.pressed&&this.attr("aria-pressed",i.pressed),null!=i.label&&this.attr({"aria-label":i.label,title:i.label}),this.not("button").on("keypress.aria-clickable"+i.namespace,i.selector,e),this.on("click.aria-clickable"+i.namespace,i.selector,i.data,i.one?r(o):t(o)),this},ariaDisabled:function(e){if(0===this.length||0===arguments.length)return this;var t=this.not("button,fieldset,input,menuitem,optgroup,option,select,textarea"),r=this.filter("button,fieldset,input,menuitem,optgroup,option,select,textarea");return e?(t.each(function(){this.setAttribute("disabled",""),this.setAttribute("aria-disabled","")}),r.each(function(){this.disabled=!0,this.setAttribute("aria-disabled","")})):(t.each(function(){this.removeAttribute("disabled"),this.removeAttribute("aria-disabled")}),r.each(function(){this.disabled=!1,this.removeAttribute("aria-disabled")})),this},ariaIsDisabled:function(){return this.is("[disabled]")}})}(),function(){jQuery.extend({wikiWithOptions:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(0!==r.length){var a=document.createDocumentFragment();r.forEach(function(t){return new Wikifier(a,t,e)});var i=[].concat(_toConsumableArray(a.querySelectorAll(".error"))).map(function(e){return e.textContent.replace(errorPrologRegExp,"")});if(i.length>0)throw new Error(i.join("; "))}},wiki:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.wikiWithOptions.apply(this,[undefined].concat(t))}}),jQuery.fn.extend({wikiWithOptions:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(0===this.length||0===r.length)return this;var a=document.createDocumentFragment();return r.forEach(function(t){return new Wikifier(a,t,e)}),this.append(a),this},wiki:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.wikiWithOptions.apply(this,[undefined].concat(t))}})}();var Util=function(){function e(e){if(e instanceof Array)return Object.freeze(e.reduce(function(e,t,r){return e[t]=r,e},Object.create(null)));if(e instanceof Object)return Object.freeze(Object.assign(Object.create(null),e));throw new TypeError("Util.toEnum obj parameter must be an array or generic object")}function t(e){return Object.prototype.toString.call(e).slice(8,-1)}function r(e){if(null===e)return"null";var t=void 0===e?"undefined":_typeof(e);return"object"===t?Object.prototype.toString.call(e).slice(8,-1):t}function n(e){var t=void 0;switch(void 0===e?"undefined":_typeof(e)){case"number":t=e;break;case"string":t=Number(e);break;default:return!1}return!Number.isNaN(t)&&Number.isFinite(t)}function a(e){return"boolean"==typeof e||"string"==typeof e&&("true"===e||"false"===e)}function i(e,t){return e===t||e!==e&&t!==t}function o(e){var t=String(e).trim(),r=t.replace(/[^\w\s\u2013\u2014-]+/g,"").replace(/[_\s\u2013\u2014-]+/g,"-").toLocaleLowerCase();return v.test(r)?t.replace(m,"").replace(/[_\s\u2013\u2014-]+/g,"-"):r}function s(e){if(null==e)return"";var t=String(e);return t&&b.test(t)?t.replace(y,function(e){return w[e]}):t}function u(e){if(null==e)return"";var t=String(e);return t&&S.test(t)?t.replace(k,function(e){return E[e.toLowerCase()]}):t}function l(e,t){var r=String(e),n=Math.trunc(t),a=r.charCodeAt(n);if(Number.isNaN(a))return{char:"",start:-1,end:-1};var i={char:r.charAt(n),start:n,end:n};if(a<55296||a>57343)return i;if(a>=55296&&a<=56319){var o=n+1;if(o>=r.length)return i;var s=r.charCodeAt(o);return s<56320||s>57343?i:(i.char=i.char+r.charAt(o),i.end=o,i)}if(0===n)return i;var u=n-1,l=r.charCodeAt(u);return l<55296||l>56319?i:(i.char=r.charAt(u)+i.char,i.start=u,i)}function c(){return j.now()}function d(e){var t=x.exec(String(e));if(null===t)throw new SyntaxError('invalid time value syntax: "'+e+'"');var r=Number(t[1]);if(1===t[2].length&&(r*=1e3),Number.isNaN(r)||!Number.isFinite(r))throw new RangeError('invalid time value: "'+e+'"');return r}function f(e){if("number"!=typeof e||Number.isNaN(e)||!Number.isFinite(e)){var r=void 0;switch(void 0===e?"undefined":_typeof(e)){case"string":r='"'+e+'"';break;case"number":r=String(e);break;default:r=t(e)}throw new Error("invalid milliseconds: "+r)}return e+"ms"}function p(e){if(!e.includes("-"))switch(e){case"bgcolor":return"backgroundColor";case"float":return"cssFloat";default:return e}return("-ms-"===e.slice(0,4)?e.slice(1):e).split("-").map(function(e,t){return 0===t?e:e.toUpperFirst()}).join("")}function h(e){var t=document.createElement("a"),r=Object.create(null);t.href=e,t.search&&t.search.replace(/^\?/,"").splitOrEmpty(/(?:&(?:amp;)?|;)/).forEach(function(e){var t=e.split("="),n=_slicedToArray(t,2),a=n[0],i=n[1];r[a]=i});var n=t.host&&"/"!==t.pathname[0]?"/"+t.pathname:t.pathname;return{href:t.href,protocol:t.protocol,host:t.host,hostname:t.hostname,port:t.port,path:""+n+t.search,pathname:n,query:t.search,search:t.search,queries:r,searches:r,hash:t.hash}}function g(e,t,r){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)throw new Error("Util.newExceptionFrom original parameter must be an object");if("function"!=typeof t)throw new Error("Util.newExceptionFrom exceptionType parameter must be an error type constructor");var n=new t(e.message);void 0!==e.name&&(n.name=e.name),void 0!==e.code&&(n.code=e.code),void 0!==e.columnNumber&&(n.columnNumber=e.columnNumber),void 0!==e.description&&(n.description=e.description),void 0!==e.fileName&&(n.fileName=e.fileName),void 0!==e.lineNumber&&(n.lineNumber=e.lineNumber),void 0!==e.number&&(n.number=e.number),void 0!==e.stack&&(n.stack=e.stack);var a=void 0===r?"undefined":_typeof(r);if("undefined"!==a)if("object"===a&&null!==r)Object.assign(n,r);else{if("string"!==a)throw new Error("Util.newExceptionFrom override parameter must be an object or string");n.message=r}return n}var m=/[\x00-\x1f"#$%&'*+,\/:;<=>?\\^`|\x7f-\x9f]+/g,v=/^-*$/,y=/[&<>"'`]/g,b=new RegExp(y.source),w=Object.freeze({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"}),k=/&(?:amp|#38|#x26|lt|#60|#x3c|gt|#62|#x3e|quot|#34|#x22|apos|#39|#x27|#96|#x60);/gi,S=new RegExp(k.source,"i"),E=Object.freeze({"&amp;":"&","&#38;":"&","&#x26;":"&","&lt;":"<","&#60;":"<","&#x3c;":"<","&gt;":">","&#62;":">","&#x3e;":">","&quot;":'"',"&#34;":'"',"&#x22;":'"',"&apos;":"'","&#39;":"'","&#x27;":"'","&#96;":"`","&#x60;":"`"}),j=Has.performance?performance:Date,x=/^([+-]?(?:\d*\.)?\d+)([Mm]?[Ss])$/;return Object.freeze(Object.defineProperties({},{toEnum:{value:e},toStringTag:{value:t},getType:{value:r},isNumeric:{value:n},isBoolean:{value:a},sameValueZero:{value:i},slugify:{value:o},escape:{value:s},unescape:{value:u},charAndPosAt:{value:l},fromCssTime:{value:d},toCssTime:{value:f},fromCssProperty:{value:p},parseUrl:{value:h},newExceptionFrom:{value:g},now:{value:c},random:{value:Math.random},entityEncode:{value:s},entityDecode:{value:u},evalExpression:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}},evalStatements:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}}}))}(),SimpleStore=function(){function e(e,n){if(r)return r.create(e,n);for(var a=0;a<t.length;++a)if(t[a].init(e,n))return r=t[a],r.create(e,n);throw new Error("no valid storage adapters found")}var t=[],r=null;return Object.freeze(Object.defineProperties({},{adapters:{value:t},create:{value:e}}))}();SimpleStore.adapters.push(function(){function e(){function e(e){try{var t=window[e],r="_sc_"+String(Date.now());t.setItem(r,r);var n=t.getItem(r)===r;return t.removeItem(r),n}catch(e){}return!1}return r=e("localStorage")&&e("sessionStorage")}function t(e,t){if(!r)throw new Error("adapter not initialized");return new n(e,t)}var r=!1,n=function(){function e(t,r){_classCallCheck(this,e);var n=t+".",a=null,i=null;r?(a=window.localStorage,i="localStorage"):(a=window.sessionStorage,i="sessionStorage"),Object.defineProperties(this,{_engine:{value:a},_prefix:{value:n},_prefixRe:{value:new RegExp("^"+RegExp.escape(n))},name:{value:i},id:{value:t},persistent:{value:!!r}})}return _createClass(e,[{key:"size",value:function(){return this.keys().length}},{key:"keys",value:function(){for(var e=[],t=0;t<this._engine.length;++t){var r=this._engine.key(t);this._prefixRe.test(r)&&e.push(r.replace(this._prefixRe,""))}return e}},{key:"has",value:function(e){return!("string"!=typeof e||!e)&&this._engine.hasOwnProperty(this._prefix+e)}},{key:"get",value:function(t){if("string"!=typeof t||!t)return null;var r=this._engine.getItem(this._prefix+t);return null==r?null:e._deserialize(r)}},{key:"set",value:function(t,r){if("string"!=typeof t||!t)return!1;try{this._engine.setItem(this._prefix+t,e._serialize(r))}catch(e){if(/quota.?(?:exceeded|reached)/i.test(e.name+e.message))throw Util.newExceptionFrom(e,Error,this.name+" quota exceeded");throw e}return!0}},{key:"delete",value:function(e){return!("string"!=typeof e||!e)&&(this._engine.removeItem(this._prefix+e),!0)}},{key:"clear",value:function(){for(var e=this.keys(),t=0,r=e.length;t<r;++t)this.delete(e[t]);return!0}},{key:"length",get:function(){return this.keys().length}}],[{key:"_serialize",value:function(e){return LZString.compressToUTF16(JSON.stringify(e))}},{key:"_deserialize",value:function(e){return JSON.parse(LZString.decompressFromUTF16(e))}}]),e}();return Object.freeze(Object.defineProperties({},{init:{value:e},create:{value:t}}))}()),SimpleStore.adapters.push(function(){function e(e){try{var t="_sc_"+String(Date.now());o._setCookie(t,o._serialize(t),undefined),i=o._deserialize(o._getCookie(t))===t,o._setCookie(t,undefined,a)}catch(e){i=!1}return i&&r(e),i}function t(e,t){if(!i)throw new Error("adapter not initialized");return new o(e,t)}function r(e){if(""!==document.cookie)for(var t=e+".",r=new RegExp("^"+RegExp.escape(t)),i=e+"!.",s=e+"*.",u=/\.(?:state|rcWarn)$/,l=document.cookie.split(/;\s*/),c=0;c<l.length;++c){var d=l[c].split("="),f=decodeURIComponent(d[0]);if(r.test(f)){var p=decodeURIComponent(d[1]);""!==p&&function(){var e=!u.test(f);o._setCookie(f,undefined,a),o._setCookie(f.replace(r,function(){return e?i:s}),p,e?n:undefined)}()}}}var n="Tue, 19 Jan 2038 03:14:07 GMT",a="Thu, 01 Jan 1970 00:00:00 GMT",i=!1,o=function(){function e(t,r){_classCallCheck(this,e);var n=t+(r?"!":"*")+".";Object.defineProperties(this,{_prefix:{value:n},_prefixRe:{value:new RegExp("^"+RegExp.escape(n))},name:{value:"cookie"},id:{value:t},persistent:{value:!!r}})}return _createClass(e,[{key:"size",value:function(){return this.keys().length}},{key:"keys",value:function(){if(""===document.cookie)return[];for(var e=document.cookie.split(/;\s*/),t=[],r=0;r<e.length;++r){var n=e[r].split("="),a=decodeURIComponent(n[0]);if(this._prefixRe.test(a)){""!==decodeURIComponent(n[1])&&t.push(a.replace(this._prefixRe,""))}}return t}},{key:"has",value:function(t){return!("string"!=typeof t||!t)&&null!==e._getCookie(this._prefix+t)}},{key:"get",value:function(t){if("string"!=typeof t||!t)return null;var r=e._getCookie(this._prefix+t);return null===r?null:e._deserialize(r)}},{key:"set",value:function(t,r){if("string"!=typeof t||!t)return!1;try{if(e._setCookie(this._prefix+t,e._serialize(r),this.persistent?n:undefined),!this.has(t))throw new Error("unknown validation error during set")}catch(e){throw Util.newExceptionFrom(e,Error,"cookie error: "+e.message)}return!0}},{key:"delete",value:function(t){if("string"!=typeof t||!t||!this.has(t))return!1;try{if(e._setCookie(this._prefix+t,undefined,a),this.has(t))throw new Error("unknown validation error during delete")}catch(e){throw Util.newExceptionFrom(e,Error,"cookie error: "+e.message)}return!0}},{key:"clear",value:function(){for(var e=this.keys(),t=0,r=e.length;t<r;++t)this.delete(e[t]);return!0}},{key:"length",get:function(){return this.keys().length}}],[{key:"_getCookie",value:function(e){if(!e||""===document.cookie)return null;for(var t=document.cookie.split(/;\s*/),r=0;r<t.length;++r){var n=t[r].split("=");if(e===decodeURIComponent(n[0])){return decodeURIComponent(n[1])||null}}return null}},{key:"_setCookie",value:function(e,t,r){if(e){var n=encodeURIComponent(e)+"=";null!=t&&(n+=encodeURIComponent(t)),null!=r&&(n+="; expires="+r),n+="; path=/",document.cookie=n}}},{key:"_serialize",value:function(e){return LZString.compressToBase64(JSON.stringify(e))}},{key:"_deserialize",value:function(e){return JSON.parse(LZString.decompressFromBase64(e))}}]),e}();return Object.freeze(Object.defineProperties({},{init:{value:e},create:{value:t}}))}());var DebugView=function(){return function(){function e(t,r,n,a){_classCallCheck(this,e),Object.defineProperties(this,{parent:{value:t},view:{value:document.createElement("span")},break:{value:document.createElement("wbr")}}),jQuery(this.view).attr({title:a,"aria-label":a,"data-type":null!=r?r:"","data-name":null!=n?n:""}).addClass("debug"),jQuery(this.break).addClass("debug hidden"),this.parent.appendChild(this.view),this.parent.appendChild(this.break)}return _createClass(e,[{key:"append",value:function(e){return jQuery(this.view).append(e),this}},{key:"modes",value:function(e){if(null==e){var t={};return this.view.className.splitOrEmpty(/\s+/).forEach(function(e){"debug"!==e&&(t[e]=!0)}),t}if("object"===(void 0===e?"undefined":_typeof(e)))return Object.keys(e).forEach(function(t){this[e[t]?"addClass":"removeClass"](t)},jQuery(this.view)),this;throw new Error("DebugView.prototype.modes options parameter must be an object or null/undefined")}},{key:"remove",value:function(){var e=jQuery(this.view);this.view.hasChildNodes()&&e.contents().appendTo(this.parent),e.remove(),jQuery(this.break).remove()}},{key:"output",get:function(){return this.view}},{key:"type",get:function(){return this.view.getAttribute("data-type")},set:function(e){this.view.setAttribute("data-type",null!=e?e:"")}},{key:"name",get:function(){return this.view.getAttribute("data-name")},set:function(e){this.view.setAttribute("data-name",null!=e?e:"")}},{key:"title",get:function(){return this.view.title},set:function(e){this.view.title=e}}],[{key:"isEnabled",value:function(){return"enabled"===jQuery(document.documentElement).attr("data-debug-view")}},{key:"enable",value:function(){jQuery(document.documentElement).attr("data-debug-view","enabled"),jQuery.event.trigger(":debugviewupdate")}},{key:"disable",value:function(){jQuery(document.documentElement).removeAttr("data-debug-view"),jQuery.event.trigger(":debugviewupdate")}},{key:"toggle",value:function(){"enabled"===jQuery(document.documentElement).attr("data-debug-view")?e.disable():e.enable()}}]),e}()}(),PRNGWrapper=function(){return function(){function e(t,r){_classCallCheck(this,e),Object.defineProperties(this,new Math.seedrandom(t,r,function(e,t){return{_prng:{value:e},seed:{writable:!0,value:t},pull:{writable:!0,value:0},random:{value:function(){return++this.pull,this._prng()}}}}))}return _createClass(e,null,[{key:"marshal",value:function(e){if(!e||!e.hasOwnProperty("seed")||!e.hasOwnProperty("pull"))throw new Error("PRNG is missing required data");return{seed:e.seed,pull:e.pull}}},{key:"unmarshal",value:function(t){if(!t||!t.hasOwnProperty("seed")||!t.hasOwnProperty("pull"))throw new Error("PRNG object is missing required data");for(var r=new e(t.seed,!1),n=t.pull;n>0;--n)r.random();return r}}]),e}()}(),StyleWrapper=function(){var e=new RegExp(Patterns.cssImage,"g"),t=new RegExp(Patterns.cssImage);return function(){function r(e){if(_classCallCheck(this,r),null==e)throw new TypeError("StyleWrapper style parameter must be an HTMLStyleElement object");Object.defineProperties(this,{style:{value:e}})}return _createClass(r,[{key:"isEmpty",value:function(){return 0===this.style.cssRules.length}},{key:"set",value:function(e){this.clear(),this.add(e)}},{key:"add",value:function(r){var n=r;t.test(n)&&(e.lastIndex=0,n=n.replace(e,function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup({source:e,matchStart:0});if(t.hasOwnProperty("error")||t.pos<e.length)return e;var r=t.source;if("data:"!==r.slice(0,5)&&Story.has(r)){var n=Story.get(r);n.tags.includes("Twine.image")&&(r=n.text.trim())}return'url("'+r.replace(/"/g,"%22")+'")'})),this.style.styleSheet?this.style.styleSheet.cssText+=n:this.style.appendChild(document.createTextNode(n))}},{key:"clear",value:function(){this.style.styleSheet?this.style.styleSheet.cssText="":jQuery(this.style).empty()}}]),r}()}(),Diff=function(){function e(t,n){for(var a=Object.prototype.toString,i=t instanceof Array,o=[].concat(Object.keys(t),Object.keys(n)).sort().filter(function(e,t,r){return 0===t||r[t-1]!==e}),s={},u=void 0,l=function(e){return e===u},c=0,d=o.length;c<d;++c){var f=o[c],p=t[f],h=n[f];if(t.hasOwnProperty(f))if(n.hasOwnProperty(f)){if(p===h)continue;if((void 0===p?"undefined":_typeof(p))===(void 0===h?"undefined":_typeof(h)))if("function"==typeof p)p.toString()!==h.toString()&&(s[f]=[r.Copy,h]);else if("object"!==(void 0===p?"undefined":_typeof(p))||null===p)s[f]=[r.Copy,h];else{var g=a.call(p),m=a.call(h);if(g===m)if(p instanceof Date)Number(p)!==Number(h)&&(s[f]=[r.Copy,clone(h)]);else if(p instanceof Map)s[f]=[r.Copy,clone(h)];else if(p instanceof RegExp)p.toString()!==h.toString()&&(s[f]=[r.Copy,clone(h)]);else if(p instanceof Set)s[f]=[r.Copy,clone(h)];else if("[object Object]"!==g)s[f]=[r.Copy,clone(h)];else{var v=e(p,h);null!==v&&(s[f]=v)}else s[f]=[r.Copy,clone(h)]}else s[f]=[r.Copy,"object"!==(void 0===h?"undefined":_typeof(h))||null===h?h:clone(h)]}else if(i&&Util.isNumeric(f)){var y=Number(f);if(!u){u="";do{u+="~"}while(o.some(l));s[u]=[r.SpliceArray,y,y]}y<s[u][1]&&(s[u][1]=y),y>s[u][2]&&(s[u][2]=y)}else s[f]=r.Delete;else s[f]=[r.Copy,"object"!==(void 0===h?"undefined":_typeof(h))||null===h?h:clone(h)]}return Object.keys(s).length>0?s:null}function t(e,n){for(var a=Object.keys(n||{}),i=clone(e),o=0,s=a.length;o<s;++o){var u=a[o],l=n[u];if(l===r.Delete)delete i[u];else if(l instanceof Array)switch(l[0]){case r.SpliceArray:i.splice(l[1],l[2]-l[1]+1);break;case r.Copy:i[u]=clone(l[1]);break;case r.CopyDate:i[u]=new Date(l[1])}else i[u]=t(i[u],l)}return i}var r=Util.toEnum({Delete:0,SpliceArray:1,Copy:2,CopyDate:3});return Object.freeze(Object.defineProperties({},{Op:{value:r},diff:{value:e},patch:{value:t}}))}(),L10n=function(){function e(){r()}function t(e,t){if(!e)return"";var r=function(e){var t=void 0;return e.some(function(e){return!!l10nStrings.hasOwnProperty(e)&&(t=e,!0)}),t}(Array.isArray(e)?e:[e]);if(!r)return"";for(var i=l10nStrings[r],o=0;a.test(i);){if(++o>50)throw new Error("L10n.get exceeded maximum replacement iterations, probable infinite loop");n.lastIndex=0,i=i.replace(n,function(e){var r=e.slice(1,-1);return t&&t.hasOwnProperty(r)?t[r]:l10nStrings.hasOwnProperty(r)?l10nStrings[r]:void 0})}return i}function r(){strings&&Object.keys(strings).length>0&&Object.keys(l10nStrings).forEach(function(e){try{var t=void 0;switch(e){case"identity":t=strings.identity;break;case"aborting":t=strings.aborting;break;case"cancel":t=strings.cancel;break;case"close":t=strings.close;break;case"ok":t=strings.ok;break;case"errorTitle":t=strings.errors.title;break;case"errorNonexistentPassage":t=strings.errors.nonexistentPassage;break;case"errorSaveMissingData":t=strings.errors.saveMissingData;break;case"errorSaveIdMismatch":t=strings.errors.saveIdMismatch;break;case"warningDegraded":t=strings.warnings.degraded;break;case"debugViewTitle":t=strings.debugView.title;break;case"debugViewToggle":t=strings.debugView.toggle;break;case"uiBarToggle":t=strings.uiBar.toggle;break;case"uiBarBackward":t=strings.uiBar.backward;break;case"uiBarForward":t=strings.uiBar.forward;break;case"uiBarJumpto":t=strings.uiBar.jumpto;break;case"jumptoTitle":t=strings.jumpto.title;break;case"jumptoTurn":t=strings.jumpto.turn;break;case"jumptoUnavailable":t=strings.jumpto.unavailable;break;case"savesTitle":t=strings.saves.title;break;case"savesDisallowed":t=strings.saves.disallowed;break;case"savesIncapable":t=strings.saves.incapable;break;case"savesLabelAuto":t=strings.saves.labelAuto;break;case"savesLabelDelete":t=strings.saves.labelDelete;break;case"savesLabelExport":t=strings.saves.labelExport;break;case"savesLabelImport":t=strings.saves.labelImport;break;case"savesLabelLoad":t=strings.saves.labelLoad;break;case"savesLabelClear":t=strings.saves.labelClear;break;case"savesLabelSave":t=strings.saves.labelSave;break;case"savesLabelSlot":t=strings.saves.labelSlot;break;case"savesUnavailable":t=strings.saves.unavailable;break;case"savesUnknownDate":t=strings.saves.unknownDate;break;case"settingsTitle":t=strings.settings.title;break;case"settingsOff":t=strings.settings.off;break;case"settingsOn":t=strings.settings.on;break;case"settingsReset":t=strings.settings.reset;break;case"restartTitle":t=strings.restart.title;break;case"restartPrompt":t=strings.restart.prompt;break;case"shareTitle":t=strings.share.title;break;case"autoloadTitle":t=strings.autoload.title;break;case"autoloadCancel":t=strings.autoload.cancel;break;case"autoloadOk":t=strings.autoload.ok;break;case"autoloadPrompt":t=strings.autoload.prompt;break;case"macroBackText":t=strings.macros.back.text;break;case"macroReturnText":t=strings.macros.return.text}t&&(l10nStrings[e]=t.replace(/%\w+%/g,function(e){return"{"+e.slice(1,-1)+"}"}))}catch(e){}})}var n=/\{\w+\}/g,a=new RegExp(n.source);return Object.freeze(Object.defineProperties({},{init:{value:e},get:{value:t}}))}(),strings={errors:{},warnings:{},debugView:{},uiBar:{},jumpto:{},saves:{},settings:{},restart:{},share:{},autoload:{},macros:{back:{},return:{}}},l10nStrings={identity:"game",aborting:"Aborting",cancel:"Cancel",close:"Close",ok:"OK",errorTitle:"Error",errorToggle:"Toggle the error view",errorNonexistentPassage:'the passage "{passage}" does not exist',errorSaveMissingData:"save is missing required data. Either the loaded file is not a save or the save has become corrupted",errorSaveIdMismatch:"save is from the wrong {identity}",_warningIntroLacking:"Your browser either lacks or has disabled",_warningOutroDegraded:", so this {identity} is running in a degraded mode. You may be able to continue, however, some parts may not work properly.",warningNoWebStorage:"{_warningIntroLacking} the Web Storage API{_warningOutroDegraded}",warningDegraded:"{_warningIntroLacking} some of the capabilities required by this {identity}{_warningOutroDegraded}",debugBarToggle:"Toggle the debug bar",debugBarNoWatches:"— no watches set —",debugBarAddWatch:"Add watch",debugBarDeleteWatch:"Delete watch",debugBarWatchAll:"Watch all",debugBarWatchNone:"Delete all",debugBarLabelAdd:"Add",debugBarLabelWatch:"Watch",debugBarLabelTurn:"Turn",debugBarLabelViews:"Views",debugBarViewsToggle:"Toggle the debug views",debugBarWatchToggle:"Toggle the watch panel",uiBarToggle:"Toggle the UI bar",uiBarBackward:"Go backward within the {identity} history",uiBarForward:"Go forward within the {identity} history",uiBarJumpto:"Jump to a specific point within the {identity} history",jumptoTitle:"Jump To",jumptoTurn:"Turn",jumptoUnavailable:"No jump points currently available…",savesTitle:"Saves",savesDisallowed:"Saving has been disallowed on this passage.",savesIncapable:"{_warningIntroLacking} the capabilities required to support saves, so saves have been disabled for this session.",savesLabelAuto:"Autosave",savesLabelDelete:"Delete",savesLabelExport:"Save to Disk…",savesLabelImport:"Load from Disk…",savesLabelLoad:"Load",savesLabelClear:"Delete All",savesLabelSave:"Save",savesLabelSlot:"Slot",savesUnavailable:"No save slots found…",savesUnknownDate:"unknown",settingsTitle:"Settings",settingsOff:"Off",settingsOn:"On",settingsReset:"Reset to Defaults",restartTitle:"Restart",restartPrompt:"Are you sure that you want to restart? Unsaved progress will be lost.",shareTitle:"Share",autoloadTitle:"Autoload",autoloadCancel:"Go to start",autoloadOk:"Load autosave",autoloadPrompt:"An autosave exists. Load it now or go to the start?",macroBackText:"Back",macroReturnText:"Return"},Config=function(){function e(){throw new Error("Config.history.mode has been deprecated and is no longer used by SugarCube, please remove it from your code")}function t(){throw new Error("Config.history.tracking has been deprecated, use Config.history.maxStates instead")}var r=!1,n=!1,a=!1,i=0,o=!0,s=!0,u=!0,l=100,c=!0,d=1e3,f=void 0,p=void 0,h=!1,g=!1,m=void 0,v=void 0,y=void 0,b=void 0,w=void 0,k="untitled-story",S=void 0,E=void 0,j=void 0,x=8,O=void 0,T=800,C=!0;return Object.freeze({get debug(){return r},set debug(e){r=Boolean(e)},get addVisitedLinkClass(){return n},set addVisitedLinkClass(e){n=Boolean(e)},get cleanupWikifierOutput(){return a},set cleanupWikifierOutput(e){a=Boolean(e)},get loadDelay(){return i},set loadDelay(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.loadDelay must be a non-negative integer");i=e},audio:Object.freeze({get pauseOnFadeToZero(){return o},set pauseOnFadeToZero(e){o=Boolean(e)},get preloadMetadata(){return s},set preloadMetadata(e){s=Boolean(e)}}),history:Object.freeze({get controls(){return u},set controls(e){if((u=Boolean(e))&&1===l)throw u=!1,new Error("Config.history.controls must be false when Config.history.maxStates is 1")},get maxStates(){return l},set maxStates(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.history.maxStates must be a non-negative integer");l=e,u&&1===e&&(u=!1)},get mode(){e()},set mode(t){e()},get tracking(){t()},set tracking(e){t()}}),macros:Object.freeze({get ifAssignmentError(){return c},set ifAssignmentError(e){c=Boolean(e)},get maxLoopIterations(){return d},set maxLoopIterations(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.macros.maxLoopIterations must be a non-negative integer");d=e}}),navigation:Object.freeze({get override(){return f},set override(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.navigation.override must be a function or null/undefined (received: "+Util.getType(e)+")");f=e}}),passages:Object.freeze({get descriptions(){return p},set descriptions(e){if(null!=e){var t=Util.getType(e);if("boolean"!==t&&"Object"!==t&&"function"!==t)throw new TypeError("Config.passages.descriptions must be a boolean, object, function, or null/undefined (received: "+t+")")}p=e},get displayTitles(){return h},set displayTitles(e){h=Boolean(e)},get nobr(){return g},set nobr(e){g=Boolean(e)},get onProcess(){return v},set onProcess(e){if(null!=e){var t=Util.getType(e);if("function"!==t)throw new TypeError("Config.passages.onProcess must be a function or null/undefined (received: "+t+")")}v=e},get start(){return m},set start(e){if(null!=e){var t=Util.getType(e);if("string"!==t)throw new TypeError("Config.passages.start must be a string or null/undefined (received: "+t+")")}m=e},get transitionOut(){return y},set transitionOut(e){if(null!=e){var t=Util.getType(e);if("string"!==t&&("number"!==t||!Number.isSafeInteger(e)||e<0))throw new TypeError("Config.passages.transitionOut must be a string, non-negative integer, or null/undefined (received: "+t+")")}y=e}}),saves:Object.freeze({get autoload(){return b},set autoload(e){if(null!=e){var t=Util.getType(e);if("boolean"!==t&&"string"!==t&&"function"!==t)throw new TypeError("Config.saves.autoload must be a boolean, string, function, or null/undefined (received: "+t+")")}b=e},get autosave(){return w},set autosave(e){if(null!=e){var t=Util.getType(e);if("string"===t)return void(w=[e]);if("boolean"!==t&&("Array"!==t||!e.every(function(e){return"string"==typeof e}))&&"function"!==t)throw new TypeError("Config.saves.autosave must be a boolean, Array of strings, function, or null/undefined (received: "+t+("Array"===t?" of mixed":"")+")")}w=e},get id(){return k},set id(e){if("string"!=typeof e||""===e)throw new TypeError("Config.saves.id must be a non-empty string (received: "+Util.getType(e)+")");k=e},get isAllowed(){return S},set isAllowed(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.saves.isAllowed must be a function or null/undefined (received: "+Util.getType(e)+")");S=e},get onLoad(){return E},set onLoad(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.saves.onLoad must be a function or null/undefined (received: "+Util.getType(e)+")");E=e},get onSave(){return j},set onSave(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.saves.onSave must be a function or null/undefined (received: "+Util.getType(e)+")");j=e},get slots(){return x},set slots(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.saves.slots must be a non-negative integer");x=e},get version(){return O},set version(e){O=e}}),ui:Object.freeze({get stowBarInitially(){return T},set stowBarInitially(e){var t=Util.getType(e);if("boolean"!==t&&("number"!==t||!Number.isSafeInteger(e)||e<0))throw new TypeError("Config.passages.transitionOut must be a boolean or non-negative integer (received: "+t+")");T=e},get updateStoryElements(){return C},set updateStoryElements(e){C=Boolean(e)}})})}(),SimpleAudio=function(){function e(){if(arguments.length<2){var e=[];throw arguments.length<1&&e.push("track ID"),arguments.length<2&&e.push("sources"),new Error("no "+e.join(" or ")+" specified")}var t=String(arguments[0]).trim(),r='track ID "'+t+'"';if(_.test(t))throw new Error("invalid "+r+": track IDs must not contain colons or whitespace");var n=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1),a=void 0;try{a=T(n)}catch(e){throw new Error(r+": error during track initialization: "+e.message)}if(Config.debug&&!a.hasSource())throw new Error(r+": no supported audio sources found");N.has(t)&&N.get(t)._destroy(),N.set(t,a)}function t(e){return N.has(e)&&N.get(e)._destroy(),N.delete(e)}function r(){N.forEach(function(e){return e._destroy()}),N.clear()}function n(e){return N.has(e)}function a(e){return N.get(e)||null}function i(){if(arguments.length<2){var e=[];throw arguments.length<1&&e.push("group ID"),arguments.length<2&&e.push("track IDs"),new Error("no "+e.join(" or ")+" specified")}var t=String(arguments[0]).trim(),r='group ID "'+t+'"';if(":"!==t[0]||_.test(t.slice(1)))throw new Error("invalid "+r+": group IDs must start with a colon and must not contain colons or whitespace");if(A.includes(t))throw new Error("cannot clobber special "+r);var n=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1),a=void 0;try{a=new Set(n.map(function(e){if(!N.has(e))throw new Error('track "'+e+'" does not exist');return e}))}catch(e){throw new Error(r+": error during group initialization: "+e.message)}I.set(t,Object.freeze(Array.from(a)))}function o(e){return I.delete(e)}function s(){I.clear()}function u(e){return I.has(e)}function l(e){return I.get(e)||null}function c(){if(arguments.length<2){var e=[];throw arguments.length<1&&e.push("list ID"),
arguments.length<2&&e.push("track IDs"),new Error("no "+e.join(" or ")+" specified")}var t=String(arguments[0]).trim(),r='list ID "'+t+'"';if(_.test(t))return this.error("invalid "+r+": list IDs must not contain colons or whitespace");var n=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1),a=void 0;try{a=new B(n.map(function(e){if(null===e)throw new Error("track descriptor must be a string or object (type: null)");switch(void 0===e?"undefined":_typeof(e)){case"string":e={id:e};break;case"object":if(!e.hasOwnProperty("id")&&!e.hasOwnProperty("sources"))throw new Error('track descriptor must contain one of either an "id" or a "sources" property');if(e.hasOwnProperty("id")&&e.hasOwnProperty("sources"))throw new Error('track descriptor must contain either an "id" or a "sources" property, not both');break;default:throw new Error("track descriptor must be a string or object (type: "+(void 0===e?"undefined":_typeof(e))+")")}var t=void 0,r=void 0,n=void 0;if(e.hasOwnProperty("id")){if("string"!=typeof e.id)throw new Error('"id" property must be a string');if(!N.has(e.id))throw new Error('track "'+e.id+'" does not exist');r=N.get(e.id)}else if(e.hasOwnProperty("sources")){if(!Array.isArray(e.sources)||0===e.sources.length)throw new Error('"sources" property must be a non-empty array');if(e.hasOwnProperty("own"))throw new Error('"own" property is not allowed with the "sources" property');try{r=T(e.sources),t=!0}catch(e){throw new Error("error during track initialization: "+e.message)}if(Config.debug&&!r.hasSource())throw new Error("no supported audio sources found")}if(e.hasOwnProperty("own")){if("boolean"!=typeof e.own)throw new Error('"own" property must be a boolean');t=e.own,t&&(r=r.clone())}if(e.hasOwnProperty("volume")){if("number"!=typeof e.volume||Number.isNaN(e.volume)||!Number.isFinite(e.volume)||e.volume<0)throw new Error('"volume" property must be a non-negative finite number');n=e.volume}return{own:null!=t&&t,track:r,volume:null!=n?n:r.volume()}}))}catch(e){throw new Error(r+": error during playlist initialization: "+e.message)}D.has(t)&&D.get(t)._destroy(),D.set(t,a)}function d(e){return D.has(e)&&D.get(e)._destroy(),D.delete(e)}function f(){D.forEach(function(e){return e._destroy()}),D.clear()}function p(e){return D.has(e)}function h(e){return D.get(e)||null}function g(){if(0===arguments.length)throw new Error("no track selector specified");var e=String(arguments[0]).trim(),t=new Set;try{var r=function e(t){var r=t.id,a=void 0;switch(r){case":all":a=n;break;case":looped":a=n.filter(function(e){return N.get(e).loop()});break;case":muted":a=n.filter(function(e){return N.get(e).mute()});break;case":paused":a=n.filter(function(e){return N.get(e).isPaused()});break;case":playing":a=n.filter(function(e){return N.get(e).isPlaying()});break;default:a=":"===r[0]?I.get(r):[r]}if(t.hasOwnProperty("not")){var i=t.not.map(function(t){return e(t)}).flat(1/0);a=a.filter(function(e){return!i.includes(e)})}return a},n=Array.from(N.keys());V(e).forEach(function(e){return r(e).forEach(function(e){if(!N.has(e))throw new Error('track "'+e+'" does not exist');t.add(e)})})}catch(e){throw new Error("error during runner initialization: "+e.message)}return new U(t)}function m(){O("load")}function v(){O("loadwithscreen")}function y(e){if(null==e)return R;R=!!e,O("mute",R)}function b(e){if(null==e)return W;if(W=!!e){var t=Visibility.changeEvent+".SimpleAudio_masterMuteOnHidden";jQuery(document).off(t).on(t,function(){return y(Visibility.isHidden())}),Visibility.isHidden()&&y(!0)}else jQuery(document).off(".SimpleAudio_masterMuteOnHidden")}function w(e){if(null==e)return M;if("number"!=typeof e||Number.isNaN(e)||!Number.isFinite(e))throw new Error("rate must be a finite number");M=Math.clamp(e,.2,5),O("rate",M)}function k(){O("stop")}function S(){O("unload")}function E(e){if(null==e)return Q;if("number"!=typeof e||Number.isNaN(e)||!Number.isFinite(e))throw new Error("volume must be a finite number");Q=Math.clamp(e,0,1),O("volume",Q)}function j(e,t){if("function"!=typeof t)throw new Error("callback parameter must be a function");L.set(e,t)}function x(e){L.delete(e)}function O(e,t){L.forEach(function(r){return r(e,t)})}function T(e){return new F(e.map(function(e){if("data:"!==e.slice(0,5)&&Story.has(e)){var t=Story.get(e);if(t.tags.includes("Twine.audio"))return t.text.trim()}var r=P.exec(e);return null===r?e:{format:r[1],src:r[2]}}))}var C=Object.freeze(["click","contextmenu","dblclick","keyup","mouseup","pointerup","touchend"]),A=Object.freeze([":not",":all",":looped",":muted",":paused",":playing"]),P=/^([\w-]+)\s*\|\s*(\S.*)$/,_=/[:\s]/,N=new Map,I=new Map,D=new Map,L=new Map,M=1,Q=1,R=!1,W=!1,F=function(){function e(t){if(_classCallCheck(this,e),t instanceof Array)this._create(t);else{if(!(t instanceof e))throw new Error("sources parameter must be either an array, of URIs or source objects, or an AudioTrack instance");this._copy(t)}}return _createClass(e,[{key:"_create",value:function(t){var r=/^data:\s*audio\/([^;,]+)\s*[;,]/i,n=/\.([^.\/\\]+)$/,a=e.getType,i=[],o=document.createElement("audio");o.preload="none",t.forEach(function(e){var t=null;switch(void 0===e?"undefined":_typeof(e)){case"string":var s=void 0;if("data:"===e.slice(0,5)){if(null===(s=r.exec(e)))throw new Error("source data URI missing media type")}else if(null===(s=n.exec(Util.parseUrl(e).pathname)))throw new Error("source URL missing file extension");var u=a(s[1]);null!==u&&(t={src:e,type:u});break;case"object":if(null===e)throw new Error("source object cannot be null");if(!e.hasOwnProperty("src"))throw new Error('source object missing required "src" property');if(!e.hasOwnProperty("format"))throw new Error('source object missing required "format" property');var l=a(e.format);null!==l&&(t={src:e.src,type:l});break;default:throw new Error("invalid source value (type: "+(void 0===e?"undefined":_typeof(e))+")")}if(null!==t){Browser.isOpera&&(t.type=t.type.replace(/;.*$/,""));var c=document.createElement("source");c.src=t.src,c.type=t.type,o.appendChild(c),i.push(t)}}),o.hasChildNodes()&&Config.audio.preloadMetadata&&(o.preload="metadata"),this._finalize(o,i,clone(t))}},{key:"_copy",value:function(e){this._finalize(e.audio.cloneNode(!0),clone(e.sources),clone(e.originals))}},{key:"_finalize",value:function(e,t,r){var n=this;Object.defineProperties(this,{audio:{configurable:!0,value:e},sources:{value:Object.freeze(t)},originals:{value:Object.freeze(r)},_error:{writable:!0,value:!1},_faderId:{writable:!0,value:null},_mute:{writable:!0,value:!1},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1}}),jQuery(this.audio).on("loadstart.AudioTrack",function(){return n._error=!1}).on("error.AudioTrack",function(){return n._error=!0}).find("source:last-of-type").on("error.AudioTrack",function(){return n._trigger("error")}),j(this,function(e){if(!n.audio)return void x(n);switch(e){case"loadwithscreen":if(n.hasSource()){var t=LoadScreen.lock();n.one("canplaythrough.AudioTrack_loadwithscreen error.AudioTrack_loadwithscreen",function(){jQuery(this).off(".AudioTrack_loadwithscreen"),LoadScreen.unlock(t)}).load()}break;case"load":n.load();break;case"mute":n._updateAudioMute();break;case"rate":n._updateAudioRate();break;case"stop":n.stop();break;case"volume":n._updateAudioVolume();break;case"unload":n.unload()}}),this._updateAudioMute(),this._updateAudioRate(),this._updateAudioVolume()}},{key:"_trigger",value:function(e){jQuery(this.audio).triggerHandler(e)}},{key:"_destroy",value:function(){x(this),this.audio&&(jQuery(this.audio).off(),this.unload(),this._error=!0,delete this.audio)}},{key:"clone",value:function(){return new e(this)}},{key:"load",value:function(){var e=this;if(this.fadeStop(),this.audio.pause(),!this.audio.hasChildNodes()){if(0===this.sources.length)return;this.sources.forEach(function(t){var r=document.createElement("source");r.src=t.src,r.type=t.type,e.audio.appendChild(r)})}"auto"!==this.audio.preload&&(this.audio.preload="auto"),this.isLoading()||this.audio.load()}},{key:"unload",value:function(){this.fadeStop(),this.stop();var e=this.audio;for(e.preload="none";e.hasChildNodes();)e.removeChild(e.firstChild);e.load()}},{key:"play",value:function(){var e=this;return this.hasSource()?this.isUnloaded()?Promise.reject(new Error("no sources are loaded")):this.isFailed()?Promise.reject(new Error("failed to load any of the sources")):("auto"!==this.audio.preload&&(this.audio.preload="auto"),Has.audioPromise?this.audio.play():new Promise(function(t,r){jQuery(e.audio).off(".AudioTrack_play").one("error.AudioTrack_play playing.AudioTrack_play",function(n){jQuery(e).off(".AudioTrack_play"),"error"===n.type?r(new Error("unknown error")):t()}),e.audio.play()})):Promise.reject(new Error("none of the candidate sources were acceptable"))}},{key:"playWhenAllowed",value:function(){var e=this;this.play().catch(function(){var t=C.map(function(e){return e+".AudioTrack_playWhenAllowed"}).join(" ");jQuery(document).one(t,function(){jQuery(document).off(".AudioTrack_playWhenAllowed"),e.audio.play()})})}},{key:"pause",value:function(){this.audio.pause()}},{key:"stop",value:function(){this.audio.pause(),this.time(0),this._trigger(":stopped")}},{key:"fade",value:function(e,t,r){var n=this;if("number"!=typeof e)throw new TypeError("duration parameter must be a number");if("number"!=typeof t)throw new TypeError("toVolume parameter must be a number");if(null!=r&&"number"!=typeof r)throw new TypeError("fromVolume parameter must be a number");if(!this.hasSource())return Promise.reject(new Error("none of the candidate sources were acceptable"));if(this.isUnloaded())return Promise.reject(new Error("no sources are loaded"));if(this.isFailed())return Promise.reject(new Error("failed to load any of the sources"));this.fadeStop();var a=Math.clamp(null==r?this.volume():r,0,1),i=Math.clamp(t,0,1);return a!==i?(this.volume(a),jQuery(this.audio).off("timeupdate.AudioTrack_fade").one("timeupdate.AudioTrack_fade",function(){var t=void 0,r=void 0;a<i?(t=a,r=i):(t=i,r=a);var o=Math.max(e,1),s=(i-a)/(o/.025);n._trigger(":fading"),n._faderId=setInterval(function(){if(!n.isPlaying())return void n.fadeStop();n.volume(Math.clamp(n.volume()+s,t,r)),Config.audio.pauseOnFadeToZero&&0===n.volume()&&n.pause(),n.volume()===i&&(n.fadeStop(),n._trigger(":faded"))},25)}),this.play()):void 0}},{key:"fadeIn",value:function(e,t){return this.fade(e,1,t)}},{key:"fadeOut",value:function(e,t){return this.fade(e,0,t)}},{key:"fadeStop",value:function(){null!==this._faderId&&(clearInterval(this._faderId),this._faderId=null)}},{key:"loop",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){return null==e?this.audio.loop:(this.audio.loop=!!e,this)})},{key:"mute",value:function(e){return null==e?this._mute:(this._mute=!!e,this._updateAudioMute(),this)}},{key:"_updateAudioMute",value:function(){this.audio.muted=this._mute||R}},{key:"rate",value:function(e){if(null==e)return this._rate;if("number"!=typeof e)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(e,.2,5),this._updateAudioRate(),this}},{key:"_updateAudioRate",value:function(){this.audio.playbackRate=Math.clamp(this._rate*M,.2,5)}},{key:"time",value:function(e){var t=this;if(null==e)return this.audio.currentTime;if("number"!=typeof e)throw new TypeError("time parameter must be a number");return this.hasMetadata()?this.audio.currentTime=e:jQuery(this.audio).off("loadedmetadata.AudioTrack_time").one("loadedmetadata.AudioTrack_time",function(){return t.audio.currentTime=e}),this}},{key:"volume",value:function(e){if(null==e)return this._volume;if("number"!=typeof e)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(e,0,1),this._updateAudioVolume(),this}},{key:"_updateAudioVolume",value:function(){this.audio.volume=Math.clamp(this._volume*Q,0,1)}},{key:"duration",value:function(){return this.audio.duration}},{key:"remaining",value:function(){return this.audio.duration-this.audio.currentTime}},{key:"isFailed",value:function(){return this._error}},{key:"isLoading",value:function(){return this.audio.networkState===HTMLMediaElement.NETWORK_LOADING}},{key:"isUnloaded",value:function(){return!this.audio.hasChildNodes()}},{key:"isUnavailable",value:function(){return!this.hasSource()||this.isUnloaded()||this.isFailed()}},{key:"isPlaying",value:function(){return!this.audio.paused&&this.hasSomeData()}},{key:"isPaused",value:function(){return this.audio.paused&&(this.audio.duration===1/0||this.audio.currentTime>0)&&!this.audio.ended}},{key:"isStopped",value:function(){return this.audio.paused&&0===this.audio.currentTime}},{key:"isEnded",value:function(){return this.audio.ended}},{key:"isFading",value:function(){return null!==this._faderId}},{key:"isSeeking",value:function(){return this.audio.seeking}},{key:"hasSource",value:function(){return this.sources.length>0}},{key:"hasNoData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_NOTHING}},{key:"hasMetadata",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_METADATA}},{key:"hasSomeData",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA}},{key:"hasData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_ENOUGH_DATA}},{key:"on",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return jQuery.fn.on.apply(jQuery(this.audio),t),this}},{key:"one",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return jQuery.fn.one.apply(jQuery(this.audio),t),this}},{key:"off",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return jQuery.fn.off.apply(jQuery(this.audio),t),this}}],[{key:"_verifyType",value:function(t){if(!t||!Has.audio)return null;var r=e._types;if(!r.hasOwnProperty(t)){var n=document.createElement("audio");r[t]=""!==n.canPlayType(t).replace(/^no$/i,"")}return r[t]?t:null}},{key:"getType",value:function(t){if(!t||!Has.audio)return null;var r=e.formats,n=t.toLowerCase(),a=r.hasOwnProperty(n)?r[n]:"audio/"+n;return e._verifyType(a)}},{key:"canPlayFormat",value:function(t){return null!==e.getType(t)}},{key:"canPlayType",value:function(t){return null!==e._verifyType(t)}}]),e}();Object.defineProperties(F,{formats:{value:{aac:"audio/aac",caf:"audio/x-caf","x-caf":"audio/x-caf",mp3:'audio/mpeg; codecs="mp3"',mpeg:'audio/mpeg; codecs="mp3"',m4a:"audio/mp4",mp4:"audio/mp4","x-m4a":"audio/mp4","x-mp4":"audio/mp4",oga:"audio/ogg",ogg:"audio/ogg",opus:'audio/ogg; codecs="opus"',wav:"audio/wav",wave:"audio/wav",weba:"audio/webm",webm:"audio/webm"}},_types:{value:{}}});var B=function(){function e(t){if(_classCallCheck(this,e),t instanceof Array)this._create(t);else{if(!(t instanceof e))throw new Error("tracks parameter must be either an array, of track objects, or an AudioTrack instance");this._copy(t)}}return _createClass(e,[{key:"_create",value:function(e){var t=this;this._finalize(e.map(function(e){if("object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("tracks parameter array members must be objects");var r=void 0,n=void 0,a=void 0,i=void 0;if(e instanceof F)r=!0,n=e.rate(),a=e.clone(),i=e.volume();else{if(!e.hasOwnProperty("track"))throw new Error('track object missing required "track" property');if(!(e.track instanceof F))throw new Error('track object\'s "track" property must be an AudioTrack object');r=e.hasOwnProperty("own")&&e.own,n=e.hasOwnProperty("rate")?e.rate:e.track.rate(),a=e.track,i=e.hasOwnProperty("volume")?e.volume:e.track.volume()}return a.stop(),a.loop(!1),a.mute(!1),a.rate(n),a.volume(i),a.on("ended.AudioList",function(){return t._onEnd()}),{own:r,track:a,volume:i,rate:n}}))}},{key:"_copy",value:function(e){this._finalize(clone(e.tracks))}},{key:"_finalize",value:function(e){Object.defineProperties(this,{tracks:{configurable:!0,value:Object.freeze(e)},queue:{configurable:!0,value:[]},current:{writable:!0,value:null},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1},_mute:{writable:!0,value:!1},_loop:{writable:!0,value:!1},_shuffle:{writable:!0,value:!1}})}},{key:"_destroy",value:function(){this.stop(),this.tracks.filter(function(e){return e.own}).forEach(function(e){return e.track._destroy()}),delete this.tracks,delete this.queue}},{key:"load",value:function(){this.tracks.forEach(function(e){return e.track.load()})}},{key:"unload",value:function(){this.stop(),this.tracks.forEach(function(e){return e.track.unload()})}},{key:"play",value:function(){return null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||(0===this.queue.length&&this._fillQueue(),this._next())?this.current.track.play():Promise.reject(new Error("no tracks were available"))}},{key:"playWhenAllowed",value:function(){var e=this;this.play().catch(function(){var t=C.map(function(e){return e+".AudioList_playWhenAllowed"}).join(" ");jQuery(document).one(t,function(){jQuery(document).off(".AudioList_playWhenAllowed"),e.play()})})}},{key:"pause",value:function(){null!==this.current&&this.current.track.pause()}},{key:"stop",value:function(){null!==this.current&&(this.current.track.stop(),this.current=null),this._drainQueue()}},{key:"skip",value:function(){this._next()?this.current.track.play():this._loop&&this.play()}},{key:"fade",value:function(e,t,r){if("number"!=typeof e)throw new TypeError("duration parameter must be a number");if("number"!=typeof t)throw new TypeError("toVolume parameter must be a number");if(null!=r&&"number"!=typeof r)throw new TypeError("fromVolume parameter must be a number");if(0===this.queue.length&&this._fillQueue(),null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||this._next()){var n=Math.clamp(t,0,1)*this.current.volume,a=void 0;return null!=r&&(a=Math.clamp(r,0,1)*this.current.volume),this._volume=t,this.current.track.fade(e,n,a)}}},{key:"fadeIn",value:function(e,t){return this.fade(e,1,t)}},{key:"fadeOut",value:function(e,t){return this.fade(e,0,t)}},{key:"fadeStop",value:function(){null!==this.current&&this.current.track.fadeStop()}},{key:"loop",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){return null==e?this._loop:(this._loop=!!e,this)})},{key:"mute",value:function(e){return null==e?this._mute:(this._mute=!!e,null!==this.current&&this.current.track.mute(this._mute),this)}},{key:"rate",value:function(e){if(null==e)return this._rate;if("number"!=typeof e)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(e,.2,5),null!==this.current&&this.current.track.rate(this._rate*this.current.rate),this}},{key:"shuffle",value:function(e){var t=this;if(null==e)return this._shuffle;if(this._shuffle=!!e,this.queue.length>0&&(this._fillQueue(),!this._shuffle&&null!==this.current&&this.queue.length>1)){var r=this.queue.findIndex(function(e){return e===t.current});if(-1!==r){var n;(n=this.queue).push.apply(n,_toConsumableArray(this.queue.splice(0,r+1)))}}return this}},{key:"volume",value:function(e){if(null==e)return this._volume;if("number"!=typeof e)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(e,0,1),null!==this.current&&this.current.track.volume(this._volume*this.current.volume),this}},{key:"duration",value:function(){if(arguments.length>0)throw new Error("duration takes no parameters");return this.tracks.map(function(e){return e.track.duration()}).reduce(function(e,t){return e+t},0)}},{key:"remaining",value:function(){if(arguments.length>0)throw new Error("remaining takes no parameters");var e=this.queue.map(function(e){return e.track.duration()}).reduce(function(e,t){return e+t},0);return null!==this.current&&(e+=this.current.track.remaining()),e}},{key:"time",value:function(){if(arguments.length>0)throw new Error("time takes no parameters");return this.duration()-this.remaining()}},{key:"isPlaying",value:function(){return null!==this.current&&this.current.track.isPlaying()}},{key:"isPaused",value:function(){return null===this.current||this.current.track.isPaused()}},{key:"isStopped",value:function(){return 0===this.queue.length&&null===this.current}},{key:"isEnded",value:function(){return 0===this.queue.length&&(null===this.current||this.current.track.isEnded())}},{key:"isFading",value:function(){return null!==this.current&&this.current.track.isFading()}},{key:"_next",value:function(){null!==this.current&&(this.current.track.stop(),this.current=null);for(var e=void 0;e=this.queue.shift();)if(!e.track.isUnavailable()){this.current=e;break}return null!==this.current&&(this.current.track.mute(this._mute),this.current.track.rate(this._rate*this.current.rate),this.current.track.volume(this._volume*this.current.volume),this.current.track.loop(!1),!0)}},{key:"_onEnd",value:function(){if(0===this.queue.length){if(!this._loop)return;this._fillQueue()}this._next()&&this.current.track.play()}},{key:"_drainQueue",value:function(){this.queue.splice(0)}},{key:"_fillQueue",value:function(){var e;this._drainQueue(),(e=this.queue).push.apply(e,_toConsumableArray(this.tracks.filter(function(e){return!e.track.isUnavailable()}))),0!==this.queue.length&&this._shuffle&&(this.queue.shuffle(),this.queue.length>1&&this.queue[0]===this.current&&this.queue.push(this.queue.shift()))}}]),e}(),U=function(){function e(t){if(_classCallCheck(this,e),!(t instanceof Set||t instanceof e))throw new TypeError("list parameter must be a Set or a AudioRunner instance");Object.defineProperties(this,{trackIds:{value:new Set(t instanceof e?t.trackIds:t)}})}return _createClass(e,[{key:"load",value:function(){e._run(this.trackIds,F.prototype.load)}},{key:"unload",value:function(){e._run(this.trackIds,F.prototype.unload)}},{key:"play",value:function(){e._run(this.trackIds,F.prototype.play)}},{key:"playWhenAllowed",value:function(){e._run(this.trackIds,F.prototype.playWhenAllowed)}},{key:"pause",value:function(){e._run(this.trackIds,F.prototype.pause)}},{key:"stop",value:function(){e._run(this.trackIds,F.prototype.stop)}},{key:"fade",value:function(t,r,n){if(null==t||null==r)throw new Error("fade requires parameters");e._run(this.trackIds,F.prototype.fade,t,r,n)}},{key:"fadeIn",value:function(t,r){if(null==t)throw new Error("fadeIn requires a parameter");e._run(this.trackIds,F.prototype.fadeIn,t,1,r)}},{key:"fadeOut",value:function(t,r){if(null==t)throw new Error("fadeOut requires a parameter");e._run(this.trackIds,F.prototype.fadeOut,t,0,r)}},{key:"fadeStop",value:function(){e._run(this.trackIds,F.prototype.fadeStop)}},{key:"loop",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(t){if(null==t)throw new Error("loop requires a parameter");return e._run(this.trackIds,F.prototype.loop,t),this})},{key:"mute",value:function(t){if(null==t)throw new Error("mute requires a parameter");return e._run(this.trackIds,F.prototype.mute,t),this}},{key:"rate",value:function(t){if(null==t)throw new Error("rate requires a parameter");return e._run(this.trackIds,F.prototype.rate,t),this}},{key:"time",value:function(t){if(null==t)throw new Error("time requires a parameter");return e._run(this.trackIds,F.prototype.time,t),this}},{key:"volume",value:function(t){if(null==t)throw new Error("volume requires a parameter");return e._run(this.trackIds,F.prototype.volume,t),this}},{key:"on",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return e._run.apply(e,[this.trackIds,F.prototype.on].concat(r)),this}},{key:"one",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return e._run.apply(e,[this.trackIds,F.prototype.one].concat(r)),this}},{key:"off",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return e._run.apply(e,[this.trackIds,F.prototype.off].concat(r)),this}}],[{key:"_run",value:function(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];e.forEach(function(e){var r=N.get(e);r&&t.apply(r,n)})}}]),e}(),V=function(){function e(e,t){var a=void 0;if(r.lastIndex=t,null===(a=r.exec(e))||"("!==a[0])throw new Error('invalid ":not()" syntax: missing parentheticals');n.lastIndex=r.lastIndex;for(var i=r.lastIndex,o={str:"",nextMatch:-1},s=1;null!==(a=n.exec(e));)if("("===a[0]?++s:--s,s<1){o.nextMatch=n.lastIndex,o.str=e.slice(i,o.nextMatch-1);break}return o}function t(r){for(var n=[],a=/:?[^\s:()]+/g,i=void 0;null!==(i=a.exec(r));){var o=i[0];if(":not"===o){if(0===n.length)throw new Error('invalid negation: no group ID preceded ":not()"');var s=n[n.length-1];if(":"!==s.id[0])throw new Error('invalid negation of track "'+s.id+'": only groups may be negated with ":not()"');var u=e(r,a.lastIndex);if(-1===u.nextMatch)throw new Error('unknown error parsing ":not()"');a.lastIndex=u.nextMatch,s.not=t(u.str)}else n.push({id:o})}return n}var r=/\S/g,n=/[()]/g;return t}();return Object.freeze(Object.defineProperties({},{tracks:{value:Object.freeze(Object.defineProperties({},{add:{value:e},delete:{value:t},clear:{value:r},has:{value:n},get:{value:a}}))},groups:{value:Object.freeze(Object.defineProperties({},{add:{value:i},delete:{value:o},clear:{value:s},has:{value:u},get:{value:l}}))},lists:{value:Object.freeze(Object.defineProperties({},{add:{value:c},delete:{value:d},clear:{value:f},has:{value:p},get:{value:h}}))},select:{value:g},load:{value:m},loadWithScreen:{value:v},mute:{value:y},muteOnHidden:{value:b},rate:{value:w},stop:{value:k},unload:{value:S},volume:{value:E}}))}(),State=function(){function e(){session.delete("state"),$=[],J=c(),G=-1,Z=[],Y=null===Y?null:new PRNGWrapper(Y.seed,!1)}function t(){if(session.has("state")){var e=session.get("state");return null!=e&&(n(e),!0)}return!1}function r(e){var t={index:G};return e?t.history=clone($):t.delta=A($),Z.length>0&&(t.expired=[].concat(_toConsumableArray(Z))),null!==Y&&(t.seed=Y.seed),t}function n(e,t){if(null==e)throw new Error("state object is null or undefined");if(!e.hasOwnProperty(t?"history":"delta")||0===e[t?"history":"delta"].length)throw new Error("state object has no history or history is empty");if(!e.hasOwnProperty("index"))throw new Error("state object has no index");if(null!==Y&&!e.hasOwnProperty("seed"))throw new Error("state object has no seed, but PRNG is enabled");if(null===Y&&e.hasOwnProperty("seed"))throw new Error("state object has seed, but PRNG is disabled");$=t?clone(e.history):P(e.delta),G=e.index,Z=e.hasOwnProperty("expired")?[].concat(_toConsumableArray(e.expired)):[],e.hasOwnProperty("seed")&&(Y.seed=e.seed),g(G)}function a(){return r(!0)}function i(e){return n(e,!0)}function o(){return Z}function s(){return Z.length+v()}function u(){return Z.concat($.slice(0,v()).map(function(e){return e.title}))}function l(e){return null!=e&&""!==e&&(!!Z.includes(e)||!!$.slice(0,v()).some(function(t){return t.title===e}))}function c(e,t){return{title:null==e?"":String(e),variables:null==t?{}:clone(t)}}function d(){return J}function f(){return G}function p(){return J.title}function h(){return J.variables}function g(e){if(null==e)throw new Error("moment activation attempted with null or undefined");switch(void 0===e?"undefined":_typeof(e)){case"object":J=clone(e);break;case"number":if(b())throw new Error("moment activation attempted with index on empty history");if(e<0||e>=y())throw new RangeError("moment activation attempted with out-of-bounds index; need [0, "+(y()-1)+"], got "+e);J=clone($[e]);break;default:throw new TypeError('moment activation attempted with a "'+(void 0===e?"undefined":_typeof(e))+'"; must be an object or valid history stack index')}return null!==Y&&(Y=PRNGWrapper.unmarshal({seed:Y.seed,pull:J.pull})),session.set("state",r()),jQuery.event.trigger(":historyupdate"),J}function m(){return $}function v(){return G+1}function y(){return $.length}function b(){return 0===$.length}function w(){return $.length>0?$[G]:null}function k(){return $.length>0?$[$.length-1]:null}function S(){return $.length>0?$[0]:null}function E(e){return b()||e<0||e>G?null:$[e]}function j(e){if(b())return null;var t=1+(e?Math.abs(e):0);return t>v()?null:$[v()-t]}function x(e){if(b()||null==e||""===e)return!1;for(var t=G;t>=0;--t)if($[t].title===e)return!0;return!1}function O(e){if(v()<y()&&$.splice(v(),y()-v()),$.push(c(e,J.variables)),Y&&(k().pull=Y.pull),Config.history.maxStates>0)for(;y()>Config.history.maxStates;)Z.push($.shift().title);return G=y()-1,g(G),v()}function T(e){return!(null==e||e<0||e>=y()||e===G)&&(G=e,g(G),!0)}function C(e){return null!=e&&0!==e&&T(G+e)}function A(e){if(!Array.isArray(e))return null;if(0===e.length)return[];for(var t=[clone(e[0])],r=1,n=e.length;r<n;++r)t.push(Diff.diff(e[r-1],e[r]));return t}function P(e){if(!Array.isArray(e))return null;if(0===e.length)return[];for(var t=[clone(e[0])],r=1,n=e.length;r<n;++r)t.push(Diff.patch(t[r-1],e[r]));return t}function _(e,t){if(!b()){var r=void 0;throw r="the Story JavaScript",new Error("State.initPRNG must be called during initialization, within either "+r+" or the StoryInit special passage")}Y=new PRNGWrapper(e,t),J.pull=Y.pull}function N(){return null!==Y}function I(){return Y?Y.pull:NaN}function D(){return Y?Y.seed:null}function L(){return Y?Y.random():Math.random()}function M(){K={},TempVariables=K}function Q(){return K}function R(e){var t=F(e);if(null!==t){for(var r=t.names,n=t.store,a=0,i=r.length;a<i;++a){if(void 0===n[r[a]])return;n=n[r[a]]}return n}}function W(e,t){var r=F(e);if(null===r)return!1;for(var n=r.names,a=n.pop(),i=r.store,o=0,s=n.length;o<s;++o){if(void 0===i[n[o]])return!1;i=i[n[o]]}return i[a]=t,!0}function F(e){for(var t={store:"$"===e[0]?State.variables:State.temporary,names:[]},r=e,n=void 0;null!==(n=X.exec(r));)r=r.slice(n[0].length),n[1]?t.names.push(n[1]):n[2]?t.names.push(n[2]):n[3]?t.names.push(n[3]):n[4]?t.names.push(n[4]):n[5]?t.names.push(R(n[5])):n[6]&&t.names.push(Number(n[6]));return""===r?t:null}function B(){storage.delete(ee)}function U(e){if("string"!=typeof e)throw new TypeError("State.metadata.delete key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");var t=storage.get(ee);t&&t.hasOwnProperty(e)&&(1===Object.keys(t).length?storage.delete(ee):(delete t[e],storage.set(ee,t)))}function V(e){if("string"!=typeof e)throw new TypeError("State.metadata.get key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");var t=storage.get(ee);return t&&t.hasOwnProperty(e)?t[e]:undefined}function z(e){if("string"!=typeof e)throw new TypeError("State.metadata.has key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");var t=storage.get(ee);return t&&t.hasOwnProperty(e)}function q(e,t){if("string"!=typeof e)throw new TypeError("State.metadata.set key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");if(void 0===t)U(e);else{var r=storage.get(ee)||{};r[e]=t,storage.set(ee,r)}}function H(){var e=storage.get(ee);return e?Object.keys(e).length:0}var $=[],J=c(),G=-1,Z=[],Y=null,K={},X=new RegExp("^(?:"+Patterns.variableSigil+"("+Patterns.identifier+")|\\.("+Patterns.identifier+")|\\[(?:(?:\"((?:\\\\.|[^\"\\\\])+)\")|(?:'((?:\\\\.|[^'\\\\])+)')|("+Patterns.variableSigil+Patterns.identifierFirstChar+".*)|(\\d+))\\])"),ee="metadata";return Object.freeze(Object.defineProperties({},{reset:{value:e},restore:{value:t},marshalForSave:{value:a},unmarshalForSave:{value:i},expired:{get:o},turns:{get:s},passages:{get:u},hasPlayed:{value:l},active:{get:d},activeIndex:{get:f},passage:{get:p},variables:{get:h},history:{get:m},length:{get:v},size:{get:y},isEmpty:{value:b},current:{get:w},top:{get:k},bottom:{get:S},index:{value:E},peek:{value:j},has:{value:x},create:{value:O},goTo:{value:T},go:{value:C},deltaEncode:{value:A},deltaDecode:{value:P},prng:{value:Object.freeze(Object.defineProperties({},{init:{value:_},isEnabled:{value:N},pull:{get:I},seed:{get:D}}))},random:{value:L},clearTemporary:{value:M},temporary:{get:Q},getVar:{
value:R},setVar:{value:W},metadata:{value:Object.freeze(Object.defineProperties({},{clear:{value:B},delete:{value:U},get:{value:V},has:{value:z},set:{value:q},size:{get:H}}))},initPRNG:{value:_},restart:{value:function(){return Engine.restart()}},backward:{value:function(){return Engine.backward()}},forward:{value:function(){return Engine.forward()}},display:{value:function(){return Engine.display.apply(Engine,arguments)}},show:{value:function(){return Engine.show.apply(Engine,arguments)}},play:{value:function(){return Engine.play.apply(Engine,arguments)}}}))}(),Scripting=function(){function addAccessibleClickHandler(e,t,r,n,a){if(arguments.length<2)throw new Error("addAccessibleClickHandler insufficient number of parameters");var i=void 0,o=void 0;if("function"==typeof t?(i=t,o={namespace:n,one:!!r}):(i=r,o={namespace:a,one:!!n,selector:t}),"function"!=typeof i)throw new TypeError("addAccessibleClickHandler handler parameter must be a function");return jQuery(e).ariaClick(o,i)}function insertElement(e,t,r,n,a,i){var o=jQuery(document.createElement(t));return r&&o.attr("id",r),n&&o.addClass(n),i&&o.attr("title",i),a&&o.text(a),e&&o.appendTo(e),o[0]}function insertText(e,t){jQuery(e).append(document.createTextNode(t))}function removeChildren(e){jQuery(e).empty()}function removeElement(e){jQuery(e).remove()}function fade(e,t){function r(){i+=.05*a,n(o,Math.easeInOut(i)),(1===a&&i>=1||-1===a&&i<=0)&&(e.style.visibility="in"===t.fade?"visible":"hidden",o.parentNode.replaceChild(e,o),o=null,window.clearInterval(s),t.onComplete&&t.onComplete())}function n(e,t){e.style.zoom=1,e.style.filter="alpha(opacity="+Math.floor(100*t)+")",e.style.opacity=t}var a="in"===t.fade?1:-1,i=void 0,o=e.cloneNode(!0),s=void 0;e.parentNode.replaceChild(o,e),"in"===t.fade?(i=0,o.style.visibility="visible"):i=1,n(o,i),s=window.setInterval(r,25)}function scrollWindowTo(e,t){function r(){l+=a,window.scroll(0,i+u*(s*Math.easeInOut(l))),l>=1&&window.clearInterval(c)}function n(e){for(var t=0;e.offsetParent;)t+=e.offsetTop,e=e.offsetParent;return t}var a=null!=t?Number(t):.1;Number.isNaN(a)||!Number.isFinite(a)||a<0?a=.1:a>1&&(a=1);var i=window.scrollY?window.scrollY:document.body.scrollTop,o=function(e){var t=n(e),r=t+e.offsetHeight,a=window.scrollY?window.scrollY:document.body.scrollTop,i=window.innerHeight?window.innerHeight:document.body.clientHeight,o=a+i;return t>=a&&r>o&&e.offsetHeight<i?t-(i-e.offsetHeight)+20:t}(e),s=Math.abs(i-o),u=i>o?-1:1,l=0,c=void 0;c=window.setInterval(r,25)}function either(){if(0!==arguments.length)return Array.prototype.concat.apply([],arguments).random()}function forget(e){if("string"!=typeof e)throw new TypeError("forget key parameter must be a string (received: "+Util.getType(e)+")");State.metadata.delete(e)}function hasVisited(){if(0===arguments.length)throw new Error("hasVisited called with insufficient parameters");if(State.isEmpty())return!1;for(var e=Array.prototype.concat.apply([],arguments),t=State.passages,r=0,n=e.length;r<n;++r)if(!t.includes(e[r]))return!1;return!0}function lastVisited(){if(0===arguments.length)throw new Error("lastVisited called with insufficient parameters");if(State.isEmpty())return-1;for(var e=Array.prototype.concat.apply([],arguments),t=State.passages,r=t.length-1,n=State.turns,a=0,i=e.length;a<i&&n>-1;++a){var o=t.lastIndexOf(e[a]);n=Math.min(n,-1===o?-1:r-o)}return n}function memorize(e,t){if("string"!=typeof e)throw new TypeError("memorize key parameter must be a string (received: "+Util.getType(e)+")");State.metadata.set(e,t)}function passage(){return State.passage}function previous(){var e=State.passages;if(arguments.length>0){var t=Number(arguments[0]);if(!Number.isSafeInteger(t)||t<1)throw new RangeError("previous offset parameter must be a positive integer greater than zero");return e.length>t?e[e.length-1-t]:""}for(var r=e.length-2;r>=0;--r)if(e[r]!==State.passage)return e[r];return""}function random(){var e=void 0,t=void 0;switch(arguments.length){case 0:throw new Error("random called with insufficient parameters");case 1:e=0,t=Math.trunc(arguments[0]);break;default:e=Math.trunc(arguments[0]),t=Math.trunc(arguments[1])}if(!Number.isInteger(e))throw new Error("random min parameter must be an integer");if(!Number.isInteger(t))throw new Error("random max parameter must be an integer");if(e>t){var r=[t,e];e=r[0],t=r[1]}return Math.floor(State.random()*(t-e+1))+e}function randomFloat(){var e=void 0,t=void 0;switch(arguments.length){case 0:throw new Error("randomFloat called with insufficient parameters");case 1:e=0,t=Number(arguments[0]);break;default:e=Number(arguments[0]),t=Number(arguments[1])}if(Number.isNaN(e)||!Number.isFinite(e))throw new Error("randomFloat min parameter must be a number");if(Number.isNaN(t)||!Number.isFinite(t))throw new Error("randomFloat max parameter must be a number");if(e>t){var r=[t,e];e=r[0],t=r[1]}return State.random()*(t-e)+e}function recall(e,t){if("string"!=typeof e)throw new TypeError("recall key parameter must be a string (received: "+Util.getType(e)+")");return State.metadata.has(e)?State.metadata.get(e):t}function tags(){if(0===arguments.length)return Story.get(State.passage).tags.slice(0);for(var e=Array.prototype.concat.apply([],arguments),t=[],r=0,n=e.length;r<n;++r)t=t.concat(Story.get(e[r]).tags);return t}function temporary(){return State.temporary}function time(){return null===Engine.lastPlay?0:Util.now()-Engine.lastPlay}function turns(){return State.turns}function variables(){return State.variables}function visited(){if(State.isEmpty())return 0;for(var e=Array.prototype.concat.apply([],0===arguments.length?[State.passage]:arguments),t=State.passages,r=State.turns,n=0,a=e.length;n<a&&r>0;++n)r=Math.min(r,t.count(e[n]));return r}function visitedTags(){if(0===arguments.length)throw new Error("visitedTags called with insufficient parameters");if(State.isEmpty())return 0;for(var e=Array.prototype.concat.apply([],arguments),t=e.length,r=State.passages,n=new Map,a=0,i=0,o=r.length;i<o;++i){var s=r[i];if(n.has(s))n.get(s)&&++a;else{var u=Story.get(s).tags;if(u.length>0){for(var l=0,c=0;c<t;++c)u.includes(e[c])&&++l;l===t?(++a,n.set(s,!0)):n.set(s,!1)}}}return a}function evalJavaScript(code,output){return function(code,output){return eval(code)}.call(output?{output:output}:null,String(code),output)}function evalTwineScript(code,output){return function(code,output){return eval(code)}.call(output?{output:output}:null,parse(String(code)),output)}var _ref8=function(){function e(e){return Util.parseUrl(e).path.replace(/^[^\w]+|[^\w]+$/g,"").replace(/[^\w]+/g,"-").toLocaleLowerCase()}function t(t){return new Promise(function(r,n){jQuery(document.createElement("script")).one("load abort error",function(e){jQuery(e.target).off(),"load"===e.type?r(e.target):n(new Error('importScripts failed to load the script "'+t+'".'))}).appendTo(document.head).attr({id:"script-imported-"+e(t),type:"text/javascript",src:t})})}function r(t){return new Promise(function(r,n){jQuery(document.createElement("link")).one("load abort error",function(e){jQuery(e.target).off(),"load"===e.type?r(e.target):n(new Error('importStyles failed to load the stylesheet "'+t+'".'))}).appendTo(document.head).attr({id:"style-imported-"+e(t),rel:"stylesheet",href:t})})}function n(e){return e.reduce(function(e,t){return e=e.then(t)},Promise.resolve())}function a(){for(var e=arguments.length,r=Array(e),a=0;a<e;a++)r[a]=arguments[a];return Promise.all(r.map(function(e){return Array.isArray(e)?n(e.map(function(e){return function(){return t(e)}})):t(e)}))}function i(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return Promise.all(t.map(function(e){return Array.isArray(e)?n(e.map(function(e){return function(){return r(e)}})):r(e)}))}return{importScripts:a,importStyles:i}}(),importScripts=_ref8.importScripts,importStyles=_ref8.importStyles,parse=function(){function e(e){if(0!==r.lastIndex)throw new RangeError("Scripting.parse last index is non-zero at start");for(var a=e,i=void 0;null!==(i=r.exec(a));)if(i[5]){var o=i[5];if("$"===o||"_"===o)continue;if(n.test(o))o=o[0];else if("is"===o){var s=r.lastIndex,u=a.slice(s);/^\s+not\b/.test(u)&&(a=a.splice(s,u.search(/\S/)),o="isnot")}t.hasOwnProperty(o)&&(a=a.splice(i.index,o.length,t[o]),r.lastIndex+=t[o].length-o.length)}return a}var t=Object.freeze({$:"State.variables.",_:"State.temporary.",to:"=",eq:"==",neq:"!=",is:"===",isnot:"!==",gt:">",gte:">=",lt:"<",lte:"<=",and:"&&",or:"||",not:"!",def:'"undefined" !== typeof',ndef:'"undefined" === typeof'}),r=new RegExp(["(\"\"|'')",'("(?:\\\\.|[^"\\\\])+")',"('(?:\\\\.|[^'\\\\])+')","([=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}]+)","([^\"'=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}\\s]+)"].join("|"),"g"),n=new RegExp("^"+Patterns.variable);return e}();return Object.freeze(Object.defineProperties({},{parse:{value:parse},evalJavaScript:{value:evalJavaScript},evalTwineScript:{value:evalTwineScript}}))}(),_ref9=function(){return{EOF:-1,Lexer:function(){function e(t,r){if(_classCallCheck(this,e),arguments.length<2)throw new Error("Lexer constructor called with too few parameters (source:string , initialState:function)");Object.defineProperties(this,{source:{value:t},initial:{value:r},state:{writable:!0,value:r},start:{writable:!0,value:0},pos:{writable:!0,value:0},depth:{writable:!0,value:0},items:{writable:!0,value:[]},data:{writable:!0,value:{}}})}return _createClass(e,[{key:"reset",value:function(){this.state=this.initial,this.start=0,this.pos=0,this.depth=0,this.items=[],this.data={}}},{key:"run",value:function(){for(;null!==this.state;)this.state=this.state(this);return this.items}},{key:"nextItem",value:function(){for(;0===this.items.length&&null!==this.state;)this.state=this.state(this);return this.items.shift()}},{key:"next",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos++]}},{key:"peek",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos]}},{key:"backup",value:function(e){this.pos-=e||1}},{key:"forward",value:function(e){this.pos+=e||1}},{key:"ignore",value:function(){this.start=this.pos}},{key:"accept",value:function(e){var t=this.next();return-1!==t&&(!!e.includes(t)||(this.backup(),!1))}},{key:"acceptRe",value:function(e){var t=this.next();return-1!==t&&(!!e.test(t)||(this.backup(),!1))}},{key:"acceptRun",value:function(e){for(;;){var t=this.next();if(-1===t)return;if(!e.includes(t))break}this.backup()}},{key:"acceptRunRe",value:function(e){for(;;){var t=this.next();if(-1===t)return;if(!e.test(t))break}this.backup()}},{key:"emit",value:function(e){this.items.push({type:e,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),this.start=this.pos}},{key:"error",value:function(e,t){if(arguments.length<2)throw new Error("Lexer.prototype.error called with too few parameters (type:number , message:string)");return this.items.push({type:e,message:t,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),null}}],[{key:"enumFromNames",value:function(e){var t=e.reduce(function(e,t,r){return e[t]=r,e},{});return Object.freeze(Object.assign(Object.create(null),t))}}]),e}()}}(),EOF=_ref9.EOF,Lexer=_ref9.Lexer,Wikifier=function(){var e=0,t=function(){function t(r,n,a){_classCallCheck(this,t),t.Parser.Profile.isEmpty()&&t.Parser.Profile.compile(),Object.defineProperties(this,{source:{value:String(n)},options:{writable:!0,value:Object.assign({profile:"all"},a)},nextMatch:{writable:!0,value:0},output:{writable:!0,value:null},_rawArgs:{writable:!0,value:""}}),null==r?this.output=document.createDocumentFragment():r.jquery?this.output=r[0]:this.output=r;try{++e,this.subWikify(this.output),1===e&&Config.cleanupWikifierOutput&&convertBreaks(this.output)}finally{--e}}return _createClass(t,[{key:"subWikify",value:function(e,r,n){var a=this.output,i=void 0;this.output=e,null!=n&&"object"===(void 0===n?"undefined":_typeof(n))&&(i=this.options,this.options=Object.assign({},this.options,n));var o=t.Parser.Profile.get(this.options.profile),s=r?new RegExp("(?:"+r+")",this.options.ignoreTerminatorCase?"gim":"gm"):null,u=void 0,l=void 0;do{if(o.parserRegExp.lastIndex=this.nextMatch,s&&(s.lastIndex=this.nextMatch),l=o.parserRegExp.exec(this.source),(u=s?s.exec(this.source):null)&&(!l||u.index<=l.index))return u.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,u.index),this.matchStart=u.index,this.matchLength=u[0].length,this.matchText=u[0],this.nextMatch=s.lastIndex,this.output=a,void(i&&(this.options=i));if(l){l.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,l.index),this.matchStart=l.index,this.matchLength=l[0].length,this.matchText=l[0],this.nextMatch=o.parserRegExp.lastIndex;for(var c=void 0,d=1,f=l.length;d<f;++d)if(l[d]){c=d-1;break}if(o.parsers[c].handler(this),null!=TempState.break)break}}while(u||l);null==TempState.break?this.nextMatch<this.source.length&&(this.outputText(this.output,this.nextMatch,this.source.length),this.nextMatch=this.source.length):this.output.lastChild&&this.output.lastChild.nodeType===Node.ELEMENT_NODE&&"BR"===this.output.lastChild.nodeName.toUpperCase()&&jQuery(this.output.lastChild).remove(),this.output=a,i&&(this.options=i)}},{key:"outputText",value:function(e,t,r){jQuery(e).append(document.createTextNode(this.source.substring(t,r)))}},{key:"rawArgs",value:function(){return this._rawArgs}},{key:"fullArgs",value:function(){return Scripting.parse(this._rawArgs)}}],[{key:"wikifyEval",value:function(e){var r=document.createDocumentFragment();new t(r,e);var n=r.querySelector(".error");if(null!==n)throw new Error(n.textContent.replace(errorPrologRegExp,""));return r}},{key:"createInternalLink",value:function(e,t,r,n){var a=jQuery(document.createElement("a"));return null!=t&&(a.attr("data-passage",t),Story.has(t)?(a.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(t)&&a.addClass("link-visited")):a.addClass("link-broken"),a.ariaClick({one:!0},function(){"function"==typeof n&&n(),Engine.play(t)})),r&&a.append(document.createTextNode(r)),e&&a.appendTo(e),a[0]}},{key:"createExternalLink",value:function(e,t,r){var n=jQuery(document.createElement("a")).attr("target","_blank").addClass("link-external").text(r).appendTo(e);return null!=t&&n.attr({href:t,tabindex:0}),n[0]}},{key:"isExternalLink",value:function(e){return!Story.has(e)&&(new RegExp("^"+Patterns.url,"gim").test(e)||/[\/.?#]/.test(e))}}]),t}();return Object.defineProperty(t,"Parser",{value:function(){function e(){return d}function t(e){if("object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("Wikifier.Parser.add parser parameter must be an object");if(!e.hasOwnProperty("name"))throw new Error('parser object missing required "name" property');if("string"!=typeof e.name)throw new Error('parser object "name" property must be a string');if(!e.hasOwnProperty("match"))throw new Error('parser object missing required "match" property');if("string"!=typeof e.match)throw new Error('parser object "match" property must be a string');if(!e.hasOwnProperty("handler"))throw new Error('parser object missing required "handler" property');if("function"!=typeof e.handler)throw new Error('parser object "handler" property must be a function');if(e.hasOwnProperty("profiles")&&!Array.isArray(e.profiles))throw new Error('parser object "profiles" property must be an array');if(a(e.name))throw new Error('cannot clobber existing parser "'+e.name+'"');d.push(e)}function r(e){var t=d.find(function(t){return t.name===e});t&&d.delete(t)}function n(){return 0===d.length}function a(e){return!!d.find(function(t){return t.name===e})}function i(e){return d.find(function(t){return t.name===e})||null}function o(){return f}function s(){var e=d,t=e.filter(function(e){return!Array.isArray(e.profiles)||e.profiles.includes("core")});return f=Object.freeze({all:{parsers:e,parserRegExp:new RegExp(e.map(function(e){return"("+e.match+")"}).join("|"),"gm")},core:{parsers:t,parserRegExp:new RegExp(t.map(function(e){return"("+e.match+")"}).join("|"),"gm")}})}function u(){return"object"!==(void 0===f?"undefined":_typeof(f))||0===Object.keys(f).length}function l(e){if("object"!==(void 0===f?"undefined":_typeof(f))||!f.hasOwnProperty(e))throw new Error('nonexistent parser profile "'+e+'"');return f[e]}function c(e){return"object"===(void 0===f?"undefined":_typeof(f))&&f.hasOwnProperty(e)}var d=[],f=void 0;return Object.freeze(Object.defineProperties({},{parsers:{get:e},add:{value:t},delete:{value:r},isEmpty:{value:n},has:{value:a},get:{value:i},Profile:{value:Object.freeze(Object.defineProperties({},{profiles:{get:o},compile:{value:s},isEmpty:{value:u},has:{value:c},get:{value:l}}))}}))}()}),Object.defineProperties(t,{helpers:{value:{}},getValue:{value:State.getVar},setValue:{value:State.setVar},parse:{value:Scripting.parse},evalExpression:{value:Scripting.evalTwineScript},evalStatements:{value:Scripting.evalTwineScript},textPrimitives:{value:Patterns}}),Object.defineProperties(t.helpers,{inlineCss:{value:function(){function e(e){var r={classes:[],id:"",styles:{}},n=void 0;do{t.lastIndex=e.nextMatch;var a=t.exec(e.source);n=a&&a.index===e.nextMatch,n&&(a[1]?r.styles[Util.fromCssProperty(a[1])]=a[2].trim():a[3]?r.styles[Util.fromCssProperty(a[3])]=a[4].trim():a[5]?r.classes=r.classes.concat(a[5].slice(1).split(/\./)):a[6]&&(r.id=a[6].slice(1).split(/#/).pop()),e.nextMatch=t.lastIndex)}while(n);return r}var t=new RegExp(Patterns.inlineCss,"gm");return e}()},evalText:{value:function(e){var t=void 0;try{switch(t=Scripting.evalTwineScript(e),void 0===t?"undefined":_typeof(t)){case"string":""===t.trim()&&(t=e);break;case"number":t=String(t);break;default:t=e}}catch(r){t=e}return t}},evalPassageId:{value:function(e){return null==e||Story.has(e)?e:t.helpers.evalText(e)}},hasBlockContext:{value:function(e){for(var t="function"==typeof window.getComputedStyle,r=e.length-1;r>=0;--r){var n=e[r];switch(n.nodeType){case Node.ELEMENT_NODE:var a=n.nodeName.toUpperCase();if("BR"===a)return!0;var i=t?window.getComputedStyle(n,null):n.currentStyle;if(i&&i.display){if("none"===i.display)continue;return"block"===i.display}switch(a){case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":return!0}return!1;case Node.COMMENT_NODE:continue;default:return!1}}return!0}},createShadowSetterCallback:{value:function(){function e(){if(!a&&!(a=t.Parser.get("macro")))throw new Error('cannot find "macro" parser');return a}function r(){for(var t=a||e(),r=new Set,n=t.context;null!==n;n=n.parent)n._shadows&&n._shadows.forEach(function(e){return r.add(e)});return[].concat(_toConsumableArray(r))}function n(e){var t={};return r().forEach(function(e){var r=e.slice(1),n="$"===e[0]?State.variables:State.temporary;t[e]=n[r]}),function(){var r=Object.keys(t),n=r.length>0?{}:null;try{return r.forEach(function(e){var r=e.slice(1),a="$"===e[0]?State.variables:State.temporary;a.hasOwnProperty(r)&&(n[r]=a[r]),a[r]=t[e]}),Scripting.evalJavaScript(e)}finally{r.forEach(function(e){var r=e.slice(1),a="$"===e[0]?State.variables:State.temporary;t[e]=a[r],n.hasOwnProperty(r)?a[r]=n[r]:delete a[r]})}}}var a=null;return n}()},parseSquareBracketedMarkup:{value:function(){function e(e,t){e:for(;;)switch(e.next()){case"\\":var r=e.next();if(r!==EOF&&"\n"!==r)break;case EOF:case"\n":return EOF;case t:break e}return e.pos}function t(e){if(!e.accept("["))return e.error(o.Error,"malformed square-bracketed markup");if(e.accept("["))e.data.isLink=!0,e.emit(o.LinkMeta);else{if(e.accept("<>"),!(e.accept("Ii")&&e.accept("Mm")&&e.accept("Gg")&&e.accept("[")))return e.error(o.Error,"malformed square-bracketed markup");e.data.isLink=!1,e.emit(o.ImageMeta)}return e.depth=2,r}function r(t){for(var r=t.data.isLink?"link":"image",i=s.None;;)switch(t.next()){case EOF:case"\n":return t.error(o.Error,"unterminated "+r+" markup");case'"':if(e(t,'"')===EOF)return t.error(o.Error,"unterminated double quoted string in "+r+" markup");break;case"|":i===s.None&&(i=s.LTR,t.backup(),t.emit(o.Text),t.forward(),t.emit(o.DelimLTR));break;case"-":i===s.None&&">"===t.peek()&&(i=s.LTR,t.backup(),t.emit(o.Text),t.forward(2),t.emit(o.DelimLTR));break;case"<":i===s.None&&"-"===t.peek()&&(i=s.RTL,t.backup(),t.emit(t.data.isLink?o.Link:o.Source),t.forward(2),t.emit(o.DelimRTL));break;case"[":++t.depth;break;case"]":if(1===--t.depth)switch(t.peek()){case"[":return++t.depth,t.backup(),i===s.RTL?t.emit(o.Text):t.emit(t.data.isLink?o.Link:o.Source),t.forward(2),t.emit(o.InnerMeta),t.data.isLink?a:n;case"]":return--t.depth,t.backup(),i===s.RTL?t.emit(o.Text):t.emit(t.data.isLink?o.Link:o.Source),t.forward(2),t.emit(o.RightMeta),null;default:return t.error(o.Error,"malformed "+r+" markup")}}}function n(t){for(var r=t.data.isLink?"link":"image";;)switch(t.next()){case EOF:case"\n":return t.error(o.Error,"unterminated "+r+" markup");case'"':if(e(t,'"')===EOF)return t.error(o.Error,"unterminated double quoted string in "+r+" markup link component");break;case"[":++t.depth;break;case"]":if(1===--t.depth)switch(t.peek()){case"[":return++t.depth,t.backup(),t.emit(o.Link),t.forward(2),t.emit(o.InnerMeta),a;case"]":return--t.depth,t.backup(),t.emit(o.Link),t.forward(2),t.emit(o.RightMeta),null;default:return t.error(o.Error,"malformed "+r+" markup")}}}function a(t){for(var r=t.data.isLink?"link":"image";;)switch(t.next()){case EOF:case"\n":return t.error(o.Error,"unterminated "+r+" markup");case'"':if(e(t,'"')===EOF)return t.error(o.Error,"unterminated double quoted string in "+r+" markup setter component");break;case"'":if(e(t,"'")===EOF)return t.error(o.Error,"unterminated single quoted string in "+r+" markup setter component");break;case"[":++t.depth;break;case"]":if(1===--t.depth)return"]"!==t.peek()?t.error(o.Error,"malformed "+r+" markup"):(--t.depth,t.backup(),t.emit(o.Setter),t.forward(2),t.emit(o.RightMeta),null)}}function i(e){var r=new Lexer(e.source,t);r.start=r.pos=e.matchStart;var n={},a=r.run(),i=a.last();return i&&i.type===o.Error?n.error=i.message:a.forEach(function(e){var t=e.text.trim();switch(e.type){case o.ImageMeta:n.isImage=!0,"<"===t[1]?n.align="left":">"===t[1]&&(n.align="right");break;case o.LinkMeta:n.isLink=!0;break;case o.Link:"~"===t[0]?(n.forceInternal=!0,n.link=t.slice(1)):n.link=t;break;case o.Setter:n.setter=t;break;case o.Source:n.source=t;break;case o.Text:n.text=t}}),n.pos=r.pos,n}var o=Lexer.enumFromNames(["Error","DelimLTR","DelimRTL","InnerMeta","ImageMeta","LinkMeta","Link","RightMeta","Setter","Source","Text"]),s=Lexer.enumFromNames(["None","LTR","RTL"]);return i}()}}),t}();!function(){function e(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);t&&t.index===e.matchStart&&(e.nextMatch=this.lookahead.lastIndex,jQuery(document.createDocumentFragment()).append(t[1]).appendTo(e.output))}Wikifier.Parser.add({name:"quoteByBlock",profiles:["block"],match:"^<<<\\n",terminator:"^<<<\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));e.subWikify(jQuery(document.createElement("blockquote")).appendTo(e.output).get(0),this.terminator)}}),Wikifier.Parser.add({name:"quoteByLine",profiles:["block"],match:"^>+",lookahead:/^>+/gm,terminator:"\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));var t=[e.output],r=0,n=e.matchLength,a=void 0,i=void 0;do{if(n>r)for(i=r;i<n;++i)t.push(jQuery(document.createElement("blockquote")).appendTo(t[t.length-1]).get(0));else if(n<r)for(i=r;i>n;--i)t.pop();r=n,e.subWikify(t[t.length-1],this.terminator),jQuery(document.createElement("br")).appendTo(t[t.length-1]),this.lookahead.lastIndex=e.nextMatch;var o=this.lookahead.exec(e.source);a=o&&o.index===e.nextMatch,a&&(n=o[0].length,e.nextMatch+=o[0].length)}while(a)}}),Wikifier.Parser.add({name:"macro",profiles:["core"],match:"<<",lookahead:new RegExp("<<(/?"+Patterns.macroName+")(?:\\s*)((?:(?:`(?:\\\\.|[^`\\\\])*`)|(?:\"(?:\\\\.|[^\"\\\\])*\")|(?:'(?:\\\\.|[^'\\\\])*')|(?:\\[(?:[<>]?[Ii][Mm][Gg])?\\[[^\\r\\n]*?\\]\\]+)|[^>]|(?:>(?!>)))*)>>","gm"),working:{source:"",name:"",arguments:"",index:0},context:null,handler:function(e){var t=this.lookahead.lastIndex=e.matchStart;if(this.parseTag(e)){var r=e.nextMatch,n=this.working.name,a=this.working.arguments,i=void 0;try{if(!(i=Macro.get(n))){if(Macro.tags.has(n)){var o=Macro.tags.get(n);return throwError(e.output,"child tag <<"+n+">> was found outside of a call to its parent macro"+(1===o.length?"":"s")+" <<"+o.join(">>, <<")+">>",e.source.slice(t,e.nextMatch))}return throwError(e.output,"macro <<"+n+">> does not exist",e.source.slice(t,e.nextMatch))}var s=null;if(i.hasOwnProperty("tags")&&!(s=this.parseBody(e,i)))return e.nextMatch=r,throwError(e.output,"cannot find a closing tag for macro <<"+n+">>",e.source.slice(t,e.nextMatch)+"…");if("function"!=typeof i.handler)return throwError(e.output,"macro <<"+n+">> handler function "+(i.hasOwnProperty("handler")?"is not a function":"does not exist"),e.source.slice(t,e.nextMatch));var u=s?s[0].args:this.createArgs(a,this.skipArgs(i,i.name));if(i.hasOwnProperty("_MACRO_API")){this.context=new MacroContext({macro:i,name:n,args:u,payload:s,source:e.source.slice(t,e.nextMatch),parent:this.context,parser:e});try{i.handler.call(this.context)}finally{this.context=this.context.parent}}else{var l=e._rawArgs;e._rawArgs=a;try{i.handler(e.output,n,u,e,s)}finally{e._rawArgs=l}}}catch(r){return throwError(e.output,"cannot execute "+(i&&i.isWidget?"widget":"macro")+" <<"+n+">>: "+r.message,e.source.slice(t,e.nextMatch))}finally{this.working.source="",this.working.name="",this.working.arguments="",this.working.index=0}}else e.outputText(e.output,e.matchStart,e.nextMatch)},parseTag:function(e){var t=this.lookahead.exec(e.source);return!(!t||t.index!==e.matchStart||!t[1])&&(e.nextMatch=this.lookahead.lastIndex,this.working.source=e.source.slice(t.index,this.lookahead.lastIndex),this.working.name=t[1],this.working.arguments=t[2],this.working.index=t.index,!0)},parseBody:function(e,t){for(var r=this.working.name,n="/"+r,a="end"+r,i=!!Array.isArray(t.tags)&&t.tags,o=[],s=-1,u=1,l=this.working.source,c=this.working.name,d=this.working.arguments,f=e.nextMatch;-1!==(e.matchStart=e.source.indexOf(this.match,e.nextMatch));)if(this.parseTag(e)){var p=this.working.source,h=this.working.name,g=this.working.arguments,m=this.working.index,v=e.nextMatch;switch(h){case r:++u;break;case a:case n:--u;break;default:if(1===u&&i)for(var y=0,b=i.length;y<b;++y)h===i[y]&&(o.push({source:l,name:c,arguments:d,args:this.createArgs(d,this.skipArgs(t,c)),contents:e.source.slice(f,m)}),l=p,c=h,d=g,f=v)}if(0===u){o.push({source:l,name:c,arguments:d,args:this.createArgs(d,this.skipArgs(t,c)),contents:e.source.slice(f,m)}),s=v;break}}else this.lookahead.lastIndex=e.nextMatch=e.matchStart+this.match.length;return-1!==s?(e.nextMatch=s,o):null},createArgs:function(e,t){var r=t?[]:this.parseArgs(e);return Object.defineProperties(r,{raw:{value:e},full:{value:Scripting.parse(e)}}),r},skipArgs:function(e,t){if(e.hasOwnProperty("skipArgs")){var r=e.skipArgs;return"boolean"==typeof r&&r||Array.isArray(r)&&r.includes(t)}return!!e.hasOwnProperty("skipArg0")&&(e.skipArg0&&e.name===t)},parseArgs:function(){function e(e,t){e:for(;;)switch(e.next()){case"\\":var r=e.next();if(r!==EOF&&"\n"!==r)break;case EOF:case"\n":return EOF;case t:break e}return e.pos}function t(e){var t=e.source.slice(e.pos).search(c);if(t===EOF)return null;switch(0!==t&&(e.pos+=t,e.ignore()),e.next()){case"`":return r;case'"':return n;case"'":return a;case"[":return i;default:return o}}function r(r){return e(r,"`")===EOF?r.error(u.Error,"unterminated backquote expression"):(r.emit(u.Expression),t)}function n(r){return e(r,'"')===EOF?r.error(u.Error,"unterminated double quoted string"):(r.emit(u.String),t)}function a(r){return e(r,"'")===EOF?r.error(u.Error,"unterminated single quoted string"):(r.emit(u.String),t)}function i(e){var r=void 0;if(e.accept("<>IiMmGg")?(r="image",e.acceptRun("<>IiMmGg")):r="link",!e.accept("["))return e.error(u.Error,"malformed "+r+" markup");e.depth=2;e:for(;;)switch(e.next()){case"\\":var n=e.next();if(n!==EOF&&"\n"!==n)break;case EOF:case"\n":return e.error(u.Error,"unterminated "+r+" markup");case"[":++e.depth;break;case"]":if(--e.depth<0)return e.error(u.Error,"unexpected right square bracket ']'");if(1===e.depth){if("]"===e.next()){--e.depth;break e}e.backup()}}return e.emit(u.SquareBracket),t}function o(e){var r=e.source.slice(e.pos).search(l);return e.pos=r===EOF?e.source.length:e.pos+r,e.emit(u.Bareword),r===EOF?null:t}function s(e){var r=new Lexer(e,t),n=[];return r.run().forEach(function(e){var t=e.text;switch(e.type){case u.Error:throw new Error('unable to parse macro argument "'+t+'": '+e.message);case u.Bareword:if(d.test(t))t=State.getVar(t);else if(/^(?:settings|setup)[.[]/.test(t))try{t=Scripting.evalTwineScript(t)}catch(e){throw new Error('unable to parse macro argument "'+t+'": '+e.message)}else if("null"===t)t=null;else if("undefined"===t)t=undefined;else if("true"===t)t=!0;else if("false"===t)t=!1;else if("NaN"===t)t=NaN;else{var r=Number(t);Number.isNaN(r)||(t=r)}break;case u.Expression:if(""===(t=t.slice(1,-1).trim()))t=undefined;else try{t=Scripting.evalTwineScript("("+t+")")}catch(e){throw new Error('unable to parse macro argument expression "'+t+'": '+e.message)}break;case u.String:try{t=Scripting.evalJavaScript(t)}catch(e){throw new Error('unable to parse macro argument string "'+t+'": '+e.message)}break;case u.SquareBracket:var a=Wikifier.helpers.parseSquareBracketedMarkup({source:t,matchStart:0});if(a.hasOwnProperty("error"))throw new Error('unable to parse macro argument "'+t+'": '+a.error);if(a.pos<t.length)throw new Error('unable to parse macro argument "'+t+'": unexpected character(s) "'+t.slice(a.pos)+'" (pos: '+a.pos+")");a.isLink?(t={isLink:!0},t.count=a.hasOwnProperty("text")?2:1,t.link=Wikifier.helpers.evalPassageId(a.link),t.text=a.hasOwnProperty("text")?Wikifier.helpers.evalText(a.text):t.link,t.external=!a.forceInternal&&Wikifier.isExternalLink(t.link),t.setFn=a.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(a.setter)):null):a.isImage&&(t=function(e){var t={source:e,isImage:!0};if("data:"!==e.slice(0,5)&&Story.has(e)){var r=Story.get(e);r.tags.includes("Twine.image")&&(t.source=r.text,t.passage=r.title)}return t}(Wikifier.helpers.evalPassageId(a.source)),a.hasOwnProperty("align")&&(t.align=a.align),a.hasOwnProperty("text")&&(t.title=Wikifier.helpers.evalText(a.text)),a.hasOwnProperty("link")&&(t.link=Wikifier.helpers.evalPassageId(a.link),t.external=!a.forceInternal&&Wikifier.isExternalLink(t.link)),t.setFn=a.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(a.setter)):null)}n.push(t)}),n}var u=Lexer.enumFromNames(["Error","Bareword","Expression","String","SquareBracket"]),l=new RegExp(Patterns.space),c=new RegExp(Patterns.notSpace),d=new RegExp("^"+Patterns.variable);return s}()}),Wikifier.Parser.add({name:"link",profiles:["core"],match:"\\[\\[[^[]",handler:function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup(e);if(t.hasOwnProperty("error"))return void e.outputText(e.output,e.matchStart,e.nextMatch);e.nextMatch=t.pos;var r=Wikifier.helpers.evalPassageId(t.link),n=t.hasOwnProperty("text")?Wikifier.helpers.evalText(t.text):r,a=t.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(t.setter)):null,i=(Config.debug?new DebugView(e.output,"link-markup","[[link]]",e.source.slice(e.matchStart,e.nextMatch)):e).output;t.forceInternal||!Wikifier.isExternalLink(r)?Wikifier.createInternalLink(i,r,n,a):Wikifier.createExternalLink(i,r,n)}}),Wikifier.Parser.add({name:"urlLink",profiles:["core"],match:Patterns.url,handler:function(e){
e.outputText(Wikifier.createExternalLink(e.output,e.matchText),e.matchStart,e.nextMatch)}}),Wikifier.Parser.add({name:"image",profiles:["core"],match:"\\[[<>]?[Ii][Mm][Gg]\\[",handler:function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup(e);if(t.hasOwnProperty("error"))return void e.outputText(e.output,e.matchStart,e.nextMatch);e.nextMatch=t.pos;var r=void 0;Config.debug&&(r=new DebugView(e.output,"image-markup",t.hasOwnProperty("link")?"[img[][link]]":"[img[]]",e.source.slice(e.matchStart,e.nextMatch)),r.modes({block:!0}));var n=t.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(t.setter)):null,a=(Config.debug?r:e).output,i=void 0;if(t.hasOwnProperty("link")){var o=Wikifier.helpers.evalPassageId(t.link);a=t.forceInternal||!Wikifier.isExternalLink(o)?Wikifier.createInternalLink(a,o,null,n):Wikifier.createExternalLink(a,o),a.classList.add("link-image")}if(a=jQuery(document.createElement("img")).appendTo(a).get(0),i=Wikifier.helpers.evalPassageId(t.source),"data:"!==i.slice(0,5)&&Story.has(i)){var s=Story.get(i);s.tags.includes("Twine.image")&&(a.setAttribute("data-passage",s.title),i=s.text.trim())}a.src=i,t.hasOwnProperty("text")&&(a.title=Wikifier.helpers.evalText(t.text)),t.hasOwnProperty("align")&&(a.align=t.align)}}),Wikifier.Parser.add({name:"monospacedByBlock",profiles:["block"],match:"^\\{\\{\\{\\n",lookahead:/^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/gm,handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);if(t&&t.index===e.matchStart){var r=jQuery(document.createElement("pre"));jQuery(document.createElement("code")).text(t[1]).appendTo(r),r.appendTo(e.output),e.nextMatch=this.lookahead.lastIndex}}}),Wikifier.Parser.add({name:"formatByChar",profiles:["core"],match:"''|//|__|\\^\\^|~~|==|\\{\\{\\{",handler:function(e){switch(e.matchText){case"''":e.subWikify(jQuery(document.createElement("strong")).appendTo(e.output).get(0),"''");break;case"//":e.subWikify(jQuery(document.createElement("em")).appendTo(e.output).get(0),"//");break;case"__":e.subWikify(jQuery(document.createElement("u")).appendTo(e.output).get(0),"__");break;case"^^":e.subWikify(jQuery(document.createElement("sup")).appendTo(e.output).get(0),"\\^\\^");break;case"~~":e.subWikify(jQuery(document.createElement("sub")).appendTo(e.output).get(0),"~~");break;case"==":e.subWikify(jQuery(document.createElement("s")).appendTo(e.output).get(0),"==");break;case"{{{":var t=/\{\{\{((?:.|\n)*?)\}\}\}/gm;t.lastIndex=e.matchStart;var r=t.exec(e.source);r&&r.index===e.matchStart&&(jQuery(document.createElement("code")).text(r[1]).appendTo(e.output),e.nextMatch=t.lastIndex)}}}),Wikifier.Parser.add({name:"customStyle",profiles:["core"],match:"@@",terminator:"@@",blockRe:/\s*\n/gm,handler:function(e){var t=Wikifier.helpers.inlineCss(e);this.blockRe.lastIndex=e.nextMatch;var r=this.blockRe.exec(e.source),n=r&&r.index===e.nextMatch,a=jQuery(document.createElement(n?"div":"span")).appendTo(e.output);0===t.classes.length&&""===t.id&&0===Object.keys(t.styles).length?a.addClass("marked"):(t.classes.forEach(function(e){return a.addClass(e)}),""!==t.id&&a.attr("id",t.id),a.css(t.styles)),n?(e.nextMatch+=r[0].length,e.subWikify(a[0],"\\n?"+this.terminator)):e.subWikify(a[0],this.terminator)}}),Wikifier.Parser.add({name:"verbatimText",profiles:["core"],match:'"{3}|<[Nn][Oo][Ww][Ii][Kk][Ii]>',lookahead:/(?:"{3}((?:.|\n)*?)"{3})|(?:<[Nn][Oo][Ww][Ii][Kk][Ii]>((?:.|\n)*?)<\/[Nn][Oo][Ww][Ii][Kk][Ii]>)/gm,handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);t&&t.index===e.matchStart&&(e.nextMatch=this.lookahead.lastIndex,jQuery(document.createElement("span")).addClass("verbatim").text(t[1]||t[2]).appendTo(e.output))}}),Wikifier.Parser.add({name:"horizontalRule",profiles:["core"],match:"^----+$\\n?|<[Hh][Rr]\\s*/?>\\n?",handler:function(e){jQuery(document.createElement("hr")).appendTo(e.output)}}),Wikifier.Parser.add({name:"emdash",profiles:["core"],match:"--",handler:function(e){jQuery(document.createTextNode("—")).appendTo(e.output)}}),Wikifier.Parser.add({name:"doubleDollarSign",profiles:["core"],match:"\\${2}",handler:function(e){jQuery(document.createTextNode("$")).appendTo(e.output)}}),Wikifier.Parser.add({name:"nakedVariable",profiles:["core"],match:Patterns.variable+"(?:(?:\\."+Patterns.identifier+")|(?:\\[\\d+\\])|(?:\\[\"(?:\\\\.|[^\"\\\\])+\"\\])|(?:\\['(?:\\\\.|[^'\\\\])+'\\])|(?:\\["+Patterns.variable+"\\]))*",handler:function(e){var t=toStringOrDefault(State.getVar(e.matchText),null);null===t?jQuery(document.createTextNode(e.matchText)).appendTo(e.output):new Wikifier((Config.debug?new DebugView(e.output,"variable",e.matchText,e.matchText):e).output,t)}}),Wikifier.Parser.add({name:"template",profiles:["core"],match:"\\?"+Patterns.templateName,handler:function(e){var t=e.matchText.slice(1),r=Template.get(t),n=null;switch(r instanceof Array&&(r=r.random()),void 0===r?"undefined":_typeof(r)){case"function":try{n=toStringOrDefault(r.call({name:t}),null)}catch(r){return throwError(e.output,"cannot execute function template ?"+t+": "+r.message,e.source.slice(e.matchStart,e.nextMatch))}break;case"string":n=r}null===n?jQuery(document.createTextNode(e.matchText)).appendTo(e.output):new Wikifier((Config.debug?new DebugView(e.output,"template",e.matchText,e.matchText):e).output,n)}}),Wikifier.Parser.add({name:"heading",profiles:["block"],match:"^!{1,6}",terminator:"\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));e.subWikify(jQuery(document.createElement("h"+e.matchLength)).appendTo(e.output).get(0),this.terminator)}}),Wikifier.Parser.add({name:"table",profiles:["block"],match:"^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",lookahead:/^\|([^\n]*)\|([fhck]?)$/gm,rowTerminator:"\\|(?:[cfhk]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[cfhk]?$\\n?)",cellTerminator:"(?:\\u0020*)\\|",rowTypes:{c:"caption",f:"tfoot",h:"thead","":"tbody"},handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));var t=jQuery(document.createElement("table")).appendTo(e.output).get(0),r=[],n=null,a=null,i=0,o=void 0;e.nextMatch=e.matchStart;do{this.lookahead.lastIndex=e.nextMatch;var s=this.lookahead.exec(e.source);if(o=s&&s.index===e.nextMatch){var u=s[2];"k"===u?(t.className=s[1],e.nextMatch+=s[0].length+1):(u!==n&&(n=u,a=jQuery(document.createElement(this.rowTypes[u])).appendTo(t)),"c"===n?(a.css("caption-side",0===i?"top":"bottom"),e.nextMatch+=1,e.subWikify(a[0],this.rowTerminator)):this.rowHandler(e,jQuery(document.createElement("tr")).appendTo(a).get(0),r),++i)}}while(o)},rowHandler:function(e,t,r){var n=this,a=new RegExp(this.cellPattern,"gm"),i=0,o=1,s=void 0;do{a.lastIndex=e.nextMatch;var u=a.exec(e.source);if(s=u&&u.index===e.nextMatch){if("~"===u[1]){var l=r[i];l&&(++l.rowCount,l.$element.attr("rowspan",l.rowCount).css("vertical-align","middle")),e.nextMatch=u.index+u[0].length-1}else if(">"===u[1])++o,e.nextMatch=u.index+u[0].length-1;else{if(u[2]){e.nextMatch=u.index+u[0].length;break}!function(){++e.nextMatch;for(var a=Wikifier.helpers.inlineCss(e),s=!1,u=!1,l=void 0;" "===e.source.substr(e.nextMatch,1);)s=!0,++e.nextMatch;"!"===e.source.substr(e.nextMatch,1)?(l=jQuery(document.createElement("th")).appendTo(t),++e.nextMatch):l=jQuery(document.createElement("td")).appendTo(t),r[i]={rowCount:1,$element:l},o>1&&(l.attr("colspan",o),o=1),e.subWikify(l[0],n.cellTerminator)," "===e.matchText.substr(e.matchText.length-2,1)&&(u=!0),a.classes.forEach(function(e){return l.addClass(e)}),""!==a.id&&l.attr("id",a.id),s&&u?a.styles["text-align"]="center":s?a.styles["text-align"]="right":u&&(a.styles["text-align"]="left"),l.css(a.styles),e.nextMatch=e.nextMatch-1}()}++i}}while(s)}}),Wikifier.Parser.add({name:"list",profiles:["block"],match:"^(?:(?:\\*+)|(?:#+))",lookahead:/^(?:(\*+)|(#+))/gm,terminator:"\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));e.nextMatch=e.matchStart;var t=[e.output],r=null,n=0,a=void 0,i=void 0;do{this.lookahead.lastIndex=e.nextMatch;var o=this.lookahead.exec(e.source);if(a=o&&o.index===e.nextMatch){var s=o[2]?"ol":"ul",u=o[0].length;if(e.nextMatch+=o[0].length,u>n)for(i=n;i<u;++i)t.push(jQuery(document.createElement(s)).appendTo(t[t.length-1]).get(0));else if(u<n)for(i=n;i>u;--i)t.pop();else u===n&&s!==r&&(t.pop(),t.push(jQuery(document.createElement(s)).appendTo(t[t.length-1]).get(0)));n=u,r=s,e.subWikify(jQuery(document.createElement("li")).appendTo(t[t.length-1]).get(0),this.terminator)}}while(a)}}),Wikifier.Parser.add({name:"commentByBlock",profiles:["core"],match:"(?:/(?:%|\\*))|(?:\x3c!--)",lookahead:/(?:\/(%|\*)(?:(?:.|\n)*?)\1\/)|(?:<!--(?:(?:.|\n)*?)-->)/gm,handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);t&&t.index===e.matchStart&&(e.nextMatch=this.lookahead.lastIndex)}}),Wikifier.Parser.add({name:"lineContinuation",profiles:["core"],match:"\\\\"+Patterns.spaceNoTerminator+"*\\n|\\n"+Patterns.spaceNoTerminator+"*\\\\|\\n?\\\\"+Patterns.spaceNoTerminator+"*$|^"+Patterns.spaceNoTerminator+"*\\\\\\n?",handler:function(e){e.nextMatch=e.matchStart+e.matchLength}}),Wikifier.Parser.add({name:"lineBreak",profiles:["core"],match:"\\n|<[Bb][Rr]\\s*/?>",handler:function(e){e.options.nobr||jQuery(document.createElement("br")).appendTo(e.output)}}),Wikifier.Parser.add({name:"htmlCharacterReference",profiles:["core"],match:"(?:(?:&#?[0-9A-Za-z]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9A-Fa-f]|1D[C-Fc-f][0-9A-Fa-f]|20[D-Fd-f][0-9A-Fa-f]|FE2[0-9A-Fa-f])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[0-9A-Za-z]{2,8};)",handler:function(e){jQuery(document.createDocumentFragment()).append(e.matchText).appendTo(e.output)}}),Wikifier.Parser.add({name:"xmlProlog",profiles:["core"],match:"<\\?[Xx][Mm][Ll][^>]*\\?>",handler:function(e){e.nextMatch=e.matchStart+e.matchLength}}),Wikifier.Parser.add({name:"verbatimHtml",profiles:["core"],match:"<[Hh][Tt][Mm][Ll]>",lookahead:/<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/gm,handler:e}),Wikifier.Parser.add({name:"verbatimSvgTag",profiles:["core"],match:"<[Ss][Vv][Gg][^>]*>",lookahead:/(<[Ss][Vv][Gg][^>]*>(?:.|\n)*?<\/[Ss][Vv][Gg]>)/gm,handler:e}),Wikifier.Parser.add({name:"verbatimScriptTag",profiles:["core"],match:"<[Ss][Cc][Rr][Ii][Pp][Tt][^>]*>",lookahead:/(<[Ss][Cc][Rr][Ii][Pp][Tt]*>(?:.|\n)*?<\/[Ss][Cc][Rr][Ii][Pp][Tt]>)/gm,handler:e}),Wikifier.Parser.add({name:"styleTag",profiles:["core"],match:"<[Ss][Tt][Yy][Ll][Ee][^>]*>",lookahead:/(<[Ss][Tt][Yy][Ll][Ee]*>)((?:.|\n)*?)(<\/[Ss][Tt][Yy][Ll][Ee]>)/gm,imageMarkup:new RegExp(Patterns.cssImage,"g"),hasImageMarkup:new RegExp(Patterns.cssImage),handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);if(t&&t.index===e.matchStart){e.nextMatch=this.lookahead.lastIndex;var r=t[2];this.hasImageMarkup.test(r)&&(this.imageMarkup.lastIndex=0,r=r.replace(this.imageMarkup,function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup({source:e,matchStart:0});if(t.hasOwnProperty("error")||t.pos<e.length)return e;var r=t.source;if("data:"!==r.slice(0,5)&&Story.has(r)){var n=Story.get(r);n.tags.includes("Twine.image")&&(r=n.text)}return'url("'+r.replace(/"/g,"%22")+'")'})),jQuery(document.createDocumentFragment()).append(t[1]+r+t[3]).appendTo(e.output)}}}),Wikifier.Parser.add({name:"htmlTag",profiles:["core"],match:"<\\w+(?:\\s+[^\\u0000-\\u001F\\u007F-\\u009F\\s\"'>\\/=]+(?:\\s*=\\s*(?:\"[^\"]*?\"|'[^']*?'|[^\\s\"'=<>`]+))?)*\\s*\\/?>",tagRe:/^<(\w+)/,mediaElements:["audio","img","source","track","video"],nobrElements:["audio","colgroup","datalist","dl","figure","ol","optgroup","picture","select","table","tbody","tfoot","thead","tr","ul","video"],voidElements:["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"],handler:function(e){var t=this.tagRe.exec(e.matchText),r=t&&t[1],n=r&&r.toLowerCase();if(n){var a=this.voidElements.includes(n)||e.matchText.endsWith("/>"),i=this.nobrElements.includes(n),o=void 0,s=void 0;if(!a){o="<\\/"+n+"\\s*>";var u=new RegExp(o,"gim");u.lastIndex=e.matchStart,s=u.exec(e.source)}if(!a&&!s)return throwError(e.output,"cannot find a closing tag for HTML <"+r+">",e.matchText+"…");var l=e.output,c=document.createElement(e.output.tagName),d=void 0;for(c.innerHTML=e.matchText;c.firstChild;)c=c.firstChild;try{this.processAttributeDirectives(c)}catch(t){return throwError(e.output,"<"+n+">: "+t.message,e.matchText+"…")}c.hasAttribute("data-passage")&&(this.processDataAttributes(c,n),Config.debug&&(d=new DebugView(e.output,"html-"+n,n,e.matchText),d.modes({block:"img"===n,nonvoid:s}),l=d.output)),s&&(e.subWikify(c,o,{ignoreTerminatorCase:!0,nobr:i}),d&&jQuery(c).find(".debug.block").length>0&&d.modes({block:!0})),l.appendChild("track"===n?c.cloneNode(!0):c)}},processAttributeDirectives:function(e){[].concat(_toConsumableArray(e.attributes)).forEach(function(t){var r=t.name,n=t.value,a="@"===r[0];if(a||r.startsWith("sc-eval:")){var i=r.slice(a?1:8),o=void 0;try{o=Scripting.evalTwineScript(n)}catch(e){throw new Error('bad evaluation from attribute directive "'+r+'": '+e.message)}try{e.setAttribute(i,o),e.removeAttribute(r)}catch(e){throw new Error('cannot transform attribute directive "'+r+'" into attribute "'+i+'"')}}})},processDataAttributes:function(e,t){var r=e.getAttribute("data-passage");if(null!=r){var n=Wikifier.helpers.evalPassageId(r);if(n!==r&&(r=n,e.setAttribute("data-passage",n)),""!==r)if(this.mediaElements.includes(t)){if("data:"!==r.slice(0,5)&&Story.has(r)){r=Story.get(r);var a=void 0,i=void 0;switch(t){case"audio":case"video":i="Twine."+t;break;case"img":i="Twine.image";break;case"track":i="Twine.vtt";break;case"source":var o=$(e).closest("audio,picture,video");o.length&&(a=o.get(0).tagName.toLowerCase(),i="Twine."+("picture"===a?"image":a))}r.tags.includes(i)&&(e["picture"===a?"srcset":"src"]=r.text.trim())}}else{var s=e.getAttribute("data-setter"),u=void 0;null!=s&&""!==(s=String(s).trim())&&(u=Wikifier.helpers.createShadowSetterCallback(Scripting.parse(s))),Story.has(r)?(e.classList.add("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(r)&&e.classList.add("link-visited")):e.classList.add("link-broken"),jQuery(e).ariaClick({one:!0},function(){"function"==typeof u&&u.call(this),Engine.play(r)})}}}})}();var Template=function(){function e(e,t){if(!(s(t)||t instanceof Array&&t.length>0&&t.every(s)))throw new Error("invalid template type ("+e+"); templates must be: functions, strings, or an array of either");(e instanceof Array?e:[e]).forEach(function(e){if(i.has(e))throw new Error("cannot clobber existing template ?"+e);if(!o.test(e))throw new Error('invalid template name "'+e+'"');i.set(e,t)})}function t(e){(e instanceof Array?e:[e]).forEach(function(e){return i.delete(e)})}function r(e){return i.has(e)?i.get(e):null}function n(e){return i.has(e)}function a(){return i.size}var i=new Map,o=new RegExp("^(?:"+Patterns.templateName+")$"),s=function(e){var t=void 0===e?"undefined":_typeof(e);return"function"===t||"string"===t};return Object.freeze(Object.defineProperties({},{add:{value:e},delete:{value:t},get:{value:r},has:{value:n},size:{get:a}}))}(),Macro=function(){function e(t,r,a){if(Array.isArray(t))return void t.forEach(function(t){return e(t,r,a)});if(!f.test(t))throw new Error('invalid macro name "'+t+'"');if(n(t))throw new Error("cannot clobber existing macro <<"+t+">>");if(u(t))throw new Error("cannot clobber child tag <<"+t+">> of parent macro"+(1===d[t].length?"":"s")+" <<"+d[t].join(">>, <<")+">>");try{if("object"===(void 0===r?"undefined":_typeof(r)))c[t]=a?clone(r):r;else{if(!n(r))throw new Error("cannot create alias of nonexistent macro <<"+r+">>");c[t]=a?clone(c[r]):c[r]}Object.defineProperty(c,t,{writable:!1}),c[t]._MACRO_API=!0}catch(e){throw"TypeError"===e.name?new Error("cannot clobber protected macro <<"+t+">>"):new Error("unknown error when attempting to add macro <<"+t+">>: ["+e.name+"] "+e.message)}if(c[t].hasOwnProperty("tags"))if(null==c[t].tags)o(t);else{if(!Array.isArray(c[t].tags))throw new Error('bad value for "tags" property of macro <<'+t+">>");o(t,c[t].tags)}}function t(e){if(Array.isArray(e))return void e.forEach(function(e){return t(e)});if(n(e)){c[e].hasOwnProperty("tags")&&s(e);try{Object.defineProperty(c,e,{writable:!0}),delete c[e]}catch(t){throw new Error("unknown error removing macro <<"+e+">>: "+t.message)}}else if(u(e))throw new Error("cannot remove child tag <<"+e+">> of parent macro <<"+d[e]+">>")}function r(){return 0===Object.keys(c).length}function n(e){return c.hasOwnProperty(e)}function a(e){var t=null;return n(e)&&"function"==typeof c[e].handler?t=c[e]:macros.hasOwnProperty(e)&&"function"==typeof macros[e].handler&&(t=macros[e]),t}function i(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"init";Object.keys(c).forEach(function(t){"function"==typeof c[t][e]&&c[t][e](t)}),Object.keys(macros).forEach(function(t){"function"==typeof macros[t][e]&&macros[t][e](t)})}function o(e,t){if(!e)throw new Error("no parent specified");for(var r=["/"+e,"end"+e],a=[].concat(r,Array.isArray(t)?t:[]),i=0;i<a.length;++i){var o=a[i];if(n(o))throw new Error("cannot register tag for an existing macro");u(o)?d[o].includes(e)||(d[o].push(e),d[o].sort()):d[o]=[e]}}function s(e){if(!e)throw new Error("no parent specified");Object.keys(d).forEach(function(t){var r=d[t].indexOf(e);-1!==r&&(1===d[t].length?delete d[t]:d[t].splice(r,1))})}function u(e){return d.hasOwnProperty(e)}function l(e){return u(e)?d[e]:null}var c={},d={},f=new RegExp("^(?:"+Patterns.macroName+")$");return Object.freeze(Object.defineProperties({},{add:{value:e},delete:{value:t},isEmpty:{value:r},has:{value:n},get:{value:a},init:{value:i},tags:{value:Object.freeze(Object.defineProperties({},{register:{value:o},unregister:{value:s},has:{value:u},get:{value:l}}))},evalStatements:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}}}))}(),MacroContext=function(){return function(){function e(t){_classCallCheck(this,e);var r=Object.assign({parent:null,macro:null,name:"",args:null,payload:null,parser:null,source:""},t);if(null===r.macro||""===r.name||null===r.parser)throw new TypeError("context object missing required properties");Object.defineProperties(this,{self:{value:r.macro},name:{value:r.name},args:{value:r.args},payload:{value:r.payload},source:{value:r.source},parent:{value:r.parent},parser:{value:r.parser},_output:{value:r.parser.output},_shadows:{writable:!0,value:null},_debugView:{writable:!0,value:null},_debugViewEnabled:{writable:!0,value:Config.debug}})}return _createClass(e,[{key:"contextHas",value:function(e){for(var t=this;null!==(t=t.parent);)if(e(t))return!0;return!1}},{key:"contextSelect",value:function(e){for(var t=this;null!==(t=t.parent);)if(e(t))return t;return null}},{key:"contextSelectAll",value:function(e){for(var t=[],r=this;null!==(r=r.parent);)e(r)&&t.push(r);return t}},{key:"addShadow",value:function(){var e=this;this._shadows||(this._shadows=new Set);for(var t=new RegExp("^"+Patterns.variable+"$"),r=arguments.length,n=Array(r),a=0;a<r;a++)n[a]=arguments[a];n.flat(1/0).forEach(function(r){if("string"!=typeof r)throw new TypeError("variable name must be a string; type: "+(void 0===r?"undefined":_typeof(r)));if(!t.test(r))throw new Error('invalid variable name "'+r+'"');e._shadows.add(r)})}},{key:"createShadowWrapper",value:function(e,t,r){var n=this,a=void 0;return"function"==typeof e&&(a={},this.shadowView.forEach(function(e){var t=e.slice(1),r="$"===e[0]?State.variables:State.temporary;a[e]=r[t]})),function(){for(var i=arguments.length,o=Array(i),s=0;s<i;s++)o[s]=arguments[s];if("function"==typeof r&&r.apply(this,o),"function"==typeof e){var u=Object.keys(a),l=u.length>0?{}:null,c=Wikifier.Parser.get("macro"),d=void 0;try{u.forEach(function(e){var t=e.slice(1),r="$"===e[0]?State.variables:State.temporary;r.hasOwnProperty(t)&&(l[t]=r[t]),r[t]=a[e]}),d=c.context,c.context=n,e.apply(this,o)}finally{d!==undefined&&(c.context=d),u.forEach(function(e){var t=e.slice(1),r="$"===e[0]?State.variables:State.temporary;a[e]=r[t],l.hasOwnProperty(t)?r[t]=l[t]:delete r[t]})}}"function"==typeof t&&t.apply(this,o)}}},{key:"createDebugView",value:function(e,t){return this._debugView=new DebugView(this._output,"macro",e||this.name,t||this.source),null!==this.payload&&this.payload.length>0&&this._debugView.modes({nonvoid:!0}),this._debugViewEnabled=!0,this._debugView}},{key:"removeDebugView",value:function(){null!==this._debugView&&(this._debugView.remove(),this._debugView=null),this._debugViewEnabled=!1}},{key:"error",value:function(e,t){return throwError(this._output,"<<"+this.name+">>: "+e,t||this.source)}},{key:"output",get:function(){return this._debugViewEnabled?this.debugView.output:this._output}},{key:"shadows",get:function(){return[].concat(_toConsumableArray(this._shadows))}},{key:"shadowView",get:function(){var e=new Set;return this.contextSelectAll(function(e){return e._shadows}).forEach(function(t){return t._shadows.forEach(function(t){return e.add(t)})}),[].concat(_toConsumableArray(e))}},{key:"debugView",get:function(){return this._debugViewEnabled?null!==this._debugView?this._debugView:this.createDebugView():null}}]),e}()}();!function(){if(Macro.add("capture",{skipArgs:!0,tags:null,handler:function(){if(0===this.args.raw.length)return this.error("no story/temporary variable list specified");var e={};try{for(var t=new RegExp("("+Patterns.variable+")","g"),r=void 0;null!==(r=t.exec(this.args.raw));){var n=r[1],a=n.slice(1),i="$"===n[0]?State.variables:State.temporary;i.hasOwnProperty(a)&&(e[a]=i[a]),this.addShadow(n)}new Wikifier(this.output,this.payload[0].contents)}finally{this.shadows.forEach(function(t){var r=t.slice(1),n="$"===t[0]?State.variables:State.temporary;e.hasOwnProperty(r)?n[r]=e[r]:delete n[r]})}}}),Macro.add("set",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{Scripting.evalJavaScript(this.args.full)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("unset",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no story/temporary variable list specified");for(var e=new RegExp("State\\.(variables|temporary)\\.("+Patterns.identifier+")","g"),t=void 0;null!==(t=e.exec(this.args.full));){var r=State[t[1]],n=t[2];r.hasOwnProperty(n)&&delete r[n]}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("remember",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{Scripting.evalJavaScript(this.args.full)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}for(var e=storage.get("remember")||{},t=new RegExp("State\\.variables\\.("+Patterns.identifier+")","g"),r=void 0;null!==(r=t.exec(this.args.full));){var n=r[1];e[n]=State.variables[n]}if(!storage.set("remember",e))return this.error("unknown error, cannot remember: "+this.args.raw);Config.debug&&this.debugView.modes({hidden:!0})},init:function(){var e=storage.get("remember");e&&Object.keys(e).forEach(function(t){return State.variables[t]=e[t]})}}),Macro.add("forget",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no story variable list specified");for(var e=storage.get("remember"),t=new RegExp("State\\.variables\\.("+Patterns.identifier+")","g"),r=void 0,n=!1;null!==(r=t.exec(this.args.full));){var a=r[1];State.variables.hasOwnProperty(a)&&delete State.variables[a],e&&e.hasOwnProperty(a)&&(n=!0,delete e[a])}if(n)if(0===Object.keys(e).length){if(!storage.delete("remember"))return this.error("unknown error, cannot update remember store")}else if(!storage.set("remember",e))return this.error("unknown error, cannot update remember store");Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("run","set"),Macro.add("script",{skipArgs:!0,tags:null,handler:function(){var e=document.createDocumentFragment();try{Scripting.evalJavaScript(this.payload[0].contents,e)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e),this.source+this.payload[0].contents+"<</"+this.name+">>")}Config.debug&&this.createDebugView(),e.hasChildNodes()&&this.output.appendChild(e)}}),Macro.add("include",{handler:function(){if(0===this.args.length)return this.error("no passage specified");var e=void 0;if(e="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],!Story.has(e))return this.error('passage "'+e+'" does not exist');Config.debug&&this.debugView.modes({block:!0}),e=Story.get(e);var t=void 0;t=this.args[1]?jQuery(document.createElement(this.args[1])).addClass(e.domId+" macro-"+this.name).attr("data-passage",e.title).appendTo(this.output):jQuery(this.output),t.wiki(e.processText())}}),Macro.add("nobr",{skipArgs:!0,tags:null,handler:function(){new Wikifier(this.output,this.payload[0].contents.replace(/^\n+|\n+$/g,"").replace(/\n+/g," "))}}),Macro.add(["print","=","-"],{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{var e=toStringOrDefault(Scripting.evalJavaScript(this.args.full),null);null!==e&&new Wikifier(this.output,"-"===this.name?Util.escape(e):e)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}}}),Macro.add("silently",{skipArgs:!0,tags:null,handler:function(){var e=document.createDocumentFragment();if(new Wikifier(e,this.payload[0].contents.trim()),Config.debug)this.debugView.modes({hidden:!0}),this.output.appendChild(e);else{var t=[].concat(_toConsumableArray(e.querySelectorAll(".error"))).map(function(e){return e.textContent});if(t.length>0)return this.error("error"+(1===t.length?"":"s")+" within contents ("+t.join("; ")+")",this.source+this.payload[0].contents+"<</"+this.name+">>")}}}),Macro.add("display","include"),Macro.add("if",{skipArgs:!0,tags:["elseif","else"],handler:function(){var e=void 0;try{var t=this.payload.length;for(e=0;e<t;++e)switch(this.payload[e].name){case"else":if(this.payload[e].args.raw.length>0)return/^\s*if\b/i.test(this.payload[e].args.raw)?this.error('whitespace is not allowed between the "else" and "if" in <<elseif>> clause'+(e>0?" (#"+e+")":"")):this.error("<<else>> does not accept a conditional expression (perhaps you meant to use <<elseif>>), invalid: "+this.payload[e].args.raw);if(e+1!==t)return this.error("<<else>> must be the final clause");break;default:if(0===this.payload[e].args.full.length)return this.error("no conditional expression specified for <<"+this.payload[e].name+">> clause"+(e>0?" (#"+e+")":""));if(Config.macros.ifAssignmentError&&/[^!=&^|<>*\/%+-]=[^=]/.test(this.payload[e].args.full))return this.error("assignment operator found within <<"+this.payload[e].name+">> clause"+(e>0?" (#"+e+")":"")+" (perhaps you meant to use an equality operator: ==, ===, eq, is), invalid: "+this.payload[e].args.raw)}var r=Scripting.evalJavaScript,n=!1;for(e=0;e<t;++e){if(Config.debug&&this.createDebugView(this.payload[e].name,this.payload[e].source).modes({nonvoid:!1}),"else"===this.payload[e].name||r(this.payload[e].args.full)){n=!0,new Wikifier(this.output,this.payload[e].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++e;e<t;++e)this.createDebugView(this.payload[e].name,this.payload[e].source).modes({nonvoid:!1,hidden:!0,invalid:!0});this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!n,invalid:!n})}}catch(t){return this.error("bad conditional expression in <<"+(0===e?"if":"elseif")+">> clause"+(e>0?" (#"+e+")":"")+": "+("object"===(void 0===t?"undefined":_typeof(t))?t.message:t))}}}),Macro.add("switch",{skipArgs:["switch"],tags:["case","default"],handler:function(){if(0===this.args.full.length)return this.error("no expression specified");var e=this.payload.length;if(1===e)return this.error("no cases specified");var t=void 0;for(t=1;t<e;++t)switch(this.payload[t].name){case"default":if(this.payload[t].args.length>0)return this.error("<<default>> does not accept values, invalid: "+this.payload[t].args.raw);if(t+1!==e)return this.error("<<default>> must be the final case");break;default:if(0===this.payload[t].args.length)return this.error("no value(s) specified for <<"+this.payload[t].name+">> (#"+t+")")}var r=void 0;try{r=Scripting.evalJavaScript(this.args.full)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}var n=this.debugView,a=!1;for(Config.debug&&n.modes({nonvoid:!1,hidden:!0}),t=1;t<e;++t){if(Config.debug&&this.createDebugView(this.payload[t].name,this.payload[t].source).modes({nonvoid:!1}),"default"===this.payload[t].name||this.payload[t].args.some(function(e){return e===r})){a=!0,new Wikifier(this.output,this.payload[t].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++t;t<e;++t)this.createDebugView(this.payload[t].name,this.payload[t].source).modes({nonvoid:!1,hidden:!0,invalid:!0});n.modes({nonvoid:!1,hidden:!0,invalid:!a}),this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!0,invalid:!a})}}}),Macro.add("for",{skipArgs:!0,tags:null,_hasRangeRe:new RegExp("^\\S"+Patterns.anyChar+"*?\\s+range\\s+\\S"+Patterns.anyChar+"*?$"),_rangeRe:new RegExp("^(?:State\\.(variables|temporary)\\.("+Patterns.identifier+")\\s*,\\s*)?State\\.(variables|temporary)\\.("+Patterns.identifier+")\\s+range\\s+(\\S"+Patterns.anyChar+"*?)$"),_3PartRe:/^([^;]*?)\s*;\s*([^;]*?)\s*;\s*([^;]*?)$/,handler:function(){var e=this.args.full.trim(),t=this.payload[0].contents.replace(/\n$/,"");if(0===e.length)this.self._handleFor.call(this,t,null,!0,null);else if(this.self._hasRangeRe.test(e)){var r=e.match(this.self._rangeRe);if(null===r)return this.error("invalid range form syntax, format: [index ,] value range collection");this.self._handleForRange.call(this,t,{type:r[1],name:r[2]},{type:r[3],name:r[4]},r[5])}else{var n=void 0,a=void 0,i=void 0;if(-1===e.indexOf(";")){if(/^\S+\s+in\s+\S+/i.test(e))return this.error("invalid syntax, for…in is not supported; see: for…range");if(/^\S+\s+of\s+\S+/i.test(e))return this.error("invalid syntax, for…of is not supported; see: for…range");a=e}else{var o=e.match(this.self._3PartRe);if(null===o)return this.error("invalid 3-part conditional form syntax, format: [init] ; [condition] ; [post]");n=o[1],a=o[2].trim(),i=o[3],0===a.length&&(a=!0)}this.self._handleFor.call(this,t,n,a,i)}},_handleFor:function(e,t,r,n){var a=Scripting.evalJavaScript,i=!0,o=Config.macros.maxLoopIterations;Config.debug&&this.debugView.modes({block:!0});try{if(TempState.break=null,t)try{a(t)}catch(e){return this.error("bad init expression: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}for(;a(r);){if(--o<0)return this.error("exceeded configured maximum loop iterations ("+Config.macros.maxLoopIterations+")");if(new Wikifier(this.output,i?e.replace(/^\n/,""):e),i&&(i=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}if(n)try{a(n)}catch(e){return this.error("bad post expression: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}}}catch(e){return this.error("bad conditional expression: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}finally{TempState.break=null}},_handleForRange:function(e,t,r,n){var a=!0,i=void 0;try{i=this.self._toRangeList(n)}catch(e){return this.error(e.message)}Config.debug&&this.debugView.modes({block:!0});try{TempState.break=null;for(var o=0;o<i.length;++o)if(t.name&&(State[t.type][t.name]=i[o][0]),
State[r.type][r.name]=i[o][1],new Wikifier(this.output,a?e.replace(/^\n/,""):e),a&&(a=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}}catch(e){return this.error("object"===(void 0===e?"undefined":_typeof(e))?e.message:e)}finally{TempState.break=null}},_toRangeList:function(e){var t=Scripting.evalJavaScript,r=void 0;try{r=t("{"===e[0]?"("+e+")":e)}catch(e){if("object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("bad range expression: "+e);throw e.message="bad range expression: "+e.message,e}var n=void 0;switch(void 0===r?"undefined":_typeof(r)){case"string":n=[];for(var a=0;a<r.length;){var i=Util.charAndPosAt(r,a);n.push([a,i.char]),a=1+i.end}break;case"object":if(Array.isArray(r))n=r.map(function(e,t){return[t,e]});else if(r instanceof Set)n=[].concat(_toConsumableArray(r)).map(function(e,t){return[t,e]});else if(r instanceof Map)n=[].concat(_toConsumableArray(r.entries()));else{if("Object"!==Util.toStringTag(r))throw new Error("unsupported range expression type: "+Util.toStringTag(r));n=Object.keys(r).map(function(e){return[e,r[e]]})}break;default:throw new Error("unsupported range expression type: "+(void 0===r?"undefined":_typeof(r)))}return n}}),Macro.add(["break","continue"],{skipArgs:!0,handler:function(){if(!this.contextHas(function(e){return"for"===e.name}))return this.error("must only be used in conjunction with its parent macro <<for>>");TempState.break="continue"===this.name?1:2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["button","link"],{isAsync:!0,tags:null,handler:function(){var e=this;if(0===this.args.length)return this.error("no "+("button"===this.name?"button":"link")+" text specified");var t=jQuery(document.createElement("button"===this.name?"button":"a")),r=void 0;if("object"===_typeof(this.args[0]))if(this.args[0].isImage){var n=jQuery(document.createElement("img")).attr("src",this.args[0].source).appendTo(t);this.args[0].hasOwnProperty("passage")&&n.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&n.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&n.attr("align",this.args[0].align),this.args[0].hasOwnProperty("link")&&(r=this.args[0].link),r=this.args[0].link}else t.append(document.createTextNode(this.args[0].text)),r=this.args[0].link;else t.wikiWithOptions({profile:"core"},this.args[0]),r=this.args.length>1?this.args[1]:undefined;null!=r?(t.attr("data-passage",r),Story.has(r)?(t.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(r)&&t.addClass("link-visited")):t.addClass("link-broken")):t.addClass("link-internal"),t.addClass("macro-"+this.name).ariaClick({namespace:".macros",one:null!=r},this.createShadowWrapper(""!==this.payload[0].contents?function(){return Wikifier.wikifyEval(e.payload[0].contents.trim())}:null,null!=r?function(){return Engine.play(r)}:null)).appendTo(this.output)}}),Macro.add("checkbox",{isAsync:!0,handler:function(){if(this.args.length<3){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("unchecked value"),this.args.length<3&&e.push("checked value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Util.slugify(t),n=this.args[1],a=this.args[2],i=document.createElement("input");jQuery(i).attr({id:this.name+"-"+r,name:this.name+"-"+r,type:"checkbox",tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,this.checked?a:n)})).appendTo(this.output),this.args.length>3&&"checked"===this.args[3]?(i.checked=!0,State.setVar(t,a)):State.setVar(t,n)}}),Macro.add(["cycle","listbox"],{isAsync:!0,skipArgs:["optionsfrom"],tags:["option","optionsfrom"],handler:function(){var e=this;if(0===this.args.length)return this.error("no variable name specified");if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Util.slugify(t),n=this.payload.length;if(1===n)return this.error("no options specified");for(var a=this.args.length>1&&"autoselect"===this.args[1],i=[],o={option:0,optionsfrom:0},s=-1,u=1;u<n;++u){var l=this.payload[u];if("option"===l.name){if(++o.option,0===l.args.length)return this.error("no arguments specified for <<"+l.name+">> (#"+o.option+")");if(i.push({label:String(l.args[0]),value:1===l.args.length?l.args[0]:l.args[1]}),l.args.length>2&&"selected"===l.args[2]){if(a)return this.error("cannot specify both the autoselect and selected keywords");if(-1!==s)return this.error("multiple selected keywords specified for <<"+l.name+">> (#"+(s+1)+" & #"+o.option+")");s=i.length-1}}else{var c=function(){if(++o.optionsfrom,0===l.args.full.length)return{v:e.error("no expression specified for <<"+l.name+">> (#"+o.optionsfrom+")")};var t=void 0;try{var r=l.args.full;t=Scripting.evalJavaScript("{"===r[0]?"("+r+")":r)}catch(t){return{v:e.error("bad evaluation: "+("object"===(void 0===t?"undefined":_typeof(t))?t.message:t))}}if("object"!==(void 0===t?"undefined":_typeof(t))||null===t)return{v:e.error("expression must yield a supported collection or generic object (type: "+(null===t?"null":void 0===t?"undefined":_typeof(t))+")")};if(t instanceof Array||t instanceof Set)t.forEach(function(e){return i.push({label:String(e),value:e})});else if(t instanceof Map)t.forEach(function(e,t){return i.push({label:String(t),value:e})});else{var n=Util.toStringTag(t);if("Object"!==n)return{v:e.error("expression must yield a supported collection or generic object (object type: "+n+")")};Object.keys(t).forEach(function(e){return i.push({label:e,value:t[e]})})}}();if("object"===(void 0===c?"undefined":_typeof(c)))return c.v}}if(-1===s)if(a){var d=Util.sameValueZero,f=State.getVar(t),p=i.findIndex(function(e){return d(e.value,f)});s=-1===p?0:p}else s=0;if("cycle"===this.name){var h=s;jQuery(document.createElement("a")).wikiWithOptions({profile:"core"},i[s].label).addClass("macro-"+this.name).ariaClick({namespace:".macros"},this.createShadowWrapper(function(){h=(h+1)%i.length,$(this).empty().wikiWithOptions({profile:"core"},i[h].label),State.setVar(t,i[h].value)})).appendTo(this.output)}else{var g=jQuery(document.createElement("select"));i.forEach(function(e,t){jQuery(document.createElement("option")).val(t).text(e.label).appendTo(g)}),g.attr({id:this.name+"-"+r,name:this.name+"-"+r,tabindex:0}).addClass("macro-"+this.name).val(s).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,i[Number(this.value)].value)})).appendTo(this.output)}State.setVar(t,i[s].value)}}),Macro.add(["linkappend","linkprepend","linkreplace"],{isAsync:!0,tags:null,handler:function(){var e=this;if(0===this.args.length)return this.error("no link text specified");var t=jQuery(document.createElement("a")),r=jQuery(document.createElement("span")),n=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]);t.wikiWithOptions({profile:"core"},this.args[0]).addClass("link-internal macro-"+this.name).ariaClick({namespace:".macros",one:!0},this.createShadowWrapper(function(){if("linkreplace"===e.name?t.remove():t.wrap('<span class="macro-'+e.name+'"></span>').replaceWith(function(){return t.html()}),""!==e.payload[0].contents){var a=document.createDocumentFragment();new Wikifier(a,e.payload[0].contents),r.append(a)}n&&setTimeout(function(){return r.removeClass("macro-"+e.name+"-in")},Engine.minDomActionDelay)})).appendTo(this.output),r.addClass("macro-"+this.name+"-insert"),n&&r.addClass("macro-"+this.name+"-in"),"linkprepend"===this.name?r.insertBefore(t):r.insertAfter(t)}}),Macro.add("radiobutton",{isAsync:!0,handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("checked value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Util.slugify(t),n=this.args[1],a=document.createElement("input");TempState.hasOwnProperty(this.name)||(TempState[this.name]={}),TempState[this.name].hasOwnProperty(r)||(TempState[this.name][r]=0),jQuery(a).attr({id:this.name+"-"+r+"-"+TempState[this.name][r]++,name:this.name+"-"+r,type:"radio",tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){this.checked&&State.setVar(t,n)})).appendTo(this.output),this.args.length>2&&"checked"===this.args[2]&&(a.checked=!0,State.setVar(t,n))}}),Macro.add("textarea",{isAsync:!0,handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("default value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');Config.debug&&this.debugView.modes({block:!0});var r=Util.slugify(t),n=this.args[1],a="autofocus"===this.args[2],i=document.createElement("textarea");jQuery(i).attr({id:this.name+"-"+r,name:this.name+"-"+r,rows:4,tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,this.value)})).appendTo(this.output),State.setVar(t,n),i.textContent=n,a&&(i.setAttribute("autofocus","autofocus"),postdisplay["#autofocus:"+i.id]=function(e){delete postdisplay[e],setTimeout(function(){return i.focus()},Engine.minDomActionDelay)})}}),Macro.add("textbox",{isAsync:!0,handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("default value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');Config.debug&&this.debugView.modes({block:!0});var r=Util.slugify(t),n=this.args[1],a=document.createElement("input"),i=!1,o=void 0;this.args.length>3?(o=this.args[2],i="autofocus"===this.args[3]):this.args.length>2&&("autofocus"===this.args[2]?i=!0:o=this.args[2]),"object"===(void 0===o?"undefined":_typeof(o))&&(o=o.link),jQuery(a).attr({id:this.name+"-"+r,name:this.name+"-"+r,type:"text",tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,this.value)})).on("keypress.macros",this.createShadowWrapper(function(e){13===e.which&&(e.preventDefault(),State.setVar(t,this.value),null!=o&&Engine.play(o))})).appendTo(this.output),State.setVar(t,n),a.value=n,i&&(a.setAttribute("autofocus","autofocus"),postdisplay["#autofocus:"+a.id]=function(e){delete postdisplay[e],setTimeout(function(){return a.focus()},Engine.minDomActionDelay)})}}),Macro.add("click","link"),Macro.add("actions",{handler:function(){for(var e=jQuery(document.createElement("ul")).addClass(this.name).appendTo(this.output),t=0;t<this.args.length;++t){var r=void 0,n=void 0,a=void 0,i=void 0;"object"===_typeof(this.args[t])?this.args[t].isImage?(a=jQuery(document.createElement("img")).attr("src",this.args[t].source),this.args[t].hasOwnProperty("passage")&&a.attr("data-passage",this.args[t].passage),this.args[t].hasOwnProperty("title")&&a.attr("title",this.args[t].title),this.args[t].hasOwnProperty("align")&&a.attr("align",this.args[t].align),r=this.args[t].link,i=this.args[t].setFn):(n=this.args[t].text,r=this.args[t].link,i=this.args[t].setFn):n=r=this.args[t],State.variables.hasOwnProperty("#actions")&&State.variables["#actions"].hasOwnProperty(r)&&State.variables["#actions"][r]||jQuery(Wikifier.createInternalLink(jQuery(document.createElement("li")).appendTo(e),r,null,function(e,t){return function(){State.variables.hasOwnProperty("#actions")||(State.variables["#actions"]={}),State.variables["#actions"][e]=!0,"function"==typeof t&&t()}}(r,i))).addClass("macro-"+this.name).append(a||document.createTextNode(n))}}}),Macro.add(["back","return"],{handler:function(){if(this.args.length>1)return this.error("too many arguments specified, check the documentation for details");var e=-1,t=void 0,r=void 0,n=void 0;if(1===this.args.length&&("object"===_typeof(this.args[0])?this.args[0].isImage?(n=jQuery(document.createElement("img")).attr("src",this.args[0].source),this.args[0].hasOwnProperty("passage")&&n.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&n.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&n.attr("align",this.args[0].align),this.args[0].hasOwnProperty("link")&&(t=this.args[0].link)):1===this.args[0].count?t=this.args[0].link:(r=this.args[0].text,t=this.args[0].link):1===this.args.length&&(r=this.args[0])),null==t){for(var a=State.length-2;a>=0;--a)if(State.history[a].title!==State.passage){e=a,t=State.history[a].title;break}if(null==t&&"return"===this.name)for(var i=State.expired.length-1;i>=0;--i)if(State.expired[i]!==State.passage){t=State.expired[i];break}}else{if(!Story.has(t))return this.error('passage "'+t+'" does not exist');if("back"===this.name){for(var o=State.length-2;o>=0;--o)if(State.history[o].title===t){e=o;break}if(-1===e)return this.error('cannot find passage "'+t+'" in the current story history')}}if(null==t)return this.error("cannot find passage");var s=void 0;s="back"!==this.name||-1!==e?jQuery(document.createElement("a")).addClass("link-internal").ariaClick({one:!0},"return"===this.name?function(){return Engine.play(t)}:function(){return Engine.goTo(e)}):jQuery(document.createElement("span")).addClass("link-disabled"),s.addClass("macro-"+this.name).append(n||document.createTextNode(r||L10n.get("macro"+this.name.toUpperFirst()+"Text"))).appendTo(this.output)}}),Macro.add("choice",{handler:function(){if(0===this.args.length)return this.error("no passage specified");var e=State.passage,t=void 0,r=void 0,n=void 0,a=void 0;if(1===this.args.length?"object"===_typeof(this.args[0])?this.args[0].isImage?(n=jQuery(document.createElement("img")).attr("src",this.args[0].source),this.args[0].hasOwnProperty("passage")&&n.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&n.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&n.attr("align",this.args[0].align),t=this.args[0].link,a=this.args[0].setFn):(r=this.args[0].text,t=this.args[0].link,a=this.args[0].setFn):r=t=this.args[0]:(t=this.args[0],r=this.args[1]),State.variables.hasOwnProperty("#choice")&&State.variables["#choice"].hasOwnProperty(e)&&State.variables["#choice"][e])return void jQuery(document.createElement("span")).addClass("link-disabled macro-"+this.name).attr("tabindex",-1).append(n||document.createTextNode(r)).appendTo(this.output);jQuery(Wikifier.createInternalLink(this.output,t,null,function(){State.variables.hasOwnProperty("#choice")||(State.variables["#choice"]={}),State.variables["#choice"][e]=!0,"function"==typeof a&&a()})).addClass("macro-"+this.name).append(n||document.createTextNode(r))}}),Macro.add(["addclass","toggleclass"],{handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("selector"),this.args.length<2&&e.push("class names"),this.error("no "+e.join(" or ")+" specified")}var t=jQuery(this.args[0]);if(0===t.length)return this.error('no elements matched the selector "'+this.args[0]+'"');switch(this.name){case"addclass":t.addClass(this.args[1].trim());break;case"toggleclass":t.toggleClass(this.args[1].trim())}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeclass",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var e=jQuery(this.args[0]);if(0===e.length)return this.error('no elements matched the selector "'+this.args[0]+'"');this.args.length>1?e.removeClass(this.args[1].trim()):e.removeClass(),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("copy",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var e=jQuery(this.args[0]);if(0===e.length)return this.error('no elements matched the selector "'+this.args[0]+'"');jQuery(this.output).append(e.html()),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["append","prepend","replace"],{tags:null,handler:function(){var e=this;if(0===this.args.length)return this.error("no selector specified");var t=jQuery(this.args[0]);if(0===t.length)return this.error('no elements matched the selector "'+this.args[0]+'"');if(""!==this.payload[0].contents){var r=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]),n=void 0;switch(r?(n=jQuery(document.createElement("span")),n.addClass("macro-"+this.name+"-insert macro-"+this.name+"-in"),setTimeout(function(){return n.removeClass("macro-"+e.name+"-in")},Engine.minDomActionDelay)):n=jQuery(document.createDocumentFragment()),n.wiki(this.payload[0].contents),this.name){case"replace":t.empty();case"append":t.append(n);break;case"prepend":t.prepend(n)}}else"replace"===this.name&&t.empty();Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("remove",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var e=jQuery(this.args[0]);if(0===e.length)return this.error('no elements matched the selector "'+this.args[0]+'"');e.remove(),Config.debug&&this.debugView.modes({hidden:!0})}}),Has.audio){var e=function(e,t){return'only one playback action allowed per invocation, "'+e+'" cannot be combined with "'+t+'"'};Macro.add("audio",{handler:function(){if(this.args.length<2){var t=[];return this.args.length<1&&t.push("track and/or group IDs"),this.args.length<2&&t.push("actions"),this.error("no "+t.join(" or ")+" specified")}var r=void 0;try{r=SimpleAudio.select(this.args[0])}catch(e){return this.error(e.message)}for(var n=this.args.slice(1),a=void 0,i=5,o=void 0,s=void 0,u=void 0,l=void 0,c=void 0,d=void 0;n.length>0;){var f=n.shift(),p=void 0;switch(f){case"load":case"pause":case"play":case"stop":case"unload":if(a)return this.error(e(f,a));a=f;break;case"fadein":if(a)return this.error(e(f,a));a="fade",o=1;break;case"fadeout":if(a)return this.error(e(f,a));a="fade",o=0;break;case"fadeto":if(a)return this.error(e(f,a));if(0===n.length)return this.error("fadeto missing required level value");if(a="fade",p=n.shift(),o=Number.parseFloat(p),Number.isNaN(o)||!Number.isFinite(o))return this.error("cannot parse fadeto: "+p);break;case"fadeoverto":if(a)return this.error(e(f,a));if(n.length<2){var h=[];return n.length<1&&h.push("seconds"),n.length<2&&h.push("level"),this.error("fadeoverto missing required "+h.join(" and ")+" value"+(h.length>1?"s":""))}if(a="fade",p=n.shift(),i=Number.parseFloat(p),Number.isNaN(i)||!Number.isFinite(i))return this.error("cannot parse fadeoverto: "+p);if(p=n.shift(),o=Number.parseFloat(p),Number.isNaN(o)||!Number.isFinite(o))return this.error("cannot parse fadeoverto: "+p);break;case"volume":if(0===n.length)return this.error("volume missing required level value");if(p=n.shift(),d=Number.parseFloat(p),Number.isNaN(d)||!Number.isFinite(d))return this.error("cannot parse volume: "+p);break;case"mute":case"unmute":u="mute"===f;break;case"time":if(0===n.length)return this.error("time missing required seconds value");if(p=n.shift(),c=Number.parseFloat(p),Number.isNaN(c)||!Number.isFinite(c))return this.error("cannot parse time: "+p);break;case"loop":case"unloop":s="loop"===f;break;case"goto":if(0===n.length)return this.error("goto missing required passage title");if(p=n.shift(),l="object"===(void 0===p?"undefined":_typeof(p))?p.link:p,!Story.has(l))return this.error('passage "'+l+'" does not exist');break;default:return this.error("unknown action: "+f)}}try{if(null!=d&&r.volume(d),null!=c&&r.time(c),null!=u&&r.mute(u),null!=s&&r.loop(s),null!=l){var g="ended.macros.macro-"+this.name+"_goto";r.off(g).one(g,function(){r.off(g),Engine.play(l)})}switch(a){case"fade":r.fade(i,o);break;case"load":r.load();break;case"pause":r.pause();break;case"play":r.play();break;case"stop":r.stop();break;case"unload":r.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(e){return this.error("error executing action: "+e.message)}}}),Macro.add("cacheaudio",{handler:function(){var e=this;if(this.args.length<2){var t=[];return this.args.length<1&&t.push("track ID"),this.args.length<2&&t.push("sources"),this.error("no "+t.join(" or ")+" specified")}var r=String(this.args[0]).trim(),n=/^format:\s*([\w-]+)\s*;\s*/i;try{SimpleAudio.tracks.add(r,this.args.slice(1).map(function(t){if(n.test(t)){if(Config.debug)return e.error('track ID "'+r+'": format specifier migration required, "format:formatId;" → "formatId|"');t=t.replace(n,"$1|")}return t}))}catch(e){return this.error(e.message)}if(Config.debug&&!SimpleAudio.tracks.get(r).hasSource())return this.error('track ID "'+r+'": no supported audio sources found');Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("createaudiogroup",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no group ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var e=String(this.args[0]).trim(),t=[],r=1,n=this.payload.length;r<n;++r){if(this.payload[r].args.length<1)return this.error("no track ID specified");t.push(String(this.payload[r].args[0]).trim()),Config.debug&&this.createDebugView(this.payload[r].name,this.payload[r].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.groups.add(e,t)}catch(e){return this.error(e.message)}Config.debug&&this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!0})}}),Macro.add("createplaylist",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no list ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");var e=Macro.get("playlist");if(null!==e.from&&"createplaylist"!==e.from)return this.error("a playlist has already been defined with <<setplaylist>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var t=String(this.args[0]).trim(),r=[],n=1,a=this.payload.length;n<a;++n){if(0===this.payload[n].args.length)return this.error("no track ID specified");for(var i={id:String(this.payload[n].args[0]).trim()},o=this.payload[n].args.slice(1);o.length>0;){var s=o.shift(),u=void 0,l=void 0;switch(s){case"copy":case"own":i.own=!0;break;case"rate":o.length>0&&o.shift();break;case"volume":if(0===o.length)return this.error("volume missing required level value");if(u=o.shift(),l=Number.parseFloat(u),Number.isNaN(l)||!Number.isFinite(l))return this.error("cannot parse volume: "+u);i.volume=l;break;default:return this.error("unknown action: "+s)}}r.push(i),Config.debug&&this.createDebugView(this.payload[n].name,this.payload[n].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.lists.add(t,r)}catch(e){return this.error(e.message)}null===e.from&&(e.from="createplaylist"),Config.debug&&this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!0})}}),Macro.add("masteraudio",{handler:function(){if(0===this.args.length)return this.error("no actions specified");for(var t=this.args.slice(0),r=void 0,n=void 0,a=void 0,i=void 0;t.length>0;){var o=t.shift(),s=void 0;switch(o){case"load":case"stop":case"unload":if(r)return this.error(e(o,r));r=o;break;case"mute":case"unmute":n="mute"===o;break;case"muteonhide":case"nomuteonhide":a="muteonhide"===o;break;case"volume":if(0===t.length)return this.error("volume missing required level value");if(s=t.shift(),i=Number.parseFloat(s),Number.isNaN(i)||!Number.isFinite(i))return this.error("cannot parse volume: "+s);break;default:return this.error("unknown action: "+o)}}try{switch(null!=n&&SimpleAudio.mute(n),null!=a&&SimpleAudio.muteOnHidden(a),null!=i&&SimpleAudio.volume(i),r){case"load":SimpleAudio.load();break;case"stop":SimpleAudio.stop();break;case"unload":SimpleAudio.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(e){return this.error("error executing action: "+e.message)}}}),Macro.add("playlist",{from:null,handler:function(){var t=this.self.from;if(null===t)return this.error("no playlists have been created");var r=void 0,n=void 0;if("createplaylist"===t){if(this.args.length<2){var a=[];return this.args.length<1&&a.push("list ID"),this.args.length<2&&a.push("actions"),this.error("no "+a.join(" or ")+" specified")}var i=String(this.args[0]).trim();if(!SimpleAudio.lists.has(i))return this.error('playlist "'+i+'" does not exist');r=SimpleAudio.lists.get(i),n=this.args.slice(1)}else{if(0===this.args.length)return this.error("no actions specified");r=SimpleAudio.lists.get("setplaylist"),n=this.args.slice(0)}for(var o=void 0,s=5,u=void 0,l=void 0,c=void 0,d=void 0,f=void 0;n.length>0;){var p=n.shift(),h=void 0;switch(p){case"load":case"pause":case"play":case"skip":case"stop":case"unload":if(o)return this.error(e(p,o));o=p;break;case"fadein":if(o)return this.error(e(p,o));o="fade",u=1;break;case"fadeout":if(o)return this.error(e(p,o));o="fade",u=0;break;case"fadeto":if(o)return this.error(e(p,o));if(0===n.length)return this.error("fadeto missing required level value");if(o="fade",h=n.shift(),u=Number.parseFloat(h),Number.isNaN(u)||!Number.isFinite(u))return this.error("cannot parse fadeto: "+h);break;case"fadeoverto":if(o)return this.error(e(p,o));if(n.length<2){var g=[];return n.length<1&&g.push("seconds"),n.length<2&&g.push("level"),this.error("fadeoverto missing required "+g.join(" and ")+" value"+(g.length>1?"s":""))}if(o="fade",h=n.shift(),s=Number.parseFloat(h),Number.isNaN(s)||!Number.isFinite(s))return this.error("cannot parse fadeoverto: "+h);if(h=n.shift(),u=Number.parseFloat(h),Number.isNaN(u)||!Number.isFinite(u))return this.error("cannot parse fadeoverto: "+h);break;case"volume":if(0===n.length)return this.error("volume missing required level value");if(h=n.shift(),f=Number.parseFloat(h),Number.isNaN(f)||!Number.isFinite(f))return this.error("cannot parse volume: "+h);break;case"mute":case"unmute":c="mute"===p;break;case"loop":case"unloop":l="loop"===p;break;case"shuffle":case"unshuffle":d="shuffle"===p;break;default:return this.error("unknown action: "+p)}}try{switch(null!=f&&r.volume(f),null!=c&&r.mute(c),null!=l&&r.loop(l),null!=d&&r.shuffle(d),o){case"fade":r.fade(s,u);break;case"load":r.load();break;case"pause":r.pause();break;case"play":r.play();break;case"skip":r.skip();break;case"stop":r.stop();break;case"unload":r.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(e){return this.error("error executing action: "+e.message)}}}),Macro.add("removeaudiogroup",{handler:function(){if(0===this.args.length)return this.error("no group ID specified");var e=String(this.args[0]).trim();if(!SimpleAudio.groups.has(e))return this.error('group "'+e+'" does not exist');SimpleAudio.groups.delete(e),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeplaylist",{handler:function(){if(0===this.args.length)return this.error("no list ID specified");var e=String(this.args[0]).trim();if(!SimpleAudio.lists.has(e))return this.error('playlist "'+e+'" does not exist');SimpleAudio.lists.delete(e),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("waitforaudio",{skipArgs:!0,handler:function(){SimpleAudio.loadWithScreen()}}),Macro.add("setplaylist",{handler:function(){if(0===this.args.length)return this.error("no track ID(s) specified");var e=Macro.get("playlist");if(null!==e.from&&"setplaylist"!==e.from)return this.error("playlists have already been defined with <<createplaylist>>");try{SimpleAudio.lists.add("setplaylist",this.args.slice(0))}catch(e){return this.error(e.message)}null===e.from&&(e.from="setplaylist"),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("stopallaudio",{skipArgs:!0,handler:function(){SimpleAudio.select(":all").stop(),Config.debug&&this.debugView.modes({hidden:!0})}})}else Macro.add(["audio","cacheaudio","createaudiogroup","createplaylist","masteraudio","playlist","removeaudiogroup","removeplaylist","waitforaudio","setplaylist","stopallaudio"],{skipArgs:!0,handler:function(){Config.debug&&this.debugView.modes({hidden:!0})}});Macro.add("goto",{handler:function(){if(0===this.args.length)return this.error("no passage specified");var e=void 0;if(e="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],!Story.has(e))return this.error('passage "'+e+'" does not exist');setTimeout(function(){return Engine.play(e)},Engine.minDomActionDelay)}}),Macro.add("repeat",{isAsync:!0,tags:null,timers:new Set,handler:function(){var e=this;if(0===this.args.length)return this.error("no time value specified");var t=void 0;try{t=Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.args[0]))}catch(e){return this.error(e.message)}Config.debug&&this.debugView.modes({block:!0});var r=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]),n=jQuery(document.createElement("span")).addClass("macro-"+this.name).appendTo(this.output);this.self.registerInterval(this.createShadowWrapper(function(){var t=document.createDocumentFragment();new Wikifier(t,e.payload[0].contents);var a=n;r&&(a=jQuery(document.createElement("span")).addClass("macro-repeat-insert macro-repeat-in").appendTo(a)),a.append(t),r&&setTimeout(function(){return a.removeClass("macro-repeat-in")},Engine.minDomActionDelay)}),t)},registerInterval:function(e,t){var r=this;if("function"!=typeof e)throw new TypeError("callback parameter must be a function");var n=State.turns,a=this.timers,i=null;i=setInterval(function(){if(n!==State.turns)return clearInterval(i),void a.delete(i);var t=void 0;try{TempState.break=null,TempState.hasOwnProperty("repeatTimerId")&&(t=TempState.repeatTimerId),TempState.repeatTimerId=i,e.call(r)}finally{void 0!==t?TempState.repeatTimerId=t:delete TempState.repeatTimerId,TempState.break=null}},t),a.add(i),prehistory.hasOwnProperty("#repeat-timers-cleanup")||(prehistory["#repeat-timers-cleanup"]=function(e){delete prehistory[e],a.forEach(function(e){return clearInterval(e)}),a.clear()})}}),Macro.add("stop",{skipArgs:!0,handler:function(){if(!TempState.hasOwnProperty("repeatTimerId"))return this.error("must only be used in conjunction with its parent macro <<repeat>>");var e=Macro.get("repeat").timers,t=TempState.repeatTimerId;clearInterval(t),e.delete(t),TempState.break=2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("timed",{isAsync:!0,tags:["next"],timers:new Set,handler:function(){if(0===this.args.length)return this.error("no time value specified in <<timed>>");var e=[];try{e.push({name:this.name,source:this.source,delay:Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.args[0])),content:this.payload[0].contents})}catch(e){return this.error(e.message+" in <<timed>>")}if(this.payload.length>1){var t=void 0;try{var r=void 0;for(t=1,r=this.payload.length;t<r;++t)e.push({name:this.payload[t].name,source:this.payload[t].source,delay:0===this.payload[t].args.length?e[e.length-1].delay:Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.payload[t].args[0])),content:this.payload[t].contents})}catch(e){return this.error(e.message+" in <<next>> (#"+t+")")}}Config.debug&&this.debugView.modes({block:!0});var n=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]),a=jQuery(document.createElement("span")).addClass("macro-"+this.name).appendTo(this.output);this.self.registerTimeout(this.createShadowWrapper(function(e){var t=document.createDocumentFragment();new Wikifier(t,e.content);var r=a;Config.debug&&"next"===e.name&&(r=jQuery(new DebugView(r[0],"macro",e.name,e.source).output)),
n&&(r=jQuery(document.createElement("span")).addClass("macro-timed-insert macro-timed-in").appendTo(r)),r.append(t),n&&setTimeout(function(){return r.removeClass("macro-timed-in")},Engine.minDomActionDelay)}),e)},registerTimeout:function(e,t){if("function"!=typeof e)throw new TypeError("callback parameter must be a function");var r=State.turns,n=this.timers,a=null,i=t.shift(),o=function o(){if(n.delete(a),r===State.turns){var s=i;null!=(i=t.shift())&&(a=setTimeout(o,i.delay),n.add(a)),e.call(this,s)}};a=setTimeout(o,i.delay),n.add(a),prehistory.hasOwnProperty("#timed-timers-cleanup")||(prehistory["#timed-timers-cleanup"]=function(e){delete prehistory[e],n.forEach(function(e){return clearTimeout(e)}),n.clear()})}}),Macro.add("widget",{tags:null,handler:function(){if(0===this.args.length)return this.error("no widget name specified");var e=this.args[0];if(Macro.has(e)){if(!Macro.get(e).isWidget)return this.error('cannot clobber existing macro "'+e+'"');Macro.delete(e)}try{Macro.add(e,{isWidget:!0,handler:function(e){return function(){var t=void 0;try{State.variables.hasOwnProperty("args")&&(t=State.variables.args),State.variables.args=[].concat(_toConsumableArray(this.args)),State.variables.args.raw=this.args.raw,State.variables.args.full=this.args.full,this.addShadow("$args");var r=document.createDocumentFragment(),n=[];if(new Wikifier(r,e),Array.from(r.querySelectorAll(".error")).forEach(function(e){n.push(e.textContent)}),0!==n.length)return this.error("error"+(n.length>1?"s":"")+" within widget contents ("+n.join("; ")+")");this.output.appendChild(r)}catch(e){return this.error("cannot execute widget: "+e.message)}finally{void 0!==t?State.variables.args=t:delete State.variables.args}}}(this.payload[0].contents)}),Config.debug&&this.debugView.modes({hidden:!0})}catch(t){return this.error('cannot create widget macro "'+e+'": '+t.message)}}})}();var Dialog=function(){function e(e,t,r,n,a){return jQuery(e).ariaClick(function(e){e.preventDefault(),"function"==typeof r&&r(e),o(t,a),"function"==typeof n&&n(e)})}function t(){var e;return(e=g).append.apply(e,arguments),Dialog}function r(){return g.get(0)}function n(e){return g.trigger(":dialogclosing"),jQuery(document).off(".dialog-close"),y?(y.disconnect(),y=null):g.off(".dialog-resize"),jQuery(window).off(".dialog-resize"),p.removeClass("open").css({left:"",right:"",top:"",bottom:""}),jQuery("#ui-bar,#story").find("[tabindex=-2]").removeAttr("aria-hidden").attr("tabindex",0),jQuery("body>[tabindex=-3]").removeAttr("aria-hidden").removeAttr("tabindex"),f.removeClass("open"),jQuery(document.documentElement).removeAttr("data-dialog"),h.empty(),g.empty().removeClass(),null!==m&&(jQuery(m).focus(),m=null),e&&e.data&&"function"==typeof e.data.closeFn&&e.data.closeFn(e),g.trigger(":dialogclose"),g.trigger(":dialogclosed"),Dialog}function a(){if(!document.getElementById("ui-dialog")){v=function(){var e=void 0;try{var t=document.createElement("p"),r=document.createElement("div");t.style.width="100%",t.style.height="200px",r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.width="100px",r.style.height="100px",r.style.visibility="hidden",r.style.overflow="hidden",r.appendChild(t),document.body.appendChild(r);var n=t.offsetWidth;r.style.overflow="auto";var a=t.offsetWidth;n===a&&(a=r.clientWidth),document.body.removeChild(r),e=n-a}catch(e){}return e||17}();var e=jQuery(document.createDocumentFragment()).append('<div id="ui-overlay" class="ui-close"></div><div id="ui-dialog" tabindex="0" role="dialog" aria-labelledby="ui-dialog-title"><div id="ui-dialog-titlebar"><h1 id="ui-dialog-title"></h1><button id="ui-dialog-close" class="ui-close" tabindex="0" aria-label="'+L10n.get("close")+'"></button></div><div id="ui-dialog-body"></div></div>');f=jQuery(e.find("#ui-overlay").get(0)),p=jQuery(e.find("#ui-dialog").get(0)),h=jQuery(e.find("#ui-dialog-title").get(0)),g=jQuery(e.find("#ui-dialog-body").get(0)),e.insertBefore("body>script#script-sugarcube")}}function i(e){return p.hasClass("open")&&(!e||e.splitOrEmpty(/\s+/).every(function(e){return g.hasClass(e)}))}function o(e,t){g.trigger(":dialogopening");var r=jQuery.extend({top:50},e),a=r.top;return i()||(m=safeActiveElement()),jQuery(document.documentElement).attr("data-dialog","open"),f.addClass("open"),null!==g[0].querySelector("img")&&g.imagesLoaded().always(function(){return d({data:{top:a}})}),jQuery("body>:not(script,#store-area,tw-storydata,#ui-bar,#ui-overlay,#ui-dialog)").attr("tabindex",-3).attr("aria-hidden",!0),jQuery("#ui-bar,#story").find("[tabindex]:not([tabindex^=-])").attr("tabindex",-2).attr("aria-hidden",!0),p.css(c(a)).addClass("open").focus(),jQuery(window).on("resize.dialog-resize",null,{top:a},jQuery.throttle(40,d)),Has.mutationObserver?(y=new MutationObserver(function(e){for(var t=0;t<e.length;++t)if("childList"===e[t].type){d({data:{top:a}});break}}),y.observe(g[0],{childList:!0,subtree:!0})):g.on("DOMNodeInserted.dialog-resize DOMNodeRemoved.dialog-resize",null,{top:a},jQuery.throttle(40,d)),jQuery(document).on("click.dialog-close",".ui-close",{closeFn:t},n).on("keypress.dialog-close",".ui-close",function(e){13!==e.which&&32!==e.which||jQuery(this).trigger("click")}),g.trigger(":dialogopen"),g.trigger(":dialogopened"),Dialog}function s(e){return d("object"===(void 0===e?"undefined":_typeof(e))?{data:e}:undefined)}function u(e,t){return g.empty().removeClass(),null!=t&&g.addClass(t),h.empty().append((null!=e?String(e):"")||" "),g.get(0)}function l(){var e;return(e=g).wiki.apply(e,arguments),Dialog}function c(e){var t=null!=e?e:50,r=jQuery(window),n={left:"",right:"",top:"",bottom:""};p.css(n);var a=r.width()-p.outerWidth(!0)-1,i=r.height()-p.outerHeight(!0)-1;return a<=32+v&&(i-=v),i<=32+v&&(a-=v),n.left=n.right=a<=32?16:a/2>>0,n.top=i<=32?n.bottom=16:i/2>t?t:n.bottom=i/2>>0,Object.keys(n).forEach(function(e){""!==n[e]&&(n[e]+="px")}),n}function d(e){var t=e&&e.data&&void 0!==e.data.top?e.data.top:50;"block"===p.css("display")&&(p.css({display:"none"}),p.css(jQuery.extend({display:""},c(t))))}var f=null,p=null,h=null,g=null,m=null,v=0,y=null;return Object.freeze(Object.defineProperties({},{append:{value:t},body:{value:r},close:{value:n},init:{value:a},isOpen:{value:i},open:{value:o},resize:{value:s},setup:{value:u},wiki:{value:l},addClickHandler:{value:e}}))}(),Engine=function(){function e(){jQuery("#init-no-js,#init-lacking").remove(),function(){var e=jQuery(document.createDocumentFragment()),t=Story.has("StoryInterface")&&Story.get("StoryInterface").text.trim();if(t){if(UIBar.destroy(),jQuery(document.head).find("#style-core-display").remove(),e.append(t),0===e.find("#passages").length)throw new Error('no element with ID "passages" found within "StoryInterface" special passage');var r=[];e.find("[data-passage]").each(function(e,t){if("passages"===t.id)throw new Error('"StoryInterface" element <'+t.nodeName.toLowerCase()+' id="passages"> must not contain a "data-passage" content attribute');var n=t.getAttribute("data-passage").trim();if(null!==t.firstElementChild)throw new Error('"StoryInterface" element <'+t.nodeName.toLowerCase()+' data-passage="'+n+'"> contains child elements');Story.has(n)&&r.push({passage:n,element:t})}),r.length>0&&(E=r),Config.ui.updateStoryElements=!1}else e.append('<div id="story" role="main"><div id="passages"></div></div>');e.insertBefore("body>script#script-sugarcube")}(),S=new StyleWrapper(function(){return jQuery(document.createElement("style")).attr({id:"style-aria-outlines",type:"text/css"}).appendTo(document.head).get(0)}()),jQuery(document).on("mousedown.aria-outlines keydown.aria-outlines",function(e){return"keydown"===e.type?m():g()})}function t(){if(Story.has("StoryInit"))try{var e=Wikifier.wikifyEval(Story.get("StoryInit").text);if(Config.debug){var t=new DebugView(document.createDocumentFragment(),"special","StoryInit","StoryInit");t.modes({hidden:!0}),t.append(e),k=t.output}}catch(e){console.error(e),Alert.error("StoryInit",e.message)}if(null==Config.passages.start)throw new Error("starting passage not selected");if(!Story.has(Config.passages.start))throw new Error('starting passage ("'+Config.passages.start+'") not found');if(jQuery(document.documentElement).focus(),State.restore())f();else{var r=!0;switch(_typeof(Config.saves.autoload)){case"boolean":Config.saves.autoload&&Save.autosave.ok()&&Save.autosave.has()&&(r=!Save.autosave.load());break;case"string":"prompt"===Config.saves.autoload&&Save.autosave.ok()&&Save.autosave.has()&&(r=!1,UI.buildAutoload(),Dialog.open());break;case"function":Save.autosave.ok()&&Save.autosave.has()&&Config.saves.autoload()&&(r=!Save.autosave.load())}r&&p(Config.passages.start)}}function r(){LoadScreen.show(),window.scroll(0,0),State.reset(),jQuery.event.trigger(":enginerestart"),window.location.reload()}function n(){return b}function a(){return b===v.Idle}function i(){return b!==v.Idle}function o(){return b===v.Rendering}function s(){return w}function u(e){var t=State.goTo(e);return t&&f(),t}function l(e){var t=State.go(e);return t&&f(),t}function c(){return l(-1)}function d(){return l(1)}function f(){return p(State.passage,!0)}function p(e,t){var r=e;b=v.Playing,TempState={},State.clearTemporary();var n=void 0,a=void 0;if("function"==typeof Config.navigation.override)try{var i=Config.navigation.override(r);i&&(r=i)}catch(e){}var o=Story.get(r);if(jQuery.event.trigger({type:":passageinit",passage:o}),Object.keys(prehistory).forEach(function(e){"function"==typeof prehistory[e]&&prehistory[e].call(this,e)},o),t||State.create(o.title),w=Util.now(),document.body.className&&(document.body.className=""),Object.keys(predisplay).forEach(function(e){"function"==typeof predisplay[e]&&predisplay[e].call(this,e)},o),Story.has("PassageReady"))try{n=Wikifier.wikifyEval(Story.get("PassageReady").text)}catch(e){console.error(e),Alert.error("PassageReady",e.message)}b=v.Rendering;var s=jQuery(o.render()),u=document.getElementById("passages");if(u.hasChildNodes()&&("number"==typeof Config.passages.transitionOut||"string"==typeof Config.passages.transitionOut&&""!==Config.passages.transitionOut&&Has.transitionEndEvent?[].concat(_toConsumableArray(u.childNodes)).forEach(function(e){var t=jQuery(e);if(e.nodeType===Node.ELEMENT_NODE&&t.hasClass("passage")){if(t.hasClass("passage-out"))return;t.attr("id","out-"+t.attr("id")).addClass("passage-out"),"string"==typeof Config.passages.transitionOut?t.on(Has.transitionEndEvent,function(e){e.originalEvent.propertyName===Config.passages.transitionOut&&t.remove()}):setTimeout(function(){return t.remove()},Math.max(y,Config.passages.transitionOut))}else t.remove()}):jQuery(u).empty()),s.addClass("passage-in").appendTo(u),setTimeout(function(){return s.removeClass("passage-in")},y),Config.passages.displayTitles&&o.title!==Config.passages.start&&(document.title=o.title+" | "+Story.title),window.scroll(0,0),b=v.Playing,Story.has("PassageDone"))try{a=Wikifier.wikifyEval(Story.get("PassageDone").text)}catch(e){console.error(e),Alert.error("PassageDone",e.message)}if(jQuery.event.trigger({type:":passagedisplay",passage:o}),Object.keys(postdisplay).forEach(function(e){"function"==typeof postdisplay[e]&&postdisplay[e].call(this,e)},o),null!==E?E.forEach(function(e){jQuery(e.element).empty(),new Wikifier(e.element,Story.get(e.passage).processText().trim())}):Config.ui.updateStoryElements&&UIBar.update(),Config.debug){var l=void 0;null!=n&&(l=new DebugView(document.createDocumentFragment(),"special","PassageReady","PassageReady"),l.modes({hidden:!0}),l.append(n),s.prepend(l.output)),null!=a&&(l=new DebugView(document.createDocumentFragment(),"special","PassageDone","PassageDone"),l.modes({hidden:!0}),l.append(a),s.append(l.output)),1===State.turns&&null!=k&&s.prepend(k)}switch(g(),jQuery("#story").find("a[href]:not(.link-external)").addClass("link-external").end().find("a,link,button,input,select,textarea").not("[tabindex]").attr("tabindex",0),_typeof(Config.saves.autosave)){case"boolean":Config.saves.autosave&&Save.autosave.save();break;case"object":o.tags.some(function(e){return Config.saves.autosave.includes(e)})&&Save.autosave.save();break;case"function":Config.saves.autosave()&&Save.autosave.save()}return jQuery.event.trigger({type:":passageend",passage:o}),b=v.Idle,w=Util.now(),s[0]}function h(e,t,r){var n=!1;switch(r){case undefined:break;case"replace":case"back":n=!0;break;default:throw new Error('Engine.display option parameter called with obsolete value "'+r+'"; please notify the developer')}p(e,n)}function g(){S.set("*:focus{outline:none}")}function m(){S.clear()}var v=Util.toEnum({Idle:"idle",Playing:"playing",Rendering:"rendering"}),y=40,b=v.Idle,w=null,k=null,S=null,E=null;return Object.freeze(Object.defineProperties({},{States:{value:v},minDomActionDelay:{value:y},init:{value:e},start:{value:t},restart:{value:r},state:{get:n},isIdle:{value:a},isPlaying:{value:i},isRendering:{value:o},lastPlay:{get:s},goTo:{value:u},go:{value:l},backward:{value:c},forward:{value:d},show:{value:f},play:{value:p},display:{value:h}}))}(),Passage=function(){var e=void 0;e=/^(?:debug|nobr|passage|widget|twine\..*)$/i;return function(){function t(r,n){var a=this;_classCallCheck(this,t),Object.defineProperties(this,{title:{value:Util.unescape(r)},element:{value:n||null},tags:{value:Object.freeze(n&&n.hasAttribute("tags")?n.getAttribute("tags").trim().splitOrEmpty(/\s+/).sort().filter(function(e,t,r){return 0===t||r[t-1]!==e}):[])},_excerpt:{writable:!0,value:null}}),Object.defineProperties(this,{domId:{value:"passage-"+Util.slugify(this.title)},classes:{value:Object.freeze(0===this.tags.length?[]:function(){return a.tags.filter(function(t){return!e.test(t)}).map(function(e){return Util.slugify(e)})}())}})}return _createClass(t,[{key:"description",value:function(){var e=Config.passages.descriptions;if(null!=e)switch(void 0===e?"undefined":_typeof(e)){case"boolean":if(e)return this.title;break;case"object":if(e instanceof Map&&e.has(this.title))return e.get(this.title);if(e.hasOwnProperty(this.title))return e[this.title];break;case"function":var r=e.call(this);if(r)return r;break;default:throw new TypeError("Config.passages.descriptions must be a boolean, object, or function")}return null===this._excerpt&&(this._excerpt=t.getExcerptFromText(this.text)),this._excerpt}},{key:"processText",value:function(){if(null==this.element)return this.text;if(this.tags.includes("Twine.image"))return"[img["+this.text+"]]";var e=this.text;return Config.passages.onProcess&&(e=Config.passages.onProcess.call(null,{title:this.title,tags:this.tags,text:e})),(Config.passages.nobr||this.tags.includes("nobr"))&&(e=e.replace(/^\n+|\n+$/g,"").replace(/\n+/g," ")),e}},{key:"render",value:function(){var e=this,r=this.tags.length>0?this.tags.join(" "):null,n=document.createElement("div");return jQuery(n).attr({id:this.domId,"data-passage":this.title,"data-tags":r}).addClass("passage "+this.className),jQuery(document.body).attr("data-tags",r).addClass(this.className),jQuery(document.documentElement).attr("data-tags",r),jQuery.event.trigger({type:":passagestart",content:n,passage:this}),Object.keys(prerender).forEach(function(t){"function"==typeof prerender[t]&&prerender[t].call(e,n,t)}),Story.has("PassageHeader")&&new Wikifier(n,Story.get("PassageHeader").processText()),new Wikifier(n,this.processText()),Story.has("PassageFooter")&&new Wikifier(n,Story.get("PassageFooter").processText()),jQuery.event.trigger({type:":passagerender",content:n,passage:this}),Object.keys(postrender).forEach(function(t){"function"==typeof postrender[t]&&postrender[t].call(e,n,t)}),this._excerpt=t.getExcerptFromNode(n),n}},{key:"className",get:function(){return this.classes.join(" ")}},{key:"text",get:function(){if(null==this.element){var e=Util.escape(this.title);return'<div class="error-view"><span class="error">'+(L10n.get("errorTitle")+": "+L10n.get("errorNonexistentPassage",{passage:e}))+"</span></div>"}return this.element.textContent.replace(/\r/g,"")}}],[{key:"getExcerptFromNode",value:function(e,t){if(!e.hasChildNodes())return"";var r=e.textContent.trim();if(""!==r){var n=new RegExp("(\\S+(?:\\s+\\S+){0,"+(t>0?t-1:7)+"})");r=r.replace(/\s+/g," ").match(n)}return r?r[1]+"…":"…"}},{key:"getExcerptFromText",value:function(e,t){if(""===e)return"";var r=new RegExp("(\\S+(?:\\s+\\S+){0,"+(t>0?t-1:7)+"})"),n=e.replace(/<<.*?>>/g," ").replace(/<.*?>/g," ").trim().replace(/^\s*\|.*\|.*?$/gm,"").replace(/\[[<>]?img\[[^\]]*\]\]/g,"").replace(/\[\[([^|\]]*?)(?:(?:\||->|<-)[^\]]*)?\]\]/g,"$1").replace(/^\s*!+(.*?)$/gm,"$1").replace(/'{2}|\/{2}|_{2}|@{2}/g,"").trim().replace(/\s+/g," ").match(r);return n?n[1]+"…":"…"}}]),t}()}(),Save=function(){function e(){if("cookie"===storage.name)return n(),Config.saves.autoload=undefined,Config.saves.autosave=undefined,Config.saves.isAllowed=undefined,Config.saves.onLoad=undefined,Config.saves.onSave=undefined,Config.saves.slots=0,!1;var e=r(),t=!1;Array.isArray(e)&&(e={autosave:null,slots:e},t=!0),Config.saves.slots!==e.slots.length&&(Config.saves.slots<e.slots.length?(e.slots.reverse(),e.slots=e.slots.filter(function(e){return!(null===e&&this.count>0)||(--this.count,!1)},{count:e.slots.length-Config.saves.slots}),e.slots.reverse()):Config.saves.slots>e.slots.length&&j(e.slots,Config.saves.slots-e.slots.length),t=!0),T(e.autosave)&&(t=!0);for(var a=0;a<e.slots.length;++a)T(e.slots[a])&&(t=!0);return x(e)&&(storage.delete("saves"),t=!1),t&&O(e),P=e.slots.length-1,!0}function t(){return{autosave:null,slots:j([],Config.saves.slots)}}function r(){var e=storage.get("saves");return null===e?t():e}function n(){return storage.delete("saves"),!0}function a(){return i()||d()}function i(){return"cookie"!==storage.name&&void 0!==Config.saves.autosave}function o(){return null!==r().autosave}function s(){return r().autosave}function u(){var e=r();return null!==e.autosave&&A(e.autosave)}function l(e,t){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return!1;var n=r(),a={title:e||Story.get(State.passage).description(),date:Date.now()};return null!=t&&(a.metadata=t),n.autosave=C(a),O(n)}function c(){var e=r();return e.autosave=null,O(e)}function d(){return"cookie"!==storage.name&&-1!==P}function f(){return P+1}function p(){if(!d())return 0;for(var e=r(),t=0,n=0,a=e.slots.length;n<a;++n)null!==e.slots[n]&&++t;return t}function h(){return 0===p()}function g(e){if(e<0||e>P)return!1;var t=r();return!(e>=t.slots.length||null===t.slots[e])}function m(e){if(e<0||e>P)return null;var t=r();return e>=t.slots.length?null:t.slots[e]}function v(e){if(e<0||e>P)return!1;var t=r();return!(e>=t.slots.length||null===t.slots[e])&&A(t.slots[e])}function y(e,t,n){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return Dialog.isOpen()?$(document).one(":dialogclosed",function(){return UI.alert(L10n.get("savesDisallowed"))}):UI.alert(L10n.get("savesDisallowed")),!1;if(e<0||e>P)return!1;var a=r();if(e>=a.slots.length)return!1;var i={title:t||Story.get(State.passage).description(),date:Date.now()};return null!=n&&(i.metadata=n),a.slots[e]=C(i),O(a)}function b(e){if(e<0||e>P)return!1;var t=r();return!(e>=t.slots.length)&&(t.slots[e]=null,O(t))}function w(e,t){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return void(Dialog.isOpen()?$(document).one(":dialogclosed",function(){return UI.alert(L10n.get("savesDisallowed"))}):UI.alert(L10n.get("savesDisallowed")));var r=null==e?Story.domId:Util.slugify(e),n=r+"-"+function(){var e=new Date,t=e.getMonth()+1,r=e.getDate(),n=e.getHours(),a=e.getMinutes(),i=e.getSeconds();return t<10&&(t="0"+t),r<10&&(r="0"+r),n<10&&(n="0"+n),a<10&&(a="0"+a),i<10&&(i="0"+i),""+e.getFullYear()+t+r+"-"+n+a+i}()+".save",a=null==t?{}:{metadata:t},i=LZString.compressToBase64(JSON.stringify(C(a)));saveAs(new Blob([i],{type:"text/plain;charset=UTF-8"}),n)}function k(e){var t=e.target.files[0],r=new FileReader;jQuery(r).on("load",function(e){var r=e.currentTarget;if(r.result){var n=void 0;try{n=JSON.parse(/\.json$/i.test(t.name)||/^\{/.test(r.result)?r.result:LZString.decompressFromBase64(r.result))}catch(e){}A(n)}}),r.readAsText(t)}function S(e){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return Dialog.isOpen()?$(document).one(":dialogclosed",function(){return UI.alert(L10n.get("savesDisallowed"))}):UI.alert(L10n.get("savesDisallowed")),null;var t=null==e?{}:{metadata:e};return LZString.compressToBase64(JSON.stringify(C(t)))}function E(e){var t=void 0;try{t=JSON.parse(LZString.decompressFromBase64(e))}catch(e){}return A(t)?t.metadata:null}function j(e,t){for(var r=0;r<t;++r)e.push(null);return e}function x(e){for(var t=e.slots,r=!0,n=0,a=t.length;n<a;++n)if(null!==t[n]){r=!1;break}return null===e.autosave&&r}function O(e){return x(e)?(storage.delete("saves"),!0):storage.set("saves",e)}function T(e){if(null==e||"object"!==(void 0===e?"undefined":_typeof(e)))return!1;var t=!1;return e.hasOwnProperty("state")&&e.state.hasOwnProperty("delta")&&e.state.hasOwnProperty("index")||(e.hasOwnProperty("data")?(delete e.mode,e.state={delta:State.deltaEncode(e.data)},delete e.data):e.state.hasOwnProperty("delta")?e.state.hasOwnProperty("index")||delete e.state.mode:(delete e.state.mode,e.state.delta=State.deltaEncode(e.state.history),delete e.state.history),e.state.index=e.state.delta.length-1,t=!0),e.state.hasOwnProperty("rseed")&&(e.state.seed=e.state.rseed,delete e.state.rseed,e.state.delta.forEach(function(e,t,r){r[t].hasOwnProperty("rcount")&&(r[t].pull=r[t].rcount,delete r[t].rcount)}),t=!0),(e.state.hasOwnProperty("expired")&&"number"==typeof e.state.expired||e.state.hasOwnProperty("unique")||e.state.hasOwnProperty("last"))&&(e.state.hasOwnProperty("expired")&&"number"==typeof e.state.expired&&delete e.state.expired,(e.state.hasOwnProperty("unique")||e.state.hasOwnProperty("last"))&&(e.state.expired=[],e.state.hasOwnProperty("unique")&&(e.state.expired.push(e.state.unique),delete e.state.unique),e.state.hasOwnProperty("last")&&(e.state.expired.push(e.state.last),delete e.state.last)),t=!0),t}function C(e){if(null!=e&&"object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("supplemental parameter must be an object");var t=Object.assign({},e,{id:Config.saves.id,state:State.marshalForSave()});return Config.saves.version&&(t.version=Config.saves.version),"function"==typeof Config.saves.onSave&&Config.saves.onSave(t),t.state.delta=State.deltaEncode(t.state.history),delete t.state.history,t}function A(e){try{if(T(e),!e||!e.hasOwnProperty("id")||!e.hasOwnProperty("state"))throw new Error(L10n.get("errorSaveMissingData"));if(e.state.history=State.deltaDecode(e.state.delta),delete e.state.delta,"function"==typeof Config.saves.onLoad&&Config.saves.onLoad(e),e.id!==Config.saves.id)throw new Error(L10n.get("errorSaveIdMismatch"));State.unmarshalForSave(e.state),Engine.show()}catch(e){return UI.alert(e.message.toUpperFirst()+".</p><p>"+L10n.get("aborting")+"."),!1}return!0}var P=-1;return Object.freeze(Object.defineProperties({},{init:{value:e},get:{value:r},clear:{value:n},ok:{value:a},autosave:{value:Object.freeze(Object.defineProperties({},{ok:{value:i},has:{value:o},get:{value:s},load:{value:u},save:{value:l},delete:{value:c}}))},slots:{value:Object.freeze(Object.defineProperties({},{ok:{value:d},length:{get:f},isEmpty:{value:h},count:{value:p},has:{value:g},get:{value:m},load:{value:v},save:{value:y},delete:{value:b}}))},export:{value:w},import:{value:k},serialize:{value:S},deserialize:{value:E}}))}(),Setting=function(){function e(){if(storage.has("options")){var e=storage.get("options");null!==e&&(window.SugarCube.settings=settings=Object.assign(t(),e)),r(),storage.delete("options")}n(),m.forEach(function(e){if(e.hasOwnProperty("onInit")){var t={name:e.name,value:settings[e.name],default:e.default};e.hasOwnProperty("list")&&(t.list=e.list),e.onInit.call(t)}})}function t(){return Object.create(null)}function r(){var e=t();return Object.keys(settings).length>0&&m.filter(function(e){return e.type!==v.Header&&settings[e.name]!==e.default}).forEach(function(t){return e[t.name]=settings[t.name]}),0===Object.keys(e).length?(storage.delete("settings"),!0):storage.set("settings",e)}function n(){var e=t(),r=storage.get("settings")||t();m.filter(function(e){return e.type!==v.Header}).forEach(function(t){return e[t.name]=t.default}),window.SugarCube.settings=settings=Object.assign(e,r)}function a(){return window.SugarCube.settings=settings=t(),storage.delete("settings"),!0}function i(e){if(0===arguments.length)a(),n();else{if(null==e||!p(e))throw new Error('nonexistent setting "'+e+'"');var t=h(e);t.type!==v.Header&&(settings[e]=t.default)}return r()}function o(e,t){m.forEach(e,t)}function s(e,t,r){if(arguments.length<3){var n=[];throw arguments.length<1&&n.push("type"),arguments.length<2&&n.push("name"),arguments.length<3&&n.push("definition"),new Error("missing parameters, no "+n.join(" or ")+" specified")}if("object"!==(void 0===r?"undefined":_typeof(r)))throw new TypeError("definition parameter must be an object");if(p(t))throw new Error('cannot clobber existing setting "'+t+'"');var a={type:e,name:t,label:"string"==typeof r.label?r.label.trim():""};if("string"==typeof r.desc){var i=r.desc.trim();""!==i&&(a.desc=i)}switch(e){case v.Header:break;case v.Toggle:a.default=!!r.default;break;case v.List:if(!r.hasOwnProperty("list"))throw new Error("no list specified");if(!Array.isArray(r.list))throw new TypeError("list must be an array");if(0===r.list.length)throw new Error("list must not be empty");if(a.list=Object.freeze(r.list),null==r.default)a.default=r.list[0];else{var o=r.list.indexOf(r.default);if(-1===o)throw new Error("list does not contain default");a.default=r.list[o]}break;case v.Range:if(!r.hasOwnProperty("min"))throw new Error("no min specified");if("number"!=typeof r.min||Number.isNaN(r.min)||!Number.isFinite(r.min))throw new TypeError("min must be a finite number");if(!r.hasOwnProperty("max"))throw new Error("no max specified");if("number"!=typeof r.max||Number.isNaN(r.max)||!Number.isFinite(r.max))throw new TypeError("max must be a finite number");if(!r.hasOwnProperty("step"))throw new Error("no step specified");if("number"!=typeof r.step||Number.isNaN(r.step)||!Number.isFinite(r.step)||r.step<=0)throw new TypeError("step must be a finite number greater than zero");var s=function(){var e=String(r.step),t=e.lastIndexOf(".");return-1===t?0:e.length-t-1}();if(function(e){if(s>0){var t=Number(r.min+"e"+s),n=Number(r.step+"e"+s),a=Number(e+"e"+s)-t;return Number(a-a%n+t+"e-"+s)}var i=e-r.min;return i-i%r.step+r.min}(r.max)!==r.max)throw new RangeError("max ("+r.max+") is not a multiple of the step ("+r.step+") plus the min ("+r.min+")");if(a.max=r.max,a.min=r.min,a.step=r.step,null==r.default)a.default=r.max;else{if("number"!=typeof r.default||Number.isNaN(r.default)||!Number.isFinite(r.default))throw new TypeError("default must be a finite number");if(r.default<r.min)throw new RangeError("default ("+r.default+") is less than min ("+r.min+")");if(r.default>r.max)throw new RangeError("default ("+r.default+") is greater than max ("+r.max+")");a.default=r.default}break;default:throw new Error("unknown Setting type: "+e)}"function"==typeof r.onInit&&(a.onInit=Object.freeze(r.onInit)),"function"==typeof r.onChange&&(a.onChange=Object.freeze(r.onChange)),m.push(Object.freeze(a))}function u(e,t){s(v.Header,e,{desc:t})}function l(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.apply(undefined,[v.Toggle].concat(t))}function c(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.apply(undefined,[v.List].concat(t))}function d(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.apply(undefined,[v.Range].concat(t))}function f(){return 0===m.length}function p(e){return m.some(function(t){return t.name===e})}function h(e){return m.find(function(t){return t.name===e})}function g(e){p(e)&&delete settings[e];for(var t=0;t<m.length;++t)if(m[t].name===e){m.splice(t,1),g(e);break}}var m=[],v=Util.toEnum({Header:0,Toggle:1,List:2,Range:3});return Object.freeze(Object.defineProperties({},{Types:{value:v},init:{value:e},create:{value:t},save:{value:r},load:{value:n},clear:{value:a},reset:{value:i},forEach:{value:o},add:{value:s},addHeader:{value:u},addToggle:{value:l},addList:{value:c},addRange:{value:d},isEmpty:{value:f},has:{value:p},get:{value:h},delete:{value:g}}))}(),Story=function(){function e(){function e(e){if(e.tags.includesAny(n))throw new Error('starting passage "'+e.title+'" contains illegal tags; invalid: "'+e.tags.filter(function(e){return n.includes(e)}).sort().join('", "')+'"')}function t(e){if(a.includes(e.title)&&e.tags.includesAny(n))throw new Error('special passage "'+e.title+'" contains illegal tags; invalid: "'+e.tags.filter(function(e){return n.includes(e)}).sort().join('", "')+'"')}var n=["widget"],a=["PassageDone","PassageFooter","PassageHeader","PassageReady","StoryAuthor","StoryBanner","StoryCaption","StoryInit","StoryMenu","StoryShare","StorySubtitle"],i=jQuery("tw-storydata"),o=i.attr("startnode")||"";Config.passages.start=null,Config.debug=/\bdebug\b/.test(i.attr("options")),i.children("style").each(function(e){d.push(new Passage("tw-user-style-"+e,this))}),i.children("script").each(function(e){f.push(new Passage("tw-user-script-"+e,this))}),i.children('tw-passagedata:not([tags~="Twine.private"],[tags~="annotation"])').each(function(){var r=jQuery(this),n=r.attr("pid")||"",a=new Passage(r.attr("name"),this);n===o&&""!==o?(Config.passages.start=a.title,e(a),c[a.title]=a):a.tags.includes("widget")?p.push(a):(t(a),c[a.title]=a)}),g=i.attr("ifid"),r("Liff Origins: Jaylie"),Config.saves.id=Story.domId}function t(){!function(){var e=document.createElement("style");new StyleWrapper(e).add(d.map(function(e){return e.text.trim()}).join("\n")),jQuery(e).appendTo(document.head).attr({id:"style-story",type:"text/css"})}();for(var e=0;e<f.length;++e)try{Scripting.evalJavaScript(f[e].text)}catch(t){console.error(t),Alert.error(f[e].title,"object"===(void 0===t?"undefined":_typeof(t))?t.message:t)}for(var t=0;t<p.length;++t)try{Wikifier.wikifyEval(p[t].processText())}catch(e){console.error(e),Alert.error(p[t].title,"object"===(void 0===e?"undefined":_typeof(e))?e.message:e)}}function r(e){if(null==e||""===e)throw new Error("story title cannot be null or empty");if(document.title=h=Util.unescape(e),""===(m=Util.slugify(h)))if(""!==g)m=g;else for(var t=0,r=h.length;t<r;++t){var n=Util.charAndPosAt(h,t),a=n.char,i=n.start,o=n.end;m+=a.codePointAt(0).toString(16),t+=o-i}}function n(){return h}function a(){return m}function i(){return g}function o(e){var t=void 0===e?"undefined":_typeof(e);switch(t){case"number":case"string":return c.hasOwnProperty(String(e));case"boolean":case"function":t="a "+t;break;case"undefined":break;default:t=null===e?"null":"an "+t}throw new TypeError("Story.has title parameter cannot be "+t)}function s(e){var t=void 0===e?"undefined":_typeof(e);switch(t){case"number":case"string":var r=String(e);return c.hasOwnProperty(r)?c[r]:new Passage(r||"(unknown)");case"boolean":case"function":t="a "+t;break;case"undefined":break;default:t=null===e?"null":"an "+t}throw new TypeError("Story.get title parameter cannot be "+t)}function u(e,t){for(var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"title",n=Object.keys(c),a=[],i=0;i<n.length;++i){var o=c[n[i]];if(o.hasOwnProperty(e))switch(_typeof(o[e])){case"undefined":break;case"object":o[e]instanceof Array&&o[e].some(function(e){return e==t})&&a.push(o);break;default:o[e]==t&&a.push(o)}}return a.sort(function(e,t){return e[r]==t[r]?0:e[r]<t[r]?-1:1}),a}function l(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"title";if("function"!=typeof e)throw new Error("Story.lookupWith filter parameter must be a function");for(var r=Object.keys(c),n=[],a=0;a<r.length;++a){var i=c[r[a]];e(i)&&n.push(i)}return n.sort(function(e,r){return e[t]==r[t]?0:e[t]<r[t]?-1:1}),n}var c={},d=[],f=[],p=[],h="",g="",m="";return Object.freeze(Object.defineProperties({},{passages:{value:c},styles:{value:d},scripts:{value:f},
widgets:{value:p},load:{value:e},init:{value:t},title:{get:n},domId:{get:a},ifId:{get:i},has:{value:o},get:{value:s},lookup:{value:u},lookupWith:{value:l}}))}(),UI=function(){function e(e,t){var r=t,n=Config.debug,a=Config.cleanupWikifierOutput;Config.debug=!1,Config.cleanupWikifierOutput=!1;try{null==r&&(r=document.createElement("ul"));var i=document.createDocumentFragment();new Wikifier(i,Story.get(e).processText().trim());var o=[].concat(_toConsumableArray(i.querySelectorAll(".error"))).map(function(e){return e.textContent.replace(errorPrologRegExp,"")});if(o.length>0)throw new Error(o.join("; "));for(;i.hasChildNodes();){var s=i.firstChild;if(s.nodeType===Node.ELEMENT_NODE&&"A"===s.nodeName.toUpperCase()){var u=document.createElement("li");r.appendChild(u),u.appendChild(s)}else i.removeChild(s)}}finally{Config.cleanupWikifierOutput=a,Config.debug=n}return r}function t(e){jQuery(Dialog.setup("Alert","alert")).append("<p>"+e+'</p><ul class="buttons"><li><button id="alert-ok" class="ui-close">'+L10n.get(["alertOk","ok"])+"</button></li></ul>");for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];Dialog.open.apply(Dialog,r)}function r(){u(),Dialog.open.apply(Dialog,arguments)}function n(){l(),Dialog.open.apply(Dialog,arguments)}function a(){c(),Dialog.open.apply(Dialog,arguments)}function i(){d(),Dialog.open.apply(Dialog,arguments)}function o(){f(),Dialog.open.apply(Dialog,arguments)}function s(){return jQuery(Dialog.setup(L10n.get("autoloadTitle"),"autoload")).append("<p>"+L10n.get("autoloadPrompt")+'</p><ul class="buttons"><li><button id="autoload-ok" class="ui-close">'+L10n.get(["autoloadOk","ok"])+'</button></li><li><button id="autoload-cancel" class="ui-close">'+L10n.get(["autoloadCancel","cancel"])+"</button></li></ul>"),jQuery(document).one("click.autoload",".ui-close",function(e){var t="autoload-ok"===e.target.id;jQuery(document).one(":dialogclosed",function(){t&&Save.autosave.load()||Engine.play(Config.passages.start)})}),!0}function u(){var e=document.createElement("ul");jQuery(Dialog.setup(L10n.get("jumptoTitle"),"jumpto list")).append(e);for(var t=State.expired.length,r=State.size-1;r>=0;--r)if(r!==State.activeIndex){var n=Story.get(State.history[r].title);n&&n.tags.includes("bookmark")&&jQuery(document.createElement("li")).append(jQuery(document.createElement("a")).ariaClick({one:!0},function(e){return function(){return jQuery(document).one(":dialogclosed",function(){return Engine.goTo(e)})}}(r)).addClass("ui-close").text(L10n.get("jumptoTurn")+" "+(t+r+1)+": "+n.description())).appendTo(e)}e.hasChildNodes()||jQuery(e).append("<li><a><em>"+L10n.get("jumptoUnavailable")+"</em></a></li>")}function l(){return jQuery(Dialog.setup(L10n.get("restartTitle"),"restart")).append("<p>"+L10n.get("restartPrompt")+'</p><ul class="buttons"><li><button id="restart-ok">'+L10n.get(["restartOk","ok"])+'</button></li><li><button id="restart-cancel" class="ui-close">'+L10n.get(["restartCancel","cancel"])+"</button></li></ul>").find("#restart-ok").ariaClick({one:!0},function(){jQuery(document).one(":dialogclosed",function(){return Engine.restart()}),Dialog.close()}),!0}function c(){function e(e,t,r,n){var a=jQuery(document.createElement("button")).attr("id","saves-"+e).html(r);return t&&a.addClass(t),n?a.ariaClick(n):a.ariaDisabled(!0),jQuery(document.createElement("li")).append(a)}var r=jQuery(Dialog.setup(L10n.get("savesTitle"),"saves")),n=Save.ok();if(n&&r.append(function(){function e(e,t,r,n,a){var i=jQuery(document.createElement("button")).attr("id","saves-"+e+"-"+n).addClass(e).html(r);return t&&i.addClass(t),a?"auto"===n?i.ariaClick({label:r+" "+L10n.get("savesLabelAuto")},function(){return a()}):i.ariaClick({label:r+" "+L10n.get("savesLabelSlot")+" "+(n+1)},function(){return a(n)}):i.ariaDisabled(!0),i}var t=Save.get(),r=jQuery(document.createElement("tbody"));if(Save.autosave.ok()){var n=jQuery(document.createElement("td")),a=jQuery(document.createElement("td")),i=jQuery(document.createElement("td")),o=jQuery(document.createElement("td"));jQuery(document.createElement("b")).attr({title:L10n.get("savesLabelAuto"),"aria-label":L10n.get("savesLabelAuto")}).text("A").appendTo(n),t.autosave?(a.append(e("load","ui-close",L10n.get("savesLabelLoad"),"auto",function(){jQuery(document).one(":dialogclosed",function(){return Save.autosave.load()})})),jQuery(document.createElement("div")).text(t.autosave.title).appendTo(i),jQuery(document.createElement("div")).addClass("datestamp").html(t.autosave.date?""+new Date(t.autosave.date).toLocaleString():"<em>"+L10n.get("savesUnknownDate")+"</em>").appendTo(i),o.append(e("delete",null,L10n.get("savesLabelDelete"),"auto",function(){Save.autosave.delete(),c()}))):(a.append(e("load",null,L10n.get("savesLabelLoad"),"auto")),i.addClass("empty").text("•  •  •"),o.append(e("delete",null,L10n.get("savesLabelDelete"),"auto"))),jQuery(document.createElement("tr")).append(n).append(a).append(i).append(o).appendTo(r)}for(var s=0,u=t.slots.length;s<u;++s){var l=jQuery(document.createElement("td")),d=jQuery(document.createElement("td")),f=jQuery(document.createElement("td")),p=jQuery(document.createElement("td"));l.append(document.createTextNode(s+1)),t.slots[s]?(d.append(e("load","ui-close",L10n.get("savesLabelLoad"),s,function(e){jQuery(document).one(":dialogclosed",function(){return Save.slots.load(e)})})),jQuery(document.createElement("div")).text(t.slots[s].title).appendTo(f),jQuery(document.createElement("div")).addClass("datestamp").html(t.slots[s].date?""+new Date(t.slots[s].date).toLocaleString():"<em>"+L10n.get("savesUnknownDate")+"</em>").appendTo(f),p.append(e("delete",null,L10n.get("savesLabelDelete"),s,function(e){Save.slots.delete(e),c()}))):(d.append(e("save","ui-close",L10n.get("savesLabelSave"),s,Save.slots.save)),f.addClass("empty").text("•  •  •"),p.append(e("delete",null,L10n.get("savesLabelDelete"),s))),jQuery(document.createElement("tr")).append(l).append(d).append(f).append(p).appendTo(r)}return jQuery(document.createElement("table")).attr("id","saves-list").append(r)}()),n||Has.fileAPI){var a=jQuery(document.createElement("ul")).addClass("buttons").appendTo(r);return Has.fileAPI&&(a.append(e("export","ui-close",L10n.get("savesLabelExport"),function(){return Save.export()})),a.append(e("import",null,L10n.get("savesLabelImport"),function(){return r.find("#saves-import-file").trigger("click")})),jQuery(document.createElement("input")).css({display:"block",visibility:"hidden",position:"fixed",left:"-9999px",top:"-9999px",width:"1px",height:"1px"}).attr({type:"file",id:"saves-import-file",tabindex:-1,"aria-hidden":!0}).on("change",function(e){jQuery(document).one(":dialogclosed",function(){return Save.import(e)}),Dialog.close()}).appendTo(r)),n&&a.append(e("clear",null,L10n.get("savesLabelClear"),Save.autosave.has()||!Save.slots.isEmpty()?function(){Save.clear(),c()}:null)),!0}return t(L10n.get("savesIncapable")),!1}function d(){var e=jQuery(Dialog.setup(L10n.get("settingsTitle"),"settings"));return Setting.forEach(function(t){if(t.type===Setting.Types.Header){var r=t.name,n=Util.slugify(r),a=jQuery(document.createElement("div")),i=jQuery(document.createElement("h2"));return a.attr("id","header-body-"+n).append(i).appendTo(e),i.attr("id","header-heading-"+n).wiki(r),void(t.desc&&jQuery(document.createElement("p")).attr("id","header-desc-"+n).wiki(t.desc).appendTo(a))}var o=t.name,s=Util.slugify(o),u=jQuery(document.createElement("div")),l=jQuery(document.createElement("label")),c=jQuery(document.createElement("div")),d=void 0;switch(jQuery(document.createElement("div")).append(l).append(c).appendTo(u),t.desc&&jQuery(document.createElement("p")).attr("id","setting-desc-"+s).wiki(t.desc).appendTo(u),l.attr({id:"setting-label-"+s,for:"setting-control-"+s}).wiki(t.label),null==settings[o]&&(settings[o]=t.default),t.type){case Setting.Types.Toggle:d=jQuery(document.createElement("button")),settings[o]?d.addClass("enabled").text(L10n.get("settingsOn")):d.text(L10n.get("settingsOff")),d.ariaClick(function(){settings[o]?(jQuery(this).removeClass("enabled").text(L10n.get("settingsOff")),settings[o]=!1):(jQuery(this).addClass("enabled").text(L10n.get("settingsOn")),settings[o]=!0),Setting.save(),t.hasOwnProperty("onChange")&&t.onChange.call({name:o,value:settings[o],default:t.default})});break;case Setting.Types.List:d=jQuery(document.createElement("select"));for(var f=0,p=t.list.length;f<p;++f)jQuery(document.createElement("option")).val(f).text(t.list[f]).appendTo(d);d.val(t.list.indexOf(settings[o])).attr("tabindex",0).on("change",function(){settings[o]=t.list[Number(this.value)],Setting.save(),t.hasOwnProperty("onChange")&&t.onChange.call({name:o,value:settings[o],default:t.default,list:t.list})});break;case Setting.Types.Range:d=jQuery(document.createElement("input")),d.attr({type:"range",min:t.min,max:t.max,step:t.step,value:settings[o],tabindex:0}).on("change input",function(){settings[o]=Number(this.value),Setting.save(),t.hasOwnProperty("onChange")&&t.onChange.call({name:o,value:settings[o],default:t.default,min:t.min,max:t.max,step:t.step})}).on("keypress",function(e){13===e.which&&(e.preventDefault(),d.trigger("change"))})}d.attr("id","setting-control-"+s).appendTo(c),u.attr("id","setting-body-"+s).appendTo(e)}),e.append('<ul class="buttons"><li><button id="settings-ok" class="ui-close">'+L10n.get(["settingsOk","ok"])+'</button></li><li><button id="settings-reset">'+L10n.get("settingsReset")+"</button></li></ul>").find("#settings-reset").ariaClick({one:!0},function(){jQuery(document).one(":dialogclosed",function(){Setting.reset(),window.location.reload()}),Dialog.close()}),!0}function f(){try{jQuery(Dialog.setup(L10n.get("shareTitle"),"share list")).append(e("StoryShare"))}catch(e){return console.error(e),Alert.error("StoryShare",e.message),!1}return!0}return Object.freeze(Object.defineProperties({},{assembleLinkList:{value:e},alert:{value:t},jumpto:{value:r},restart:{value:n},saves:{value:a},settings:{value:i},share:{value:o},buildAutoload:{value:s},buildJumpto:{value:u},buildRestart:{value:l},buildSaves:{value:c},buildSettings:{value:d},buildShare:{value:f},stow:{value:function(){return UIBar.stow()}},unstow:{value:function(){return UIBar.unstow()}},setStoryElements:{value:function(){return UIBar.update()}},isOpen:{value:function(){return Dialog.isOpen.apply(Dialog,arguments)}},body:{value:function(){return Dialog.body()}},setup:{value:function(){return Dialog.setup.apply(Dialog,arguments)}},addClickHandler:{value:function(){return Dialog.addClickHandler.apply(Dialog,arguments)}},open:{value:function(){return Dialog.open.apply(Dialog,arguments)}},close:{value:function(){return Dialog.close.apply(Dialog,arguments)}},resize:{value:function(){return Dialog.resize()}},buildDialogAutoload:{value:s},buildDialogJumpto:{value:u},buildDialogRestart:{value:l},buildDialogSaves:{value:c},buildDialogSettings:{value:d},buildDialogShare:{value:f},buildLinkListFromPassage:{value:e}}))}(),UIBar=function(){function e(){c&&(c.hide(),jQuery(document).off(".ui-bar"),jQuery(document.head).find("#style-ui-bar").remove(),c.remove(),c=null)}function t(){return c&&c.hide(),this}function r(){if(!document.getElementById("ui-bar")){var e=function(){var e=L10n.get("uiBarToggle"),t=L10n.get("uiBarBackward"),r=L10n.get("uiBarJumpto"),n=L10n.get("uiBarForward");return jQuery(document.createDocumentFragment()).append('<div id="ui-bar"><div id="ui-bar-tray"><button id="ui-bar-toggle" tabindex="0" title="'+e+'" aria-label="'+e+'"></button><div id="ui-bar-history"><button id="history-backward" tabindex="0" title="'+t+'" aria-label="'+t+'"></button><button id="history-jumpto" tabindex="0" title="'+r+'" aria-label="'+r+'"></button><button id="history-forward" tabindex="0" title="'+n+'" aria-label="'+n+'"></button></div></div><div id="ui-bar-body"><header id="title" role="banner"><div id="story-banner"></div><h1 id="story-title"></h1><div id="story-subtitle"></div><div id="story-title-separator"></div><p id="story-author"></p></header><div id="story-caption"></div><nav id="menu" role="navigation"><ul id="menu-story"></ul><ul id="menu-core"><li id="menu-item-saves"><a tabindex="0">'+L10n.get("savesTitle")+'</a></li><li id="menu-item-settings"><a tabindex="0">'+L10n.get("settingsTitle")+'</a></li><li id="menu-item-restart"><a tabindex="0">'+L10n.get("restartTitle")+'</a></li><li id="menu-item-share"><a tabindex="0">'+L10n.get("shareTitle")+"</a></li></ul></nav></div></div>")}();c=jQuery(e.find("#ui-bar").get(0)),e.insertBefore("body>script#script-sugarcube"),jQuery(document).on(":historyupdate.ui-bar",function(e,t){return function(){e.ariaDisabled(State.length<2),t.ariaDisabled(State.length===State.size)}}(jQuery("#history-backward"),jQuery("#history-forward")))}}function n(){return c&&"none"===c.css("display")}function a(){return c&&c.hasClass("stowed")}function i(){return c&&c.show(),this}function o(){c&&(("boolean"==typeof Config.ui.stowBarInitially?Config.ui.stowBarInitially:jQuery(window).width()<=Config.ui.stowBarInitially)&&function(){var e=jQuery(c).add("#story");e.addClass("no-transition"),c.addClass("stowed"),setTimeout(function(){return e.removeClass("no-transition")},Engine.minDomActionDelay)}(),jQuery("#ui-bar-toggle").ariaClick({label:L10n.get("uiBarToggle")},function(){return c.toggleClass("stowed")}),Config.history.controls?(jQuery("#history-backward").ariaDisabled(State.length<2).ariaClick({label:L10n.get("uiBarBackward")},function(){return Engine.backward()}),Story.lookup("tags","bookmark").length>0?jQuery("#history-jumpto").ariaClick({label:L10n.get("uiBarJumpto")},function(){return UI.jumpto()}):jQuery("#history-jumpto").remove(),jQuery("#history-forward").ariaDisabled(State.length===State.size).ariaClick({label:L10n.get("uiBarForward")},function(){return Engine.forward()})):jQuery("#ui-bar-history").remove(),jQuery("#story-title").text(Story.title),Story.has("StoryCaption")||jQuery("#story-caption").remove(),Story.has("StoryMenu")||jQuery("#menu-story").remove(),Config.ui.updateStoryElements||l(),jQuery("#menu-item-saves a").ariaClick(function(e){e.preventDefault(),UI.buildSaves(),Dialog.open()}).text(L10n.get("savesTitle")),Setting.isEmpty()?jQuery("#menu-item-settings").remove():jQuery("#menu-item-settings a").ariaClick(function(e){e.preventDefault(),UI.buildSettings(),Dialog.open()}).text(L10n.get("settingsTitle")),jQuery("#menu-item-restart a").ariaClick(function(e){e.preventDefault(),UI.buildRestart(),Dialog.open()}).text(L10n.get("restartTitle")),Story.has("StoryShare")?jQuery("#menu-item-share a").ariaClick(function(e){e.preventDefault(),UI.buildShare(),Dialog.open()}).text(L10n.get("shareTitle")):jQuery("#menu-item-share").remove())}function s(e){if(c&&!c.hasClass("stowed")){var t=void 0;e&&(t=jQuery("#story"),t.addClass("no-transition"),c.addClass("no-transition")),c.addClass("stowed"),e&&setTimeout(function(){t.removeClass("no-transition"),c.removeClass("no-transition")},Engine.minDomActionDelay)}return this}function u(e){if(c&&c.hasClass("stowed")){var t=void 0;e&&(t=jQuery("#story"),t.addClass("no-transition"),c.addClass("no-transition")),c.removeClass("stowed"),e&&setTimeout(function(){t.removeClass("no-transition"),c.removeClass("no-transition")},Engine.minDomActionDelay)}return this}function l(){if(c){setPageElement("story-banner","StoryBanner"),setPageElement("story-subtitle","StorySubtitle"),setPageElement("story-author","StoryAuthor"),setPageElement("story-caption","StoryCaption");var e=document.getElementById("menu-story");if(null!==e&&(jQuery(e).empty(),Story.has("StoryMenu")))try{UI.assembleLinkList("StoryMenu",e)}catch(e){console.error(e),Alert.error("StoryMenu",e.message)}}}var c=null;return Object.freeze(Object.defineProperties({},{destroy:{value:e},hide:{value:t},init:{value:r},isHidden:{value:n},isStowed:{value:a},show:{value:i},start:{value:o},stow:{value:s},unstow:{value:u},update:{value:l},setStoryElements:{value:l}}))}(),DebugBar=function(){function e(){var e=L10n.get("debugBarToggle"),t=L10n.get("debugBarAddWatch"),o=L10n.get("debugBarWatchAll"),u=L10n.get("debugBarWatchNone"),c=L10n.get("debugBarWatchToggle"),h=L10n.get("debugBarViewsToggle");jQuery(document.createDocumentFragment()).append('<div id="debug-bar"><div id="debug-bar-watch" aria-hidden="true" hidden="hidden"><div>'+L10n.get("debugBarNoWatches")+'</div>></div><div><button id="debug-bar-watch-toggle" tabindex="0" title="'+c+'" aria-label="'+c+'">'+L10n.get("debugBarLabelWatch")+'</button><label id="debug-bar-watch-label" for="debug-bar-watch-input">'+L10n.get("debugBarLabelAdd")+'</label><input id="debug-bar-watch-input" name="debug-bar-watch-input" type="text" list="debug-bar-watch-list" tabindex="0"><datalist id="debug-bar-watch-list" aria-hidden="true" hidden="hidden"></datalist><button id="debug-bar-watch-add" tabindex="0" title="'+t+'" aria-label="'+t+'"></button><button id="debug-bar-watch-all" tabindex="0" title="'+o+'" aria-label="'+o+'"></button><button id="debug-bar-watch-none" tabindex="0" title="'+u+'" aria-label="'+u+'"></button></div><div><button id="debug-bar-views-toggle" tabindex="0" title="'+h+'" aria-label="'+h+'">'+L10n.get("debugBarLabelViews")+'</button><label id="debug-bar-turn-label" for="debug-bar-turn-select">'+L10n.get("debugBarLabelTurn")+'</label><select id="debug-bar-turn-select" tabindex="0"></select></div><button id="debug-bar-toggle" tabindex="0" title="'+e+'" aria-label="'+e+'"></button></div><div id="debug-bar-hint"></div>').appendTo("body"),y=jQuery("#debug-bar"),b=jQuery(y.find("#debug-bar-watch").get(0)),w=jQuery(y.find("#debug-bar-watch-list").get(0)),k=jQuery(y.find("#debug-bar-turn-select").get(0));var g=jQuery(y.find("#debug-bar-toggle").get(0)),m=jQuery(y.find("#debug-bar-watch-toggle").get(0)),v=jQuery(y.find("#debug-bar-watch-input").get(0)),E=jQuery(y.find("#debug-bar-watch-add").get(0)),j=jQuery(y.find("#debug-bar-watch-all").get(0)),x=jQuery(y.find("#debug-bar-watch-none").get(0)),O=jQuery(y.find("#debug-bar-views-toggle").get(0));g.ariaClick(function(){S?n():r(),S=!S,l()}),m.ariaClick(function(){b.attr("hidden")?b.removeAttr("aria-hidden hidden"):b.attr({"aria-hidden":!0,hidden:"hidden"}),l()}),v.on(":addwatch",function(){a(this.value.trim()),this.value=""}).on("keypress",function(e){13===e.which&&(e.preventDefault(),v.trigger(":addwatch"))}),E.ariaClick(function(){return v.trigger(":addwatch")}),j.ariaClick(i),x.ariaClick(s),k.on("change",function(){Engine.goTo(Number(this.value))}),O.ariaClick(function(){DebugView.toggle(),l()}),jQuery(document).on(":historyupdate.debug-bar",p).on(":passageend.debug-bar",function(){d(),f()}).on(":enginerestart.debug-bar",function(){session.delete("debugState")})}function t(){u(),c(),p(),d(),f()}function r(){y.css("right","-"+y.outerWidth()+"px"),l()}function n(){y.css("right",0),l()}function a(e){g.test(e)&&(v.pushUnique(e),v.sort(),d(),f(),l())}function i(){Object.keys(State.variables).map(function(e){return v.pushUnique("$"+e)}),Object.keys(State.temporary).map(function(e){return v.pushUnique("_"+e)}),v.sort(),d(),f(),l()}function o(e){v.delete(e),d(),f(),l()}function s(){for(var e=v.length-1;e>=0;--e)v.pop();d(),f(),l()}function u(){if(session.has("debugState")){var e=session.get("debugState");S=e.stowed,v.push.apply(v,_toConsumableArray(e.watchList)),e.watchEnabled?b.removeAttr("aria-hidden hidden"):b.attr({"aria-hidden":!0,hidden:"hidden"}),e.viewsEnabled?DebugView.enable():DebugView.disable()}}function l(){session.set("debugState",{stowed:S,watchList:v,watchEnabled:!b.attr("hidden"),viewsEnabled:DebugView.isEnabled()})}function c(){S?r():n()}function d(){if(0===v.length)return void b.empty().append("<div>"+L10n.get("debugBarNoWatches")+"</div>");for(var e=L10n.get("debugBarDeleteWatch"),t=jQuery(document.createElement("table")),r=jQuery(document.createElement("tbody")),n=0,a=v.length;n<a;++n)!function(t,n){var a=v[t],i=a.slice(1),s="$"===a[0]?State.variables:State.temporary,u=jQuery(document.createElement("tr")),l=jQuery(document.createElement("button")),c=jQuery(document.createElement("code"));l.addClass("watch-delete").attr("data-name",a).ariaClick({one:!0,label:e},function(){return o(a)}),c.text(h(s[i])),jQuery(document.createElement("td")).append(l).appendTo(u),jQuery(document.createElement("td")).text(a).appendTo(u),jQuery(document.createElement("td")).append(c).appendTo(u),u.appendTo(r)}(n);t.append(r),b.empty().append(t)}function f(){var e=Object.keys(State.variables),t=Object.keys(State.temporary);if(0===e.length&&0===t.length)return void w.empty();var r=[].concat(_toConsumableArray(e.map(function(e){return"$"+e})),_toConsumableArray(t.map(function(e){return"_"+e}))).sort(),n=document.createDocumentFragment();r.delete(v);for(var a=0,i=r.length;a<i;++a)jQuery(document.createElement("option")).val(r[a]).appendTo(n);w.empty().append(n)}function p(){for(var e=State.size,t=State.expired.length,r=document.createDocumentFragment(),n=0;n<e;++n)jQuery(document.createElement("option")).val(n).text(t+n+1+". "+Util.escape(State.history[n].title)).appendTo(r);k.empty().ariaDisabled(e<2).append(r).val(State.activeIndex)}function h(e){if(null===e)return"null";switch(void 0===e?"undefined":_typeof(e)){case"number":if(Number.isNaN(e))return"NaN";if(!Number.isFinite(e))return"Infinity";case"boolean":case"symbol":case"undefined":return String(e);case"string":return JSON.stringify(e);case"function":return"Function"}var t=Util.toStringTag(e);if("Date"===t)return"Date {"+e.toLocaleString()+"}";if("RegExp"===t)return"RegExp "+e.toString();var r=[];if(e instanceof Array||e instanceof Set){for(var n=e instanceof Array?e:Array.from(e),a=0,i=n.length;a<i;++a)r.push(n.hasOwnProperty(a)?h(n[a]):"<empty>");return Object.keys(n).filter(function(e){return!m.test(e)}).forEach(function(e){return r.push(h(e)+": "+h(n[e]))}),t+"("+n.length+") ["+r.join(", ")+"]"}return e instanceof Map?(e.forEach(function(e,t){return r.push(h(t)+" → "+h(e))}),t+"("+e.size+") {"+r.join(", ")+"}"):(Object.keys(e).forEach(function(t){return r.push(h(t)+": "+h(e[t]))}),t+" {"+r.join(", ")+"}")}var g=new RegExp("^"+Patterns.variable+"$"),m=/^\d+$/,v=[],y=null,b=null,w=null,k=null,S=!0;return Object.freeze(Object.defineProperties({},{init:{value:e},start:{value:t},stow:{value:r},unstow:{value:n},watch:{value:a},watchAll:{value:i},unwatch:{value:o},unwatchAll:{value:s}}))}(),LoadScreen=function(){function e(){jQuery(document).on("readystatechange.SugarCube",function(){o.size>0||("complete"===document.readyState?"loading"===jQuery(document.documentElement).attr("data-init")&&(Config.loadDelay>0?setTimeout(function(){0===o.size&&r()},Math.max(Engine.minDomActionDelay,Config.loadDelay)):r()):n())})}function t(){jQuery(document).off("readystatechange.SugarCube"),o.clear(),r()}function r(){jQuery(document.documentElement).removeAttr("data-init")}function n(){jQuery(document.documentElement).attr("data-init","loading")}function a(){return++s,o.add(s),n(),s}function i(e){if(null==e)throw new Error("LoadScreen.unlock called with a null or undefined ID");o.has(e)&&o.delete(e),0===o.size&&jQuery(document).trigger("readystatechange")}var o=new Set,s=0;return Object.freeze(Object.defineProperties({},{init:{value:e},clear:{value:t},hide:{value:r},show:{value:n},lock:{value:a},unlock:{value:i}}))}(),version=Object.freeze({title:"SugarCube",major:2,minor:30,patch:0,prerelease:null,build:9082,date:new Date("2019-09-26T20:43:20.257Z"),extensions:{},toString:function(){var e=this.prerelease?"-"+this.prerelease:"";return this.major+"."+this.minor+"."+this.patch+e+"+"+this.build},short:function(){var e=this.prerelease?"-"+this.prerelease:"";return this.title+" (v"+this.major+"."+this.minor+"."+this.patch+e+")"},long:function(){return this.title+" v"+this.toString()+" ("+this.date.toUTCString()+")"}}),TempState={},macros={},postdisplay={},postrender={},predisplay={},prehistory={},prerender={},session=null,settings={},setup={},storage=null,browser=Browser,config=Config,has=Has,History=State,state=State,tale=Story,TempVariables=State.temporary;window.SugarCube={},jQuery(function(){try{var e=LoadScreen.lock();LoadScreen.init(),document.normalize&&document.normalize(),Story.load(),storage=SimpleStore.create(Story.domId,!0),session=SimpleStore.create(Story.domId,!1),Dialog.init(),UIBar.init(),Engine.init(),Story.init(),L10n.init(),session.has("rcWarn")||"cookie"!==storage.name||(session.set("rcWarn",1),window.alert(L10n.get("warningNoWebStorage"))),Save.init(),Setting.init(),Macro.init(),Engine.start(),Config.debug&&DebugBar.init();var t=$(window),r=setInterval(function(){t.width()&&(clearInterval(r),setTimeout(function(){UIBar.start(),Config.debug&&DebugBar.start(),LoadScreen.unlock(e)},Engine.minDomActionDelay))},Engine.minDomActionDelay);window.SugarCube={Browser:Browser,Config:Config,Dialog:Dialog,Engine:Engine,Has:Has,L10n:L10n,Macro:Macro,Passage:Passage,Save:Save,Scripting:Scripting,Setting:Setting,SimpleAudio:SimpleAudio,State:State,Story:Story,UI:UI,UIBar:UIBar,DebugBar:DebugBar,Util:Util,Visibility:Visibility,Wikifier:Wikifier,session:session,settings:settings,setup:setup,storage:storage,version:version}}catch(e){return console.error(e),LoadScreen.clear(),Alert.fatal(null,e.message,e)}})}(window,window.document,jQuery);}
	</script>
</body>
</html>
